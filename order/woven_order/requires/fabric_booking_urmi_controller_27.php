
<?
/*-------------------------------------------- Comments
Version                  :  V1
Purpose			         : 	This form will create Woven Garments Fabric Booking
Functionality	         :
JS Functions	         :
Created by		         :	Monzu
Creation date 	         : 	27-12-2012
Requirment Client        :
Requirment By            :
Requirment type          :
Requirment               :
Affected page            :
Affected Code            :
DB Script                :
Updated by 		         :
Update date		         :
QC Performed BY	         :
QC Date			         :
Comments		         : From this version oracle conversion is start
						   Date 08-08-15, Merchandizing >Main Fabric booking > Fabric booking booking GR > Cuff - Color Size Breakdown in Pcs > Contrast color is not showing. Issue id=5749 update by jahid
-----------------------------------------------------*/
header('Content-type:text/html; charset=utf-8');
session_start();
if( $_SESSION['logic_erp']['user_id'] == "" ) header("location:login.php");
include('../../../includes/common.php');
include('../../../includes/class4/class.conditions.php');
include('../../../includes/class4/class.reports.php');
include('../../../includes/class4/class.fabrics.php');
include('../../../includes/class4/class.yarns.php');
include('../../../includes/class4/class.trims.php');
include('../../../includes/class4/class.emblishments.php');
include('../../../includes/class4/class.washes.php');

$data=$_REQUEST['data'];
$action=$_REQUEST['action'];
$permission=$_SESSION['page_permission'];
$user_id=$_SESSION['logic_erp']['user_id'];
$user_ip=$_SESSION['logic_erp']["user_ip"];
$buyer_cond=set_user_lavel_filtering(' and buy.id','buyer_id');
$company_cond=set_user_lavel_filtering(' and comp.id','company_id');

function signature_table1($report_id, $company, $width, $template_id="", $padding_top = 70,$prepared_by='') {
	if ($template_id != '') {
		$template_id = " and template_id=$template_id ";
	}
	$sql = sql_select("select designation,name,activities,prepared_by from variable_settings_signature where report_id=$report_id and company_id=$company   and status_active=1  $template_id order by sequence_no");


	if($sql[0][csf("prepared_by")]==1){
		list($prepared_by,$activities)=explode('**',$prepared_by);
		$sql_2[100] = array ( DESIGNATION => 'Prepared By' ,NAME => $prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
		$sql=$sql_2+$sql;
	}

	$count = count($sql);
	$td_width = floor($width / $count);
	$standard_width = $count * 150;
	if ($standard_width > $width) {
		$td_width = 150;
	}
	$no_coloumn_per_tr = floor($width / $td_width);
	$i = 1;
	if ($count == 0) {$message = "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
	$signature_data = '<table id="signatureTblId" width="' . $width . '" style="padding-top:' . $padding_top . 'px;"><tr><td width="100%" height="' . $padding_top . '" colspan="' . $count . '">' . $message . '</td></tr><tr>';
	foreach ($sql as $row) {
		$signature_data .= '<td width="' . $td_width . '" align="center" valign="top">
		<strong>' . $row[csf("activities")] . '</strong><br>
		<strong style="text-decoration:overline">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
		if ($i % $no_coloumn_per_tr == 0) {
			$signature_data .= '</tr><tr><td width="100%" height="70" colspan="' . $no_coloumn_per_tr . '"></td></tr>';
		}
		$i++;
	}
	$signature_data .= '</tr></table>';
	return $signature_data;
}

$isNextProcessValidate=1;//Issue Id --- ISD-19-15663 for Knit Asia
$isYarnPurchseValidate=1;//Issue Id --- ISD-20-20388 for Fakir Apparels Ltd.

//---------------------------------------------------- Start---------------------------------------------------------------------------
//$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");
$color_library=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
$size_library=return_library_array( "select id,size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");

$season_name_arr=return_library_array( "select id,season_name from lib_buyer_season",'id','season_name');

if ($action=="load_drop_down_buyer"){
	echo create_drop_down( "cbo_buyer_name", 140, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company='$data' and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "","1","" );
	exit();
}

if ($action=="load_drop_down_buyer_popup"){
	echo create_drop_down( "cbo_buyer_name", 140, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company='$data' and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "","0","" );
	exit();
}

if ($action=="load_drop_down_suplier")
{
	if($data==5 || $data==3){
		echo create_drop_down( "cbo_supplier_name", 140, "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name",1, "-- Select Supplier --", "", "validate_suplier()",0,"" );
	}
	else{
		echo create_drop_down( "cbo_supplier_name", 140, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=9 and   a.status_active =1 and a.is_deleted=0 order by supplier_name","id,supplier_name", 1, "-- Select Supplier --", $selected, "fill_attention(this.value)",0 );
	}
	exit();
}

if($action=="get_attention_name")
{
	$data=explode("_",$data);
	$contact_person='';
	if($data[1] !=5){
		$sql=sql_select("select id, contact_person from lib_supplier where id=$data[0] and status_active =1 and is_deleted=0");
	}
	if($data[1] ==5){
		$sql=sql_select("select id, contract_person as contact_person from lib_company where id=$data[0] and status_active =1 and is_deleted=0");
	}
	foreach($sql as $row){
		$contact_person=$row[csf('contact_person')];
	}
	if($data[1]==3) echo ' '; //In House
	else echo $contact_person;
	exit();
}

function load_drop_down_suplier($data)
{
	$cbo_supplier_name='';
	if($data==5 || $data==3){
		$cbo_supplier_name= create_drop_down( "cbo_supplier_name", 140, "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name",1, "-- Select Supplier --", "", "validate_suplier()",0,"" );
	}
	else{
		$cbo_supplier_name= create_drop_down( "cbo_supplier_name", 140, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=9 and   a.status_active =1 and a.is_deleted=0 order by supplier_name","id,supplier_name", 1, "-- Select Supplier --", $selected, "",0 );
	}
	return $cbo_supplier_name;
}

if($action=="check_conversion_rate")
{
	$data=explode("**",$data);
	if($db_type==0)
	{
		$conversion_date=change_date_format($data[1], "Y-m-d", "-",1);
	}
	else
	{
		$conversion_date=change_date_format($data[1], "d-M-y", "-",1);
	}
	$currency_rate=set_conversion_rate( $data[0], $conversion_date,$data[2] );
	echo "1"."_".$currency_rate;
	exit();
}

if($action=="check_month_maintain")
{
	$sql_result=sql_select("select tna_integrated from variable_order_tracking where company_name='$data' and variable_list=14 and status_active=1 and is_deleted=0");
	$maintain_setting=$sql_result[0][csf('tna_integrated')];
	if($maintain_setting==1) echo "1"."_";
	else echo "0"."_";
	exit();
}

if ($action=="fabric_booking_popup")
{
	echo load_html_head_contents("Booking Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
 	?>
	<script>
	function js_set_value(booking_no)
	{
		document.getElementById('selected_booking').value=booking_no;
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;" >
        <form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
            <table width="100%" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all">
                <thead>                    
					
					<tr>
             		   <th colspan="11" align="center"><? echo create_drop_down( "cbo_search_category", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
          			  </tr>
                    <tr>
                        <th width="150">Company Name</th>
                        <th width="140">Buyer Name</th>
                        <th width="80">Booking No</th>
                        <th width="80">Job No</th>
                        <th width="80">File No</th>
                        <th width="80">Internal Ref.</th>
                        <th width="80">Style Ref </th>
                        <th width="80">Order No</th>
                        <th width="130" colspan="2">Date Range</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tr class="general">
                    <td>
                        <input type="hidden" id="selected_booking">
                        <? echo create_drop_down( "cbo_company_mst", 150, "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name","id,company_name",1, "-- Select Company --", '', "load_drop_down( 'fabric_booking_urmi_controller', this.value, 'load_drop_down_buyer_popup', 'buyer_td' );",1); ?>
                    </td>
                    <td id="buyer_td"><? echo create_drop_down( "cbo_buyer_name", 140, $blank_array,"", 1, "-- Select Buyer --" ); ?></td>
                    <td><input name="txt_booking_prifix" id="txt_booking_prifix" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px"></td>
                    <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px"></td>
                    <td align="center">
                    <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_booking_prifix').value+'_'+document.getElementById('cbo_search_category').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('txt_order_search').value, 'create_booking_search_list_view', 'search_div', 'fabric_booking_urmi_controller','setFilterGrid(\'list_view\',-1)')" style="width:100px;" /></td>
                </tr>
                <tr>
                    <td align="center" valign="middle" colspan="11">
                    <?=load_month_buttons(1); ?>
                    </td>
                </tr>
            </table>
            <div id="search_div"></div>
        </form>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	<script type="text/javascript">
		$("#cbo_company_mst").val(<? echo $company?>);
		load_drop_down( 'fabric_booking_urmi_controller', $("#cbo_company_mst").val(), 'load_drop_down_buyer_popup', 'buyer_td' );
	</script>
	</html>
	<?
	exit();
}

if ($action=="create_booking_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company="  a.company_id='$data[0]'"; else { echo "Please Select Company First."; die; }
	if ($data[1]!=0) $buyer=" and a.buyer_id='$data[1]'"; else $buyer="";
	if($db_type==0) $year_cond=" and SUBSTRING_INDEX(b.insert_date, '-', 1)=$data[5]";
	if($db_type==2) $year_cond=" and to_char(b.insert_date,'YYYY')=$data[5]";
	if($db_type==0) $booking_year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$data[5]";
	if($db_type==2) $booking_year_cond=" and to_char(a.insert_date,'YYYY')=$data[5]";
	$file_no = str_replace("'","",$data[8]);
	$internal_ref = str_replace("'","",$data[9]);
	
	if($data[7]==1){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num='$data[6]'    "; else  $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num='$data[4]'  "; else  $job_cond="";
		if (trim($data[10])!="") $style_cond=" and b.style_ref_no ='$data[10]'";
		if (str_replace("'","",$data[11])!="") $order_cond=" and c.po_number = '$data[11]'  ";
		if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and c.file_no='".trim($file_no)."' ";
		if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and c.grouping='".trim($internal_ref)."' ";
	}
	else if($data[7]==2){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '$data[6]%'  $booking_year_cond  "; else  $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num like '$data[4]%'  $year_cond  "; else  $job_cond="";
		if (trim($data[10])!="") $style_cond=" and b.style_ref_no like '$data[10]%'";
		if (str_replace("'","",$data[11])!="") $order_cond=" and c.po_number like '$data[11]%'  ";
		if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and c.file_no like '".trim($file_no)."%' ";
		if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and c.grouping like '".trim($internal_ref)."%' ";
	}
	else if($data[7]==3){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '%$data[6]'  $booking_year_cond  "; else  $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num like '%$data[4]'  $year_cond  "; else  $job_cond="";
		if (trim($data[10])!="") $style_cond=" and b.style_ref_no like'%$data[10]'";
		if (str_replace("'","",$data[11])!="") $order_cond=" and c.po_number like '%$data[11]'  ";
		if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and c.file_no like '%".trim($file_no)."' ";
		if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and c.grouping like '%".trim($internal_ref)."' ";
	}
	else if($data[7]==4 || $data[7]==0){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '%$data[6]%'  $booking_year_cond  "; else  $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num like '%$data[4]%'  $year_cond  "; else  $job_cond="";
		if (trim($data[10])!="") $style_cond=" and b.style_ref_no like '%$data[10]%'";
		if (str_replace("'","",$data[11])!="") $order_cond=" and c.po_number like '%$data[11]%'  ";
		if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and c.file_no like '%".trim($file_no)."%' ";
		if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and c.grouping like '%".trim($internal_ref)."%' ";
	}

	if($db_type==0){
		if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $booking_date ="";
	}
	else if($db_type==2){
		if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $booking_date ="";
	}
	$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");
	$po_qty=return_library_array( "select id,po_quantity from wo_po_break_down", "id", "po_quantity");
	$po_array=array();
	$job_prefix_num=array();
	$sql_po= sql_select("select a.booking_no, a.po_break_down_id, a.job_no from wo_booking_mst a where $company $buyer $booking_date and a.booking_type=1 and a.is_short=2 and   a.status_active=1 and a.is_deleted=0 order by a.booking_no");
	foreach($sql_po as $row){
		$po_id=explode(",",$row[csf("po_break_down_id")]);
		$job_prefix_arr=explode("-",$row[csf("job_no")]);
		$po_number_string="";
		$po_qty_total=0;
		foreach($po_id as $key=> $value ){
			$po_number_string.=$po_number[$value].",";
			$po_qty_total+=$po_qty[$value];
		}
		$po_array[$row[csf("po_break_down_id")]]=rtrim($po_number_string,",");
		$po_qty_array[$row[csf("po_break_down_id")]]=$po_qty_total;
		$job_prefix_num[$row[csf("job_no")]]=ltrim($job_prefix_arr[2],0);
	}

	$approved=array(0=>"No",1=>"Yes",2=>"No",3=>"Yes");
	$is_ready=array(0=>"No",1=>"Yes",2=>"No");
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	$suplier=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	//$arr=array (2=>$comp,3=>$buyer_arr,4=>$job_prefix_num,6=>$garments_item,7=>$po_array,10=>$item_category,11=>$fabric_source,12=>$suplier,13=>$approved,14=>$is_ready);

	$sql= "select a.id, a.booking_no_prefix_num, c.file_no, c.grouping, a.booking_date, a.company_id, a.buyer_id, a.job_no, a.pay_mode, d.gmts_item_id, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.booking_no, a.ready_to_approved, b.style_ref_no from wo_booking_mst a, wo_po_details_master b, wo_po_break_down c, wo_po_details_mas_set_details d where $company $buyer $job_cond $booking_date $booking_cond  $file_no_cond  $internal_ref_cond $style_cond $order_cond ". set_user_lavel_filtering(' and a.buyer_id','buyer_id')." and a.job_no=b.job_no and a.job_no=c.job_no_mst and b.job_no=c.job_no_mst and b.job_no=d.job_no and a.booking_type=1 and a.is_short=2 and a.status_active=1 and a.is_deleted=0 and a.entry_form=118 group by a.id, a.booking_no_prefix_num, c.file_no, c.grouping, a.booking_date, a.company_id, a.buyer_id, a.job_no, a.pay_mode, d.gmts_item_id, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.booking_no, a.ready_to_approved, b.style_ref_no order by a.id DESC";
	?>
    <table width="1160" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all">
        <thead>
            <tr>
                <th width="30">SL</th>
                <th width="60">Booking No</th>
                <th width="60">Booking Date</th>
                <th width="80">Buyer</th>
                <th width="60">Job No</th>
                <th width="90">Style Ref.</th>
                <th width="90">Gmts Item </th>
                <th width="100">PO number</th>
                <th width="50">PO Qty.</th>
                <th width="80">Internal Ref</th>
                <th width="80">File No</th>
                <th width="80">Fabric Nature</th>
                <th width="80">Fabric Source</th>
                <th width="50">Pay Mode</th>
                <th width="50">Supplier</th>
                <th width="50">Approved</th>
                <th>Ready to Approved</th>
            </tr>
        </thead>
    </table>
    <div style="max-height:300px; overflow-y:scroll; width:1160px" >
        <table width="1140" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all" id="list_view">
            <tbody>
            <?
            $sl=1;
            $data=sql_select($sql);
            foreach($data as $row)
            {
				if ($sl%2==0)$bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value('<? echo $row[csf("booking_no")]?>')" style="cursor:pointer">
                    <td width="30"><? echo $sl; ?></td>
                    <td width="60"><? echo $row[csf("booking_no_prefix_num")];?></td>
                    <td width="60"><? echo change_date_format($row[csf("booking_date")],"dd-mm-yyyy","-"); ?></td>
                    <td width="80" style="word-break:break-all"><? echo $buyer_arr[$row[csf("buyer_id")]];?></td>
                    <td width="60"><? echo $job_prefix_num[$row[csf("job_no")]];?></td>
                    <td width="90" style="word-break:break-all"><? echo $row[csf("style_ref_no")]; ?></td>
                    <td width="90" style="word-break:break-all"><? echo $garments_item[$row[csf("gmts_item_id")]];?> </td>
                    <td width="100" style="word-wrap: break-word;word-break: break-all;"><? echo $po_array[$row[csf("po_break_down_id")]];?></td>
                    <td width="50"><? echo $po_qty_array[$row[csf("po_break_down_id")]];?></td>
                    <td width="80" style="word-break:break-all"><? echo $row[csf("grouping")];?></td>
                    <td width="80" style="word-break:break-all"><? echo $row[csf("file_no")];?></td>
                    <td width="80" style="word-break:break-all"><? echo $item_category[$row[csf("item_category")]];?></td>
                    <td width="80" style="word-break:break-all"><? echo $fabric_source[$row[csf("fabric_source")]];?></td>
                    <td width="50" style="word-break:break-all"><? echo $pay_mode[$row[csf("pay_mode")]];?></td>
                    <td width="50" style="word-break:break-all">
                    <?
                    if($row[csf("pay_mode")]==3 || $row[csf("pay_mode")]==5) echo $comp[$row[csf("supplier_id")]]; else echo $suplier[$row[csf("supplier_id")]];
                    ?>
                    </td>
                    <td width="50"><? echo $approved[$row[csf("is_approved")]];?></td>
                    <td><? echo $is_ready[$row[csf("ready_to_approved")]];?></td>
				</tr>
				<?
				$sl++;
            }
            ?>
            </tbody>
        </table>
    </div>
    <?
	exit();
}

if ($action=="populate_data_from_search_popup")
{
	$sql_approved="select a.company_id, max(a.setup_date) as setup_date, b.allow_partial from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and b.status_active=1 and page_id=5  group by a.company_id, b.allow_partial order by setup_date";
	$result_nasscity = sql_select($sql_approved); $allow_partial_arr=array();
	foreach($result_nasscity as $row)
	{
		$allow_partial_arr[$row[csf("company_id")]]=$row[csf("allow_partial")];
	}
	unset($result_nasscity);
	//print_r($allow_partial_arr[3]);

	 $sql= "select id, booking_no, booking_date, company_id, buyer_id, job_no, po_break_down_id, item_category, fabric_source, currency_id, exchange_rate, pay_mode, booking_month, supplier_id, attention, booking_percent, delivery_date, source, booking_year, colar_excess_percent, cuff_excess_percent, is_approved, ready_to_approved, is_apply_last_update, rmg_process_breakdown, fabric_composition, uom, remarks, quality_level, fabricstructure, fabricgsm, sustainability_standard, fab_material, requisition_no, proceed_knitting, proceed_dyeing, cad_eff_percent from wo_booking_mst where booking_no='$data'";

	 $data_array=sql_select($sql);
	 foreach ($data_array as $row)
	 {
        echo "document.getElementById('txt_order_no_id').value = '".$row[csf("po_break_down_id")]."';\n";
		echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_id")]."';\n";
		echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_id")]."';\n";
		echo "document.getElementById('txt_job_no').value = '".$row[csf("job_no")]."';\n";
		echo "document.getElementById('txt_booking_no').value = '".$row[csf("booking_no")]."';\n";
		echo "document.getElementById('update_id').value = '".$row[csf("id")]."';\n";
		echo "document.getElementById('cbo_fabric_natu').value = '".$row[csf("item_category")]."';\n";
		echo "document.getElementById('cbo_fabric_source').value = '".$row[csf("fabric_source")]."';\n";
		echo "document.getElementById('cbo_currency').value = '".$row[csf("currency_id")]."';\n";
		echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
		echo "document.getElementById('cbo_pay_mode').value = '".$row[csf("pay_mode")]."';\n";
		echo "document.getElementById('txt_booking_date').value = '".change_date_format($row[csf("booking_date")],'dd-mm-yyyy','-')."';\n";
		echo "document.getElementById('cbo_booking_month').value = '".$row[csf("booking_month")]."';\n";
		echo "document.getElementById('txt_attention').value = '".$row[csf("attention")]."';\n";
		echo "document.getElementById('txt_booking_percent').value = '".$row[csf("booking_percent")]."';\n";
		echo "document.getElementById('txt_delivery_date').value = '".change_date_format($row[csf("delivery_date")],'dd-mm-yyyy','-')."';\n";
	    echo "document.getElementById('cbo_source').value = '".$row[csf("source")]."';\n";
		echo "document.getElementById('cbo_booking_year').value = '".$row[csf("booking_year")]."';\n";
		echo "document.getElementById('txt_colar_excess_percent').value = '".$row[csf("colar_excess_percent")]."';\n";
		echo "document.getElementById('txt_cuff_excess_percent').value = '".$row[csf("cuff_excess_percent")]."';\n";
		if($row[csf("is_approved")]==3) $is_approved=1; else $is_approved=$row[csf("is_approved")];

		echo "document.getElementById('id_approved_id').value = '".$is_approved."';\n";
		echo "document.getElementById('cbo_ready_to_approved').value = '".$row[csf("ready_to_approved")]."';\n";
		echo "document.getElementById('txt_processloss_breck_down').value = '".$row[csf("rmg_process_breakdown")]."';\n";
		echo "document.getElementById('txt_fabriccomposition').value = '".$row[csf("fabric_composition")]."';\n";
		$supplier_dropdwan=load_drop_down_suplier($row[csf("pay_mode")]);
		echo "document.getElementById('sup_td').innerHTML = '".$supplier_dropdwan."';\n";
		echo "document.getElementById('cbo_supplier_name').value = '".$row[csf("supplier_id")]."';\n";
		echo "document.getElementById('cbouom').value = '".$row[csf("uom")]."';\n";
		echo "document.getElementById('txt_remark').value = '".$row[csf("remarks")]."';\n";
		echo "document.getElementById('cbo_quality_level').value = '".$row[csf("quality_level")]."';\n";
		echo "$('#cbo_quality_level').attr('disabled',true)".";\n";
		echo "document.getElementById('txt_fabricstructure').value = '".$row[csf("fabricstructure")]."';\n";
		echo "document.getElementById('txt_fabricgsm').value = '".$row[csf("fabricgsm")]."';\n";
		echo "document.getElementById('sustainability_standard').value = '".$row[csf("sustainability_standard")]."';\n";
		echo "$('#sustainability_standard').attr('disabled',true)".";\n";
		echo "document.getElementById('cbo_fab_material').value = '".$row[csf("fab_material")]."';\n";
		echo "$('#cbo_fab_material').attr('disabled',true)".";\n";
		echo "document.getElementById('txt_requision_no').value = '".$row[csf("requisition_no")]."';\n";
		echo "$('#txt_requision_no').attr('disabled',true)".";\n";
		echo "document.getElementById('txt_cad_eff_percent').value = '".$row[csf("cad_eff_percent")]."';\n";
		
		if($row[csf("proceed_knitting")]==1)
		{
			echo "$('#chk_pro_knitting').prop('checked', true);\n";
			echo "$('#chk_pro_knitting').val('".$row[csf("proceed_knitting")]."');\n";
		}
		else
		{
			echo "$('#chk_pro_knitting').prop('checked', false);\n";
			echo "$('#chk_pro_knitting').val(2);\n";
		}
		
		if($row[csf("proceed_dyeing")]==1)
		{
			echo "$('#chk_pro_dyeing').prop('checked', true);\n";
			echo "$('#chk_pro_dyeing').val('".$row[csf("proceed_dyeing")]."');\n";
		}
		else
		{
			echo "$('#chk_pro_dyeing').prop('checked', false);\n";
			echo "$('#chk_pro_dyeing').val(2);\n";
		}
//
		$refusing_reason=return_field_value("refusing_reason", "refusing_cause_history", "mst_id='".$row[csf('id')]."'  and entry_form=7");
		//$approval_cause=return_field_value("approval_cause as approval_cause", "fabric_booking_approval_cause", "id='".$row[csf('id')]."' and approval_cause=$refusing_reason  and entry_form=7","approval_cause");
		//echo $max_approved_no.'d';
		//echo "$('#check_app_id').val($max_approved_no);\n";
		
		
		echo "document.getElementById('txt_refusing_cause').value = '".$refusing_reason."';\n";

		if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
		else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

		$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$row[csf("po_break_down_id")].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
		foreach($data_array3 as $inv)
		{
			$grouping=implode(",",array_unique(explode(",",$inv[csf("grouping")])));
			$file_no=implode(",",array_unique(explode(",",$inv[csf("file_no")])));
			echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";
			echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";
		}
		//approval_cause_refusing_his
		 $un_approval_cause=return_field_value("approval_cause as approval_cause", "approval_cause_refusing_his", "booking_id='".$row[csf('id')]."'  and entry_form=7","approval_cause");
		$approval_cause='';
		$menu_id=$_SESSION['menu_id'];
		$user_id=$_SESSION['logic_erp']['user_id'];
		$sql_request="select MAX(id) as id, approval_cause from fabric_booking_approval_cause where entry_form=7  and booking_id=".$row[csf("id")]." and approval_type=2 and status_active=1 and is_deleted=0 group by approval_cause order by id desc";// page_id='$menu_id' //and user_id='$user_id'
		//echo $sql_request;
		$nameArray_request=sql_select($sql_request);
		
		foreach($nameArray_request as $approw)
		{
			$approval_cause=$approw[csf("approval_cause")];
		}
		
		$un_sql_request="select MAX(id) as id,max(approval_no) as approved_no from fabric_booking_approval_cause where entry_form=7  and booking_id=".$row[csf("id")]." and approval_type=2 and status_active=1 and is_deleted=0";// page_id='$menu_id'
		//echo $sql_request;
		$nameArray_un_request=sql_select($un_sql_request);
		$cause_approved_no='';
		foreach($nameArray_un_request as $approw)
		{
			$cause_approved_no=$approw[csf("approved_no")];
		}
		//echo "select max(approved_no) as max_approved_no from approval_history where mst_id='".$row[csf('id')]."'  and entry_form=7 ";
		 $max_approved_no=return_field_value("max(approved_no) as max_approved_no", "approval_history", "mst_id='".$row[csf('id')]."'  and entry_form=7","max_approved_no");
	// echo $max_approved_no.'='.$cause_approved_no.',';die;
		
		if($max_approved_no!=$cause_approved_no)
		{
			$approval_cause='';	
		}

		if($row[csf("is_approved")]==1 || $row[csf("is_approved")]==3)
		{
			if($allow_partial_arr[$row[csf("company_id")]]==1)
			{
				if($is_approved==1) echo "document.getElementById('app_sms2').innerHTML = 'This booking is approved';\n";
			}
			else
			{
				if($row[csf("is_approved")]==1) echo "document.getElementById('app_sms2').innerHTML = 'This booking is approved';\n";
				if($row[csf("is_approved")]==3) echo "document.getElementById('app_sms2').innerHTML = 'This booking is Partial approved';\n";
			}

			echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
			echo "document.getElementById('txt_un_appv_request').value = '".str_replace(array("&", "*", "(", ")", "=","'","_",",","\r", "\n",'"','#'), "", $approval_cause)."';\n";
		}
		else
		{
			echo "document.getElementById('app_sms2').innerHTML = '';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
			echo "document.getElementById('txt_un_appv_request').value = '';\n";
		}

		$po_no="";
		$sql_po= "select po_number from  wo_po_break_down  where id in(".$row[csf('po_break_down_id')].")";
		$data_array_po=sql_select($sql_po);
		foreach ($data_array_po as $row_po)
		{
			$po_no.=$row_po[csf('po_number')].",";
		}
		echo "document.getElementById('txt_order_no').value = '".substr($po_no, 0, -1)."';\n";
		$po_m="";
		$sql_m= "select dealing_marchant from   wo_po_details_master  where job_no='".$row[csf("job_no")]."'";
		$data_array_m=sql_select($sql_m);
		foreach ($data_array_m as $row_m)
		{
			$po_m=$row_m[csf('dealing_marchant')];
		}
		if($row[csf("is_apply_last_update")]==2 && $is_approved!=1)
		{
			echo "document.getElementById('app_sms3').innerHTML = 'Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$po_m]."';\n";
			echo "document.getElementById('is_apply_last_update').value = '".$row[csf("is_apply_last_update")]."';\n";
		}
		else
		{
			echo "document.getElementById('app_sms3').innerHTML = '';\n";
		}

		$colar_culff_percent=return_field_value("colar_culff_percent", "variable_order_tracking", "company_name='".$row[csf("company_id")]."'  and variable_list=40 and status_active=1 and is_deleted=0");
		if($colar_culff_percent==1)
		{
			echo "$('#txt_colar_excess_percent').removeAttr('disabled')".";\n";
			echo "$('#txt_cuff_excess_percent').removeAttr('disabled')".";\n";
		}
		if($colar_culff_percent==2)
		{
			echo "$('#txt_colar_excess_percent').attr('disabled','true')".";\n";
		    echo "$('#txt_cuff_excess_percent').attr('disabled','true')".";\n";
		}

		$sql_delevary=sql_select("select task_number,max(task_finish_date) as task_finish_date from tna_process_mst where po_number_id in(".$row[csf("po_break_down_id")].") and task_number in(73) and is_deleted = 0 and 	status_active=1 group by task_number");
		foreach($sql_delevary as $row_delevary)
		{
		   echo "document.getElementById('txt_tna_date').value = '".change_date_format($row_delevary[csf("task_finish_date")],'dd-mm-yyyy','-')."';\n";
		}
	 }
	 exit();
}

if ($action=="order_search_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		//var cbo_level='<?// echo $cbo_level; ?>';
		var selected_id = new Array, selected_name = new Array();
		function check_all_data(){
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length-1;
			tbl_row_count = tbl_row_count;
			for( var i = 1; i <= tbl_row_count; i++ ){
				if($("#tr_"+i).css("display") !='none'){
				document.getElementById("tr_"+i).click();
				}
			}
		}
		
		function set_all()
		{
			var old=document.getElementById('hidd_oldRow_no').value; 
			//alert(old)
			/*if(old!="")
			{   
				old=old.split(",");
				for(var k=0; k<old.length; k++)
				{   
					//js_set_value( old[k] );*/
					
					$('#list_view tr').each(function(index, element) {
						if( $('#'+this.id).attr('bgcolor')=='yellow' )
						{
							var nid=this.id;//.replace( 'tr_', "");  
							//alert(nid)
							var strval=nid.split("_");
							var str_data=$('#txtindividualid_'+strval[1]).val();
							var str_all=str_data.split("_");
							var str=str_all[0];
							var str_po=str_all[1];
							document.getElementById('job_no').value=str_all[2];
							//alert(nid);
							//var nid=nid.replace( 'tr_', ""); 
							toggle( nid, '#FFFFCC');
							//alert(nid);
							if( jQuery.inArray( str , selected_id ) == -1 )
							{
								selected_id.push( str );
								selected_name.push( str_po );
							}
							else
							{
								for( var i = 0; i < selected_id.length; i++ )
								{
									if( selected_id[i] == str ) break;
								}
				
								selected_id.splice( i, 1 );
								selected_name.splice( i, 1 );
									//alert(selected_id.length)
								if(selected_id.length==0)
								{
									document.getElementById('job_no').value="";
								}
							}
							var id = '' ; var name = '';
							for( var i = 0; i < selected_id.length; i++ )
							{
								id += selected_id[i] + ',';
								name += selected_name[i] + ',';
							}
							id = id.substr( 0, id.length - 1 );
							name = name.substr( 0, name.length - 1 );
							$('#po_number_id').val( id );
							$('#po_number').val( name );
							 
							/*if( jQuery.inArray(  nid , selected_id ) == -1) 
							{
								//selected_id_listed.push( nid );
								
								selected_id.push( str );
								selected_name.push( str_po );
							}
							else
							{
								for( var i = 0; i < selected_id.length; i++ ) {
									if( selected_id[i] == nid  ) break;
								}
								selected_id.splice( i, 1 );
							}*/
						}
					});
/*				} 
			}
*/		}

		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}

		function js_set_value( str_data,tr_id,selectable,sc_lc_check,isYarnAllo )//str_data,tr_id,selectable,sc_lc_check,isYarnAllo
		{
			//var str_data=$('#txtindividualid_'+tr_id).val();
			//alert(tr_id)
			/*var str_all=str_data.split("_");
			var str=str_all[0];
			var str_po=str_all[1];
			var selectable=str_all[3];
			var sc_lc_check=str_all[4];
			var isYarnAllo=str_all[5];*/
			//alert(str_all[6]);
			if(selectable==0){
				alert("Fabric booking TNA date is over of this PO.\nTNA date need to revise to create the Fabric Booking.");
				return;
			}
			if(sc_lc_check==1){
				alert("SC/LC is not found against your selected PO,Please ensure it then try again");
				return;
			}
			if(isYarnAllo==1){
				alert("Yarn Allocation Found Against Your Selected PO.\n Please try again or Contract With MIS.");
				return;
			}
			//var str_all=str_data.split("_");
			var str_all=str_data.split("_");
			var str=str_all[0];
			var str_po=str_all[1];
			//alert(document.getElementById('job_no').value+'='+str_all[2]);
			if ( document.getElementById('job_no').value!="" && document.getElementById('job_no').value!=str_all[2] )
			{
				alert('Job Mixing Not Allowed.');
				return;
			}
			
			toggle( tr_id, '#FFFFCC');
			
			document.getElementById('job_no').value=str_all[2];

			if( jQuery.inArray( str , selected_id ) == -1 )
			{
				selected_id.push( str );
				selected_name.push( str_po );
			}
			else
			{
				for( var i = 0; i < selected_id.length; i++ )
				{
					if( selected_id[i] == str ) break;
				}

				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
					//alert(selected_id.length)
				if(selected_id.length==0)
				{
					document.getElementById('job_no').value="";
				}
			}
			var id = '' ; var name = '';
			for( var i = 0; i < selected_id.length; i++ )
			{
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );
			$('#po_number_id').val( id );
			$('#po_number').val( name );
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;" >
			<?
				$booking_month=0;
				if(str_replace("'","",$cbo_booking_month)<10) $booking_month.=str_replace("'","",$cbo_booking_month); else $booking_month=str_replace("'","",$cbo_booking_month);
				$start_date="01"."-".$booking_month."-".str_replace("'","",$cbo_booking_year);
				$end_date=cal_days_in_month(CAL_GREGORIAN, $booking_month, str_replace("'","",$cbo_booking_year))."-".$booking_month."-".str_replace("'","",$cbo_booking_year);
				if($booking_month!=0)
				{
					$start_date=$start_date; $end_date=$end_date;
				}
				else
				{
					$start_date=''; $end_date='';
				}
				
				$exjob=explode("-",$txt_job_no);
				$jobPre=$exjob[2]*1;
				if($jobPre==0) $jobPre="";
            ?>
            <form name="searchpofrm_1" id="searchpofrm_1">
                <table width="950" class="rpt_table" align="center" rules="all">
                    <thead>
						<tr colspan="11">
						<strong>
						1)Tna date is less then booking date then row color is <span style="color:red">Red</span>&nbsp; &nbsp;
						2.Y.Allocation found and booking not found row <span style="color:yellow">Yellow</span>  font color <span style="color:green">Green</span>&nbsp; &nbsp;
						3.Booking found Y.Allocation not found row <span style="color:yellow">Yellow</span> font color <span style="color:green">Green</span> &nbsp; &nbsp;
						4.Y.Allocation found and booking found row <span style="color:yellow">Yellow</span> font color <span style="color:green">Green</span> &nbsp; &nbsp;
						5.Only booking found row color <span style="color:yellow">Yellow</span></strong>
						</tr>
                        <tr>
                            <th colspan="11"><?=create_drop_down( "cbo_string_search_type", 200, $string_search_type,'', 1, "-Searching Type-",1); ?></th>
                        </tr>
                        <tr>
                            <th width="140">Company Name</th>
                            <th width="140">Buyer Name</th>
                            <th width="60">Job Year</th>
                            <th width="70">Job No</th>
                            <th width="70">Internal Ref</th>
                            <th width="70">File No</th>
                            <th width="80">Style Ref </th>
                            <th width="80">Order No</th>
                            <th width="130" colspan="2">Date Range</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tr class="general">
                        <td><?=create_drop_down( "cbo_company_mst", 140, "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name","id,company_name",1, "- Select Company -", str_replace("'","",$cbo_company_name), "load_drop_down( 'fabric_booking_controller', this.value, 'load_drop_down_buyer_popup', 'buyer_td' );"); ?></td>
                        <td id="buyer_td"><?=create_drop_down( "cbo_buyer_name", 140, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company=$cbo_company_name and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", str_replace("'","",$cbo_buyer_name), "" ); ?></td>
                        <td><? echo create_drop_down( "cbo_job_year", 60, $year,"", 1, "-- Select --", date('Y'), "",0 ); ?></td>
                        <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:60px" value="<?=$jobPre; ?>"></td>
                        <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:70px"></td>
                        <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:70px"></td>
                        <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px" value="<?=$start_date; ?>"/></td>
                        <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px" value="<?=$end_date; ?>"/></td>
                        <td align="center">
                        <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+'<?=$txt_booking_no; ?>'+'_'+'<?=$txt_order_no_id; ?>'+'_'+'<?=$txt_job_no; ?>'+'_'+document.getElementById('cbo_job_year').value, 'create_po_search_list_view','search_div','fabric_booking_urmi_controller','setFilterGrid(\'list_view\',-1); set_all();');" style="width:70px;" />
                        </td>
                    </tr>
                    <tr>
                        <td align="center" valign="top" colspan="11">
                            <input type="hidden" id="po_number_id" value="<?=$txt_order_no_id; ?>">
                            <input type="hidden" id="job_no" value="<?=$txt_job_no; ?>">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="11" align="center">
                        	<strong>Selected PO Number:</strong> &nbsp;<input type="text" class="text_boxes" readonly style="width:750px" id="po_number" value="<?=$txt_order_no; ?>">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="11" align="center"><input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" /></td>
                    </tr>
                    <tr>
                        <td colspan="11" align="center">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All 
                        </td>
                    </tr>
                </table>
                <div id="search_div"></div>
            </form>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="create_po_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company=" and a.company_name='$data[0]'"; else { echo "Please Select Company First."; die; }
	
	$buyer="";
	if(str_replace("'","",$data[1])==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer="";
		}
		else $buyer="";
	}
	else $buyer=" and a.buyer_name='$data[1]'";

	$job_cond=""; $order_cond=""; $style_cond="";
	if($data[7]==1)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number = '$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no ='$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==2)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '$data[6]%'  "; //else  $style_cond="";
	}
	else if($data[7]==3)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==4 || $data[7]==0)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]%'"; //else  $style_cond="";
	}
	
	$internal_ref = str_replace("'","",$data[8]);
	$file_no = str_replace("'","",$data[9]);
	
	if(str_replace("'","",$data[4])=="" && str_replace("'","",$data[5])=="" && trim($data[6])=="" && $internal_ref=="" && $file_no=="")
	{
		echo $job_no."Please Insert Job No/PO No/Style/Ref No/File no";die;
	}
	
	$booking_no = str_replace("'","",$data[10]);
	$existingpoid = str_replace("'","",$data[11]);
	$job_no = str_replace("'","",$data[12]);
	$jobYear = str_replace("'","",$data[13]);
	//echo $job_no.'DSSA';
	if ($job_no=="") $job_no_cond=""; else $job_no_cond=" and a.job_no='".trim($job_no)."' ";
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and b.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and b.grouping like '%".trim($internal_ref)."%' ";

	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $shipment_date ="";
	}
	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $shipment_date ="";
	}
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$data[0] and b.page_id=25 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}
	//if($app_nessity==1) $appCond=" and c.approved=1"; else $appCond="";
	//Note: this validation off by issue:1006
	
	$jobYearCond="";
	if($jobYear!=0)
	{
		if($db_type==0) $jobYearCond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$jobYear";
		else if($db_type==2) $jobYearCond=" and to_char(a.insert_date,'YYYY')=$jobYear";
	}
	
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	$arr=array (1=>$comp,2=>$buyer_arr);
	//$sql= "select a.job_no_prefix_num,a.company_name,a.buyer_name,a.style_ref_no,a.job_quantity,b.id, b.po_number,b.grouping,b.file_no,b.po_quantity,b.shipment_date,a.job_no from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c where a.job_no=b.job_no_mst and a.job_no=c.job_no and a.status_active=1 and b.status_active=1 and b.shiping_status not in(3) $job_no_cond $appCond $shipment_date $company $buyer $job_cond $order_cond $style_cond $file_no_cond $internal_ref_cond order by a.job_no";
	$sql= "select a.job_no_prefix_num, a.company_name, a.buyer_name, a.style_ref_no, a.job_quantity, b.id, b.po_number, b.grouping, b.file_no, b.po_quantity, b.shipment_date, a.job_no from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c where a.id=b.job_id and a.id=c.job_id ".set_user_lavel_filtering(' and a.buyer_name','buyer_id')." and b.shiping_status not in(3) and a.status_active=1 and b.status_active=1 $appCond $shipment_date $company $buyer $job_cond $order_cond $style_cond $file_no_cond $internal_ref_cond $job_no_cond $jobYearCond order by b.id ASC";
	//echo $sql;
	$sqlD=sql_select($sql); $poidArr=array();
	foreach ($sqlD as $row)
	{
		$poidArr[$row[csf('id')]]=$row[csf('id')];
	}
	?>
    <table width="940" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" >
        <thead>
            <tr>
                <th width="30">SL</th>
                <th width="60">Job No</th>
                <th width="60">Company</th>
                <th width="50">Buyer</th>
                <th width="100">Style Ref.</th>
                <th width="100">Internal Ref.</th>
                <th width="100">File No</th>
                <th width="70">Job Qty</th>
                <th width="150">PO number</th>
                <th width="80">Po Qty</th>
                <th>Shipment Date</th>
            </tr>
        </thead>
    </table>
    <div style="max-height:280px; overflow-y:scroll; width:940px">
        <table width="920" class="rpt_table" id="list_view" border="1" rules="all">
        <?
		$sc_lc_variable=2;
		$sc_lc_variable=return_field_value("excut_source", "variable_order_tracking", "company_name=$data[0]  and variable_list=73 and status_active=1 and is_deleted=0");
			 //echo $sc_lc_variable;

		$tna_integrated=return_field_value("tna_integrated", "variable_order_tracking", "company_name=$data[0]  and variable_list=14 and status_active=1 and is_deleted=0");
		if($sc_lc_variable==1)
		{
			//$sql_sc=sql_select("select b.id, d.wo_po_break_down_id from wo_po_details_master a, wo_po_break_down b, com_sales_contract_order_info d where a.job_no=b.job_no_mst  and b.id= d.wo_po_break_down_id and a.status_active=1 and b.status_active=1 $appCond $shipment_date $company $buyer $job_cond $order_cond $style_cond $file_no_cond $internal_ref_cond order by a.job_no");
			$sql_sc=sql_select("select d.wo_po_break_down_id from com_sales_contract_order_info d where d.status_active=1 and d.is_deleted=0 ".where_con_using_array($poidArr,1,'d.wo_po_break_down_id')."");
			$sc_Arr=array();
			foreach($sql_sc as $row){
				$sc_Arr[$row[csf('wo_po_break_down_id')]]=$row[csf('wo_po_break_down_id')];
			}
			unset($sql_sc);
			
			//$sql_lc=sql_select("select b.id,d.wo_po_break_down_id from wo_po_details_master a, wo_po_break_down b , com_export_lc_order_info d where a.job_no=b.job_no_mst  and b.id= d.wo_po_break_down_id and a.status_active=1 and b.status_active=1 $appCond $shipment_date $company $buyer $job_cond $order_cond $style_cond $file_no_cond $internal_ref_cond order by a.job_no");
			$sql_lc=sql_select("select d.wo_po_break_down_id from com_export_lc_order_info d where d.status_active=1 and d.is_deleted=0 ".where_con_using_array($poidArr,1,'d.wo_po_break_down_id')."");
			$lc_Arr=array();
			foreach($sql_lc as $row){
				$lc_Arr[$row[csf('wo_po_break_down_id')]]=$row[csf('wo_po_break_down_id')];
			}
			unset($sql_lc);
		}
		
		//$sqlt=sql_select("select b.id,a.job_no,d.task_start_date, d.task_finish_date from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c , tna_process_mst d where a.job_no=b.job_no_mst and a.job_no=c.job_no and a.job_no=d.job_no and b.id= d.po_number_id and d.task_number = 31 and a.status_active=1 and b.status_active=1 $appCond $shipment_date $company $buyer $job_cond $order_cond $style_cond $file_no_cond $internal_ref_cond order by a.job_no");
		$sqlt=sql_select("select d.po_number_id, d.task_start_date, d.task_finish_date from tna_process_mst d where d.task_number = 31 and d.status_active=1 and d.is_deleted=0 ".where_con_using_array($poidArr,1,'d.po_number_id')."");
		$tnaArr=array();
		foreach($sqlt as $row){
			$tnaArr[$row[csf('po_number_id')]]=$row[csf('task_finish_date')];
		}
		unset($sqlt);
		
		//$sqltBooking=sql_select("select b.id from  wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c  where a.job_no=b.job_no_mst and a.job_no=c.job_no  and b.id= c.po_break_down_id and b.status_active=1 and c.booking_type=1 and c.status_active=1 and c.booking_no='$booking_no' $shipment_date $company $buyer $job_cond $order_cond $style_cond $file_no_cond $internal_ref_cond order by a.job_no");
		$sqltBooking=sql_select("select c.po_break_down_id, c.is_short from wo_booking_dtls c where c.booking_type=1 and c.status_active=1 and c.is_deleted=0 ".where_con_using_array($poidArr,1,'c.po_break_down_id')." group by c.po_break_down_id, c.is_short");
		$BookingArr=array(); $booking_found_arr=array();
		foreach($sqltBooking as $row){
			$BookingArr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
			if($row[csf('is_short')]==2)
			{
				$booking_found_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
			}
		}
		unset($sqltBooking);
		
		//echo $booking_no.'SD';
		$yarnAlloArr=array();
		if($booking_no!="")
		{
			$yarnAllo=sql_select("select po_break_down_id from inv_material_allocation_dtls where booking_no='$booking_no' and status_active=1 and is_deleted=0");
			//echo "select po_break_down_id from inv_material_allocation_dtls where booking_no='$booking_no' and status_active=1 and is_deleted=0";
			foreach($yarnAllo as $yrow){
				$yarnAlloArr[$yrow[csf('po_break_down_id')]]=$yrow[csf('po_break_down_id')];
			}
			unset($yarnAllo);
		}
		

		/*$booking_sql=sql_select("SELECT d.po_break_down_id from wo_po_details_master a join wo_po_break_down b on a.id=b.job_id join wo_pre_cost_mst c on a.id=c.job_id join wo_booking_dtls d on b.id=d.po_break_down_id where  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and d.booking_type=1 and d.is_short=2 $appCond $shipment_date $company $buyer $job_cond $order_cond $style_cond $file_no_cond $internal_ref_cond $job_no_cond $jobYearCond group by d.po_break_down_id");
		foreach ($booking_sql as $row) {
			$booking_found_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		}*/

		
		//echo $sql;
		
		$i=1;
		$oldpoid=explode(",",$existingpoid); $selectedporow="";
		foreach($sqlD as $row)
		{
			if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
			$selectable=1;
			$tnad=strtotime($tnaArr[$row[csf('id')]]);
			$bod=strtotime(date("d-m-Y"));
			
			if($tnad < $bod && $tna_integrated==1){
				$bgcolor="#F00"; $selectable=0;
			}else{
				$bgcolor=$bgcolor; $selectable=1;
			}
			$sc_lc_check=0; $msg="";
			if($sc_lc_variable==1)//Fabric Booking Control With SC/LC --Yes
			{
				$sc_po=$sc_Arr[$row[csf('id')]];
				$lc_po=$lc_Arr[$row[csf('id')]];
				
				if($sc_po || $lc_po) {
					$sc_lc_check=0; $msg="";
				}
				else { 
					$sc_lc_check=1; $msg="SC/LC is not found against your selected PO,Please ensure it then try again.";
				}
			}
			
			$isYarnAllo=0;
			if($yarnAlloArr[$row[csf("id")]]!="" && $booking_found_arr[$row[csf("id")]] ==""){
				$isYarnAllo=1; $bgcolor="yellow"; $font_color="#00CC66"; $msg="Allocation Found.";
			}
			else if($booking_found_arr[$row[csf("id")]] !="" && $yarnAlloArr[$row[csf("id")]]==""){
				$isYarnAllo=0; $bgcolor="yellow"; $font_color="#00CC66"; $msg="Booking Found.";
			}
			else if($booking_found_arr[$row[csf("id")]] !="" && $yarnAlloArr[$row[csf("id")]]!=""){
				$isYarnAllo=1; $bgcolor="yellow"; $font_color="#00CC66"; $msg="Allocation and Booking Found.";
			}
			else {
				$isYarnAllo=0; $font_color='';
			}
			
			if($BookingArr[$row[csf('id')]]!="") $bgcolor="yellow";// don't remove 
			
			//print_r($oldpoid);
			
			if(in_array($row[csf("id")],$oldpoid)) 
			{ 
				if($selectedporow=="") $selectedporow=$i; else $selectedporow.=",".$i;
			}
			
			?>
             <tr style="color:<?=$font_color;?>" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer;" id="tr_<?=$i; ?>" onClick="js_set_value('<?=$row[csf("id")]."_".$row[csf("po_number")]."_".$row[csf("job_no")]; ?>',this.id,<?=$selectable; ?>,<?=$sc_lc_check; ?>,<?=$isYarnAllo; ?>);">
                <td width="30"><?=$i; ?>
                	<input type="hidden" name="txtindividualid_<?=$i; ?>" id="txtindividualid_<?=$i; ?>" value="<?=$row[csf("id")]."_".$row[csf("po_number")]."_".$row[csf("job_no")]."_".$selectable."_".$sc_lc_check."_".$isYarnAllo; ?>"/>
                </td>
                <td width="60" style="word-break:break-all"><?=$row[csf("job_no_prefix_num")]; ?></td>
                <td width="60" style="word-break:break-all"><?=$comp[$row[csf("company_name")]]; ?></td>
                <td width="50" style="word-break:break-all"><?=$buyer_arr[$row[csf("buyer_name")]]; ?></td>
                <td width="100" style="word-break:break-all"><?=$row[csf("style_ref_no")]; ?></td>
                <td width="100" style="word-break:break-all"><?=$row[csf("grouping")]; ?></td>
                <td width="100" style="word-break:break-all"><?=$row[csf("file_no")]; ?></td>
                <td width="70" align="right"><?=$row[csf("job_quantity")]; ?></td>
                <td width="150" style="word-break:break-all" title="<?=$msg; ?>"><p><?=$row[csf("po_number")]; ?> </p></td>
                <td width="80" align="right"><?=$row[csf("po_quantity")]; ?></td>
                <td style="word-break:break-all"><?=change_date_format($row[csf("shipment_date")],"dd-mm-yyyy",'-'); ?></td>
            </tr>
            <?
			$i++;
		}
		?>
        <input type="hidden" name="hidd_oldRow_no" id="hidd_oldRow_no" value="<?=$selectedporow; ?>"/>
        </table>
    </div>
    <?
	exit();
}

if ($action=="populate_order_data_from_search_popup")
{
	if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
	else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

	$data_array=sql_select("select a.job_no,a.company_name,a.buyer_name,a.sustainability_standard,a.fab_material,a.quality_level,a.requisition_no,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$data.") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name,a.sustainability_standard,a.fab_material,a.quality_level,a.requisition_no");
	foreach ($data_array as $row)
	{
		$grouping=implode(",",array_unique(explode(",",$row[csf("grouping")])));
		$file_no=implode(",",array_unique(explode(",",$row[csf("file_no")])));
		echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_name")]."';\n";
		echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_name")]."';\n";
		echo "document.getElementById('txt_job_no').value = '".$row[csf("job_no")]."';\n";
		echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";
		echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";
		echo "document.getElementById('cbo_quality_level').value = '".$row[csf("quality_level")]."';\n";
		echo "$('#cbo_quality_level').attr('disabled','true')".";\n";
		echo "document.getElementById('sustainability_standard').value = '".$row[csf("sustainability_standard")]."';\n";
		echo "$('#sustainability_standard').attr('disabled','true')".";\n";
		echo "document.getElementById('cbo_fab_material').value = '".$row[csf("fab_material")]."';\n";
		echo "$('#cbo_fab_material').attr('disabled','true')".";\n";
		echo "document.getElementById('txt_requision_no').value = '".$row[csf("requisition_no")]."';\n";
		echo "$('#txt_requision_no').attr('disabled','true')".";\n";
		
		$booking_no="";
		$sql= sql_select("select booking_no from wo_booking_mst  where job_no='".$row[csf("job_no")]."' and booking_type=1");
		foreach($sql as $sql_row)
		{
			$booking_no.=$sql_row[csf('booking_no')].", ";
		}

		if($booking_no=="")
		{
			 echo "document.getElementById('app_sms3').innerHTML = '';\n";
		}
		else
		{
			echo "document.getElementById('app_sms3').innerHTML = 'Booking No ".rtrim($booking_no ,", ")." is found against  this Job No';\n";
		}

		$colar_culff_percent=return_field_value("colar_culff_percent", "variable_order_tracking", "company_name='".$row[csf("company_name")]."'  and variable_list=40 and status_active=1 and is_deleted=0");
		if($colar_culff_percent==1)
		{
			echo "$('#txt_colar_excess_percent').removeAttr('disabled')".";\n";
			echo "$('#txt_cuff_excess_percent').removeAttr('disabled')".";\n";
		}
		if($colar_culff_percent==2)
		{
			echo "$('#txt_colar_excess_percent').attr('disabled','true')".";\n";
		    echo "$('#txt_cuff_excess_percent').attr('disabled','true')".";\n";
		}

		//$sql_delevary=sql_select("select task_number,max(task_finish_date) as task_finish_date from tna_process_mst where po_number_id in(".$data.") and task_number in(73) and is_deleted = 0 and 	status_active=1 group by task_number"); for group
		$sql_delevary=sql_select("select  min(task_start_date) as task_finish_date from tna_process_mst where po_number_id in(".$data.") and task_number in(73) and is_deleted = 0 and 	status_active=1");// added for urmi req from fakhrul
		foreach($sql_delevary as $row_delevary)
		{
		   echo "document.getElementById('txt_delivery_date').value = '".change_date_format($row_delevary[csf("task_finish_date")],'dd-mm-yyyy','-')."';\n";
		   echo "document.getElementById('txt_tna_date').value = '".change_date_format($row_delevary[csf("task_finish_date")],'dd-mm-yyyy','-')."';\n";
		}
	}
}

if ($action=="generate_fabric_booking")
{
	//extract($_REQUEST);
	extract(check_magic_quote_gpc( $_REQUEST ));
	?>
    <table width="2020" class="rpt_table" border="0" rules="all">
        <thead>
        <tr>
            <th colspan="22" align="right">
                 <form>
                    <input type="radio" name="copy_basis" value="0" checked>Copy to All
                    <input type="radio" name="copy_basis" value="1">Copy Gmts Size Wise
                    <input type="radio" name="copy_basis" value="2">Copy Gmts Color Wise
                    <input type="radio" name="copy_basis" value="4">Copy Po Wise
                    <input type="radio" name="copy_basis" value="5">No Copy
                </form>
            </th>
       </tr>
        <tr>
            <th width="30">SL</th>
            <th width="120">PO Number</th>
            <th width="140">Gmts Item</th>
            <th width="120">Body Part</th>
            <th width="100">Color Type</th>
            <th width="100">Construction</th>
            <th width="100">Composition</th>
            <th width="50">GSM</th>
            <th width="80">Dia/Width</th>
            <th width="80">Proces Loss</th>
            <th width="50">Item Size</th>
            <th width="150">Col. Sensivity</th>
            <th width="100">Gmts. Color</th>
            <th width="100">Fab. Color</th>
            <th width="100">Gmts. Size</th>
            <th width="100">Gmts. Qty [Plan Cut]</th>
            <th width="100">Fin Fab Qty</th>
            <th width="100">Gray Qty</th>
            <th width="50">Rate</th>
            <th width="100">Amount</th>
            <th width="60">Colar/ Cuff Percent</th>
            <th>&nbsp;</th>
       </tr>
   </thead>
   </table>
    <div style=" max-height:200px; overflow-y:scroll; width:2020px"  align="left">
    <table width="2003" class="rpt_table" id="tbl_fabric_booking" border="0" rules="all">
    <tbody>
	<?
    $txt_order_no_id=str_replace("'","",$txt_order_no_id);
    $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
    $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
    $cbouom=str_replace("'","",$cbouom);

	$job_sql=sql_select("select a.company_name, a.job_no, b.id, b.po_number, min(c.id) as cid, sum(c.plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where b.id in(".$txt_order_no_id.") and b.job_no_mst=a.job_no and b.id=c.po_break_down_id and b.job_no_mst=c.job_no_mst and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.company_name, a.job_no, b.id, b.po_number, c.color_number_id, c.size_number_id, c.item_number_id");
	$company2=0; $po_number=array(); $paln_cut_qnty_array=array(); $popaln_cut_qnty_array=array();
	foreach($job_sql as $jrow)
	{
		$company2=$jrow[csf("company_name")];
		$po_number[$jrow[csf("id")]]=$jrow[csf("po_number")];
		$paln_cut_qnty_array[$jrow[csf("cid")]]=$jrow[csf("plan_cut_qnty")];
		$popaln_cut_qnty_array[$jrow[csf("id")]]+=$jrow[csf("plan_cut_qnty")];
	}
	unset($job_sql);

    $print_report_format_ids2=return_field_value("format_id","lib_report_template","template_name='".$company2."'  and module_id=2 and report_id=1 and is_deleted=0 and status_active=1");
    $format_ids=explode(",",$print_report_format_ids2);

    if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
    if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
    if ($cbouom!=0) $cbouom_cond="and a.uom='$cbouom'";

    $txt_booking_percent=str_replace("'","",$txt_booking_percent);
    $booking_sql=sql_select("select b.id, sum(a.grey_fab_qnty) as grey_fab_qnty, sum(a.fin_fab_qnty) as fin_fab_qnty from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and  a.po_break_down_id in(".$txt_order_no_id.") and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 group by b.id ");

    foreach($booking_sql as $brow)
    {
        $finish_fabric_qnty_array[$brow[csf("id")]]=$brow[csf("fin_fab_qnty")];
        $grey_fabric_qnty_array[$brow[csf("id")]]=$brow[csf("grey_fab_qnty")];
    }
    unset($booking_sql);

    $body_part_type=return_library_array("select id,body_part_type from lib_body_part", "id", "body_part_type");

	$item_ratio_array=return_library_array("select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select("select a.id as pre_cost_fabric_cost_dtls_id, a.job_no, a.item_number_id, a.body_part_id, a.fab_nature_id, a.fabric_source, a.color_type_id, a.gsm_weight, a.construction, a.composition, a.color_size_sensitive, a.costing_per, a.color, a.color_break_down, a.rate as rate_mst, b.id, b.po_break_down_id, b.color_size_table_id, b.color_number_id, b.gmts_sizes as size_number_id, b.dia_width, b.item_size, b.cons, b.process_loss_percent, b.requirment, b.rate, b.pcs, b.remarks
FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b
WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id in (".$txt_order_no_id.")  $cbo_fabric_natu $cbo_fabric_source_cond $cbouom_cond and a.status_active=1 and a.is_deleted=0 order by a.id,b.color_size_table_id");
	$powiseCostingPerReqQtyArr=array();
	foreach ($nameArray as $nrow)
	{
		$req_grey_fab_qty=0; $reqGreyFabQty=0; $costing_per=0;
		if($nrow[csf("costing_per")]==1) $costing_per=12;
		else if($nrow[csf("costing_per")]==2) $costing_per=1;
		else if($nrow[csf("costing_per")]==3) $costing_per=24;
		else if($nrow[csf("costing_per")]==4) $costing_per=36;
		else if($nrow[csf("costing_per")]==5) $costing_per=48;
		else $costing_per=0;

		$req_grey_fab_qty =($paln_cut_qnty_array[$nrow[csf("color_size_table_id")]]/$item_ratio_array[$nrow[csf("item_number_id")]])*($nrow[csf("requirment")]/$costing_per);
		
		$powiseCostingPerReqQtyArr[$nrow[csf("pre_cost_fabric_cost_dtls_id")]][$nrow[csf("po_break_down_id")]]['greyreqqty']+=$req_grey_fab_qty;
	}

	$count=0; $arr_fab_co_si=array();
	if(count($nameArray)>0)
	{
		foreach ($nameArray as $result)
		{
			$constrast_color_arr=array();
			if($result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
			if ($count%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
			$bala_fin_fab_qnty=0; $bala_grey_fab_qnty=0;
			$costing_per=0;
			if($result[csf("costing_per")]==1) $costing_per=12;
			else if($result[csf("costing_per")]==2) $costing_per=1;
			else if($result[csf("costing_per")]==3) $costing_per=24;
			else if($result[csf("costing_per")]==4) $costing_per=36;
			else if($result[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;

			$bala_fin_fab_qnty =def_number_format(((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$item_ratio_array[$result[csf("item_number_id")]])*($result[csf("cons")]/$costing_per))*($txt_booking_percent/100)),5,"");
			
			$bala_grey_fab_qnty =def_number_format(((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$item_ratio_array[$result[csf("item_number_id")]])*($result[csf("requirment")]/$costing_per))*($txt_booking_percent/100)),5,"");
			

			$bala_fin_fab_qnty=def_number_format($bala_fin_fab_qnty-$finish_fabric_qnty_array[$result[csf("id")]],5,"");
			$bala_grey_fab_qnty=def_number_format($bala_grey_fab_qnty-$grey_fabric_qnty_array[$result[csf("id")]],5,"");
			$itempoWiseReqQty=0;
			
			$itempoWiseReqQty=def_number_format(($powiseCostingPerReqQtyArr[$result[csf("pre_cost_fabric_cost_dtls_id")]][$result[csf("po_break_down_id")]]['greyreqqty']/($popaln_cut_qnty_array[$result[csf("po_break_down_id")]]/$item_ratio_array[$result[csf("item_number_id")]]))*$costing_per,5,"");

			if($bala_fin_fab_qnty>0  || $bala_grey_fab_qnty> 0)
			{
				$count++;
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$count; ?>','<?=$bgcolor;?>');" id="tr_<?=$count; ?>">
                    <td width="30"><?=$count;?></td>
                    <td width="120" style="word-break:break-all"><?=$po_number[$result[csf("po_break_down_id")]]; ?> <input type="hidden" id="pobreakdownid_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("po_break_down_id")]; ?>"/></td>
                    <td width="140" style="word-break:break-all"><?=$garments_item[$result[csf("item_number_id")]];?></td>
                    <td width="120">
						<?=$body_part[$result[csf("body_part_id")]];?>
                        <input  type="hidden" id="bodypartid_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("body_part_id")]; ?>"/>
                        <input type="hidden" id="bodyparttype_<?=$count; ?>" style="width:20px;" value="<?=$body_part_type[$result[csf("body_part_id")]]; ?>"/>
                    </td>
                    <td width="100"><?=$color_type[$result[csf("color_type_id")]];?> <input type="hidden" id="colortype_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("color_type_id")]; ?>"/></td>
                    <td width="100"><?=$result[csf("construction")]; ?>
                        <input type="hidden" id="construction_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("construction")]; ?>"/>
                        <input type="hidden" id="precostfabriccostdtlsid_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("pre_cost_fabric_cost_dtls_id")]; ?>"/></td>
                    <td width="100"><?=$result[csf("composition")]; ?>
                        <input type="hidden" id="composition_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("composition")]; ?>"/>
                        <input type="hidden" id="cotaid_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("color_size_table_id")]; ?>"/>
                        <input type="hidden" id="preconskg_<?=$count; ?>" style="width:20px;" value="<?=$itempoWiseReqQty; ?>"/>
                    </td>
                    <td width="50"><?=$result[csf("gsm_weight")]; ?> <input type="hidden" id="gsmweight_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("gsm_weight")]; ?>"/></td>
                    <td width="80">
						<?=$result[csf("dia_width")]; ?>
                        <input type="hidden" id="diawidth_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("dia_width")]; ?>"/>
                        <input type="hidden" id="remarks_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("remarks")]; ?>"/>
                    </td>
                    <td width="80"><?=$result[csf("process_loss_percent")]; ?> <input type="hidden" id="processlosspercent_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("process_loss_percent")]; ?>"/></td>
                    <td width="50" style="word-break:break-all"><?=$result[csf("item_size")];?></td>
                    <td width="150"><?=$size_color_sensitive[$result[csf("color_size_sensitive")]]; ?></td>
                    <td width="100"><input type="hidden" id="gmtscolorid_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("color_number_id")]; ?>"/>
                    	<? if($result[csf("color_size_sensitive")]!=0) echo $color_library[$result[csf("color_number_id")]]; ?>
                    </td>
                    <td width="100">
						<?
                        $color_id="";
                        if($result[csf("color_size_sensitive")]==3)
                        {
                            echo $constrast_color_arr[$result[csf("color_number_id")]];
                            $color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$result[csf('pre_cost_fabric_cost_dtls_id')]." and gmts_color_id=".$result[csf('color_number_id')]."");
                        }
                        else if($result[csf("color_size_sensitive")]==0)
                        {
                            echo $color_library[$result[csf("color")]]; $color_id=$result[csf("color")];
                        }
                        else
                        {
                            echo $color_library[$result[csf("color_number_id")]]; $color_id=$result[csf("color_number_id")];
                        }
                        ?>
                        <input  type="hidden" id="colorid_<?=$count; ?>" style="width:20px;" value="<?=$color_id; ?>"/>
                    </td>
                    <td width="100"><?=$size_library[$result[csf("size_number_id")]]; ?>
                    	<input type="hidden" id="gmtssizeid_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("size_number_id")]; ?>"/>
                    </td>
                    <td align="right" width="100"><?=$paln_cut_qnty_array[$result[csf("color_size_table_id")]]; ?></td>
                    <td align="right" width="100">
                    	<input type="text" id="finscons_<?=$count; ?>" name="finscons_<?=$count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<?=$bgcolor; ?>;font-family:verdana; font-size:11px" onChange="validate_value(<?=$count ;?>,'finish');" value="<?=$bala_fin_fab_qnty; ?>" placeholder="<?=$bala_fin_fab_qnty; $tot_bala_fin_fab_qnty+=$bala_fin_fab_qnty; ?>"/>
                    </td>
                    <td align="right" width="100">
                    	<input type="text" id="greycons_<?=$count; ?>" name="greycons_<?=$count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<?=$bgcolor; ?>;font-family:verdana; font-size:11px" onChange="validate_value(<?=$count ;?>,'grey');" value="<?=$bala_grey_fab_qnty; ?>" placeholder="<?=$bala_grey_fab_qnty; $tot_bala_grey_fab_qnty+=$bala_grey_fab_qnty;?>"/>
                    </td>
                    <td align="right" width="50"><input type="text" id="rate_<?=$count; ?>" style="width:100%; height:100%; border:none; text-align:right; background-color:<?= $bgcolor; ?>;font-family:verdana; font-size:11px" onChange="validate_value(<?=$count ;?>,'rate');" bomrate="<?=number_format($result[csf("rate")],4); ?>" value="<?=$result[csf("rate")]; ?>" <? if ($cbo_fabric_source==1){ echo "readonly";} else { echo "";}  ?>/> </td>
                    <td align="right" width="100"> <input type="text" id="amount_<?=$count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<?=$bgcolor; ?>;font-family:verdana; font-size:11px" value="<?=def_number_format(($result[csf("rate")]*$bala_grey_fab_qnty),5,''); ?>" readonly/></td>
                    <?
                    $colarculfpercentreadonly=""; $collar_culf_per="";
                    if($body_part_type[$result[csf("body_part_id")]]==40){
                    	$colarculfpercentreadonly="";  $collar_culf_per=str_replace("'","",$txt_colar_excess_percent);
                    }
                    else if($body_part_type[$result[csf("body_part_id")]]==50){
                    	$colarculfpercentreadonly=""; $collar_culf_per=str_replace("'","",$txt_cuff_excess_percent);
                    }
                    else
                    {
                    	$colarculfpercentreadonly="readonly";  $collar_culf_per="";
                    }
                    ?>
                    <td align="right" width="60"><input type="text" id="colarculfpercent_<?=$count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<?=$bgcolor; ?>;font-family:verdana; font-size:11px" value="<?=$collar_culf_per; ?>" <?=$colarculfpercentreadonly; ?>  onChange="copy_colarculfpercent(<?=$count; ?>)" /></td>
                    <td align="right"><input type="text" id="updateid_<?=$count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<?=$bgcolor; ?>;font-family:verdana; font-size:11px" value="<? //=$result[csf("id")]; ?>" readonly/></td>
                    <td align="right"><?  ?></td>
				</tr>
				<?
			}
		} // if count namearray end
	} // for each name arra
	?>
	</tbody>
    </table>

    </div>
    <?
    if($count==0)
	{
		$value ="Full Booked"; $display="";
	}
	else
	{
		$value =""; $display="none";
	}
	?>
    <table width="2020" class="rpt_table" border="0" rules="all">
        <tfoot>
            <tr>
            	<td width="30" align="center" colspan="21" id="full_booked" style="font-size:50; font-weight:bold; display:<? echo $display; ?>"><? echo $value; ?></td>
            </tr>
            <tr>
                <th width="30"></th>
                <th width="120"></th>
                <th width="140"></th>
                <th width="120"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="50"></th>
                <th width="80"></th>
                <th width="80"></th>
                <th width="50"></th>
                <th width="150"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"><? echo number_format($tot_bala_fin_fab_qnty,4);?></th>
                <th width="100"><? echo number_format($tot_bala_grey_fab_qnty,4);?></th>
                <th width="50"></th>
                <th width="100"></th>
                <th width="60"></th>
                <th></th>
            </tr>
        </tfoot>
    </table>
    <table width="2020" class="rpt_table" border="0" rules="all">
        <tr>
            <td align="center" width="100%" colspan="18" class="button_container">
            <?
            echo load_submit_buttons( $permission, "fnc_fabric_booking_dtls",0,0,"",2) ;
            foreach($format_ids as $row_id)
            {
				if($row_id==1)
				{
					?>
					<input type="button" value="Print GP" onClick="generate_fabric_report_gr('show_fabric_booking_report_gr');" style="width:80px;" name="print_gr" id="print_gr" class="formbutton" />
					<input type="hidden" id="booking_option" name="booking_option" /><input type="hidden" id="booking_option_no" name="booking_option_no" />
					<input type="hidden" id="booking_option_id" name="booking_option_id" />
					<?
				}
				if($row_id==2)
				{
					?><input type="button" value="Print B1" onClick="generate_fabric_report('show_fabric_booking_report');" style="width:80px;" name="print" id="print" class="formbutton" /><a id="print1" href="" style="text-decoration:none" download hidden>B1</a><?
				}
				if($row_id==3)
				{
					?><input type="button" value="Print B2" onClick="generate_fabric_report('show_fabric_booking_report3');" style="width:80px;" name="print_booking3" id="print_booking3" class="formbutton" /><?
				}
				if($row_id==4)
				{
					?><input type="button" value="Print Cut1" onClick="generate_fabric_report('show_fabric_booking_report1');" style="width:80px;" name="print_booking1" id="print_booking1" class="formbutton" /><?
				}
				if($row_id==5)
				{
					?><input type="button" value="Print Cut2" onClick="generate_fabric_report('show_fabric_booking_report2');" style="width:80px;" name="print_booking2" id="print_booking2" class="formbutton" /><?
				}
				if($row_id==6)
				{
					?><input type="button" value="Print B3" onClick="generate_fabric_report('show_fabric_booking_report4');" style="width:80px;" name="print_booking4" id="print_booking4" class="formbutton" /><?
				}
				if($row_id==7)
				{
					?><input type="button" value="Print B3" onClick="generate_fabric_report('show_fabric_booking_report5');" style="width:80px;" name="print_booking5" id="print_booking5" class="formbutton" /><?
				}
				if($row_id==28)
				{
					?><input type="button" value="Print B13" onClick="generate_fabric_report('show_fabric_booking_report_akh');" style="width:80px;" name="print_booking_akh" id="print_booking_akh" class="formbutton" /><?
				}
				if($row_id==45)
				{
					?><input type="button" value="Print B4" onClick="generate_fabric_report('show_fabric_booking_report_urmi');" style="width:80px;" name="print_booking_urmi" id="print_booking_urmi" class="formbutton" /><?
				}
				if($row_id==53)
				{
					?><input type="button" value="Print B5" onClick="generate_fabric_report('show_fabric_booking_report_jk');" style="width:80px;" name="print_booking_jk" id="print_booking_jk" class="formbutton" /><?
				}
				if($row_id==432)
				{
					?><input type="button" value="Print B5.1" onClick="generate_fabric_report('show_fabric_booking_report_fn');"  style="width:80px;" name="print_booking_fn" id="print_booking_fn" class="formbutton" /><?
				}
				if($row_id==73)
				{
					?><input type="button" value="Print B6" onClick="generate_fabric_report('show_fabric_booking_report_mf')"  style="width:80px;" name="print_booking_mf" id="print_booking_mf" class="formbutton" /><?
				}
				if($row_id==84)
				{
					?><input type="button" value="Print B7" onClick="generate_fabric_report('show_fabric_booking_report_islam')"  style="width:80px;" name="print_booking_islam" id="print_booking_islam" class="formbutton" /><?
				}
				if($row_id==93)
				{
					?><input type="button" value="Print B9" onClick="generate_fabric_report('show_fabric_booking_report_libas')"  style="width:80px;" name="print_booking_libas" id="print_booking_libas" class="formbutton" /><?
				}
				if($row_id==129)
				{
					?><input type="button" value="Print B10" onClick="generate_fabric_report('show_fabric_booking_report_print5')"  style="width:80px;" name="print_booking_5" id="print_booking_5" class="formbutton" /><?
				}
				if($row_id==193)
				{
					?><input type="button" value="Print B11" onClick="generate_fabric_report('show_fabric_booking_report_print4')"  style="width:80px;" name="print_booking_4" id="print_booking_4" class="formbutton" /><?
				}
				if($row_id==269)
				{
					?><input type="button" value="Print B12" onClick="generate_fabric_report('show_fabric_booking_report_knit')"  style="width:80px;" name="print_booking_6" id="print_booking_6" class="formbutton" /><?
				}
				if($row_id==280)
				{
					?><input type="button" value="Print B14" onClick="generate_fabric_report('show_fabric_booking_report_print14')"  style="width:80px;" name="print_booking_14" id="print_booking_14" class="formbutton" /><?
				}
				if($row_id==39)
				{
					?><input type="button" value="Print Booking2" onClick="generate_fabric_report('show_fabric_booking_report_print39')"  style="width:120px;" name="print_booking_39" id="print_booking_39" class="formbutton" /><?
				}
				if($row_id==304)
				{
					?><input type="button" value="Print B15" onClick="generate_fabric_report('show_fabric_booking_report10')"  style="width:120px;" name="print_booking_15" id="print_booking_15" class="formbutton" /><?
				}
				if($row_id==719)
				{
					?>
					 <input type="button" value="Print B16" onClick="generate_fabric_report('show_fabric_booking_report16')"  style="width:120px;" name="print_booking_16" id="print_booking_16" class="formbutton" />
					 <?
				}
				if($row_id==723)
				{
					?><input type="button" value="Print B17" onClick="generate_fabric_report('show_fabric_booking_report17')"  style="width:120px;" name="print_booking_17" id="print_booking_17" class="formbutton" /><?
				}
				if($row_id==339)
				{
					?><input type="button" value="Print B18" onClick="generate_fabric_report('show_fabric_booking_report18')"  style="width:120px;" name="print_booking_18" id="print_booking_18" class="formbutton" /><?
				}
				if($row_id==370)
				{
					
					?><input type="button" value="Print B19" onClick="generate_fabric_report('show_fabric_booking_report_print19')"  style="width:80px;" name="print_booking_19" id="print_booking_19" class="formbutton" /><?
				}
				if($row_id==383)
				{
					
					?><input type="button" value="Print B20" onClick="generate_fabric_report('show_fabric_booking_report_print20')"  style="width:80px;" name="print_booking_20" id="print_booking_20" class="formbutton" /><?
				}
				if($row_id==404)
				{
					?><input type="button" value="Print B21" onClick="generate_fabric_report('show_fabric_booking_report21')"  style="width:80px;" name="print_booking_21" id="print_booking_21" class="formbutton" /><?
				}if($row_id==419)
				{
					?><input type="button" value="Print B22" onClick="generate_fabric_excel_report('show_fabric_booking_report22')"  style="width:80px;" name="print_booking_22" id="print_booking_22" class="formbutton" />&nbsp;<a id="print_report22" href="" style="text-decoration:none" download hidden>BB</a><?
				}if($row_id==426)
				{
					?><input type="button" value="Print B23" onClick="generate_fabric_report('show_fabric_booking_report_print23')"  style="width:80px;" name="print_booking_23" id="print_booking_23" class="formbutton" /><?
				}
				if($row_id==452)
				{
				
					?><input type="button" value="Print B24" onClick="generate_fabric_report('show_fabric_booking_report_print24')"  style="width:80px;" name="print_booking_24" id="print_booking_24" class="formbutton" /><?
				}
				if($row_id==786)
				{
				
					?><input type="button" value="Print B25" onClick="generate_fabric_report('show_fabric_booking_report25')"  style="width:80px;" name="print_booking_25" id="print_booking_25" class="formbutton" /><?
				}
            }
            //var_dump($format_ids);
            ?>
            </td>
        </tr>
    </table>
	<?
	exit();
}

if ($action=="show_fabric_booking")
{
	//extract($_REQUEST);
	extract(check_magic_quote_gpc( $_REQUEST ));
	?>
    <table width="2020" class="rpt_table" border="0" rules="all">
        <thead>
            <tr>
                <th colspan="22" align="right">
                <form>
                <input type="radio" name="copy_basis" value="0" checked>Copy to All
                <input type="radio" name="copy_basis" value="1">Copy Gmts Size Wise
                <input type="radio" name="copy_basis" value="2">Copy Gmts Color Wise
                <input type="radio" name="copy_basis" value="4">Copy Po Wise
                <input type="radio" name="copy_basis" value="5">No Copy
                </form>
                </th>
            </tr>
            <tr>
                <th width="30">SL</th>
                <th width="120">PO Number</th>
                <th width="140">Gmts Item</th>
                <th width="120">Body Part</th>
                <th width="100">Color Type</th>
                <th width="100">Construction</th>
                <th width="100">Composition</th>
                <th width="50">GSM</th>
                <th width="80">Dia/Width</th>
                <th width="80">Proces Loss</th>
                <th width="50">Item Size</th>
                <th width="150">Col. Sensivity</th>
                <th width="100">Gmts.Color</th>
                <th width="100">Fab.Color</th>
                <th width="100">Gmts. Sizes</th>
                <th width="100">Gmts. Quantity (Plan Cut)</th>
                <th width="100">Fin Fab Qnty</th>
                <th width="100">Gray Qnty</th>
                <th width="50">Rate</th>
                <th width="100">Amount</th>
                <th width="60">Colar/ Cuff percent</th>
                <th>&nbsp;</th>
            </tr>
        </thead>
    </table>
    <div style=" max-height:200px; overflow-y:scroll; width:2020px"  align="left">
    <table width="2003" class="rpt_table" id="tbl_fabric_booking" border="0" rules="all">
    <tbody>
	<?
	
	
	$sql_po="select c.id,c.po_number,a.company_id,a.is_approved from wo_po_break_down c, wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and c.job_no_mst=b.job_no and c.id=b.po_break_down_id and a.booking_no='".str_replace("'","",$txt_booking_no)."' and a.is_deleted=0 and a.status_active=1  and b.is_deleted=0 and b.status_active=1";
	$result_po=sql_select($sql_po);
	foreach($result_po as $row)
	{
		$company_id=$row[csf('company_id')];$is_approved=$row[csf('is_approved')];
	}
	
	$txt_order_no_id=str_replace("'","",$txt_order_no_id);
	$job_sql=sql_select("select a.company_name, a.job_no, b.id, b.po_number, min(c.id) as cid, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where b.id in(".$txt_order_no_id.") and b.job_no_mst=a.job_no and b.id=c.po_break_down_id and b.job_no_mst=c.job_no_mst and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.company_name, a.job_no, b.id, b.po_number, c.color_number_id, c.size_number_id, c.item_number_id");
	$company2=0; $po_number_arr=array(); $paln_cut_qnty_array=array(); $popaln_cut_qnty_array=array();
	foreach($job_sql as $jrow)
	{
		$company2=$jrow[csf("company_name")];$job_no=$jrow[csf("job_no")];
		$po_number_arr[$jrow[csf("id")]]=$jrow[csf("po_number")];
		$paln_cut_qnty_array[$jrow[csf("cid")]]=$jrow[csf("plan_cut_qnty")];
		$popaln_cut_qnty_array[$jrow[csf("id")]]+=$jrow[csf("plan_cut_qnty")];
	}
	unset($job_sql);

	$print_report_format_ids=return_field_value("format_id"," lib_report_template","template_name ='".$company_id."'  and module_id=2 and report_id=1  and is_deleted=0 and status_active=1");
	$format_id=explode(",",$print_report_format_ids);

	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$cbouom=str_replace("'","",$cbouom);
	$tot_finish_fab_qnty=0; $tot_grey_fab_qnty=0;
	if($type==1)
	{
		$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
		$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
		if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
		if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
		if ($cbouom!=0) $cbouom_cond="and a.uom='$cbouom'";
		$txt_booking_percent=str_replace("'","",$txt_booking_percent);
		
		$booking_dtls_sql="SELECT a.id as booking_dtls_id, b.id, a.fabric_color_id, a.fin_fab_qnty, a.grey_fab_qnty, a.amount, a.rate, a.colar_cuff_per  from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_pre_cost_fabric_cost_dtls c where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id in(".$txt_order_no_id.") and a.booking_no='$txt_booking_no' and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
		$booking_dtls_res=sql_select($booking_dtls_sql);
		$booking_dtls_id_array=array(); $fabric_color_array=array(); $finish_fabric_qnty_array=array(); $grey_fabric_qnty_array=array(); $grey_fabric_amount_array=array(); $grey_fabric_rate_array=array(); $colar_cuff_percent_array=array();

		foreach($booking_dtls_res as $row)
		{
			$booking_dtls_id_array[$row[csf("id")]]=$row[csf("booking_dtls_id")];
			//$job_no=$row[csf("job_no")];
			$fabric_color_array[$row[csf("id")]]=$row[csf("fabric_color_id")];
			$finish_fabric_qnty_array[$row[csf("id")]]+=$row[csf("fin_fab_qnty")];
			$grey_fabric_qnty_array[$row[csf("id")]]+=$row[csf("grey_fab_qnty")];
			$grey_fabric_amount_array[$row[csf("id")]]=$row[csf("amount")];
			$grey_fabric_rate_array[$row[csf("id")]]['rate']=$row[csf("rate")];
			$grey_fabric_rate_array[$row[csf("id")]]['colar_cuff_per']=$row[csf("colar_cuff_per")];
		}
		unset($booking_dtls_res);

		$contrastcolor_id="select job_no, pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls ";
		$contrastcolor_id_res=sql_select($contrastcolor_id); $contrastcolor_arr=array();
		foreach($contrastcolor_id_res as $row)
		{
			$contrastcolor_arr[$row[csf("job_no")]][$row[csf("pre_cost_fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
		}
		unset($contrastcolor_id_res);

		$colar_cuff_percent_array=return_library_array( "select a.id as booking_dtls_id,a.colar_cuff_per,b.id from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and  a.po_break_down_id in(".$txt_order_no_id.") and a.booking_no='$txt_booking_no' and a.booking_type=1 and a.status_active=1 and a.is_deleted=0", "id", "colar_cuff_per");

		$body_part_type=return_library_array( "select id,body_part_type from lib_body_part", "id", "body_part_type"  );
		//$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down",'id','po_number');
		//echo "select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details  where job_no ='$job_no'";
		$item_ratio_array=return_library_array( "select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details  where job_no ='$job_no'", "gmts_item_id", "set_item_ratio");

		$name_sql="select a.id as pre_cost_fabric_cost_dtls_id, a.job_no, a.item_number_id, a.body_part_id, a.fab_nature_id, a.fabric_source, a.color_type_id, a.gsm_weight, a.construction, a.composition, a.color_size_sensitive, a.costing_per, a.color, a.color_break_down, a.rate as rate_mst, b.id, b.po_break_down_id, b.color_size_table_id, b.color_number_id, b.gmts_sizes as size_number_id, b.dia_width, b.item_size, b.cons, b.process_loss_percent, b.requirment, b.rate, b.pcs, b.remarks

		FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id in (".$txt_order_no_id.")  $cbo_fabric_natu $cbo_fabric_source_cond $cbouom_cond and a.status_active=1 and a.is_deleted=0 order by a.id,b.color_size_table_id";
		$nameArray=sql_select($name_sql);
		$powiseCostingPerReqQtyArr=array();
		foreach ($nameArray as $nrow)
		{
			$req_grey_fab_qty=0; $reqGreyFabQty=0; $costing_per=0;
			if($nrow[csf("costing_per")]==1) $costing_per=12;
			else if($nrow[csf("costing_per")]==2) $costing_per=1;
			else if($nrow[csf("costing_per")]==3) $costing_per=24;
			else if($nrow[csf("costing_per")]==4) $costing_per=36;
			else if($nrow[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;
	
			$req_grey_fab_qty =($paln_cut_qnty_array[$nrow[csf("color_size_table_id")]]/$item_ratio_array[$nrow[csf("item_number_id")]])*($nrow[csf("requirment")]/$costing_per);
			$powiseCostingPerReqQtyArr[$nrow[csf("pre_cost_fabric_cost_dtls_id")]][$nrow[csf("po_break_down_id")]]['greyreqqty']+=$req_grey_fab_qty;
		}
		//print_r($powiseCostingPerReqQtyArr);
		
        $count=0;
        foreach ($nameArray as $result)
        {
            if (count($nameArray)>0 )
            {
                $constrast_color_arr=array();
                if($result[csf("color_size_sensitive")]==3)
                {
                    $constrast_color=explode('__',$result[csf("color_break_down")]);
                    for($i=0;$i<count($constrast_color);$i++)
                    {
                        $constrast_color2=explode('_',$constrast_color[$i]);
                        $constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
                    }
                }

			    if ($count%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				/*if($result[csf("costing_per")]==1) $price_costing_per=12*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==2) $price_costing_per=1*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==3) $price_costing_per=24*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==4) $price_costing_per=36*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==5) $price_costing_per=48*$item_ratio_array[$result[csf("item_number_id")]];
				else $price_costing_per=0;

				//$bala_fin_fab_qnty=0; $bala_grey_fab_qnty=0;
				//echo $paln_cut_qnty_array[$result[csf("color_size_table_id")]].'='.$price_costing_per.'='.$result[csf("cons")].'='.$txt_booking_percent.',';
				$bala_fin_fab_qnty=def_number_format((((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$price_costing_per)*$result[csf("cons")])*$txt_booking_percent)/100),5,"");
				$bala_grey_fab_qnty=def_number_format((((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$price_costing_per)*$result[csf("requirment")])*$txt_booking_percent)/100),5,"");*/
				
				$costing_per=0;
				if($result[csf("costing_per")]==1) $costing_per=12;
				else if($result[csf("costing_per")]==2) $costing_per=1;
				else if($result[csf("costing_per")]==3) $costing_per=24;
				else if($result[csf("costing_per")]==4) $costing_per=36;
				else if($result[csf("costing_per")]==5) $costing_per=48;
				else $costing_per=0;
	
				$bala_fin_fab_qnty =def_number_format(((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$item_ratio_array[$result[csf("item_number_id")]])*($result[csf("cons")]/$costing_per))*($txt_booking_percent/100)),5,"");
				
				$bala_grey_fab_qnty =def_number_format(((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$item_ratio_array[$result[csf("item_number_id")]])*($result[csf("requirment")]/$costing_per))*($txt_booking_percent/100)),5,"");
				//echo $bala_fin_fab_qnty.'='.$bala_grey_fab_qnty.', ';
				
				$itempoWiseReqQty=0;
			
				$itempoWiseReqQty=def_number_format(($powiseCostingPerReqQtyArr[$result[csf("pre_cost_fabric_cost_dtls_id")]][$result[csf("po_break_down_id")]]['greyreqqty']/($popaln_cut_qnty_array[$result[csf("po_break_down_id")]]/$item_ratio_array[$result[csf("item_number_id")]]))*$costing_per,5,"");
				//echo $po_number_arr[$result[csf("po_break_down_id")]].'=='.$powiseCostingPerReqQtyArr[$result[csf("po_break_down_id")]]['greyreqqty'].'=='.$popaln_cut_qnty_array[$result[csf("po_break_down_id")]].'=='.$item_ratio_array[$result[csf("item_number_id")]].'<br>';
				
				if($finish_fabric_qnty_array[$result[csf("id")]]>0  || $grey_fabric_qnty_array[$result[csf("id")]]> 0  )
				{
					$count++;
					?>
                	<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$count; ?>','<?=$bgcolor; ?>');" id="tr_<?=$count; ?>">
                        <td width="30" onClick="select_id_for_delete_item(<?=$count; ?>);"> <?=$count;   ?></td>
                        <td width="120" style="word-break:break-all"><?=$po_number_arr[$result[csf("po_break_down_id")]];?> 
                        <input type="hidden" id="pobreakdownid_<?=$count; ?>" style="width:20px;" value="<?=$result[csf("po_break_down_id")]; ?>"/></td>
                        <td width="140"><?=$garments_item[$result[csf("item_number_id")]];?></td>
                        <td width="120">
							<? echo $body_part[$result[csf("body_part_id")]];?>
                            <input  type="hidden" id="bodypartid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("body_part_id")]; ?>"/>
                            <input type="hidden" id="bodyparttype_<? echo $count; ?>" style="width:20px;" value="<? echo $body_part_type[$result[csf("body_part_id")]]; ?>"/>
                        </td>
                        <td width="100"><? echo $color_type[$result[csf("color_type_id")]];?> <input type="hidden" id="colortype_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("color_type_id")]; ?>"/></td>
                        <td width="100"><? echo $result[csf("construction")]; ?>
                            <input type="hidden" id="construction_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("construction")]; ?>"/>
                            <input type="hidden" id="precostfabriccostdtlsid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("pre_cost_fabric_cost_dtls_id")]; ?>"/></td>
                        <td width="100"><? echo $result[csf("composition")]; ?>
                            <input type="hidden" id="composition_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("composition")]; ?>"/>
                            <input type="hidden" id="cotaid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("color_size_table_id")]; ?>"/>
                            <input type="hidden" id="preconskg_<? echo $count; ?>" style="width:20px;" value="<?=$itempoWiseReqQty; ?>"/>
                        </td>

                        <td width="50"><? echo $result[csf("gsm_weight")]; ?> <input type="hidden" id="gsmweight_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("gsm_weight")]; ?>"/></td>
                        <td width="80">
							<?  echo $result[csf("dia_width")]; ?>
                            <input type="hidden" id="diawidth_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("dia_width")]; ?>"/>
                            <input type="hidden" id="remarks_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("remarks")]; ?>"/>
                        </td>
                        <td width="80"><?  echo $result[csf("process_loss_percent")]; ?> <input type="hidden" id="processlosspercent_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("process_loss_percent")]; ?>"/></td>
                        <td width="50"><p><?  echo $result[csf("item_size")];?></p></td>
                        <td width="150"><? echo $size_color_sensitive[$result[csf("color_size_sensitive")]];  ?></td>
                        <td width="100">
                            <input  type="hidden" id="gmtscolorid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("color_number_id")]; ?>"/>
                            <? if($result[csf("color_size_sensitive")]!=0) echo $color_library[$result[csf("color_number_id")]]; ?>
                        </td>
                        <td width="100">
							<?
                            $color_id="";
                            if($type==1)
                            {
                                echo $color_library[$fabric_color_array[$result[csf("id")]]];
                                $color_id=$fabric_color_array[$result[csf("id")]];
                            }
                            else if($type==2)
                            {
                                if($result[csf("color_size_sensitive")]==3)
                                {
                                    echo $constrast_color_arr[$result[csf("color_number_id")]]; $color_id=$contrastcolor_arr[$result[csf("job_no")]][$result[csf("pre_cost_fabric_cost_dtls_id")]][$result[csf("color_number_id")]];
                                }
                                else if($result[csf("color_size_sensitive")]==0)
                                {
                                    echo $color_library[$result[csf("color")]]; $color_id=$result[csf("color")];
                                }
                                else
                                {
                                    echo $color_library[$result[csf("color_number_id")]]; $color_id=$result[csf("color_number_id")];
                                }
                            }
                            ?>
                            <input  type="hidden" id="colorid_<? echo $count; ?>" style="width:20px;" value="<? echo $color_id; ?>"/>
                        </td>
                        <td width="100"><? echo $size_library[$result[csf("size_number_id")]]; ?>
                            <input  type="hidden" id="gmtssizeid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("size_number_id")]; ?>"/>
                        </td>
                        <td align="right" width="100"> <? echo $paln_cut_qnty_array[$result[csf("color_size_table_id")]]; ?></td>
                        <td align="right" width="100">
                        	<input type="text" title="<? echo $result[csf("cons")]; ?>"   id="finscons_<? echo $count; ?>" name="finscons_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  onChange="validate_value( <? echo $count ;?>,'finish')" value="<?  echo $finish_fabric_qnty_array[$result[csf("id")]]; $tot_finish_fab_qnty+=$finish_fabric_qnty_array[$result[csf("id")]];  ?>" placeholder="<?=def_number_format($bala_fin_fab_qnty,2,'');?>" />
                        </td>
                        <td align="right" width="100">
                        	<input type="text"   id="greycons_<? echo $count; ?>" name="greycons_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  onChange="validate_value( <? echo $count ;?>,'grey')" value="<?   echo  $grey_fabric_qnty_array[$result[csf("id")]]; $tot_grey_fab_qnty+=$grey_fabric_qnty_array[$result[csf("id")]];?>" placeholder="<?   echo def_number_format($bala_grey_fab_qnty,2,'');?>"/>
                        </td>
                        <td align="right" width="50"><input type="text" id="rate_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px" onChange="validate_value(<? echo $count ;?>,'rate');" bomrate="<?=number_format($result[csf("rate")],4); ?>" value="<? echo number_format($grey_fabric_rate_array[$result[csf("id")]]['rate'],4); ?>" <? if ($cbo_fabric_source==1){ echo "readonly";} else { echo "";} ?>/></td>
                        <td align="right" width="100"><input type="text" id="amount_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px" value="<? echo $grey_fabric_amount_array[$result[csf("id")]]; $tot_grey_fab_amount+=$grey_fabric_amount_array[$result[csf("id")]]; ?>" readonly/></td>
                        <?
						$colarculfpercentreadonly=""; $collar_culf_per="";
						if($body_part_type[$result[csf("body_part_id")]]==40 && $colar_cuff_percent_array[$result[csf("id")]]==''){
							$colarculfpercentreadonly=""; $collar_culf_per=str_replace("'","",$txt_colar_excess_percent);
						}
						else if($body_part_type[$result[csf("body_part_id")]]==40 && $colar_cuff_percent_array[$result[csf("id")]]!=''){
							$colarculfpercentreadonly=""; $collar_culf_per=$colar_cuff_percent_array[$result[csf("id")]];
						}
						else if($body_part_type[$result[csf("body_part_id")]]==50  && $colar_cuff_percent_array[$result[csf("id")]]==''){
							$colarculfpercentreadonly=""; $collar_culf_per=str_replace("'","",$txt_cuff_excess_percent);
						}
						else if($body_part_type[$result[csf("body_part_id")]]==50  && $colar_cuff_percent_array[$result[csf("id")]]!=''){
							$colarculfpercentreadonly=""; $collar_culf_per=$colar_cuff_percent_array[$result[csf("id")]];
						}
						else
						{
							$colarculfpercentreadonly="readonly"; $collar_culf_per=$colar_cuff_percent_array[$result[csf("id")]];
						}
						?>
                        <td align="right" width="60"><input type="text" id="colarculfpercent_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  value="<? echo $collar_culf_per; ?>" <? echo $colarculfpercentreadonly; ?> onChange="copy_colarculfpercent(<? echo $count; ?>)" /> </td>
                        <td align="right">
                        <input type="text" id="updateid_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  value="<? echo $booking_dtls_id_array [$result[csf("id")]]; ?>" readonly />
                        </td>
                    </tr>
                	<?
				}
			} // if count namearray end
		} // for each name arra
	}

	if($type==2)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");

		execute_query( "update wo_booking_mst set is_apply_last_update=1 where booking_no ='".$txt_booking_no."' and status_active=1 and is_deleted=0",0);
		execute_query( "UPDATE wo_booking_mst a
					   SET a.fab_material =
					          (SELECT b.fab_material
					                 FROM wo_po_details_master b
					                WHERE     a.job_no = b.job_no
					                and b.is_deleted=0
					           ),
					       a.requisition_no =
					          (SELECT b.requisition_no
					            FROM wo_po_details_master b
					                WHERE   a.job_no = b.job_no
					                and b.is_deleted=0),
					       a.sustainability_standard =
					          (SELECT b.sustainability_standard
					             FROM wo_po_details_master b
					                WHERE   a.job_no = b.job_no
					                and b.is_deleted=0),
					        a.quality_level =
					          (SELECT b.quality_level
					             FROM wo_po_details_master b
					                WHERE   a.job_no = b.job_no
					                and b.is_deleted=0)
					                
					 WHERE a.booking_no = '".$txt_booking_no."' and status_active=1 and is_deleted=0",0);
		$rID= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no ='".$txt_booking_no."' and status_active=1 and is_deleted=0",0);
		$rID= execute_query( "update wo_booking_dtls set status_active=3, is_deleted=2 where booking_no ='".$txt_booking_no."' and status_active=1 and is_deleted=0",0);

		if($db_type==0)
		{
			if($rID){
				mysql_query("COMMIT");
			}
			else{
				mysql_query("ROLLBACK");
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
			}
			else{
				oci_rollback($con);
			}
		}

		//$txt_order_no_id=str_replace("'","",$txt_order_no_id);
		$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
		$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
		$cbouom=str_replace("'","",$cbouom);

		if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
		if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
		if ($cbouom!=0) $cbouom_cond="and a.uom='$cbouom'";
		$txt_booking_percent=str_replace("'","",$txt_booking_percent);
		
		$sql_cuff="select b.id as dtls_id,c.id,c.po_number,a.company_id,b.colar_cuff_per,b.po_break_down_id as po_id,b.gmts_color_id,b.gmts_size,b.pre_cost_fabric_cost_dtls_id,b.dia_width from wo_po_break_down c, wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and c.job_no_mst=b.job_no and c.id=b.po_break_down_id and a.booking_no='".str_replace("'","",$txt_booking_no)."' and b.po_break_down_id in(".$txt_order_no_id.")  and a.status_active=1  and b.status_active=3 and b.colar_cuff_per>0  order by  b.id desc";
		$result_cuff=sql_select($sql_cuff); //20092 issue Id
		foreach($result_cuff as $row)
		{
		$collar_cuff_per_arr[$row[csf('po_id')]][$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('dia_width')]][$row[csf('gmts_color_id')]]=$row[csf('colar_cuff_per')];
		}
		unset($result_cuff);
	

		$item_ratio_array=return_library_array( "select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");

		$booking_dtls_id_array=array(); $finish_fabric_qnty_array=array(); $grey_fabric_qnty_array=array(); $colar_cuff_percent_array=array(); $otherBookingQty_arr=array();
		$sqldtls_id=sql_select("select a.id as booking_dtls_id, a.booking_no, a.fin_fab_qnty, a.grey_fab_qnty, a.colar_cuff_per, b.id from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.po_break_down_id in(".$txt_order_no_id.") and a.booking_type=1 and a.status_active=1 and a.is_deleted=0");// and a.booking_no='$txt_booking_no'
		//echo "select a.id as booking_dtls_id, a.booking_no, a.fin_fab_qnty, a.grey_fab_qnty, a.colar_cuff_per, b.id from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.po_break_down_id in(".$txt_order_no_id.") and a.booking_type=1 and a.status_active=1 and a.is_deleted=0";
		foreach ($sqldtls_id as $row)
		{
			if(str_replace("'","",$txt_booking_no)==$row[csf("booking_no")])
			{
				$booking_dtls_id_array[$row[csf("id")]]=$row[csf("booking_dtls_id")];
				$finish_fabric_qnty_array[$row[csf("id")]]+=$row[csf("fin_fab_qnty")];
				$grey_fabric_qnty_array[$row[csf("id")]]+=$row[csf("grey_fab_qnty")];
				$grey_fabric_qnty_array[$row[csf("id")]]+=$row[csf("colar_cuff_per")];
			}
			else
			{
				$otherBookingQty_arr[$row[csf("id")]]['fin']+=$row[csf("fin_fab_qnty")];
        		$otherBookingQty_arr[$row[csf("id")]]['grey']+=$row[csf("grey_fab_qnty")];
			}
		}
		unset($sqldtls_id);
		$contrast_color_arr=array();
		$contrast_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no=$txt_job_no");
		foreach ($contrast_color_sql as $row)
		{
			$contrast_color_arr[$row[csf("pre_cost_fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
		}
		unset($contrast_color_sql);

		$body_part_type=return_library_array( "select id,body_part_type from lib_body_part", "id", "body_part_type"  );

		$nameArray=sql_select("select a.id as pre_cost_fabric_cost_dtls_id, a.job_no, a.item_number_id, a.body_part_id, a.fab_nature_id, a.fabric_source, a.color_type_id, a.gsm_weight, a.construction, a.composition, a.color_size_sensitive, a.costing_per, a.color, a.color_break_down, a.rate as rate_mst, b.id, b.po_break_down_id, b.color_size_table_id, b.color_number_id, b.gmts_sizes as size_number_id, b.dia_width, b.item_size, b.cons, b.process_loss_percent, b.requirment, b.rate, b.pcs, b.remarks

		FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id in (".$txt_order_no_id.")  $cbo_fabric_natu $cbo_fabric_source_cond $cbouom_cond and a.status_active=1 and a.is_deleted=0
		order by a.id,b.color_size_table_id");
		
		$powiseCostingPerReqQtyArr=array();
		foreach ($nameArray as $nrow)
		{
			$req_grey_fab_qty=0; $reqGreyFabQty=0; $costing_per=0;
			if($nrow[csf("costing_per")]==1) $costing_per=12;
			else if($nrow[csf("costing_per")]==2) $costing_per=1;
			else if($nrow[csf("costing_per")]==3) $costing_per=24;
			else if($nrow[csf("costing_per")]==4) $costing_per=36;
			else if($nrow[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;
	
			$req_grey_fab_qty =($paln_cut_qnty_array[$nrow[csf("color_size_table_id")]]/$item_ratio_array[$nrow[csf("item_number_id")]])*($nrow[csf("requirment")]/$costing_per);
			
			//echo $po_number_arr[$nrow[csf("po_break_down_id")]].'=='.$powiseCostingPerReqQtyArr[$result[csf("po_break_down_id")]]['greyreqqty'].'=='.$popaln_cut_qnty_array[$result[csf("po_break_down_id")]].'=='.$item_ratio_array[$result[csf("item_number_id")]].'<br>';
			
			$powiseCostingPerReqQtyArr[$nrow[csf("pre_cost_fabric_cost_dtls_id")]][$nrow[csf("po_break_down_id")]]['greyreqqty']+=$req_grey_fab_qty;
		}
		//print_r($powiseCostingPerReqQtyArr);
		
		$count=0;
		if (count($nameArray)>0 )
		{
			foreach ($nameArray as $result)
			{
				$constrast_color_arr=array();
				if($result[csf("color_size_sensitive")]==3)
				{
					$constrast_color=explode('__',$result[csf("color_break_down")]);
					for($i=0;$i<count($constrast_color);$i++)
					{
						$constrast_color2=explode('_',$constrast_color[$i]);
						$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
					}
				}

				/*if($result[csf("costing_per")]==1) $price_costing_per=12*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==2) $price_costing_per=1*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==3) $price_costing_per=24*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==4) $price_costing_per=36*$item_ratio_array[$result[csf("item_number_id")]];
				else if($result[csf("costing_per")]==5) $price_costing_per=48*$item_ratio_array[$result[csf("item_number_id")]];
				else $price_costing_per=0;

				$bala_fin_fab_qnty=0; $bala_grey_fab_qnty=0;
				$bala_fin_fab_qnty=def_number_format((((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$price_costing_per)*$result[csf("cons")])*$txt_booking_percent)/100),5,"");
				$bala_grey_fab_qnty=def_number_format((((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$price_costing_per)*$result[csf("requirment")])*$txt_booking_percent)/100),5,"");*/
				
				$costing_per=0; $bala_fin_fab_qnty=0; $bala_grey_fab_qnty=0;
				if($result[csf("costing_per")]==1) $costing_per=12;
				else if($result[csf("costing_per")]==2) $costing_per=1;
				else if($result[csf("costing_per")]==3) $costing_per=24;
				else if($result[csf("costing_per")]==4) $costing_per=36;
				else if($result[csf("costing_per")]==5) $costing_per=48;
				else $costing_per=0;
	
				$bala_fin_fab_qnty =def_number_format(((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$item_ratio_array[$result[csf("item_number_id")]])*($result[csf("cons")]/$costing_per))*($txt_booking_percent/100)),5,"");
				
				$bala_grey_fab_qnty =def_number_format(((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/$item_ratio_array[$result[csf("item_number_id")]])*($result[csf("requirment")]/$costing_per))*($txt_booking_percent/100)),5,"");

				if ($count%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				//echo $otherBookingQty_arr[$result[csf("id")]]['fin'].'='.$otherBookingQty_arr[$result[csf("id")]]['grey'].'<br>';
				$bala_fin_fab_qnty=def_number_format($bala_fin_fab_qnty-($finish_fabric_qnty_array[$result[csf("id")]]+$otherBookingQty_arr[$result[csf("id")]]['fin']),5,"");
				$bala_grey_fab_qnty=def_number_format($bala_grey_fab_qnty-($grey_fabric_qnty_array[$result[csf("id")]]+$otherBookingQty_arr[$result[csf("id")]]['grey']),5,"");
				
				$itempoWiseReqQty=0;
			
				$itempoWiseReqQty=def_number_format(($powiseCostingPerReqQtyArr[$result[csf("pre_cost_fabric_cost_dtls_id")]][$result[csf("po_break_down_id")]]['greyreqqty']/($popaln_cut_qnty_array[$result[csf("po_break_down_id")]]/$item_ratio_array[$result[csf("item_number_id")]]))*$costing_per,5,"");

				if($bala_fin_fab_qnty >0  || $bala_grey_fab_qnty > 0 )
				{
					$count++;
					?>
					<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$count; ?>','<?=$bgcolor; ?>');" id="tr_<?=$count; ?>">
                        <td width="30" onClick="select_id_for_delete_item(<? echo $count; ?>)"> <? echo $count; ?></td>
                        <td width="120" style="word-break:break-all"><? echo $po_number_arr[$result[csf("po_break_down_id")]];?>
                          <input type="text" id="pobreakdownid_<? echo $count; ?>" style="width:40px;" value="<? echo $result[csf("po_break_down_id")]; ?>"/></td>
                        <td width="140"><? echo $garments_item[$result[csf("item_number_id")]];?></td>
                        <td width="120"><? echo $body_part[$result[csf("body_part_id")]];?>
                            <input type="hidden" id="bodypartid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("body_part_id")]; ?>"/>
                            <input type="hidden" id="bodyparttype_<? echo $count; ?>" style="width:20px;" value="<? echo $body_part_type[$result[csf("body_part_id")]]; ?>"/>
                        </td>
                        <td width="100"><? echo $color_type[$result[csf("color_type_id")]];?> <input type="hidden" id="colortype_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("color_type_id")]; ?>"/></td>
                        <td width="100"><? echo $result[csf("construction")]; ?>
                            <input type="hidden" id="construction_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("construction")]; ?>"/>
                            <input type="hidden" id="precostfabriccostdtlsid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("pre_cost_fabric_cost_dtls_id")]; ?>"/></td>
                        <td width="100"><? echo $result[csf("composition")]; ?>
                            <input type="hidden" id="composition_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("composition")]; ?>"/>
                            <input type="hidden" id="cotaid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("color_size_table_id")]; ?>"/>
                            <input type="hidden" id="preconskg_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("requirment")]; ?>"/>
                        </td>
                        <td width="50"><? echo $result[csf("gsm_weight")]; ?> <input type="hidden" id="gsmweight_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("gsm_weight")]; ?>"/></td>
                        <td width="80"><? echo $result[csf("dia_width")]; ?>
                            <input type="hidden" id="diawidth_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("dia_width")]; ?>"/>
                            <input type="hidden" id="remarks_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("remarks")]; ?>"/>
                        </td>
                        <td width="80"><?  echo $result[csf("process_loss_percent")]; ?> <input type="hidden" id="processlosspercent_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("process_loss_percent")]; ?>"/></td>
                        <td width="50"><p><?  echo $result[csf("item_size")];?></p></td>
                        <td width="150"><? echo $size_color_sensitive[$result[csf("color_size_sensitive")]];  ?></td>
                        <td width="100">
                            <input  type="hidden" id="gmtscolorid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("color_number_id")]; ?>"/>
                            <? if($result[csf("color_size_sensitive")]!=0) echo $color_library[$result[csf("color_number_id")]]; ?>
                        </td>
                        <td width="100">
                            <?
                            $color_id="";
                            if($type==1)
                            {
                            	echo $color_library[$fabric_color_array[$result[csf("id")]]]; $color_id=$fabric_color_array[$result[csf("id")]];
                            }
                            else if($type==2)
                            {
								if($result[csf("color_size_sensitive")]==3)
								{
									echo $constrast_color_arr[$result[csf("color_number_id")]]; $color_id=$contrast_color_arr[$result[csf('pre_cost_fabric_cost_dtls_id')]][$result[csf('color_number_id')]];
								}
								else if($result[csf("color_size_sensitive")]==0)
								{
									echo $color_library[$result[csf("color")]]; $color_id=$result[csf("color")];
								}
								else
								{
									echo $color_library[$result[csf("color_number_id")]]; $color_id=$result[csf("color_number_id")];
								}
                            }
                            ?>
                            <input  type="hidden" id="colorid_<? echo $count; ?>" style="width:20px;" value="<? echo $color_id; ?>"/>
                        </td>
                        <td width="100"><? echo $size_library[$result[csf("size_number_id")]]; ?>
                        	<input type="hidden" id="gmtssizeid_<? echo $count; ?>" style="width:20px;" value="<? echo $result[csf("size_number_id")]; ?>"/>
                        </td>
                        <td align="right" width="100"> <? echo $paln_cut_qnty_array[$result[csf("color_size_table_id")]]; ?></td>
                        <td align="right" width="100">
                        	<input type="text"   id="finscons_<? echo $count; ?>" name="finscons_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  onChange="validate_value( <? echo $count ;?>,'finish')" value="<?  echo $bala_fin_fab_qnty; $tot_finish_fab_qnty+=$bala_fin_fab_qnty;  ?>"/> 
                        </td>
                        <td align="right" width="100">
                        	<input type="text"   id="greycons_<? echo $count; ?>" name="greycons_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  onChange="validate_value( <? echo $count ;?>,'grey')" value="<?   echo  $bala_grey_fab_qnty; $tot_grey_fab_qnty+=$bala_grey_fab_qnty;?>"/>
                        </td>
                        <td align="right" width="50"><input type="text" id="rate_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px" onChange="validate_value( <? echo $count ;?>,'rate')" bomrate="<?=number_format($result[csf("rate")],4); ?>" value="<? echo number_format($result[csf("rate")],4); ?>" <? if ($cbo_fabric_source==1){ echo "readonly";} else { echo "";} ?>/></td>
                        <td align="right" width="100"> <input type="text" id="amount_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  value="<? echo def_number_format(($result[csf("rate")]*$bala_grey_fab_qnty),2,''); ?>" readonly/></td>
							<?
                            $colarculfpercentreadonly="";
                            if($body_part_type[$result[csf("body_part_id")]]==40 || $body_part_type[$result[csf("body_part_id")]]==50 ) $colarculfpercentreadonly="";
                            else $colarculfpercentreadonly="readonly";
							$prev_collar_cuff_per=$collar_cuff_per_arr[$result[csf('po_break_down_id')]][$result[csf('pre_cost_fabric_cost_dtls_id')]][$result[csf('dia_width')]][$result[csf('color_number_id')]];
                            ?>
                        <td align="right" width="60"><input type="text" id="colarculfpercent_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  value="<? if($colar_cuff_percent_array[$result[csf("id")]]) echo $colar_cuff_percent_array[$result[csf("id")]];else echo  $prev_collar_cuff_per;?>" <? echo $colarculfpercentreadonly; ?> onChange="copy_colarculfpercent(<? echo $count; ?>)" /></td>
                        <td align="right" title="UpId=<? echo $booking_dtls_id_array[$result[csf("id")]]?>">
                        <input type="text" id="updateid_<? echo $count; ?>" style=" width:100%; height:100%; border:none; text-align:right; background-color:<? echo $bgcolor; ?>;font-family:verdana; font-size:11px"  value="<? echo $booking_dtls_id_array[$result[csf("id")]]; ?>" readonly />
                        </td>
					</tr>
					<?
				}
			}
		}
	}
	?>
	</tbody>
    </table>
    </div>
     <?
    if($count==0)
	{
		$value ="Full Booked"; $display="";
	}
	else
	{
		$value =""; $display="none";
	}
	?>
    <table width="2020" class="rpt_table" border="0" rules="all">
        <tfoot>
            <tr>
            	<td width="50" align="center" colspan="21" id="full_booked" style="font-size:50; font-weight:bold; display:<? $display; ?>"><? echo $value; ?></td>
            </tr>
            <tr>
                <th width="30"></th>
                <th width="120"></th>
                <th width="140"></th>
                <th width="120"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="50"></th>
                <th width="80"></th>
                <th width="80"></th>
                <th width="50"></th>
                <th width="150"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"></th>
                <th width="100"><? echo number_format($tot_finish_fab_qnty,4);?></th>
                <th width="100"><? echo number_format($tot_grey_fab_qnty,4); ?></th>
                <th width="50"></th>
                <th width="100"><? echo number_format($tot_grey_fab_amount,2); ?></th>
                <th width="60"></th>
                <th></th>
            </tr>
        </tfoot>
    </table>
    <table width="2020" class="rpt_table" border="0" rules="all">
        <tr>
            <td align="center" width="100%" colspan="19" class="button_container">
            <?
            echo load_submit_buttons( $permission, "fnc_fabric_booking_dtls",0,0,"",2) ;

            foreach($format_id as $row_id)
            {
				if($row_id==1)
				{
					?>
					<input type="button" value="Print GP" onClick="generate_fabric_report_gr('show_fabric_booking_report_gr')"  style="width:80px" name="print_gr" id="print_gr" class="formbutton" />
					<input type="hidden" id="booking_option" name="booking_option" /><input type="hidden" id="booking_option_no" name="booking_option_no" />
					<input type="hidden" id="booking_option_id" name="booking_option_id" />
					<?
				}
				if($row_id==2)
				{
					?><input type="button" value="Print B1" onClick="generate_fabric_report('show_fabric_booking_report')"  style="width:80px" name="print" id="print" class="formbutton" /><a id="print1" href="" style="text-decoration:none" download hidden>B1</a><?
				}
				if($row_id==3)
				{
					?><input type="button" value="Print B2" onClick="generate_fabric_report('show_fabric_booking_report3')"  style="width:80px" name="print_booking3" id="print_booking3" class="formbutton" /><?
				}
				if($row_id==4)
				{
					?><input type="button" value="Print Cut1" onClick="generate_fabric_report('show_fabric_booking_report1')"  style="width:80px" name="print_booking1" id="print_booking1" class="formbutton" /><?
				}
				if($row_id==5)
				{
					?><input type="button" value="Print Cut2" onClick="generate_fabric_report('show_fabric_booking_report2')"  style="width:80px" name="print_booking2" id="print_booking2" class="formbutton" /><?
				}
				if($row_id==6)
				{
					?><input type="button" value="Print B3" onClick="generate_fabric_report('show_fabric_booking_report4')"  style="width:80px" name="print_booking4" id="print_booking4" class="formbutton" /><?
				}
				if($row_id==7)
				{
					?><input type="button" value="Print B3" onClick="generate_fabric_report('show_fabric_booking_report5')"  style="width:80px" name="print_booking5" id="print_booking5" class="formbutton" /><?
				}
				if($row_id==28)
				{
					?><input type="button" value="Print B13" onClick="generate_fabric_report('show_fabric_booking_report_akh')"  style="width:80px;" name="print_booking_akh" id="print_booking_akh" class="formbutton" /><?
				}
				if($row_id==45)
				{
					?><input type="button" value="Print B4" onClick="generate_fabric_report('show_fabric_booking_report_urmi')"  style="width:80px;" name="print_booking_urmi" id="print_booking_urmi" class="formbutton" /><?
				}
				if($row_id==53)
				{
					?><input type="button" value="Print B5" onClick="generate_fabric_report('show_fabric_booking_report_jk')"  style="width:80px;" name="print_booking_jk" id="print_booking_jk" class="formbutton" /><?
				}
				if($row_id==432)
				{
					?><input type="button" value="Print B5.1" onClick="generate_fabric_report('show_fabric_booking_report_fn')"  style="width:80px;" name="print_booking_fn" id="print_booking_fn" class="formbutton" /><?
				}
				if($row_id==73)
				{
					?><input type="button" value="Print B6" onClick="generate_fabric_report('show_fabric_booking_report_mf')"  style="width:80px;" name="print_booking_jk" id="print_booking_jk" class="formbutton" /><?
				}
				if($row_id==84)
				{
					?><input type="button" value="Print B7" onClick="generate_fabric_report('show_fabric_booking_report_islam')"  style="width:80px;" name="print_booking_islam" id="print_booking_islam" class="formbutton" /><?
				}
				if($row_id==93)
				{
					?><input type="button" value="Print B9" onClick="generate_fabric_report('show_fabric_booking_report_libas')"  style="width:80px;" name="print_booking_libas" id="print_booking_libas" class="formbutton" /><?
				}
				if($row_id==129)
				{
					?><input type="button" value="Print B10" onClick="generate_fabric_report('show_fabric_booking_report_print5')"  style="width:80px;" name="print_booking_5" id="print_booking_5" class="formbutton" /><?
				}
				if($row_id==193)
				{
					?><input type="button" value="Print B11" onClick="generate_fabric_report('show_fabric_booking_report_print4')"  style="width:80px;" name="print_booking_4" id="print_booking_4" class="formbutton" /><?
				}
				if($row_id==269)
				{
					?><input type="button" value="Print B12" onClick="generate_fabric_report('show_fabric_booking_report_knit')"  style="width:80px;" name="print_booking_6" id="print_booking_6" class="formbutton" /><?
				}
				if($row_id==280)
				{
					?><input type="button" value="Print B14" onClick="generate_fabric_report('show_fabric_booking_report_print14')"  style="width:80px;" name="print_booking_14" id="print_booking_14" class="formbutton" /><?
				}
				if($row_id==39)
				{
					?><input type="button" value="Print Booking2" onClick="generate_fabric_report('show_fabric_booking_report_print39')"  style="width:120px;" name="print_booking_39" id="print_booking_39" class="formbutton" /><?
				}
				if($row_id==304)
				{
					?><input type="button" value="Print B15" onClick="generate_fabric_report('show_fabric_booking_report10')"  style="width:120px;" name="print_booking_15" id="print_booking_15" class="formbutton" /><?
				}
				if($row_id==719)
				{
					?>
					 <input type="button" value="Print B16" onClick="generate_fabric_report('show_fabric_booking_report16')"  style="width:120px;" name="print_booking_16" id="print_booking_16" class="formbutton" />
					 <?
				}
				if($row_id==723)
				{
					?><input type="button" value="Print B17" onClick="generate_fabric_report('show_fabric_booking_report17')"  style="width:120px;" name="print_booking_17" id="print_booking_17" class="formbutton" /><?
				}
				if($row_id==339)
				{
					?><input type="button" value="Print B18" onClick="generate_fabric_report('show_fabric_booking_report18')"  style="width:120px;" name="print_booking_18" id="print_booking_18" class="formbutton" /><?
				}
				if($row_id==370)
				{
					?><input type="button" value="Print B19" onClick="generate_fabric_report('show_fabric_booking_report_print19')"  style="width:120px;" name="print_booking_19" id="print_booking_19" class="formbutton" /><?
				}
				if($row_id==383)
				{
					
					?><input type="button" value="Print B20" onClick="generate_fabric_report('show_fabric_booking_report_print20')"  style="width:80px;" name="print_booking_20" id="print_booking_20" class="formbutton" /><?
				}
				if($row_id==404)
				{
					
					?><input type="button" value="Print B21" onClick="generate_fabric_report('show_fabric_booking_report21')"  style="width:80px;" name="print_booking_21" id="print_booking_21" class="formbutton" /><?
				}if($row_id==419)
				{
					?><input type="button" value="Print B22" onClick="generate_fabric_excel_report('show_fabric_booking_report22')"  style="width:80px" name="print_booking_22" id="print_booking_22" class="formbutton" /><a id="print_report22" href="" style="text-decoration:none" download hidden>BB</a><?
				}if($row_id==426)
				{
					?><input type="button" value="Print B23" onClick="generate_fabric_report('show_fabric_booking_report_print23')"  style="width:80px;" name="print_booking_23" id="print_booking_23" class="formbutton" /><?
				}
				if($row_id==452)
				{
				
					?><input type="button" value="Print B24" onClick="generate_fabric_report('show_fabric_booking_report_print24')"  style="width:80px;" name="print_booking_24" id="print_booking_24" class="formbutton" /><?
				}
				if($row_id==786)
				{
				
					?><input type="button" value="Print B25" onClick="generate_fabric_report('show_fabric_booking_report25')"  style="width:80px;" name="print_booking_25" id="print_booking_25" class="formbutton" /><?
				}
				
            }

            if($is_approved==1 || $is_approved==3)
            {
            	?><input type="button" class="formbutton_disabled" style="width:150px" value="Apply Last Update" onClick="fnc_show_booking(2);"><?
            }
            else
            {
            	?><input type="button" class="formbutton" style="width:150px" value="Apply Last Update" onClick="fnc_show_booking(2);"><?
            }
            ?>
            </td>
        </tr>
    </table>
	<?
	exit();
}

if($action=="populate_data_from_apply_last_update")
{
	$sql= "select fab_material , requisition_no, quality_level,sustainability_standard, is_apply_last_update from wo_booking_mst where booking_no ='".$data."' and status_active=1 and is_deleted=0";
		 //echo $sql;
	 $data_array=sql_select($sql);
	 foreach ($data_array as $row)
	 {
		echo "document.getElementById('cbo_quality_level').value = '".$row[csf("quality_level")]."';\n";
		echo "document.getElementById('sustainability_standard').value = '".$row[csf("sustainability_standard")]."';\n";
		echo "document.getElementById('cbo_fab_material').value = '".$row[csf("fab_material")]."';\n";
		echo "document.getElementById('txt_requision_no').value = '".$row[csf("requisition_no")]."';\n";
		echo "document.getElementById('is_apply_last_update').value = '".$row[csf("is_apply_last_update")]."';\n";
	}
}

if ($action=="check_SO_PI_APP"){
	$data=explode("_",$data);
	$txt_booking_no="'".$data[0]."'";
	$cbo_pay_mode=$data[1];
	$txt_job_no="'".$data[2]."'";
	$is_approved=0;
	$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
	foreach($sql as $row){
		if($row[csf('is_approved')]==3){
			$is_approved=1;
		}else{
			$is_approved=$row[csf('is_approved')];
		}
	}
	if($is_approved==1){
		echo "approved**".str_replace("'","",$txt_booking_no);
		die;
	}

	/*$sales_order=0;
	$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no");
	foreach($sqls as $rows){
		$sales_order=$rows[csf('job_no')];
	}
	if($sales_order){
		echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
		die;
	}*/
	if(str_replace("'","",$cbo_pay_mode)==2){
		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id  and b.work_order_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0  and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			die;
		}
	}
	/*$recv_number=return_field_value( "recv_number", "inv_receive_master"," booking_no=$txt_booking_no  and status_active=1 and  is_deleted=0");
	if($recv_number){
		echo "recv1**".str_replace("'","",$txt_booking_no)."**".$recv_number;
		die;
	}*/

		$po_arr=array();
		$sql_po= sql_select("select b.po_break_down_id from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=118  and b.booking_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by b.po_break_down_id");
		//echo "select b.po_break_down_id from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=118  and b.booking_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by b.po_break_down_id";
		foreach($sql_po as $Pdata){
			$po_arr[$Pdata[csf('po_break_down_id')]]=$Pdata[csf('po_break_down_id')];
		}
		$po=implode(",",$po_arr);


		$booking_no=0;
		$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in($po)  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no");
		//echo "select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in($po)  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no";
		//echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
			//die;
		foreach($sql as $Rdata){
         $booking_no=$Rdata[csf('booking_no')];
		}
		if($booking_no){
			echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
			disconnect($con);die;
		}
}

if ($action=="save_update_delete")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$cdate=date('d-M-Y');
	if($isYarnPurchseValidate==2 && str_replace("'","",$cbo_ready_to_approved)==1)
	{
		$sqlYreq="select id from inv_purchase_requisition_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0";
		$sqlYreqRes=sql_select($sqlYreq);
		if(count($sqlYreqRes)<1)
		{
			echo "yarnPurReq**".str_replace("'","",$txt_booking_no)."**".$booking_no;
			disconnect($con);die;
		}
	}
	
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$booking_no=0;
		$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).")  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and a.fabric_source=$cbo_fabric_source and a.item_category=$cbo_fabric_natu group by a.booking_no");
		foreach($sql as $Rdata){
         $booking_no=$Rdata[csf('booking_no')];
		}
		if($booking_no){
			echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
			disconnect($con);die;
		}
		
		if($db_type==0) $date_cond=" YEAR(insert_date)";
		else if($db_type==2) $date_cond="to_char(insert_date,'YYYY')";

		$new_booking_no=explode("*",return_mrr_number( str_replace("'","",$cbo_company_name), '', 'Fb', date("Y",time()), 5, "select booking_no_prefix, booking_no_prefix_num from wo_booking_mst where company_id=$cbo_company_name and booking_type=1 and $date_cond=".date('Y',time())." order by id desc ", "booking_no_prefix", "booking_no_prefix_num" ));
		
		$id=return_next_id( "id", "wo_booking_mst", 1 ) ;
		$field_array="id, booking_type, is_short, booking_no_prefix, booking_no_prefix_num, booking_no, company_id, buyer_id, job_no, po_break_down_id, item_category, fabric_source, currency_id, exchange_rate, pay_mode, source, booking_date, delivery_date, booking_month, booking_year, supplier_id, attention, booking_percent, colar_excess_percent, cuff_excess_percent, ready_to_approved, inserted_by, insert_date, rmg_process_breakdown, fabric_composition, uom, remarks, entry_form, quality_level, fabricstructure, fabricgsm, sustainability_standard, fab_material, requisition_no, proceed_knitting, proceed_dyeing, cad_eff_percent, status_active, is_deleted";
		 $data_array ="(".$id.",1,2,'".$new_booking_no[1]."',".$new_booking_no[2].",'".$new_booking_no[0]."',".$cbo_company_name.",".$cbo_buyer_name.",".$txt_job_no.",".$txt_order_no_id.",".$cbo_fabric_natu.",".$cbo_fabric_source.",".$cbo_currency.",".$txt_exchange_rate.",".$cbo_pay_mode.",".$cbo_source.",".$txt_booking_date.",".$txt_delivery_date.",".$cbo_booking_month.",".$cbo_booking_year.",".$cbo_supplier_name.",".$txt_attention.",".$txt_booking_percent.",".$txt_colar_excess_percent.",".$txt_cuff_excess_percent.",".$cbo_ready_to_approved.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$txt_processloss_breck_down.",".$txt_fabriccomposition.",".$cbouom.",".$txt_remark.",118,".$cbo_quality_level.",".$txt_fabricstructure.",".$txt_fabricgsm.",".$sustainability_standard.",".$cbo_fab_material.",".$txt_requision_no.",".$chk_pro_knitting.",".$chk_pro_dyeing.",".$txt_cad_eff_percent.",1,0)";
		 
		 $rID=sql_insert("wo_booking_mst",$field_array,$data_array,0);
		if($db_type==0)
		{
			if($rID){
				mysql_query("COMMIT");
				echo "0**".$new_booking_no[0]."**".$id;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**";
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
				echo "0**".$new_booking_no[0]."**".$id;
			}
			else{
				oci_rollback($con);
				echo "10**";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approval_need=return_field_value("b.allow_partial as allow_partial", "approval_setup_mst a,approval_setup_dtls b", "a.id=b.mst_id and b.status_active=1 and page_id=5 and a.company_id=$cbo_company_name and a.setup_date<='" . $cdate . "' order by a.setup_date DESC","allow_partial" );
		if($approval_need!='') $approval_need=$approval_need; else $approval_need=2;

		$is_approved=0;
        $sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
        foreach($sql as $row){
           if($approval_need==1)
		   {
		   		if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		   }
		   else $is_approved=$row[csf('is_approved')];
        }
        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
		if($isNextProcessValidate==1)
		{
			$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id  and b.work_order_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0  and b.status_active=1 and  b.is_deleted=0");
			if($pi_number){
				echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
				disconnect($con);die;
			}

			$receive_mrr=0;
			$sqlre=sql_select("select a.recv_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_receive_master a, inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type in (1,4) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.recv_number, b.item_category, b.transaction_type");
			//echo "select a.recv_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_receive_master a, inv_transaction b where a.booking_no=$txt_booking_no and b.transaction_type in (1,4) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.recv_number, b.item_category, b.transaction_type";
			 $yarnIssueReturnQty=0;

			foreach($sqlre as $rows){
				$receive_mrr.=$rows[csf('recv_number')].',';
				if($rows[csf('item_category')]==1 && $rows[csf('transaction_type')]==4) $yarnIssueReturnQty+=$rows[csf('cons_quantity')];
			}
			if($receive_mrr){
				echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
				disconnect($con);die;
			}

			/*$issue_mrr=0;
			$sqlis=sql_select("select a.issue_number from inv_issue_master a,inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.issue_number");

			foreach($sqlis as $rows){
				$issue_mrr=$rows[csf('issue_number')];
			}
			if($issue_mrr){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
				die;
			}*/

			$issue_mrr=0; $fab_issue_mrr="";
			$sqlis=sql_select("select a.issue_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_issue_master a, inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type in (2,3) and a.entry_form!=3 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.issue_number, b.item_category, b.transaction_type"); // and b.item_category=1
			$yarnIssueQty=0;
			foreach($sqlis as $rows){
				$issue_mrr.=$rows[csf('issue_number')].',';
				if($rows[csf('item_category')]==1  && $rows[csf('transaction_type')]==2) $yarnIssueQty+=$rows[csf('cons_quantity')];

				if($rows[csf('item_category')]==2  && $rows[csf('transaction_type')]==2)
				{
					$fab_issue_mrr.=$rows[csf('issue_number')].',';
				}
			}
			$issueBalance=$yarnIssueQty-$yarnIssueReturnQty;
			//echo $issueBalance.'='.$yarnIssueQty.'='.$yarnIssueReturnQty; die;
			if($issueBalance>0){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
				disconnect($con);die;
			}

			//Validation Fabric issue Mrr. CRM id : 7101 (urmi)
			if($fab_issue_mrr){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$fab_issue_mrr;
				disconnect($con);die;
			}

			$booking_no=0;
			//$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.job_no=$txt_job_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no");
			$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).")  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and a.fabric_source=$cbo_fabric_source and a.item_category=$cbo_fabric_natu group by a.booking_no");
			foreach($sql as $Rdata){
			 $booking_no=$Rdata[csf('booking_no')];
			}
			if($booking_no){
				echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
				disconnect($con);die;
			}
		}

		$field_array="buyer_id*job_no*po_break_down_id*item_category*fabric_source*currency_id*exchange_rate*pay_mode*source*booking_date*delivery_date*booking_month*booking_year*supplier_id*attention*booking_percent*colar_excess_percent*cuff_excess_percent*ready_to_approved*updated_by*update_date*rmg_process_breakdown*fabric_composition*uom*remarks*quality_level*fabricstructure*fabricgsm*sustainability_standard*fab_material*requisition_no*proceed_knitting*proceed_dyeing*cad_eff_percent";
		$data_array ="".$cbo_buyer_name."*".$txt_job_no."*".$txt_order_no_id."*".$cbo_fabric_natu."*".$cbo_fabric_source."*".$cbo_currency."*".$txt_exchange_rate."*".$cbo_pay_mode."*".$cbo_source."*".$txt_booking_date."*".$txt_delivery_date."*".$cbo_booking_month."*".$cbo_booking_year."*".$cbo_supplier_name."*".$txt_attention."*".$txt_booking_percent."*".$txt_colar_excess_percent."*".$txt_cuff_excess_percent."*".$cbo_ready_to_approved."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$txt_processloss_breck_down."*".$txt_fabriccomposition."*".$cbouom."*".$txt_remark."*".$cbo_quality_level."*".$txt_fabricstructure."*".$txt_fabricgsm."*".$sustainability_standard."*".$cbo_fab_material."*".$txt_requision_no."*".$chk_pro_knitting."*".$chk_pro_dyeing."*".$txt_cad_eff_percent."";
		$rID=sql_update("wo_booking_mst",$field_array,$data_array,"id","".$update_id."",0);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id);
			}
			else{
				oci_roolback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)   // Delete Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approval_need=return_field_value("b.allow_partial as allow_partial", "approval_setup_mst a,approval_setup_dtls b", "a.id=b.mst_id and b.status_active=1 and page_id=5 and a.company_id=$cbo_company_name and a.setup_date<='" . $cdate . "' order by a.setup_date DESC","allow_partial" );
		if($approval_need!='') $approval_need=$approval_need; else $approval_need=2;

		$is_approved=0;
        $sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
        foreach($sql as $row){
           if($approval_need==1)
		   {
		   		if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		   }
		   else $is_approved=$row[csf('is_approved')];
        }
        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
		if($isNextProcessValidate==1)
		{
			$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
			if($pi_number){
				echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
				disconnect($con);die;
			}

			$pplbook=0;
			$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
			foreach($ppl as $pplrow){
				$pplbook=$pplrow[csf('id')];
			}

			if($pplbook!=0){
				echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
				disconnect($con);die;
			}

			$sales_order=0;

			$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
			foreach($sqls as $rows){
				$sales_order=$rows[csf('job_no')];
			}
			if($sales_order){
				echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
				disconnect($con);die;
			}

			$receive_mrr=0;
			$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
			foreach($sqlre as $rows){
				$receive_mrr=$rows[csf('recv_number')];
			}
			if($receive_mrr){
				echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
				disconnect($con);die;
			}

			$issue_mrr=0;
			$sqlis=sql_select("select a.issue_number from inv_issue_master a,inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.issue_number");
			foreach($sqlis as $rows){
				$issue_mrr=$rows[csf('issue_number')];
			}
			if($issue_mrr){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
				disconnect($con);die;
			}
			$po_arr=array();
			$sql_po= sql_select("select b.po_break_down_id from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=118  and b.booking_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.po_break_down_id");
			foreach($sql_po as $Pdata){
				$po_arr[$Pdata[csf('po_break_down_id')]]=$Pdata[csf('po_break_down_id')];
			}
			$po=implode(",",$po_arr);

			$booking_no=0;
			//$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.job_no=$txt_job_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no");
			$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in($po) and a.fabric_source=$cbo_fabric_source and a.item_category=$cbo_fabric_natu and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no");


			foreach($sql as $Rdata){
			 $booking_no=$Rdata[csf('booking_no')];
			}
			if($booking_no){
				echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
				disconnect($con);die;
			}
			$yarn_booking_no=0;

			$yarn_sqls=sql_select("select booking_no from inv_material_allocation_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
			foreach($yarn_sqls as $rows){
				$yarn_booking_no=$rows[csf('booking_no')];
			}
			if($yarn_booking_no){
				echo "yarn_allo**".str_replace("'","",$txt_booking_no)."**".$yarn_booking_no;
				disconnect($con);die;
			}

		
		//inv_material_allocation_mst
		}
		

		$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'*'1'";
		$rID=sql_delete("wo_booking_mst",$field_array,$data_array,"booking_no","".$txt_booking_no."",1);
		//$rID1=sql_delete("wo_booking_dtls",$field_array,$data_array,"booking_no","".$txt_booking_no."",1);
		$rID1=execute_query( "update wo_booking_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1  where  booking_no =".$txt_booking_no." and status_active=1 and is_deleted=0",1);
		if($db_type==0)
		{
			if($rID && $rID1){
				mysql_query("COMMIT");
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID  && $rID1){
				oci_commit($con);
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="save_update_delete_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$cdate=date('d-M-Y');

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approval_need=return_field_value("b.allow_partial as allow_partial", "approval_setup_mst a,approval_setup_dtls b", "a.id=b.mst_id and b.status_active=1 and page_id=5 and a.company_id=$cbo_company_name and a.setup_date<='" . $cdate . "' order by a.setup_date DESC","allow_partial" );
		if($approval_need!='') $approval_need=$approval_need; else $approval_need=2;

		$is_approved=0;
        $sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
        foreach($sql as $row){
           if($approval_need==1)
		   {
		   		if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		   }
		   else $is_approved=$row[csf('is_approved')];
        }
        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no);disconnect($con);die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
		$booking_no=0;
		$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).")  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and a.fabric_source=$cbo_fabric_source and a.item_category=$cbo_fabric_natu group by a.booking_no");
		foreach($sql as $Rdata){
         $booking_no=$Rdata[csf('booking_no')];
		}
		if($booking_no){
			echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
			disconnect($con);die;
		}
		// if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		 $counter=0;
		 $fail=0;
		 $add_comma=1;
		 $id=return_next_id( "id", "wo_booking_dtls", 1 ) ;
		 $field_array="id, job_no, booking_mst_id, po_break_down_id, pre_cost_fabric_cost_dtls_id, color_size_table_id, precons, booking_no, booking_type, is_short, fabric_color_id, gmts_color_id, fin_fab_qnty, grey_fab_qnty, rate, amount, color_type, construction, copmposition, gsm_weight, dia_width, process_loss_percent, colar_cuff_per, pre_cost_remarks, inserted_by, insert_date";

		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $counter++;
			 $pobreakdownid="pobreakdownid_".$i;
			 //pobreakdownid_1
			 $precostfabriccostdtlsid="precostfabriccostdtlsid_".$i;
			 $colorid="colorid_".$i;
			 $cotaid="cotaid_".$i;
			 $preconskg="preconskg_".$i;
			 $finscons="finscons_".$i;
			 $greycons="greycons_".$i;
			 $rate="rate_".$i;
			 $amount="amount_".$i;
			 $colortype="colortype_".$i;
			 $construction="construction_".$i;
			 $composition="composition_".$i;
			 $gsmweight="gsmweight_".$i;
			 $diawidth="diawidth_".$i;
			 $processlosspercent="processlosspercent_".$i;
			 $colarculfpercent="colarculfpercent_".$i;
			 $updateid="updateid_".$i;
			 $gmtscolorid="gmtscolorid_".$i;
			 $remarks="remarks_".$i;
			  $pre_remarks=str_replace("'",'',$$remarks);
			 $pre_construction=str_replace("'",'',$$construction);
			 $pre_composition=str_replace("'",'',$$composition);

			if ($add_comma!=1) $data_array .=",";
			$data_array .="(".$id.",".$txt_job_no.",".$update_id.",".$$pobreakdownid.",".$$precostfabriccostdtlsid.",".$$cotaid.",".$$preconskg.",".$txt_booking_no.",1,2,".$$colorid.",".$$gmtscolorid.",".$$finscons.",".$$greycons.",".$$rate.",".$$amount.",".$$colortype.",'".$pre_construction."','".$pre_composition."',".$$gsmweight.",".$$diawidth.",".$$processlosspercent.",".$$colarculfpercent.",'".$pre_remarks."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			$add_comma++;
			$id=$id+1;
			if ($data_array!="" && $counter==100)
			{
				$counter=0;
				$rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
				$data_array="";
				$add_comma=1;
				if( $rID && $fail==0) { $rID=1;  } else { $rID=0; $fail=1; }
				//echo "A";
			}
		 }
		//echo "10**".$data_array.'d';die;
		 if ($data_array!="" && $counter!=100)
		 {
			$counter=0;
			$rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
			$data_array="";
			$add_comma=1;
			//echo "B";
			if( $rID && $fail==0) { $rID=1;  } else { $rID=0; $fail=1; }
		 }

		 if($fail==0)
		 {
			 $rID= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no =".$txt_booking_no." and status_active=1 and is_deleted=0",0);
			 if( $rID==1 && $fail==0) { $rID=1;  } else { $rID=0; $fail=1; }
		 }
		 //echo "10**insert into wo_booking_dtls $field_array values ($data_array)"; die;
		 //$rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
		 //check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_booking_no[0];
			}
			else{

				mysql_query("ROLLBACK");
				echo "10**".$new_booking_no[0];
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_booking_no[0];
			}
			else{
				oci_rollback($con);
				echo "10**".$new_booking_no[0];
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)  // update Here
	{
		$con = connect();

		$approval_need=return_field_value("b.allow_partial as allow_partial", "approval_setup_mst a,approval_setup_dtls b", "a.id=b.mst_id and b.status_active=1 and page_id=5 and a.company_id=$cbo_company_name and a.setup_date<='" . $cdate . "' order by a.setup_date DESC","allow_partial" );
		if($approval_need!='') $approval_need=$approval_need; else $approval_need=2;

		$is_approved=0;
        $sql=sql_select("select is_apply_last_update, is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
        foreach($sql as $row){
           if($approval_need==1)
		   {
		   		if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		   }
		   else $is_approved=$row[csf('is_approved')];

		   $is_apply_last_update=$row[csf('is_apply_last_update')];
        }

        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no);disconnect($con); die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no);disconnect($con); die; }

		if($isNextProcessValidate==1)
		{
			$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
			if($pi_number){
				echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
				disconnect($con);die;
			}

			/*$receive_mrr=0;
			$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
			foreach($sqlre as $rows){
				$receive_mrr=$rows[csf('recv_number')];
			}
			if($receive_mrr){
				echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
				die;
			}*/
			$receive_mrr=0;
			$sqlre=sql_select("select a.recv_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_receive_master a, inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type in (1,4) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.recv_number, b.item_category, b.transaction_type");
			//echo "select a.recv_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_receive_master a, inv_transaction b where a.booking_no=$txt_booking_no and b.transaction_type in (1,4) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.recv_number, b.item_category, b.transaction_type";
			 $yarnIssueReturnQty=0;

			foreach($sqlre as $rows){
				if($rows[csf('item_category')]!=1 && $rows[csf('transaction_type')]!=4) $receive_mrr.=$rows[csf('recv_number')].',';
				if($rows[csf('item_category')]==1 && $rows[csf('transaction_type')]==4) $yarnIssueReturnQty+=$rows[csf('cons_quantity')];
			}
			if($receive_mrr){
				echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
				disconnect($con);die;
			}
			unset($sqlre);

			/*$issue_mrr=0;
			$sqlis=sql_select("select a.issue_number from inv_issue_master a,inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.issue_number");
			foreach($sqlis as $rows){
				$issue_mrr=$rows[csf('issue_number')];
			}
			if($issue_mrr){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
				die;
			}*/
			$issue_mrr=0;
			$sqlis=sql_select("select a.issue_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_issue_master a, inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type in (2,3) and a.entry_form!=3 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.issue_number, b.item_category, b.transaction_type"); // and b.item_category=1
			$yarnIssueQty=0;
			foreach($sqlis as $rows){
				$issue_mrr.=$rows[csf('issue_number')].',';
				if($rows[csf('item_category')]==1  && $rows[csf('transaction_type')]==2) $yarnIssueQty+=$rows[csf('cons_quantity')];
			}

			$issueBalance=$yarnIssueQty-$yarnIssueReturnQty;
			//echo $issueBalance.'='.$yarnIssueQty.'='.$yarnIssueReturnQty; die;
			 if($issueBalance>0){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
				disconnect($con);die;
			}
			unset($sqlis);
			/*if($issue_mrr){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
				die;
			}*/
			$po_arr=array();
			if(str_replace("'","",$txt_booking_no)!=''){
			$sql_po= sql_select("select b.po_break_down_id from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=118  and b.booking_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by b.po_break_down_id");
			foreach($sql_po as $Pdata){
				$po_arr[$Pdata[csf('po_break_down_id')]]=$Pdata[csf('po_break_down_id')];
			}
			}
			$po=implode(",",$po_arr);
			if($po!='') $po=$po;else $po=0;
			$booking_no=0;
			//$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.job_no=$txt_job_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no");
			$sqlBook= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in($po)  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and a.fabric_source=$cbo_fabric_source and a.item_category=$cbo_fabric_natu group by a.booking_no");

			foreach($sqlBook as $Rdata){
			 $booking_no=$Rdata[csf('booking_no')];
			}
			
			if($booking_no){
				echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
				disconnect($con);die;
			}
			unset($sqlBook);
		}
		//if($is_apply_last_update==2 && $is_approved!=1)
		//{
			$booking_color_arr=array();
			$sql_color= sql_select("select a.id as fab_cost_id,c.color_number_id from wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls a where c.job_no_mst=a.job_no and c.job_no_mst=$txt_job_no  and c.status_active=1 and  c.is_deleted=0 group by a.id,c.color_number_id");
			foreach($sql_color as $row)
			{
				$booking_color_arr[$row[csf('fab_cost_id')]][$row[csf('color_number_id')]]=$row[csf('color_number_id')];
			}
			
			$sql_dye=sql_select("select id as dmt_mst_id,pre_cost_fabric_cost_id,fabric_color  from wo_dye_to_match where booking_no=$txt_booking_no");
			$dtm_color_arr=array();$dye_mt_id='';
			foreach($sql_dye as $row){

				$fab_color_ids=$booking_color_arr[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]];
				if($fab_color_ids!=$row[csf('fabric_color')])
				{
					if($dye_mt_id=='') $dye_mt_id=$row[csf('dmt_mst_id')];else $dye_mt_id.=",".$row[csf('dmt_mst_id')];
				}
				$dtm_color_arr[$row[csf('fab_cost_id')]][$row[csf('fabric_color')]]=$row[csf('fabric_color')];
			}
			unset($sql_dye);
			unset($sql_color);
			$new_color_id_chk=array_diff($booking_color_arr,$dtm_color_arr);
			if(count($new_color_id_chk)>0 && $dye_mt_id!='')
			{
				//$rID=execute_query( "update wo_dye_to_match set status_active=0,is_deleted =1 where id in($dye_mt_id)",0);
				$rID=execute_query( "delete from wo_dye_to_match where id in($dye_mt_id) ",0);
				if($rID) $rID=1;else $rID=0;
			}

			//print_r($new_color_id_chk);
			//echo "10**".$rID.'='.$dye_mt_id;die;
		//}


		if($db_type==0) mysql_query("BEGIN");

		 //if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $id=return_next_id( "id", "wo_booking_dtls", 1 ) ;
		 $add_comma=0;  $counter=0; $counterup=0; $fail=0; $fail_up=0;  //echo "10**";
		 $field_array="id, job_no,booking_mst_id, po_break_down_id, pre_cost_fabric_cost_dtls_id, color_size_table_id, precons, booking_no, booking_type, is_short, fabric_color_id, gmts_color_id, fin_fab_qnty, grey_fab_qnty, rate, amount, color_type, construction, copmposition, gsm_weight, dia_width, process_loss_percent, colar_cuff_per, pre_cost_remarks, inserted_by, insert_date";

		 $field_array_up="job_no*po_break_down_id*pre_cost_fabric_cost_dtls_id*color_size_table_id*precons*booking_no*booking_type*is_short *fabric_color_id*gmts_color_id*fin_fab_qnty*grey_fab_qnty*rate*amount*color_type*construction*copmposition*gsm_weight*dia_width*process_loss_percent*colar_cuff_per*pre_cost_remarks*updated_by*update_date";
		 //echo "10**";
		 $bookArr=array();
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $pobreakdownid="pobreakdownid_".$i;
			 $precostfabriccostdtlsid="precostfabriccostdtlsid_".$i;
			 $colorid="colorid_".$i;
			 $cotaid="cotaid_".$i;
			 $preconskg="preconskg_".$i;
			 $finscons="finscons_".$i;
			 $greycons="greycons_".$i;
			 $rate="rate_".$i;
			 $amount="amount_".$i;
			 $colortype="colortype_".$i;
			 $construction="construction_".$i;
			 $composition="composition_".$i;
			 $gsmweight="gsmweight_".$i;
			 $diawidth="diawidth_".$i;
			 $processlosspercent="processlosspercent_".$i;
			 $colarculfpercent="colarculfpercent_".$i;
			 $updateid="updateid_".$i;
			 $gmtscolorid="gmtscolorid_".$i;
             $remarks="remarks_".$i;
			 $pre_remarks=str_replace("'",'',$$remarks);
			 $pre_construction=str_replace("'",'',$$construction);
			 $pre_composition=str_replace("'",'',$$composition);

			 if(str_replace("'",'',$$updateid)!="")
			 {
				$counterup++;
				$id_arr[]=str_replace("'",'',$$updateid);
				$data_array_up[str_replace("'",'',$$updateid)] =explode("*",("".$txt_job_no."*".$$pobreakdownid."*".$$precostfabriccostdtlsid."*".$$cotaid."*".$$preconskg."*".$txt_booking_no."*1*2*".$$colorid."*".$$gmtscolorid."*".$$finscons."*".$$greycons."*".$$rate."*".$$amount."*".$$colortype."*'".$pre_construction."'*'".$pre_composition."'*".$$gsmweight."*".$$diawidth."*".$$processlosspercent."*".$$colarculfpercent."*'".trim($pre_remarks)."'*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));

				if (count($data_array_up)>0 && $counterup==100)
				{
					$counterup=0;
					$rID=execute_query(bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
					$id_arr=array();
					$data_array_up=array();

					if( $rID && $fail_up==0) { $rID=1;  } else { $rID=0; $fail_up=1; }
				}
			 }

			if(str_replace("'",'',$$updateid)=="")
			{
				$counter++;
				if ($add_comma!=0) $data_array .=",";
				$data_array .="(".$id.",".$txt_job_no.",".$update_id.",".$$pobreakdownid.",".$$precostfabriccostdtlsid.",".$$cotaid.",".$$preconskg.",".$txt_booking_no.",1,2,".$$colorid.",".$$gmtscolorid.",".$$finscons.",".$$greycons.",".$$rate.",".$$amount.",".$$colortype.",'".$pre_construction."','".$pre_composition."',".$$gsmweight.",".$$diawidth.",".$$processlosspercent.",".$$colarculfpercent.",'".trim($pre_remarks)."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
				$id=$id+1;
				$add_comma++;
				if ($data_array!="" && $counter==100)
			    {
					$counter=0;
					$rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
					
					//echo "insert into wo_booking_dtls (".$field_array.") values ".$data_array.'='; 
					
					$data_array="";
					$add_comma=0;
					//$bookArr[$id]=str_replace("'",'',$$gmtscolorid);
					if( $rID && $fail==0) { $rID=1;  } else { $rID=0; $fail=1; }

			    }

			}
		 }
		// die;
	//echo "10**";
		//print_r($data_array);die;
		 if ($data_array!="" && $counter!=100)
		 {
			$counter=0;
			$rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
			//echo "insert into wo_booking_dtls (".$field_array.") values ".$data_array.'='; 
			$data_array="";
			$add_comma=0;
			if( $rID && $fail==0) { $rID=1;  } else { $rID=0; $fail=1; }
		 }
		 	//echo "10**=";die;
	//	echo "10**";
		//echo  bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up, $data_array_up, $id_arr ); die;
		 if (count($data_array_up)>0 && $counterup!=100)
		{
			$counterup=0;
			$rID=execute_query(bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
			$id_arr=array();
			$data_array_up=array();

			if( $rID && $fail_up==0) { $rID=1;  } else { $rID=0; $fail_up=1; }
		}

		//echo  bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up, $data_array_up, $id_arr ); die;
		//$rID=execute_query(bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		/*if($data_array !="")
		 {
		  $rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
		 }*/
		 if($rID==1 && $fail_up==0)
		 {
			 $rID= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no =".$txt_booking_no." and status_active=1 and is_deleted=0",0);
			 if( $rID==1 && $fail_up==0) { $rID=1;  } else { $rID=0; $fail_up=1; }
		 }
		// echo "10**".$rID.'='.$fail.'='.$fail_up;die;

		 //$rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
		/// check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".str_replace(",","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".str_replace(",","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)  // DELETE Here
	{
		$con = connect();
		$is_approved=0;
        $sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
        foreach($sql as $row){
           // if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		    $is_approved=$row[csf('is_approved')];
        }
        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no);disconnect($con); die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }

		if($isNextProcessValidate==1)
		{
			$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
			if($pi_number){
				echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
				disconnect($con);die;
			}

			$pplbook=0;
			$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
			foreach($ppl as $pplrow){
				$pplbook=$pplrow[csf('id')];
			}

			if($pplbook!=0){
				echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
				disconnect($con);die;
			}

			$sales_order=0;
			$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
			foreach($sqls as $rows){
				$sales_order=$rows[csf('job_no')];
			}
			if($sales_order){
				echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
				disconnect($con);die;
			}

			$receive_mrr=0;
			$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
			foreach($sqlre as $rows){
				$receive_mrr=$rows[csf('recv_number')];
			}
			if($receive_mrr){
				echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
				disconnect($con);die;
			}

			$issue_mrr=0;
			$sqlis=sql_select("select a.issue_number from inv_issue_master a,inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.issue_number");
			foreach($sqlis as $rows){
				$issue_mrr=$rows[csf('issue_number')];
			}
			if($issue_mrr){
				echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
				disconnect($con);die;
			}

			$po_arr=array();
			$sql_po= sql_select("select b.po_break_down_id from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=118  and b.booking_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by b.po_break_down_id");
			foreach($sql_po as $Pdata){
				$po_arr[$Pdata[csf('po_break_down_id')]]=$Pdata[csf('po_break_down_id')];
			}
			$po=implode(",",$po_arr);

			$booking_no=0;
			//$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.job_no=$txt_job_no  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no");

// same nature holy save/update delete korty dibe na//cbo_fabric_natu

			$sql= sql_select("select a.booking_no from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108  and b.po_break_down_id in($po) and a.item_category=$cbo_fabric_natu and a.fabric_source=$cbo_fabric_source  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 group by a.booking_no");

			foreach($sql as $Rdata){
			 $booking_no=$Rdata[csf('booking_no')];
			}
			if($booking_no){
				echo "parb1**".str_replace("'","",$txt_booking_no)."**".$booking_no;
				disconnect($con);die;
			}
			$yarn_booking_no=0;

			$yarn_sqls=sql_select("select booking_no from inv_material_allocation_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
			foreach($yarn_sqls as $rows){
				$yarn_booking_no=$rows[csf('booking_no')];
			}
			if($yarn_booking_no){
				echo "yarn_allo**".str_replace("'","",$txt_booking_no)."**".$yarn_booking_no;
				disconnect($con);die;
			}
		}

		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//echo "10**".$selected_id_for_delete; die;
		if(str_replace("'","",$selected_id_for_delete)=="")
		{
			$rID=execute_query( "update wo_booking_dtls set status_active=0,is_deleted =1,updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where  booking_no =$txt_booking_no and status_active=1 and is_deleted=0",0);
		}
		else
		{
			$rID=execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1,updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where id in(".str_replace("'","",$selected_id_for_delete).") and status_active=1 and is_deleted=0",0);
			//echo "update wo_booking_dtls set status_active=0,is_deleted =1 where  id in(".str_replace("'","",$selected_id_for_delete).")";
		}
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "2**".str_replace(",","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
				echo "2**".str_replace(",","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="check_is_booking_used")
{
	$data=explode("_",$data);
	$txt_booking_no="'".$data[0]."'";
	if($data!="" && $isNextProcessValidate==1)
	{
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		 foreach($sql as $row){
           // if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		    $is_approved=$row[csf('is_approved')];
        }
        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no);disconnect($con); die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}

		$receive_mrr=0;
        $sqlre=sql_select("select a.recv_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_receive_master a, inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type in (1,4) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.recv_number, b.item_category, b.transaction_type");
		 $yarnIssueReturnQty=0;

        foreach($sqlre as $rows){
            if($rows[csf('item_category')]!=1 && $rows[csf('transaction_type')]!=4) $receive_mrr.=$rows[csf('recv_number')].',';
			if($rows[csf('item_category')]==1 && $rows[csf('transaction_type')]==4) $yarnIssueReturnQty+=$rows[csf('cons_quantity')];
        }
        if($receive_mrr){
            echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
            disconnect($con);die;
        }
		$issue_mrr=0;
        $sqlis=sql_select("select a.issue_number, b.item_category, b.transaction_type, sum(b.cons_quantity) as cons_quantity from inv_issue_master a, inv_transaction b where a.id=b.mst_id and a.booking_no=$txt_booking_no and b.transaction_type in (2,3) and a.entry_form!=3 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.issue_number, b.item_category, b.transaction_type"); // and b.item_category=1
        $yarnIssueQty=0;
        foreach($sqlis as $rows){
            $issue_mrr.=$rows[csf('issue_number')].',';
			if($rows[csf('item_category')]==1  && $rows[csf('transaction_type')]==2) $yarnIssueQty+=$rows[csf('cons_quantity')];
        }


		$issueBalance=$yarnIssueQty-$yarnIssueReturnQty;
		//echo $issueBalance.'='.$yarnIssueQty.'='.$yarnIssueReturnQty; die;
		if($issueBalance>0)
		{
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
            disconnect($con);die;
		}
	}
	exit();
}

if($action=="delete_booking_item")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
  $rID = execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1 where  booking_no ='$data'",0);
  $rID= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no ='$data' and status_active=1 and is_deleted=0",0);
  $rID = execute_query( "update wo_booking_mst set is_apply_last_update=1 where  booking_no ='$data' and is_deleted =0 and status_active=1",0);
   if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".str_replace(",","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}

		if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".str_replace(",","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}
}

if($action=="booking_surch_option")
{
	extract($_REQUEST);
	echo load_html_head_contents("Popup Info","../../../", '', '', $unicode);
	?>
    <script>

		var selected_id = new Array;
		var selected_name = new Array;
		var selected_no = new Array;
    	function check_all_data()
		{

			var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			var onclickString=paramArr=functionParam="";
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				onclickString = $('#tr_' + i).attr('onclick');
				paramArr = onclickString.split("'");
				functionParam = paramArr[1];
				js_set_value( functionParam );

			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( strCon )
		{
			//alert(strCon);
				var splitSTR = strCon.split("_");
				var str_or = splitSTR[0];
				var selectID = splitSTR[1];
				var selectDESC = splitSTR[2];
				//$('#txt_individual_id' + str).val(splitSTR[1]);
				//$('#txt_individual' + str).val('"'+splitSTR[2]+'"');

				toggle( document.getElementById( 'tr_' + str_or ), '#FFFFCC' );

				if( jQuery.inArray( str_or, selected_no ) == -1 ) {
					selected_id.push( selectID );
					selected_name.push( selectDESC );
					selected_no.push( str_or );
				}
				else {
					for( var i = 0; i < selected_id.length; i++ ) {
						if( selected_id[i] == selectID ) break;
					}
					selected_id.splice( i, 1 );
					selected_name.splice( i, 1 );
					selected_no.splice( i, 1 );
				}
				var id = ''; var name = ''; var job = ''; var num='';
				for( var i = 0; i < selected_id.length; i++ ) {
					id += selected_id[i] + ',';
					name += selected_name[i] + ',';
					num += selected_no[i] + ',';
				}
				id 		= id.substr( 0, id.length - 1 );
				name 	= name.substr( 0, name.length - 1 );
				num 	= num.substr( 0, num.length - 1 );
				//alert(num);
				$('#txt_selected_id').val( id );
				$('#txt_selected').val( name );
				$('#txt_selected_no').val( num );
		}

		function frm_close()
		{
			parent.emailwindow.hide();
		}
    </script>
    <?
	$select_rpt_option_arr=array(1=>"Size and Color Breakdown",2=>"Main Booking Info",3=>"Collar / Cuff -  Colour Size Brakedown in Pcs",4=>"Yarn Required Summary",5=>"Allocated Yarn",6=>"Conversion Charge",7=>"Embellishment",8=>"Approved Instructions",9=>"Special  Instruction",10=>"Comments",11=>"TNA Information");
	?>

    <div style="width:500px;">
    <table width="500" cellpadding="0" cellspacing="0" class="rpt_table" border="1" rules="all" id="" align="left">
    	<thead>
        	<tr>
                <th width="50">Sl</th>
                <th>Report Option</th>
            </tr>
        </thead>
    </table>
    <table width="500" cellpadding="0" cellspacing="0" class="rpt_table" border="1" rules="all" id="list_view" align="left">
        <tbody>
			<?
            $i=1;
            foreach($select_rpt_option_arr as $id=>$val)
            {
                if ($i%2==0)
                $bgcolor="#E9F3FF";
                else
                $bgcolor="#FFFFFF";
                ?>
                <tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>" onClick="js_set_value('<? echo $i."_".$id."_".$val; ?>')" style="cursor:pointer">
                    <td width="50"  align="center"><? echo $i; ?></td>
                    <td><? echo $val; ?></td>
                </tr>
                <?
                $i++;
            }
            ?>
            <tr>
                <td  style="vertical-align:middle; padding-left:20px;" colspan="2"><input type="checkbox" id="all_check" onClick="check_all_data('all_check')" />&nbsp;Check All / Un-Check All
                <input type='hidden' id='txt_selected_id' />
                <input type='hidden' id='txt_selected' />
                <input type='hidden' id='txt_selected_no' />
                </td>
            </tr>
        </tbody>
    </table>
    <br>
    <div style="width:100%"><p align="center"><input type="button" id="btn_close" class="formbutton" style="width:100px;" value="Close" onClick="frm_close();" ></p></div>
    </div>

    <script language="javascript" type="text/javascript">
	var category_no='<? echo $booking_option_no;?>';
	var category_id='<? echo $booking_option_id;?>';
	var category_des='<? echo $booking_option;?>';
	var cate_ref="";
	if(category_no!="")
	{
		category_no_arr=category_no.split(",");
		category_id_arr=category_id.split(",");
		category_des_arr=category_des.split(",");
		var str_ref="";
		for(var k=0;k<category_no_arr.length; k++)
		{
			cate_ref=category_no_arr[k]+'_'+category_id_arr[k]+'_'+category_des_arr[k];
			js_set_value(cate_ref);
		}
	}
	</script>
    <?
	exit();
}

if($action=="terms_condition_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
?>
	<script>
function add_break_down_tr(i)
 {
	var row_num=$('#tbl_termcondi_details tr').length-1;
	if (row_num!=i)
	{
		return false;
	}
	else
	{
		i++;

		 $("#tbl_termcondi_details tr:last").clone().find("input,select").each(function() {
			$(this).attr({
			  'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
			  'name': function(_, name) { return name + i },
			  'value': function(_, value) { return value }
			});
		  }).end().appendTo("#tbl_termcondi_details");
		 $('#increase_'+i).removeAttr("onClick").attr("onClick","add_break_down_tr("+i+");");
		  $('#decrease_'+i).removeAttr("onClick").attr("onClick","fn_deletebreak_down_tr("+i+")");
		  $('#termscondition_'+i).val("");
	}

}

function fn_deletebreak_down_tr(rowNo)
{


		var numRow = $('table#tbl_termcondi_details tbody tr').length;
		if(numRow==rowNo && rowNo!=1)
		{
			$('#tbl_termcondi_details tbody tr:last').remove();
		}

}

function fnc_fabric_booking_terms_condition( operation )
{
	    var row_num=$('#tbl_termcondi_details tr').length-1;
		var data_all="";
		for (var i=1; i<=row_num; i++)
		{

			if (form_validation('termscondition_'+i,'Term Condition')==false)
			{
				return;
			}

			data_all=data_all+get_submitted_data_string('txt_booking_no*termscondition_'+i,"../../../",i);
		}
		var data="action=save_update_delete_fabric_booking_terms_condition&operation="+operation+'&total_row='+row_num+data_all;
		freeze_window(operation);
		http.open("POST","fabric_booking_urmi_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_fabric_booking_terms_condition_reponse;
}

function fnc_fabric_booking_terms_condition_reponse()
{

	if(http.readyState == 4)
	{
	    var reponse=trim(http.responseText).split('**');
			if (reponse[0].length>2) reponse[0]=10;
			release_freezing();
			if(reponse[0]==0 || reponse[0]==1)
			{
				parent.emailwindow.hide();
			}
	}
}
    </script>

</head>

<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
<fieldset>
        	<form id="termscondi_1" autocomplete="off">
           <input type="hidden" id="txt_booking_no" name="txt_booking_no" value="<? echo str_replace("'","",$txt_booking_no) ?>"/>


            <table width="650" cellspacing="0" class="rpt_table" border="0" id="tbl_termcondi_details" rules="all">
                	<thead>
                    	<tr>
                        	<th width="50">Sl</th><th width="530">Terms</th><th ></th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");// quotation_id='$data'
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            	<tr id="settr_1" align="center">
                                    <td>
                                    <? echo $i;?>
                                    </td>
                                    <td>
                                    <input type="text" id="termscondition_<? echo $i;?>"   name="termscondition_<? echo $i;?>" style="width:95%"  class="text_boxes"  value="<? echo $row[csf('terms')]; ?>"  />
                                    </td>
                                    <td>
                                    <input type="button" id="increase_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i; ?> )" />
                                    <input type="button" id="decrease_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?>);" />
                                    </td>
                                </tr>
                            <?
						}
					}
					else
					{
					$data_array=sql_select("select id, terms from  lib_terms_condition where is_default=1");// quotation_id='$data'
					foreach( $data_array as $row )
						{
							$i++;
					?>
                    <tr id="settr_1" align="center">
                                    <td>
                                    <? echo $i;?>
                                    </td>
                                    <td>
                                    <input type="text" id="termscondition_<? echo $i;?>"   name="termscondition_<? echo $i;?>" style="width:95%"  class="text_boxes"  value="<? echo $row[csf('terms')]; ?>"  />
                                    </td>
                                    <td>
                                    <input type="button" id="increase_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i; ?> )" />
                                    <input type="button" id="decrease_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> );" />
                                    </td>
                                </tr>
                    <?
						}
					}
					?>
                </tbody>
                </table>

                <table width="650" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">
						        <?
									echo load_submit_buttons( $permission, "fnc_fabric_booking_terms_condition", 0,0 ,"reset_form('termscondi_1','','','','')",1) ;
									?>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="dtm_popup")
{
	echo load_html_head_contents("DTM Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
<script>

function trims_popup(page_link,title,i)
{
	var job_no=$('#txt_job_no').val();
	var booking_no=$('#txt_booking_no').val();
	var selected_no=$('#txt_order_no_id').val();
	var fabric=$('#fabric_'+i).val();
	var color=$('#color_'+i).val();
	var fabric_cost_id=$('#fabric_cost_id_'+i).val();


	if(booking_no=='')
	{
		alert('Booking  Not Found.');
		$('#txt_booking_no').focus();
		return;
	}

	page_link=page_link+'&job_no='+job_no+'&booking_no='+booking_no+'&selected_no='+selected_no+'&fabric='+fabric+'&color='+color+'&fabric_cost_id='+fabric_cost_id+'&index='+i;
	emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=800px,height=300px,center=1,resize=1,scrolling=0','../../')

}
</script>
<?
//echo $job_no."_".$booking_no."_".$selected_no;
//$sql=sql_select("select id,booking_id,booking_no,pre_cost_fabric_cost_id,fabric_color,precost_trim_cost_id,item_group,qty from wo_dye_to_match where booking_no='$booking_no'");
$dtm_arr=array();
$sql=sql_select("select pre_cost_fabric_cost_id,fabric_color,sum(qty) as qty  from wo_dye_to_match where booking_no='$booking_no' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_id,fabric_color");
foreach($sql as $row){
	$dtm_arr[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]]=$row[csf('qty')];
}


$trims_matches_sql=sql_select("SELECT a.id, a.body_part_id, a.composition, a.construction, a.gsm_weight, d.fabric_color_id, d.gmts_color_id, min(c.id) as cid, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and c.id=d.color_size_table_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no ='$booking_no' and d.status_active=1 and  c.status_active=1  and a.status_active=1 and d.is_deleted=0
			group by a.id, a.body_part_id, a.composition, a.construction, a.gsm_weight, d.fabric_color_id , d.gmts_color_id order by a.id, cid ");
?>



</head>
<body>
<div align="center" style="width:100%;" >
<input type="hidden" id="txt_job_no" name="txt_job_no" value="<? echo $job_no;  ?>"/>
<input type="hidden" id="txt_booking_no" name="txt_booking_no" value="<? echo $booking_no;  ?>"/>
<input type="hidden" id="txt_order_no_id" name="txt_order_no_id" value="<? echo $selected_no;  ?>"/>
	<table width="800" cellspacing="0" class="rpt_table" border="0" id="tbl_trims_dyes_match1" rules="all">
	<thead>
	  <tr>
		<th width="40">S/L</th>
		<th width="300">Fabric Driscription</th>
		<th width="150">Color</th>
		<th width="100">Fabric Qnty.</th>
		<th width="100">Trims</th>
	  </tr>
	</thead>
	<tbody>
	<?

	$i=1;
	foreach($trims_matches_sql as $row)
	 {
	 ?>
	  <tr>
	  	<td width="40"><? echo $i; ?></td>
	  	<td width="300">
        <input class="text_boxes" type="text" style="width:300px;"  name="fabric_<? echo $i; ?>" id="fabric_<? echo $i; ?>" value="<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')];?>" readonly/>
         <input class="text_boxes" type="hidden" style="width:300px;"  name="fabric_cost_id_<? echo $i; ?>" id="fabric_cost_id_<? echo $i; ?>" value="<? echo $row[csf('id')];?>" readonly/>
        </td>
	  	<td width="150">
        <? echo $color_library[$row[csf('fabric_color_id')]];?>
        <input class="text_boxes" type="hidden" style="width:150px;"  name="color_<? echo $i; ?>" id="color_<? echo $i; ?>" value="<? echo $row[csf('gmts_color_id')];?>" readonly/>
        </td>
	  	<td width="100" align="right">
		<? echo $row[csf('fin_fab_qnty')];?>
        </td>
	  	<td width="100"><input class="text_boxes" type="text" style="width:100px;"  name="trims_<? echo $i; ?>" id="trims_<? echo $i; ?>" value="<? echo $dtm_arr[$row[csf('id')]][$row[csf('fabric_color_id')]] ?>" onDblClick="trims_popup('fabric_booking_urmi_controller.php?action=trims_popup','Trims Item',<? echo $i ?>)" readonly/></td>
	  </tr>
	  <? $i++;

	  } ?>
	</tbody>
	</table>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="trims_popup")
{
	echo load_html_head_contents("DTM Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
<script>
function fnc_fabric_dye_to_match( operation )
{

	var job_no=$('#txt_job_no').val();
	var booking_no=$('#txt_booking_no').val();
	var selected_no=$('#txt_order_no_id').val();
	var fabric=$('#fabric').val();
	var color=$('#color').val();
	var fabric_cost_id=$('#fabric_cost_id').val();
	var index=$('#index').val();

	    var row_num=$('#tbl_trims_dyes_match tbody tr').length;
		var data_all="";
		for (var i=1; i<=row_num; i++)
		{

			data_all=data_all+get_submitted_data_string('trim_group_'+i+'*pre_cost_trim_cost_id_'+i+'*dyeqty_'+i+'*color_'+i,"../../../",i);

		}
		//alert(data_all);
		var data="action=save_update_delete_dye_to_match&operation="+operation+'&total_row='+row_num+data_all+'&booking_no='+booking_no+'&fabric='+fabric+'&color='+color+'&fabric_cost_id='+fabric_cost_id;
		freeze_window(operation);
		http.open("POST","fabric_booking_urmi_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_fabric_booking_terms_condition_reponse;
}

function fnc_fabric_booking_terms_condition_reponse()
{

	if(http.readyState == 4)
	{
	        var reponse=trim(http.responseText).split('**');
			 if(trim(reponse[0])=='approved')
			 {
				 alert("This booking is approved");
				 release_freezing();
				 return;
			 }

			if(trim(reponse[0])=='papproved'){
				alert("This booking is Partial approved");
				release_freezing();
				return;
			}

			if (reponse[0].length>2) reponse[0]=10;
			release_freezing();
			if(reponse[0]==0 || reponse[0]==1)
			{
				var index=$('#index').val();
				parent.document.getElementById('trims_'+index).value=reponse[1];
				parent.emailwindow.hide();
			}
	}
}
</script>
<?
$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");

$dtm_arr=array();
$dtm_arr_item_color=array();
$sql=sql_select("select pre_cost_fabric_cost_id,fabric_color,precost_trim_cost_id,item_color,sum(qty) as qty from wo_dye_to_match where booking_no='$booking_no' and pre_cost_fabric_cost_id='$fabric_cost_id' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_id,fabric_color,item_color,precost_trim_cost_id");

foreach($sql as $row){
	$dtm_arr[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]][$row[csf('precost_trim_cost_id')]]=$row[csf('qty')];
	$dtm_arr_item_color[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]][$row[csf('precost_trim_cost_id')]]=$row[csf('item_color')];
}
$trims_matches_sql=sql_select("select a.id,a.job_no,a.trim_group,a.description,a.cons_uom FROM wo_pre_cost_trim_cost_dtls a, wo_pre_cost_trim_co_cons_dtls b,  wo_booking_dtls c
			WHERE
			a.job_no=b.job_no and
			a.job_no=c.job_no and
			a.id=b.wo_pre_cost_trim_cost_dtls_id and
			b.po_break_down_id=c.po_break_down_id and
			c.booking_no ='$booking_no' and
			b.po_break_down_id in($selected_no)
			and a.status_active=1 and a.is_deleted=0
			and c.status_active=1 and c.is_deleted=0
			group by a.id,a.job_no,a.trim_group,a.description,a.cons_uom");

	$condition= new condition();
	if(str_replace("'","",$job_no) !=''){
	$condition->job_no("='$job_no'");
	}
	if(str_replace("'","",$selected_no) !=''){
		$condition->po_id("in($selected_no)");
	}
	$condition->init();
	$trim= new trims($condition);
	//echo $trim->getQuery();
	$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
	$totalqtyarray_arr2=$trim->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
?>
</head>
<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
<fieldset>
<form id="dtm_1">
<input type="hidden" id="txt_job_no" name="txt_job_no" value="<? echo $job_no;  ?>"/>
<input type="hidden" id="txt_booking_no" name="txt_booking_no" value="<? echo $booking_no;  ?>"/>
<input type="hidden" id="txt_order_no_id" name="txt_order_no_id" value="<? echo $selected_no;  ?>"/>
<input type="hidden" id="fabric" name="txt_order_no_id" value="<? echo $fabric;  ?>"/>
<input type="hidden" id="color" name="color" value="<? echo $color;  ?>"/>
<input type="hidden" id="fabric_cost_id" name="fabric_cost_id" value="<? echo $fabric_cost_id;  ?>"/>
<input type="hidden" id="index" name="index" value="<? echo $index;  ?>"/>
	<table width="700" cellspacing="0" class="rpt_table" border="0" id="tbl_trims_dyes_match" rules="all">
	<thead>
	  <tr>
		<th width="40">S/L</th>
		<th width="150">Item Group</th>
		<th width="150">Item Color</th>
        <th width="150">Item Driscription</th>
		<th width="100">Req. Qty.</th>
		<th width="60">Uom</th>
        <th width="60">Dye Qnty</th>
	  </tr>
	</thead>
	<tbody>
	<?

	$i=1;
	foreach($trims_matches_sql as $row)
	 {
	 $item_color=$dtm_arr_item_color[$fabric_cost_id][$color][$row[csf('id')]];
	 if(empty($item_color)){
		 $item_color=$color;
	 }
	 $qnty=array_sum($totalqtyarray_arr2[$row[csf('job_no')]][$row[csf('trim_group')]][$row[csf('description')]][$item_color]);
	 ?>
	  <tr>
	  	<td width="40"><? echo $i; ?></td>
	  	<td width="150">
        <? echo $lib_item_group_arr[$row[csf('trim_group')]];?>
        <input class="text_boxes" type="hidden" style="width:150px;"  name="trim_group_<? echo $i; ?>" id="trim_group_<? echo $i; ?>" value="<? echo $row[csf('trim_group')];?>" readonly/>
         <input class="text_boxes" type="hidden" style="width:150px;"  name="pre_cost_trim_cost_id_<? echo $i; ?>" id="pre_cost_trim_cost_id_<? echo $i; ?>" value="<? echo $row[csf('id')];?>" readonly/>
        </td>
	  	<td width="150">
        <? //echo $color_library[$color];?>
        <input class="text_boxes" type="text" style="width:150px;"  name="color_<? echo $i; ?>" id="color_<? echo $i; ?>" value="<? echo $color_library[$item_color];?>"/>
        </td>
	  	<td width="120">
		<? echo $row[csf('description')];?>
        </td>
	  	<td width="100" title="Job and trim item wise=<?=$totalqtyarray_arr[$row[csf('job_no')]][$row[csf('id')]]?>">
        <input class="text_boxes_numeric" type="text" style="width:100px;"  name="reqqty_<? echo $i; ?>" id="reqqty_<? echo $i; ?>" value="<? echo $qnty;//$totalqtyarray_arr[$row[csf('job_no')]][$row[csf('id')]]; ?>" readonly/>
        </td>
        <td width="60">
        <input class="text_boxes" type="text" style="width:60px;"  name="uom_<? echo $i; ?>" id="uom_<? echo $i; ?>" value="<? echo $unit_of_measurement[$row[csf('cons_uom')]]; ?>" readonly/>
        </td>
        <td width="60">
        <input class="text_boxes_numeric" type="text" style="width:60px;"  name="dyeqty_<? echo $i; ?>" id="dyeqty_<? echo $i; ?>" value="<? echo $dtm_arr[$fabric_cost_id][$color][$row[csf('id')]] ?>"/>
        </td>
	  </tr>
	  <? $i++;

	  } ?>
	</tbody>
	</table>
    </form>
    <table width="650" cellspacing="0" class="" border="0">
        <tr>
            <td align="center" width="100%" class="button_container">
            <?
            echo load_submit_buttons( $permission, "fnc_fabric_dye_to_match", 0,0 ,"reset_form('dtm_1','','','','')",1) ;
            ?>
            </td>
        </tr>
    </table>
    </fieldset>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="save_update_delete_dye_to_match")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$booking_id=return_field_value( "id", "wo_booking_mst","booking_no ='$booking_no'");

		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no='$booking_no'");
		 foreach($sql as $row){
           // if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		    $is_approved=$row[csf('is_approved')];
        }
        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
				//var data="action=save_update_delete_dye_to_match&operation="+operation+'&total_row='+row_num+data_all+'&booking_no='+booking_no+'&fabric='+fabric+'&color='+color;
				//data_all=data_all+get_submitted_data_string('trim_group_'+i+'*pre_cost_trim_cost_id_'+i+'*dyeqty_'+i,"../../../",i);

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con);die;}
		$id=return_next_id( "id", "wo_dye_to_match", 1 ) ;
		$field_array="id,booking_id,booking_no,pre_cost_fabric_cost_id,fabric_color,item_color,precost_trim_cost_id,item_group,qty";//,status_active,is_deleted
		$total_dye_qty=0;
		$new_array_color=array();
		for ($i=1;$i<=$total_row;$i++)
		{
			$trim_group="trim_group_".$i;
			$pre_cost_trim_cost_id="pre_cost_trim_cost_id_".$i;
			$dyeqty="dyeqty_".$i;
			$item_color="color_".$i;
			
			if(str_replace("'","",$$item_color)!="")
			{
				if (!in_array(str_replace("'","",$$item_color),$new_array_color)){
					$color_id = return_id( str_replace("'","",$$item_color), $color_library, "lib_color", "id,color_name","118");
					$new_array_color[$color_id]=str_replace("'","",$$item_color);
				}
				else $color_id =  array_search(str_replace("'","",$$item_color), $new_array_color);
			}
			else $color_id=0;
			
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$booking_id.",'".$booking_no."','".$fabric_cost_id."','".$color."','".$color_id."',".$$pre_cost_trim_cost_id.",".$$trim_group.",".$$dyeqty.")";
			$total_dye_qty+=str_replace("'"," ",$$dyeqty);
			$id=$id+1;
		}
		//echo "10**insert into wo_dye_to_match (".$field_array.") values ".$data_array;die;
		$rID_de3=execute_query( "delete from wo_dye_to_match where  pre_cost_fabric_cost_id ='".$fabric_cost_id."' and fabric_color= '".$color."'",0);
		$rID=sql_insert("wo_dye_to_match",$field_array,$data_array,1);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID && $rID_de3){
			mysql_query("COMMIT");
			echo "0**".$total_dye_qty;
			}
			else{
			mysql_query("ROLLBACK");
			echo "10**".$total_dye_qty;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID && $rID_de3){
			oci_commit($con);
			echo "0**".$total_dye_qty;
			}
			else{
			oci_rollback($con);
			echo "10**".$total_dye_qty;
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="rmg_process_loss_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
?>
	<script>
function js_set_value_set()
{
	  var cutting_per=$('#cutting_per').val();
	  if(cutting_per=="") cutting_per=0;

	  var embbroidery_per=$('#embbroidery_per').val();
	  if(embbroidery_per=="") embbroidery_per=0;

	  var printing_per=$('#printing_per').val();
	  if(printing_per=="") printing_per=0;

	  var wash_per=$('#wash_per').val();
	  if(wash_per=="") wash_per=0;

	  var sew_per=$('#sew_per').val();
	  if(sew_per=="") sew_per=0;

	  var fin_per=$('#fin_per').val();
	  if(fin_per=="") fin_per=0;

	var knitt_per=$('#knitt_per').val();
	  if(knitt_per=="") knitt_per=0;

	  var dying_per=$('#dying_per').val();
	  if(dying_per=="") dying_per=0;

	  var extracutt_per=$('#extracutt_per').val();
	  if(extracutt_per=="") extracutt_per=0;

	  var other_per=$('#other_per').val();
	  if(other_per=="")other_per=0;

	  var neck_sleev_printing_per=$('#neck_sleev_printing_per').val();
	  if(neck_sleev_printing_per=="") neck_sleev_printing_per=0;

	 // var gmt_other_per=$('#gmt_other_per').val();
	 // if(gmt_other_per=="") gmt_other_per=0;
	  gmt_other_per=0;

	  var yarn_dyeing_per=$('#yarn_dyeing_per').val();
	  if(yarn_dyeing_per=="") yarn_dyeing_per=0;

	  var all_over_print_per=$('#all_over_print_per').val();
	  if(all_over_print_per=="")all_over_print_per=0;

	  var lay_wash_per=$('#lay_wash_per').val();
	  if(lay_wash_per=="") lay_wash_per=0;

	  var gmtfinish_per=$('#gmtfinish_per').val();
	  if(gmtfinish_per=="") gmtfinish_per=0;

	 var txt_processloss_breck_down=cutting_per+'_'+embbroidery_per+'_'+printing_per+'_'+wash_per+'_'+sew_per+'_'+fin_per+'_'+knitt_per+'_'+dying_per+'_'+extracutt_per+'_'+other_per+'_'+neck_sleev_printing_per+'_'+gmt_other_per+'_'+yarn_dyeing_per+'_'+all_over_print_per+'_'+lay_wash_per+'_'+gmtfinish_per;
	 document.getElementById('txt_processloss_breck_down').value=txt_processloss_breck_down;
	 parent.emailwindow.hide();
}
    </script>

</head>

<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
	<?
	$data=explode("_",$txt_processloss_breck_down);
	?>
<fieldset>
    <form autocomplete="off">
    <input style="width:60px;" type="hidden" class="text_boxes"  name="txt_processloss_breck_down" id="txt_processloss_breck_down" />
    <table width="180" class="rpt_table" border="1" rules="all">
               <tr>
                <td width="130">
               Cut Panel rejection <!--  Extra Cutting %  breack Down 8-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="extracutt_per" id="extracutt_per" value="<? echo $data[8];  ?>"  />
                </td>
                </tr>
                <tr>
                <td width="130">
                 Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="printing_per" id="printing_per" value="<? echo $data[2];  ?>" />
                </td>
                </tr>


                <tr>
                <td width="130">
                 Neck/Sleeve Printing <!-- new breack Down 10-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="neck_sleev_printing_per" id="neck_sleev_printing_per" value="<? echo $data[10];  ?>" />
                </td>
                </tr>


                <tr>
                <td width="130">
                Embroidery  <!-- Embroidery  % breack Down 1-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="embbroidery_per" id="embbroidery_per" value="<? echo $data[1];  ?>"  />
                </td>
                </tr>


                <tr>
                <td width="130">
                Sewing/Input <!-- Sewing % breack Down 4-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="sew_per" id="sew_per" value="<? echo $data[4];  ?>" />
                </td>
                </tr>

                <tr>
                <td width="130">
                Garments Wash  <!-- Washing % breack Down 3-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="wash_per" id="wash_per"  value="<? echo $data[3];  ?>" />
                </td>
                </tr>

                <tr>
                <td width="130">
                Gmts Finishing  <!-- Washing % breack Down 3-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="gmtfinish_per" id="gmtfinish_per"  value="<? echo $data[15];  ?>" />
                </td>
                </tr>


                <!--<tr>
                <td width="130">-->
                  <!--  Others New breack Down 11-->
               <!-- </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="gmt_other_per" id="gmt_other_per" value="<? //echo $data[11];  ?>"  />
                </td>
                </tr>-->

                <tr>
                <td width="130">
                 Knitting   <!-- Knitting % breack Down 6-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="knitt_per" id="knitt_per" value="<? echo $data[6];  ?>"  />
                </td>
                </tr>

                <tr>
                <td width="130">
                 Yarn Dyeing   <!-- New breack Down 12-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="yarn_dyeing_per" id="yarn_dyeing_per" value="<? echo $data[12];  ?>"  />
                </td>
                </tr>

                <tr>
                <td width="130">
                Dyeing & Finishing   <!-- Finishing % breack Down 5-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="fin_per" id="fin_per" value="<? echo $data[5];  ?>"  />
                </td>
                </tr>


                <tr>
                <td width="130">
                All Over Print  <!-- New breack Down 13-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="all_over_print_per" id="all_over_print_per" value="<? echo $data[13];  ?>"  />
                </td>
                </tr>

                <tr>
                <td width="130">
                Lay Wash (Fabric)  <!-- New breack Down 14-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="lay_wash_per" id="lay_wash_per" value="<? echo $data[14];  ?>"  />
                </td>
                </tr>


                <tr>
                <td width="130">
                 Dyeing  <!--breack Down 7-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="dying_per" id="dying_per" value="<? echo $data[7];  ?>"  />
                </td>
                </tr>
                <tr>
                <td width="130">
                 Cutting (Febric) <!-- Cutting % breack Down 0-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="cutting_per" id="cutting_per" value="<? echo $data[0];  ?>" />
                </td>
                </tr>
                <tr>
                <td width="130">
                 Others <!--breack Down 9-->
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="other_per" id="other_per" value="<? echo $data[9];  ?>"  />
                </td>
                </tr>

                <tr>
               <td align="center"  class="button_container" colspan="2">
			    <input type="button" class="formbutton" value="Close" onClick="js_set_value_set()"/>
                 </td>
                </tr>
           </table>
    </form>
</fieldset>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="open_adjust_qty_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	echo "select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,b. color_number_id,c. contrast_color_id  FROM wo_pre_cost_fabric_cost_dtls a,  wo_pre_cos_fab_co_avg_con_dtls b  left join wo_pre_cos_fab_co_color_dtls  c on b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.job_no ='$txt_job_no' and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b. color_number_id,c. contrast_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width";


	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	a.job_no ='$txt_job_no' and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
?>
	<script>
    </script>

</head>

<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
   <form name="orderdetailsentry_2"  autocomplete="off" id="orderdetailsentry_2">
        <fieldset style="width:950px;">
            <legend>Details</legend>
            <table style="border:none" cellpadding="0" cellspacing="2" border="0">
                <thead class="form_table_header">
                    <tr align="center" >
                        <th  width="400">Fabric Description</th>
                        <th  width="100">Dia</th>
                    </tr>
                </thead>
                    <tr>
                        <td id="fabricdescription_id_td">
                        <?  echo create_drop_down( "cbo_fabricdescription_id", 400, $blank_array,"", 1, "--Select--", $selected, "" ); ?>
                        </td>
                        <td>
                        <input class="text_boxes" type="text" name="newdia" id="newdia"  value=""  style="width:100px"/>
                        <input class="text_boxes" type="hidden" name="saveddia" id="saveddia"  value=""  style="width:100px"/>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" colspan="12" id="breackdown_form">
                        </td>
                    </tr>
                    <tr>
                        <td align="center" colspan="12" valign="middle" class="button_container">
                        <input class="text_boxes" name="txt_update_dtls_id" id="txt_update_dtls_id" type="hidden" value=""  style="width:100px"/>
                        <?
                        echo load_submit_buttons( $permission, "fnc_fabric_booking_dtls", 0,0 ,"reset_form('orderdetailsentry_2','breackdown_form','','','','')",2);//other_work()
                        ?>
                        <input type="button" value="Print Booking" onClick="generate_fabric_report('show_fabric_booking_report')"  style="width:100px" name="print" id="print" class="formbutton" />
                        <div id="pdf_file_name"></div>
                        </td>
                        </tr>
                         <tr>
                        <td align="center" colspan="12" id="list_view">
                        </td>
                    </tr>

            </table>
        </fieldset>
    </form>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="show_fabric_booking_report_gr")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if(str_replace("'","",$cbo_booking_gr)!="")
	{
		$booking_check_array=explode(",",$cbo_booking_gr);
	}
	$cbo_booking_gr_arr=array();
	if(count($booking_check_array)>0)
	{
		foreach($booking_check_array as $val)
		{
			$cbo_booking_gr_arr[$val]=$val;
		}
	}

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");

	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px; font-weight:bold" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no,a.is_approved, count(b.id) as revised_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 group by a.is_approved");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
		$path = str_replace("'", "", $path);
		if ($path == "") {
			$path = '../../';
		}

	ob_start();
?>
        <!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                             <td rowspan="3" width="250" id="barcode_img_id">

                             </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								if($nameArray_approved_row[csf('approved_no')]==1 && $nameArray_approved_row[csf('is_approved')]==0){
									?>
                                    <b> Revised No :  <? echo $nameArray_approved_row[csf('revised_no')]; //echo $nameArray_approved_row[csf('approved_no')]; ?></b>
                                      <br/>
                                      Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
                                    <?

								}
								 if($nameArray_approved_row[csf('approved_no')]>1 && $nameArray_approved_row[csf('is_approved')]==0)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('revised_no')];//echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1 && ($nameArray_approved_row[csf('is_approved')]==1 || $nameArray_approved_row[csf('is_approved')]==3))
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('revised_no')]-1;//echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;

				$booking_po_id=str_replace("'","",$txt_order_no_id);


				if($db_type==0)
				{
					$nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.factory_marchant,group_concat(c.po_number) as po_number_all,MIN(c.pub_shipment_date) as pub_shipment_date, group_concat(DATEDIFF(c.pub_shipment_date,c.po_received_date)) as  date_diff, MIN(c.pub_shipment_date) as  pub_shipment_date, MIN(c.insert_date) as po_insert_date,group_concat(c.shiping_status) as shiping_status, sum(c.po_quantity*b.total_set_qnty) as po_qnty_pce,sum(c.plan_cut*b.total_set_qnty) as plan_cut,a.pay_mode
				from wo_booking_mst a, wo_po_details_master b, wo_po_break_down c
				where  a.job_no=b.job_no and b.job_no=c.job_no_mst and a.booking_no=$txt_booking_no and c.id in($booking_po_id)
				group by a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.pay_mode,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.factory_marchant");
				}
				else//LISTAGG(cast(b.id as varchar2(4000)), ',') WITHIN GROUP (ORDER BY b.id) as po_id
				{
					$nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.factory_marchant, LISTAGG(cast(c.po_number as varchar2(4000)), ', ') WITHIN GROUP (ORDER BY c.po_number) as po_number_all, LISTAGG(cast(c.pub_shipment_date as varchar2(4000)), ',') WITHIN GROUP (ORDER BY c.pub_shipment_date)  as pub_shipment_date, LISTAGG(cast((c.pub_shipment_date-c.po_received_date) as varchar2(4000)), ',') WITHIN GROUP (ORDER BY c.pub_shipment_date,c.po_received_date) as  date_diff, MIN(c.pub_shipment_date) as  pub_shipment_date, MIN(c.insert_date) as po_insert_date, LISTAGG(cast(c.shiping_status as varchar2(4000)), ',') WITHIN GROUP (ORDER BY c.shiping_status) as shiping_status, sum(c.po_quantity*b.total_set_qnty) as po_qnty_pce,sum(c.plan_cut*b.total_set_qnty) as plan_cut,a.pay_mode
				from wo_booking_mst a, wo_po_details_master b, wo_po_break_down c
				where  a.job_no=b.job_no and b.job_no=c.job_no_mst and a.booking_no=$txt_booking_no and c.id in($booking_po_id)
				group by a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.pay_mode,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.factory_marchant");
				}


				$po_plancut_sql=sql_select("select sum(order_quantity) as order_quantity,sum(plan_cut_qnty) as plan_cut_qnty
				from wo_po_color_size_breakdown where po_break_down_id in($booking_po_id) and status_active=1 and is_deleted=0");

				$po_id_all=$nameArray[0][csf('po_break_down_id')];
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date,
								(case when task_number=50 then task_start_date else null end) as yarn_issue_start_date,
								(case when task_number=50 then task_finish_date else null end) as yarn_issue_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
						$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_start_date']=$row[csf("fab_booking_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_end_date']=$row[csf("fab_booking_end_date")];
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
					if($row[csf("yarn_issue_start_date")]!="" && $row[csf("yarn_issue_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_issue_start_date']=$row[csf("yarn_issue_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_issue_end_date']=$row[csf("yarn_issue_end_date")];
					}
				}

				$tna_start_date="";
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no="";
					$shipment_date="";
					$shiping_status_arr=explode(",",$result[csf('shiping_status')]);
					$shiping_status_arr=array_unique($shiping_status_arr);
					if(count($shiping_status_arr)==1 && $shiping_status_arr[0]==3)
					{

						$shiping_status= "Full shipment";
					}
					else if(count($shiping_status_arr)==1 && $shiping_status_arr[0]==1)
					{
						$shiping_status= "Full Pending";
					}
					else
					{
						$shiping_status= "Partial shipment";
					}


					$varcode_booking_no=$result[csf('booking_no')];
					$po_qnty_tot+=$result[csf('plan_cut')];

				?>
            <table width="1330" style="border:1px solid black">
                <tr>
                	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
                </tr>
                <tr>
                    <td width="150"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                    <td width="300">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                    <td width="150"><span style="font-size:16px"><b>Dept.</b></span></td>
                    <td width="300">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                    <td width="150" style="font-size:18px"><b>Booking No </b>   </td>
                    <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
                </tr>
                <tr>
                    <td  style="font-size:16px"><b>Garments Item</b></td>
                    <td>:&nbsp;
                    <?
                    $gmts_item_name="";
                    $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                    for($g=0;$g<=count($gmts_item); $g++)
                    {
                    $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                    }
                    echo rtrim($gmts_item_name,',');
                    ?>
                    </td>
                    <td  style="font-size:16px"><b>Lead Time </b>   </td>
                    <td>:&nbsp;<?  echo rtrim($result[csf('date_diff')],",");?> </td>
                    <td style="font-size:12px"><b>Supplier Name</b>   </td>
                    <td>:&nbsp;<?
							if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
							echo $company_library[$result[csf('supplier_id')]];
							}
							else{
							echo $supplier_name_arr[$result[csf('supplier_id')]];
							}
						//echo $supplier_name_arr[$result[csf('supplier_id')]];
						?>
                        </td>
                </tr>
                <tr>
                    <td style="font-size:18px"><b>Style Ref.</b>   </td>
                    <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
                    <td style="font-size:12px"><b>Style Des.</b></td>
                    <td >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                    <td style="font-size:12px"><b>Attention</b></td>
                    <td >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                </tr>
                <tr>
                    <td><span style="font-size:18px"><b>Order Qnty</b></span></td>
                    <td style="font-size:18px">:&nbsp;<b><?  echo $po_plancut_sql[0][csf("order_quantity")]." Pcs";
					//echo number_format($result[csf('po_qnty_pce')],0)." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?></b></td>
                    <td style="font-size:16px"><b>Plan Cut Qty</b></td>
                    <td style="font-size:16px">:&nbsp;<b><?

					    echo $po_plancut_sql[0][csf("plan_cut_qnty")]." Pcs";

					// echo number_format($result[csf('plan_cut')],0)." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?></b></td>
                    <td style="font-size:12px"><b>Factory Merchant</b></td>
                    <td>:&nbsp;<? echo $marchentrArr[$result[csf('factory_marchant')]]; ?></td>
                </tr>
                <tr>
                    <td style="font-size:18px;" valign="top"><b>Order No</b></td>
                    <td style="font-size:18px;" colspan="3" valign="top">:&nbsp;<b><? echo $result[csf('po_number_all')];//echo rtrim($po_no,", "); ?></b></td>
                    <td style="font-size:12px" valign="top"><b>Currency</b></td>
                    <td valign="top">:&nbsp;<? echo $currency[$result[csf('currency_id')]]; $currency_id=$result[csf('currency_id')]; $exchang_rate=$result[csf('exchange_rate')]; ?></td>
                </tr>
            </table>
            <br>
            <table width="100%" style="border:1px solid black" >
                <tr>
                    <td width="150" style="font-size:12px"><b>Booking Release Date</b></td>
                    <td width="300">:&nbsp;
                    <?

					$booking_date=$result[csf('booking_date')];
                    echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                    ?>&nbsp;&nbsp;&nbsp;</td>
                    <td  width="150" style="font-size:12px"><b>TNA Start Date</b></td>
                    <td  width="300" >:&nbsp;<? echo change_date_format($tna_fab_start); ?></td>
                    <?
					$daysInHand.=(datediff('d',date('d-m-Y',time()),$result[csf('pub_shipment_date')])-1).",";
					 if($tna_fab_start!="")
					 {
					 	$wo_perpare_after=(datediff('d',$tna_fab_start,$booking_date)-1);
					 }
					 if($wo_perpare_after<1) $prep_caption="Before"; else  $prep_caption="After";
					?>
                    <td width="150" style="font-size:16px"><b>WO Prepared <? echo $prep_caption; ?> </b>   </td>
                    <td style="font-size:18px">:&nbsp;<b>
					<?

					 echo abs($wo_perpare_after).' Days';
					 ?></b>
					</td>
                </tr>
                <tr>
                    <td style="font-size:18px"><b>Delivery Date</b></td>
                    <td style="font-size:18px; font-weight:bold;">:&nbsp;<? if($result[csf('delivery_date')]!="" && $result[csf('delivery_date')]!='0000-00-00') echo change_date_format( $result[csf('delivery_date')]);?></td>
                    <td style="font-size:12px"><b>Shipment Date</b></td>
                    <td > :&nbsp;<? if($result[csf('pub_shipment_date')]!="" && $result[csf('pub_shipment_date')]!='0000-00-00')  echo change_date_format($result[csf('pub_shipment_date')]);//echo rtrim($shipment_date,", "); ?></td>
                    <td style="font-size:18px"><b>Ship.days in Hand</b></td>
                    <td style="font-size:18px"> :&nbsp;<b><? echo rtrim($daysInHand,',').' Days'; ?></b></td>
                </tr>
                <?
				if($db_type==0)
				{
					$last_update_date=return_field_value("max(date(update_date)) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
				}
				else
				{
					$last_update_date=return_field_value("max(to_char(update_date,'DD-MM-YYYY')) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
				}
				?>
                <tr>
                    <td style="font-size:18px"><b>Last Update</b></td>
                    <td style="font-size:18px">:&nbsp;<b><? if($last_update_date!="" && $last_update_date!="0000-00-00") echo change_date_format($last_update_date);?></b></td>
                    <td style="font-size:18px"><b>Ex-factory status</b></td>
                    <td style="font-size:18px">:&nbsp;<b><? echo $shiping_status;?></b></td>
                </tr>
            </table>
            <?
			}
			// motivation end!!

			?>
            <table width="100%" >
            	<tr>
                	<td width="30%" valign="top">
                        <?
                        $rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
                        ?>
                        <fieldset id="" >
                        <legend>RMG Process Loss % </legend>
                            <table width="180" class="rpt_table" border="1" rules="all">
                            <?
                            if(number_format($rmg_process_breakdown_arr[8],2)>0)
                            {
                                ?>
                                    <tr>
                                        <td width="130">
                                        Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                                        </td>
                                        <td align="right">
                                        <?
                                        echo number_format($rmg_process_breakdown_arr[8],2);
                                        ?>
                                        </td>
                                    </tr>
                                <?
                            }
                            if(number_format($rmg_process_breakdown_arr[2],2)>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Chest Printing <!-- Printing % breack Down 2-->
                                    </td>
                                    <td align="right">
                                    <?
                                    echo number_format($rmg_process_breakdown_arr[2],2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            if(number_format($rmg_process_breakdown_arr[10],2)>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Neck/Sleeve Printing <!-- New breack Down 10-->
                                    </td>
                                    <td align="right">
                                    <?
                                    echo number_format($rmg_process_breakdown_arr[10],2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            if(number_format($rmg_process_breakdown_arr[1],2)>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Embroidery   <!-- Embroidery  % breack Down 1-->
                                    </td>
                                    <td align="right">
                                    <?
                                    echo number_format($rmg_process_breakdown_arr[1],2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            if(number_format($rmg_process_breakdown_arr[4],2)>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Sewing /Input<!-- Sewing % breack Down 4-->
                                    </td>
                                    <td align="right">
                                    <?
                                    echo number_format($rmg_process_breakdown_arr[4],2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            if(number_format($rmg_process_breakdown_arr[3],2)>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Garments Wash <!-- Washing %breack Down 3-->
                                    </td>
                                    <td align="right">
                                    <?
                                    echo number_format($rmg_process_breakdown_arr[3],2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            if(number_format($rmg_process_breakdown_arr[15],2)>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Gmts Finishing <!-- Washing %breack Down 3-->
                                    </td>
                                    <td align="right">
                                    <?
                                    echo number_format($rmg_process_breakdown_arr[15],2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            if(number_format($rmg_process_breakdown_arr[11],2)>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Others <!-- New breack Down 11-->
                                    </td>
                                    <td align="right">
                                    <?
                                    echo number_format($rmg_process_breakdown_arr[11],2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            $gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
                            if($gmts_pro_sub_tot>0)
                            {
                                ?>
                                <tr>
                                    <td width="130">
                                    Sub Total <!-- New breack Down 11-->
                                    </td>
                                    <td align="right">
                                    <?

                                    echo number_format($gmts_pro_sub_tot,2);
                                    ?>
                                    </td>
                                </tr>
                                <?
                            }
                            ?>
                            </table>
                        </fieldset>
                    </td>
                    <td width="30%"  valign="top">
                    	<fieldset id="" >
                        <legend>Fabric Process Loss % </legend>
                        <table width="100%" class="rpt_table" border="1" rules="all">
                        <?
                        if(number_format($rmg_process_breakdown_arr[6],2)>0)
                        {
							?>
							<tr>
								<td width="130">
								Knitting  <!--  Knitting % breack Down 6-->
								</td>
								<td align="right">
								<?
								echo number_format($rmg_process_breakdown_arr[6],2);
								?>
								</td>
								</tr>
								<?
								}
								if(number_format($rmg_process_breakdown_arr[12],2)>0)
								{
								?>
								<tr>
								<td width="130">
								Yarn Dyeing  <!--  New breack Down 12-->
								</td>
								<td align="right">
								<?
								echo number_format($rmg_process_breakdown_arr[12],2);
								?>
								</td>
							</tr>
							<?
                        }
                        if(number_format($rmg_process_breakdown_arr[5],2)>0)
                        {
							?>
							<tr>
								<td width="130">
								Dyeing & Finishing  <!-- Finishing % breack Down 5-->
								</td>
								<td align="right">
								<?
								echo number_format($rmg_process_breakdown_arr[5],2);
								?>
								</td>
							</tr>
							<?
                        }
                        if(number_format($rmg_process_breakdown_arr[13],2)>0)
                        {
							?>
							<tr>
								<td width="130">
								All Over Print <!-- new  breack Down 13-->
								</td>
								<td align="right">
								<?
								echo number_format($rmg_process_breakdown_arr[13],2);
								?>
								</td>
							</tr>
							<?
                        }
                        if(number_format($rmg_process_breakdown_arr[14],2)>0)
                        {
							?>
							<tr>
                                <td width="130">
                                Lay Wash (Fabric) <!-- new  breack Down 14-->
                                </td>
                                <td align="right">
                                <?
                                echo number_format($rmg_process_breakdown_arr[14],2);
                                ?>
                                </td>
							</tr>
							<?
                        }
                        if(number_format($rmg_process_breakdown_arr[7],2)>0)
                        {
							?>
							<tr>
                                <td width="130">
                                Dying   <!-- breack Down 7-->
                                </td>
                                <td align="right">
                                <?
                                echo number_format($rmg_process_breakdown_arr[7],2);
                                ?>
                                </td>
							</tr>
							<?
                        }
                        if(number_format($rmg_process_breakdown_arr[0],2)>0)
                        {
							?>
							<tr>
                                <td width="130">
                                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                                </td>
                                <td align="right">
                                <?
                                echo number_format($rmg_process_breakdown_arr[0],2);
                                ?>
                                </td>
							</tr>
							<?
                        }
                        if(number_format($rmg_process_breakdown_arr[9],2)>0)
                        {
							?>
							<tr>
                                <td width="130">
                                Others  <!-- Others% breack Down 9-->
                                </td>
                                <td align="right">
                                <?
                                echo number_format($rmg_process_breakdown_arr[9],2);
                                ?>
                                </td>
							</tr>
							<?
                        }
                        $fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
                        if(fab_proce_sub_tot>0)
                        {
							?>
							<tr>
                                <td width="130">
                                Sub Total  <!-- Others% breack Down 9-->
                                </td>
                                <td align="right">
                                <?

                                echo number_format($fab_proce_sub_tot,2);
                                ?>
                                </td>
							</tr>
							<?
                        }
                        if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
                        {
							?>
							<tr>
                                <td width="130">
                                Grand Total  <!-- Others% breack Down 9-->
                                </td>
                                <td align="right">
                                <?
                                echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
                                ?>
                                </td>
							</tr>
							<?
                        }
                        ?>
                        </table>
                        </fieldset>
                    </td>
                    <td valign="top">
						<?
                        $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
                        ?>
                        <fieldset id="" >
                        <legend>Image </legend>
                        <table width="310">
                            <tr>
                            <?
                            $img_counter = 0;
                            foreach($nameArray_imge as $result_imge)
                            {
                                if($path=="")
                                {
                                	$path='../../';
                                }

                                ?>
                                <td>
                                    <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="80" height="60" border="2" />
                                </td>
                                <?

                                $img_counter++;
                            }
                            ?>
                            </tr>
                       </table>
                       </fieldset>
                    </td>
                </tr>
            </table>

            <?
			$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down",'id','po_number');
			if(count($cbo_booking_gr_arr)>0)
			{
					if($cbo_booking_gr_arr[1]!="")
					{
						if($cbo_fabric_source==1 || $cbo_fabric_source==2)
						{
						 $nameArray_size=sql_select( "select distinct size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1  order by size_number_id desc");
					   ?>
						<table width="100%" >
							<tr>
								<td width="100%">
								<div id="div_size_color_matrix" style="float:left; max-width:1000;">
								<fieldset id="div_size_color_matrix" style="max-width:1000;">
								<legend>Size and Color Breakdown </legend>
								<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
									<tr>
										<td style="border:1px solid black"><strong>PO Number</strong></td>
										<td style="border:1px solid black"><strong>Ship Date</strong></td>
										<td style="border:1px solid black"><strong>Gmts Item</strong></td>
										<td style="border:1px solid black"><strong>Color/Size</strong></td>
									<?
										foreach($nameArray_size  as $result_size)
										{	     ?>
										<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
									<?	}    ?>
										<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
										<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
										<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
									</tr>
									<?
									$color_size_order_qnty_array=array();
									$color_size_qnty_array=array();
									$size_tatal=array();
									$size_tatal_order=array();
									$order_id=explode(",",str_replace("'","",$txt_order_no_id));
									for($or=0;$or<count($order_id); $or++)
									{
									for($c=0;$c<count($gmts_item); $c++)
									{
									$item_size_tatal=array();
									$item_size_tatal_order=array();
									$item_grand_total=0;
									$item_grand_total_order=0;
									$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
									?>
								   <!-- <tr>
									<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

									</tr>-->
									<?
									foreach($nameArray_color as $result_color)
									{
									?>
									<tr>
										<td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
										 <td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
										  <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
										<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
										<?
										$color_total=0;
										$color_total_order=0;

										foreach($nameArray_size  as $result_size)
										{
										$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0 order by size_number_id");
										foreach($nameArray_color_size_qnty as $result_color_size_qnty)
										{

										?>
											<td style="border:1px solid black; text-align:right">
											<?
												if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
												{
													 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
													 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
													 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
													 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
													 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
													 $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
													 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
													 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
													 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
													 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
													 {
															$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
													 }
													 else
													 {
														$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
														$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
													 }
													 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
													 {
															$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
													 }
													 else
													 {
														$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
														$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
													 }
												}
												else echo "0";
											 ?>
											</td>

									<?
										}
										}
										?>
										<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
										 <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
										 <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
									</tr>
									<?
									}
									?>
									<tr>
									  <td align="center" style="border:1px solid black"><strong></strong></td>
									  <td align="center" style="border:1px solid black"><strong></strong></td>
									  <td align="center" style="border:1px solid black"><strong></strong></td>
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
										?>
										<td style="border:1px solid black;  text-align:right"><? echo number_format($item_size_tatal_order[$result_size[csf('size_number_id')]],0);  ?></td>
										<?
										}
										?>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
									</tr>
									<?
									}
									}
									?>
									 <tr>
										<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
									</tr>
									<!--<tr>-->
									<tr>
									<td align="center" style="border:1px solid black"><strong></strong></td>
									<td align="center" style="border:1px solid black"><strong></strong></td>
									<td align="center" style="border:1px solid black"><strong></strong></td>
										<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
										?>
										<td style="border:1px solid black;  text-align:right"><? echo number_format( $size_tatal_order[$result_size[csf('size_number_id')]],0);  ?></td>
										<?
										}
										?>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
										<td  style="border:1px solid black;  text-align:right">
										<?
										$excess_gra_tot= ($po_qnty_tot-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %";
										?>
                                        </td>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($po_qnty_tot),0); ?></td>
									</tr>
								</table>
									</fieldset>
									</div>
								</td>
							</tr>
					   </table>
						<?
						}// if($cbo_fabric_source==1) end
					}

			  ?>
			  <br/>

			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;
			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;
			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;
			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;
			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");

			?>

			<?
			if($cbo_booking_gr_arr[2]!="")
			{
				if($cbo_fabric_source==1)
				{
				$nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.status_active=1 and
				d.is_deleted=0
				group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");
				 ?>

				 <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				 <tr align="center">
				 <th colspan="3" align="left">Body Part</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
					}
					?>
					<td  rowspan="9" width="50"><p>Total  Finish Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
					<td  rowspan="9" width="50"><p>Total Grey Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
					<td  rowspan="9" width="50"><p>Process Loss % </p></td>
				   </tr>
				 <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
					}
					?>
					<!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
						 <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
				   </tr>
					<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
					}
					?>


				   </tr>
					<tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
						else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else         		              echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
					}
					?>

				   </tr>
				   <tr>
				   <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
				   </tr>

				   <tr>
						<!--<th  width="120" align="left">Gmts. Color</th>-->
						<th  width="120" align="left">Fabric Color</th>
						<th  width="120" align="left">Body Color</th>
						<th  width="120" align="left">Lab Dip No</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
					}
					?>

				   </tr>
				   <?


					  $gmt_color_library=array();
					  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
					  FROM
					  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
					  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
					  a.job_no ='$job_no'");
					  foreach( $gmt_color_data as $gmt_color_row)
					  {
						$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
					  }

						$grand_total_fin_fab_qnty=0;
						$grand_total_grey_fab_qnty=0;
						$grand_totalcons_per_finish=0;
						$grand_totalcons_per_grey=0;
						$color_wise_wo_sql=sql_select("select fabric_color_id
													  FROM
													  wo_booking_dtls
													  WHERE
													  booking_no =$txt_booking_no and
													  status_active=1 and
													  is_deleted=0
													  group by fabric_color_id");
					foreach($color_wise_wo_sql as $color_wise_wo_result)
					{
					?>
						<tr>
					   <!-- <td  width="120" align="left">
						<?

						//echo $color_library[$color_wise_wo_result['fabric_color_id']];

						?></td>-->
						<td  width="120" align="left">
						<?
						echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


						?>
						</td>
						<td>
						<?
						//echo $color_library[$gmt_color_library[$color_wise_wo_result['fabric_color_id']]];
						//echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
						echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
						?>
						</td>
						<td  width="120" align="left">
						<?
						$order_id=str_replace("'","",$txt_order_no_id);
						$lapdip_no="";
						$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."'  and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
						if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
						?>
						</td>
						<?
						$total_fin_fab_qnty=0;
						$total_grey_fab_qnty=0;

						foreach($nameArray_fabric_description as $result_fabric_description)
						{

							if($db_type==0)
							{
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							WHERE a.job_no=b.job_no and
							a.id=b.pre_cost_fabric_cost_dtls_id and
							c.job_no_mst=a.job_no and
							c.id=b.color_size_table_id and
							b.po_break_down_id=d.po_break_down_id and
							b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
							d.booking_no =$txt_booking_no and
							a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
							a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
							a.construction='".$result_fabric_description[csf('construction')]."' and
							a.composition='".$result_fabric_description[csf('composition')]."' and
							a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
							b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
							d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
							d.status_active=1 and
							d.is_deleted=0
							");
							}
							if($db_type==2)
							{

							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							WHERE a.job_no=b.job_no and
							a.id=b.pre_cost_fabric_cost_dtls_id and
							c.job_no_mst=a.job_no and
							c.id=b.color_size_table_id and
							b.po_break_down_id=d.po_break_down_id and
							b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
							d.booking_no =$txt_booking_no and
							a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
							a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
							a.construction='".$result_fabric_description[csf('construction')]."' and
							a.composition='".$result_fabric_description[csf('composition')]."' and
							a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
							b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
							nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
							d.status_active=1 and
							d.is_deleted=0
							");
							}

							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'>
						<?
						if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
						{
						echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
						$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
						}
						?>
						</td>
						<td width='50' align='right' >
						<?
						if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
						{
						echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
						$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						}
						?>
						</td>
						<?
						}
						?>
						<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
						<td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

						<td align="right">
						<?
						if($process_loss_method==1)
						{
							$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
						}

						if($process_loss_method==2)
						{
							$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
						}
						echo number_format($process_percent,2);

						?>

						</td>
						</tr>
					 <?
					}
					?>
					<tr style=" font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Total</strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{

							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
						<?
						}
						?>
						<td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
						<td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
						<td align="right">
						<?
						if($process_loss_method==1)// markup
						{
							$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
						}

						if($process_loss_method==2) //margin
						{
							$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
						}
						echo number_format($totalprocess_percent,2);
						?>
						</td>
						</tr>
						<tr style="font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{

							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

						?>
						<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
						<?
						}
						?>
						<td align="right"><? echo number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)?></td>
						<td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)?></td>
						<td align="right">
						<?
						if($process_loss_method==1)
						{
							$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
						}

						if($process_loss_method==2)
						{
							$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
						}
						echo number_format($totalprocess_percent_dzn,2);
						?>
						</td>
						</tr>

				</table>
				<?
				}

				if($cbo_fabric_source==2)
				{

					$nameArray_fabric_description= sql_select("select a.body_part_id,a.uom,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment
					FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					d.status_active=1 and
					d.is_deleted=0
					group by a.body_part_id,a.uom,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");

				 ?>

				 <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				 <tr align="center">
				 <th colspan="3" align="left">Body Part</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
					}
					?>
					<td  rowspan="9" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$result_fabric_description[csf('uom')]];//if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?>)</p></td>
					<td  rowspan="9" width="50"><p>Avg Rate(<? $unit_of_measurement[$result_fabric_description[csf('uom')]];//if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?>)</p></td>
					<td  rowspan="9" width="50"><p>Amount </p></td>
				   </tr>
				 <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
					}
					?>
					<!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
						 <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
				   </tr>
					<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
					}
					?>


				   </tr>
					<tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
					}
					?>

				   </tr>
				   <tr>
				   <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
				   </tr>

				   <tr>
						<!--<th  width="120" align="left">Gmts. Color</th>-->
						<th  width="120" align="left">Fabric Color</th>
						<th  width="120" align="left">Body Color</th>
						<th  width="120" align="left">Lab Dip No</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
					}
					?>

				   </tr>
				   <?
					  $gmt_color_library=array();
					  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
					  FROM
					  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
					  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
					  a.job_no ='$job_no'");
					  foreach( $gmt_color_data as $gmt_color_row)
					  {
						$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
					  }

						$grand_total_fin_fab_qnty=0;
						$grand_total_amount=0;
						$color_wise_wo_sql=sql_select("select fabric_color_id, avg(rate) as dtls_rate
													  FROM
													  wo_booking_dtls
													  WHERE
													  booking_no =$txt_booking_no and
													  status_active=1 and
													  is_deleted=0
													  group by fabric_color_id");
					foreach($color_wise_wo_sql as $color_wise_wo_result)
					{
					?>
						<tr>
					   <!-- <td  width="120" align="left">
						<?

						//echo $color_library[$color_wise_wo_result['fabric_color_id']];

						?></td>-->
						<td  width="120" align="left">
						<?
						echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
						?>
						</td>
						<td>
						<?
						echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
						?>
						</td>
						<td  width="120" align="left">
						<?
						$lapdip_no="";
						$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
						if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
						?>
						</td>
						<?
						$total_fin_fab_qnty=0;
						$total_amount=0;

						foreach($nameArray_fabric_description as $result_fabric_description)
						{
							if($db_type==0)
							{
								$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty*d.rate) as amount,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
								FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
								WHERE a.job_no=b.job_no and
								a.id=b.pre_cost_fabric_cost_dtls_id and
								c.job_no_mst=a.job_no and
								c.id=b.color_size_table_id and
								b.po_break_down_id=d.po_break_down_id and
								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
								d.booking_no =$txt_booking_no and
								a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
								a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
								a.construction='".$result_fabric_description[csf('construction')]."' and
								a.composition='".$result_fabric_description[csf('composition')]."' and
								a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
								b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
								d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
								d.status_active=1 and
								d.is_deleted=0 ");
							}
							if($db_type==2)
							{

								if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";


								$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty*d.rate) as amount, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
								FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
								WHERE a.job_no=b.job_no and
								a.id=b.pre_cost_fabric_cost_dtls_id and
								c.job_no_mst=a.job_no and
								c.id=b.color_size_table_id and
								b.po_break_down_id=d.po_break_down_id and
								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
								d.booking_no =$txt_booking_no and
								a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
								a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
								a.construction='".$result_fabric_description[csf('construction')]."' and
								a.composition='".$result_fabric_description[csf('composition')]."' and
								$gsm_cond
								b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
								nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
								d.status_active=1 and
								d.is_deleted=0");
							}
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'>
						<?
						if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
						{
						echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
						$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						}
						?>
						</td>
						<td width='50' align='right' >
						<?
						if($color_wise_wo_result_qnty[csf('rate')]!="")
						{
							echo number_format($color_wise_wo_result_qnty[csf('amount')]/$color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
						}
						?>
						</td>
						<td width='50' align='right' >
						<?
						//$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
						$amount=$color_wise_wo_result_qnty[csf('amount')];
						if($amount!="")
						{
						echo number_format($amount,2);
						$total_amount+=$amount;
						}
						?>
						</td>
						<?
						}
						?>
						<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
						<td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
						<td align="right">
						<?
						echo number_format($total_amount,2);

						?>
						</td>
						</tr>
					 <?
					}
					?>
					<tr style=" font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Total</strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{
							if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d

															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															$gsm_cond
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
						<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
						<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
						<?
						}
						?>
						<td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
						<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
						<td align="right">
						<?
						echo number_format($grand_total_amount,2);
						?>
						</td>
						</tr>
						<tr style="font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{

							if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															$gsm_cond
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

						?>
						<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
						<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
						<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
						<?
						}
						?>
						<td align="right">
						<?
						//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
						$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
						echo number_format($consumption_per_unit_fab,4);
						//$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)
						?>
						</td>
						<td align="right">
						<?
						//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
						$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
						//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
						//$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)
						?>
						</td>
						<td align="right">
						<?
						//echo number_format($consumption_per_unit_amuont,2);
						?>
						</td>
						</tr>
				</table>
				<?
				}

			}
			?>
				<br/>
				<?

	if($cbo_fabric_source==1)
	{
		if($cbo_booking_gr_arr[3]!="")
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id,item_number_id, (plan_cut_qnty) as plan_cut_qnty, (order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 ");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']+=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']+=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id,a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				$item_id_arr[$collar_cuff_row[csf('id')]]=$collar_cuff_row[csf('item_number_id')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												$item_id=$item_id_arr[$pre_cost_id];
												?>
												<td title="<? //echo $item_id.'='.$pre_cost_id;?>" align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
		}
				?>

				<br/>
				<?
				$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
			//	$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, color,type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,color,type_id order by id");
			$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one,a.copm_two_id, a.percent_two,a.color, a.type_id, a.supplier_id, sum(a.cons_qnty) as yarn_required, AVG(a.rate) as rate from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b. pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and  a.status_active=1 and a.is_deleted=0 group by a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.color, a.type_id, a.supplier_id order by id");
				?>
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
					<tr>
						<td width="49%" valign="top">
						<?
						if($cbo_booking_gr_arr[4]!="")
						{
							?>
							<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
								</tr>
								<tr align="center">
								<td>Sl</td>
								<td>Yarn Description</td>
								<td>Brand</td>
								<td>Lot</td>
								<?
								if($show_yarn_rate==1)
								{
									?>
									<td>Rate</td>
									<?
								}
								?>
								<td>Cons for <? echo $costing_per; ?> Gmts</td>
							</tr>
							<?
							$i=0;
							$total_yarn=0;
							foreach($yarn_sql_array  as $row)
							{

								$i++;
							?>
							<tr align="center">
								<td><? echo $i; ?></td>
								<td>
								<?
								$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
								if($row['copm_two_id'] !=0)
								{
									$yarn_des.=$composition[$row[csf('copm_two_id')]]." ".$row[csf('percent_two')]."%";
								}
								$yarn_des.=$color_library[$row[csf('color')]]." ";
								$yarn_des.=$yarn_type[$row[csf('type_id')]];
								echo $yarn_des;
								?>
								</td>
								<td></td>
								<td></td>
								<?
								if($show_yarn_rate==1)
								{
								?>
								 <td><? echo number_format($row[csf('rate')],4); ?></td>
								 <?
								}
								 ?>
								<td><? echo number_format($row[csf('yarn_required')],4); ?></td>
							</tr>
							<?
							}
							?>
							<tr align="center">
								<td>Total</td>
								<td></td>
								<td></td>
								<td></td>
								<?
								if($show_yarn_rate==1)
								{
									?>
									<td></td>
									<?
								}
								?>
								<td></td>
							</tr>
							</table>
							<?
						}
						?>
						</td>
						<td width="2%">
						</td>
						<td width="49%" valign="top" align="center">
						<?
						if($cbo_booking_gr_arr[5]!="")
						{
							$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
							if(count($yarn_sql_array)>0)
							{
							?>
							   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td colspan="7"><b>Allocated Yarn</b></td>

								</tr>
								<tr align="center">
								<td>Sl</td>
								<td>Yarn Description</td>
								<td>Brand</td>
								<td>Lot</td>


								<td>Allocated Qty (Kg)</td>
								</tr>
								<?
								$total_allo=0;
								$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
								$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
								$i=0;
								$total_yarn=0;
								foreach($yarn_sql_array  as $row)
								{

									$i++;
								?>
								<tr align="center">
								<td><? echo $i; ?></td>
								<td>
								<?

								echo $item[$row[csf('item_id')]];
								?>
								</td>
								<td>
								<?

								echo $supplier[$row[csf('supplier_id')]];
								?>
								</td>
								<td>
								<?

								echo $row[csf('lot')];
								?>
								</td>
								<td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
								</tr>
								<?
								}
								?>
								<tr align="center">
								<td>Total</td>
								<td></td>


								<td></td>
								<td></td>
								<td align="right"><? echo number_format($total_allo,4); ?></td>
								</tr>
								</table>
								<?
							}
							else
							{
								$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
								if($is_yarn_allocated==1)
								{
								?>
								<font style=" font-size:30px"><b> Draft</b></font>
								<?
								}
								else
								{
									echo "";
								}
							}
						}

						?>
						</td>
					</tr>
				</table>
				<br/>

				<?

				$conversion_data=sql_select("select a.body_part_id,a.fab_nature_id, a.color_type_id,b.job_no,b.cons_process,b.fabric_description,b.charge_unit,b.color_break_down,b.amount,a.color_size_sensitive,a.id from wo_pre_cost_fab_conv_cost_dtls b,wo_pre_cost_fabric_cost_dtls a where b.job_no='$job_no'  and a.job_no=b.job_no  and a.id=b.fabric_description and b.status_active=1 and b.is_deleted=0");
				$exchange_rate=return_field_value("exchange_rate", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0 ");
			
				?>
				<!-- wo_pre_cost_fabric_cost_dtls -->
				<table  width="650"  border="0" cellpadding="0" cellspacing="0" align="left" >
					<tr>
						<td width="49%" valign="top">
							<?
							if($cbo_booking_gr_arr[6]!="")
							{
								?>
								<style type="text/css">

									hr {
										border: 0;
										background-color: #000;
										height: 1px;
									}
								</style>
								<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
									<td colspan="7"><b>Conversion Charge</b></td>

									</tr>
									<tr align="center">
									<td width="30">Sl</td>
									<td width="210">Fabric Description</td>
									<td width="50">UOM</td>
									<td width="100">Process</td>
									<td width="100">Color</td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(USD)</div></td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(Tk.)</div></td>
								</tr>
								<?
								$i=0;
								$total_amount=0;
								foreach($conversion_data  as $row)
								{

									$i++;
									 $color_break_down=explode("__",$row[csf('color_break_down')]);
									 $color_arr=$color_break_down[0];
									 $unit_charge=$color_break_down[1];

									  $fabric_nature_id=$row[csf('fab_nature_id')];

									$color='';	$color_unit_rate='';
								
									foreach($color_break_down as $color_row)
									{
										$color_data=explode("_",$color_row);
										
										if($color=='')
										{
										  $color=$color_data[0];
										}
										else
										{
											  $color.=','.$color_data[0];
										}

										if($color_unit_rate=='')
										{
										  $color_unit_rate=$color_data[1];
										}
										else
										{
											  $color_unit_rate.=','.$color_data[1];
										}

									}
							    	?>
								  <tr align="center">
									<td width="30"><? echo $i; ?></td>
									<td width="220">
									<?
											echo  $body_part[$row[csf("body_part_id")]].', '.$color_type[$row[csf("color_type_id")]].', '.$fabric_description_arr[$row[csf("fabric_description")]];
									?>

									</td>
									<td width="50"><? if( $fabric_nature_id==2) echo "Kg";else echo "Yds";?></td>
									<td width="100"><? echo $conversion_cost_head_array[$row[csf('cons_process')]]; ?></td>

								   <?

									if($row[csf('cons_process')]==31)
									{


										?>
										<td width="100">

										<div style="word-break:break-all; font-size:medium">
										<?
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											
											$data_array2=sql_select("select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='".$row[csf('fabric_description')]."'");
											$i=1;
											$h=0;
												foreach( $data_array2 as $row2 )
												{
													
													if($i==1){
														if($color_library[$row2[csf('color_number_id')]] !==""){
															
															echo $color_library[$row2[csf('color_number_id')]];
															$i++;
															
														}
											    	}else{
														echo "<hr>";
														echo $color_library[$row2[csf('color_number_id')]];
													}
												
												
											
												}
												
										}else{

											$data_array1=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on 
											e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='".$row[csf('fabric_description')]."' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");

					
											$i=1;
											foreach( $data_array1 as $row1 )
											{
												
												
												if($i==1){
														echo $color_library[$row1[csf('color_number_id')]];
														$i++;
												}else{
													echo "<hr>";
													echo $color_library[$row1[csf('color_number_id')]];
												}
												
											
											}

											


										}
										?>
										</div>
										</td>
										<?
									 }
									 else
									 { 
										 ?>

									 <td width="100">
										
									 </td>
									 <? }

									if($row[csf('cons_process')]==31)
									{
									?>

									<td width="70" title="Unit As Per">
									<div style="word-break:break-all; font-size:medium">
									<?
										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											$color_name="";	$color_m="";
											// $color_data2=count($data_color);
											$color_data2=count($data_array2);
										
											foreach($data_color_unit_rate as $val)
											{

											$color_m++;
											if($color_data2==1){
												echo number_format($val,4);break;
											}else{
												echo number_format($val,4);
											}
											if($color_data2!=$color_m)
											echo '<hr>';
											}

										}else{

											$color_name="";	$color_m="";
											// $color_data2=count($data_color);
											$color_data1=count($data_array1);
											foreach($data_color_unit_rate as $val)
											{
											$color_m++;
											if($color_data1==1){
												echo number_format($val,4);break;
											}else{
												echo number_format($val,4);
											}
											if($color_data1!=$color_m)
											echo '<hr>';
											
											}
											

										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									<? echo number_format($row[csf('charge_unit')],4); ?>
									</td>

									<? }


									if($row[csf('cons_process')]==31)
									{
									?>

									 <td width="70">
									 <div style="word-break:break-all; font-size:medium">
									<?
									
										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											$color_name="";$color_td=0;
											// $color_data=count($data_color);
											$color_data=count($data_array2);
											foreach($data_color_unit_rate as $val)
											{  $color_td++;
												
												if($color_data==1){
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;break;
												}else{
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;
												}
											if($color_data!=$color_td)
											echo '<hr>';
											
											}
										}else{

											$color_name="";$color_td=0;
											$color_data3=count($data_array1);
											foreach($data_color_unit_rate as $val)
											{  $color_td++;
												if($color_data3==1){
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;break;
												}else{
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;
												}
											if($color_data!=$color_td)
											echo '<hr>';
											
											}
										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									 <?
									 $total_amount+=$row[csf('charge_unit')]*$exchange_rate;
									  echo number_format($row[csf('charge_unit')]*$exchange_rate,4); ?>
									</td>

									<? }
									?>
								   </tr>
								   <?
								 }
							    	?>
							    	<tr align="center">


									<td colspan="6" align="right">Total</td>
									<td><? echo number_format($total_amount,4); ?></td>
							    	</tr>
								  </table>
								 <?
							}
							?>

						</td>


					</tr>
				</table>
				<br/>


				<?

				?>
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
					<tr>
						<td width="49%" valign="top">
						<?
						if($cbo_booking_gr_arr[7]!="")
						{
							$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
							if(count($sql_embelishment)>0)
							{
							?>
								<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td colspan="7"><b>Embelishment (Pre Cost)</b></td>

								</tr>
								<tr align="center">
								<td>Sl</td>
								<td>Embelishment Name</td>
								<td>Embelishment Type</td>
								<td>Cons <? echo $costing_per; ?> Gmts</td>
								<td>Rate</td>
								<td>Amount</td>

								</tr>
								<?
								$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
								$i=0;
								foreach($sql_embelishment  as $row_embelishment)
								{

									$i++;
								?>
								<tr align="center">
								<td><? echo $i; ?></td>
								<td>
								<?
								echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
								?>
								</td>
								<td>
								<?
								if($row_embelishment[csf('emb_name')]==1)
								{
								echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==2)
								{
								echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==3)
								{
								echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==4)
								{
								echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==5)
								{
								echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
								}
								?>

								</td>
								<td>
								<?
								echo $row_embelishment[csf('cons_dzn_gmts')];
								?>
								</td>
								<td>
								<?
								echo $row_embelishment[csf('rate')];
								?>
								</td>

								<td>
								<?
								echo $row_embelishment[csf('amount')];
								?>
								</td>


								</tr>
								<?
								}
								?>

								</table>
								<?
							}
						}
						?>
						</td>
						<td width="2%">
						</td>
						<td width="49%" valign="top" align="center">
						<?
						if($cbo_booking_gr_arr[8]!="")
						{
							?>
							<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td><b>Approved Instructions</b></td>
								</tr>
								<tr>
								<td>
								<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
								</td>
								</tr>
							</table>
							<?
						}
						?>
						</td>
					</tr>
				</table>
				<br/>

				<?
				}// fabric Source End

				if($cbo_fabric_source==1 || $cbo_fabric_source==2)
				{

					?>
					<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<tr>
						<td width="49%" valign="top">
						<?
						if($cbo_booking_gr_arr[9]!="")
						{
							echo get_spacial_instruction($txt_booking_no,"97%",118);
						}
						?>
						</td>
						<td width="2%">
						</td>
						<td width="49%" valign="top">
						<?
						if($cbo_booking_gr_arr[10]!="")
						{
							?>
							<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
							<tr align="center">
							<td colspan="10"><b>Comments</b></td>

							</tr>
							<tr align="center">
							<td>Sl</td>
							<td>Po NO</td>
							<td>Ship Date</td>
							<td>Pre-Cost Qty</td>
							<td>Mn.Book Qty</td>
							<td>Sht.Book Qty</td>
							<td>Smp.Book Qty</td>
							<td>Tot.Book Qty</td>
							<td>Balance</td>
							<td>Comments</td>
							</tr>
							<?
							$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
							$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
							if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
							if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
							$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

							$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
							$nameArray=sql_select("
							select
							a.id,
							a.item_number_id,
							a.costing_per,
							b.po_break_down_id,
							b.color_size_table_id,
							b.requirment,
							c.po_number
						FROM
							wo_pre_cost_fabric_cost_dtls a,
							wo_pre_cos_fab_co_avg_con_dtls b,
							wo_po_break_down c
						WHERE
							a.job_no=b.job_no and
							a.job_no=c.job_no_mst and
							a.id=b.pre_cost_fabric_cost_dtls_id and
							b.po_break_down_id=c.id and
							b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
							order by id");
							$count=0;
							$tot_grey_req_as_pre_cost_arr=array();
							foreach ($nameArray as $result)
							{
								if (count($nameArray)>0 )
								{
									if($result[csf("costing_per")]==1)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==2)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==3)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==4)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==5)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
								}
							}
							$total_pre_cost=0;
							$total_booking_qnty_main=0;
							$total_booking_qnty_short=0;
							$total_booking_qnty_sample=0;
							$total_tot_bok_qty=0;
							$tot_balance=0;

							$booking_qnty_main=return_library_array( "select a.po_break_down_id as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category in(2,3) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.po_break_down_id order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

							$booking_qnty_short=return_library_array( "select a.po_break_down_id as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category in(2,3) and a.is_short=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.po_break_down_id order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
							$booking_qnty_sample=return_library_array( "select a.po_break_down_id as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c,wo_pre_cost_fabric_cost_dtls d   where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.pre_cost_fabric_cost_dtls_id=d.id and  d.job_no= b.job_no_mst  and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category in(2,3)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.po_break_down_id order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
							$sql_data=sql_select( "select a.id as id,  a.po_number, max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.id, a.po_number order by id");
							foreach($sql_data  as $row)
							{
							$col++;
							?>
							<tr align="center">
							<td><? echo $col; ?></td>
							<td><? echo $row[csf("po_number")]; ?></td>
							 <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
							<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
							<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
							<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
							<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
							<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
							<td align="right">
							<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
							</td>
							<td>
							<?
							if( $balance>0)
							{
								echo "Less Booking";
							}
							else if ($balance<0)
							{
								echo "Over Booking";
							}
							else
							{
								echo "";
							}
							?>
							</td>
							</tr>
							<?
							}
							?>
							<tfoot>
							<tr>
							<td colspan="3">Total:</td>
							<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
							 <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
							<td align="right"><? echo number_format($tot_balance,2); ?></td>
							<td></td>
							</tr>
							</tfoot>
							</table>
							<?
						}
						?>
						</td>
					</tr>
				</table>
				<br>
				<?
				if($cbo_booking_gr_arr[11]!="")
				{
					?>
					<fieldset id="div_size_color_matrix" style="max-width:1000;">
					<legend>TNA Information</legend>
					<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
						<tr>
							<td rowspan="2" align="center" valign="top">SL</td>
							<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
							<td colspan="2" align="center" valign="top"><b>Fabric Booking</b></td>
                            <td colspan="2" align="center" valign="top"><b>Yarn Issue</b></td>
							<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
							<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
							<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
							<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
							<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
							<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
						</tr>
						<tr>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
                            <td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>

						</tr>
						<?
						$i=1;
						foreach($tna_date_task_arr as $order_id=>$row)
						{
							?>
							<tr>
								<td><? echo $i; ?></td>
								<td><? echo $po_num_arr[$order_id]; ?></td>
								<td align="center"><? echo change_date_format($row['fab_booking_start_date']); ?></td>
								<td  align="center"><? echo change_date_format($row['fab_booking_end_date']); ?></td>
                                <td align="center"><? echo change_date_format($row['yarn_issue_start_date']); ?></td>
								<td  align="center"><? echo change_date_format($row['yarn_issue_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
								<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
							</tr>
							<?
							$i++;
						}
						?>

					</table>
					</fieldset>
					<?
				}
				}
			}
			else
			{
						if($cbo_fabric_source==1 || $cbo_fabric_source==2)
						{
						 $nameArray_size=sql_select( "select distinct size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1  order by size_number_id desc");
					   ?>
						<table width="100%" >
							<tr>
								<td width="100%">
								<div id="div_size_color_matrix" style="float:left; max-width:1000;">
								<fieldset id="div_size_color_matrix" style="max-width:1000;">
								<legend>Size and Color Breakdown </legend>
								<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
									<tr>
										<td style="border:1px solid black"><strong>PO Number</strong></td>
										<td style="border:1px solid black"><strong>Ship Date</strong></td>
										<td style="border:1px solid black"><strong>Gmts Item</strong></td>
										<td style="border:1px solid black"><strong>Color/Size</strong></td>
									<?
										foreach($nameArray_size  as $result_size)
										{	     ?>
										<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
									<?	}    ?>
										<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
										<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
										<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
									</tr>
									<?
									$color_size_order_qnty_array=array();
									$color_size_qnty_array=array();
									$size_tatal=array();
									$size_tatal_order=array();
									$order_id=explode(",",str_replace("'","",$txt_order_no_id));
									for($or=0;$or<count($order_id); $or++)
									{
									for($c=0;$c<count($gmts_item); $c++)
									{
									$item_size_tatal=array();
									$item_size_tatal_order=array();
									$item_grand_total=0;
									$item_grand_total_order=0;
									$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
									?>

									<?
									foreach($nameArray_color as $result_color)
									{
									?>
									<tr>
										<td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
										 <td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
										  <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
										<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
										<?
										$color_total=0;
										$color_total_order=0;

										foreach($nameArray_size  as $result_size)
										{
										$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0 order by size_number_id");
										foreach($nameArray_color_size_qnty as $result_color_size_qnty)
										{

										?>
											<td style="border:1px solid black; text-align:right">
											<?
												if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
												{
													 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
													 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
													 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
													 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
													 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
													 $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
													 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
													 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
													 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
													 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
													 {
															$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
													 }
													 else
													 {
														$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
														$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
													 }
													 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
													 {
															$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
													 }
													 else
													 {
														$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
														$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
													 }
												}
												else echo "0";
											 ?>
											</td>

									<?
										}
										}
										?>
										<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
										 <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
										 <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
									</tr>
									<?
									}
									?>
									<tr>
									  <td align="center" style="border:1px solid black"><strong></strong></td>
									  <td align="center" style="border:1px solid black"><strong></strong></td>
									  <td align="center" style="border:1px solid black"><strong></strong></td>
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
										?>
										<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
										<?
										}
										?>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
									</tr>
									<?
									}
									}
									?>
									 <tr>
										<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
									</tr>
									<!--<tr>-->
									<tr>
									<td align="center" style="border:1px solid black"><strong></strong></td>
									<td align="center" style="border:1px solid black"><strong></strong></td>
									<td align="center" style="border:1px solid black"><strong></strong></td>
										<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
										?>
										<td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
										<?
										}
										?>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
										<td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($po_qnty_tot-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
										<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($po_qnty_tot),0); ?></td>
									</tr>
								</table>
									</fieldset>
									</div>
								</td>
							</tr>
					   </table>
						<?
						}// if($cbo_fabric_source==1) end

			  ?>
			  <br/>

			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;
			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;
			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;
			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;
			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");

			?>

			<?
				if($cbo_fabric_source==1)
				{
				$nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.status_active=1 and
				d.is_deleted=0
				group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");
				 ?>

				 <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				 <tr align="center">
				 <th colspan="3" align="left">Body Part</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
					}
					?>
					<td  rowspan="9" width="50"><p>Total  Finish Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
					<td  rowspan="9" width="50"><p>Total Grey Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
					<td  rowspan="9" width="50"><p>Process Loss % </p></td>
				   </tr>
				 <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
					}
					?>

				   </tr>
					<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
					}
					?>


				   </tr>
					<tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
						else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else         		              echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
					}
					?>

				   </tr>
				   <tr>
				   <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
				   </tr>

				   <tr>
						<th  width="120" align="left">Fabric Color</th>
						<th  width="120" align="left">Body Color</th>
						<th  width="120" align="left">Lab Dip No</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
					}
					?>

				   </tr>
				   <?
					  $gmt_color_library=array();
					  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
					  FROM
					  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
					  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
					  a.job_no ='$job_no'");
					  foreach( $gmt_color_data as $gmt_color_row)
					  {
						$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
					  }

						$grand_total_fin_fab_qnty=0;
						$grand_total_grey_fab_qnty=0;
						$grand_totalcons_per_finish=0;
						$grand_totalcons_per_grey=0;
						$color_wise_wo_sql=sql_select("select fabric_color_id
													  FROM
													  wo_booking_dtls
													  WHERE
													  booking_no =$txt_booking_no and
													  status_active=1 and
													  is_deleted=0
													  group by fabric_color_id");
					foreach($color_wise_wo_sql as $color_wise_wo_result)
					{
					?>
						<tr>

						<td  width="120" align="left">
						<?
						echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


						?>
						</td>
						<td>
						<?
						echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
						?>
						</td>
						<td  width="120" align="left">
						<?
						$order_id=str_replace("'","",$txt_order_no_id);
						$lapdip_no="";
						$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."'  and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
						if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
						?>
						</td>
						<?
						$total_fin_fab_qnty=0;
						$total_grey_fab_qnty=0;

						foreach($nameArray_fabric_description as $result_fabric_description)
						{
							if($db_type==0)
							{
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							WHERE a.job_no=b.job_no and
							a.id=b.pre_cost_fabric_cost_dtls_id and
							c.job_no_mst=a.job_no and
							c.id=b.color_size_table_id and
							b.po_break_down_id=d.po_break_down_id and
							b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
							d.booking_no =$txt_booking_no and
							a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
							a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
							a.construction='".$result_fabric_description[csf('construction')]."' and
							a.composition='".$result_fabric_description[csf('composition')]."' and
							a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
							b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
							d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
							d.status_active=1 and
							d.is_deleted=0
							");
							}
							if($db_type==2)
							{
							if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							WHERE a.job_no=b.job_no and
							a.id=b.pre_cost_fabric_cost_dtls_id and
							c.job_no_mst=a.job_no and
							c.id=b.color_size_table_id and
							b.po_break_down_id=d.po_break_down_id and
							b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
							d.booking_no =$txt_booking_no and
							a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
							a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
							a.construction='".$result_fabric_description[csf('construction')]."' and
							a.composition='".$result_fabric_description[csf('composition')]."' and
							$gsm_cond
							b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
							nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
							d.status_active=1 and
							d.is_deleted=0
							");
							}

							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'>
						<?
						if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
						{
						echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
						$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
						}
						?>
						</td>
						<td width='50' align='right' >
						<?
						if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
						{
						echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
						$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						}
						?>
						</td>
						<?
						}
						?>
						<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
						<td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

						<td align="right">
						<?
						if($process_loss_method==1)
						{
							$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
						}

						if($process_loss_method==2)
						{
							$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
						}
						echo number_format($process_percent,2);

						?>

						</td>
						</tr>
					 <?
					}
					?>
					<tr style=" font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Total</strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{
							if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															$gsm_cond
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>

						<?
						}
						?>
						<td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
						<td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
						<td align="right">
						<?
						if($process_loss_method==1)// markup
						{
							$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
						}

						if($process_loss_method==2) //margin
						{
							$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
						}
						echo number_format($totalprocess_percent,2);
						?>
						</td>
						</tr>
						<tr style="font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{

							if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															$gsm_cond
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

						?>
						<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
						<?
						}
						?>
						<td align="right"><? echo number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)?></td>
						<td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)?></td>
						<td align="right">
						<?
						if($process_loss_method==1)
						{
							$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
						}

						if($process_loss_method==2)
						{
							$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
						}
						echo number_format($totalprocess_percent_dzn,2);
						?>
						</td>
						</tr>
				</table>
				<?
				}

				if($cbo_fabric_source==2)
				{

					$nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment
					FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					d.status_active=1 and
					d.is_deleted=0
					group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");

				 ?>

				 <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				 <tr align="center">
				 <th colspan="3" align="left">Body Part</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
					}
					?>
					<td  rowspan="9" width="50"><p>Total Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
					<td  rowspan="9" width="50"><p>Avg Rate <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
					<td  rowspan="9" width="50"><p>Amount </p></td>
				   </tr>
				 <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
					}
					?>

				   </tr>
					<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
					}
					?>


				   </tr>
					<tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
					foreach($nameArray_fabric_description  as $result_fabric_description)
					{
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
					}
					?>

				   </tr>
				   <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
					}
					?>

				   </tr>
				   <tr>
				   <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
				   </tr>

				   <tr>
						<!--<th  width="120" align="left">Gmts. Color</th>-->
						<th  width="120" align="left">Fabric Color</th>
						<th  width="120" align="left">Body Color</th>
						<th  width="120" align="left">Lab Dip No</th>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
					}
					?>

				   </tr>
				   <?
					  $gmt_color_library=array();
					  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
					  FROM
					  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
					  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
					  a.job_no ='$job_no'");
					  foreach( $gmt_color_data as $gmt_color_row)
					  {
						$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
					  }

						$grand_total_fin_fab_qnty=0;
						$grand_total_amount=0;
						$color_wise_wo_sql=sql_select("select fabric_color_id, avg(rate) as dtls_rate
													  FROM
													  wo_booking_dtls
													  WHERE
													  booking_no =$txt_booking_no and
													  status_active=1 and
													  is_deleted=0
													  group by fabric_color_id");
					foreach($color_wise_wo_sql as $color_wise_wo_result)
					{
					?>
						<tr>

						<td  width="120" align="left">
						<?
						echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


						?>
						</td>
						<td>
						<?
						echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
						?>
						</td>
						<td  width="120" align="left">
						<?
						$lapdip_no="";
						$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
						if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
						?>
						</td>
						<?
						$total_fin_fab_qnty=0;
						$total_amount=0;

						foreach($nameArray_fabric_description as $result_fabric_description)
						{
							if($db_type==0)
							{
								$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
								FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
								WHERE a.job_no=b.job_no and
								a.id=b.pre_cost_fabric_cost_dtls_id and
								c.job_no_mst=a.job_no and
								c.id=b.color_size_table_id and
								b.po_break_down_id=d.po_break_down_id and
								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
								d.booking_no =$txt_booking_no and
								a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
								a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
								a.construction='".$result_fabric_description[csf('construction')]."' and
								a.composition='".$result_fabric_description[csf('composition')]."' and
								a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
								b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
								d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
								d.status_active=1 and
								d.is_deleted=0 ");
							}
							if($db_type==2)
							{
								if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
								$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
								FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
								WHERE a.job_no=b.job_no and
								a.id=b.pre_cost_fabric_cost_dtls_id and
								c.job_no_mst=a.job_no and
								c.id=b.color_size_table_id and
								b.po_break_down_id=d.po_break_down_id and
								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
								d.booking_no =$txt_booking_no and
								a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
								a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
								a.construction='".$result_fabric_description[csf('construction')]."' and
								a.composition='".$result_fabric_description[csf('composition')]."' and
								$gsm_cond
								b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
								nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
								d.status_active=1 and
								d.is_deleted=0");
							}
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'>
						<?
						if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
						{
						echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
						$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						}
						?>
						</td>
						<td width='50' align='right' >
						<?
						if($color_wise_wo_result_qnty[csf('rate')]!="")
						{
							echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
						}
						?>
						</td>
						<td width='50' align='right' >
						<?
						$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
						if($amount!="")
						{
						echo number_format($amount,2);
						$total_amount+=$amount;
						}
						?>
						</td>
						<?
						}
						?>
						<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
						<td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
						<td align="right">
						<?
						echo number_format($total_amount,2);

						?>
						</td>
						</tr>
					 <?
					}
					?>
					<tr style=" font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Total</strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{
							if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															$gsm_cond
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
						<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
						<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
						<?
						}
						?>
						<td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
						<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
						<td align="right">
						<?
						echo number_format($grand_total_amount,2);
						?>
						</td>
						</tr>
						<tr style="font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
					<?
						foreach($nameArray_fabric_description as $result_fabric_description)
						{
							if($result_fabric_description[csf('gsm_weight')]!="") $gsm_cond=" a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and "; else $gsm_cond="";
							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
															WHERE a.job_no=b.job_no and
															a.id=b.pre_cost_fabric_cost_dtls_id and
															c.job_no_mst=a.job_no and
															c.id=b.color_size_table_id and
															b.po_break_down_id=d.po_break_down_id and
															b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
															d.booking_no =$txt_booking_no and
															a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
															a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
															a.construction='".$result_fabric_description[csf('construction')]."' and
															a.composition='".$result_fabric_description[csf('composition')]."' and
															$gsm_cond
															b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
															d.status_active=1 and
															d.is_deleted=0
															");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

						?>
						<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
						<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
						<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
						<?
						}
						?>
						<td align="right">
						<?
						$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
						echo number_format($consumption_per_unit_fab,4);
						?>
						</td>
						<td align="right">
						<?
						$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
						?>
						</td>
						<td align="right">
						<?
						?>
						</td>
						</tr>
				</table>
				<?
				}

			?>
				<br/>
				<?

				if($cbo_fabric_source==1)
				{
						?>
						<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
						<tr>
						<?
						$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
						if(count($nameArray_item_size)>0)
						{
						?>
						<td width="49%">
						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
						<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
						</tr>
						<tr>
						<td width="70">Size</td>

						<?

						foreach($nameArray_item_size  as $result_size)
						{
						?>
						<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
						<?
						}
						?>
						<td rowspan="2" align="center"><strong>Total</strong></td>
						<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
						<tr>
						<td>Collar Size</td>

						<?
						foreach($nameArray_item_size  as $result_item_size)
						{
						?>
						<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
						<?
						}
						?>
						 <?

							$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
				");
						foreach($color_wise_wo_sql as $color_wise_wo_result)
						{
							$color_total_collar=0;
							$color_total_collar_order_qnty=0;
							$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
							$constrast_color_arr=array();
							if($color_wise_wo_result[csf("color_size_sensitive")]==3)
							{
								$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
								for($i=0;$i<count($constrast_color);$i++)
								{
									$constrast_color2=explode('_',$constrast_color[$i]);
									$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
								}
							}
						?>
							<tr>
							<td>
							<?
							if($color_wise_wo_result[csf("color_size_sensitive")]==3)
							{
								echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
								$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
							}
							else
							{
								echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
								$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
							}
							?>

							</td>
							<?
							foreach($nameArray_item_size  as $result_size)
							{
								?>
								<td align="center" style="border:1px solid black">
								<?
								$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

								list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
								$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
								$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
								echo number_format($plan_cut+$colar_excess_per,0);
								$color_total_collar+=$plan_cut+$colar_excess_per;
								$color_total_collar_order_qnty+=$plan_cut;
								$grand_total_collar+=$plan_cut+$colar_excess_per;
								$grand_total_collar_order_qnty+=$plan_cut;
								?>
								</td>
								<?
							}
							?>

							<td align="center"><? echo number_format($color_total_collar,0); ?></td>
							<td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
							</tr>
							<?
							}
							?>
							<tr>
								<td>Size Total</td>

								<?
								foreach($nameArray_item_size  as $result_size)
								{
								?>
								<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
								<?
								}
								?>
								<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
								<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
							</tr>
						</table>
						</td>
						<td width="2%">
						</td>
						<?
						}
						?>

						<?
						$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

						if(count($nameArray_item_size)>0)
						{
						?>
						<td width="49%">

						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
						<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
						</tr>
						<tr>
						<td width="70">Size</td>

						<?
						foreach($nameArray_item_size  as $result_size)
						{
						?>
						<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
						<?
						}
						?>
						<td rowspan="2" align="center"><strong>Total</strong></td>
						<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
						<tr>
						<td>Cuff Size</td>

						<?
						foreach($nameArray_item_size  as $result_item_size)
						{
						?>
						<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
						<?
						}
						?>
						 <?

							$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
				");
						foreach($color_wise_wo_sql as $color_wise_wo_result)
						{
							$color_total_cuff=0;
							$color_total_cuff_order_qnty=0;
							$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
							$constrast_color_arr=array();
							if($color_wise_wo_result[csf("color_size_sensitive")]==3)
							{
								$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
								for($i=0;$i<count($constrast_color);$i++)
								{
									$constrast_color2=explode('_',$constrast_color[$i]);
									$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
								}
							}
						?>
							<tr>
							<td>
							<?
							if($color_wise_wo_result[csf("color_size_sensitive")]==3)
							{
								echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
								$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
							}
							else
							{
								echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
								$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
							}
							?>

							</td>
							<?
							foreach($nameArray_item_size  as $result_size)
							{
								?>
								<td align="center" style="border:1px solid black">

								<?
								$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

								list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
								$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
								$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
								echo number_format($plan_cut*2+$cuff_excess_per,0);
								$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
								$color_total_cuff_order_qnty+=$plan_cut*2;
								$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
								$grand_total_cuff_order_qnty+=$plan_cut*2;
								?>

								</td>
								<?
							}
							?>

							<td align="center"><? echo number_format($color_total_cuff,0); ?></td>
							<td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
							</tr>
							<?
							}
							?>
							<tr>
								<td>Size Total</td>

								<?
								foreach($nameArray_item_size  as $result_size)
								{

								?>
								<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
								<?
								}
								?>
								<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
								<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
							</tr>
						</table>
						</td>
						<?
								}
						?>
						</tr>
						</table>

				<br/>
				<?
				$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
				//$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, color,type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,color,type_id order by id");
				$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one,a.copm_two_id, a.percent_two,a.color, a.type_id, a.supplier_id, sum(a.cons_qnty) as yarn_required, AVG(a.rate) as rate from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b. pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and  a.status_active=1 and a.is_deleted=0 group by a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.color, a.type_id, a.supplier_id order by id");
				?>
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
					<tr>
						<td width="49%" valign="top">
							<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
								</tr>
								<tr align="center">
								<td>Sl</td>
								<td>Yarn Description</td>
								<td>Brand</td>
								<td>Lot</td>
								<?
								if($show_yarn_rate==1)
								{
									?>
									<td>Rate</td>
									<?
								}
								?>
								<td>Cons for <? echo $costing_per; ?> Gmts</td>
							</tr>
							<?
							$i=0;
							$total_yarn=0;
							foreach($yarn_sql_array  as $row)
							{

								$i++;
							?>
							<tr align="center">
								<td><? echo $i; ?></td>
								<td>
								<?
								$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
								if($row['copm_two_id'] !=0)
								{
									$yarn_des.=$composition[$row[csf('copm_two_id')]]." ".$row[csf('percent_two')]."%";
								}
								$yarn_des.=$color_library[$row[csf('color')]]." ";
								$yarn_des.=$yarn_type[$row[csf('type_id')]];
								echo $yarn_des;
								?>
								</td>
								<td></td>
								<td></td>
								<?
								if($show_yarn_rate==1)
								{
								?>
								 <td><? echo number_format($row[csf('rate')],4); ?></td>
								 <?
								}
								 ?>
								<td><? echo number_format($row[csf('yarn_required')],4); ?></td>
							</tr>
							<?
							}
							?>
							<tr align="center">
								<td>Total</td>
								<td></td>
								<td></td>
								<td></td>
								<?
								if($show_yarn_rate==1)
								{
									?>
									<td></td>
									<?
								}
								?>
								<td></td>
							</tr>
							</table>
						</td>
						<td width="2%">
						</td>
						<td width="49%" valign="top" align="center">
						<?
							$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
							if(count($yarn_sql_array)>0)
							{
							?>
							   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td colspan="7"><b>Allocated Yarn</b></td>

								</tr>
								<tr align="center">
								<td>Sl</td>
								<td>Yarn Description</td>
								<td>Brand</td>
								<td>Lot</td>


								<td>Allocated Qty (Kg)</td>
								</tr>
								<?
								$total_allo=0;
								$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
								$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
								$i=0;
								$total_yarn=0;
								foreach($yarn_sql_array  as $row)
								{

									$i++;
								?>
								<tr align="center">
								<td><? echo $i; ?></td>
								<td>
								<?

								echo $item[$row[csf('item_id')]];
								?>
								</td>
								<td>
								<?

								echo $supplier[$row[csf('supplier_id')]];
								?>
								</td>
								<td>
								<?

								echo $row[csf('lot')];
								?>
								</td>
								<td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
								</tr>
								<?
								}
								?>
								<tr align="center">
								<td>Total</td>
								<td></td>


								<td></td>
								<td></td>
								<td align="right"><? echo number_format($total_allo,4); ?></td>
								</tr>
								</table>
								<?
							}
							else
							{
								$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
								if($is_yarn_allocated==1)
								{
								?>
								<font style=" font-size:30px"><b> Draft</b></font>
								<?
								}
								else
								{
									echo "";
								}
							}
						?>
						</td>
					</tr>
				</table>
				<br/>

				<?

				$conversion_data=sql_select("select a.body_part_id,a.fab_nature_id, a.color_type_id,b.job_no,b.cons_process,b.fabric_description,b.charge_unit,b.color_break_down,b.amount from wo_pre_cost_fab_conv_cost_dtls b,wo_pre_cost_fabric_cost_dtls a where b.job_no='$job_no'  and a.job_no=b.job_no  and a.id=b.fabric_description and b.status_active=1 and b.is_deleted=0");
				$exchange_rate=return_field_value("exchange_rate", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0 ");
				?>
				<table  width="650"  border="0" cellpadding="0" cellspacing="0" align="left" >
					<tr>
						<td width="49%" valign="top">
								<style type="text/css">

									hr {
										border: 0;
										background-color: #000;
										height: 1px;
									}
								</style>
								<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
									<td colspan="7"><b>Conversion Charge</b></td>

									</tr>
									<tr align="center">
									<td width="30">Sl</td>
									<td width="210">Fabric Description</td>
									<td width="50">UOM</td>
									<td width="100">Process</td>
									<td width="100">Color</td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(USD)</div></td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(Tk.)</div></td>
								</tr>
								<?
								$i=0;
								$total_amount=0;
								foreach($conversion_data  as $row)
								{

									$i++;
									 $color_break_down=explode("__",$row[csf('color_break_down')]);
									 $color_arr=$color_break_down[0];
									 $unit_charge=$color_break_down[1];
									$fabric_nature_id=$row[csf('fab_nature_id')];
									$color='';	$color_unit_rate='';
									foreach($color_break_down as $color_row)
									{
										$color_data=explode("_",$color_row);
										if($color=='')
										{
										  $color=$color_data[0];
										}
										else
										{
											  $color.=','.$color_data[0];
										}

										if($color_unit_rate=='')
										{
										  $color_unit_rate=$color_data[1];
										}
										else
										{
											  $color_unit_rate.=','.$color_data[1];
										}

										//$color_id=rtrim(explode(",",$color));

									}

								?>
								<tr align="center">
									<td width="30"><? echo $i; ?></td>
									<td width="220">

									<?



									echo  $body_part[$row[csf("body_part_id")]].', '.$color_type[$row[csf("color_type_id")]].', '.$fabric_description_arr[$row[csf("fabric_description")]];
									?>

									</td>
									<td width="50"><? if( $fabric_nature_id==2) echo "Kg";else echo "Yds"; ?></td>
									<td width="100"><? echo $conversion_cost_head_array[$row[csf('cons_process')]]; ?></td>

								   <?
									if($row[csf('cons_process')]==31)
									{
									?>
									 <td width="100">

									  <div style="word-break:break-all; font-size:medium">
									<?
										$color_name="";$color_k=0;
										$data_color=explode(",",$color);
										$color_data1=count($data_color);
										foreach($data_color as $val)
										{ $color_k++;
											echo $color_library[$val];
										   if($color_data1!=$color_k)
										   echo '<hr>';

										}
									?>
									</div>
									 </td>
									 <?
									 }
									 else
									 { ?>

									 <td width="100">


									 </td>
									 <? }

									if($row[csf('cons_process')]==31)
									{
									?>

									<td width="70" title="Unit As Per">
									<div style="word-break:break-all; font-size:medium">
									<?
										$color_name="";	$color_m="";

										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										$color_data2=count($data_color);
										foreach($data_color_unit_rate as $val)
										{ $color_m++;

												 echo number_format($val,4);

										   if($color_data2!=$color_m)
										   echo '<hr>';
										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									<? echo number_format($row[csf('charge_unit')],4); ?>
									</td>

									<? }


									if($row[csf('cons_process')]==31)
									{
									?>

									 <td width="70">
									 <div style="word-break:break-all; font-size:medium">
									<?
										$color_name="";$color_td=0;
										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										$color_data=count($data_color);
										foreach($data_color_unit_rate as $val)
										{ $color_td++;
											 echo number_format($val*$exchange_rate,4);
											 $total_amount+=$val*$exchange_rate;
										   if($color_data!=$color_td)
										   echo '<hr>';
										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									 <?
									 $total_amount+=$row[csf('charge_unit')]*$exchange_rate;
									  echo number_format($row[csf('charge_unit')]*$exchange_rate,4); ?>
									</td>

									<? }
									?>
								</tr>
								<?
								}
								?>
								<tr align="center">


									<td colspan="6" align="right">Total</td>
									<td><? echo number_format($total_amount,4); ?></td>
								</tr>
								</table>

						</td>


					</tr>
				</table>
				<br/>
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
					<tr>
						<td width="49%" valign="top">
						<?
							$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
							if(count($sql_embelishment)>0)
							{
							?>
								<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td colspan="7"><b>Embelishment (Pre Cost)</b></td>

								</tr>
								<tr align="center">
								<td>Sl</td>
								<td>Embelishment Name</td>
								<td>Embelishment Type</td>
								<td>Cons <? echo $costing_per; ?> Gmts</td>
								<td>Rate</td>
								<td>Amount</td>

								</tr>
								<?
								$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
								$i=0;
								foreach($sql_embelishment  as $row_embelishment)
								{

									$i++;
								?>
								<tr align="center">
								<td><? echo $i; ?></td>
								<td>
								<?
								echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
								?>
								</td>
								<td>
								<?
								if($row_embelishment[csf('emb_name')]==1)
								{
								echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==2)
								{
								echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==3)
								{
								echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==4)
								{
								echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
								}
								if($row_embelishment[csf('emb_name')]==5)
								{
								echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
								}
								?>

								</td>
								<td>
								<?
								echo $row_embelishment[csf('cons_dzn_gmts')];
								?>
								</td>
								<td>
								<?
								echo $row_embelishment[csf('rate')];
								?>
								</td>

								<td>
								<?
								echo $row_embelishment[csf('amount')];
								?>
								</td>


								</tr>
								<?
								}
								?>
								</table>
								<?
							}
						?>
						</td>
						<td width="2%">
						</td>
						<td width="49%" valign="top" align="center">
							<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
								<td><b>Approved Instructions</b></td>
								</tr>
								<tr>
								<td>
								<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
								</td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
				<br/>

				<?
				}// fabric Source End

				if($cbo_fabric_source==1 || $cbo_fabric_source==2)
				{

					?>
					<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<tr>
						<td width="49%" valign="top">
                            <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
						</td>
						<td width="2%">
						</td>
						<td width="49%" valign="top">
						<?

							?>
							<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
							<tr align="center">
							<td colspan="10"><b>Comments</b></td>

							</tr>
							<tr align="center">
							<td>Sl</td>
							<td>Po NO</td>
							<td>Ship Date</td>
							<td>Pre-Cost Qty</td>
							<td>Mn.Book Qty</td>
							<td>Sht.Book Qty</td>
							<td>Smp.Book Qty</td>
							<td>Tot.Book Qty</td>
							<td>Balance</td>
							<td>Comments</td>
							</tr>
							<?
							$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
							$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
							if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
							if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
							$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
							$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");

							$nameArray=sql_select("
							select
							a.id,
							a.item_number_id,
							a.costing_per,
							b.po_break_down_id,
							b.color_size_table_id,
							b.requirment,
							c.po_number
						FROM
							wo_pre_cost_fabric_cost_dtls a,
							wo_pre_cos_fab_co_avg_con_dtls b,
							wo_po_break_down c
						WHERE
							a.job_no=b.job_no and
							a.job_no=c.job_no_mst and
							a.id=b.pre_cost_fabric_cost_dtls_id and
							b.po_break_down_id=c.id and
							b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
							order by id");
							$count=0;
							$tot_grey_req_as_pre_cost_arr=array();
							foreach ($nameArray as $result)
							{
								if (count($nameArray)>0 )
								{
									if($result[csf("costing_per")]==1)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==2)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==3)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==4)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									if($result[csf("costing_per")]==5)
									{
										$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
									}
									$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
								}
							}
							$total_pre_cost=0;
							$total_booking_qnty_main=0;
							$total_booking_qnty_short=0;
							$total_booking_qnty_sample=0;
							$total_tot_bok_qty=0;
							$tot_balance=0;

							$booking_qnty_main=return_library_array( "select a.po_break_down_id as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category in(2,3) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.po_break_down_id order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

							$booking_qnty_short=return_library_array( "select a.po_break_down_id as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category in(2,3) and a.is_short=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.po_break_down_id order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
							$booking_qnty_sample=return_library_array( "select a.po_break_down_id as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c,wo_pre_cost_fabric_cost_dtls d   where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.pre_cost_fabric_cost_dtls_id=d.id and  d.job_no= b.job_no_mst  and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category in(2,3)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.po_break_down_id order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
							$sql_data=sql_select( "select a.id as id,  a.po_number, max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.id, a.po_number order by id");
							foreach($sql_data  as $row)
							{
							$col++;
							?>
							<tr align="center">
							<td><? echo $col; ?></td>
							<td><? echo $row[csf("po_number")]; ?></td>
							 <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
							<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
							<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
							<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
							<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
							<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
							<td align="right">
							<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
							</td>
							<td>
							<?
							if( $balance>0)
							{
								echo "Less Booking";
							}
							else if ($balance<0)
							{
								echo "Over Booking";
							}
							else
							{
								echo "";
							}
							?>
							</td>
							</tr>
							<?
							}
							?>
							<tfoot>
							<tr>
							<td colspan="3">Total:</td>
							<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
							 <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
							<td align="right"><? echo number_format($tot_balance,2); ?></td>
							<td></td>
							</tr>
							</tfoot>
							</table>
						</td>
					</tr>
				</table>
				<br>
					<fieldset id="div_size_color_matrix" style="max-width:1000;">
					<legend>TNA Information</legend>
					<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
						<tr>
							<td rowspan="2" align="center" valign="top">SL</td>
							<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
							<td colspan="2" align="center" valign="top"><b>Fabric Booking</b></td>
                            <td colspan="2" align="center" valign="top"><b>Yarn Issue</b></td>
							<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
							<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
							<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
							<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
							<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
							<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
						</tr>
						<tr>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
                            <td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>
							<td width="70" align="center" valign="top"><b>Start Date</b></td>
							<td width="70" align="center" valign="top"><b>End Date</b></td>

						</tr>
						<?
						$i=1;
						foreach($tna_date_task_arr as $order_id=>$row)
						{
							?>
							<tr>
								<td><? echo $i; ?></td>
								<td><? echo $po_num_arr[$order_id]; ?></td>
								<td align="center"><? echo change_date_format($row['fab_booking_start_date']); ?></td>
								<td  align="center"><? echo change_date_format($row['fab_booking_end_date']); ?></td>
                                <td align="center"><? echo change_date_format($row['yarn_issue_start_date']); ?></td>
								<td  align="center"><? echo change_date_format($row['yarn_issue_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
								<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
								<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
								<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
							</tr>
							<?
							$i++;
						}
						?>

					</table>
					</fieldset>
					<?
				}
			}

		?>
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>

       </div>

    <script type="text/javascript" src="../../js/jquery.js"></script>
    <script type="text/javascript" src="../../js/jquerybarcode.js"></script>
    <script>
		fnc_generate_Barcode('<? echo $varcode_booking_no; ?>','barcode_img_id');
	</script>
       <?
	   
	   
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
	
		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_akh")
{

	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut) as po_tot_qnty", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")","po_tot_qnty");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path == "") {
	$path = '../../';
}

ob_start();

?>
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='50px' width='70px' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" width="280px" style="font-size:20px;">
							<?
                            echo $company_library[$cbo_company_name];
                            ?>
                            </td>
                            <td align="left" width="120px" style="font-size:20px;">
							<?
							if(str_replace("'","",$id_approved_id) ==1)
							{
								$approved_date=$nameArray_approved_date_row[csf('approved_date')];
								$approved_date=explode(" ",$approved_date);
								$approveddate= $approved_date[0];
								$approved_time= $approved_date[1];
								$ampm_time= $approved_date[2];
								echo 'Approved Date: &nbsp;'.change_date_format($approveddate).', '.$approved_time.' '.$ampm_time;
							}
							 ?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" width="280px" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1) { echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                             <td rowspan="2" width="120" style=" font-size:xx-large">
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <strong> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></strong>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                  </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;

				$booking_po_id=str_replace("'","",$txt_order_no_id);
				if($db_type==0)
				{
					$nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,group_concat(c.po_number) as po_number_all,MIN(c.pub_shipment_date) as pub_shipment_date, group_concat(DATEDIFF(c.pub_shipment_date,c.po_received_date)) as  date_diff, MIN(c.pub_shipment_date) as  pub_shipment_date, MIN(c.insert_date) as po_insert_date,group_concat(c.shiping_status) as shiping_status, sum(c.po_quantity*b.total_set_qnty) as po_qnty_pce,sum(c.plan_cut*b.total_set_qnty) as plan_cut
				from wo_booking_mst a, wo_po_details_master b, wo_po_break_down c

				where  a.job_no=b.job_no and b.job_no=c.job_no_mst and a.booking_no=$txt_booking_no and c.id in($booking_po_id)
				group by a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant ");
				}
				else
				{
					$nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date, a.fabric_composition,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant, LISTAGG(cast(c.po_number as varchar2(4000)), ',') WITHIN GROUP (ORDER BY c.po_number) as po_number_all, LISTAGG(cast(c.pub_shipment_date as varchar2(4000)), ',') WITHIN GROUP (ORDER BY c.pub_shipment_date)  as pub_shipment_date, LISTAGG(cast((c.pub_shipment_date-c.po_received_date) as varchar2(4000)), ',') WITHIN GROUP (ORDER BY c.pub_shipment_date,c.po_received_date) as  date_diff, MIN(c.pub_shipment_date) as  pub_shipment_date, MIN(c.insert_date) as po_insert_date, LISTAGG(cast(c.shiping_status as varchar2(4000)), ',') WITHIN GROUP (ORDER BY c.shiping_status) as shiping_status, sum(c.po_quantity*b.total_set_qnty) as po_qnty_pce,sum(c.plan_cut*b.total_set_qnty) as plan_cut
				from wo_booking_mst a, wo_po_details_master b, wo_po_break_down c
				where  a.job_no=b.job_no and b.job_no=c.job_no_mst and a.booking_no=$txt_booking_no and c.id in($booking_po_id)
				group by a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date, a.fabric_composition,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant ");
				}




				$po_plancut_sql=sql_select("select sum(order_quantity) as order_quantity,sum(plan_cut_qnty) as plan_cut_qnty
				from wo_po_color_size_breakdown where po_break_down_id in($booking_po_id) and status_active=1 and is_deleted=0");

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
				listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.style_description,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in ($booking_po_id) and a.job_no=b.job_no_mst group by a.job_no,a.style_description,a.company_name,a.buyer_name");

				$tna_start_date="";
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$season_name=$season_name_arr[$result[csf('season')]];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
					$cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
				?>
            <table width="1330" style="border:1px solid black" >
                <tr>
                	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
                </tr>
                <tr>
                    <td width="150"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                    <td width="300">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                    <td style="font-size:18px" width="150"><b>Style Ref.</b>   </td>
                    <td style="font-size:18px" width="300">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
                    <td width="150"><span style="font-size:18px"><b>Order Qnty</b></span></td>
                    <td style="font-size:18px">:&nbsp;<b><?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]];
					//echo number_format($result[csf('po_qnty_pce')],0)." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?></b></td>
                </tr>
                <tr>
                    <td  style="font-size:12px"><b>Garments Item</b></td>
                    <td>:&nbsp;
                    <?
                    $gmts_item_name="";
                    $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                    for($g=0;$g<=count($gmts_item); $g++)
                    {
                    $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                    }
                    echo rtrim($gmts_item_name,',');
                    ?>
                    </td>
                    <td  style="font-size:12px"><b>Booking Release Date</b></td>
                    <td >:&nbsp;
                    <?
                    $booking_date=$result[csf('update_date')];
                    if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                    {
                    	$booking_date=$result[csf('insert_date')];
                    }
                    echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                    ?>&nbsp;</td>
                    <td style="font-size:12px"><b>Dealing Merchant</b></td>
                    <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
                </tr>
                <tr>
                    <td style="font-size:18px"><b>Dept.</b></td>
                    <td style="font-size:18px">:&nbsp;<b><? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></b></td>
                    <td style="font-size:12px"><b>Delivery Date</b></td>
                    <td >:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                    <td style="font-size:12px"><b>Shipment Date</b></td>
                    <td >:&nbsp;<? echo change_date_format( $result[csf('pub_shipment_date')],'dd-mm-yyyy','-');?></td>
                </tr>
                <tr>
                    <td style="font-size:18px"><b>Order No</b></td>
                    <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('po_number_all')];//echo rtrim($season_name,", "); ?></b></td>
                      <td style="font-size:18px"><b>Season</b></td><td>:&nbsp;<b> <? echo $season_name; ?></b></td>
                    <td style="font-size:12px"><b>Job No</b></td>
                    <td >:&nbsp;<? echo $result[csf('job_no')];?></td>
                </tr>
                <tr>
                    <td style="font-size:18px"><b>Internal Ref No</b></td>
                    <td style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>
                    <td style="font-size:18px"><b>File no</b></td>
                    <td style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
                    <td style="font-size:18px"><b>Booking No </b>   </td>
                    <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
                </tr>
                <tr>
                    <td style="font-size:18px"><b>Fab. Composition</b></td>
                    <td style="font-size:18px"> :&nbsp;<b><? echo $result[csf('fabric_composition')]; ?></b></td>
                     <td style="font-size:18px"><b>Style Description</b></td>
                    <td style="font-size:18px"> :&nbsp;<b><? echo $data_array3[0][csf("style_description")]; ?></b></td>
                    <td style="font-size:18px"><b>Booking Date</b></td>
                    <td style="font-size:18px"> :&nbsp;<b><? echo change_date_format($result[csf("booking_date")]); ?></b></td>

                </tr>

            </table>
            <?
			}

			if($cbo_fabric_source==1 || $cbo_fabric_source==2)
			{
				$nameArray_size=sql_select( "select distinct size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1  order by size_number_id desc");
				$color_size_order_qnty_array=array();
				$color_size_qnty_array=array();
				$size_tatal=array();
				$size_tatal_order=array();
				$order_id=explode(",",str_replace("'","",$txt_order_no_id));
				for($or=0;$or<count($order_id); $or++)
				{
					for($c=0;$c<count($gmts_item); $c++)
					{
						$item_size_tatal=array();
						$item_size_tatal_order=array();
						$item_grand_total=0;
						$item_grand_total_order=0;
						$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
						foreach($nameArray_color as $result_color)
						{
							$color_total=0;
							$color_total_order=0;

							foreach($nameArray_size  as $result_size)
							{
								$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0 order by size_number_id");
								foreach($nameArray_color_size_qnty as $result_color_size_qnty)
								{
									if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
									{
										$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
										$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
										$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
										$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
										$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
										$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
										if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
										{
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
										}
										else
										{
											$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
										}
										if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
										{
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
										}
										else
										{
											$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
										}
									}
								}
							}
						}
					}
				}

			}// if($cbo_fabric_source==1) end
	  ?>
      <br/>
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='".$txt_job_no."'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$txt_job_no'");

	 ?>

     <?
if($cbo_fabric_source==1)
{
$nameArray_fabric_description= sql_select("select  min(a.id) as id,min(a.body_part_type) as body_part_type, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type,min(b.item_size) as item_size, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment
FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and
d.status_active=1 and
d.is_deleted=0
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by id");
//body_part_type
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="9" width="50"><p>Total Grey Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="9" width="50"><p>Total  Finish Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="9" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else   echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Machine Dia*GG</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$bpart_type=$result_fabric_description[csf('body_part_type')];
			if($bpart_type==40 || $bpart_type==50 )
			{
				$mc_item_size="";
			}
			else
			{
				$mc_item_size=$result_fabric_description[csf('item_size')];
			}
			if( $result_fabric_description[csf('item_size')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$mc_item_size."</td>";
		}
		?>

       </tr>
       
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Grey</th><th width='50'>Finish</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$txt_job_no' and a.status_active=1 and b.status_active=1");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }
	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td width="120" align="left">
			<?
			$order_id=str_replace("'","",$txt_order_no_id);
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$txt_job_no."'  and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
				d.status_active=1 and
				d.is_deleted=0  and
				c.status_active=1 and
				c.is_deleted=0 ");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0 and
				c.status_active=1 and
				c.is_deleted=0 ");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
				?>

				<td width='50' align='right' >
				<?
				if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
				{
					echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0);
					$total_grey_fab_qnty+=number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0,'','');
				}
				?>
				</td>
				<td width='50' align='right'>
				<?
				if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
				{
					echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],0) ;
					$total_fin_fab_qnty+=number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],0,'','') ;
				}
				?>
				</td>
				<?
			}
			?>
            <td align="right"><? echo number_format($total_grey_fab_qnty,0); $grand_total_grey_fab_qnty+=number_format($total_grey_fab_qnty,0,'','');?></td>
            <td align="right">
			<?
			echo number_format($total_fin_fab_qnty,0); $grand_total_fin_fab_qnty+=number_format($total_fin_fab_qnty,0,'','');
			?>
            </td>

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,0);

			?>
            </td>
            </tr>
         <?

		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0  and
												c.status_active=1 and
												c.is_deleted=0  ");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0);?></td>
            <td width='50' align='right'><? echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],0) ;?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,0);?></td>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,0);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0  and
												c.status_active=1 and
												c.is_deleted=0 ");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			//echo $grand_total_grey_fab_qnty;
			echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)
			?>
            </td>
            <td align="right">
			<?
			echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			?>
            </td>
            </tr>
    </table>
    <?
	}

	if($cbo_fabric_source==2)
	{
	$nameArray_fabric_description= sql_select("select min(a.id) as id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,min(b.item_size) as item_size, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment
	FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width
	order by id");
		 ?>

		 <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
		 <tr align="center">
		 <th colspan="3" align="left">Body Part</th>
			<?
			foreach($nameArray_fabric_description  as $result_fabric_description)
			{
				if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
			}
			?>
			<td  rowspan="9" width="50"><p>Total Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
			<td  rowspan="9" width="50"><p>Avg Rate <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
			<td  rowspan="9" width="50"><p>Amount </p></td>
		   </tr>
		 <tr align="center"><th colspan="3" align="left">Color Type</th>
			<?
			foreach($nameArray_fabric_description  as $result_fabric_description)
			{
				if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
			}
			?>

		   </tr>
			<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
			<?
			foreach($nameArray_fabric_description  as $result_fabric_description)
			{
				if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
			}
			?>


		   </tr>
			<tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
			<?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
				else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
			}
			?>

		   </tr>
		   <tr align="center"><th  colspan="3" align="left">GSM</th>
			<?
			foreach($nameArray_fabric_description  as $result_fabric_description)
			{
				if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
			}
			?>

		   </tr>
		   <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
			<?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
			}
			?>

		   </tr>
            <tr align="center"><th   colspan="3" align="left">Machine Dia*GG</th>
			<?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				if( $result_fabric_description[csf('item_size')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else  echo "<td colspan='3' align='center'>".$result_fabric_description[csf('item_size')]."</td>";
			}
			?>

		   </tr>
		   <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
			<?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
			}
			?>

		   </tr>
		   <tr>
		   <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
		   </tr>

		   <tr>
				<th  width="120" align="left">Fabric Color</th>
				<th  width="120" align="left">Body Color</th>
				<th  width="120" align="left">Lab Dip No</th>
			<?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
			?>

		   </tr>
		   <?
			  $gmt_color_library=array();
			  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
			  FROM
			  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
			  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
			  a.job_no ='$txt_job_no'");
			  foreach( $gmt_color_data as $gmt_color_row)
			  {
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
			  }

				$grand_total_fin_fab_qnty=0;
				$grand_total_amount=0;
				$color_wise_wo_sql=sql_select("select fabric_color_id
											  FROM
											  wo_booking_dtls
											  WHERE
											  booking_no =$txt_booking_no and
											  status_active=1 and
											  is_deleted=0
											  group by fabric_color_id");
			foreach($color_wise_wo_sql as $color_wise_wo_result)
			{
			?>
				<tr>
				<td  width="120" align="left">
				<?
				echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


				?>
				</td>
				<td>
				<?
				echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				?>
				</td>
				<td  width="120" align="left">
				<?
				$lapdip_no="";
				$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$txt_job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
				if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
				?>
				</td>
				<?
				$total_fin_fab_qnty=0;
				$total_amount=0;

				foreach($nameArray_fabric_description as $result_fabric_description)
				{
					if($db_type==0)
					{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
					d.status_active=1 and
					d.is_deleted=0  and
					c.status_active=1 and
					c.is_deleted=0 ");
					}
					if($db_type==2)
					{

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0 and
					c.status_active=1 and
					c.is_deleted=0 ");
					}
					list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
				?>
				<td width='50' align='right'>
				<?
				if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
				{
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;
				$total_fin_fab_qnty+=number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0,'.','');
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				if($color_wise_wo_result_qnty[csf('rate')]!="")
				{
				echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
				if($amount!="")
				{
				echo number_format($amount,0);
				$total_amount+=$amount;
				}
				?>
				</td>
				<?
				}
				?>
				<td align="right"><? echo number_format($total_fin_fab_qnty,0); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
				<td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
				<td align="right">
				<?
				echo number_format($total_amount,0);

				?>
				</td>
				</tr>
			 <?
			}
			?>
			<tr style=" font-weight:bold">
			<th  width="120" align="left">&nbsp;</th>
			<td  width="120" align="left">&nbsp;</td>
			<td  width="120" align="left"><strong>Total</strong></td>
			<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
													WHERE a.job_no=b.job_no and
													a.id=b.pre_cost_fabric_cost_dtls_id and
													c.job_no_mst=a.job_no and
													c.id=b.color_size_table_id and
													b.po_break_down_id=d.po_break_down_id and
													b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
													d.booking_no =$txt_booking_no and
													a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
													a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
													a.construction='".$result_fabric_description[csf('construction')]."' and
													a.composition='".$result_fabric_description[csf('composition')]."' and
													a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
													b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
													d.status_active=1 and
													d.is_deleted=0  and
													c.status_active=1 and
													c.is_deleted=0  ");
					list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
				?>
				<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
				<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
				<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
				<?
				}
				?>
				<td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
				<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
				<td align="right">
				<?
				echo number_format($grand_total_amount,2);
				?>
				</td>
				</tr>
				<tr style="font-weight:bold">
			<!--<td  width="120" align="left">&nbsp;</td>-->
			<th  width="120" align="left">&nbsp;</th>
			<td  width="120" align="left">&nbsp;</td>
			<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
			<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
													WHERE a.job_no=b.job_no and
													a.id=b.pre_cost_fabric_cost_dtls_id and
													c.job_no_mst=a.job_no and
													c.id=b.color_size_table_id and
													b.po_break_down_id=d.po_break_down_id and
													b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
													d.booking_no =$txt_booking_no and
													a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
													a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
													a.construction='".$result_fabric_description[csf('construction')]."' and
													a.composition='".$result_fabric_description[csf('composition')]."' and
													a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
													b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
													d.status_active=1 and
													d.is_deleted=0  and
													c.status_active=1 and
													c.is_deleted=0  ");
					list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

				?>
				<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
				<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
				<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
				<?
				}
				?>
				<td align="right">
				<?
				$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot1)*($total_set_qnty*$costing_per_qnty);
				echo number_format($consumption_per_unit_fab,4);
				?>
				</td>
				<td align="right">
				<?
				$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot1)*($total_set_qnty*$costing_per_qnty);
				?>
				</td>
				<td align="right">
				<?
				//echo number_format($consumption_per_unit_amuont,2);
				?>
				</td>
				</tr>
		</table>
		<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$txt_job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity,item_number_id  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id,item_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type,c.item_number_id
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]['color_break_down']=$collar_cuff_row[csf('color_break_down')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]['item_number_id']=$collar_cuff_row[csf('item_number_id')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$item_number_id=$color_break_down['item_number_id'];
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down['color_break_down']);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$item_number_id][$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$item_number_id][$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$item_number_id][$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

		$cons_arr=array();
		$cons_sql=sql_select("SELECT count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id, sum(cons_qnty) as yarn_required from wo_pre_cost_fab_yarn_cost_dtls where job_no='$txt_job_no' and  status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id");
		//echo "SELECT count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id, sum(cons_qnty) as yarn_required from wo_pre_cost_fab_yarn_cost_dtls where job_no='$txt_job_no' and  status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id order by id";
		foreach($cons_sql as $row)
		{
			$cons_arr[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('percent_one')]][$row[csf('copm_two_id')]][$row[csf('percent_two')]][$row[csf('color')]][$row[csf('type_id')]]=$row[csf('yarn_required')];
		}
		unset($cons_sql);

		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one,a.copm_two_id, a.percent_two,a.color, a.type_id, a.supplier_id, sum(a.cons_qnty) as yarn_required, AVG(a.rate) as rate from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b. pre_cost_fabric_cost_dtls_id and a.job_no='$txt_job_no' and  a.status_active=1 and a.is_deleted=0 group by a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.color, a.type_id, a.supplier_id order by id");

		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top" align="center">
                	<? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%"></td>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                        <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                        </tr>
                        <tr align="center">
                        <td>Sl</td>
                        <td>Yarn Description</td>
                        <td>Supplier</td>
                        <?
                        if($show_yarn_rate==1)
                        {
							?>
							<td>Rate</td>
							<?
                        }
                        ?>
                        <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                        <td><? echo $i; ?></td>
                        <td>
                        <?
                        $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
                        if($row['copm_two_id'] !=0)
                        {
                            $yarn_des.=$composition[$row[csf('copm_two_id')]]." ".$row[csf('percent_two')]."%";
                        }
						$yarn_des.=$color_library[$row[csf('color')]]." ";
                        $yarn_des.=$yarn_type[$row[csf('type_id')]];
                        echo $yarn_des;
                        ?>
                        </td>
                        <td><? echo $supplier_name_arr[$row[csf('supplier_id')]] ;?></td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                         <td><? echo number_format($row[csf('rate')],4); ?></td>
                         <?
                        }
						$yarn_required=0;
						$yarn_required=$cons_arr[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('percent_one')]][$row[csf('copm_two_id')]][$row[csf('percent_two')]][$row[csf('color')]][$row[csf('type_id')]];
                         ?>
                        <td><? echo number_format($yarn_required,4); ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                        <td>Total</td>
                        <td></td>
                        <td></td>
                        <?
                        if($show_yarn_rate==1)
                        {
							?>
							<td></td>
							<?
                        }
                        ?>
                        <td></td>
                    </tr>
                    </table>
                </td>
            </tr>
        </table>
        <br/>
        <?


		}// fabric Source End
		if($cbo_fabric_source==1 || $cbo_fabric_source==2)
		{
			?>
            <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">&nbsp;

                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                    <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr align="center">
                        	<td colspan="10"><b>Picture</b></td>
                        </tr>
                        <tr align="center">
                            <td colspan="10">
                            <?
							$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$txt_job_no' and file_type=1");
							foreach($nameArray_imge as $result_imge)
							{
								if($path=="")
								{
									$path='../../';
								}

								?>
                                <img  src='<? echo $path.$result_imge[csf('image_location')]; ?>' height='60px' width='80px' border="2" />
								<?
							}
							?>
							</tr>
							</table>
							</fieldset>
							</div>
                            </td>
                        </tr>
                    </table>
                </td>

            </tr>
        </table>
        <br>
        <?
        //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------


		$task_short_name_arr=return_library_array( "SELECT TASK_NAME,TASK_SHORT_NAME FROM LIB_TNA_TASK WHERE IS_DELETED=0 AND STATUS_ACTIVE=1 AND TASK_NAME IN(31,60,61,73,84,86,110,47)",'TASK_NAME','TASK_SHORT_NAME');
		?>


        <fieldset id="div_size_color_matrix" style="max-width:1000;">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[47];?></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[60];?></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[61];?></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[73];?></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[84];?></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[86];?></b></td>
                <td colspan="2"  align="center" valign="top"><b><? echo $task_short_name_arr[110];?></b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                	<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
            <?
		}
		?>

         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>

       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}

		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_jk")
{	
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$cbo_pay_mode=str_replace("'","",$cbo_pay_mode);
	$txt_order_no_id=str_replace("'","",$txt_order_no_id);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if(empty($txt_order_no_id))
	{
		
		$sql_po=sql_select("Select po_break_down_id from wo_booking_dtls where status_active=1 and booking_no in('".str_replace("'","",$txt_booking_no)."') group by po_break_down_id");
		$po_txt='';
		foreach ($sql_po as $row) {
			if(empty($txt_order_no_id))
			{
				$txt_order_no_id=$row[csf('po_break_down_id')];
			}
			else{
				$txt_order_no_id.=",".$row[csf('po_break_down_id')];
			}
			
		}
	}

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
	$brand_name_arr=return_library_array( "select id, brand_name from lib_buyer_brand ",'id','brand_name');
	$booking_po_id=str_replace("'","",$txt_order_no_id);

	?>
	<div style="width:1330px" align="center">
    <?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}
	ob_start();

 ?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
 								echo $company_library[$cbo_company_name];
 								?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.pay_mode,a.update_date,a.uom,a.remarks,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant, a.booking_percent,b.brand_id from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$booking_uom=$result[csf('uom')];
					$cbo_pay_mode=$result[csf('pay_mode')];

					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}

					}

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				if($cbo_pay_mode==5 || $cbo_pay_mode==3 )
				{
					$pay_supplier_name=$company_library[$result[csf('supplier_id')]];
				}
				else
				{
					$pay_supplier_name=$supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>

            <tr>

                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Release Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td  style="font-size:12px"><b>Style Des.</b></td>
                <td  >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
               <td>:&nbsp;<?  $lead_time=rtrim($lead_time,",");
				$lead_times=implode(",",array_unique(explode(',',$lead_time))); echo $lead_times;?> </td>
                <td style="font-size:12px"><b>Dealing Merchant</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;<? echo $pay_supplier_name;?>    </td>
                <td style="font-size:12px"><b>Fab. Delv. Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
            </tr>
			<tr>
                <td></td>
                <td>&nbsp;</td>
                <td></td>
                <td>&nbsp;</td>
                <td style="font-size:18"> Pay mode </td> <td style="font-size:18">: &nbsp;<? echo $pay_mode[$cbo_pay_mode]; ?></td>
            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>PO Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>
            </tr>
           <tr>
               <td style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px">:&nbsp;<b><?   $po_no=rtrim($po_no,",");
				$po_nos=implode(",",array_unique(explode(',',$po_no))); echo $po_nos; ?></b></td>
				<td style="font-size:12px"><b>Brand</b></td>
				<td>:&nbsp;<b><?php echo $brand_name_arr[$result[csf('brand_id')]]; ?><b></td>

            </tr>
            <tr>
               <td  style="font-size:12px"><b>Shipment Date</b></td>
               <td colspan="3"> :&nbsp;<?  $shipment_date=rtrim($shipment_date,",");
				$shipment_dates=implode(",",array_unique(explode(',',$shipment_date))); echo $shipment_dates; ?></td>

                 <td  style="font-size:18px"><b>Booking Date</b></td>
               <td style="font-size:13px">:&nbsp;<? $insert_booking_date=explode(" ",$result[csf('insert_date')]);
			   if($booking_date!="" || $booking_date!="0000-00-00 00:00:00")
				{
			 		 echo change_date_format($insert_booking_date[0],'dd-mm-yyyy','-');
				}
				?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
                <td> :&nbsp;<? $WOPreparedAfter=rtrim($WOPreparedAfter,",");
				$WOPreparedAfters=implode(",",array_unique(explode(',',$WOPreparedAfter))); 
				echo $WOPreparedAfters.' Days'; ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
                <td> :&nbsp;<? $daysInHand=rtrim($daysInHand,",");
				$daysInHands=implode(",",array_unique(explode(',',$daysInHand)));
				echo $daysInHands.' Days';?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td> :&nbsp;<? $shiping_status=rtrim($shiping_status,",");
				$shiping_statuss=implode(",",array_unique(explode(',',$shiping_status)));
				echo $shiping_statuss; ?></td>

            </tr>
			<tr>
				<td style="font-size:12px"><b>Remarks</b></td>
				<td colspan="3">:&nbsp;<? echo $result[csf('remarks')]?></td>
				<td style="font-size:12px"><b>Booking Percent :</b></td>
				<td>:&nbsp;<? echo $booking_percent=$result[csf('booking_percent')]."%"; ?></td>
			</tr>
        </table>
           <?
			}


			if($cbo_fabric_source==1)
			{
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  job_no_mst=$txt_job_no and	is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>

                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                    $path='../../';
                    }

					?>
					<td>
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
			}// if($cbo_fabric_source==1) end

	  ?>
      <br/>

     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";

				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	 ?>

     <?

	if($cbo_fabric_source==1)
	{
	$nameArray_gmts_sizes = sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE
	a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.size_number_id,c.size_order order by c.size_order");
	$GmtsSizesArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$GmtsSizesArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('size_number_id')]]=$size_library[$sizes_row[csf('size_number_id')]];
	}

	/*echo "select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.count_id
	FROM wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cost_fab_yarn_cost_dtls c,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_booking_dtls d
	WHERE
	a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no=a.job_no and
	a.id=c.fabric_cost_dtls_id and
	b.pre_cost_fabric_cost_dtls_id=c.fabric_cost_dtls_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.count_id";*/
	$nameArray_gmts_sizes = sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.count_id
	FROM wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cost_fab_yarn_cost_dtls c,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_booking_dtls d
	WHERE
	a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no=a.job_no and
	a.id=c.fabric_cost_dtls_id and
	b.pre_cost_fabric_cost_dtls_id=c.fabric_cost_dtls_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.count_id");
	$countArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$countArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('count_id')]]=$yarn_count_arr[$sizes_row[csf('count_id')]];
	}

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id,a.item_number_id, max(a.lib_yarn_count_deter_id) as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.item_number_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('item_number_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else echo "<td  colspan='2'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else    echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="9" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="9" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="9" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition / Yarn Type</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Yarn Count</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{

		$cArr=$countArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gcount=implode(",",$cArr);
			if( $Gcount == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$Gcount."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Gmts Sizes</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$sizeArr=$GmtsSizesArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gsize=implode(",",$sizeArr);


			if( $Gsize == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$Gsize."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
		}
		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'  and  a.status_active=1 and   a.is_deleted=0  and  b.status_active=1 and   b.is_deleted=0");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("gmts_color_id")]){
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
			}
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;

			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
					d.status_active=1 and
					d.is_deleted=0 ");
				}
				if($db_type==2)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0 ");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				if($process_loss_method==1)
				{
					$process_loss_percent=(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]-$color_wise_wo_result_qnty[csf('fin_fab_qnty')])/$color_wise_wo_result_qnty[csf('fin_fab_qnty')])*100;
				}

				if($process_loss_method==2)
				{
					$process_loss_percent=(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]-$color_wise_wo_result_qnty[csf('fin_fab_qnty')])/$color_wise_wo_result_qnty[csf('grey_fab_qnty')])*100;
				}
				echo number_format($process_loss_percent,2)."%<br>";
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
				$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];


			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;

			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			//echo $grand_total_fin_fab_qnty;
			echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			?>
            </td>
            <td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}

	if($cbo_fabric_source==2)
	{
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id,  a.lib_yarn_count_deter_id as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.item_number_id,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.item_number_id,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Gmts Item</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('item_number_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Amount </p></td>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;

			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>

			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,4);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	?>
        <br/>
        <?
		if($cbo_fabric_source==1 || $cbo_fabric_source==2)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}

			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id and b.cons>0 and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				if($collar_cuff_row[csf('item_size')]!='0')
				{
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				}

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res); $jk=0;
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					if($jk==0 || (($jk/2)==0)) {
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;"> <? } ?>
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size <? echo $jk; ?></td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										if($item_size!="" || $item_size!=0)
										{
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
										}
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';
												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                  //  $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
													 $colar_excess_per=($plan_cut*$collar_ex_per)/100;
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                     <? if($jk==0 || (($jk/2)==0)) { ?>
                </div> <? } ?>
                <br/>
                <?
				$jk++;
            }
        }

		$condition= new condition();
		if(str_replace("'","",$job_no) !=''){
			$condition->job_no("='$job_no'");
		}
		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);

		//$yarn_data_array=$yarn->getOrderCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_data_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnQtyArray();

		$yarn_data_amt_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnAmountArray();

		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");
	$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");

		$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_no=$txt_booking_no and a.qty>0 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
		
		if(count($sql_data)>0)
		{
			?>
			<br/>
			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
				<tr align="center">
					<td colspan="10"><b>Dyes To Match</b></td>
				</tr>
				<tr align="center">
					<td>Sl</td>
					<td>Item</td>
					<td>Body Color</td>
					<td>Item Color</td>
					<td>Finish Qty.</td>
					<td>UOM</td>
				</tr>
				<?
				foreach($sql_data  as $row)
				{
					$co++;
					?>
					<tr>
						<td><? echo $co; ?></td>
						<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
						<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
						<td><? echo $color_library[$row[csf('item_color')]];?></td>
						<td align="right"><? echo $row[csf('qty')];?></td>
						<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
					</tr>
					<?
				}
				?>
			</table>
			<br/>
			<?
		}




		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one,a.copm_two_id, a.percent_two, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, AVG(a.rate) as rate,b.po_break_down_id from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one, a.copm_two_id,a.percent_two,a.color,a.type_id,b.po_break_down_id order by po_break_down_id");
		

        
                
 //===================================================Conversion Charge============================================================					
					$conversion_data=sql_select("select a.body_part_id,a.fab_nature_id, a.color_type_id,b.job_no,b.cons_process,b.fabric_description,b.charge_unit,b.color_break_down,b.amount,a.color_size_sensitive,a.id from wo_pre_cost_fab_conv_cost_dtls b,wo_pre_cost_fabric_cost_dtls a where b.job_no='$job_no'  and a.job_no=b.job_no  and a.id=b.fabric_description and b.status_active=1 and b.is_deleted=0");
					$exchange_rate=return_field_value("exchange_rate", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0 ");

	?>
        <br/>
		

		<div width="100%">				
            <table  width="49%"  style="float: left;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    	<td colspan="5"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                        <td>Sl</td>
                        <td>PO</td>
                        <td>Yarn Description</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td>Rate</td>
                        <?
                        }
                        ?>
                        <td>Cons for <? echo $costing_per; ?> Gmts</td>
                        <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						//$rowcons_qnty = $yarn_data_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						//$rowcons_Amt = $yarn_data_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$rowcons_qnty = $yarn_data_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("color")]][$row[csf("type_id")]];
						$rowcons_Amt = $yarn_data_amt_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("color")]][$row[csf("type_id")]];

						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td><? echo $po_number[$row[csf('po_break_down_id')]]; ?></td>
                            <td>
                            <?
                            $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
							$yarn_des.=$color_library[$row[csf('color')]]." ";
							$yarn_des.=$yarn_type[$row[csf('type_id')]];

                            echo $yarn_des;
                            ?>
                            </td>
                            <?
                            if($show_yarn_rate==1)
                            {
                            ?>
                             <td><? echo fn_number_format($rate,4); ?></td>
                             <?
                            }
                             ?>
                            <td><?  echo fn_number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4); ?></td>

                            <td align="right"><? echo fn_number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
						</tr>
						<?
					}
					?>
                    <tr align="center">
                        <td></td>
                        <td></td>
                        <td></td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td></td>
                        <?
                        }
                        ?>
                        <td align="right">Total : </td>
                        <td align="right"><? echo fn_number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
					
				<table  width="49%" style="float: right;" border="0" cellpadding="0" cellspacing="0"  >
					<tr>
						<td width="49%" valign="top">
						
								<style type="text/css">

									hr {
										border: 0;
										background-color: #000;
										height: 1px;
									}
								</style>
								<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
									<td colspan="7"><b>Conversion Charge</b></td>

									</tr>
									<tr align="center">
									<td width="30">Sl</td>
									<td width="210">Fabric Description</td>
									<td width="50">UOM</td>
									<td width="100">Process</td>
									<td width="100">Color</td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(USD)</div></td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(Tk.)</div></td>
								</tr>
								<?
								$i=0;
								$total_amount=0;
								foreach($conversion_data  as $row)
								{

									$i++;
									$color_break_down=explode("__",$row[csf('color_break_down')]);
									$color_arr=$color_break_down[0];
									$unit_charge=$color_break_down[1];

									$fabric_nature_id=$row[csf('fab_nature_id')];

									$color='';	$color_unit_rate='';
								
									foreach($color_break_down as $color_row)
									{
										$color_data=explode("_",$color_row);
										
										if($color=='')
										{
										$color=$color_data[0];
										}
										else
										{
											$color.=','.$color_data[0];
										}

										if($color_unit_rate=='')
										{
										$color_unit_rate=$color_data[1];
										}
										else
										{
											$color_unit_rate.=','.$color_data[1];
										}

									}
									?>
								<tr align="center">
									<td width="30"><? echo $i; ?></td>
									<td width="220">
									<?
											echo  $body_part[$row[csf("body_part_id")]].', '.$color_type[$row[csf("color_type_id")]].', '.$fabric_description_arr[$row[csf("fabric_description")]];
									?>

									</td>
									<td width="50"><? if( $fabric_nature_id==2) echo "Kg";else echo "Yds";?></td>
									<td width="100"><? echo $conversion_cost_head_array[$row[csf('cons_process')]]; ?></td>

								<?

									if($row[csf('cons_process')]==31)
									{


										?>
										<td width="100">

										<div style="word-break:break-all; font-size:medium">
										<?
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											
											$data_array2=sql_select("select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='".$row[csf('fabric_description')]."'");
											$i=1;
											$h=0;
												foreach( $data_array2 as $row2 )
												{
													
													if($i==1){
														if($color_library[$row2[csf('color_number_id')]] !==""){
															
															echo $color_library[$row2[csf('color_number_id')]];
															$i++;
															
														}
													}else{
														echo "<hr>";
														echo $color_library[$row2[csf('color_number_id')]];
													}
												
												
											
												}
												
										}else{

											$data_array1=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on 
											e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='".$row[csf('fabric_description')]."' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");

					
											$i=1;
											foreach( $data_array1 as $row1 )
											{
												
												
												if($i==1){
														echo $color_library[$row1[csf('color_number_id')]];
														$i++;
												}else{
													echo "<hr>";
													echo $color_library[$row1[csf('color_number_id')]];
												}
												
											
											}

											


										}
										?>
										</div>
										</td>
										<?
									}
									else
									{ 
										?>

									<td width="100">
										
									</td>
									<? }

									if($row[csf('cons_process')]==31)
									{
									?>

									<td width="70" title="Unit As Per">
									<div style="word-break:break-all; font-size:medium">
									<?
										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											$color_name="";	$color_m="";
											// $color_data2=count($data_color);
											$color_data2=count($data_array2);
										
											foreach($data_color_unit_rate as $val)
											{

											$color_m++;
											if($color_data2==1){
												echo number_format($val,4);break;
											}else{
												echo number_format($val,4);
											}
											if($color_data2!=$color_m)
											echo '<hr>';
											}

										}else{

											$color_name="";	$color_m="";
											// $color_data2=count($data_color);
											$color_data1=count($data_array1);
											foreach($data_color_unit_rate as $val)
											{
											$color_m++;
											if($color_data1==1){
												echo number_format($val,4);break;
											}else{
												echo number_format($val,4);
											}
											if($color_data1!=$color_m)
											echo '<hr>';
											
											}
											

										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									<? echo number_format($row[csf('charge_unit')],4); ?>
									</td>

									<? }


									if($row[csf('cons_process')]==31)
									{
									?>

									<td width="70">
									<div style="word-break:break-all; font-size:medium">
									<?
									
										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											$color_name="";$color_td=0;
											// $color_data=count($data_color);
											$color_data=count($data_array2);
											foreach($data_color_unit_rate as $val)
											{  $color_td++;
												
												if($color_data==1){
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;break;
												}else{
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;
												}
											if($color_data!=$color_td)
											echo '<hr>';
											
											}
										}else{

											$color_name="";$color_td=0;
											$color_data3=count($data_array1);
											foreach($data_color_unit_rate as $val)
											{  $color_td++;
												if($color_data3==1){
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;break;
												}else{
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;
												}
											if($color_data!=$color_td)
											echo '<hr>';
											
											}
										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									<?
									$total_amount+=$row[csf('charge_unit')]*$exchange_rate;
									echo number_format($row[csf('charge_unit')]*$exchange_rate,4); ?>
									</td>

									<? }
									?>
								</tr>
								<?
								}
									?>
									<tr align="center">


									<td colspan="6" align="right">Total</td>
									<td><? echo number_format($total_amount,4); ?></td>
									</tr>
								</table>
								<?
							
							?>

						</td>


					</tr>
				</table>

				

				<?
				$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
				?>
				<table  width="49%" style="float: left;margin-top:5px;"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
                <td width="45%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>
                    </table>
                    <?
				}
					?>
                </td>              
                </tr>
                </table>

                </td>
            </tr>
        </table>
		<table width="49%" style="float: left;margin-top:5px;"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id ");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<!-- <font style=" font-size:30px"><b> Draft</b></font> -->
                    <?
					}
					else
					{
						echo "";
					}
				}?>
				</td>
			</tr>
			</table>
	
		
		
		
		
		
		</div>



	<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
			<caption> <strong style="float:left"> Stripe Details</strong></caption>
			<?
			$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
			$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no=$txt_job_no  and d.job_no=$txt_job_no and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
			$result_data=sql_select($sql_stripe);
			foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			}
			?>

				<tr>
				<th width="30"> SL</th>
				<th width="100"> Body Part</th>
				<th width="80"> Fabric Color</th>
				<th width="70"> Fabric Qty(KG)</th>
				<th width="70"> Stripe Color</th>
				<th width="70"> Stripe Measurement</th>
				<th width="70"> Stripe Uom</th>
				<th  width="70"> Qty.(KG)</th>
				<th  width="70"> Y/D Req.</th>
				</tr>
				<?
				//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
					//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


				$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
				foreach($stripe_arr as $body_id=>$body_data){
					foreach($body_data as $color_id=>$color_val){
						$rowspan=count($color_val['stripe_color']);
						$composition=$stripe_arr2[$body_id][$color_id]['composition'];
						$construction=$stripe_arr2[$body_id][$color_id]['construction'];
						$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
						$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
						$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

						?>
						<tr>
						<?
						$color_qty= array_sum($stripe_arr[$body_id][$color_id]['fabreqtotkg']);
						?>
						<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
						<?
						$total_fab_qty+=$color_qty;
						foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
						{
							$measurement=$color_val['measurement'][$strip_color_id];
							$uom=$color_val['uom'][$strip_color_id];
							$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
							$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
							?>
							<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
							<td align="right"> <? echo  number_format($measurement,2); ?></td>
							<td> <? echo  $unit_of_measurement[$uom]; ?></td>
							<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
							<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
							</tr>
							<?
							$total_fabreqtotkg+=$fabreqtotkg;
						}
						$i++;
					}
				}
				?>
				<tfoot>
				<tr>
				<td colspan="3">Total </td>
				<td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
				<td></td>
				<td></td>
				<td>   </td>
				<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
				</tr>
				</tfoot>
				</table>
				<br>

			<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
				<tr>
					<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
						<? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
					</td>
					<td width="2%">
					</td>
					<td width="49%" valign="top">
					<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					<tr align="center">
						<td colspan="10"><b>Comments</b></td>

						</tr>
						<tr align="center">
						<td>Sl</td>
						<td>Po NO</td>
						<td>Ship Date</td>
						<td>Pre-Cost Qty</td>
						<td>Mn.Book Qty</td>
						<td>Sht.Book Qty</td>
						<td>Smp.Book Qty</td>
						<td>Tot.Book Qty</td>
						<td>Balance</td>
						<td>Comments</td>
						</tr>
						<?
		$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
		$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
		if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
		if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
		$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

		$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");



		$nameArray=sql_select("
		select
		a.id,
		a.item_number_id,
		a.costing_per,
		b.po_break_down_id,
		b.color_size_table_id,
		b.requirment,
		c.po_number
	FROM
		wo_pre_cost_fabric_cost_dtls a,
		wo_pre_cos_fab_co_avg_con_dtls b,
		wo_po_break_down c
	WHERE
	a.job_no=b.job_no and
	a.job_no=c.job_no_mst and
    a.id=b.pre_cost_fabric_cost_dtls_id and
	b.po_break_down_id=c.id and
	b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
	order by id");

	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
            if($result[csf("costing_per")]==1)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==2)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==3)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==4)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==5)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0;
					$total_booking_qnty_main=0;
					$total_booking_qnty_short=0;
					$total_booking_qnty_sample=0;
					$total_tot_bok_qty=0;
					$tot_balance=0;

					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td>
					<?
					if( $balance>0)
					{
						echo "Less Booking";
					}
					else if ($balance<0)
					{
						echo "Over Booking";
					}
					else
					{
						echo "";
					}
					?>
                    </td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                </td>

            </tr>
        </table>
       <br>
         <?

		 $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");

	 $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");

 	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
        <br/>
       <?
	   //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	   ?>

	<fieldset id="div_size_color_matrix" style="max-width:1000;">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>



        <?
		}// fabric Source End
		echo signature_table(1, $cbo_company_name, "1330px");
		?>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}

		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_fn")
{	
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";

	$txt_order_no_id=str_replace("'","",$txt_order_no_id);
	if(empty($txt_order_no_id))
	{
		
		$sql_po=sql_select("Select po_break_down_id from wo_booking_dtls where status_active=1 and booking_no in('".str_replace("'","",$txt_booking_no)."') group by po_break_down_id");
		$po_txt='';
		foreach ($sql_po as $row) {
			if(empty($txt_order_no_id))
			{
				$txt_order_no_id=$row[csf('po_break_down_id')];
			}
			else{
				$txt_order_no_id.=",".$row[csf('po_break_down_id')];
			}
			
		}
	}

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$style_owner_arr=return_library_array( "select id,company_name from   lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
	$brand_name_arr=return_library_array( "select id, brand_name from lib_buyer_brand ",'id','brand_name');
	$booking_po_id=str_replace("'","",$txt_order_no_id);
	$job_no="";$style_owner="";
	$style_owner_arr=sql_select( "select a.job_no,a.booking_no,b.style_owner,b.company_name from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		//$buyer_name=$style_owner_arr[0][csf('buyer_id')];
        foreach ($style_owner_arr as $result_job)
        {
			$job_no="'".$result_job[csf('job_no')];
			$style_owner=$result_job[csf('style_owner')];
			$job_num=$result_job[csf('job_no')];

		}

	?>
	<div style="width:1330px" align="center">
    <?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}
	ob_start();

	

 ?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
						<tr>
							<td align="center" style="font-size:20px">
                				<strong><?=$style_owner=$company_library[$style_owner]; ?> </strong>
                			</td>
						</tr>
                        <tr>
                            <td align="center" style="font-size:18px;">
                              <?php
 								echo $company_library[$cbo_company_name];
 								?>
                            </td>
                            <td rowspan="3" width="250">
                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                            </td>
                        </tr>
						
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> -->
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.pay_mode,a.update_date,a.remarks,a.uom,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant, a.booking_percent,b.brand_id from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$booking_uom=$result[csf('uom')];
					$pay_modes=$result[csf('pay_mode')];

					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}

					}

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				if($pay_modes==5 || $pay_modes==3 )
				{
					$supplier_name=$company_library[$result[csf('supplier_id')]];
				}
				else
				{
					$supplier_name=$supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>

            <tr>

                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Release Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td  style="font-size:12px"><b>Style Des.</b></td>
                <td  >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
               <td>:&nbsp;<?  $lead_time=rtrim($lead_time,",");
				$lead_times=implode(",",array_unique(explode(',',$lead_time))); echo $lead_times;?> </td>
                <td style="font-size:12px"><b>Dealing Merchant</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;<? echo $supplier_name;?>    </td>
                <td style="font-size:12px"><b>Fab. Delv. Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>



            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>PO Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td  style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px">:&nbsp;<b><?   $po_no=rtrim($po_no,",");
				$po_nos=implode(",",array_unique(explode(',',$po_no))); echo $po_nos; ?></b></td>
				<td style="font-size:12px"><b>Brand</b></td>
				<td>:&nbsp;<b><?php echo $brand_name_arr[$result[csf('brand_id')]]; ?></b></td>

            </tr>
            <tr>
               <td  style="font-size:12px"><b>Shipment Date</b></td>
               <td colspan="3"> :&nbsp;<?  $shipment_date=rtrim($shipment_date,",");
				$shipment_dates=implode(",",array_unique(explode(',',$shipment_date))); echo $shipment_dates; ?></td>

                 <td  style="font-size:18px"><b>Booking Date</b></td>
               <td style="font-size:13px">:&nbsp;<? $insert_booking_date=explode(" ",$result[csf('insert_date')]);
			   if($booking_date!="" || $booking_date!="0000-00-00 00:00:00")
				{
			 		 echo change_date_format($insert_booking_date[0],'dd-mm-yyyy','-');
				}
				?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
                <td> :&nbsp;<? $WOPreparedAfter=rtrim($WOPreparedAfter,",");
				$WOPreparedAfters=implode(",",array_unique(explode(',',$WOPreparedAfter))); 
				echo $WOPreparedAfters.' Days'; ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
                <td> :&nbsp;<? $daysInHand=rtrim($daysInHand,",");
				$daysInHands=implode(",",array_unique(explode(',',$daysInHand)));
				echo $daysInHands.' Days';?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td> :&nbsp;<? $shiping_status=rtrim($shiping_status,",");
				$shiping_statuss=implode(",",array_unique(explode(',',$shiping_status)));
				echo $shiping_statuss; ?>&nbsp;</td>

            </tr>
			<tr>
				<td style="font-size:12px"><b>Remarks</b></td>
				<td colspan="3">:&nbsp;<? echo $result[csf('remarks')]?></td>
				<td style="font-size:12px"><b>Booking Percent :</b></td>
				<td>:&nbsp;<? echo $booking_percent=$result[csf('booking_percent')]."%"; ?></td>
			</tr>
        </table>
           <?
			}


			if($cbo_fabric_source==1)
			{
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  job_no_mst=$txt_job_no and	is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>

                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                    $path='../../';
                    }

					?>
					<td>
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
			}// if($cbo_fabric_source==1) end

	  ?>
      <br/>

     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";

				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	 ?>

     <?

	if($cbo_fabric_source==1)
	{
	$nameArray_gmts_sizes = sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE
	a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.size_number_id,c.size_order order by c.size_order");
	$GmtsSizesArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$GmtsSizesArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('size_number_id')]]=$size_library[$sizes_row[csf('size_number_id')]];
	}

	/*echo "select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.count_id
	FROM wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cost_fab_yarn_cost_dtls c,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_booking_dtls d
	WHERE
	a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no=a.job_no and
	a.id=c.fabric_cost_dtls_id and
	b.pre_cost_fabric_cost_dtls_id=c.fabric_cost_dtls_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.count_id";*/
	$nameArray_gmts_sizes = sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.count_id
	FROM wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cost_fab_yarn_cost_dtls c,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_booking_dtls d
	WHERE
	a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no=a.job_no and
	a.id=c.fabric_cost_dtls_id and
	b.pre_cost_fabric_cost_dtls_id=c.fabric_cost_dtls_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.count_id");
	$countArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$countArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('count_id')]]=$yarn_count_arr[$sizes_row[csf('count_id')]];
	}

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id,a.item_number_id, max(a.lib_yarn_count_deter_id) as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.item_number_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('item_number_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else echo "<td  colspan='2'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else    echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="9" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="9" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="9" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition / Yarn Type</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Yarn Count</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{

		$cArr=$countArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gcount=implode(",",$cArr);
			if( $Gcount == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$Gcount."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Gmts Sizes</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$sizeArr=$GmtsSizesArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gsize=implode(",",$sizeArr);


			if( $Gsize == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$Gsize."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
		}
		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'  and  a.status_active=1 and   a.is_deleted=0  and  b.status_active=1 and   b.is_deleted=0");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("gmts_color_id")]){
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
			}
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;

			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
					d.status_active=1 and
					d.is_deleted=0 ");
				}
				if($db_type==2)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0 ");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				if($process_loss_method==1)
				{
					$process_loss_percent=(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]-$color_wise_wo_result_qnty[csf('fin_fab_qnty')])/$color_wise_wo_result_qnty[csf('fin_fab_qnty')])*100;
				}

				if($process_loss_method==2)
				{
					$process_loss_percent=(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]-$color_wise_wo_result_qnty[csf('fin_fab_qnty')])/$color_wise_wo_result_qnty[csf('grey_fab_qnty')])*100;
				}
				echo number_format($process_loss_percent,2)."%<br>";
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
				$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];


			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;

			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			//echo $grand_total_fin_fab_qnty;
			echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			?>
            </td>
            <td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}

	if($cbo_fabric_source==2)
	{
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id,  a.lib_yarn_count_deter_id as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.item_number_id,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.item_number_id,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Gmts Item</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('item_number_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Amount </p></td>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;

			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>

			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,4);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	?>
        <br/>
        <?
		if($cbo_fabric_source==1 || $cbo_fabric_source==2)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}

			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id and b.cons>0 and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				if($collar_cuff_row[csf('item_size')]!='0')
				{
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				}

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res); $jk=0;
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					if($jk==0 || (($jk/2)==0)) {
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;"> <? } ?>
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size <? echo $jk; ?></td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										if($item_size!="" || $item_size!=0)
										{
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
										}
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';
												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                     <? if($jk==0 || (($jk/2)==0)) { ?>
                </div> <? } ?>
                <br/>
                <?
				$jk++;
            }
        }

		$condition= new condition();
		if(str_replace("'","",$job_no) !=''){
			$condition->job_no("='$job_no'");
		}
		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);

		//$yarn_data_array=$yarn->getOrderCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_data_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnQtyArray();

		$yarn_data_amt_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnAmountArray();

		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");
	$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");

		$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_no=$txt_booking_no and a.qty>0 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
		
		if(count($sql_data)>0)
		{
			?>
			<br/>
			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
				<tr align="center">
					<td colspan="10"><b>Dyes To Match</b></td>
				</tr>
				<tr align="center">
					<td>Sl</td>
					<td>Item</td>
					<td>Body Color</td>
					<td>Item Color</td>
					<td>Finish Qty.</td>
					<td>UOM</td>
				</tr>
				<?
				foreach($sql_data  as $row)
				{
					$co++;
					?>
					<tr>
						<td><? echo $co; ?></td>
						<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
						<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
						<td><? echo $color_library[$row[csf('item_color')]];?></td>
						<td align="right"><? echo $row[csf('qty')];?></td>
						<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
					</tr>
					<?
				}
				?>
			</table>
			<br/>
			<?
		}




		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one,a.copm_two_id, a.percent_two, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, AVG(a.rate) as rate,b.po_break_down_id from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one, a.copm_two_id,a.percent_two,a.color,a.type_id,b.po_break_down_id order by po_break_down_id");
		

        
                
 //===================================================Conversion Charge============================================================					
					$conversion_data=sql_select("select a.body_part_id,a.fab_nature_id, a.color_type_id,b.job_no,b.cons_process,b.fabric_description,b.charge_unit,b.color_break_down,b.amount,a.color_size_sensitive,a.id from wo_pre_cost_fab_conv_cost_dtls b,wo_pre_cost_fabric_cost_dtls a where b.job_no='$job_no'  and a.job_no=b.job_no  and a.id=b.fabric_description and b.status_active=1 and b.is_deleted=0");
					$exchange_rate=return_field_value("exchange_rate", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0 ");

	?>
        <br/>
		

		<div width="100%">				
            <table  width="49%"  style="float: left;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    	<td colspan="5"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                        <td>Sl</td>
                        <td>PO</td>
                        <td>Yarn Description</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td>Rate</td>
                        <?
                        }
                        ?>
                        <td>Cons for <? echo $costing_per; ?> Gmts</td>
                        <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						//$rowcons_qnty = $yarn_data_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						//$rowcons_Amt = $yarn_data_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$rowcons_qnty = $yarn_data_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("color")]][$row[csf("type_id")]];
						$rowcons_Amt = $yarn_data_amt_array[$row[csf("po_break_down_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("color")]][$row[csf("type_id")]];

						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td><? echo $po_number[$row[csf('po_break_down_id')]]; ?></td>
                            <td>
                            <?
                            $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
							$yarn_des.=$color_library[$row[csf('color')]]." ";
							$yarn_des.=$yarn_type[$row[csf('type_id')]];

                            echo $yarn_des;
                            ?>
                            </td>
                            <?
                            if($show_yarn_rate==1)
                            {
                            ?>
                             <td><? echo fn_number_format($rate,4); ?></td>
                             <?
                            }
                             ?>
                            <td><?  echo fn_number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4); ?></td>

                            <td align="right"><? echo fn_number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
						</tr>
						<?
					}
					?>
                    <tr align="center">
                        <td></td>
                        <td></td>
                        <td></td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td></td>
                        <?
                        }
                        ?>
                        <td align="right">Total : </td>
                        <td align="right"><? echo fn_number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
					
				<table  width="49%" style="float: right;" border="0" cellpadding="0" cellspacing="0"  >
					<tr>
						<td width="49%" valign="top">
						
								<style type="text/css">

									hr {
										border: 0;
										background-color: #000;
										height: 1px;
									}
								</style>
								<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
								<tr align="center">
									<td colspan="7"><b>Conversion Charge</b></td>

									</tr>
									<tr align="center">
									<td width="30">Sl</td>
									<td width="210">Fabric Description</td>
									<td width="50">UOM</td>
									<td width="100">Process</td>
									<td width="100">Color</td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(USD)</div></td>
									<td width="70"><div style="word-break:break-all; font-size:small">Charge/Unit(Tk.)</div></td>
								</tr>
								<?
								$i=0;
								$total_amount=0;
								foreach($conversion_data  as $row)
								{

									$i++;
									$color_break_down=explode("__",$row[csf('color_break_down')]);
									$color_arr=$color_break_down[0];
									$unit_charge=$color_break_down[1];

									$fabric_nature_id=$row[csf('fab_nature_id')];

									$color='';	$color_unit_rate='';
								
									foreach($color_break_down as $color_row)
									{
										$color_data=explode("_",$color_row);
										
										if($color=='')
										{
										$color=$color_data[0];
										}
										else
										{
											$color.=','.$color_data[0];
										}

										if($color_unit_rate=='')
										{
										$color_unit_rate=$color_data[1];
										}
										else
										{
											$color_unit_rate.=','.$color_data[1];
										}

									}
									?>
								<tr align="center">
									<td width="30"><? echo $i; ?></td>
									<td width="220">
									<?
											echo  $body_part[$row[csf("body_part_id")]].', '.$color_type[$row[csf("color_type_id")]].', '.$fabric_description_arr[$row[csf("fabric_description")]];
									?>

									</td>
									<td width="50"><? if( $fabric_nature_id==2) echo "Kg";else echo "Yds";?></td>
									<td width="100"><? echo $conversion_cost_head_array[$row[csf('cons_process')]]; ?></td>

								<?

									if($row[csf('cons_process')]==31)
									{


										?>
										<td width="100">

										<div style="word-break:break-all; font-size:medium">
										<?
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											
											$data_array2=sql_select("select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='".$row[csf('fabric_description')]."'");
											$i=1;
											$h=0;
												foreach( $data_array2 as $row2 )
												{
													
													if($i==1){
														if($color_library[$row2[csf('color_number_id')]] !==""){
															
															echo $color_library[$row2[csf('color_number_id')]];
															$i++;
															
														}
													}else{
														echo "<hr>";
														echo $color_library[$row2[csf('color_number_id')]];
													}
												
												
											
												}
												
										}else{

											$data_array1=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on 
											e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='".$row[csf('fabric_description')]."' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");

					
											$i=1;
											foreach( $data_array1 as $row1 )
											{
												
												
												if($i==1){
														echo $color_library[$row1[csf('color_number_id')]];
														$i++;
												}else{
													echo "<hr>";
													echo $color_library[$row1[csf('color_number_id')]];
												}
												
											
											}

											


										}
										?>
										</div>
										</td>
										<?
									}
									else
									{ 
										?>

									<td width="100">
										
									</td>
									<? }

									if($row[csf('cons_process')]==31)
									{
									?>

									<td width="70" title="Unit As Per">
									<div style="word-break:break-all; font-size:medium">
									<?
										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											$color_name="";	$color_m="";
											// $color_data2=count($data_color);
											$color_data2=count($data_array2);
										
											foreach($data_color_unit_rate as $val)
											{

											$color_m++;
											if($color_data2==1){
												echo number_format($val,4);break;
											}else{
												echo number_format($val,4);
											}
											if($color_data2!=$color_m)
											echo '<hr>';
											}

										}else{

											$color_name="";	$color_m="";
											// $color_data2=count($data_color);
											$color_data1=count($data_array1);
											foreach($data_color_unit_rate as $val)
											{
											$color_m++;
											if($color_data1==1){
												echo number_format($val,4);break;
											}else{
												echo number_format($val,4);
											}
											if($color_data1!=$color_m)
											echo '<hr>';
											
											}
											

										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									<? echo number_format($row[csf('charge_unit')],4); ?>
									</td>

									<? }


									if($row[csf('cons_process')]==31)
									{
									?>

									<td width="70">
									<div style="word-break:break-all; font-size:medium">
									<?
									
										$data_color=explode(",",$color);
										$data_color_unit_rate=explode(",",$color_unit_rate);
										if($row[csf('color_size_sensitive')] ==3)
										{ 
											$color_name="";$color_td=0;
											// $color_data=count($data_color);
											$color_data=count($data_array2);
											foreach($data_color_unit_rate as $val)
											{  $color_td++;
												
												if($color_data==1){
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;break;
												}else{
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;
												}
											if($color_data!=$color_td)
											echo '<hr>';
											
											}
										}else{

											$color_name="";$color_td=0;
											$color_data3=count($data_array1);
											foreach($data_color_unit_rate as $val)
											{  $color_td++;
												if($color_data3==1){
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;break;
												}else{
													echo number_format($val*$exchange_rate,4);
												$total_amount+=$val*$exchange_rate;
												}
											if($color_data!=$color_td)
											echo '<hr>';
											
											}
										}
									?>
									</div>
									</td>
									<?
									}
									else
									{ ?>
									<td width="70">
									<?
									$total_amount+=$row[csf('charge_unit')]*$exchange_rate;
									echo number_format($row[csf('charge_unit')]*$exchange_rate,4); ?>
									</td>

									<? }
									?>
								</tr>
								<?
								}
									?>
									<tr align="center">


									<td colspan="6" align="right">Total</td>
									<td><? echo number_format($total_amount,4); ?></td>
									</tr>
								</table>
								<?
							
							?>

						</td>


					</tr>
				</table>

				

				<?
				$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
				?>
				<table  width="49%" style="float: left;margin-top:5px;"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
                <td width="45%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

					$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>
                    </table>
                    <?
				}
					?>
                </td>              
                </tr>
                </table>

                </td>
            </tr>
        </table>
		<table width="49%" style="float: left;margin-top:5px;"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id ");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<!-- <font style=" font-size:30px"><b> Draft</b></font> -->
                    <?
					}
					else
					{
						echo "";
					}
				}?>
				</td>
			</tr>
			</table>
	
		
		
		
		
		
		</div>



	<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
			<caption> <strong style="float:left"> Stripe Details</strong></caption>
			<?
			$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
			$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no=$txt_job_no  and d.job_no=$txt_job_no and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
			$result_data=sql_select($sql_stripe);
			foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			}
			?>

				<tr>
				<th width="30"> SL</th>
				<th width="100"> Body Part</th>
				<th width="80"> Fabric Color</th>
				<th width="70"> Fabric Qty(KG)</th>
				<th width="70"> Stripe Color</th>
				<th width="70"> Stripe Measurement</th>
				<th width="70"> Stripe Uom</th>
				<th  width="70"> Qty.(KG)</th>
				<th  width="70"> Y/D Req.</th>
				</tr>
				<?
				//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
					//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


				$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
				foreach($stripe_arr as $body_id=>$body_data){
					foreach($body_data as $color_id=>$color_val){
						$rowspan=count($color_val['stripe_color']);
						$composition=$stripe_arr2[$body_id][$color_id]['composition'];
						$construction=$stripe_arr2[$body_id][$color_id]['construction'];
						$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
						$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
						$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

						?>
						<tr>
						<?
						$color_qty= array_sum($stripe_arr[$body_id][$color_id]['fabreqtotkg']);
						?>
						<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
						<?
						$total_fab_qty+=$color_qty;
						foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
						{
							$measurement=$color_val['measurement'][$strip_color_id];
							$uom=$color_val['uom'][$strip_color_id];
							$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
							$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
							?>
							<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
							<td align="right"> <? echo  number_format($measurement,2); ?></td>
							<td> <? echo  $unit_of_measurement[$uom]; ?></td>
							<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
							<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
							</tr>
							<?
							$total_fabreqtotkg+=$fabreqtotkg;
						}
						$i++;
					}
				}
				?>
				<tfoot>
				<tr>
				<td colspan="3">Total </td>
				<td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
				<td></td>
				<td></td>
				<td>   </td>
				<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
				</tr>
				</tfoot>
				</table>
				<br>

			<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
				<tr>
					<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
						<? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
					</td>
					<td width="2%">
					</td>
					<td width="49%" valign="top">
					<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					<tr align="center">
						<td colspan="10"><b>Comments</b></td>

						</tr>
						<tr align="center">
						<td>Sl</td>
						<td>Po NO</td>
						<td>Ship Date</td>
						<td>Pre-Cost Qty</td>
						<td>Mn.Book Qty</td>
						<td>Sht.Book Qty</td>
						<td>Smp.Book Qty</td>
						<td>Tot.Book Qty</td>
						<td>Balance</td>
						<td>Comments</td>
						</tr>
						<?
		$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
		$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
		if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
		if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
		$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

		$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");



		$nameArray=sql_select("
		select
		a.id,
		a.item_number_id,
		a.costing_per,
		b.po_break_down_id,
		b.color_size_table_id,
		b.requirment,
		c.po_number
	FROM
		wo_pre_cost_fabric_cost_dtls a,
		wo_pre_cos_fab_co_avg_con_dtls b,
		wo_po_break_down c
	WHERE
	a.job_no=b.job_no and
	a.job_no=c.job_no_mst and
    a.id=b.pre_cost_fabric_cost_dtls_id and
	b.po_break_down_id=c.id and
	b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
	order by id");

	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
            if($result[csf("costing_per")]==1)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==2)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==3)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==4)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==5)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0;
					$total_booking_qnty_main=0;
					$total_booking_qnty_short=0;
					$total_booking_qnty_sample=0;
					$total_tot_bok_qty=0;
					$tot_balance=0;

					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td>
					<?
					if( $balance>0)
					{
						echo "Less Booking";
					}
					else if ($balance<0)
					{
						echo "Over Booking";
					}
					else
					{
						echo "";
					}
					?>
                    </td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                </td>

            </tr>
        </table>
       <br>
         <?

		 $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");

	 $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");

 	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
        <br/>
       <?
	   //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	   ?>

	<fieldset id="div_size_color_matrix" style="max-width:1000;">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>



        <?
		}// fabric Source End
		echo signature_table(1, $cbo_company_name, "1330px");
		?>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}

		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report18")
{
	extract($_REQUEST);
	 $cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,address from lib_location",'id','address');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path != "") {
	$path = $path;
} else {
	$path = "../../";
}
ob_start();

?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:24px;">
                              <?php
								echo $company_library[$cbo_company_name];
								?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>

                               <span style="font-size:16px"><b> Repeat No:&nbsp;&nbsp;
	                               <?php $job_no_txt=trim($txt_job_no,"'"); $order_repeat_no=return_field_value( "order_repeat_no", "wo_po_details_master","job_no='$job_no_txt'");

	                                	if(!empty($order_repeat_no)) 
	                                	{
	                                		echo $order_repeat_no;
	                                	}
	                                	else
	                                	{
	                                		echo "NEW";
	                                	} 

	                                ?>
	                                </b>
	                            </span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
							$job_no=str_replace("'","",$txt_job_no);
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>
							<br>
                                
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:24px">
                                <strong><? $report_title="Main Fabric Booking"; if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "(Un Approved)";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$booking_po_id='';
				$po_quantity=0;

                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.remarks, a.supplier_id, a.fabric_composition, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.pay_mode, a.update_date, a.uom, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, a.booking_percent from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$booking_uom=$result[csf('uom')];
					$pay_modes=$result[csf('pay_mode')];
					$remarks=$result[csf('remarks')];
					$fabric_composition=$result[csf('fabric_composition')];
					$po_no="";
					$shipment_date="";
					$sql_po= "select id,grouping,file_no,po_number, MIN(pub_shipment_date) pub_shipment_date, sum(po_quantity) as po_quantity from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by id,po_number,grouping,file_no order by id asc"; 
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
						$po_quantity+=$row_po[csf('po_quantity')];
						$grouping[$row_po[csf('grouping')]]=$row_po[csf('grouping')];
						$file_no[$row_po[csf('file_no')]]=$row_po[csf('file_no')];
					}
					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}


				$booking_po_id=$result[csf('po_break_down_id')];



					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}

					}

				if($db_type==2)
				{
					$group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				}
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

				$data_array3=sql_select("select a.job_no, a.company_name, a.buyer_name, $group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				if($pay_modes==5 || $pay_modes==3 )
				{
					$supplier_name=$company_library[$result[csf('supplier_id')]];
				}
				else
				{
					$supplier_name=$supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2 && str_replace("'","",$id_approved_id) !=1){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('booking_date')];
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td  style="font-size:12px"><b>Style Des.</b></td>
                <td  >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
                <td>:&nbsp;<?  $lead_time=rtrim($lead_time,",");
$lead_times=implode(",",array_unique(explode(',',$lead_time)));
echo $lead_times;?> </td>
                <td style="font-size:12px"><b>Dealing Merchant</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;<? echo $supplier_name;?>    </td>
                <td style="font-size:12px"><b>Fab. Delv. Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>



            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>PO Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td  style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px" colspan="3">:&nbsp;<b><? $po_no=rtrim($po_no,", ");
$po_nos=implode(", ",array_unique(explode(', ',$po_no)));echo $po_nos; ?></b></td>
               <td>Internal Ref</td>
               <td>:&nbsp;<? echo implode($grouping, ",") ?></td>
            </tr>
            <tr>
               <td  style="font-size:12px"><b>Shipment Date</b></td>
               <td colspan="3" title="<? echo $shipment_date;?>"> :&nbsp;<? $shipment_dateArr=rtrim($shipment_date,", ");
$shipment_dates=implode(", ",array_unique(explode(', ',$shipment_dateArr))); echo $shipment_dates; ?></td>               
               <td>File NO.</td>
               <td>:&nbsp;<? echo implode($file_no, ","); ?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
               <td> :&nbsp;<? $WOPreparedAfter=rtrim($WOPreparedAfter,",");
$WOPreparedAfters=implode(",",array_unique(explode(',',$WOPreparedAfter))); echo $WOPreparedAfters.' Days'; ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
               <td> :&nbsp;<? $daysInHand=rtrim($daysInHand,",");
$daysInHands=implode(",",array_unique(explode(',',$daysInHand))); echo $daysInHands.' Days';?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td> :&nbsp;<? $shiping_status=rtrim($shiping_status,",");
$shiping_statuss=implode(",",array_unique(explode(',',$shiping_status)));  echo $shiping_statuss; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Booking Percent :</b><? echo $booking_percent=$result[csf('booking_percent')]."%"; ?></td>

            </tr>
             <tr>
            	<td style="font-size:12px"><b>Fabric Composition</b></td>
            	  <td style="font-size:18px" colspan="5"> :&nbsp;<? echo $fabric_composition;?></td>
            </tr>
            <tr>
            	<td style="font-size:12px"><b>Remarks</b></td>
            	<td colspan="5"> :&nbsp;<? echo $remarks;?></td>
            </tr>
        </table>
           <?
			}


			
	  ?>
      <br/>

      <!--  Here will be the main portion  -->
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;
			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;
			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	 ?>

     <?
	 //    $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
	 $sql_po_color=sql_select("select sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown where  status_active=1 and job_no_mst='$job_no'");
	  $grand_total= $sql_po_color[0][csf('plan_cut_qnty')];
	 
if($cbo_fabric_source==1  || $cbo_fabric_source==3)
{
	$nameArray_gmts_sizes= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.size_number_id,c.size_order order by c.size_order");
	$GmtsSizesArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$GmtsSizesArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('size_number_id')]]=$size_library[$sizes_row[csf('size_number_id')]];
	}


	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, max(a.lib_yarn_count_deter_id) as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan=''>&nbsp</td>";
			else echo "<td  colspan=''>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        
        <td  rowspan="10" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan=''>&nbsp</td>";
			else  echo "<td  colspan=''>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
        <!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
             <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan=''>&nbsp</td>";
			else echo "<td  colspan=''>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition / Yarn Type</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='' >&nbsp</td>";
			else   echo "<td colspan='' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan=''>&nbsp</td>";
			else  echo "<td colspan='' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan=''>&nbsp</td>";
			else  echo "<td colspan='' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
        <tr align="center"><th   colspan="3" align="left">Gmts Sizes</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$sizeArr=$GmtsSizesArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gsize=implode(",",$sizeArr);


			if( $Gsize == "")   echo "<td colspan=''>&nbsp</td>";
			else  echo "<td colspan='' align='center'>".$Gsize."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?> </th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan=''>&nbsp</td>";
			else echo "<td align='center' colspan=''>Fin: ".number_format($result_fabric_description[csf('cons')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'  colspan=''>Finish</th>";
		}
		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];

		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;

			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
					d.status_active=1 and
					d.is_deleted=0 ");
				}
				if($db_type==2)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0 ");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' colspan="" align='right'>
			 <?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			?>
            </td>
            
            <?
			}
			$grand_total_grey_fab_qnty+=$total_grey_fab_qnty;
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right' colspan=""><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
            
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
           
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
         <tr style="font-weight:bold;">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;

			?>
			<td width='50' colspan="" align='right'> <?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <?
			}
			?>
            <td align="right" >
			 <?
			//echo $grand_total_fin_fab_qnty.'='.$grand_total.'='.$total_set_qnty.'='.$costing_per_qnty;
			echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			?>
            </td>
          
            <td align="right">
              <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}

	if($cbo_fabric_source==2)
	{
		$nameArray_gmts_sizes= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.size_number_id,c.size_order order by c.size_order");
	$GmtsSizesArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$GmtsSizesArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('size_number_id')]]=$size_library[$sizes_row[csf('size_number_id')]];
	}

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id,  a.lib_yarn_count_deter_id as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else      echo "<td  colspan='3'><div style='word-wrap:break-word; width:100px'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</div></td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Amount </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else   echo "<td  colspan='3'><div style='word-wrap:break-word; width:100px'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</div></td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else   echo "<td  colspan='3'><div style='word-wrap:break-word; width:100px'>". $result_fabric_description[csf('construction')]."</div></td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else   echo "<td colspan='3' ><div style='word-wrap:break-word; width:100px'>".$result_fabric_description[csf('composition')]."</div></td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else  echo "<td colspan='3' align='center'><div style='word-wrap:break-word; width:100px'>". $result_fabric_description[csf('gsm_weight')]."</div></td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else    echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Gmts Sizes</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$sizeArr=$GmtsSizesArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gsize=implode(",",$sizeArr);


			if( $Gsize == "")   echo "<td colspan='3'>&nbsp</td>";
			else  echo "<td colspan='3' align='center'>".$Gsize."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else  echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp; </th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty['grey_fab_qnty'];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);

			echo number_format($consumption_per_unit_fab,4);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	?>
        <br/>
        <?
		if($cbo_fabric_source==1 || $cbo_fabric_source==3 || $cbo_fabric_source==2)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and e.body_part_type in (40,50) order by  c.size_order";
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			/*echo '10**<pre>';
			print_r($collar_cuff_sql_res); die;*/
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; margin:5px;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="margin:5px;">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> -- Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									foreach($size_number  as $item_size=>$val)
									{
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
									<?
									}
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                
                <?
            	}
        	}

			$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name", "id", "item_name");
			$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
			$bookingId=0;
			foreach($sql as $row){
			$bookingId= $row[csf('id')];
			}
			$co=0;
			$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
			if(count($sql_data)>0)
			{
				?>
				<br/>
				<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					<tr align="center">
						<td colspan="10"><b>Dyes To Match</b></td>
					</tr>
					<tr align="center">
						<td>Sl</td>
						<td>Item</td>
						<td>Body Color</td>
						<td>Item Color</td>
						<td>Finish Qty.</td>
						<td>UOM</td>
					</tr>
					<?
					foreach($sql_data  as $row)
					{
						$co++;
						?>
						<tr>
							<td><? echo $co; ?></td>
							<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
							<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
							<td><? echo $color_library[$row[csf('item_color')]];?></td>
							<td align="right"><? echo $row[csf('qty')];?></td>
							<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
						</tr>
						<?
					}
					?>
				</table>
				<br/>
				<?
			}
			 
			//echo $yarn->getQuery(); die;
		
			//print_r($yarn_data_array);
			//$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		//	$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");

			 
			?>
			
			<br/>
			<?
			$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<td width="49%" valign="top">
					<?
					if(count($sql_embelishment)>0)
					{
						?>
						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
							<tr align="center">
								<td colspan="7"><b>Embelishment (Pre Cost)</b></td>
							</tr>
							<tr align="center">
								<td>Sl</td>
								<td>Embelishment Name</td>
								<td>Embelishment Type</td>
								<td>Cons <? echo $costing_per; ?> Gmts</td>
								<td>Rate</td>
								<td>Amount</td>
							</tr>
							<?
							$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
							$i=0;
							foreach($sql_embelishment  as $row_embelishment)
							{
								$i++;
								?>
								<tr align="center">
									<td><? echo $i; ?></td>
									<td><? echo $emblishment_name_array[$row_embelishment[csf('emb_name')]]; ?></td>
									<td>
									<?
										if($row_embelishment[csf('emb_name')]==1) echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==2) echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==3)  echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==4) echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==5) echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
									?>
									</td>
									<td><? echo $row_embelishment[csf('cons_dzn_gmts')]; ?></td>
									<td><? echo $row_embelishment[csf('rate')]; ?></td>
									<td><? echo $row_embelishment[csf('amount')]; ?></td>
								</tr>
								<?
							}
							?>
						</table>
						<?
					}
					?>
					</td>
					<td width="2%">&nbsp;</td>
					<td width="49%" valign="top" align="center">
						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" style="margin:5px;" rules="all">
							<tr align="center">
								<td><b>Approved Instructions</b></td>
							</tr>
							<tr>
								<td><? echo $nameArray_approved_comments_row[csf('comments')]; ?></td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			<br/>


		<!-- stripe start here  -->


			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	            <caption> <strong style="float:left"> Stripe Details</strong></caption>
	                <?
	                $color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
	                $sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.stripe_color,d.id as did,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,d.id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,b.dia_width order by d.id");
	                $result_data=sql_select($sql_stripe);
	                foreach($result_data as $row){
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
	                }
	                ?>
	                <tr>
	                    <th width="30"> SL</th>
	                    <th width="100"> Body Part</th>
	                    <th width="80"> Fabric Color</th>
	                    <th width="70"> Fabric Qty(KG)</th>
	                    <th width="70"> Stripe Color</th>
	                    <th width="70"> Stripe Measurement</th>
	                    <th width="70"> Qty.(KG)</th>
	                    <th width="70"> Y/D Req.</th>
	                </tr>
	                <?
	                $i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
	                foreach($stripe_arr as $body_id=>$body_data)
	                {
	                    foreach($body_data as $color_id=>$color_val)
	                    {
	                        $rowspan=count($color_val['stripe_color']);
	                        $composition=$stripe_arr2[$body_id][$color_id]['composition'];
	                        $construction=$stripe_arr2[$body_id][$color_id]['construction'];
	                        $gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
	                        $color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
	                        $dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

	                        $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	                        WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$body_id."' and a.color_type_id='".$color_type_id."' and a.construction='".$construction."' and a.composition='".$composition."' and a.gsm_weight='".$gsm_weight."' and nvl(d.fabric_color_id,0)=nvl('".$color_id."',0) and d.status_active=1 and d.is_deleted=0 ");
	                        list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
	                        ?>
	                        <tr>
	                            <?
	                            $color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	                            ?>
	                            <td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
	                            <td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
	                            <td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
	                            <td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
	                            <?
	                                $total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	                                foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
	                                {
	                                    $measurement=$color_val['measurement'][$strip_color_id];
	                                    $fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
	                                    $yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
	                                    ?>
	                                    <td><?  echo  $color_name_arr[$s_color_val]; ?></td>
	                                    <td align="right"> <? echo  number_format($measurement,2); ?></td>
	                                    <td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
	                                    <td> <? echo  $yes_no[$yarn_dyed]; ?></td>
	                                </tr>
	                                <?
	                                $total_fabreqtotkg+=$fabreqtotkg;
	                            }
	                            $i++;
	                        }
	                    }
	                ?>
	                <tfoot>
	                    <tr>
	                        <td colspan="3">Total </td>
	                        <td align="right"><? echo  number_format($total_fab_qty,2); ?> </td>
	                        <td></td>
	                        <td></td>
	                        <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
	                        <td></td>
	                    </tr>
	                </tfoot>
	            </table>
	            <br>

		<!-- stripe end here  -->

        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="100%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"100%",118);?>
				</td>
			    	<td width="2%">&nbsp;</td>
			    	<td width="49%" valign="top">
					  <?
					if($cbo_fabric_source==1 || $cbo_fabric_source==3)
					{
					//$nameArray_size=sql_select( "select  size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  job_no_mst=$txt_job_no and is_deleted=0 and status_active=1 group by size_number_id order by size_order");

				   ?>
		            <table width="100%" >
				    <tr>
		            
		                
		            <td width="330" valign="top" align="left">
		            <?
					$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
					?>
		            <div id="div_size_color_matrix" style="float:left;">
		            	<fieldset id="" >
		 				<legend>Image </legend>
		            	<table width="310">
		                <tr>
		                <?
						$img_counter = 0;
		                foreach($nameArray_imge as $result_imge)
						{
						    if($path=="")
		                    {
		                    $path='../../';
		                    }

							?>
							<td>
		                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
							</td>
							<?

							$img_counter++;
						}
						?>  


					<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr align="center">
							<td colspan="10"><b>Comments</b></td>
						</tr>
						<tr align="center">
							<td>Sl</td>
							<td>Po NO</td>
							<td>Ship Date</td>
							<td>Pre-Cost Qty</td>
							<td>Mn.Book Qty</td>
							<td>Sht.Book Qty</td>
							<td>Smp.Book Qty</td>
							<td>Tot.Book Qty</td>
							<td>Balance</td>
							<td>Comments</td>
						</tr>
						<?
						$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
						$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
						if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
						if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
						$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

						$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");



						$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM	wo_pre_cost_fabric_cost_dtls a,	wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");

						$count=0;
						$tot_grey_req_as_pre_cost_arr=array();
						foreach ($nameArray as $result)
						{
							if (count($nameArray)>0 )
							{
								if($result[csf("costing_per")]==1)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==2)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==3)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==4)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==5)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
							}
						}
						$total_pre_cost=0;
						$total_booking_qnty_main=0;
						$total_booking_qnty_short=0;
						$total_booking_qnty_sample=0;
						$total_tot_bok_qty=0;
						$tot_balance=0;

						$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

						$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
						$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
						$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
						foreach($sql_data  as $row)
						{
							$col++;
							?>
							<tr align="center">
								<td><? echo $col; ?></td>
								<td><? echo $row[csf("po_number")]; ?></td>
								<td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
								<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
								<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
								<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
								<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
								<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
								<td align="right">
								<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
								</td>
								<td>
									<?
									if( $balance>0)
									{
										echo "Less Booking";
									}
									else if ($balance<0)
									{
										echo "Over Booking";
									}
									else
									{
										echo "";
									}
									?>
								</td>
							</tr>
							<?
						}
						?>
						<tfoot>
							<tr>
								<td colspan="3">Total:</td>
								<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
								<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
								<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
								<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
								<td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
								<td align="right"><? echo number_format($tot_balance,2); ?></td>
								<td></td>
							</tr>
						</tfoot>
					</table>
				</td>
		                </tr>
		           </table>
		           </fieldset>
		           </div>
		          </td>
		        </tr>
		       </table>
		        <?
					}// if($cbo_fabric_source==1) end

			  ?>
				</td>
            </tr>
        </table>
       <br>
         <?

		 	$lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");

	 		//$data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date,b.un_approved_reason, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
			$data_array=sql_select(" select b.id,b.approved_by,b.approved_no, b.approved_date,b.un_approved_reason, c.user_full_name,c.designation,d.approval_cause from wo_booking_mst a join approval_history b on a.id=b.mst_id join  user_passwd c on b.approved_by=c.id left join fabric_booking_approval_cause d on b.id =d.approval_history_id  where a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");

 	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="25%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="15%" style="border:1px solid black;">Approval No</th><th width="30%" style="border:1px solid black;">Un Approval Cause</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                <td width="25%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td>
                <td width="27%" style="border:1px solid black;"><? echo date("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>
                <td width="15%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                <td width="15%" style="border:1px solid black;"><? echo $row[csf('approval_cause')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
        <br/>
       <?
	   //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number in (84,186,187) then task_start_date else null end) as cutting_start_date,
								(case when task_number in (84,186,187) then task_finish_date else null end) as cutting_end_date,
								(case when task_number in (86,122,190,191) then task_start_date else null end) as sewing_start_date,
								(case when task_number in (86,122,190,191) then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date,

								(case when task_number=63 then task_start_date else null end) as aop_rec_start_date,
								(case when task_number=63 then task_finish_date else null end) as aop_rec_end_date,
								(case when task_number=178 then task_start_date else null end) as kniting_yd_start_date,
								(case when task_number=178 then task_finish_date else null end) as kniting_yd_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}

						$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_start_date']=$row[csf("fab_booking_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_end_date']=$row[csf("fab_booking_end_date")];


					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
					if($row[csf("kniting_yd_start_date")]!="" && $row[csf("kniting_yd_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_start_date']=$row[csf("kniting_yd_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_rec_end_date']=$row[csf("kniting_yd_rec_end_date")];
					}
					if($row[csf("aop_rec_start_date")]!="" && $row[csf("aop_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_start_date']=$row[csf("aop_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_end_date']=$row[csf("aop_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------

	   	$task_short_name_arr=return_library_array( "select task_name,task_short_name from lib_tna_task where is_deleted=0 and status_active=1 and task_name in(31,60,61,73,84,186,187,86,122,190,191,110,47,63,178)",'task_name','task_short_name');



	   ?>

		<fieldset id="div_size_color_matrix" style="max-width:1200; display:none">
				<legend>TNA Information</legend>
				<!--<span style="font-size:180; font-weight:bold;"></span>-->
				<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
					<tr>
						<td rowspan="2" align="center" valign="top">SL</td>
						<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[31];?></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[47];?><!--Yarn Receive--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[60];?><!--Knitting--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[178];?><!--Knitting Y/D--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[61];?><!--Dyeing--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[63];?><!--AOP Recieve--></b></td>

						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[73];?><!--Finishing Fabric--></b></td>

						<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
						<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
						<td colspan="2"  align="center" valign="top"><b><? echo $task_short_name_arr[110];?><!--Ex-factory --></b></td>
					</tr>
					<tr>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

					</tr>
					<?
					$i=1;
					foreach($tna_date_task_arr as $order_id=>$row)
					{
						?>
						<tr>
							<td><? echo $i; ?></td>
							<td><? echo $po_num_arr[$order_id]; ?></td>
							<td align="center"><? echo change_date_format($row['fab_booking_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['fab_booking_end_date']); ?></td>

							<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>

							<td  align="center"><? echo change_date_format($row['kniting_yd_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['kniting_yd_rec_end_date']); ?></td>

							<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>

							<td align="center"><? echo change_date_format($row['aop_rec_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['aop_rec_end_date']); ?></td>


							<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
						</tr>
						<?
						$i++;
					}
					?>

				</table>
				</fieldset>
		<?







		$tna_history_start_sql=sql_select( "select id,po_number_id,
		(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
		(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
		(case when task_number=60 then task_start_date else null end) as knitting_start_date,
		(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
		(case when task_number=61 then task_start_date else null end) as dying_start_date,
		(case when task_number=61 then task_finish_date else null end) as dying_end_date,
		(case when task_number=73 then task_start_date else null end) as finishing_start_date,
		(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
		(case when task_number in (84,186,187) then task_start_date else null end) as cutting_start_date,
		(case when task_number in (84,186,187) then task_finish_date else null end) as cutting_end_date,
		(case when task_number in (86,122,190,191) then task_start_date else null end) as sewing_start_date,
		(case when task_number in (86,122,190,191) then task_finish_date else null end) as sewing_end_date,
		(case when task_number=110 then task_start_date else null end) as exfact_start_date,
		(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
		(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
		(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date,

		(case when task_number=63 then task_start_date else null end) as aop_rec_start_date,
		(case when task_number=63 then task_finish_date else null end) as aop_rec_end_date,
		(case when task_number=178 then task_start_date else null end) as kniting_yd_start_date,
		(case when task_number=178 then task_finish_date else null end) as kniting_yd_rec_end_date
		from tna_plan_actual_history
		where status_active=0 and is_deleted=1 and po_number_id in($po_id_all) and task_number in(31,60,61,73,84,186,187,86,122,190,191,110,47,63,178)");
		$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
		$tna_date_task_arr=array();
		foreach($tna_history_start_sql as $row)
		{
			if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
			{
				if($tna_fab_start=="")
				{
					$tna_fab_start=$row[csf("fab_booking_start_date")];
				}

				$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_start_date']=$row[csf("fab_booking_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_end_date']=$row[csf("fab_booking_end_date")];
			}


			if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
			}
			if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
			}
			if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
			}
			if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
			}
			if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
			}
			if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
			}
			if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
			}
			if($row[csf("kniting_yd_start_date")]!="" && $row[csf("kniting_yd_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_start_date']=$row[csf("kniting_yd_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_rec_end_date']=$row[csf("kniting_yd_rec_end_date")];
			}
			if($row[csf("aop_rec_start_date")]!="" && $row[csf("aop_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_start_date']=$row[csf("aop_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_end_date']=$row[csf("aop_rec_end_date")];
			}
		}

       if(count($tna_date_task_arr)>0){

	  ?>

		<fieldset id="div_size_color_matrix" style="max-width:1200; display:none">
        <legend>TNA History Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[31];?></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[47];?><!--Yarn Receive--></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[60];?><!--Knitting--></b></td>
				<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[178];?><!--Knitting Y/D--></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[61];?><!--Dyeing--></b></td>
				<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[63];?><!--AOP Recieve--></b></td>

                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[73];?><!--Finishing Fabric--></b></td>

                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b><? echo $task_short_name_arr[110];?><!--Ex-factory --></b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

				<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

				<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['fab_booking_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['fab_booking_end_date']); ?></td>

                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>

					<td  align="center"><? echo change_date_format($row['kniting_yd_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['kniting_yd_rec_end_date']); ?></td>

                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>

					 <td align="center"><? echo change_date_format($row['aop_rec_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['aop_rec_end_date']); ?></td>


                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>

		<?
	   		}


		}// fabric Source End

		if($cbo_fabric_source==2)
		{
           echo get_spacial_instruction($txt_booking_no,"100%",118);
		}
		echo signature_table(1, $cbo_company_name, "1330px");
		?>
       </div>
       <?
	   
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}

		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_libas")
{
	extract($_REQUEST);
	 $cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$is_approved=return_field_value( "is_approved", "wo_booking_mst","booking_no=$txt_booking_no");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	
	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
	$fabric_composition_arr=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
	
	?>
	<div style="width:1330px" align="center">
    <?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}
	ob_start();
	?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php echo $company_library[$cbo_company_name]; ?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>

                               <span style="font-size:16px"><b> Repeat No:&nbsp;&nbsp;
	                               <?php $job_no_txt=trim($txt_job_no,"'"); $order_repeat_no=return_field_value( "order_repeat_no", "wo_po_details_master","job_no='$job_no_txt'");

	                                	if(!empty($order_repeat_no)) 
	                                	{
	                                		echo $order_repeat_no;
	                                	}
	                                	else
	                                	{
	                                		echo "NEW";
	                                	} 

	                                ?>
	                                </b>
	                            </span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>
	<br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <!-- <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong> -->


								<?php
								

								if($is_approved==1){ $ap_msg="<b style='color:red'>This Booking is Full Approved.</b>";}
									else if($is_approved==3){

										$approval_allow=sql_select("select b.id, b.page_id, b.approval_need, b.allow_partial, b.validate_page,a.setup_date from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id='$cbo_company_name' and a.status_active=1 and b.page_id=5 and b.status_active=1 and b.is_deleted=0 order by b.id desc ");

										if($approval_allow[0][csf("approval_need")]==1 && $approval_allow[0][csf("allow_partial")]==1){
											$ap_msg="<b style='color:red'>This Booking is Approved.</b>";
										}else{
											$ap_msg="<b style='color:red'>This Booking is Partially Approved.</b>";
										}
									}
									else{ $ap_msg=" ";}
									echo $ap_msg;

								?>

                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$booking_po_id='';
				$po_quantity=0;

                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.remarks, a.supplier_id, a.fabric_composition, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.pay_mode, a.update_date, a.uom, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, a.booking_percent, a.sustainability_standard from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$booking_uom=$result[csf('uom')];
					$pay_modes=$result[csf('pay_mode')];
					$remarks=$result[csf('remarks')];
					$fabric_composition=$result[csf('fabric_composition')];
					$po_no="";
					$shipment_date="";
					$sql_po= "select grouping,file_no,po_number, MIN(pub_shipment_date) pub_shipment_date, sum(po_quantity) as po_quantity from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,grouping,file_no";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipdate=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-');
						// $shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
						$po_quantity+=$row_po[csf('po_quantity')];
						$grouping[$row_po[csf('grouping')]]=$row_po[csf('grouping')];
						$file_no[$row_po[csf('file_no')]]=$row_po[csf('file_no')];
						$shipdate_arr[$shipdate]=$shipdate;
					}
					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}


				$booking_po_id=$result[csf('po_break_down_id')];



					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}

					}

				if($db_type==2)
				{
					$group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				}
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

				$data_array3=sql_select("select a.job_no, a.company_name, a.buyer_name, $group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				if($pay_modes==5 || $pay_modes==3 )
				{
					$supplier_name=$company_library[$result[csf('supplier_id')]];
				}
				else
				{
					$supplier_name=$supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2 && str_replace("'","",$id_approved_id) !=1){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('booking_date')];
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td  style="font-size:12px"><b>Style Des.</b></td>
                <td  >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
                <td>:&nbsp;<?  echo implode(",",array_unique(explode(",",rtrim($lead_time))));?> </td>
                <td style="font-size:12px"><b>Dealing Merchant</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;<? echo $supplier_name;?>    </td>
                <td style="font-size:12px"><b>Fab. Delv. Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>

            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>PO Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>
            </tr>
           <tr>
               <td  style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px" colspan="3">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
               <td><b>Internal Ref</b></td>
               <td>:&nbsp;<b><? echo implode($grouping, ",") ?></b></td>
            </tr>
            <tr>
               <td  style="font-size:12px"><b>Shipment Date</b></td>
               <td colspan="3"> :&nbsp;<? echo implode(",",$shipdate_arr); ?></td>               
               <td>File NO.</td>
               <td>:&nbsp;<? echo implode($file_no, ",") ?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
               <td> :&nbsp;<? echo implode(",",array_unique(explode(",",rtrim($WOPreparedAfter)))).' Days' ?></td>
			 
               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
               <td> :&nbsp;<? echo implode(",",array_unique(explode(",",rtrim($daysInHand)))).' Days'?></td>
			   
               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td> :&nbsp; <? echo implode(",",array_unique(explode(",",rtrim($shiping_status)))); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Booking Percent :</b><? echo $booking_percent=$result[csf('booking_percent')]."%"; ?></td>
			  
            </tr>
             <tr>
            	<td style="font-size:12px"><b>Fabric Composition</b></td>
            	  <td style="font-size:18px" colspan="5"> :&nbsp;<? echo $fabric_composition;?></td>
            </tr>
            <tr>
            	<td style="font-size:12px"><b>Remarks</b></td>
            	<td colspan="5"> :&nbsp;<? echo $remarks;?></td>
            </tr>
        </table>
           <?
			}


		if($cbo_fabric_source==1 || $cbo_fabric_source==3)
		{
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  job_no_mst=$txt_job_no and is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                    $path='../../';
                    }

					?>
					<td>
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
	}// if($cbo_fabric_source==1) end

	  ?>
      <br/>

      <!--  Here will be the main portion  -->
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;
			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;
			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	 ?>

     <?
	if($cbo_fabric_source==1  || $cbo_fabric_source==3)
	{
		$nameArray_gmts_sizes= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
		WHERE a.job_no=b.job_no and
		a.id=b.pre_cost_fabric_cost_dtls_id and
		c.job_no_mst=a.job_no and
		c.id=b.color_size_table_id and
		b.po_break_down_id=d.po_break_down_id and
		b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
		d.booking_no =$txt_booking_no and
		d.status_active=1 and
		d.is_deleted=0
		group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.size_number_id,c.size_order order by c.size_order");
		$GmtsSizesArr=array();
		foreach($nameArray_gmts_sizes as $sizes_row){
			$GmtsSizesArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('size_number_id')]]=$size_library[$sizes_row[csf('size_number_id')]];
		}


		$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, max(a.lib_yarn_count_deter_id) as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
		WHERE a.job_no=b.job_no and
		a.id=b.pre_cost_fabric_cost_dtls_id and
		c.job_no_mst=a.job_no and
		c.id=b.color_size_table_id and
		b.po_break_down_id=d.po_break_down_id and
		b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
		d.booking_no =$txt_booking_no and
		d.status_active=1 and
		d.is_deleted=0
		group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
		?>

		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
		<tr align="center">
		<th colspan="3" align="left">Body Part</th>
			<?
			foreach($nameArray_fabric_description  as $result_fabric_description)
			{
				if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
				else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
			}
			?>
			<td  rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
			<td  rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
			<td  rowspan="10" width="50"><p>Process Loss % </p></td>
		</tr>
		<tr align="center"><th colspan="3" align="left">Color Type</th>
			<?
			foreach($nameArray_fabric_description  as $result_fabric_description)
			{
				if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
				else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
			}
			?>
			<!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
				<!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
		</tr>
			<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
			<?
			foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
	   <tr align="center">
                    <th colspan="3" align="left">Fabric Composition</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('determin_id')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>".$fabric_composition_arr[$lip_yarn_count[$result_fabric_description[csf('determin_id')]]]."</td>";
                    }
                    ?>
          </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition / Yarn Type</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2'  ><div style='word-wrap:break-word; width:100px'>".$result_fabric_description[csf('composition')]."</div></td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
        <tr align="center"><th   colspan="3" align="left">Gmts Sizes</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$sizeArr=$GmtsSizesArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gsize=implode(",",$sizeArr);


			if( $Gsize == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2'  align='center'><div style='word-wrap:break-word; width:100px'>".$Gsize."</div></td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
		}
		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];

		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;

			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
					d.status_active=1 and
					d.is_deleted=0 ");
				}
				if($db_type==2)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0 ");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				if($process_loss_method==1)
				{
					$process_loss_percent=(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]-$color_wise_wo_result_qnty[csf('fin_fab_qnty')])/$color_wise_wo_result_qnty[csf('fin_fab_qnty')])*100;
				}

				if($process_loss_method==2)
				{
					$process_loss_percent=(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]-$color_wise_wo_result_qnty[csf('fin_fab_qnty')])/$color_wise_wo_result_qnty[csf('grey_fab_qnty')])*100;
				}
				echo number_format($process_loss_percent,2)."%<br>";
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
				$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];


			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			//echo $grand_total_fin_fab_qnty;
			echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			?>
            </td>
            <td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}

	if($cbo_fabric_source==2)
	{
		
		$nameArray_gmts_sizes= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
		WHERE a.job_no=b.job_no and
		a.id=b.pre_cost_fabric_cost_dtls_id and
		c.job_no_mst=a.job_no and
		c.id=b.color_size_table_id and
		b.po_break_down_id=d.po_break_down_id and
		b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
		d.booking_no =$txt_booking_no and
		d.status_active=1 and
		d.is_deleted=0
		group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.size_number_id,c.size_order order by c.size_order");
		$GmtsSizesArr=array();
		foreach($nameArray_gmts_sizes as $sizes_row){
			$GmtsSizesArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('size_number_id')]]=$size_library[$sizes_row[csf('size_number_id')]];
		}

		$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id,  a.lib_yarn_count_deter_id as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
		WHERE a.job_no=b.job_no and
		a.id=b.pre_cost_fabric_cost_dtls_id and
		c.job_no_mst=a.job_no and
		c.id=b.color_size_table_id and
		b.po_break_down_id=d.po_break_down_id and
		b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
		d.booking_no =$txt_booking_no and
		d.status_active=1 and
		d.is_deleted=0
		group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
		?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
		<?php
		if($show_yarn_rate==1){?>
       		 <td  rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
       		 <td  rowspan="10" width="50"><p>Amount </p></td>
		<? } ?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else  echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else   echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Gmts Sizes</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$sizeArr=$GmtsSizesArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gsize=implode(",",$sizeArr);


			if( $Gsize == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'><div style='word-wrap:break-word; width:120px'>".$Gsize."</div></td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$colspan="";
			if($show_yarn_rate==1){
			  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}else{
				$colspan="colspan='3'";
				echo "<th width='50' colspan='3'>Fab. Qty</th>";
			}
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."  and status_active=1 and is_deleted=0");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

				
			?>
			<td width='50' align='right' <?=$colspan;?>>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}

			?>
            </td>
			<?

			if($show_yarn_rate==1){?>

            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty['grey_fab_qnty'];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			 }
			}
			?>
            <td align="right" <?=$colspan;?>><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
			<?php
			if($show_yarn_rate==1){?>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,2);

			?>
            </td>
			<?}?>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right' <?=$colspan;?>><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
			<?php
			if($show_yarn_rate==1){?>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			}
			?>
            <td align="right" <?=$colspan;?>><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
			<?php
			if($show_yarn_rate==1){?>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
			<? } ?>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right' <?=$colspan;?>><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>

			<?php
			if($show_yarn_rate==1){?>
         	<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
		}
			?>
            <td align="right" <?=$colspan;?>>
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);

			echo number_format($consumption_per_unit_fab,4);
			?>
            </td>
			<?php
			if($show_yarn_rate==1){?>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
			<? }?>
            </tr>
    </table>
    <?
	}
	?>
        <br/>
        <?
		if($cbo_fabric_source==1 || $cbo_fabric_source==3 || $cbo_fabric_source==2)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and e.body_part_type in (40,50) order by  c.size_order";
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			/*echo '10**<pre>';
			print_r($collar_cuff_sql_res); die;*/
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									foreach($size_number  as $item_size=>$val)
									{
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
									<?
									}
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            	}
        	}

			$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name", "id", "item_name");
			$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
			$bookingId=0;
			foreach($sql as $row){
			$bookingId= $row[csf('id')];
			}
			$co=0;
			$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
			if(count($sql_data)>0)
			{
				?>
				<br/>
				<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					<tr align="center">
						<td colspan="10"><b>Dyes To Match</b></td>
					</tr>
					<tr align="center">
						<td>Sl</td>
						<td>Item</td>
						<td>Body Color</td>
						<td>Item Color</td>
						<td>Finish Qty.</td>
						<td>UOM</td>
					</tr>
					<?
					foreach($sql_data  as $row)
					{
						$co++;
						?>
						<tr>
							<td><? echo $co; ?></td>
							<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
							<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
							<td><? echo $color_library[$row[csf('item_color')]];?></td>
							<td align="right"><? echo $row[csf('qty')];?></td>
							<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
						</tr>
						<?
					}
					?>
				</table>
				<br/>
				<?
			}
			$condition= new condition();
			if(str_replace("'","",$txt_order_no_id) !=''){
				$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
			}

			$condition->init();
			$cos_per_arr=$condition->getCostingPerArr();
			$yarn= new yarn($condition);
			$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
			$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

			$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
			?>
	        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
	            <tr>
	                <td width="49%" valign="top">
	                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	                    <tr align="center">
	                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

	                    </tr>
	                    <tr align="center">
	                    <td>Sl</td>
	                    <td>Yarn Description</td>
	                    <td>Brand</td>
	                    <td>Lot</td>
	                    <?
						if($show_yarn_rate==1)
						{
						?>
	                    <td>Rate</td>
	                    <?
						}
						?>
	                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
	                    <td>Total (KG)</td>
	                    </tr>
	                    <?
						$i=0;
						$total_yarn=0;
						foreach($yarn_sql_array  as $row)
	                    {

							$i++;
							$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
							$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


							$rate=$rowcons_Amt/$rowcons_qnty;
							$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
						?>
	                    <tr align="center">
	                    <td><? echo $i; ?></td>
	                    <td>
						<?
						$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
						$yarn_des.=$color_library[$row[csf('color')]]." ";
						$yarn_des.=$yarn_type[$row[csf('type_id')]];
						echo $yarn_des;
						?>
	                    </td>
	                    <td></td>
	                    <td></td>
	                    <?
						if($show_yarn_rate==1)
						{
						?>
	                     <td ><? echo number_format($row[csf('rate')],4); ?></td>
	                     <?
						}
						 ?>
	                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

	                    <td align="right">
						<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
	                    </tr>
	                    <?
						}
						?>
	                    <tr align="center">
	                    <td>Total</td>
	                    <td></td>
	                    <td></td>
	                    <td></td>
	                    <?
						if($show_yarn_rate==1)
						{
						?>
	                    <td></td>
	                    <?
	                    }
						?>
	                    <td></td>
	                    <td align="right"><? echo number_format($total_yarn,2); ?></td>
	                    </tr>
	                    </table>
	                </td>
	                <td width="2%">
	                </td>
	                <td width="49%" valign="top" align="center">
	                <?
					$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id");
					if(count($yarn_sql_array)>0)
					{
					?>
	                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	                    <tr align="center">
	                    <td colspan="7"><b>Allocated Yarn</b></td>

	                    </tr>
	                    <tr align="center">
	                    <td>Sl</td>
	                    <td>Yarn Description</td>
	                    <td>Brand</td>
	                    <td>Lot</td>


	                    <td>Allocated Qty (Kg)</td>
	                    </tr>
	                    <?
						$total_allo=0;
						$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
						$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
						$i=0;
						$total_yarn=0;
						foreach($yarn_sql_array  as $row)
	                    {

							$i++;
						?>
	                    <tr align="center">
	                    <td><? echo $i; ?></td>
	                    <td>
						<?

						echo $item[$row[csf('item_id')]];
						?>
	                    </td>
	                    <td>
	                    <?

						echo $supplier[$row[csf('supplier_id')]];
						?>
	                    </td>
	                    <td>
						<?

						echo $row[csf('lot')];
						?>
	                    </td>
	                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
	                    </tr>
	                    <?
						}
						?>
	                    <tr align="center">
	                    <td>Total</td>
	                    <td></td>


	                    <td></td>
	                    <td></td>
	                    <td align="right"><? echo number_format($total_allo,4); ?></td>
	                    </tr>
	                    </table>
	                    <?
					}
					else
					{
						$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
						if($is_yarn_allocated==1)
						{
						?>
						<font style=" font-size:30px"><b> Draft</b></font>
	                    <?
						}
						else
						{
							echo "";
						}
					}
						?>
	                </td>
	            </tr>
	        </table>	        
	        <br/>
			<?
			$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<td width="49%" valign="top">
					<?
					if(count($sql_embelishment)>0)
					{
						?>
						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
							<tr align="center">
								<td colspan="7"><b>Embelishment (Pre Cost)</b></td>
							</tr>
							<tr align="center">
								<td>Sl</td>
								<td>Embelishment Name</td>
								<td>Embelishment Type</td>
								<td>Cons <? echo $costing_per; ?> Gmts</td>
								<td>Rate</td>
								<td>Amount</td>
							</tr>
							<?
							$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
							$i=0;
							foreach($sql_embelishment  as $row_embelishment)
							{
								$i++;
								?>
								<tr align="center">
									<td><? echo $i; ?></td>
									<td><? echo $emblishment_name_array[$row_embelishment[csf('emb_name')]]; ?></td>
									<td>
									<?
										if($row_embelishment[csf('emb_name')]==1) echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==2) echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==3)  echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==4) echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
										if($row_embelishment[csf('emb_name')]==5) echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
									?>
									</td>
									<td><? echo $row_embelishment[csf('cons_dzn_gmts')]; ?></td>
									<td><? echo $row_embelishment[csf('rate')]; ?></td>
									<td><? echo $row_embelishment[csf('amount')]; ?></td>
								</tr>
								<?
							}
							?>
						</table>
						<?
					}
					?>
					</td>
					<td width="2%">&nbsp;</td>
					<td width="49%" valign="top" align="center">
						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
							<tr align="center">
								<td><b>Approved Instructions</b></td>
							</tr>
							<tr>
								<td><? echo $nameArray_approved_comments_row[csf('comments')]; ?></td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			<br/>


		<!-- stripe start here  -->


			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	            <caption> <strong style="float:left"> Stripe Details</strong></caption>
	                <?
	                $color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
	                $sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.stripe_color,d.id as did,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,d.id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,b.dia_width,d.uom order by d.id");
	                $result_data=sql_select($sql_stripe);
	                foreach($result_data as $row){
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
	                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
	                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
	                }
	                ?>
	                <tr>
	                    <th width="30"> SL</th>
	                    <th width="100"> Body Part</th>
	                    <th width="80"> Fabric Color</th>
	                    <th width="70"> Fabric Qty(KG)</th>
	                    <th width="70"> Stripe Color</th>
	                    <th width="70"> Stripe Measurement</th>
	                    <th width="70"> Qty.(KG)</th>
	                    <th width="70"> Y/D Req.</th>
	                </tr>
	                <?
	                $i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
	                foreach($stripe_arr as $body_id=>$body_data)
	                {
	                    foreach($body_data as $color_id=>$color_val)
	                    {
	                        $rowspan=count($color_val['stripe_color']);
	                        $composition=$stripe_arr2[$body_id][$color_id]['composition'];
	                        $construction=$stripe_arr2[$body_id][$color_id]['construction'];
	                        $gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
	                        $color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
	                        $dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

	                        $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	                        WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$body_id."' and a.color_type_id='".$color_type_id."' and a.construction='".$construction."' and a.composition='".$composition."' and a.gsm_weight='".$gsm_weight."' and nvl(d.fabric_color_id,0)=nvl('".$color_id."',0) and d.status_active=1 and d.is_deleted=0 ");
	                        list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
	                        ?>
	                        <tr>
	                            <?
	                            $color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	                            ?>
	                            <td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
	                            <td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
	                            <td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
	                            <td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
	                            <?
	                                $total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	                                foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
	                                {
	                                    $measurement=$color_val['measurement'][$strip_color_id];
										$uom=$color_val['uom'][$strip_color_id];
	                                    $fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
	                                    $yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
	                                    ?>
	                                    <td><?  echo  $color_name_arr[$s_color_val]; ?></td>
	                                    <td align="right"> <? echo  number_format($measurement,2)."(".$unit_of_measurement[$uom].")"; ?></td>
	                                    <td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
	                                    <td> <? echo  $yes_no[$yarn_dyed]; ?></td>
	                                </tr>
	                                <?
	                                $total_fabreqtotkg+=$fabreqtotkg;
									$total_measurement+=$measurement;
	                            }
	                            $i++;
	                        }
	                    }
	                ?>
	                <tfoot>
	                    <tr>
	                        <td colspan="3">Total </td>
	                        <td align="right"><? echo  number_format($total_fab_qty,2); ?> </td>
	                        <td></td>
	                        <td align="right"><? echo  number_format($total_measurement,2); ?></td>
	                        <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
	                        <td></td>
	                    </tr>
	                </tfoot>
	            </table>
	            <br>

		<!-- stripe end here  -->

        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
				</td>
				<td width="2%">&nbsp;</td>
				<td width="49%" valign="top">
					<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr align="center">
							<td colspan="10"><b>Comments</b></td>
						</tr>
						<tr align="center">
							<td>Sl</td>
							<td>Po NO</td>
							<td>Ship Date</td>
							<td>Pre-Cost Qty</td>
							<td>Mn.Book Qty</td>
							<td>Sht.Book Qty</td>
							<td>Smp.Book Qty</td>
							<td>Tot.Book Qty</td>
							<td>Balance</td>
							<td>Comments</td>
						</tr>
						<?
						$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
						$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
						if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
						if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
						$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

						$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");



						$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM	wo_pre_cost_fabric_cost_dtls a,	wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");

						$count=0;
						$tot_grey_req_as_pre_cost_arr=array();
						foreach ($nameArray as $result)
						{
							if (count($nameArray)>0 )
							{
								if($result[csf("costing_per")]==1)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==2)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==3)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==4)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==5)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
							}
						}
						$total_pre_cost=0;
						$total_booking_qnty_main=0;
						$total_booking_qnty_short=0;
						$total_booking_qnty_sample=0;
						$total_tot_bok_qty=0;
						$tot_balance=0;

						$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

						$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
						$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
						$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
						foreach($sql_data  as $row)
						{
							$col++;
							?>
							<tr align="center">
								<td><? echo $col; ?></td>
								<td><? echo $row[csf("po_number")]; ?></td>
								<td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
								<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
								<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
								<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
								<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
								<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
								<td align="right">
								<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
								</td>
								<td>
									<?
									if( $balance>0)
									{
										echo "Less Booking";
									}
									else if ($balance<0)
									{
										echo "Over Booking";
									}
									else
									{
										echo "";
									}
									?>
								</td>
							</tr>
							<?
						}
						?>
						<tfoot>
							<tr>
								<td colspan="3">Total:</td>
								<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
								<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
								<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
								<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
								<td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
								<td align="right"><? echo number_format($tot_balance,2); ?></td>
								<td></td>
							</tr>
						</tfoot>
					</table>
				</td>
            </tr>
        </table>
       <br>
         <?

		 	$lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");

	 		//$data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date,b.un_approved_reason, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
			$data_array=sql_select(" select b.id,b.approved_by,b.approved_no, b.approved_date,b.un_approved_reason, c.user_full_name,c.designation,d.approval_cause from wo_booking_mst a join approval_history b on a.id=b.mst_id join  user_passwd c on b.approved_by=c.id left join fabric_booking_approval_cause d on b.id =d.approval_history_id  where a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");

 	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="25%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="15%" style="border:1px solid black;">Approval No</th><th width="30%" style="border:1px solid black;">Un Approval Cause</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                <td width="25%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td>
                <td width="27%" style="border:1px solid black;"><? echo date("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>
                <td width="15%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                <td width="15%" style="border:1px solid black;"><? echo $row[csf('approval_cause')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
        <br/>
       <?
	   //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number in (84,186,187) then task_start_date else null end) as cutting_start_date,
								(case when task_number in (84,186,187) then task_finish_date else null end) as cutting_end_date,
								(case when task_number in (86,122,190,191) then task_start_date else null end) as sewing_start_date,
								(case when task_number in (86,122,190,191) then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date,

								(case when task_number=63 then task_start_date else null end) as aop_rec_start_date,
								(case when task_number=63 then task_finish_date else null end) as aop_rec_end_date,
								(case when task_number=178 then task_start_date else null end) as kniting_yd_start_date,
								(case when task_number=178 then task_finish_date else null end) as kniting_yd_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}

						$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_start_date']=$row[csf("fab_booking_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_end_date']=$row[csf("fab_booking_end_date")];


					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
					if($row[csf("kniting_yd_start_date")]!="" && $row[csf("kniting_yd_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_start_date']=$row[csf("kniting_yd_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_rec_end_date']=$row[csf("kniting_yd_rec_end_date")];
					}
					if($row[csf("aop_rec_start_date")]!="" && $row[csf("aop_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_start_date']=$row[csf("aop_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_end_date']=$row[csf("aop_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------

	   	$task_short_name_arr=return_library_array( "select task_name,task_short_name from lib_tna_task where is_deleted=0 and status_active=1 and task_name in(31,60,61,73,84,186,187,86,122,190,191,110,47,63,178)",'task_name','task_short_name');



	   ?>

		<fieldset id="div_size_color_matrix" style="max-width:1200;">
				<legend>TNA Information</legend>
				<!--<span style="font-size:180; font-weight:bold;"></span>-->
				<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
					<tr>
						<td rowspan="2" align="center" valign="top">SL</td>
						<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[31];?></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[47];?><!--Yarn Receive--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[60];?><!--Knitting--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[178];?><!--Knitting Y/D--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[61];?><!--Dyeing--></b></td>
						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[63];?><!--AOP Recieve--></b></td>

						<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[73];?><!--Finishing Fabric--></b></td>

						<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
						<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
						<td colspan="2"  align="center" valign="top"><b><? echo $task_short_name_arr[110];?><!--Ex-factory --></b></td>
					</tr>
					<tr>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>
						<td width="85" align="center" valign="top"><b>Start Date</b></td>
						<td width="85" align="center" valign="top"><b>End Date</b></td>

					</tr>
					<?
					$i=1;
					foreach($tna_date_task_arr as $order_id=>$row)
					{
						?>
						<tr>
							<td><? echo $i; ?></td>
							<td><? echo $po_num_arr[$order_id]; ?></td>
							<td align="center"><? echo change_date_format($row['fab_booking_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['fab_booking_end_date']); ?></td>

							<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>

							<td  align="center"><? echo change_date_format($row['kniting_yd_start_date']); ?></td>
							<td  align="center"><? echo change_date_format($row['kniting_yd_rec_end_date']); ?></td>

							<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>

							<td align="center"><? echo change_date_format($row['aop_rec_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['aop_rec_end_date']); ?></td>


							<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
							<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
							<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
						</tr>
						<?
						$i++;
					}
					?>

				</table>
				</fieldset>
		<?







		$tna_history_start_sql=sql_select( "select id,po_number_id,
		(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
		(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
		(case when task_number=60 then task_start_date else null end) as knitting_start_date,
		(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
		(case when task_number=61 then task_start_date else null end) as dying_start_date,
		(case when task_number=61 then task_finish_date else null end) as dying_end_date,
		(case when task_number=73 then task_start_date else null end) as finishing_start_date,
		(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
		(case when task_number in (84,186,187) then task_start_date else null end) as cutting_start_date,
		(case when task_number in (84,186,187) then task_finish_date else null end) as cutting_end_date,
		(case when task_number in (86,122,190,191) then task_start_date else null end) as sewing_start_date,
		(case when task_number in (86,122,190,191) then task_finish_date else null end) as sewing_end_date,
		(case when task_number=110 then task_start_date else null end) as exfact_start_date,
		(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
		(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
		(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date,

		(case when task_number=63 then task_start_date else null end) as aop_rec_start_date,
		(case when task_number=63 then task_finish_date else null end) as aop_rec_end_date,
		(case when task_number=178 then task_start_date else null end) as kniting_yd_start_date,
		(case when task_number=178 then task_finish_date else null end) as kniting_yd_rec_end_date
		from tna_plan_actual_history
		where status_active=0 and is_deleted=1 and po_number_id in($po_id_all) and task_number in(31,60,61,73,84,186,187,86,122,190,191,110,47,63,178)");
		$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
		$tna_date_task_arr=array();
		foreach($tna_history_start_sql as $row)
		{
			if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
			{
				if($tna_fab_start=="")
				{
					$tna_fab_start=$row[csf("fab_booking_start_date")];
				}

				$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_start_date']=$row[csf("fab_booking_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['fab_booking_end_date']=$row[csf("fab_booking_end_date")];
			}


			if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
			}
			if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
			}
			if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
			}
			if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
			}
			if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
			}
			if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
			}
			if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
			}
			if($row[csf("kniting_yd_start_date")]!="" && $row[csf("kniting_yd_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_start_date']=$row[csf("kniting_yd_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['kniting_yd_rec_end_date']=$row[csf("kniting_yd_rec_end_date")];
			}
			if($row[csf("aop_rec_start_date")]!="" && $row[csf("aop_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_start_date']=$row[csf("aop_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['aop_rec_end_date']=$row[csf("aop_rec_end_date")];
			}
		}

       if(count($tna_date_task_arr)>0){

	  ?>

		<fieldset id="div_size_color_matrix" style="max-width:1200;">
        <legend>TNA History Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[31];?></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[47];?><!--Yarn Receive--></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[60];?><!--Knitting--></b></td>
				<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[178];?><!--Knitting Y/D--></b></td>
                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[61];?><!--Dyeing--></b></td>
				<td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[63];?><!--AOP Recieve--></b></td>

                <td colspan="2" align="center" valign="top"><b><? echo $task_short_name_arr[73];?><!--Finishing Fabric--></b></td>

                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b><? echo $task_short_name_arr[110];?><!--Ex-factory --></b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

				<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

				<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['fab_booking_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['fab_booking_end_date']); ?></td>

                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>

					<td  align="center"><? echo change_date_format($row['kniting_yd_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['kniting_yd_rec_end_date']); ?></td>

                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>

					 <td align="center"><? echo change_date_format($row['aop_rec_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['aop_rec_end_date']); ?></td>


                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>







		<?
	   		}


		}// fabric Source End

		if($cbo_fabric_source==2)
		{
           echo get_spacial_instruction($txt_booking_no,"97%",118);
		}
		echo signature_table(1, $cbo_company_name, "1330px");
		?>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
		*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_urmi")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).") and status_active!=0");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	
	$sql_po=sql_select("select sum(plan_cut) as plan_cut,sum(po_quantity) as po_quantity from wo_po_break_down where  id in(".str_replace("'","",$txt_order_no_id).") and status_active!=0");
	$po_qnty_tot=$sql_po[0][csf('plan_cut')];
	$po_qnty_tot1=$sql_po[0][csf('po_quantity')];
	//echo "select sum(plan_cut) as plan_cut,sum(po_quantity) as po_quantity from wo_po_break_down where  id in(".str_replace("'","",$txt_order_no_id).") and status_active!=0";
	// echo $po_qnty_tot.'='.$po_qnty_tot1;
	
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php

$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;

$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;

$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;

$path = str_replace("'", "", $path);
if ($path != "") {
	$path = $path;
} else {
	$path = "../../";
}
ob_start();
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$uom=0;
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
			
                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.pay_mode, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season, b.season_buyer_wise  as season_matrix, b.order_repeat_no, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.qlty_label, b.client_id, a.fabric_composition from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") and status_active!=0 group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
					}

					$shipment_date="";
					$sql_min= "select MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") and status_active!=0";
					$data_array_min=sql_select($sql_min);
					foreach ($data_array_min as $sql_min)
					{
						$shipment_date.=change_date_format($sql_min[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}

					$Maxshipment_date="";
					$sql_max= "select MAX(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") and status_active!=0";
					$data_array_max=sql_select($sql_max);
					foreach ($data_array_max as $row_max)
					{
						$Maxshipment_date.=change_date_format($row_max[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}

					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") and status_active!=0";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") and status_active!=0";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") and status_active!=0";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") and status_active!=0 group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}
					}

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst and b.status_active!=0 group by a.job_no,a.company_name,a.buyer_name");

				?>
       <table width="100%" style="border:1px solid black;table-layout: fixed;" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="220">:&nbsp;<span style="font-size:18px"><b><?
					$buyer_name_str="";
					if($result[csf('client_id')]!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]."-".$buyer_name_arr[$result[csf('client_id')]]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]; echo $buyer_name_str; ?></b></span></td>
                <td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="220">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td>:&nbsp; <?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
            </tr>
            <tr>
                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Release Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b>
					<?
                        echo $result[csf('style_ref_no')];
                        $style_sting=$result[csf('style_ref_no')];
                    ?>
                 </b>
                 </td>
            </tr>
             <tr>
                <td style="font-size:12px"><b>Style Des.</b></td>
                <td>:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
                <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;
				<?
				$lead_time=implode(",",array_unique(explode(",",chop($lead_time,","))));
			   	echo $lead_time;
				?> </td>
                <td style="font-size:12px"><b>Dealing Merchant</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;
				<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3 ){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>
                </td>
                <td style="font-size:12px"><b>Delivery Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>



            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<? $season_matrix=return_field_value("season_name","lib_buyer_season","id=".$result[csf('season_matrix')],"season_name");echo $season_matrix; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>Po Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
               <td  style="font-size:12px"><b>Repeat No</b></td>
               <td  >:&nbsp;<? echo $result[csf('order_repeat_no')]; ?></td>
            </tr>
            <tr>
               <td style="font-size:12px"><b>Shipment Date</b></td>
                <td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">: First :&nbsp;<? echo rtrim($shipment_date,", "); ?>, Last: <? echo rtrim($Maxshipment_date,", ");  ?></td>
                <td  style="font-size:12px"><b>Quality Label</b></td>
               <td  >:&nbsp;<? echo $quality_label[$result[csf('qlty_label')]]; ?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
			   <?
			   $WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
			   echo $WOPreparedAfter.' Days' ;
			   ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
			   <?
			   $daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
			   echo $daysInHand.' Days' ;
			    //echo rtrim($daysInHand,',').' Days'
			   ?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
			   <?
			   $shiping_status=implode(",",array_unique(explode(",",chop($shiping_status,","))));
			   echo $shiping_status;
			   ?></td>

            </tr>
           <tr>
               <td style="font-size:18px"><b>Internal Ref No</b></td>
               <td style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>
               <td style="font-size:18px"><b>File no</b></td>
               <td style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
               <td style="font-size:18px"><b>Currency</b></td>
               <td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
          </tr>
           <tr>
               <td style="font-size:18px"><b>Remarks</b></td>
               <td style="font-size:18px" colspan="5"> :<? echo $result[csf('remarks')]?></td>
          </tr>
             <tr>
               <td style="font-size:18px"><b>Fabric Composition</b></td>
               <td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
          </tr>

        </table>
           <?
			}
			if($cbo_fabric_source==1 || $cbo_fabric_source==2)
			{
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active!=0 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active!=0 and is_deleted =0");
						 
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 //echo $color_total.',';
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>

                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image</legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                    $path='../../';
                    }

					?>
					<td>
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
			}// if($cbo_fabric_source==1) end

	  ?>
      <br/>
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	if($cbo_fabric_source==1){
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=12 and
	d.status_active=1 and
	c.status_active!=0 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in KG</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
        <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=12  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		  /*a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				*/
			 $color_wise_wo_sql=sql_select("select  a.item_number_id as item,a.body_part_id as body_id,a.color_type_id as c_type,a.construction,a.composition,b.dia_width,b.remarks,d.fabric_color_id,a.gsm_weight,(d.fin_fab_qnty) as fin_fab_qnty,(d.grey_fab_qnty) as grey_fab_qnty,(d.rate) as rate,(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and a.job_no='".$job_no."' and 
				a.uom=12 and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				 
				foreach($color_wise_wo_sql as $row)
				{
					$fab_booking_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['fin_qty']+=$row[csf('fin_fab_qnty')];
					$fab_booking_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['grey_qty']+=$row[csf('grey_fab_qnty')];
					$fab_booking_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['amount']+=$row[csf('amount')];
					
					$fab_booking_tot_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]]['fin_qty']+=$row[csf('fin_fab_qnty')];
					$fab_booking_tot_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]]['grey_qty']+=$row[csf('grey_fab_qnty')];
					$fab_booking_tot_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]]['amount']+=$row[csf('amount')];
					
				}
				unset($color_wise_wo_sql); 
				
			$gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and
			a.id=b.pre_cost_fabric_cost_dtls_id and
			c.job_no_mst=a.job_no and
			c.id=b.color_size_table_id and
			b.po_break_down_id=d.po_break_down_id and
			b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
			a.uom=12 and
			d.status_active=1 and
			c.status_active!=0 and
			d.is_deleted=0  and
			b.cons>0
			group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
			foreach( $gmt_color_data as $gmt_color_row)
			{
				if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
					$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
				}
				$gmt_color_arr[$gmt_color_row[csf("fabric_color_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			}
			  $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=12 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			//$lapdip_no="";
			//$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			
			
			 $lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			//if($lapdip_noAll=="") echo "&nbsp;"; echo $lapdip_noAll;
			?>
            </td>
            <?
			
				
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				 
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
				
				$item=$result_fabric_description[csf('item_number_id')];
				$body_id=$result_fabric_description[csf('body_part_id')];
				$c_type_id=$result_fabric_description[csf('color_type_id')];
				$construction=$result_fabric_description[csf('construction')];
				$composition=$result_fabric_description[csf('composition')];
				$gsm_weight=$result_fabric_description[csf('gsm_weight')];
				$dia_width=$result_fabric_description[csf('dia_width')];
				$remarks=$result_fabric_description[csf('remarks')];
				$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
				
				$fin_qty=$fab_booking_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks][$fabric_color_id]['fin_qty'];
				$grey_qty=$fab_booking_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks][$fabric_color_id]['grey_qty'];
				$amount=$fab_booking_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks][$fabric_color_id]['amount'];
				
			?>
			<td width='50' align='right'>
			<?
			//if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			if($grey_qty!="")
			{
				//echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				//$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
				echo def_number_format($grey_qty,2) ;
				$total_fin_fab_qnty+=$grey_qty;
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($amount!="")
			{
			echo def_number_format($amount/$grey_qty,5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			//$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
			$amount=def_number_format($amount,2,'',0);
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
				
				$item=$result_fabric_description[csf('item_number_id')];
				$body_id=$result_fabric_description[csf('body_part_id')];
				$c_type_id=$result_fabric_description[csf('color_type_id')];
				$construction=$result_fabric_description[csf('construction')];
				$composition=$result_fabric_description[csf('composition')];
				$gsm_weight=$result_fabric_description[csf('gsm_weight')];
				$dia_width=$result_fabric_description[csf('dia_width')];
				$remarks=$result_fabric_description[csf('remarks')];
				//$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
				
				//$tot_fin_qty=$fab_booking_tot_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks]['fin_qty'];
				$tot_grey_qty=$fab_booking_tot_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks]['grey_qty'];
				//$tot_amount=$fab_booking_tot_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks]['amount'];
				
			?>
			<td width='50' align='right'><?  echo def_number_format($tot_grey_qty,2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <br/>
    <?
	}
	//===========================

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0 and
	c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Yds</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Yds)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate (Yds) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		 /* $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=27  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0  and
	c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	foreach( $gmt_color_data as $gmt_color_row)
			{
				if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
					$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
				}
			}
			 $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}
			 $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=27 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			 $lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate ,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				}
				
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);//$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{

			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>



            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	//=================================PCS
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0 and
	 c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Pcs</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Pcs)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate (Pcs) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		 /* $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=1  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0  and
	c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	foreach( $gmt_color_data as $gmt_color_row)
			{
				if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
					$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
				}
			}
			 $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}
	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=1 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			 $lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;


			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate ,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);//$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>



            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	//==========================================Mtr
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0 and
	c.status_active!=0 and

	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Mtr</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Mtr)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate (Mtr) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		/*  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=23 and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/ //issue id :6003, urmi, date :20-08-2017
		  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0  and
	c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }
		  $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=23 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate ,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);//$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>



            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}


	if($cbo_fabric_source==2){
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=12 and
	d.status_active=1 and
	d.is_deleted=0  and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in KG</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2)
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>

       </tr>
       <?

 $color_wise_wo_sql=sql_select("select  a.item_number_id as item,a.body_part_id as body_id,a.color_type_id as c_type,a.construction,a.composition,b.dia_width,b.remarks,d.fabric_color_id,a.gsm_weight,(d.fin_fab_qnty) as fin_fab_qnty,(d.grey_fab_qnty) as grey_fab_qnty,(d.rate) as rate,(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and a.job_no='".$job_no."' and 
				a.uom=12 and
				d.status_active=1 and
				d.is_deleted=0
				and c.status_active!=0
				");
				 
				foreach($color_wise_wo_sql as $row)
				{
					$fab_booking_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['fin_qty']+=$row[csf('fin_fab_qnty')];
					$fab_booking_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['grey_qty']+=$row[csf('grey_fab_qnty')];
					$fab_booking_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['amount']+=$row[csf('amount')];
					
					$fab_booking_tot_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]]['fin_qty']+=$row[csf('fin_fab_qnty')];
					$fab_booking_tot_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]]['grey_qty']+=$row[csf('grey_fab_qnty')];
					$fab_booking_tot_Qty_arr[$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('dia_width')]][$row[csf('gsm_weight')]][$row[csf('remarks')]]['amount']+=$row[csf('amount')];
					
				}
				unset($color_wise_wo_sql); 
				
		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=12  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		  	  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=12 and
	d.status_active=1 and
	d.is_deleted=0  and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }
			$poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}
	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=12 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			 
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				/*if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0  and c.status_active!=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0  and c.status_active!=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
				*/
				$item=$result_fabric_description[csf('item_number_id')];
				$body_id=$result_fabric_description[csf('body_part_id')];
				$c_type_id=$result_fabric_description[csf('color_type_id')];
				$construction=$result_fabric_description[csf('construction')];
				$composition=$result_fabric_description[csf('composition')];
				$gsm_weight=$result_fabric_description[csf('gsm_weight')];
				$dia_width=$result_fabric_description[csf('dia_width')];
				$remarks=$result_fabric_description[csf('remarks')];
				$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
				
				$fin_qty=$fab_booking_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks][$fabric_color_id]['fin_qty'];
				$grey_qty=$fab_booking_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks][$fabric_color_id]['grey_qty'];
				$amount=$fab_booking_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks][$fabric_color_id]['amount'];
				
				/*echo "select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0  and c.status_active!=0
				";*/
			?>
			<td width='50' align='right'>
			<?
			if($grey_qty!="")
			{
				echo def_number_format($grey_qty,2) ;
				$total_fin_fab_qnty+=$grey_qty;
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($amount!="")
			{
			echo def_number_format($amount/$grey_qty,5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($amount,2,'',0);
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0 and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
				
				$item=$result_fabric_description[csf('item_number_id')];
				$body_id=$result_fabric_description[csf('body_part_id')];
				$c_type_id=$result_fabric_description[csf('color_type_id')];
				$construction=$result_fabric_description[csf('construction')];
				$composition=$result_fabric_description[csf('composition')];
				$gsm_weight=$result_fabric_description[csf('gsm_weight')];
				$dia_width=$result_fabric_description[csf('dia_width')];
				$remarks=$result_fabric_description[csf('remarks')];
				//$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
				
				//$fin_qty=$fab_booking_tot_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks]['fin_qty'];
				$grey_qty=$fab_booking_tot_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks]['grey_qty'];
				//$amount=$fab_booking_Qty_arr[$item][$body_id][$c_type_id][$construction][$composition][$dia_width][$gsm_weight][$remarks][$fabric_color_id]['amount'];
				
			?>
			<td width='50' align='right'><?  echo def_number_format($grey_qty,2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')]),2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0 and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <br/>
    <?
	}
	//===========================

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0 and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Yds</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Yds)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <?
		if($cbo_fabric_source==2)
		{
			?>
            <td  rowspan="11" width="50"><p>Avg Rate (Yds) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>
            <?
		}
		?>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2) //Purchase
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>

       </tr>
       <?

		  $gmt_color_library=array();
		 /* $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=27  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		   $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0  and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }
		   $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=27 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];

			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0  and c.status_active!=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0  and c.status_active!=0
				");
				}
				
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);

			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0 and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
			  									b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0  and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0 and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Pcs</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Pcs)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Pcs)";} ?></p></td>
        <?
		if($cbo_fabric_source==2)
		{
			?>
            <td  rowspan="11" width="50"><p>Avg Rate (Pcs) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Pcs)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>
            <?
		}
		?>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2) //Purchase
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>

       </tr>
       <?


		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=1 and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		   $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0 and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }
		 $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}
			
	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=1 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			 $lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0 and c.status_active!=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0  and c.status_active!=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				                                b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0  and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0  and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0 and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Mtr</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Mtr)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>
        <?
		if($cbo_fabric_source==2)
		{
			?>
            <td  rowspan="11" width="50"><p>Avg Rate (Mtr) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>
            <?
		}
		?>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2) //Purchase
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=23 and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		   $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0  and c.status_active!=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }
		   $poId=str_replace("'","",$txt_order_no_id);
			$sql_labdip=sql_select("select c.lapdip_no,c.job_no_mst,c.color_name_id,c.po_break_down_id as po_id from wo_po_lapdip_approval_info c where c.job_no_mst='".$job_no."' and c.approval_status=3 and  c.status_active=1 and c.po_break_down_id in($poId) order by c.color_name_id ");
			foreach($sql_labdip as $row)
			{
				if($row[csf("lapdip_no")])
				{
				$labdip_arr[$row[csf("color_name_id")]].=$row[csf("lapdip_no")].',';
				$gmt_labdip_arr[$color_library[$row[csf("color_name_id")]]]=$row[csf("lapdip_no")];
				}
			}

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=23 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			 $lapdip_noAll="";
			$labdip=rtrim($labdip_arr[$color_wise_wo_result[csf("fabric_color_id")]],',');
			$lapdip_noAll=implode(",",array_unique(explode(",",$labdip)));
			
			 if($lapdip_noAll=='') 
			 {
				$gmt_color=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
				$gmt_colorArr=array_unique(explode(",",$gmt_color));
				$gmt_labdip_no='';
				foreach($gmt_colorArr as $gmColor)
				{
					if($gmt_labdip_no=='') $gmt_labdip_no=$gmt_labdip_arr[$gmColor];else  $gmt_labdip_no.=",".$gmt_labdip_arr[$gmColor];
				}
				$gmt_labdip_nos=implode(",",array_unique(explode(",",$gmt_labdip_no)));
			 	echo  $gmt_labdip_nos;
			 }
			 else 
			 { 
				 echo $lapdip_noAll;
			 }
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0  and c.status_active!=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0 and c.status_active!=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);

			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0 and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no  and a.job_no='".$job_no."' and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0  and c.status_active!=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}
	?>
        <br/>

        <?

		if($cbo_fabric_source==1 || $cbo_fabric_source==2)
		{
			$booking_po_id=str_replace("'","",$txt_order_no_id);
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id,color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by item_number_id,color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active!=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				$itemIdArr[$collar_cuff_row[csf('id')]]=$collar_cuff_row[csf('item_number_id')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											$itemId=$itemIdArr[$pre_cost_id];
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$itemId][$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$itemId][$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$itemId][$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
		?>
        <br/>


        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr align="center">
                        <td><b>Approved Instructions</b></td>

                        </tr>
                        <tr>
                        <td>
                    <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                    </td>
                    </tr>
                    </table>
                	<br />
                   <!--<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active!=0 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");



	$nameArray=sql_select("
	select
	a.id,
	a.item_number_id,
	a.costing_per,
	b.po_break_down_id,
	b.color_size_table_id,
	b.requirment,
	c.po_number
FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_po_break_down c
WHERE
	a.job_no=b.job_no and
	a.job_no=c.job_no_mst and
    a.id=b.pre_cost_fabric_cost_dtls_id and
	b.po_break_down_id=c.id and
	b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 and c.status_active!=0
	order by id");

	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
            if($result[csf("costing_per")]==1)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==2)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==3)
			{

				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==4)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==5)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0;
					$total_booking_qnty_main=0;
					$total_booking_qnty_short=0;
					$total_booking_qnty_sample=0;
					$total_tot_bok_qty=0;
					$tot_balance=0;


					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 and b.status_active!=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 and b.status_active!=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") and a.status_active!=0 group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td>
					<?
					if( $balance>0)
					{
						echo "Less Booking";
					}
					else if ($balance<0)
					{
						echo "Over Booking";
					}
					else
					{
						echo "";
					}
					?>
                    </td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>-->
                </td>

            </tr>
        </table>
       <br>
        <?
    
	 $desg_name=return_library_array( "select id, custom_designation from lib_designation", "id", "custom_designation"  );
	 $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
                <th width="50%" style="border:1px solid black;">Name/Designation</th>
                <th width="27%" style="border:1px solid black;">Approval Date</th>
                <th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')].'/'.$desg_name[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
        <br>
        <? 
		//$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
		$booking_id=return_field_value( "id", "wo_booking_mst","booking_no=$txt_booking_no");
		 $user_nameArr=return_library_array( "select id, user_name from user_passwd ", "id", "user_name"  );
		$un_pprove_reques_data_array=sql_select("select b.id,b.approval_cause,b.user_id,b.insert_date,a.cause_id from   fabric_booking_approval_cause b left join approval_cause_refusing_his a  on   b.id=a.cause_id  where b.booking_id=$booking_id and b.entry_form=7  and b.status_active=1 order by b.id");
	//	echo "select a.id,a.approval_cause,a.user_id,a.insert_date,a.cause_id from   fabric_booking_approval_cause b left join approval_cause_refusing_his a  on   b.id=a.cause_id  where b.booking_id=$booking_id and b.entry_form=7  and b.status_active=1 order by a.id";
		// 
		//echo "select a.approval_cause,a.user_id,a.insert_date from approval_cause_refusing_his a , fabric_booking_approval_cause b where b.id=a.cause_id and b.booking_id=$booking_id and b.entry_form=7 and a.approval_type=2 order by a.id";
		foreach($un_pprove_reques_data_array as $hrow)
		{
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$hrow[csf('insert_date')];
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			$causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=$hrow[csf('approval_cause')].'_'.$hrow[csf('id')];
			//$unapprove_cause_arr[$hrow[csf('approval_cause')]]['insert_date']=$hrow[csf('insert_date')];
			$causeIdArrChk[$hrow[csf('cause_id')]]=$hrow[csf('cause_id')];
		}
		$causeId=implode(",",$causeIdArrChk);
		//$un_approve_reques_data_cause_array=sql_select("select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=7 and b.approval_type=2 and b.status_active=1  order by b.id");
		//echo "select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=7 and b.approval_type=2 and b.status_active=1 and b.id not in($causeId) order by b.id";
		//echo "select a.approval_cause,a.user_id,a.insert_date from approval_cause_refusing_his a , fabric_booking_approval_cause b where b.id=a.cause_id and b.booking_id=$booking_id and b.entry_form=7 and a.approval_type=2 order by a.id";
		/*foreach($un_approve_reques_data_cause_array as $hrow)
		{
			if($causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=='')
			{
				$insert_date=$hrow[csf('insert_date')];
				if(strtotime($hrow[csf('update_date')])>0)
				{
					$insert_date=$hrow[csf('update_date')];	
				}
			
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$insert_date;
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			//$unapprove_cause_arr[$hrow[csf('approval_cause')]]['insert_date']=$hrow[csf('insert_date')];
			}
		}*/
		?>
		<table align="center" cellspacing="0" width="100%" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
                <th width="200">Rev. Date</th>
                <th width="200">Rev. By</th>
				<th>Reason of Revision</th>
			</thead>
		 <tbody>
			<?
			$i=1;
			foreach($unapprove_cause_arr as $cause=>$hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
                  <td width="30"><?=$i; ?></td>
					<td width="200"><?=$hrow[('insert_date')]; ?></td>
                    <td width="200"><?=$user_nameArr[$hrow[('user_id')]]; ?></td>
                  
					<td style="word-break:break-all"><?=$hrow[('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
            </tbody>
            
			</table>
            
        <br/>
       <?
       //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	?>

    <fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		?>

         <!--<br><br><br><br>-->
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
			echo "****".custom_file_name($txt_booking_no,$style_sting,$job_no);
		 ?>

       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();

}

if($action=="show_fabric_booking_report_print39")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		
ob_start();		
		
		?>										<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td width="100"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;"><?php echo $company_library[$cbo_company_name]; ?></td>
                            <td rowspan="3" width="250">
                                <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1)
                                {
									?>
									<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
									<br/>
									Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
                                }
                                ?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
                            if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
                            else $location="";
                            
                            foreach ($nameArray as $result)
                            {
								echo  $location_name_arr[$location];
								?>
								<!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
								Level No: <? //echo $result[csf('level_no')]?>
								Road No: <? //echo $result[csf('road_no')]; ?>
								Block No: <? //echo $result[csf('block_no')];?>
								City No: <? //echo $result[csf('city')];?>
								Zip Code: <? //echo $result[csf('zip_code')]; ?>
								Province No: <?php //echo $result[csf('province')];?>
								Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
								Email Address: <? echo $result[csf('email')];?>
								Website No: <? echo $result[csf('website')]; ?>
								<?
                            }
                            ?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:20px">
                            	<strong><?  echo "Fabric Work Order";?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
		<?
		
        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
		
        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		
        $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			 $booking_po_id=$result[csf('po_break_down_id')];

			?>
			<table width="100%" style="border:1px solid black; font-family:Arial Narrow;" >
				<tr>
					<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
					<td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
					<td width="100"><span style="font-size:16px;"><b>Dept. <? if($result[csf('product_code')] !=""){ echo " (Prod Code)";} if($result[csf('pro_sub_dep')] !=0){ echo " (Sub Dep)";} ?></b></span></td>
					<td width="110" style="font-size:16px;">:&nbsp;<?=$product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
					<td width="100"><span style="font-size:16px;"><b>Order Qty</b></span></td>
					<td width="110" style="font-size:16px;">:&nbsp;<?=$po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]]; ?></td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Garments Item</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;
						<?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?>
					</td>
					<td width="100" style="font-size:16px;"><b>Booking Release Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;
						<?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>&nbsp;&nbsp;&nbsp;</td>
					<td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
					<td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Style Des.</b></td>
					<td width="110"style="font-size:16px;" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
					<td width="100" style="font-size:16px"><b>Lead Time </b>   </td>
					<td width="110" style="font-size:16px;">:&nbsp;<?  echo rtrim($lead_time,",");?> </td>
					<td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
					<td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Supplier Name</b>   </td>
					<td width="110" style="font-size:16px;">:&nbsp;
					<?
					if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]];
					else echo $supplier_name_arr[$result[csf('supplier_id')]];
					?></td>
					<td width="100" style="font-size:16px;"><b>Febric Delivery Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
					<td width="100" style="font-size:18px"><b>Booking No </b>   </td>
					<td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
					<?
					if($db_type==0)
					{
						$last_update_date=return_field_value("max(date(update_date)) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					else
					{
						$last_update_date=return_field_value("max(to_char(update_date,'DD-MM-YYYY')) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					?>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Season</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
					<td width="100" style="font-size:16px"><b>Last Update Date</b></td>
					<td width="100" style="font-size:18px">:&nbsp;<b><? if($last_update_date!="" && $last_update_date!="0000-00-00") echo change_date_format($last_update_date);?></b></td>
					<td width="100" style="font-size:16px;"><b>Po Received Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo $po_received_date; ?></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:18px"><b>Order No</b></td>
				   <td width="110" style="font-size:18px" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
				</tr>
				<tr>
				   	<td width="100" style="font-size:16px;"><b>Shipment Date</b></td>
					<td width="110" colspan="5" style="font-size:16px;"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:16px;"><b>WO Prepared After Order Entry</b></td>
				   <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($WOPreparedAfter,',').' Days' ?></td>
				   <td width="100" style="font-size:12px;"><b>Ship.days in Hand</b></td>
				   <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($daysInHand,',').' Days'?></td>
				   <td width="100" style="font-size:12px"><b>Ex-factory status</b></td>
				   <td width="110"> :&nbsp;<? echo rtrim($shiping_status,','); ?></td>
				</tr>
			   <tr>
				   <td width="100" style="font-size:18px"><b>Internal Ref No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$grouping))); ?></b></td>
				   <td width="100" style="font-size:18px"><b>File no</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$file_no)));?></b></td>
				   <td width="100" style="font-size:18px"><b>Order Repeat No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $result[csf('order_repeat_no')];?></b></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:18px"><b>Remarks</b></td>
				   <td style="font-size:18px" colspan="3"> :<? echo $result[csf('remarks')]?></td>
				   <td width="100" style="font-size:18px"><b>Order Repeat Job No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo $result[csf('repeat_job_no')];?></b></td>
				</tr>
				<tr>
				   <td width="130" style="font-size:18px"><b>Fabric Composition</b></td>
				   <td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
				</tr>
				<tr>
				   <td width="130" style="font-size:18px"><b>Attention</b></td>
				   <td style="font-size:18px" colspan="5"> : &nbsp; <? echo $result[csf('attention')]?></td>
				</tr>
				<?php if ($sample_booking_no != '') {?>
					<tr>
						<td colspan="5" align="center">
					  <strong> <? echo "Fabric of Sample Fabric Booking No:".$sample_booking_no.", Total Fabric=".$sample_booking_qty." KG,	will be Dyed with this fabric."; ?> </strong>
						</td>
					</tr>
				<?php }?>
			</table>
			<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			<table width="100%" style="font-family:Arial Narrow;" >
                <tr>
                    <td width="800">
                        <div id="div_size_color_matrix" style="float:left; max-width:1000;">
                            <fieldset id="div_size_color_matrix" style="max-width:1000;">
                                <legend>Size and Color Breakdown</legend>
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="border:1px solid black; width:80px" align="center"><strong>Allowance %</strong></td>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style="border:1px solid black"><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="border:1px solid black; text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="200" valign="top" align="left">
                        <div id="div_size_color_matrix" style="float:left;">
							<? $rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown); ?>
                            <fieldset id="" >
                                <legend>RMG Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all">
									<?
                                    if(number_format($rmg_process_breakdown_arr[8],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[2],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[10],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[1],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[4],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[3],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[15],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[11],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
										</tr>
										<?
                                    }
                                    $gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
                                    if($gmts_pro_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                            <fieldset id="" >
                                <legend>Fabric Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;">
                                    <?
                                    if(number_format($rmg_process_breakdown_arr[6],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[12],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[5],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[13],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"> All Over Print <!-- new  breack Down 13--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[14],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[7],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dying   <!-- breack Down 7--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[0],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[9],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
										</tr>
										<?
                                    }

                                    $fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
                                    if(fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="330" valign="top" align="left">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" >
                                <legend>Image </legend>
                                <table width="310">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                </tr>
			</table>
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		<br/>
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="9" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="9" width="50"><p>Total Greige Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="9" width="50"><p>Process Loss % </p></td>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='2' >&nbsp</td>";
						else echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center" style="display:none">
                    <th colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        $determin_id=$result_fabric_description[csf('determin_id')];
                        if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
                        else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
                $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td><? echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
						<?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							?>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
							<?
                        }
                        ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "Tipu"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);
			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                  //  $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
													 $colar_excess_per=($plan_cut*$collar_ex_per)/100;//
													 //number format double usage  sumation will be problem
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

		$condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td style="display:none">Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td style="display:none"><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td style="display:none"></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;" style="display:none">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>

        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <caption> <strong style="float:left"> Y/D Details</strong></caption>
        <?
		$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
		$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row){
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
		}
		?>
            <tr>
            <th width="30"> SL</th>
            <th width="100"> Body Part</th>
            <th width="80"> Fabric Color</th>
            <th width="70"> Fabric Qty(KG)</th>
            <th width="70"> Stripe Color</th>
            <th width="70"> Stripe Measurement</th>
            <th width="70"> Stripe Uom</th>
            <th  width="70"> Qty.(KG)</th>
            <th  width="70"> Y/D Req.</th>
            </tr>
            <?
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
					?>
					<tr>
					<?
					$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <tr align="center">
        <td colspan="10"><b>Comments</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("
        select
        a.id,
        a.item_number_id,
        a.costing_per,
        b.po_break_down_id,
        b.color_size_table_id,
        b.requirment,
        c.po_number
        FROM
        wo_pre_cost_fabric_cost_dtls a,
        wo_pre_cos_fab_co_avg_con_dtls b,
        wo_po_break_down c
        WHERE
        a.job_no=b.job_no and
        a.job_no=c.job_no_mst and
        a.id=b.pre_cost_fabric_cost_dtls_id and
        b.po_break_down_id=c.id and
        b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
        order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>
       <br>

<fieldset id="div_size_color_matrix" style="max-width:1000;">
<?
//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				//$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		?>

            <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>


         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report") 
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		
		ob_start();
		
		?>										<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td width="100"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;"><?php echo $company_library[$cbo_company_name]; ?></td>
                            <td rowspan="3" width="250">
                                <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1)
                                {
									?>
									<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
									<br/>
									Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
                                }
                                ?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
                            if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
                            else $location="";
                            
                            foreach ($nameArray as $result)
                            {
								echo  $location_name_arr[$location];
								?>
								<!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
								Level No: <? //echo $result[csf('level_no')]?>
								Road No: <? //echo $result[csf('road_no')]; ?>
								Block No: <? //echo $result[csf('block_no')];?>
								City No: <? //echo $result[csf('city')];?>
								Zip Code: <? //echo $result[csf('zip_code')]; ?>
								Province No: <?php //echo $result[csf('province')];?>
								Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
								Email Address: <? echo $result[csf('email')];?>
								Website No: <? echo $result[csf('website')]; ?>
								<?
                            }
							 if($txt_booking_no!="") $quality_level=return_field_value( "quality_level", "wo_booking_mst","booking_no=$txt_booking_no");
                            ?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:20px">
                            	<strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";};  ?>
                                 </font></strong><b style="font-size: larger">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<? 
								 if($quality_level>0) echo $fbooking_order_nature[$quality_level];else echo " &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "; ?></b>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
		<?
		
        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
		
        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		
        $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			 $booking_po_id=$result[csf('po_break_down_id')];      

			?>
			<table width="100%" style="border:1px solid black; font-family:Arial Narrow;" >
				<tr>
					<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
					<td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
					<td width="100"><span style="font-size:16px;"><b>Dept. <? if($result[csf('product_code')] !=""){ echo " (Prod Code)";} if($result[csf('pro_sub_dep')] !=0){ echo " (Sub Dep)";} ?></b></span></td>
					<td width="110" style="font-size:16px;">:&nbsp;<?=$product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
					<td width="100"><span style="font-size:16px;"><b>Order Qty</b></span></td>
					<td width="110" style="font-size:16px;">:&nbsp;<?=$po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]]; ?></td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Garments Item</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;
						<?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?>
					</td>
					<td width="100" style="font-size:16px;"><b>Booking Release Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;
						<?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>&nbsp;&nbsp;&nbsp;</td>
					<td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
					<td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Style Des.</b></td>
					<td width="110"style="font-size:16px;" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
					<td width="100" style="font-size:16px"><b>Lead Time </b>   </td>
					<td width="110" style="font-size:16px;">:&nbsp;<?  echo rtrim($lead_time,",");?> </td>
					<td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
					<td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Supplier Name</b>   </td>
					<td width="110" style="font-size:16px;">:&nbsp;
					<?
					if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]];
					else echo $supplier_name_arr[$result[csf('supplier_id')]];
					?></td>
					<td width="100" style="font-size:16px;"><b>Delivery Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
					<td width="100" style="font-size:18px"><b>Booking No </b>   </td>
					<td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
					<?
					if($db_type==0)
					{
						$last_update_date=return_field_value("max(date(update_date)) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					else
					{
						$last_update_date=return_field_value("max(to_char(update_date,'DD-MM-YYYY')) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					?>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Season</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
					<td width="100" style="font-size:16px"><b>Last Update Date</b></td>
					<td width="100" style="font-size:18px">:&nbsp;<b><? if($last_update_date!="" && $last_update_date!="0000-00-00") echo change_date_format($last_update_date);?></b></td>
					<td width="100" style="font-size:16px;"><b>Po Received Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo $po_received_date; ?></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:18px"><b>Order No</b></td>
				   <td style="font-size:18px; word-break:break-all" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
				</tr>
				<tr>
				   	<td width="100" style="font-size:16px;"><b>Shipment Date</b></td>
					<td width="110" colspan="5" style="font-size:16px;"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:16px;"><b>WO Prepared After</b></td>
				   <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($WOPreparedAfter,',').' Days' ?></td>
				   <td width="100" style="font-size:12px;"><b>Ship.days in Hand</b></td>
				   <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($daysInHand,',').' Days'?></td>
				   <td width="100" style="font-size:12px"><b>Ex-factory status</b></td>
				   <td width="110"> :&nbsp;<? echo rtrim($shiping_status,','); ?></td>
				</tr>
			   <tr>
				   <td width="100" style="font-size:18px"><b>Internal Ref No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$grouping))); ?></b></td>
				   <td width="100" style="font-size:18px"><b>File no</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$file_no)));?></b></td>
				   <td width="100" style="font-size:18px"><b>Order Repeat No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $result[csf('order_repeat_no')];?></b></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:18px"><b>Remarks</b></td>
				   <td style="font-size:18px" colspan="3"> :<? echo $result[csf('remarks')]?></td>
				   <td width="100" style="font-size:18px"><b>Order Repeat Job No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo $result[csf('repeat_job_no')];?></b></td>
				</tr>
				<tr>
				   <td width="130" style="font-size:18px"><b>Fabric Composition</b></td>
				   <td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
				</tr>
				<tr>
				   <td width="130" style="font-size:18px"><b>Attention</b></td>
				   <td style="font-size:18px" colspan="5"> : &nbsp; <? echo $result[csf('attention')]?></td>
				</tr>
				<?php if ($sample_booking_no != '') {?>
					<tr>
						<td colspan="5" align="center">
					  <strong> <? echo "Fabric of Sample Fabric Booking No:".$sample_booking_no.", Total Fabric=".$sample_booking_qty." KG,	will be Dyed with this fabric."; ?> </strong>
						</td>
					</tr>
				<?php }?>
			</table>
			<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			<table width="100%" style="font-family:Arial Narrow;" >
                <tr>
                    <td width="800">
                        <div id="div_size_color_matrix" style="float:left; max-width:1000;">
                            <fieldset id="div_size_color_matrix" style="max-width:1000;">
                                <legend>Size and Color Breakdown</legend>
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style="border:1px solid black"><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="border:1px solid black; text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="200" valign="top" align="left">
                        <div id="div_size_color_matrix" style="float:left;">
							<? $rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown); ?>
                            <fieldset id="" >
                                <legend>RMG Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all">
									<?
                                    if(number_format($rmg_process_breakdown_arr[8],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[2],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[10],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[1],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[4],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[3],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[15],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[11],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
										</tr>
										<?
                                    }
                                    $gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
                                    if($gmts_pro_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                            <fieldset id="" >
                                <legend>Fabric Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;">
                                    <?
                                    if(number_format($rmg_process_breakdown_arr[6],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[12],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[5],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[13],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"> All Over Print <!-- new  breack Down 13--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[14],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[7],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dying   <!-- breack Down 7--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[0],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[9],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
										</tr>
										<?
                                    }

                                    $fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
                                    if(fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="330" valign="top" align="left">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" >
                                <legend>Image </legend>
                                <table width="310">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                </tr>
			</table>
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		<br/>
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no' and status_active=1");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='2' >&nbsp</td>";
						else echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        $determin_id=$result_fabric_description[csf('determin_id')];
                        if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
                        else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
                $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and d.status_active=1 and  d.is_deleted=0 ";// and a.uom=12
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.status_active=1  and b.status_active=1 and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td><? if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]) echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
						if($process_loss_method==1) //Markup
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
							
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_fin_fab_qnty.'*'.'100';
                        }
                        if($process_loss_method==2)
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_grey_fab_qnty.'*'.'100';
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;" title="<? echo $msg;?>">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
						<?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							?>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
							<?
                        }
                        ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $row)
			{
				$collar_cuff_percent_arr[$row[csf('body_part_type')]][$row[csf('body_part_full_name')]][$row[csf('color_number_id')]][$row[csf('gmts_sizes')]]=$row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$row[csf('body_part_type')]][$row[csf('body_part_full_name')]]=$row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$row[csf('body_part_type')]][$row[csf('body_part_full_name')]][$row[csf('size_number_id')]]=$row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$row[csf('body_part_full_name')]][$row[csf('size_number_id')]][$row[csf('item_size')]]=$row[csf('item_size')];
				$color_size_sensitive_arr[$row[csf('body_part_full_name')]][$row[csf('id')]][$row[csf('color_number_id')]][$row[csf('color_size_sensitive')]]=$row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);
			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                   // $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                   $tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
												    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		//$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, 
		sum(a.cons_qnty) as yarn_required,
		sum(b.grey_fab_qnty*a.cons_ratio/100) AS grey_req,
		 AVG (a.rate) AS rate
		    from wo_pre_cost_fab_yarn_cost_dtls a,
		  wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id order by id");
		  
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						//$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						//$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$row[csf('rate')];//$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =$row[csf('grey_req')];//($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>

        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <caption> <strong style="float:left"> Stripe Details</strong></caption>
        <?
		$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
		$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row){
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
		}
		?>
            <tr>
            <th width="30"> SL</th>
            <th width="100"> Body Part</th>
            <th width="80"> Fabric Color</th>
            <th width="70"> Fabric Qty(KG)</th>
            <th width="70"> Stripe Color</th>
            <th width="70"> Stripe Measurement</th>
            <th width="70"> Stripe Uom</th>
            <th  width="70"> Qty.(KG)</th>
            <th  width="70"> Y/D Req.</th>
            </tr>
            <?
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
					?>
					<tr>
					<?
					$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <tr align="center">
        <td colspan="10"><b>Comments</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("
        select
        a.id,
        a.item_number_id,
        a.costing_per,
        b.po_break_down_id,
        b.color_size_table_id,
        b.requirment,
        c.po_number
        FROM
        wo_pre_cost_fabric_cost_dtls a,
        wo_pre_cos_fab_co_avg_con_dtls b,
        wo_po_break_down c
        WHERE
        a.job_no=b.job_no and
        a.job_no=c.job_no_mst and
        a.id=b.pre_cost_fabric_cost_dtls_id and
        b.po_break_down_id=c.id and
        b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
        order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>
       <br>

	<fieldset id="div_size_color_matrix" style="max-width:1000;">
	<?
	//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,

								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } 
		//echo get_spacial_instruction($txt_booking_no,"97%",118);
		$mst_id=$txt_booking_no; $width="97%"; $entry_form=118;
		$html = '
	<table  width=' . $width . ' class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
	<thead>
	<tr style="border:1px solid black;">
	<th width="3%" style="border:1px solid black;">Sl</th><th width="97%" style="border:1px solid black;">Special Instruction</th>
	</tr>
	</thead>
	<tbody>';

	if ($entry_form != '') {$entry_form_con = " and entry_form=$entry_form";}

	$data_array = sql_select("select id, terms from  wo_booking_terms_condition where booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id");
	if (count($data_array) > 0) {
		$i = 0;
		foreach ($data_array as $row) {
			$i++;
			$html .= '
			<tr id="settr_1" align="" style="border:1px solid black;">
			<td style="border:1px solid black;">' . $i . '</td>
			<td style="border:1px solid black; font-weight:bold">' . $row[csf('terms')] . '</td>
			</tr>';
		}
	}

	$html .= '
	</tbody>
	</table>';
	echo $html;

			$yarn_req=sql_select("select b.id, b.mst_id, b.job_no, a.basis,a.is_approved, b.booking_no,a.requ_prefix_num from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b
			 where a.id=b.mst_id and a.entry_form=70 and b.booking_no=$txt_booking_no and b.status_active=1 and b.is_deleted=0");

			 foreach($yarn_req as $row){

				$yarn_req_arr[$row[csf('requ_prefix_num')]]=$row[csf('requ_prefix_num')];

			 }
		 ?>
        <br>
		<table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
          
		
			<tr>
				<td width="50">	SL	</td>
				<td width="250"><b>Yarn Purchase Requisition</b></td>
				<td width="400">	<?=implode(",",$yarn_req_arr);?>	</td>
			</tr>
		</table>
        

         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
       <?
	$emailBody=ob_get_contents();
	
	$user_id=$_SESSION['logic_erp']['user_id'];
		$report_cat=101;
		//$html = ob_get_contents();
		//ob_clean();
		//$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
		foreach (glob("fb*.xls") as $filename1) {
		//if( @filemtime($filename) < (time()-$seconds_old) )
		@unlink($filename1);
		}
		//---------end------------//
		$name=time();
		$filename1="fb".$user_id."_".$name.".xls";
		$create_new_doc = fopen($filename1, 'w');
		$is_created = fwrite($create_new_doc, $emailBody);
		echo "0****$filename1****$report_cat";
		
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}
if($action=="show_fabric_booking_report22")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<style>
		

		@media print {
			footer {
				position: fixed;
				bottom: 0;
				margin-top:100px;
			}

			body{
				position: absulate;
				/* height:500px; */
				top:0px;
				bottom: 100px;
			}
			
		}

		</style>
	<body>
	<div style="width:1330px" class="divhead"align="center">
		<?php
			$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
			list($nameArray_approved_row) = $nameArray_approved;
			$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
			list($nameArray_approved_date_row) = $nameArray_approved_date;
			$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
			list($nameArray_approved_comments_row) = $nameArray_approved_comments;

			
			ob_start();
		
		?>										<!--    Header Company Information         -->
			<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
				<tr>
					<td width="100"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
					<td width="1250">
						<table width="100%" cellpadding="0" cellspacing="0"  >
							<tr>
								<td align="center" style="font-size:20px;"><?php echo $company_library[$cbo_company_name]; ?></td>
								<td rowspan="3" width="250">
									<span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
									<?
									if($nameArray_approved_row[csf('approved_no')]>1)
									{
										?>
										<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
										<br/>
										Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
										<?
									}
									?>
								</td>
							</tr>
							<tr>
								<td align="center" style="font-size:14px">
								<?
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
								if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								else $location="";
								
								foreach ($nameArray as $result)
								{
									echo  $location_name_arr[$location];
									?>
									<!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
									Level No: <? //echo $result[csf('level_no')]?>
									Road No: <? //echo $result[csf('road_no')]; ?>
									Block No: <? //echo $result[csf('block_no')];?>
									City No: <? //echo $result[csf('city')];?>
									Zip Code: <? //echo $result[csf('zip_code')]; ?>
									Province No: <?php //echo $result[csf('province')];?>
									Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
									Email Address: <? echo $result[csf('email')];?>
									Website No: <? echo $result[csf('website')]; ?>
									<?
								}
								if($txt_booking_no!="") $quality_level=return_field_value( "quality_level", "wo_booking_mst","booking_no=$txt_booking_no");
								?>
								</td>
							</tr>
							<tr>
								<td align="center" style="font-size:20px">
									<strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";};  ?>
									</font></strong><b style="font-size: larger">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<? 
									if($quality_level>0) echo $fbooking_order_nature[$quality_level];else echo " &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "; ?></b>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		<?
		
        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
		
        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		
        $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			 $booking_po_id=$result[csf('po_break_down_id')];      

			?>
			<table width="100%" style="border:1px solid black; font-family:Arial Narrow; font-size:9px;" >
				<tr>
					<td colspan="6" valign="top" style="font-size:14px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
				</tr>
				<tr>
					<td width="120"><span><b>Buyer/Agent Name</b></span></td>
					<td width="110">:&nbsp;<span><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
					<td width="100"><span><b>Dept. <? if($result[csf('product_code')] !=""){ echo " (Prod Code)";} if($result[csf('pro_sub_dep')] !=0){ echo " (Sub Dep)";} ?></b></span></td>
					<td width="110">:&nbsp;<?=$product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
					<td width="100"><span><b>Order Qty</b></span></td>
					<td width="110">:&nbsp;<?=$po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]]; ?></td>
				</tr>
				<tr>
					<td width="100"><b>Garments Item</b></td>
					<td width="110">:&nbsp;
						<?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?>
					</td>
					<td width="100"><b>Booking Release Date</b></td>
					<td width="110">:&nbsp;
						<?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>&nbsp;&nbsp;&nbsp;</td>
					<td width="100"><b>Style Ref.</b>   </td>
					<td width="110">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
				</tr>
				<tr>
					<td width="100"><b>Style Des.</b></td>
					<td width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
					<td width="100"><b>Lead Time </b>   </td>
					<td width="110">:&nbsp;<?  echo rtrim($lead_time,",");?> </td>
					<td width="100"><b>Dealing Merchant</b></td>
					<td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100"><b>Supplier Name</b>   </td>
					<td width="110">:&nbsp;
					<?
					if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]];
					else echo $supplier_name_arr[$result[csf('supplier_id')]];
					?></td>
					<td width="100"><b>Delivery Date</b></td>
					<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
					<td width="100"><b>Booking No </b>   </td>
					<td width="110">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
					<?
					if($db_type==0)
					{
						$last_update_date=return_field_value("max(date(update_date)) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					else
					{
						$last_update_date=return_field_value("max(to_char(update_date,'DD-MM-YYYY')) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					?>
				</tr>
				<tr>
					<td width="100"><b>Season</b></td>
					<td width="110">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
					<td width="100"><b>Last Update Date</b></td>
					<td width="100">:&nbsp;<b><? if($last_update_date!="" && $last_update_date!="0000-00-00") echo change_date_format($last_update_date);?></b></td>
					<td width="100"><b>Po Received Date</b></td>
					<td width="110">:&nbsp;<? echo $po_received_date; ?></td>
				</tr>
				<tr>
				   <td width="100"><b>Order No</b></td>
				   <td style="font-size:12px; word-break:break-all" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
				</tr>
				<tr>
				   	<td width="100"><b>Shipment Date</b></td>
					<td width="110" colspan="5"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>
				</tr>
				<tr>
				   <td width="100"><b>WO Prepared After</b></td>
				   <td width="110"> :&nbsp;<? echo rtrim($WOPreparedAfter,',').' Days' ?></td>
				   <td width="100"><b>Ship.days in Hand</b></td>
				   <td width="110"> :&nbsp;<? echo rtrim($daysInHand,',').' Days'?></td>
				   <td width="100"><b>Ex-factory status</b></td>
				   <td width="110"> :&nbsp;<? echo rtrim($shiping_status,','); ?></td>
				</tr>
			   <tr>
				   <td width="100"><b>Internal Ref No</b></td>
				   <td width="110"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$grouping))); ?></b></td>
				   <td width="100"><b>File no</b></td>
				   <td width="110"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$file_no)));?></b></td>
				   <td width="100"><b>Order Repeat No</b></td>
				   <td width="110"> :&nbsp;<b><? echo  $result[csf('order_repeat_no')];?></b></td>
				</tr>
				<tr>
				   <td width="100"><b>Remarks</b></td>
				   <td colspan="3"> :<? echo $result[csf('remarks')]?></td>
				   <td width="100"><b>Order Repeat Job No</b></td>
				   <td width="110"> :&nbsp;<b><? echo $result[csf('repeat_job_no')];?></b></td>
				</tr>
				<tr>
				   <td width="130"><b>Fabric Composition</b></td>
				   <td colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
				</tr>
				<tr>
				   <td width="130"><b>Attention</b></td>
				   <td colspan="5"> : &nbsp; <? echo $result[csf('attention')]?></td>
				</tr>
				<?php if ($sample_booking_no != '') {?>
					<tr>
						<td colspan="5" align="center">
					  <strong> <? echo "Fabric of Sample Fabric Booking No:".$sample_booking_no.", Total Fabric=".$sample_booking_qty." KG,	will be Dyed with this fabric."; ?> </strong>
						</td>
					</tr>
				<?php }?>
			</table>
			<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			<table width="100%" style="font-family:Arial Narrow;" >
                <tr>
                    <td width="800">
                        <div id="" style="float:left; max-width:1000;">
                            <fieldset id="" style="max-width:1000;">
                                <legend style="font-size:20px">Size and Color Breakdown</legend>
                                <table  class=""  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" style="border-collapse:collapse; font-size:16px;" >
                                    <tr>
                                        <td><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style=""><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="width:80px;" align="center"><strong> Excess %</strong></td>
                                        <td style="width:130px;" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style=""><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="text-align:center;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="text-align:center;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="text-align:center;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="text-align:center;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										<tr>
										<td align="center" style="border:1px solid black ;" ><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="text-align:center;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="text-align:center;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="text-align:center;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="text-align:center;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style=""><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="text-align:center;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="text-align:center;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="text-align:center;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="text-align:center;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="200" valign="top" align="left">
                        <div id="div_size_color_matrix" style="float:left;">
							<? $rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown); ?>
                            <fieldset id="" >
                                <legend style="font-size:20px;">RMG Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
									<?
                                    if(number_format($rmg_process_breakdown_arr[8],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[8],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[2],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Chest Printing <!-- Printing % breack Down 2--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[10],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[1],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[4],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Sewing /Input<!-- Sewing % breack Down 4--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[3],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Garments Wash <!-- Washing %breack Down 3--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[15],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Gmts Finishing <!-- Washing %breack Down 3--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[11],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Others <!-- New breack Down 11--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
										</tr>
										<?
                                    }
                                    $gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
                                    if($gmts_pro_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Sub Total <!-- New breack Down 11--></td>
                                            <td align="right""><? echo number_format($gmts_pro_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                            <fieldset id="" >
                                <legend style="font-size:20px;">Fabric Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
                                    <?
                                    if(number_format($rmg_process_breakdown_arr[6],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Knitting  <!--  Knitting % breack Down 6--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[12],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Yarn Dyeing  <!--  New breack Down 12--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[5],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[13],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130""> All Over Print <!-- new  breack Down 13--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[14],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[7],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Dying   <!-- breack Down 7--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[0],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[9],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Others  <!-- Others% breack Down 9--></td>
                                            <td align="right""><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
										</tr>
										<?
                                    }

                                    $fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
                                    if(fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Sub Total  <!-- Others% breack Down 9--></td>
                                            <td align="right""><? echo number_format($fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130"">Grand Total  <!-- Others% breack Down 9--></td>
                                            <td align="right""><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="330" valign="top" align="left">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" >
                                <legend style="font-size:20px;">Image </legend>
                                <table width="310" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                </tr>
			</table>
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		<br/>
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no' and status_active=1");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="" width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2' >&nbsp</td>";
						else echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='2' >&nbsp</td>";
						else echo "<td colspan='2'>".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        $determin_id=$result_fabric_description[csf('determin_id')];
                        if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
                        else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50'>Grey</th>";
                    }
                    ?>
                </tr>
                <?
                $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.status_active=1  and b.status_active=1 and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120"><? if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]) echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center'>
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center'>
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
						if($process_loss_method==1) //Markup
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
							
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_fin_fab_qnty.'*'.'100';
                        }
                        if($process_loss_method==2)
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_grey_fab_qnty.'*'.'100';
                        }
                        ?>
                        <td align="center"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" title="<? echo $msg;?>">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center'><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
						<?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							?>
							<td width='50' align='center'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
							<?
                        }
                        ?>
                    <td align="center">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3'>".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50'style='font-size:10px;' >Rate</th><th width='50'>Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
              	  ?>
					<tr>
					
						<td  width="120" align="left">
							<?
							echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
							
							
							?>
						</td>
						<td>
							<?
							echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
							?>
						</td>
						<td  width="120" align="left">
							<?
							$lapdip_no="";
							$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
							if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
							?>
						</td>
							<?
							$total_fin_fab_qnty=0;
							$total_amount=0;
							
							foreach($nameArray_fabric_description as $result_fabric_description)
							{
							if($db_type==0)
							{
								$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
								WHERE a.job_no=b.job_no and
								a.id=b.pre_cost_fabric_cost_dtls_id and
								c.job_no_mst=a.job_no and
								c.id=b.color_size_table_id and
								b.po_break_down_id=d.po_break_down_id and
								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
								d.booking_no =$txt_booking_no and
								a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
								a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
								a.construction='".$result_fabric_description[csf('construction')]."' and
								a.composition='".$result_fabric_description[csf('composition')]."' and
								a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
								a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
								b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
								d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
								d.status_active=1 and
								d.is_deleted=0
								");
							}
							if($db_type==2)
							{
							
								$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
								WHERE a.job_no=b.job_no and
								a.id=b.pre_cost_fabric_cost_dtls_id and
								c.job_no_mst=a.job_no and
								c.id=b.color_size_table_id and
								b.po_break_down_id=d.po_break_down_id and
								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
								d.booking_no =$txt_booking_no and
								a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
								a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
								a.construction='".$result_fabric_description[csf('construction')]."' and
								a.composition='".$result_fabric_description[csf('composition')]."' and
								a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
								a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
								b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
								nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
								d.status_active=1 and
								d.is_deleted=0
								");
							}
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
							?>
						<td width='50' align='right'>
							<?
							if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
							{
							echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
							$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
							}
							?>
						</td>
						<td width='50' align='right'>
							<?
							if($color_wise_wo_result_qnty[csf('rate')]!="")
							{
							echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
							}
							?>
						</td>
						<td width='50' align='right'>
							<?
							$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
							if($amount!="")
							{
							echo number_format($amount,2);
							$total_amount+=$amount;
							}
							?>
						</td>
						<?
						}
						?>
						<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
						<td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
						<td align="right"><?	echo number_format($total_amount,2);?>  </td>
					</tr>
                	<?
                 }
                	?>
                <tr style=" font-weight:bold">
               		 <!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Total</strong></td>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.status_active=1 and
					d.is_deleted=0
					");
					list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
					?>
					<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
					<td width='50' align='right'> <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
					<td width='50' align='right'> <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
					<?
					}
					?>
					<td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
					<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
					<td align="right">
					<?
					echo number_format($grand_total_amount,2);
					?>
					</td>
                </tr>
                <tr style="font-weight:bold">
					<!--<td  width="120" align="left">&nbsp;</td>-->
					<th  width="120" align="left">&nbsp;</th>
					<td  width="120" align="left">&nbsp;</td>
					<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
					<?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.status_active=1 and
					d.is_deleted=0
					");
					list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
					
					?>
					<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
					<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
					<td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
					<?
					}
					?>
					<td align="right">
						<?
						$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
						echo number_format($consumption_per_unit_fab,4);
						?>
					</td>
					<td align="right">	<?	$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
							echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
						?>
					</td>
					<td align="right"><? echo number_format($consumption_per_unit_amuont,2);	?></td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);
			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
               <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 /* foreach($size_number  as $item_size=>$val)
									 { */
										?>
										<td align="center" style="border:1px solid black;font-size:10px;" ><strong><? echo implode(",", $size_number);?></strong></td>
										<?
									 /* } */
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black;font-size:10px;"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black;font-size:10px;" >
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                   // $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                   $tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
												    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center;font-size:10px;"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center;font-size:10px;"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black;font-size:10px;"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;border-collapse:collapse;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
                    <tr align="center">
                 	   <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
						<tr align="center">
							<td><? echo $i; ?></td>
							<td>
							<?
							$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
							$yarn_des.=$color_library[$row[csf('color')]]." ";
							$yarn_des.=$yarn_type[$row[csf('type_id')]];
							echo $yarn_des;
							?>
							</td>
							<td></td>
							<td></td>
							<?
							if($show_yarn_rate==1)
							{
							?>
							<td><? echo number_format($row[csf('rate')],4); ?></td>
							<?
							}
							?>
							<td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

							<td align="right">
							<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
							</tr>
							<?
							}
							?>
							<tr align="center">
							<td>Total</td>
							<td></td>
							<td></td>
							<td></td>
							<?
							if($show_yarn_rate==1)
							{
							?>
							<td></td>
							<?
							}
							?>
							<td></td>
							<td align="right"><? echo number_format($total_yarn,4); ?></td>
						</tr>
                   </table>
                </td>
                <td width="2%"></td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
				?>
                  <table  width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
                    <tr align="center">
                    	<td colspan="7"><b>Allocated Yarn</b></td>
                    </tr>
                    <tr align="center">
						<td>Sl</td>
						<td>Yarn Description</td>
						<td>Brand</td>
						<td>Lot</td>
						<td>Allocated Qty (Kg)</td>
                    </tr>
						<?
						$total_allo=0;
						$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
						$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
						$i=0;
						$total_yarn=0;
						foreach($yarn_sql_array  as $row)
						{

							$i++;
						?>
                    <tr align="center">
						<td><? echo $i; ?></td>
						<td><?	echo $item[$row[csf('item_id')]];?>	</td>
						<td><? echo $supplier[$row[csf('supplier_id')]];?></td>
						<td><?	echo $row[csf('lot')];	?></td>
						<td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
						<td>Total</td>
						<td></td>
						<td></td>
						<td></td>
						<td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                  </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px;font-size:10px;" ><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
            <tr>
                <td width="49%" valign="top">
					<?
					if(count($sql_embelishment)>0)
					{
					?>
						<table  width="100%"  border="1" cellpadding="2" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
						<tr align="center">
							<td colspan="7"><b>Embelishment (Pre Cost)</b></td>
						</tr>
						<tr align="center">
							<td>Sl</td>
							<td>Embelishment Name</td>
							<td>Embelishment Type</td>
							<td>Cons <? echo $costing_per; ?> Gmts</td>
							<td>Rate</td>
							<td>Amount</td>
						</tr>
						<?
						$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
						$i=0;
						//$total_yarn=0;
						foreach($sql_embelishment  as $row_embelishment)
						{

							$i++;
						?>
						<tr align="center">
							<td><? echo $i; ?></td>
							<td>
							<?
							echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
							?>
							</td>
							<td>
							<?
							if($row_embelishment[csf('emb_name')]==1)
							{
							echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
							}
							if($row_embelishment[csf('emb_name')]==2)
							{
							echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
							}
							if($row_embelishment[csf('emb_name')]==3)
							{
							echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
							}
							if($row_embelishment[csf('emb_name')]==4)
							{
							echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
							}
							if($row_embelishment[csf('emb_name')]==5)
							{
							echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
							}
							?>

							</td>
							<td>
							<?
							echo $row_embelishment[csf('cons_dzn_gmts')];
							?>
							</td>
							<td>
							<?
							echo $row_embelishment[csf('rate')];
							?>
							</td>

							<td>
							<?
							echo $row_embelishment[csf('amount')];
							?>
							</td>
						</tr>
						<?
						}
						?>

						</table>
						<?
					}
						?>
                </td>
                <td width="2%"> </td>
                <td width="49%" valign="top" align="center">
					<table  width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
						<tr align="center">
						<td><b>Approved Instructions</b></td>
						</tr>
						<tr>
						<td><?  echo $nameArray_approved_comments_row[csf('comments')];  ?></td>
					</tr>
					</table>
                </td>
            </tr>
        </table>
        <br/>

        <table width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
        <caption> <strong style="float:left"> Stripe Details</strong></caption>
			<?
			$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
			$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
			$result_data=sql_select($sql_stripe);
			foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			}
			?>
            <tr>
				<th width="30"> SL</th>
				<th width="100"> Body Part</th>
				<th width="80"> Fabric Color</th>
				<th width="70"> Fabric Qty(KG)</th>
				<th width="70"> Stripe Color</th>
				<th width="70"> Stripe Measurement</th>
				<th width="70"> Stripe Uom</th>
				<th  width="70"> Qty.(KG)</th>
				<th  width="70"> Y/D Req.</th>
            </tr>
				<?
				//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
					//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


				$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
				foreach($stripe_arr as $body_id=>$body_data){
					foreach($body_data as $color_id=>$color_val){
						$rowspan=count($color_val['stripe_color']);
						$composition=$stripe_arr2[$body_id][$color_id]['composition'];
						$construction=$stripe_arr2[$body_id][$color_id]['construction'];
						$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
						$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
						$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

						if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
						else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

						$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							WHERE a.job_no=b.job_no and
							a.id=b.pre_cost_fabric_cost_dtls_id and
							c.job_no_mst=a.job_no and
							c.id=b.color_size_table_id and
							b.po_break_down_id=d.po_break_down_id and
							b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
							d.booking_no =$txt_booking_no and
							a.body_part_id='".$body_id."' and
							a.color_type_id='".$color_type_id."' and
							a.construction='".$construction."' and
							a.composition='".$composition."' and
							a.gsm_weight='".$gsm_weight."' and
							$color_cond and
							d.status_active=1 and
							d.is_deleted=0
							");
							list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
						?>
					<tr>
						<?
						$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						?>
						<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
						<?
						$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
						{
							$measurement=$color_val['measurement'][$strip_color_id];
							$uom=$color_val['uom'][$strip_color_id];
							$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
							$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
				    </tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
				<tr>
					<td colspan="3">Total </td>
					<td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
					<td></td>
					<td></td>
					<td></td>
					<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
				</tr>
            </tfoot>
         </table>
        <br/>
        <table width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
			<tr align="center"><td colspan="10"><b>Comments</b></td> </tr>
			<tr align="center">
				<td>Sl</td>
				<td>Po NO</td>
				<td>Ship Date</td>
				<td>Pre-Cost Qty</td>
				<td>Mn.Book Qty</td>
				<td>Sht.Book Qty</td>
				<td>Smp.Book Qty</td>
				<td>Tot.Book Qty</td>
				<td>Balance</td>
				<td>Comments</td>
			</tr>
				<?
				$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
				$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
				if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
				if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
				$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
				$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

				$nameArray=sql_select("
				select
				a.id,
				a.item_number_id,
				a.costing_per,
				b.po_break_down_id,
				b.color_size_table_id,
				b.requirment,
				c.po_number
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_pre_cos_fab_co_avg_con_dtls b,
				wo_po_break_down c
				WHERE
				a.job_no=b.job_no and
				a.job_no=c.job_no_mst and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				b.po_break_down_id=c.id and
				b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
				order by id");

				$count=0;
				$tot_grey_req_as_pre_cost_arr=array();
				foreach ($nameArray as $result)
				{
				if (count($nameArray)>0 )
				{
				if($result[csf("costing_per")]==1)
				{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
				}
				if($result[csf("costing_per")]==2)
				{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
				}
				if($result[csf("costing_per")]==3)
				{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
				}
				if($result[csf("costing_per")]==4)
				{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
				}
				if($result[csf("costing_per")]==5)
				{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
				}
				$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
				}
				}

				$total_pre_cost=0;
				$total_booking_qnty_main=0;
				$total_booking_qnty_short=0;
				$total_booking_qnty_sample=0;
				$total_tot_bok_qty=0;
				$tot_balance=0;
				$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

				$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
				$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
				$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
			foreach($sql_data  as $row)
			{
			$col++;
			?>
			<tr align="center">
				<td><? echo $col; ?></td>
				<td><? echo $row[csf("po_number")]; ?></td>
				<td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
				<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
				<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
				<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
				<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
				<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
				<td align="right"><? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
				</td>
				<td>
				<?
				if( $balance>0)
				{
				echo "Less Booking";
				}
				else if ($balance<0)
				{
				echo "Extra Booking";
				}
				else
				{
				echo "";
				}
				?>
				</td>
			</tr>
			<?
			}
			?>
			<tfoot>
				<tr>
					<td colspan="3">Total:</td>
					<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
					<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
					<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
					<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
					<td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
					<td align="right"><? echo number_format($tot_balance,2); ?></td>
					<td></td>
				</tr>
			</tfoot>
        </table>
       <br>

		<fieldset style="max-width:1000;font-size:16px;">
			<?
			//------------------------------ Query for TNA start-----------------------------------
						$po_id_all=str_replace("'","",$txt_order_no_id);
					$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
					$tna_start_sql=sql_select( "select id,po_number_id,
									(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
									(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,

									(case when task_number=60 then task_start_date else null end) as knitting_start_date,
									(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
									(case when task_number=61 then task_start_date else null end) as dying_start_date,
									(case when task_number=61 then task_finish_date else null end) as dying_end_date,
									(case when task_number=64 then task_start_date else null end) as finishing_start_date,
									(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
									(case when task_number=84 then task_start_date else null end) as cutting_start_date,
									(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
									(case when task_number=86 then task_start_date else null end) as sewing_start_date,
									(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
									(case when task_number=110 then task_start_date else null end) as exfact_start_date,
									(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
									(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
									(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
									from tna_process_mst
									where status_active=1 and po_number_id in($po_id_all)");
					$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
					$tna_date_task_arr=array();
					foreach($tna_start_sql as $row)
					{
						if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
						{
							if($tna_fab_start=="")
							{
								$tna_fab_start=$row[csf("fab_booking_start_date")];
							}
						}


						if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
						}
						if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
						}
						if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
						}
						if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
						}

						if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
						}
						if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
						}
						if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
						}
					}

			//------------------------------ Query for TNA end-----------------------------------
			?>
			<legend style='font-size:16px;'>TNA Information</legend>
			<table width="100%" border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:16px;" >
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><strong>Order No</strong></td>
					<td colspan="2" align="center" valign="top"><strong>Yarn Receive</strong></td>
					<td colspan="2" align="center" valign="top"><strong>Knitting</strong></td>
					<td colspan="2" align="center" valign="top"><strong>Dyeing</strong></td>
					<td colspan="2" align="center" valign="top"><strong>Finish Fabric Prod.</strong></td>
					<td colspan="2" align="center" valign="top"><strong>Cutting </strong></td>
					<td colspan="2" align="center" valign="top"><strong>Sewing </strong></td>
					<td colspan="2"  align="center" valign="top"><strong>Ex-factory </strong></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><strong>Start Date</strong></td>
					<td width="85" align="center" valign="top"><strong>End Date</strong></td>
					<td width="85" align="center" valign="top"><strong>Start Date</strong></td>
					<td width="85" align="center" valign="top"><strong>End Date</strong></td>
					<td width="85" align="center" valign="top"><strong>Start Date</strong></td>
					<td width="85" align="center" valign="top"><strong>End Date</strong></td>
					<td width="85" align="center" valign="top"><strong>Start Date</strong></td>
					<td width="85" align="center" valign="top"><strong>End Date</strong></td>
					<td width="85" align="center" valign="top"><strong>Start Date</strong></td>
					<td width="85" align="center" valign="top"><strong>End Date</strong></td>
					<td width="85" align="center" valign="top"><strong>Start Date</strong></td>
					<td width="85" align="center" valign="top"><strong>End Date</strong></td>
					<td width="85" align="center" valign="top"><strong>Start Date</strong></td>
					<td width="85" align="center" valign="top"><strong>End Date</strong></td>

				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					//$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>

			</table>
        </fieldset>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" border="1" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;" >
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } 
			$mst_id=$txt_booking_no; $width="97%"; $entry_form=118;
		if ($entry_form != '') {$entry_form_con = " and entry_form=$entry_form";}
	
		$data_array = sql_select("select id, terms from  wo_booking_terms_condition where booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id");
		
				?>
		<table  width="<?=$width;?>" border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
			<thead>
				<tr style="border:1px solid black;">
					<th width="3%" >Sl</th>
					<th width="97%">Special Instruction</th>
				</tr>
			</thead>
			<tbody>
				<?php
				if (count($data_array) > 0) {
					$i = 0;
					$content="";
					foreach ($data_array as $row) {
						$content .=$row[csf('terms')];

						$i++;?>
						<tr id="settr_1" align="" style="border:1px solid black;">
							<td><?= $i ;?></td>
							<td style="font-weight:bold;"><?=$row[csf('terms')];?></td>
						</tr>
					<?
						
						}
						
					
					}
					
						
					?>
			</tbody>
		
		</table>

		<?
		
		

			$yarn_req=sql_select("select b.id, b.mst_id, b.job_no, a.basis,a.is_approved, b.booking_no,a.requ_prefix_num from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b
			 where a.id=b.mst_id and a.entry_form=70 and b.booking_no=$txt_booking_no and b.status_active=1 and b.is_deleted=0");

			 foreach($yarn_req as $row){

				$yarn_req_arr[$row[csf('requ_prefix_num')]]=$row[csf('requ_prefix_num')];

			 }
		 ?>
        <br>
		<table width="100%" border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow;border-collapse:collapse; font-size:9px;">
			<tr>
				<td width="50">	SL	</td>
				<td width="250"><b>Yarn Purchase Requisition</b></td>
				<td width="400"><?=implode(",",$yarn_req_arr);?></td>
			</tr>
		</table>
		
        
       
			</div>
    </div>
	
	
 </body>
       <?
	
			$reportBody=ob_get_contents();
			$report_signature=signature_table1(1, $cbo_company_name,"1350");
			ob_end_clean();

			$user_id=$_SESSION['logic_erp']['user_id'];
		$report_cat=100;
		//$html = ob_get_contents();
		//ob_clean();
		//$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
		foreach (glob("fb*.xls") as $filename1) {
		//if( @filemtime($filename) < (time()-$seconds_old) )
		@unlink($filename1);
		}
		//---------end------------//
		$name=time();
		$filename1="fb".$user_id."_".$name.".xls";
		$create_new_doc = fopen($filename1, 'w');
		$is_created = fwrite($create_new_doc, $reportBody);
		echo "$reportBody****$filename1****$report_cat";
			
			foreach (glob("../../../auto_mail/tmp/main_fabric_booking_v2_".$user_id.".pdf") as $filename) {			
				@unlink($filename);
			}
			
			$att_file_arr=array();
			require('../../../ext_resource/mpdf60/mpdf.php');
			$mpdf = new mPDF('', 'A4', '', '', 10, 10, 10, 35, 3, 3);	
			$mpdf->SetHTMLFooter($report_signature);
			$mpdf->WriteHTML($reportBody,2);
			$user_id=$_SESSION['logic_erp']['user_id'];
			$REAL_FILE_NAME = 'main_fabric_booking_v2_'.$user_id.'.pdf';
			$file_path='../../../auto_mail/tmp/'.$REAL_FILE_NAME;
			$mpdf->Output($file_path, 'F');
			$att_file_arr[]='../../../auto_mail/tmp/'.$REAL_FILE_NAME.'**'.$REAL_FILE_NAME;
	



	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	
	exit();
		
}

if($action=="show_fabric_booking_report21")//md mamun-11-28-2021-crm-27160
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id,brand_name from lib_buyer_brand",'id','brand_name');
	$team_leader_arr=return_library_array( "select id,team_leader_name from lib_marketing_team",'id','team_leader_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
		
        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		
        $nameArray=sql_select( "select a.company_id, a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, a.cad_eff_percent, b.job_no,b.brand_id, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks, b.team_leader, b.fit_id from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		
		$bookingcompany_id=$nameArray[0][csf('company_id')];
		$bookingbuyer_id=$nameArray[0][csf('buyer_id')];
		
		$sql_temp=sql_select("SELECT comapny_id, buyer_id, lower_limit_qty, upper_limit_qty, total as percentage FROM lib_excess_cut_slab WHERE comapny_id='$bookingcompany_id' and  buyer_id='$bookingbuyer_id' and status_active=1 and is_deleted=0 order by comapny_id, buyer_id, lower_limit_qty asc");
		$i=0;
		foreach($sql_temp  as $row)
		{
			if( $exc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]=='') $i=0;
			$exc_perc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]['limit'][$i]=$row[csf("lower_limit_qty")]."__".$row[csf("upper_limit_qty")];
			$exc_perc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]['val'][$i]=$row[csf("percentage")];
			$exc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]=1;
			//echo $i."=";
			$i++;
		}
		unset($sql_temp);
		
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(a.pub_shipment_date,a.po_received_date)";
            $group_concat_all="group_concat(a.grouping) as grouping, group_concat(a.file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(a.pub_shipment_date-a.po_received_date)";
            $group_concat_all=" listagg(cast(a.grouping as varchar2(4000)),',') within group (order by a.grouping) as grouping,
                                listagg(cast(a.file_no as varchar2(4000)),',') within group (order by a.file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select a.id, a.po_number, a.pub_shipment_date, MIN(a.pub_shipment_date) as mpub_shipment_date, MIN(a.po_received_date) as po_received_date, MIN(a.insert_date) as insert_date, a.plan_cut, a.po_quantity, a.shiping_status, $date_dif_cond as date_diff, $group_concat_all, sum(b.order_quantity) as poqtypcs from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.id in(".$po_id_all.") and b.status_active=1 and b.is_deleted=0 group by a.id, a.po_number, a.pub_shipment_date, a.plan_cut, a.po_quantity, a.shiping_status, a.po_received_date");
		//echo "select a.id, a.po_number, a.pub_shipment_date, MIN(a.pub_shipment_date) as mpub_shipment_date, MIN(a.po_received_date) as po_received_date, MIN(a.insert_date) as insert_date, a.plan_cut, a.po_quantity, a.shiping_status, $date_dif_cond as date_diff, $group_concat_all, sum(c.order_quantity) as poqtypcs from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.id in(".$po_id_all.") and b.status_active=1 and b.is_deleted=0 group by a.id, a.po_number, a.pub_shipment_date, a.plan_cut, a.po_quantity, a.shiping_status, a.po_received_date";
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('poqtypcs')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
		$sum_fin_fabqnty=sql_select("SELECT  sum(d.fin_fab_qnty) as qty	FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  
			a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on 
			b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id
			WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0");
		?>
		<div width="100%"><?
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
			$brand_id=$result[csf('brand_id')];
			$extra=explode("_",$rmg_process_breakdown);
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];      

			$a_process_loss=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[1];//+$extra[13]
			$b_process_loss=$extra[4]+$extra[3]+$extra[15];
			$tot_pro_loss=$a_process_loss+$b_process_loss;

			/*if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
			listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
			else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
			$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");*/

				//  print_r($total_fin_fabqnty);

			ob_start();
			if($brand_id>0) $brand_id_name="/".$brand_name_arr[$brand_id];else  $brand_id_name='';
			?>
			<table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td align="center" colspan="2"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='5%' width='7%' align="left"/><p style=" margin-top:2%;"><?php echo $company_library[$cbo_company_name]; 
					if(str_replace("'","",$id_approved_id) ==1){ ?>
						<span style="font-size:25px; float:right;"><strong> <font style="color:green"> <? echo "Approved"; ?> </font></strong></span> 
					 <? } ?>
			
					</p></td>
					<td align="center" width="100" colspan="2"> TEAM : &nbsp; <?=$team_leader_arr[$result[csf('team_leader')]];?></td>	
					<td align="center" width="100" colspan="2"> FIT: &nbsp; <?=$fit_list_arr[$result[csf('fit_id')]];?></td>
					<td align="center" colspan="2" width="170">FABRIC BOOKIC SHEET<br><?=str_replace("'","",$txt_booking_no);?></td>
				</tr>
		 	</table>
			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>Portal Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_received_date;?></b></td>
					<td width="150" style="font-size:16px;"><b>Job No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo trim($txt_job_no,"'"); ?></b></td>
					<td width="150" style="font-size:16px;"><b>Internal Ref</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $grouping;//implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")])));?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Prepared Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$result[csf('booking_date')];?></b></td>
					<td width="150" style="font-size:16px;"><b>Style Description</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></b></td>
                    <td width="150" style="font-size:16px;"><b>CAD Efficiency %</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $result[csf('cad_eff_percent')]; ?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Buyer / Brand </b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $buyer_name_arr[$result[csf('buyer_name')]].$brand_id_name; ?></b></td>
					<td width="150" style="font-size:16px;"><b>Order Quantity</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1;?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Style Ref. No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<? echo $result[csf('style_ref_no')];?> </b></td>
					<td width="150" style="font-size:16px;"><b>Target Input Qty.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Garments Item</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?></b></td>
					<td width="150" style="font-size:16px;"><b>Gmts  Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=number_format(($sum_fin_fabqnty[0][csf('qty')]/$po_qnty_tot1)*12,2); ?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Order No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
					<td width="150" style="font-size:16px;"><b>Cutting Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
					$target_qty=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);
					echo number_format(($sum_fin_fabqnty[0][csf('qty')]/$target_qty)*12,2);?></b></td>
				</tr>
			 </table>
			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>A) B/Input  Rej%</b></td>
					<td width="100" style="font-size:16px;"><b><b>(1)&nbsp; Fabric :&nbsp<?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Print:<?=$extra[10]+$extra[2];?>%</b></td>
					<td width="100" style="font-size:16px;"><b> (3)&nbsp; Embo :<?=$extra[1];?>%</b></td>
					<td width="100" style="font-size:16px;"></td><!--<b> (4)&nbsp; AOP :<?//=$extra[13];?>%</b>-->
					<td width="100" align="right" style="font-size:16px;"><b>Total:</b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[1];//+$extra[13]?>%</b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>B)&nbsp; A/Input Extra/Rej %</b></td>					
					<td width="100" style="font-size:16px;"><b>(1)&nbsp; Sewing:<?=$extra[4];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Wash:<?=$extra[3];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(3)&nbsp; Packing: <? echo $extra[15];  ?>%</b></td>
					<td width="100" style="font-size:16px;"><b></b></td>
					<td width="100" align="right" style="font-size:16px;"><b>Total: </b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[4]+$extra[3]+$extra[15];?>%</b></td>
				</tr>
			 </table>
			<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select min(id) as id, size_number_id, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order"); $sizeidArr=array();
			foreach($nameArray_size  as $result_size)
			{
				$sizeidArr[$result_size[csf('size_number_id')]]['size']=$result_size[csf('size_number_id')];
				$sizeidArr[$result_size[csf('size_number_id')]]['plan']+=$result_size[csf('plan_cut_qnty')];
				$sizeidArr[$result_size[csf('size_number_id')]]['po']+=$result_size[csf('order_quantity')];
			}
			unset($nameArray_size);
			?>
            <table class="rpt_table" border="1" align="left" cellpadding="0" width="100%" cellspacing="0" rules="all" >
                <tr>
                    <td style="border:1px solid black" colspan="2" width="80"><strong> Size</strong></td>										
                    <?
                    foreach($sizeidArr  as $sizeidstr=>$sizeval)
                    {
                        ?><td align="center" style="word-break:break-all" style="border:1px solid black"><strong><?=$size_library[$sizeidstr];?></strong></td>
                    <? } ?>
                    <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                </tr>
                <?
                $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                $item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
				?>
				<tr>
					<td align="left" style="border:1px solid black" width="220">C) Order Qty (Pcs)  @</td>
					<td align="left" style="border:1px solid black" width="60">100%</td>
					<?
					$color_total=0; $color_total_order=0;
					foreach($sizeidArr  as $sizeidstr=>$sizeval)
					{
						?>
						<td style="border:1px solid black; text-align:center; font-size:18px;">
						<?
						if($sizeval['plan']!= "")
						{
							echo number_format($sizeval['po'],0);
							$color_total += $sizeval['plan'];
							$color_total_order += $sizeval['po'];
							$item_grand_total+=$sizeval['plan'];
							$item_grand_total_order+=$sizeval['po'];
							$grand_total +=$sizeval['plan'];
							$grand_total_order +=$sizeval['po'];
							
							$color_size_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$sizeval['plan'];
							$color_size_order_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$sizeval['po'];
							if (array_key_exists($sizeidstr, $size_tatal))
							{
								$size_tatal[$sizeidstr]+=$sizeval['plan'];
								$size_tatal_order[$sizeidstr]+=$sizeval['po'];
							}
							else
							{
								$size_tatal[$sizeidstr]=$sizeval['plan'];
								$size_tatal_order[$sizeidstr]=$sizeval['po'];
							}
							if (array_key_exists($sizeidstr, $item_size_tatal))
							{
								$item_size_tatal[$sizeidstr]+=$sizeval['plan'];
								$item_size_tatal_order[$sizeidstr]+=$sizeval['po'];
							}
							else
							{
								$item_size_tatal[$sizeidstr]=$sizeval['plan'];
								$item_size_tatal_order[$sizeidstr]=$sizeval['po'];
							}
						}
						else echo "0";
						?>
						</td>
						<?
					}
					?>
					<td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
				</tr>
                <tr>
                    <td align="left" style="border:1px solid black" width="220">D) Cutting Qty (A+B+C) @ </td>
                    <td align="left" style="border:1px solid black" width="60"><?=100+$tot_pro_loss;?>%</td>
                    <?
                    $color_total=0; $color_total_order=0;
                   foreach($sizeidArr  as $sizeidstr=>$sizeval)
                    {
						?>
						<td style="border:1px solid black; text-align:center; font-size:18px;">
						<?
						if($sizeval['plan']!= "")
						{
							echo number_format($sizeval['po']*((100+$tot_pro_loss)/100),0);
							$color_total += $sizeval['plan']*((100+$tot_pro_loss)/100) ;
							$color_total_order += $sizeval['po']*((100+$tot_pro_loss)/100) ;
							$item_grand_total+=$sizeval['plan']*((100+$tot_pro_loss)/100);
							$item_grand_total_order+=$sizeval['po']*((100+$tot_pro_loss)/100);
						
							
							$color_size_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$sizeval['plan']*((100+$tot_pro_loss)/100);
							$color_size_order_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$sizeval['po']*((100+$tot_pro_loss)/100);
							if (array_key_exists($sizeidstr, $size_tatal))
							{
								$size_tatal[$sizeidstr]+=$sizeval['plan']*((100+$tot_pro_loss)/100);
								$size_tatal_order[$sizeidstr]+=$sizeval['po']*((100+$tot_pro_loss)/100);
							}
							else
							{
								$size_tatal[$sizeidstr]=$sizeval['plan']*((100+$tot_pro_loss)/100);
								$size_tatal_order[$sizeidstr]=$sizeval['po']*((100+$tot_pro_loss)/100);
							}
							if (array_key_exists($sizeidstr, $item_size_tatal))
							{
								$item_size_tatal[$sizeidstr]+=$sizeval['plan']*((100+$tot_pro_loss)/100);
								$item_size_tatal_order[$sizeidstr]+=$sizeval['po']*((100+$tot_pro_loss)/100);
							}
							else
							{
								$item_size_tatal[$sizeidstr]=$sizeval['plan']*((100+$tot_pro_loss)/100);
								$item_size_tatal_order[$sizeidstr]=$sizeval['po']*((100+$tot_pro_loss)/100);
							}
						}
						else echo "0";
						?>
						</td>
						<?
                    }
                    ?>
                    <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                </tr>
                <tr>
                    <td align="left" style="border:1px solid black" width="220">Target Input Qty. (D-A) @ &nbsp;&nbsp; </td>
                    <td align="left" style="border:1px solid black" width="60"><?=(100+$tot_pro_loss)-$a_process_loss;?>%</td>
                    <?
                    $target_input_loss=(100+$tot_pro_loss)-$a_process_loss;
                    $color_total=0; $color_total_order=0;
                    foreach($sizeidArr  as $sizeidstr=>$sizeval)
                    {
						?>
						<td style="border:1px solid black; text-align:center; font-size:18px;">
						<?
						if($sizeval['plan']!= "")
						{
							echo number_format($sizeval['po']*($target_input_loss/100),0);
							$color_total += $sizeval['plan']*($target_input_loss/100) ;
							$color_total_order += $sizeval['po']*($target_input_loss/100) ;
							$item_grand_total+=$sizeval['plan']*($target_input_loss/100);
							$item_grand_total_order+=$sizeval['po']*($target_input_loss/100);
						
							
							$color_size_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$sizeval['plan']*($target_input_loss/100);
							$color_size_order_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$sizeval['po']*($target_input_loss/100);
							if (array_key_exists($sizeidstr, $size_tatal))
							{
								$size_tatal[$sizeidstr]+=$sizeval['plan']*($target_input_loss/100);
								$size_tatal_order[$sizeidstr]+=$sizeval['po']*($target_input_loss/100);
							}
							else
							{
								$size_tatal[$sizeidstr]=$sizeval['plan']*($target_input_loss/100);
								$size_tatal_order[$sizeidstr]=$sizeval['po']*($target_input_loss/100);
							}
							if (array_key_exists($sizeidstr, $item_size_tatal))
							{
								$item_size_tatal[$sizeidstr]+=$sizeval['plan']*($target_input_loss/100);
								$item_size_tatal_order[$sizeidstr]+=$sizeval['po']*($target_input_loss/100);
							}
							else
							{
								$item_size_tatal[$sizeidstr]=$sizeval['plan']*($target_input_loss/100);
								$item_size_tatal_order[$sizeidstr]=$sizeval['po']*($target_input_loss/100);
							}
						}
						else echo "0";
						?>
						</td>
						<?
                    }
                    ?>
                    <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                </tr>
            </table>
			<?
		}
		// if($cbo_fabric_source==1) end
		//die;
		
      	// Here will be the main portion  
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no' and status_active=1");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
		<br>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
			<tr align="center">
            	<th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">&nbsp; </th>
            </tr>
			<tr align="center">
                <th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">Fabric Details in Kg</th>
            </tr>
			<tr align="center">
                <th colspan="3" align="left">Item Name</th>
                <?
                foreach($nameArray_fabric_description  as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('item_number_id')] == "") echo "<td  colspan='3'>&nbsp</td>";
                    else echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
                }
                ?>
                <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                <td rowspan="10" width="50"><p>Process Loss % </p></td>
            </tr>
            <tr align="center">
                <th colspan="3" align="left">Body Part</th>
                <?
                foreach($nameArray_fabric_description  as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
                    else echo "<td colspan='3' style='word-break:break-all'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                }
                ?>
              
            </tr>
            <tr align="center">
                <th colspan="3" align="left">Color Type</th>
                <?
                foreach($nameArray_fabric_description  as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
                    else echo "<td  colspan='3'  style='word-break:break-all'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                }
                ?>
            </tr>
            <tr align="center">
                <th colspan="3" align="left">Fabric Construction</th>
                <?
                foreach($nameArray_fabric_description  as $result_fabric_description)
                {
                    if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
                    else echo "<td  colspan='3'  style='word-break:break-all'>". $result_fabric_description[csf('construction')]."</td>";
                }
                ?>
            </tr>
            <tr align="center">
                <th colspan="3" align="left">Yarn Composition</th>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
                    else echo "<td colspan='3'  style='word-break:break-all'>".$result_fabric_description[csf('composition')]."</td>";
                }
                ?>
            </tr>
            <tr align="center">
                <th colspan="3" align="left">GSM</th>
                <?
                foreach($nameArray_fabric_description  as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='3' style='word-break:break-all' >&nbsp</td>";
                    else echo "<td colspan='3'  style='word-break:break-all' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                }
                ?>
            </tr>
          
            <tr align="center">
                <th colspan="3" align="left">Dia/Width (Inch)</th>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
                    else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                }
                ?>
            </tr>
            <tr align="center">
                <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
                    else echo "<td colspan='3'  style='word-break:break-all' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                }
                ?>
            </tr>
             <tr align="center">
                <th   colspan="3" align="left">Remarks</th>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                    if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
                    else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('remarks')].",".$fabric_typee[$result_fabric_description[csf('remarks')]]."</td>";
                }
                ?>
            </tr>
            <tr>
                <th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
            </tr>
            <tr>
                <th width="120" align="left">Fabric Color</th>
                <th width="120" align="left">Body Color</th>
                <th width="120" align="left">Lab Dip No</th>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                    echo "<th width='50'>Finish</th><th width='50'>P.Loss</th><th width='50' >Grey</th>";
                }
                ?>
            </tr>
                <?
			   $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty, d.process_loss_percent 
 FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b,wo_po_color_size_breakdown c, wo_booking_dtls d 
  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and c.id=b.color_size_table_id  and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and  b.po_break_down_id=d.po_break_down_id and d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')].'**'.$row[csf('fabric_color_id')];
					//echo $fin_grey_color_key.'==<br>';
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['process_loss_percent'] =$row[csf('process_loss_percent')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.status_active=1  and b.status_active=1 and a.status_active=1 and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
				unset($gmt_color_data);
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
						
                        <td><? if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]) echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							//echo $fin_gray_color.'--<br>';
							
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;"><?
								if($color_wo_fin_qnty!="")
								{
									echo $fin_grey_color_qty_arr[$fin_gray_color]['process_loss_percent'];
									
								}
						  ?></td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
						if($process_loss_method==1) //Markup
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
							
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_fin_fab_qnty.'*'.'100';
                        }
                        if($process_loss_method==2)
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_grey_fab_qnty.'*'.'100';
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;" title="<? echo $msg;?>">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td>
						<td width='50' align='center' style="font-size:18px;">&nbsp;<?  //echo number_format($wo_fin_qnty,2) ;?></td>
						<td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left" title="<?=count($nameArray_fabric_description);?>" colspan="<?=count($nameArray_fabric_description)*3;?>"><strong>Consumption For: <?=$costing_per; ?></strong></td>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
				  <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
				
				$lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
					<td width="120" align="left"><?=$color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
					<td><?=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
					<td width="120" align="left">
					<?
					$lapdip_no="";
					$lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
					
					if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
					?>
					</td>
					<?
					$total_fin_fab_qnty=0;
					$total_amount=0;
					
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
					
					if($db_type==2)
					{
					
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0
					");
					}
					list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
					?>
					<td width='50' align='right'>
					<?
					if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
					{
					echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
					$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					}
					?>
					</td>
					<td width='50' align='right' >
					<?
					if($color_wise_wo_result_qnty[csf('rate')]!="")
					{
					echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
					}
					?>
					</td>
					<td width='50' align='right' >
					<?
					$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
					if($amount!="")
					{
					echo number_format($amount,2);
					$total_amount+=$amount;
					}
					?>
					</td>
					<?
					}
					?>
					<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
					<td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
					<td align="right">
					<?
					echo number_format($total_amount,2);
					
					?>
					</td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0  order by  c.size_order,e.body_part_type";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);
			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div width="100%" style="overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                   // $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                   $tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
												    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
               
                <?
            }
        }

		$condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr align="center">
                            <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
                        </tr>
                        <tr align="center">
                            <td>Sl</td>
                            <td>Yarn Description</td>
                            <td>Brand</td>
                            <td>Lot</td>
                            <?
                            if($show_yarn_rate==1)
                            {
                                ?>
                                <td>Rate</td>
                                <?
                            }
                            ?>
                            <td>Cons for <? echo $costing_per; ?> Gmts</td>
                            <td>Total (KG)</td>
                        </tr>
                        <?
                        $i=0;
                        $total_yarn=0;
                        foreach($yarn_sql_array  as $row)
                        {
    
                            $i++;
                            $rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
                            $rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
    
    
                            $rate=$rowcons_Amt/$rowcons_qnty;
                            $rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
                            ?>
                            <tr align="center">
                                <td><?=$i; ?></td>
                                <td>
                                <?
                                $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
                                $yarn_des.=$color_library[$row[csf('color')]]." ";
                                $yarn_des.=$yarn_type[$row[csf('type_id')]];
                                echo $yarn_des;
                                ?>
                                </td>
                                <td></td>
                                <td></td>
                                <?
                                if($show_yarn_rate==1)
                                {
                                    ?>
                                    <td><? echo number_format($row[csf('rate')],4); ?></td>
                                    <?
                                }
                                ?>
                                <td><?=number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>
                                <td align="right">
                                <? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                            </tr>
                            <?
                        }
                        ?>
                        <tr align="center">
                            <td>Total</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <?
                            if($show_yarn_rate==1)
                            {
                            ?>
                            <td></td>
                            <?
                            }
                            ?>
                            <td></td>
                            <td align="right"><? echo number_format($total_yarn,4); ?></td>
                        </tr>
                    </table>
                </td>
                <td width="2%"></td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
					foreach($yarn_sql_array  as $row)
                    {
						$prodIdArr[$row[csf('item_id')]]=$row[csf('item_id')];
					}
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr align="center">
                            <td colspan="7"><b>Allocated Yarn</b></td>
                        </tr>
                        <tr align="center">
                            <td>SL</td>
                            <td>Yarn Description</td>
                            <td>Brand</td>
                            <td>Lot</td>
                            <td>Allocated Qty (Kg)</td>
                        </tr>
                        <?
                        $total_allo=0;
                        $item=return_library_array( "select id, product_name_details from   product_details_master where id in(".implode(',',$prodIdArr).")",'id','product_name_details');
                        $supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
                        $i=0;
                        $total_yarn=0;
                        foreach($yarn_sql_array  as $row)
                        {
                            $i++;
                            ?>
                            <tr align="center">
                                <td><? echo $i; ?></td>
                                <td><?=$item[$row[csf('item_id')]]; ?></td>
                                <td><?=$supplier[$row[csf('supplier_id')]]; ?></td>
                                <td><?=$row[csf('lot')]; ?></td>
                                <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                            </tr>
                            <?
                        }
                        ?>
                        <tr align="center">
                            <td>Total</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td align="right"><? echo number_format($total_allo,4); ?></td>
                        </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
		<div id="div_size_color_matrix" style="float:left; max-width:1000;">
            <fieldset id="div_size_color_matrix" style="max-width:1000;">
            <legend>Size and Color Breakdown</legend>
            <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                <tr>
                    <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                    <td style="border:1px solid black"><strong>Color/Size</strong></td>
                <?
                    foreach($sizeidArr  as $sizeidstr=>$sizeval)
                    {	     
                        ?><td align="center" style="border:1px solid black"><strong><? echo $size_library[$sizeidstr];?></strong></td>
                <?	}    ?>
                    <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                    <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                    <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                </tr>
                <?
                $nameArray_color_size_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, plan_cut_qnty as plan_cut_qnty, order_quantity as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  status_active=1 and is_deleted =0");
                
                $itemColorSizeQtyArr=array();
                foreach($nameArray_color_size_qnty as $qrow)
                {
                    $itemColorSizeQtyArr[$qrow[csf('item_number_id')]][$qrow[csf('color_number_id')]][$qrow[csf('size_number_id')]]['plan']+=$qrow[csf('plan_cut_qnty')];
                    $itemColorSizeQtyArr[$qrow[csf('item_number_id')]][$qrow[csf('color_number_id')]][$qrow[csf('size_number_id')]]['po']+=$qrow[csf('order_quantity')];
                }
                unset($nameArray_color_size_qnty);
                
                $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                for($c=0;$c<count($gmts_item); $c++)
                {
                $item_size_tatal=array(); $item_size_tatal_order=array();
                $item_grand_total=0; $item_grand_total_order=0;
                $nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
                $r=1;
                foreach($nameArray_color as $result_color)
                {
                ?>
                <tr>
                    <? if($r==1){?>
                    <td style="border:1px solid black" rowspan="<?=count($nameArray_color);?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
                    <? $r++; } ?>
                    <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                    <?
                    $color_total=0;
                    $color_total_order=0;

                    foreach($sizeidArr  as $sizeidstr=>$sizeval)
                    {
                    /*$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
                    foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                    {*/
                    $colorsizeplanqty=$colorsizepoqty=0;
                    $colorsizeplanqty=$itemColorSizeQtyArr[$gmts_item[$c]][$result_color[csf('color_number_id')]][$sizeidstr]['plan'];
                    $colorsizepoqty=$itemColorSizeQtyArr[$gmts_item[$c]][$result_color[csf('color_number_id')]][$sizeidstr]['po'];
                    ?>
                        <td style="border:1px solid black; text-align:right">
                        <?
                            if($colorsizeplanqty!= "")
                            {
                                 echo number_format($colorsizepoqty,0);
                                 $color_total += $colorsizeplanqty;
                                 $color_total_order +=$colorsizepoqty;
                                 $item_grand_total+=$colorsizeplanqty;
                                 $item_grand_total_order+=$colorsizepoqty;
                                 $grand_total +=$colorsizeplanqty;
                                 $grand_total_order +=$colorsizepoqty;

                                 $color_size_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$colorsizeplanqty;
                                 $color_size_order_qnty_array[$sizeidstr][$result_color[csf('color_number_id')]]=$colorsizepoqty;
                                 if (array_key_exists($sizeidstr, $size_tatal))
                                 {
                                        $size_tatal[$sizeidstr]+=$colorsizeplanqty;
                                        $size_tatal_order[$sizeidstr]+=$colorsizepoqty;
                                 }
                                 else
                                 {
                                    $size_tatal[$sizeidstr]=$colorsizeplanqty;
                                    $size_tatal_order[$sizeidstr]=$colorsizepoqty;
                                 }
                                 if (array_key_exists($sizeidstr, $item_size_tatal))
                                 {
                                        $item_size_tatal[$sizeidstr]+=$colorsizeplanqty;
                                        $item_size_tatal_order[$sizeidstr]+=$colorsizepoqty;
                                 }
                                 else
                                 {
                                    $item_size_tatal[$sizeidstr]=$colorsizeplanqty;
                                    $item_size_tatal_order[$sizeidstr]=$colorsizepoqty;
                                 }
                            }
                            else echo "0";
                         ?>
                        </td>
                    <? //}
                    }
                    ?>
                      <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>
                     <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                     </td>
                    <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                </tr>
                <?
                }
                }
                ?>
                <tr>
                    <td style="border:1px solid black; text-align:right"></td>
                    <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                    <?
                    $grand_total_order=0;$grand_total=0;
                    foreach($sizeidArr  as $sizeidstr=>$sizeval)
                    {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$sizeidstr];  ?></td>
                        <?
                        $grand_total_order+=$size_tatal_order[$sizeidstr];
                        $grand_total+=$size_tatal[$sizeidstr];
                    }
                    ?>
                    <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                    <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                    <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                </tr>
            </table>
            </fieldset>
        </div>
        <br/>
		<div width="100%">
		<?
			$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
			$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
			$result_data=sql_select($sql_stripe);
			foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			}
			if(count($stripe_arr)>0){
			?>
        <table width="55%"  border="1" style="float:left" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
			 <tr>
				<th colspan="9"> <strong style="float:left"> Stripe Details</strong></th>
            </tr>
            <tr>
				<th width="30"> SL</th>
				<th width="100"> Body Part</th>
				<th width="80"> Fabric Color</th>
				<th width="70"> Fabric Qty(KG)</th>
				<th width="70"> Stripe Color</th>
				<th width="70"> Stripe Measurement</th>
				<th width="70"> Stripe Uom</th>
				<th  width="70"> Qty.(KG)</th>
				<th  width="70"> Y/D Req.</th>
            </tr>
            <?
			if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
			$color_wise_wo_sql_qnty=sql_select("select a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					d.status_active=1 and
					d.is_deleted=0");
			$colorWiseBookQtyArr=array();
			foreach($color_wise_wo_sql_qnty as $brow){
				$colorWiseBookQtyArr[$brow[csf('body_part_id')]][$brow[csf('color_type_id')]][$brow[csf('construction')]][$brow[csf('composition')]][$brow[csf('gsm_weight')]][$brow[csf('fabric_color_id')]]['gqty']+=$brow[csf('grey_fab_qnty')];
				$colorWiseBookQtyArr[$brow[csf('body_part_id')]][$brow[csf('color_type_id')]][$brow[csf('construction')]][$brow[csf('composition')]][$brow[csf('gsm_weight')]][$brow[csf('fabric_color_id')]]['fqty']+=$brow[csf('fin_fab_qnty')];
			}
			unset($color_wise_wo_sql_qnty);
			
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
					?>
					<tr>
					<?
					$color_qty=$colorWiseBookQtyArr[$body_id][$color_type_id][$construction][$composition][$gsm_weight][$color_id]['gqty'];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$colorWiseBookQtyArr[$body_id][$color_type_id][$construction][$composition][$gsm_weight][$color_id]['gqty'];
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
			<?
			/*$condition= new condition();
			if(str_replace("'","",$job_no) !=''){
				$condition->job_no("='$job_no'");
			}
			$condition->init();
			$cos_per_arr=$condition->getCostingPerArr();
			$yarn= new yarn($condition);
	
			//$yarn_data_array=$yarn->getOrderCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
			$yarn_data_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnQtyArray();
	
			$yarn_data_amt_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnAmountArray();
	
			$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
			$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");*/
		
	
			
			} //Stripe End
			$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
			$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_no=$txt_booking_no and a.qty>0 and a.status_active=1 and b.status_active=1 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
			
			if(count($sql_data)>0)
			{
				?>
				<table width="40%"  border="1" cellpadding="0" style="float:left;margin-left:5px; margin-bottom:10px;" cellspacing="0" class="rpt_table" rules="all">
                    <tr>
                        <th colspan="6"> <strong style="float:left"> Dyes To Match</strong></th>
                    </tr>
					<tr align="center">
						<td>Sl</td>
						<td>Item</td>
						<td>Body Color</td>
						<td>Item Color</td>
						<td>Finish Qty.</td>
						<td>UOM</td>
					</tr>
					<?
					foreach($sql_data  as $row)
					{
						$co++;
						?>
						<tr>
							<td><? echo $co; ?></td>
							<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
							<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
							<td><? echo $color_library[$row[csf('item_color')]];?></td>
							<td align="right"><? echo $row[csf('qty')];?></td>
							<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
						</tr>
						<?
					}
					?>
				</table>
				<?
			}
			?>
		</div>
        <br/>
	<div width="100%">
	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
	$tna_start_sql=sql_select( "select id,po_number_id,
					(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
					(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,

					(case when task_number=60 then task_start_date else null end) as knitting_start_date,
					(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
					(case when task_number=61 then task_start_date else null end) as dying_start_date,
					(case when task_number=61 then task_finish_date else null end) as dying_end_date,
					(case when task_number=64 then task_start_date else null end) as finishing_start_date,
					(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
					(case when task_number=84 then task_start_date else null end) as cutting_start_date,
					(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
					(case when task_number=86 then task_start_date else null end) as sewing_start_date,
					(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
					(case when task_number=110 then task_start_date else null end) as exfact_start_date,
					(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
					(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
					(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
					from tna_process_mst
					where status_active=1 and po_number_id in($po_id_all)");
	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}


		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}

		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_date_task_arr)>0){
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000;margin-top:10%;">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
		
        </fieldset>
		<?php
				}?>
		</div>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } 
		//echo get_spacial_instruction($txt_booking_no,"97%",118);
		$mst_id=$txt_booking_no; $width="100%"; $entry_form=118;
		
			if ($entry_form != '') {$entry_form_con = " and entry_form=$entry_form";}
			//echo "select id, terms from  wo_booking_terms_condition where   booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id";
			$data_array = sql_select("select id, terms from  wo_booking_terms_condition where   booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id asc");
			$tot_row=count($data_array)/2;
			//echo $tot_row;
			$k=1;
			foreach($data_array as $row)
			{
				if($k<=$tot_row)
				{
				$term_bookingArr[$row[csf('id')]]['terms']=$row[csf('terms')];
				}
				else
				{
				$other_term_bookingArr[$row[csf('id')]]['terms']=$row[csf('terms')];	
				}
				$k++;
			}
			
if (count($data_array) > 0) {
		?>
        <br>
        <table align="left"  width="<?=$width;?>" align="center"   border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <td valign="top">
        
        <table   width="650" class="rpt_table"   align="center"  border="1" cellpadding="0" cellspacing="0" rules="all">
        <thead>
            <tr style="border:1px solid black;">
            <th width="3%" style="border:1px solid black;">Sl</th>
            <th width="45%" style="border:1px solid black;">Special Instruction</th>
            </tr>
        </thead>
        <tbody>
		<?
		
			//print_r($term_bookingArr);
		$sl=1;
				foreach ($term_bookingArr as $term=>$row) {
					?>
					<tr id="settr_1" align="" style="border:1px solid black;">
					<td align="center" style="border:1px solid black;text-align:center"><?=$sl;?></td>
				   <td style="border:1px solid black; font-weight:bold"><?=$row['terms'];?></td>
					<?
					$sl++;
					}
				
		?>
	</tbody>
	</table>
    </td>
    <!--1st part end-->
    <?
	$sl2=$sl;
    if (count($other_term_bookingArr) > 0) {
	?>
		<td valign="top">
        	<table  width="650" class="rpt_table"   align="center"  border="1" cellpadding="0" cellspacing="0" rules="all">
        <thead>
            <tr style="border:1px solid black;">
            <th width="3%" style="border:1px solid black;" >Sl</th>
            <th width="45%" style="border:1px solid black;">Special Instruction</th>
            </tr>
        </thead>
        <tbody>
		<?
				foreach ($other_term_bookingArr as $term2=>$row2) {
					?>
					<tr id="settr_2" align="" style="border:1px solid black;">
					<td align="center" style="border:1px solid black; text-align:center"><?=$sl2;?></td>
				   <td style="border:1px solid black; font-weight:bold"><?=$row2['terms'];?></td>
					<?
					$sl2++;
					}
				
		?>
	</tbody>
	</table>
    
        </td> 
        <?
	}
		?>   
    </tr>
    </table>
    <?
}
	?>	
    

        

         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
	   </div>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report21_back")//md mamun-11-28-2021-crm-27160
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id,brand_name from lib_buyer_brand",'id','brand_name');
	$team_leader_arr=return_library_array( "select id,team_leader_name from lib_marketing_team",'id','team_leader_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
		
        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		
        $nameArray=sql_select( "select a.company_id, a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, a.cad_eff_percent, b.job_no,b.brand_id, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks, b.team_leader, b.fit_id from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		
		$bookingcompany_id=$nameArray[0][csf('company_id')];
		$bookingbuyer_id=$nameArray[0][csf('buyer_id')];
		
		$sql_temp=sql_select("SELECT comapny_id, buyer_id, lower_limit_qty, upper_limit_qty, total as percentage FROM lib_excess_cut_slab WHERE comapny_id='$bookingcompany_id' and  buyer_id='$bookingbuyer_id' and status_active=1 and is_deleted=0 order by comapny_id, buyer_id, lower_limit_qty asc");
		$i=0;
		foreach($sql_temp  as $row)
		{
			if( $exc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]=='') $i=0;
			$exc_perc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]['limit'][$i]=$row[csf("lower_limit_qty")]."__".$row[csf("upper_limit_qty")];
			$exc_perc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]['val'][$i]=$row[csf("percentage")];
			$exc[$row[csf("comapny_id")]][$row[csf("buyer_id")]]=1;
			//echo $i."=";
			$i++;
		}
		unset($sql_temp);
		
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(a.pub_shipment_date,a.po_received_date)";
            $group_concat_all="group_concat(a.grouping) as grouping, group_concat(a.file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(a.pub_shipment_date-a.po_received_date)";
            $group_concat_all=" listagg(cast(a.grouping as varchar2(4000)),',') within group (order by a.grouping) as grouping,
                                listagg(cast(a.file_no as varchar2(4000)),',') within group (order by a.file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select a.id, a.po_number, a.pub_shipment_date, MIN(a.pub_shipment_date) as mpub_shipment_date, MIN(a.po_received_date) as po_received_date, MIN(a.insert_date) as insert_date, a.plan_cut, a.po_quantity, a.shiping_status, $date_dif_cond as date_diff, $group_concat_all, sum(b.order_quantity) as poqtypcs from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.id in(".$po_id_all.") and b.status_active=1 and b.is_deleted=0 group by a.id, a.po_number, a.pub_shipment_date, a.plan_cut, a.po_quantity, a.shiping_status, a.po_received_date");
		//echo "select a.id, a.po_number, a.pub_shipment_date, MIN(a.pub_shipment_date) as mpub_shipment_date, MIN(a.po_received_date) as po_received_date, MIN(a.insert_date) as insert_date, a.plan_cut, a.po_quantity, a.shiping_status, $date_dif_cond as date_diff, $group_concat_all, sum(c.order_quantity) as poqtypcs from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.id in(".$po_id_all.") and b.status_active=1 and b.is_deleted=0 group by a.id, a.po_number, a.pub_shipment_date, a.plan_cut, a.po_quantity, a.shiping_status, a.po_received_date";
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('poqtypcs')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		?>
		<div width="100%"><?
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
			$brand_id=$result[csf('brand_id')];
			$extra=explode("_",$rmg_process_breakdown);
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];      

			$a_process_loss=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[1];//+$extra[13]
			$b_process_loss=$extra[4]+$extra[3]+$extra[15];
			$tot_pro_loss=$a_process_loss+$b_process_loss;

			$sum_fin_fabqnty=sql_select("SELECT  sum(d.fin_fab_qnty) as qty	FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  
			a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on 
			b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id
			WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0");

			if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
			listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
			else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
			$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				//  print_r($total_fin_fabqnty);

			ob_start();
			if($brand_id>0) $brand_id_name="/".$brand_name_arr[$brand_id];else  $brand_id_name='';
			?>
			<table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td align="center" colspan="2"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='5%' width='7%' align="left"/><p style=" margin-top:2%;"><?php echo $company_library[$cbo_company_name]; 
					if(str_replace("'","",$id_approved_id) ==1){ ?>
						<span style="font-size:25px; float:right;"><strong> <font style="color:green"> <? echo "Approved"; ?> </font></strong></span> 
					 <? } ?>
			
					</p></td>
					<td align="center" width="100" colspan="2"> TEAM : &nbsp; <?=$team_leader_arr[$result[csf('team_leader')]];?></td>	
					<td align="center" width="100" colspan="2"> FIT: &nbsp; <?=$fit_list_arr[$result[csf('fit_id')]];?></td>
					<td align="center" colspan="2" width="170">FABRIC BOOKIC SHEET<br><?=str_replace("'","",$txt_booking_no);?></td>
				</tr>
		 	</table>
			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>Portal Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_received_date;?></b></td>
					<td width="150" style="font-size:16px;"><b>Job No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo trim($txt_job_no,"'"); ?></b></td>
					<td width="150" style="font-size:16px;"><b>Internal Ref</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")])));?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Prepared Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$result[csf('booking_date')];?></b></td>
					<td width="150" style="font-size:16px;"><b>Style Description</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></b></td>
                    <td width="150" style="font-size:16px;"><b>CAD Efficiency %</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $result[csf('cad_eff_percent')]; ?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Buyer / Brand </b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $buyer_name_arr[$result[csf('buyer_name')]].$brand_id_name; ?></b></td>
					<td width="150" style="font-size:16px;"><b>Order Quantity</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1;?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Style Ref. No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<? echo $result[csf('style_ref_no')];?> </b></td>
					<td width="150" style="font-size:16px;"><b>Target Input Qty.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Garments Item</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?></b></td>
					<td width="150" style="font-size:16px;"><b>Gmts  Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=number_format(($sum_fin_fabqnty[0][csf('qty')]/$po_qnty_tot1)*12,2); ?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Order No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
					<td width="150" style="font-size:16px;"><b>Cutting Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
					$target_qty=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);
					echo number_format(($sum_fin_fabqnty[0][csf('qty')]/$target_qty)*12,2);?></b></td>
				</tr>
			 </table>
			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>A) B/Input  Rej%</b></td>
					<td width="100" style="font-size:16px;"><b><b>(1)&nbsp; Fabric :&nbsp<?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Print:<?=$extra[10]+$extra[2];?>%</b></td>
					<td width="100" style="font-size:16px;"><b> (3)&nbsp; Embo :<?=$extra[1];?>%</b></td>
					<td width="100" style="font-size:16px;"></td><!--<b> (4)&nbsp; AOP :<?//=$extra[13];?>%</b>-->
					<td width="100" align="right" style="font-size:16px;"><b>Total:</b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[1];//+$extra[13]?>%</b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>B)&nbsp; A/Input Extra/Rej %</b></td>					
					<td width="100" style="font-size:16px;"><b>(1)&nbsp; Sewing:<?=$extra[4];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Wash:<?=$extra[3];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(3)&nbsp; Packing: <? echo $extra[15];  ?>%</b></td>
					<td width="100" style="font-size:16px;"><b></b></td>
					<td width="100" align="right" style="font-size:16px;"><b>Total: </b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[4]+$extra[3]+$extra[15];?>%</b></td>
				</tr>
			 </table>
			<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="100%" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black" colspan="2" width="80"><strong> Size</strong></td>										
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="word-break:break-all" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                         
                                    </tr>
                                    <?
									
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                 //   for($c=0;$c<count($gmts_item); $c++)
                                 //   {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  status_active=1  ".where_con_using_array($gmts_item,1,'item_number_id')." and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0  group by color_number_id  order by color_order");
										?>
									
										<?
									//	foreach($nameArray_color as $result_color)
										//{
											?>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">C) Order Qty (Pcs)  @</td>
												<td align="left" style="border:1px solid black" width="60">100%</td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."  ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");

													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                              
											</tr>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">D) Cutting Qty (A+B+C) @ </td>
												<td align="left" style="border:1px solid black" width="60"><?=100+$tot_pro_loss;?>%</td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."   ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100),0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100) ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100) ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
														
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                              
											</tr>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">Target Input Qty. (D-A) @ &nbsp;&nbsp; </td>
												<td align="left" style="border:1px solid black" width="60"><?=(100+$tot_pro_loss)-$a_process_loss;?>%</td>
                                                <?
												$target_input_loss=(100+$tot_pro_loss)-$a_process_loss;
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."   ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100),0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100) ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100) ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
														
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                              
											</tr>
											<?
									//	}
										?>
										
										
										
										</tr>
										<?
                                   // }
                                    ?>
                                  
                                   
                                </table>
                           
                        
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no' and status_active=1");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
		<br>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
			<tr align="center">
            	<th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">&nbsp; </th>
            </tr>
			<tr align="center">
                <th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">Fabric Details in Kg</th>
            </tr>
			<tr align="center">
                    <th colspan="3" align="left">Item Name</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('item_number_id')] == "") echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
				<tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3' style='word-break:break-all'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                  
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td  colspan='3'  style='word-break:break-all'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td  colspan='3'  style='word-break:break-all'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Yarn Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all'>".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='3' style='word-break:break-all' >&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
              
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
				 <tr align="center">
                    <th   colspan="3" align="left">Remarks</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('remarks')].",".$fabric_typee[$result_fabric_description[csf('remarks')]]."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50'>P.Loss</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
               /* $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty,d.process_loss_percent FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";*/
			   $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty, d.process_loss_percent 
 FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b,wo_po_color_size_breakdown c, wo_booking_dtls d 
  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and c.id=b.color_size_table_id  and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and  b.po_break_down_id=d.po_break_down_id and d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')].'**'.$row[csf('fabric_color_id')];
					//echo $fin_grey_color_key.'==<br>';
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['process_loss_percent'] =$row[csf('process_loss_percent')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.status_active=1  and b.status_active=1 and a.status_active=1 and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
				unset($gmt_color_data);
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
						
                        <td><? if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]) echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							//echo $fin_gray_color.'--<br>';
							
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;"><?
								if($color_wo_fin_qnty!="")
								{
									echo $fin_grey_color_qty_arr[$fin_gray_color]['process_loss_percent'];
									
								}
						  ?></td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
						if($process_loss_method==1) //Markup
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
							
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_fin_fab_qnty.'*'.'100';
                        }
                        if($process_loss_method==2)
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_grey_fab_qnty.'*'.'100';
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;" title="<? echo $msg;?>">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];



						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td>
						<td width='50' align='center' style="font-size:18px;">&nbsp;<?  //echo number_format($wo_fin_qnty,2) ;?></td>
						<td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left" title="<?=count($nameArray_fabric_description);?>" colspan="<?=count($nameArray_fabric_description)*3;?>"><strong>Consumption For: <? echo $costing_per; ?></strong></td>
						<?
                      //  foreach($nameArray_fabric_description as $result_fabric_description)
                       // {
							?>
							<!--<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>-->
							<?
                       // }
                       // ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
				  <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0  order by  c.size_order,e.body_part_type";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);
			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div width="100%" style="overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                   // $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                   $tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
												    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
               
                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0   and  b.status_active=1 and b.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
					foreach($yarn_sql_array  as $row)
                    {
						$prodIdArr[$row[csf('item_id')]]=$row[csf('item_id')];
					}
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master where id in(".implode(',',$prodIdArr).")",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
		<div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
						<td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
				
					?>
                   
                    <?
					$r=1;
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
						<? if($r==1){?>
						<td style="border:1px solid black" rowspan="<?=count($nameArray_color);?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
						<?$r++;}?>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
						
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>
 						
                    <?
					}
                    ?>
                     
                    <tr>
						<td style="border:1px solid black; text-align:right"></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						$grand_total_order=0;$grand_total=0;
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
						$grand_total_order+=$size_tatal_order[$result_size[csf('size_number_id')]];
						$grand_total+=$size_tatal[$result_size[csf('size_number_id')]];
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>





        <?
		// $sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		?>
        <!-- <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table> -->

        <br/>
		<div width="100%">
		<?
			$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
			$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
			$result_data=sql_select($sql_stripe);
			foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			}
			
			if(count($stripe_arr)>0){
			?>

        <table width="55%"  border="1" style="float:left" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
      	
		
			 <tr>
				<th colspan="9"> <strong style="float:left"> Stripe Details</strong></th>
			
            </tr>
            <tr>
				<th width="30"> SL</th>
				<th width="100"> Body Part</th>
				<th width="80"> Fabric Color</th>
				<th width="70"> Fabric Qty(KG)</th>
				<th width="70"> Stripe Color</th>
				<th width="70"> Stripe Measurement</th>
				<th width="70"> Stripe Uom</th>
				<th  width="70"> Qty.(KG)</th>
				<th  width="70"> Y/D Req.</th>
            </tr>
            <?
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
					?>
					<tr>
					<?
					$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
			

		
			<?
			/*$condition= new condition();
			if(str_replace("'","",$job_no) !=''){
				$condition->job_no("='$job_no'");
			}
			$condition->init();
			$cos_per_arr=$condition->getCostingPerArr();
			$yarn= new yarn($condition);
	
			//$yarn_data_array=$yarn->getOrderCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
			$yarn_data_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnQtyArray();
	
			$yarn_data_amt_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnAmountArray();
	
			$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
			$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");*/
		
	
			
			} //Stripe End
			$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
			$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_no=$txt_booking_no and a.qty>0 and a.status_active=1 and b.status_active=1 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
			
			if(count($sql_data)>0)
			{
				?>
			
				<table width="40%"  border="1" cellpadding="0" style="float:left;margin-left:5px; margin-bottom:10px;" cellspacing="0" class="rpt_table" rules="all">
				<tr>
				<th colspan="6"> <strong style="float:left"> Dyes To Match</strong></th>
			
            </tr>
					<tr align="center">
						<td>Sl</td>
						<td>Item</td>
						<td>Body Color</td>
						<td>Item Color</td>
						<td>Finish Qty.</td>
						<td>UOM</td>
					</tr>
					<?
					foreach($sql_data  as $row)
					{
						$co++;
						?>
						<tr>
							<td><? echo $co; ?></td>
							<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
							<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
							<td><? echo $color_library[$row[csf('item_color')]];?></td>
							<td align="right"><? echo $row[csf('qty')];?></td>
							<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
						</tr>
						<?
					}
					?>
				</table>
			
				<?
			}
			?>
				</div>
			
        <br/>
      

	<div width="100%">
	<?
	//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,

								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	
	if(count($tna_date_task_arr)>0){
	?>

	<fieldset id="div_size_color_matrix" style="max-width:1000;margin-top:10%;">

	
	
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
		
        </fieldset>
		<?php
				}?>
		</div>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } 
		//echo get_spacial_instruction($txt_booking_no,"97%",118);
		$mst_id=$txt_booking_no; $width="100%"; $entry_form=118;
		
			if ($entry_form != '') {$entry_form_con = " and entry_form=$entry_form";}
			//echo "select id, terms from  wo_booking_terms_condition where   booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id";
			$data_array = sql_select("select id, terms from  wo_booking_terms_condition where   booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id asc");
			$tot_row=count($data_array)/2;
			//echo $tot_row;
			$k=1;
			foreach($data_array as $row)
			{
				if($k<=$tot_row)
				{
				$term_bookingArr[$row[csf('id')]]['terms']=$row[csf('terms')];
				}
				else
				{
				$other_term_bookingArr[$row[csf('id')]]['terms']=$row[csf('terms')];	
				}
				$k++;
			}
			
if (count($data_array) > 0) {
		?>
        <br>
        <table align="left"  width="<?=$width;?>" align="center"   border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <td valign="top">
        
        <table   width="650" class="rpt_table"   align="center"  border="1" cellpadding="0" cellspacing="0" rules="all">
        <thead>
            <tr style="border:1px solid black;">
            <th width="3%" style="border:1px solid black;">Sl</th>
            <th width="45%" style="border:1px solid black;">Special Instruction</th>
            </tr>
        </thead>
        <tbody>
		<?
		
			//print_r($term_bookingArr);
		$sl=1;
				foreach ($term_bookingArr as $term=>$row) {
					?>
					<tr id="settr_1" align="" style="border:1px solid black;">
					<td align="center" style="border:1px solid black;text-align:center"><?=$sl;?></td>
				   <td style="border:1px solid black; font-weight:bold"><?=$row['terms'];?></td>
					<?
					$sl++;
					}
				
		?>
	</tbody>
	</table>
    </td>
    <!--1st part end-->
    <?
	$sl2=$sl;
    if (count($other_term_bookingArr) > 0) {
	?>
		<td valign="top">
        	<table  width="650" class="rpt_table"   align="center"  border="1" cellpadding="0" cellspacing="0" rules="all">
        <thead>
            <tr style="border:1px solid black;">
            <th width="3%" style="border:1px solid black;" >Sl</th>
            <th width="45%" style="border:1px solid black;">Special Instruction</th>
            </tr>
        </thead>
        <tbody>
		<?
				foreach ($other_term_bookingArr as $term2=>$row2) {
					?>
					<tr id="settr_2" align="" style="border:1px solid black;">
					<td align="center" style="border:1px solid black; text-align:center"><?=$sl2;?></td>
				   <td style="border:1px solid black; font-weight:bold"><?=$row2['terms'];?></td>
					<?
					$sl2++;
					}
				
		?>
	</tbody>
	</table>
    
        </td> 
        <?
	}
		?>   
    </tr>
    </table>
    <?
}
	?>	
    

        

         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
	   </div>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

// B10 START 
if($action=="show_fabric_booking_report10")//Print B10
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');

	//$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
		
		  if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
             else $location="";
		$sql_loc=sql_select("select id,location_name,address from lib_location where company_id=$cbo_company_name");
		foreach($sql_loc as $row)
		{
			$location_name_arr[$row[csf('id')]]= $row[csf('location_name')];
			$location_address_arr[$row[csf('id')]]= $row[csf('address')];
		}

		
ob_start();		
		
		?>										<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td width="100" style="font-size:28px"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:28px;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<?php echo $company_library[$cbo_company_name]; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</td>
                            <td>
                               
                                
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1)
                                {
									?>
									<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
									<br/>
									Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
                                }
                                ?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center">
                           &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <?
                                                      
                            echo $location_address_arr[$location];
                           ?> &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            </td>
                             <td align="center">
                              <span><b style="float:right">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?>&nbsp;&nbsp;&nbsp;</b></span>
                             </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:20px">
                            <span style="font-size:18px; float:center;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> <font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font>&nbsp;&nbsp;&nbsp;</strong></span> 
                               
                            </td>
                             <td align="center" style="font-size:20px">
                               <span style="font-size:18px; float:right"><b style=" float:right"> Location:&nbsp;&nbsp;<? echo $location_name_arr[$location]; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></span>
                             </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
		<?
		
        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
		
        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		
        $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		$order_uom=$nameArray[0][csf('order_uom')];
		
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];

			?>
			<table width="100%" style="border:1px solid black;font-size:18px; font-family:Arial Narrow;" >
				<tr>
					<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
					<td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
					<td width="100"><span style="font-size:16px;"><b>Dept. <? if($result[csf('product_code')] !=""){ echo " (Prod Code)";} if($result[csf('pro_sub_dep')] !=0){ echo " (Sub Dep)";} ?></b></span></td>
					<td width="110" style="font-size:16px;">:&nbsp;<?=$product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
					<td width="100"><span style="font-size:16px;"><b>Order Qty</b></span></td>
					<td width="110" style="font-size:16px;">:&nbsp;<?=$po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]]; ?></td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Garments Item</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;
						<?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?>
					</td>
					<td width="100" style="font-size:16px;"><b>Booking Release Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;
						<?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>&nbsp;&nbsp;&nbsp;</td>
					<td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
					<td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Style Des.</b></td>
					<td width="110"style="font-size:16px;" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
					<td width="100" style="font-size:16px"><b>Lead Time </b>   </td>
					<td width="110" style="font-size:16px;">:&nbsp;<?  echo rtrim($lead_time,",");?> </td>
					<td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
					<td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Supplier Name</b>   </td>
					<td width="110" style="font-size:16px;">:&nbsp;
					<?
					if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]];
					else echo $supplier_name_arr[$result[csf('supplier_id')]];
					?></td>
					<td width="100" style="font-size:16px;"><b>Delivery Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
					<td width="100" style="font-size:18px"><b>Booking No </b>   </td>
					<td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
					<?
					if($db_type==0)
					{
						$last_update_date=return_field_value("max(date(update_date)) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					else
					{
						$last_update_date=return_field_value("max(to_char(update_date,'DD-MM-YYYY')) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
					}
					?>
				</tr>
				<tr>
					<td width="100" style="font-size:16px;"><b>Season</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
					<td width="100" style="font-size:16px"><b>Last Update Date</b></td>
					<td width="100" style="font-size:18px">:&nbsp;<b><? if($last_update_date!="" && $last_update_date!="0000-00-00") echo change_date_format($last_update_date);?></b></td>
					<td width="100" style="font-size:16px;"><b>Po Received Date</b></td>
					<td width="110" style="font-size:16px;">:&nbsp;<? echo $po_received_date; ?></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:18px"><b>Order No</b></td>
				   <td style="font-size:18px; word-break:break-all" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
				</tr>
				<tr>
				   	<td width="100" style="font-size:16px;"><b>Shipment Date</b></td>
					<td width="110" colspan="5" style="font-size:16px;"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:16px;"><b>WO Prepared After</b></td>
				   <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($WOPreparedAfter,',').' Days' ?></td>
				   <td width="100" style="font-size:12px;"><b>Ship.days in Hand</b></td>
				   <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($daysInHand,',').' Days'?></td>
				   <td width="100" style="font-size:12px"><b>Ex-factory status</b></td>
				   <td width="110"> :&nbsp;<? echo rtrim($shiping_status,','); ?></td>
				</tr>
			   <tr>
				   <td width="100" style="font-size:18px"><b>Internal Ref No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$grouping))); ?></b></td>
				   <td width="100" style="font-size:18px"><b>File no</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$file_no)));?></b></td>
				   <td width="100" style="font-size:18px"><b>Order Repeat No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $result[csf('order_repeat_no')];?></b></td>
				</tr>
				<tr>
				   <td width="100" style="font-size:18px"><b>Remarks</b></td>
				   <td style="font-size:18px" colspan="3"> :<? echo $result[csf('remarks')]?></td>
				   <td width="100" style="font-size:18px"><b>Order Repeat Job No</b></td>
				   <td width="110" style="font-size:18px"> :&nbsp;<b><? echo $result[csf('repeat_job_no')];?></b></td>
				</tr>
				<tr>
				   <td width="130" style="font-size:18px"><b>Fabric Composition</b></td>
				   <td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
				</tr>
				<tr>
				   <td width="130" style="font-size:18px"><b>Attention</b></td>
				   <td style="font-size:18px" colspan="5"> : &nbsp; <? echo $result[csf('attention')]?></td>
				</tr>
				<?php if ($sample_booking_no != '') {?>
					<tr>
						<td colspan="5" align="center">
					  <strong> <? echo "Fabric of Sample Fabric Booking No:".$sample_booking_no.", Total Fabric=".$sample_booking_qty." KG,	will be Dyed with this fabric."; ?> </strong>
						</td>
					</tr>
				<?php }?>
			</table>
			<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			<table width="100%" style="font-family:Arial Narrow;font-size:18px" >
                <tr>
                    <td width="900">
                        <div id="div_size_color_matrix" style="float:left; max-width:1000;">
                            <fieldset id="div_size_color_matrix" style="max-width:1000;">
                                <legend>Size and Color Breakdown</legend>
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="1000" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style="border:1px solid black"><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="border:1px solid black; text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="130" valign="top" align="left">
                        <div id="div_size_color_matrix" style="float:left;">
							
                        </div>
                    </td>
                    <td width="200" valign="top" align="right">
						
                        <div id="div_size_color_matrix" style="float:right;font-size:18px;font-family:Arial Narrow;">
                           <? $rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown); ?>
                            <fieldset id="" >
                                <legend>RMG Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all">
									<?
                                    if(number_format($rmg_process_breakdown_arr[8],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[2],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[10],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[1],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[4],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[3],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[15],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[11],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
										</tr>
										<?
                                    }
                                    $gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
                                    if($gmts_pro_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                            <fieldset id="" >
                                <legend>Fabric Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;">
                                    <?
                                    if(number_format($rmg_process_breakdown_arr[6],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[12],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[5],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[13],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"> All Over Print <!-- new  breack Down 13--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[14],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[7],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dying   <!-- breack Down 7--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[0],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[9],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
										</tr>
										<?
                                    }

                                    $fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
                                    if(fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                </tr>
			</table>
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		<br/>
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			/*$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");*/
			$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			/*echo "SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width";*/
			//echo "kausar"; die;
			//avg(b.requirment) as requirment
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='2' >&nbsp</td>";
						else echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        $determin_id=$result_fabric_description[csf('determin_id')];
                        if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
                        else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per.' / '.$unit_of_measurement[$order_uom]; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
             /*   $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";*/
			  $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a , wo_pre_cos_fab_co_avg_con_dtls b , wo_po_color_size_breakdown c , wo_booking_dtls d   WHERE   a.id=b.pre_cost_fabric_cost_dtls_id and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no'   and  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0  and c.status_active=1 and  c.is_deleted=0  and a.status_active=1 and  a.is_deleted=0 ";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td><? echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Consumption For <? echo $costing_per.' / '.$unit_of_measurement[$order_uom]; ?></strong></td>
						<?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							?>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
							<?
                        }
                        ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;

		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.job_no ='$job_no' and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per.' / '.$unit_of_measurement[$order_uom]; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id as fab_id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and

                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per.' / '.$unit_of_measurement[$order_uom]; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);
			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;font-size:18px;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per.' / '.$unit_of_measurement[$order_uom]; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  style="font-size:18px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					foreach($yarn_sql_array  as $row)
                    {
						$prodIdArr[$row[csf('item_id')]]=$row[csf('item_id')];
					}
					$prodId=implode(',',$prodIdArr);
					
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master where id in($prodId)",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
                 <td width="49%" valign="top" align="center">
                	<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" >
                                <legend>Image </legend>
                                <table width="310">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
               	
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>

        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <caption> <strong style="float:left"> Stripe Details</strong></caption>
        <?
		$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
		$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row){
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
		}
		?>
            <tr>
            <th width="30"> SL</th>
            <th width="100"> Body Part</th>
            <th width="80"> Fabric Color</th>
            <th width="70"> Fabric Qty(KG)</th>
            <th width="70"> Stripe Color</th>
            <th width="70"> Stripe Measurement</th>
            <th width="70"> Stripe Uom</th>
            <th  width="70"> Qty.(KG)</th>
            <th  width="70"> Y/D Req.</th>
            </tr>
            <?
			$color_wise_wo_sql_qnty=sql_select("select  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.gmts_color_id,(d.fin_fab_qnty) as fin_fab_qnty,(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$dataArr=$row[csf('body_part_id')].'_'.$row[csf('color_type_id')].'_'.$row[csf('construction')].'_'.$row[csf('composition')].'_'.$row[csf('gsm_weight')].'_'.$row[csf('gmts_color_id')];
				$colorQtyArr[$dataArr]+=$row[csf('grey_fab_qnty')];
			}
						

			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";					
						$data_Arr=$body_id.'_'.$color_type_id.'_'.$construction.'_'.$composition.'_'.$gsm_weight.'_'.$color_id;;
					?>
					<tr>
					<?
					$color_qty=$colorQtyArr[$data_Arr];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_qty;
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b>Comments</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("
        select
        a.id,
        a.item_number_id,
        a.costing_per,
        b.po_break_down_id,
        b.color_size_table_id,
        b.requirment,
        c.po_number
        FROM
        wo_pre_cost_fabric_cost_dtls a,
        wo_pre_cos_fab_co_avg_con_dtls b,
        wo_po_break_down c
        WHERE
        a.job_no=b.job_no and
        a.job_no=c.job_no_mst and
        a.id=b.pre_cost_fabric_cost_dtls_id and
        b.po_break_down_id=c.id and
        b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
        order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and c.job_no ='$job_no' and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>
       <br>

<fieldset id="div_size_color_matrix" style="max-width:1000;">
<?
//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:17px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } echo get_spacial_instruction($txt_booking_no,"97%",118); ?>
        
        

         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

// B10 END

// B16 START 
if($action=="show_fabric_booking_report16")//Print B16
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array("select master_tble_id, image_location from common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id, brand_name from lib_buyer_brand ",'id','brand_name');
	$user_name_arr=return_library_array( "select id, user_full_name from user_passwd ",'id','user_full_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<style type="text/css">
		@media print {
		    .pagebreak { page-break-before: always; } /* page-break-after works, as well */
		}
	</style>
	<div style="width:1330px" align="center">
    <?php
    	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
		$fabric_composition=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
		
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		$max_approve_date_data = sql_select("select min(b.approved_date) as approved_date,max(b.approved_date) as last_approve_date,max(b.un_approved_date) as un_approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		//echo "select min(b.approved_date) as approved_date,max(b.approved_date) as last_approve_date,max(b.un_approved_date) from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7";
		$first_approve_date=''; $last_approve_date=''; $un_approved_date='';
		if(count($max_approve_date_data))
		{
			$last_approve_date=$max_approve_date_data[0][csf('last_approve_date')];
			$first_approve_date=$max_approve_date_data[0][csf('approved_date')];
			$un_approved_date=$max_approve_date_data[0][csf('un_approved_date')];
		}
		
		if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'"); else $location="";
		$sql_loc=sql_select("select id,location_name,address from lib_location where company_id=$cbo_company_name");
		foreach($sql_loc as $row)
		{
			$location_name_arr[$row[csf('id')]]= $row[csf('location_name')];
			$location_address_arr[$row[csf('id')]]= $row[csf('address')];
		}
		// echo "<pre>";
		// print_r($emblishment_name_array);
		// echo "</pre>";

		//[140] => WASH ENZYME SILICON
    	//[142] => Wash Hydro Tumble Dry
    	//[193] => Washing
		
		$yes_no_sql=sql_select("select job_no,cons_process from  wo_pre_cost_fab_conv_cost_dtls where job_no='$txt_job_no'  and status_active=1 and is_deleted=0  order by id");
		$peach=''; $brush=''; $fab_wash='';
		foreach ($yes_no_sql as $row) {
			
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'peach') !== false)
        	{
			    if(!empty($peach))
			    {
			    	$peach.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$peach.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brush') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brush [With Finish]') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brushing') !== false)
        	{
			    if(!empty($brush))
			    {
			    	$brush.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$brush.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'wash') !== false || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'washing') !== false)
        	{
			    if(!empty($fab_wash))
			    {
			    	$fab_wash.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$fab_wash.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'y/d') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('YD at Main Fabric Booking') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'yarn dyeing') !== false)
        	{
			    if(!empty($yd))
			    {
			    	$yd.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$yd.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'aop') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('All Over Printing'))
        	{
			    if(!empty($aop))
			    {
			    	$aop.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$aop.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
		}
		$emb_print=sql_select("select id, job_no, emb_name, emb_type from wo_pre_cost_embe_cost_dtls where  job_no='$txt_job_no' and status_active=1 and is_deleted=0 and cons_dzn_gmts>0 and emb_name in (1,2,3) order by id");
		
		//echo "select id, job_no, emb_name, emb_type from wo_pre_cost_embe_cost_dtls where emb_name!=3 and job_no='$txt_job_no' and status_active=1 and is_deleted=0 order by id";

		$emb_print_data=array();
		$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,99=>$blank_array);
		foreach ($emb_print as $row) 
		{
			$emb_print_data[$row[csf('job_no')]][$row[csf('emb_name')]].=$type_array[$row[csf("emb_name")]][$row[csf('emb_type')]].",";
		}
		// echo "<pre>";
		// print_r($emb_print_data);
		// echo "</pre>";
		//echo "select id, job_no, emb_name, emb_type from wo_pre_cost_embe_cost_dtls where emb_name!=3 and job_no='$txt_job_no' and status_active=1 and is_deleted=0 order by id";

		$nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, (b.job_quantity*b.total_set_qnty) as jobqtypcs, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.factory_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks, a.sustainability_standard, b.brand_id, a.quality_level, a.fab_material, a.requisition_no, b.qlty_label, b.packing, b.job_no, a.proceed_knitting, a.proceed_dyeing from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$job_no_str=$nameArray[0][csf('job_no')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		$delivery_date=$nameArray[0][csf('delivery_date')];
		$requisition_no=$nameArray[0][csf('requisition_no')];
		$jobqtypcs=$nameArray[0][csf('jobqtypcs')];
		
		$job_yes_no=sql_select("select id, job_id,job_no, gmts_item_id, set_item_ratio, smv_pcs, smv_set, smv_pcs_precost, smv_set_precost, complexity, embelishment, cutsmv_pcs, cutsmv_set, finsmv_pcs, finsmv_set, printseq, embro, embroseq, wash, washseq, spworks, spworksseq, gmtsdying, gmtsdyingseq, ws_id, aop, aopseq,bush,bushseq,peach,peachseq,yd,ydseq from wo_po_details_mas_set_details where job_no='$job_no_str'");

		$po_shipment_date=sql_select("select  MIN(pub_shipment_date) as min_shipment_date,max(pub_shipment_date) as max_shipment_date from wo_po_break_down where id in(".$po_id_all.") order by shipment_date asc ");
         $min_shipment_date='';
         $max_shipment_date='';
         foreach ($po_shipment_date as $row) {
         	 $min_shipment_date=$row[csf('min_shipment_date')];
         	 $max_shipment_date=$row[csf('max_shipment_date')];
         	 break;
         }

        $po_running_cancel= sql_select("select case when status_active=1 then  PO_NUMBER end as running_po, case when status_active>1 then po_number end as cancel_po,po_quantity from wo_po_break_down  where id in(".$po_id_all.") order by shipment_date asc ");
        $running_po=''; $cancel_po=''; $running_po_qnty=0;
        foreach ($po_running_cancel as $row) {
        	if(!empty($row[csf('running_po')]))
        	{
        		if(!empty($running_po))
        		{
        			$running_po.=",".$row[csf('running_po')];
        		}
        		else{
        			$running_po.=$row[csf('running_po')];
        		}
        		 $running_po_qnty+=$row[csf('po_quantity')];
        	}
        	if(!empty($row[csf('cancel_po')]))
        	{
        		if(!empty($cancel_po))
        		{
        			$cancel_po.=",".$row[csf('cancel_po')];
        		}
        		else{
        			$cancel_po.=$row[csf('cancel_po')];
        		}
        	}
        }
        $stype_color_res=sql_select("select  stripe_type from wo_pre_stripe_color where job_no='$txt_job_no' and status_active=1 and is_deleted=0 group by stripe_type");
        $stype_color='';
        foreach ($stype_color_res as $val) {
        	if(!empty($stype_color))
        	{
        		$stype_color.=", ".$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        	else
        	{
        		$stype_color=$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        }
		ob_start();		
		?>	
											<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td width="200" style="font-size:28px"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:28px;"> <?php echo $company_library[$cbo_company_name]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:18px"><?=$location_address_arr[$location]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:24px">
                            <span style="float:center;"><b><strong> <font style="color:black">Main Fabric Booking </font></strong></b></span> 
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:20px">
							<?
							if(str_replace("'","",$id_approved_id) ==1){ ?>
                            <span style="font-size:20px; float:center;"><strong> <font style="color:green"> <? echo "[Approved]"; ?> </font></strong></span> 
                               <? }else{ ?>
								<span style="font-size:20px; float:center;"><strong> <font style="color:red"><? echo "[Not Approved]"; ?> </font></strong></span> 
							   <? } ?>
                            </td>
                        </tr>
                    </table>
                </td>
                <td width="200">
                	<table style="border:1px solid black; font-family:Arial Narrow;" width="100%">
                		<tr>
                			<td><b>Min. Ship Date:</b></td>
                			<td><b><?php echo  date('d-m-Y',strtotime($min_shipment_date));?></b></td>
                		</tr>
                		<tr>
                			<td><b>Max. Ship Date:</b></td>
                			<td><b><?php echo date('d-m-Y',strtotime($max_shipment_date));?></b></td>
                		</tr>
                	</table>
                	<br>
                	<table style="border:1px solid black; font-family:Arial Narrow;font-size: 10px;" width="100%">
                		<tr>
                			<td>Printing Date :</td>
                			<td><?php echo  date('d-m-Y');?></td>
                		</tr>
                		<tr>
                			<td>Printing Time:</td>
                			<td><?php echo  date('h:i:sa');?></td>
                		</tr>
                		<tr>
                			<td>User Name:</td>
                			<td><?php echo $user_name_arr[$user_id];?></td>
                		</tr>
                		<tr>
                			<?php 
                				function get_client_ip() {
								    $ipaddress = '';
								    if (getenv('HTTP_CLIENT_IP'))
								        $ipaddress = getenv('HTTP_CLIENT_IP');
								    else if(getenv('HTTP_X_FORWARDED_FOR'))
								        $ipaddress = getenv('HTTP_X_FORWARDED_FOR');
								    else if(getenv('HTTP_X_FORWARDED'))
								        $ipaddress = getenv('HTTP_X_FORWARDED');
								    else if(getenv('HTTP_FORWARDED_FOR'))
								        $ipaddress = getenv('HTTP_FORWARDED_FOR');
								    else if(getenv('HTTP_FORWARDED'))
								       $ipaddress = getenv('HTTP_FORWARDED');
								    else if(getenv('REMOTE_ADDR'))
								        $ipaddress = getenv('REMOTE_ADDR');
								    else
								        $ipaddress = 'UNKNOWN';
								    return $ipaddress;
								}
                			 ?>
                			<td>IP Address:</td>
                			<td><?php if(empty($user_ip)){echo get_client_ip();} echo $user_ip;?></td>
                		</tr>
                	</table>
                </td>
            </tr>
        </table>
		<?
        $job_no=trim($txt_job_no,"'"); $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff,min(factory_received_date) as factory_received_date, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
      
        $to_ship=0; $fp_ship=0; $f_ship=0;

        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $factory_received_date=change_date_format($row[csf('factory_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) {
				$shiping_status.= "FP".",";
				$to_ship++;
				$fp_ship++;
			}
			else if($row[csf('shiping_status')]==2){
				$shiping_status.= "PD".",";
				$to_ship++;
			} 
			else if($row[csf('shiping_status')]==3){
				$shiping_status.= "FS".",";
				$to_ship++;
				$f_ship++;
			} 
        }

        if($to_ship==$f_ship) $shiping_status= "Full shipped";
        else if($to_ship==$fp_ship) $shiping_status= "Full Pending";
        else $shiping_status= "Partial Delivery";
       
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$factory_received_date=implode(",",array_filter(array_unique(explode(",",$factory_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];

			?>
			<table width="100%" class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all"  style="font-size:18px; font-family:Arial Narrow;" >
				<tr>
					<td colspan="2" rowspan="6" width="210">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" width="210">
                                <legend>Image </legend>
                                <table width="208">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="200" height="200" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
					</td>
					<td width="100"><b>Job No</b></td>
					<?php 
						
					 	$revised_no=$nameArray_approved_row[csf('approved_no')]-1;
						if($revised_no<0) $revised_no=0;
					 ?>
					<td width="140"> <span style="font-size:18px"><b style="float:left;font-size:18px"><? echo trim($txt_job_no,"'");if(!empty($revised_no)){ ?>&nbsp;<span style="color: red;">/&nbsp;<? echo $revised_no; }?></span></b> </span> </td>
					<td colspan="7" width="760">
						<b><?php if(!empty($result[csf('remarks')])){ ?><span style="font-size: 25px;">&#8592;</span><? echo $result[csf('remarks')]; } ?></b>
					</td>
				</tr>
				<?php
					$order_yes_no=sql_select("Select embelishment ,embro ,wash  ,spworks ,gmtsdying , ws_id , aop , aopseq , bush ,  peach, yd    from wo_po_details_mas_set_details where job_no='$txt_job_no' order by id");
				?>
				<tr>
					<td width="100" style="font-size:16px;"><b>Style</b></td>
					<td width="110"style="font-size:16px;" >&nbsp;<? echo $result[csf('style_ref_no')]; ?></td>
					<td width="100" style="font-size:16px;"><b>Dept. (Prod Code)</b></td>
					<td width="140"style="font-size:16px;" >&nbsp;<? echo $product_dept[$result[csf('product_dept')]]; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} ?></td>
					<td width="100"><b>YD</b></td>
					<td width="110"><?php echo (!empty($yd) || $order_yes_no[0][csf('yd')]==1)  ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo $yd;//!empty($yd) ? $stype_color : ''; ?></td>
					<td width="110"><b>Fac. Order Received Date</b></td>
					<td width="100"><?php echo $factory_received_date; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></span></td>
					<td width="100"><b>Sub Dep</b></td>
					<td width="140"><? if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
					<td width="100"><b>AOP</b></td>
					<td width="110"><?php echo   ($order_yes_no[0][csf('aop')]==1 || (!empty($aop))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$aop;?></td>
					<td width="110"><b>Booking Start<br>Appoval Date</b></td>
					<td width="100">
						<?php if(!empty($first_approve_date)){ echo date('d-m-Y',strtotime($first_approve_date)); } ?><br>
						<?php if(!empty($last_approve_date)){ echo date('d-m-Y',strtotime($last_approve_date)); } ?>
					</td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Garments Item</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"> <?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?></span></td>
					<td width="100"><b>Season</b></td>
					<td width="140"><? echo $season_name_arr[$result[csf('season')]]; ?></td>
					<td width="100"><b>Peach</b></td>
					<td width="110"><?php echo  ($job_yes_no[0][csf('peach')]==1 || (!empty($peach))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$peach?></td>
					<td width="110"><b>Approved Status</b></td>
					<td width="100">
					<? if(str_replace("'","",$id_approved_id) ==1){ ?>
					<b style="color:green"><?	echo "Yes";?></b>
					<? }else{ ?><b style="color:red"><?	echo "No";?></b><?}; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Sample Req. No</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"><?php echo $requisition_no; ?></span></td>
					<td width="100"><b>Brand</b></td>
					<td width="140"><?php echo $brand_name_arr[$result[csf('brand_id')]]; ?></td>
					<td width="100"><b>Brushing</b></td>
					<td width="110"><?php echo  ($job_yes_no[0][csf('bush')]==1 ||  (!empty($brush))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$brush?></td>
					<td width="110"><b>Booking Date</b></td>
					<td width="100"> <?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>
                    </td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Booking No</b></span></td>
					<td width="110"><span style="font-size:18px"><b><? echo $result[csf('booking_no')];?></b><? echo "<br>(".$fabric_source[$result[csf('fabric_source')]].")"?></span></td>
					<td width="100"><b>Order Repeat No</b></td>
					<td width="140"><? echo  $result[csf('order_repeat_no')];?></td>
					<td width="100"><b>Print / Type</b></td>
					<td width="110"><?php echo   ($order_yes_no[0][csf('embelishment')]==1 || (!empty($emb_print_data[$txt_job_no][1]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo  !empty($emb_print_data[$txt_job_no][1]) ? chop($emb_print_data[$txt_job_no][1],",") : '' ;?></td>
					<td width="110"><b>Delivery Date</b></td>
					<td width="100"><? echo change_date_format($delivery_date); ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Running PO No</b></span></td>
					<td width="350" colspan="3" style="word-break: break-all;"><p style="font-size:12px;width: 450px;word-break: break-all;" ><? echo $running_po; ?></p></td>
					<td width="100"><b>Order Repeat Job No</b></td>
					<td width="110"><? echo $result[csf('repeat_job_no')];?></td>
					<td width="100"><b>EMB / Type</b></td>
					<td width="110"><?php echo  ($order_yes_no[0][csf('embro')]==1 || (!empty($emb_print_data[$txt_job_no][2]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo  !empty($emb_print_data[$txt_job_no][2]) ? chop($emb_print_data[$txt_job_no][2],",") : '' ;?></td>
					<td width="110"><b>Amendment Date</b></td>
					<td width="100"><? if(!empty($un_approved_date)){echo change_date_format($un_approved_date);} ?>
                    </td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Cancelled PO</b></span></td>
					<td width="350" colspan="3" ><p style="font-size:12px;width: 450px;word-break: break-all;"><? echo $cancel_po; ?></p></td>
					<?php $fab_material=array(1=>"Organic",2=>"BCI"); ?>
					<td width="100"><b>Fab. Material</b> </td>
					<td width="110"><?php echo $fab_material[$result[csf('fab_material')]]; ?></td>
					<td width="100"><b>GMT Wash</b></td>
					<td width="110"><?php echo  ($order_yes_no[0][csf('wash')]==1 || (!empty($emb_print_data[$txt_job_no][3]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo  !empty($emb_print_data[$txt_job_no][3]) ? chop($emb_print_data[$txt_job_no][3],",") : '' ;?></td>
					<td width="110"><b>Dealing Merchandiser</b></td>
					<td width="100"><? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>GMT/ Style Description</b></span></td>
					<td width="350" colspan="3"><span style="font-size:18px"><? echo $result[csf('style_description')]; ?></span></td>
					<td width="100"><b>Sustainability Standard</b></td>
					<td width="110"><?php echo $sustainability_standard[$result[csf('sustainability_standard')]];  ?></td>
					<td width="100"><b>Fab Wash</b></td>
					<td width="110"><?php echo !empty($fab_wash)? 'Yes' : 'No'; ?></td>
					<td width="100"><?=$fab_wash?></td>
					<td width="110"><b>Factory Merchandiser</b></td>
					<td width="100"><? echo $marchentrArr[$result[csf('factory_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Fabric Description</b></span></td>
					<td width="350" colspan="3"><span style="font-size:18px">
						<? 
							$sql_fab="
							  SELECT 
							         a.lib_yarn_count_deter_id AS determin_id,
							         a.construction
							        
							    FROM wo_pre_cost_fabric_cost_dtls a,
							         wo_pre_cos_fab_co_avg_con_dtls b,
							         wo_booking_dtls d
							   WHERE     a.job_id = b.job_id
							         AND a.id = b.pre_cost_fabric_cost_dtls_id
							         AND a.id = d.pre_cost_fabric_cost_dtls_id
							         AND b.po_break_down_id = d.po_break_down_id
							         AND b.color_size_table_id = d.color_size_table_id
							         AND b.pre_cost_fabric_cost_dtls_id = d.pre_cost_fabric_cost_dtls_id
							         AND d.booking_no = $txt_booking_no
							         AND a.status_active = 1
							         AND d.status_active = 1
							         AND d.is_deleted = 0
							          and a.body_part_id in (1,20)

							    group by a.lib_yarn_count_deter_id , a.construction
							";
							//echo $sql_fab;
							$res_fab=sql_select($sql_fab);
							$des='';
							foreach ($res_fab as $row) 
							{

								if(!empty($des))
								{
									$des."***";
								}
								$des.=$row[csf('construction')] . " ". $fabric_composition[$lip_yarn_count[$row[csf('determin_id')]]];
							}
							echo implode(",", array_unique(explode("***", $des)));
						?>
						</span></td>
					<td width="100"><b>Order Nature</b></td>
					<td width="110"><?php echo $fbooking_order_nature[$result[csf('quality_level')]] ?></td>
					<td width="100"><b>Running Order Qty</b></td>
					<?php $order_uom_res=sql_select( "select a.order_uom from wo_po_details_master a where a.status_active=1 and a.is_deleted=0  and a.job_no='$txt_job_no' ");
						$order_uom='';
						if(count($order_uom_res))
						{
							$order_uom=$unit_of_measurement[$order_uom_res[0][csf('order_uom')]];
						}
					 ?>
					<td width="210" colspan="2" align="center"><b> <?php echo number_format($running_po_qnty,0); ?>&nbsp;(<?=$order_uom;?>)</b></td>
					
					
					<td width="110"><b>Shipment Status</b></td>
					<td width="100"> 
                        <? echo rtrim($shiping_status,','); ?>
                        	
                    </td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Attention</b></span></td>
					<td  width="350" colspan="3"><span style="font-size:18px"><? echo $result[csf('attention')]; ?></span></td>
					<td width="100"><b>Quality Label</b></td>
					<td width="110"><?php echo $quality_label[$result[csf('qlty_label')]]; ?></td>
					<td width="100"><b>Packing</b></td>
					<td width="420" colspan="4" align="center"><b> <?php echo $packing[$result[csf('packing')]]; ?></b></td>
				</tr>
                <tr>
					<td><span style="font-size:18px"><b>Proceed for Knitting</b></span></td>
					<td><span style="font-size:18px"><? echo $yes_no[$result[csf('proceed_knitting')]]; ?></span></td>
					<td><b>Proceed for Dyeing</b></td>
					<td><?php echo $yes_no[$result[csf('proceed_dyeing')]]; ?></td>
					<td colspan="7">&nbsp;</td>
				</tr>
			</table>
			<br>
			<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			<table width="100%" style="font-family:Arial Narrow;font-size:18px" >
                <tr>
                    <td width="900">
                        <div id="div_size_color_matrix" style="float:left; max-width:1000;">
                            <fieldset id="div_size_color_matrix" style="max-width:1000;">
                                <legend>Size and Color Breakdown</legend>
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="1000" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style="border:1px solid black"><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="border:1px solid black; text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="130" valign="top" align="left">
                        <div id="div_size_color_matrix" style="float:left;">
							
                        </div>
                    </td>
                    <td width="200" valign="top" align="right">
						
                        <div id="div_size_color_matrix" style="float:right;font-size:18px;font-family:Arial Narrow;">
                           <? $rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown); ?>
                            <fieldset id="" >
                                <legend>RMG Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all">
									<?
                                    if(number_format($rmg_process_breakdown_arr[8],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[2],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[10],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[1],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[4],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[3],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[15],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[11],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
										</tr>
										<?
                                    }
                                    $gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
                                    if($gmts_pro_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                            <fieldset id="" >
                                <legend>Fabric Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;">
                                    <?
                                    if(number_format($rmg_process_breakdown_arr[6],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[12],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[5],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[13],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"> All Over Print <!-- new  breack Down 13--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[14],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[7],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dying   <!-- breack Down 7--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[0],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[9],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
										</tr>
										<?
                                    }

                                    $fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
                                    if(fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                </tr>
			</table>
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		<br/>
		<br>
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }

        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			$fb_desc_sq="SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type,  b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight,  b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width";
			$nameArray_fabric_description= sql_select($fb_desc_sq);
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                 <tr align="center">
                    <th colspan="3" align="left">Fabric Composition</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('determin_id')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $fabric_composition[$lip_yarn_count[$result_fabric_description[csf('determin_id')]]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Yarn Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='2' >&nbsp</td>";
						else echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
               
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>A Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">GMT Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
                $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td><? echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
						<?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							?>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
							<?
                        }
                        ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(a.avg_finish_cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(a.avg_cons) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");


			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('determin_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $fabric_composition[$lip_yarn_count[$result_fabric_description[csf('determin_id')]]]."</td>";

						
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Yarn Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">GMT Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id as fab_id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and

                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				if(!empty($collar_cuff_row[csf('item_size')]))
				{
					$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				}
				
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);

			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;font-size:18px;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }
                            ?>
                        </tr>
                            <?

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        
                        <tr>
                            <td>Size Total</td>
								<?
                               // foreach($pre_size_total_arr  as $size_qty)
                               // {
                                	foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
									{
										$size_qty=$pre_size_total_arr[$size_number_id];
										?>
										<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
										<?
									}

                               // }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

        ?>

       		 <table width="98%">
       		 	<tr>
       		 		<td width="45%" style="float: left;">
       		 			<?php 

       		 				$sql_purchase="SELECT a.booking_no, a.uom, sum(b.fin_fab_qnty) as qnty , b.construction, b.copmposition, b.gsm_weight as dia, b.dia_width as gsm from wo_booking_mst a, wo_booking_dtls b where     a.booking_no = b.booking_no and a.fabric_source = 2 and b.job_no = '$txt_job_no'and b.status_active = 1 and b.is_deleted = 0 and a.status_active = 1 and a.is_deleted = 0 and  a.booking_type=1 group by a.booking_no, a.uom, b.construction, b.copmposition, b.dia, b.gsm_weight, b.dia_width"; 
       		 				//echo $sql_purchase;
							$purchase_res=sql_select($sql_purchase);
							?>
							<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <thead>
				                   <tr align="center">
				                    	<th colspan="5"><b>Purchased Booking Info</b></th>
				                    </tr>
				                    <tr align="center">
					                    <th>Sl</th>
					                    <th>Booking No</th>
					                    <th>Fabric Data</th>
					                    <th>UOM</th>
					                    <th>Qnty</th>
					                   
				                    </tr>
 			                   </thead>
 			                   <tbody>
 			                   		<?

 			                   			foreach ($purchase_res as  $row) 
 			                   			{
 			                   				?>
 			                   				<tr>
 			                   					<td><?=$p++;?></td>
 			                   					<td><p><?=$row[csf('booking_no')];?></p></td>
 			                   					<td><p><?=$row[csf('construction')] .", ".$row[csf('copmposition')].", ".$row[csf('gsm')].", ".$row[csf('dia')];?></p></td>
 			                   					<td><p><?=$unit_of_measurement[$row[csf('uom')]];?></p></td>
 			                   					<td><p><?=number_format($row[csf('qnty')],2);?></p></td>
 			                   				</tr>
 			                   				<?
 			                   			}


 			                   		?>
 			                   </tbody>
 			                   
 			            </table>

       		 			 
       		 		</td>
       		 		<td width="45%" style="float: right;">
 			       		 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <tr align="center">
 			                    	<td colspan="10"><b>Dyes To Match</b></td>
 			                    </tr>
 			                    <tr align="center">
 				                    <td>Sl</td>
 				                    <td>Item</td>
 				                    <td>Item Description</td>
 				                    <td>Body Color</td>
 				                    <td>Item Color</td>
 				                    <td>Finish Qty.</td>
 				                    <td>UOM</td>
 			                    </tr>
 			                    <?
 								$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
 								$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
 								$bookingId=0;
 								foreach($sql as $row){
 									$bookingId= $row[csf('id')];
 								}
 								$co=0;
 								$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty, b.description   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom, b.description order by a.fabric_color");

 								foreach($sql_data  as $row)
 			                    {
 									$co++;
 									?>
 				                    <tr>
 				                    <td><? echo $co; ?></td>
 				                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
 				                    <td><p> <? echo $row[csf('description')];?></p></td>
 				                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
 				                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
 				                    <td align="right"><? echo $row[csf('qty')];?></td>
 				                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
 				                    </tr>
 				                    <?
 								}
 								?>
 			            </table>
       		 		</td>
       		 	</tr>
       		 </table>
            <br>

        <?

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  style="font-size:18px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> </b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
                 <td width="49%" valign="top" align="center">
                	
               	
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                				<?
                				$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
									 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
									 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

								$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
                				 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");


                				if(count($unapprove_data_array)>0)
                				{
                				$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
                					$unapproved_request_arr=array();
                					foreach($sql_unapproved as $rowu)
                					{
                						$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
                					}
                		 		?>
                		       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
                		            <thead>
                		            <tr style="border:1px solid black;">
                		                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                		                </tr>
                		                <tr style="border:1px solid black;">
                		                <th width="3%" style="border:1px solid black;">Sl</th>
                						<th width="30%" style="border:1px solid black;">Name</th>
                						<th width="20%" style="border:1px solid black;">Designation</th>
                						<th width="5%" style="border:1px solid black;">Approval Status</th>
                						<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                						<th width="22%" style="border:1px solid black;"> Date</th>

                		                </tr>
                		            </thead>
                		            <tbody>
                		            <?
                					$i=1;
                					foreach($unapprove_data_array as $row){

                					?>
                		            <tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
                						<td width="20%" style="border:1px solid black;"><? echo '';?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
                		            </tr>
                		                <?
                						$i++;
                						$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
                						$un_approved_date=$un_approved_date[0];
                						if($db_type==0) //Mysql
                						{
                							if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}
                						else
                						{
                							if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}

                						if($un_approved_date!="")
                						{
                						?>
                					<tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
                		              </tr>

                		                <?
                						$i++;
                						}

                					}
                						?>
                		            </tbody>
                		        </table>
                				<?
                				}
                				?>

                </td>
            </tr>
        </table>
        <br/>
        <table  width="100%" style="margin: 0px;padding: 0px;">
	        <?php $stripe_color_wise=array(); ?>
	       
	        <tr>
	        	<td width="70%" >
    		        <table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >
    			        		       
    				        <caption style="text-align: center;justify-content: center;">Stripe Details</caption>
    				        <?
    						$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
    						$sql_stripe=("SELECT c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d , wo_po_color_size_breakdown e where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0 and e.id=b.color_size_table_id and e.is_deleted=0 and e.status_active=1 and e.color_number_id=d.color_number_id  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id "); 				
    						$result_data=sql_select($sql_stripe);
    						foreach($result_data as $row)
    						{
    							$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
    							$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
    							$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
    							$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
    							$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

    							$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
    							$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
    							$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
    							$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
    							$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
    						}
    						?>
    						<thead>
    							<tr>
    		    		            <th align="center" width="30"> SL</th>
    		    		            <th align="center" width="100"> Body Part</th>
    		    		            <th align="center" width="80"> Fabric Color</th>
    		    		            <th align="center" width="70"> Fabric Qty(KG)</th>
    		    		            <th align="center" width="70"> Stripe Color</th>
    		    		            <th align="center" width="70"> Stripe Measurement</th>
    		    		            <th align="center" width="70"> Stripe Uom</th>
    		    		            <th  align="center" width="70"> Qty.(KG)</th>
    		    		            <th  align="center" width="70"> Y/D Req.</th>
    				            </tr>
    						</thead>
    				        <tbody>  
    				            <?
    							//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
    							//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
    								//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
    				            
    							$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
    				            foreach($stripe_arr as $body_id=>$body_data)
    				            {
    								foreach($body_data as $color_id=>$color_val)
    								{
    									$rowspan=count($color_val['stripe_color']);
    									$composition=$stripe_arr2[$body_id][$color_id]['composition'];
    									$construction=$stripe_arr2[$body_id][$color_id]['construction'];
    									$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
    									$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
    									$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

    									if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
    									else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

    									$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
    										WHERE a.job_no=b.job_no and
    										a.id=b.pre_cost_fabric_cost_dtls_id and
    										c.job_no_mst=a.job_no and
    										c.id=b.color_size_table_id and
    										b.po_break_down_id=d.po_break_down_id and
    										b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
    										d.booking_no =$txt_booking_no and
    										a.body_part_id='".$body_id."' and
    										a.color_type_id='".$color_type_id."' and
    										a.construction='".$construction."' and
    										a.composition='".$composition."' and
    										a.gsm_weight='".$gsm_weight."' and
    										$color_cond and
    										d.status_active=1 and
    										d.is_deleted=0
    										");
    								
    										list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
    									$sk=0;
    									foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
    		    						{
    		    							
    			    							?>
    										<tr title="<?=$span?>">
    			    							<?
    			    							$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
    			    							if($sk==0)
    			    							{
    				    							?>
    				    							<td rowspan="<?=$rowspan;?>"> <? echo $i; ?></td>
    				    							<td rowspan="<?=$rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
    				    							<td rowspan="<?=$rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
    				    							<td rowspan="<?=$rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
    				    							<?
    				    							$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
    				    							$i++;
    				    						}
    			    							

    			    								$measurement=$color_val['measurement'][$strip_color_id];
    			    								$uom=$color_val['uom'][$strip_color_id];
    			    								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
    			    								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
    			    								
    			    								?>
    			    							
    			        								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
    			        								<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
    			        		                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
    			        								<td align="right"> <? echo  number_format($fabreqtotkg,2); ?> &nbsp;</td>
    			        								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
    			    								
    			    								<?
    			    								
    			    								$sk++;
    			    								$total_fabreqtotkg+=$fabreqtotkg;
    			    								$stripe_color_wise[$color_name_arr[$s_color_val]]+=$fabreqtotkg;
    			    							
    			    							
    			    							?>
    										</tr>
    										<?
    									}
    								}
    							}
    							?>
    						</tbody>
    			            <tfoot>
    				            <tr>
    		    		            <td colspan="3">Total </td>
    		    		            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
    		    		            <td></td>
    		    		            <td></td>
    		    		            <td>   </td>
    		    		            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
    		    		        </tr>
    			            </tfoot>
    			    </table>
	        	</td>
	        	
	        	<td width="20%" >
			        <table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;"  >
			       	        <caption style="justify-content: center;text-align: center;">Stripe  Color wise Summary</caption>
			               	<thead>
			       	            <tr>
			       		            <th width="30"> SL</th>
			       		            
			       		            <th width="70"> Stripe Color</th>
			       		           
			       		            <th  width="70"> Qty.(KG)</th>
			       		           
			       	            </tr>
			       	        </thead>
			       	        <tbody>
			       	            <?

			       					$i=1;$total_stripe_qnt=0;        		            
			       						foreach($stripe_color_wise as $color=>$val)
			       						{
			       							
			       							
			       							?>
			       							<tr>
			           							<td> <? echo $i; ?></td>
			           							
			           							<td > <? echo $color; ?></td>
			           							<td align="right"> <?php echo number_format($val,2); ?></td>
			           						</tr>
			       							
			       							<?
			       							$total_stripe_qnt+=$val;
			       							
			       							$i++;
			       						}
			       					
			       					?>
			       			</tbody>
		                   <tfoot>
		       	            <tr>
		       		            <td></td>
		       		            <td></td>
		       		            <td align="right"><? echo  number_format($total_stripe_qnt,2); ?> </td>
		       	            </tr>
		                   </tfoot>
			        </table>
	        	</td>
	        </tr>
        </table >
        

       
      
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Production) </b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("
        select
        a.id,
        a.item_number_id,
        a.costing_per,
        b.po_break_down_id,
        b.color_size_table_id,
        b.requirment,
        c.po_number
        FROM
        wo_pre_cost_fabric_cost_dtls a,
        wo_pre_cos_fab_co_avg_con_dtls b,
        wo_po_break_down c
        WHERE
        a.job_no=b.job_no and
        a.job_no=c.job_no_mst and
        a.id=b.pre_cost_fabric_cost_dtls_id and
        b.po_break_down_id=c.id and
        b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
        order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>

        <?
         if(count($purchase_res))
        {
        	?>
         <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Purchase)</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Purchase<br>Booking Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and c.job_no_mst = '$txt_job_no'  and a.fab_nature_id=3 and   a.fabric_source = '2'  and a.status_active=1 and a.is_deleted=0 order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and   a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1  and c.fabric_source = 2  and a.is_short=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");


        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1 and c.fabric_source=2 and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =4 and c.fabric_source=2 and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.job_no_mst='$txt_job_no' group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
       
        </tfoot>
        </table>
         <?
        	}
        ?>
       <br>

		<fieldset id="div_size_color_matrix" style="max-width:1000;">
		<?
		//------------------------------ Query for TNA start-----------------------------------
		$po_id_all=str_replace("'","",$txt_order_no_id);
		$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
		$tna_start_sql=sql_select( "select id,po_number_id,
						(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
						(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
						(case when task_number=60 then task_start_date else null end) as knitting_start_date,
						(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
						(case when task_number=61 then task_start_date else null end) as dying_start_date,
						(case when task_number=61 then task_finish_date else null end) as dying_end_date,
						(case when task_number=64 then task_start_date else null end) as finishing_start_date,
						(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
						(case when task_number=84 then task_start_date else null end) as cutting_start_date,
						(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
						(case when task_number=86 then task_start_date else null end) as sewing_start_date,
						(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
						(case when task_number=110 then task_start_date else null end) as exfact_start_date,
						(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
						(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
						(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
						from tna_process_mst
						where status_active=1 and po_number_id in($po_id_all)");
		$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
		$tna_date_task_arr=array();
		foreach($tna_start_sql as $row)
		{
			if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
			{
				if($tna_fab_start=="")
				{
					$tna_fab_start=$row[csf("fab_booking_start_date")];
				}
			}


			if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
			}
			if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
			}
			if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
			}
			if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
			}

			if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
			}
			if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
			}
			if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
			}
		}

			//------------------------------ Query for TNA end-----------------------------------
		?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:17px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } echo get_spacial_instruction($txt_booking_no,"97%",118); ?>
       
        <div style="font-family:Arial Narrow;"><?=signature_table(1, $cbo_company_name, "1400px"); ?></div>
        <br>
        
       <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="1300" cellspacing="0" rules="all" >
        	<thead>
            	<th colspan="16"><b>Job Progress Status: </b></th>
            </thead>
            <?
			$condition= new condition();
			if(str_replace("'","",$job_no) !=''){
				$condition->job_no("='$job_no'");
			}
			//Fabric Booking
			$condition->init();
			$fabric= new fabric($condition);  //echo $fabric->getQuery();
			$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabreqQty=0;
			foreach($fabric_qty['knit']['grey'] as $fid=>$fdata)
			{
				foreach($fdata as $fuom=>$fuomdata)
				{
					$fabreqQty+=$fuomdata;
				}
			}
			
			$sqlJobPo=sql_select("select id from wo_po_break_down where job_no_mst='$job_no' and status_active=1 and is_deleted=0");
			$poIds="";
			foreach($sqlJobPo as $row)
			{
				if($poIds=="") $poIds=$row[csf('id')]; else $poIds.=','.$row[csf('id')];
			}
			unset($sqlJobPo);
			
			$sqlFabbooking=sql_select("select sum(grey_fab_qnty) as grey_fab_qnty from wo_booking_dtls where job_no='$job_no' and booking_type=1 and status_active=1 and is_deleted=0");
			$fabbookingQty=$sqlFabbooking[0][csf('grey_fab_qnty')];
			
			$fabbookingPer=($fabbookingQty/$fabreqQty)*100;
			
			//Yarn Allocation
			$sqlYarnAll=sql_select("select sum(qnty) as qnty from inv_material_allocation_dtls where job_no='$job_no' and item_category=1 and status_active=1 and is_deleted=0");
			$yarnAlloQty=$sqlYarnAll[0][csf('qnty')];
			$yarnAlloPer=($yarnAlloQty/$fabreqQty)*100;
			
			$sqlStore="select entry_form, trans_type, quantity from order_wise_pro_details where po_breakdown_id in(".$poIds.") and trans_type in (1,2) and entry_form in (2,3,22,23,58,82,7,66,37,225) and status_active=1";
			$sqlstoreRes=sql_select($sqlStore);
			
			$yarnIssueQty=$knittingFinishQty=$greyRecQty=$finishProdQty=$finishRecQty=0;
			foreach($sqlstoreRes as $row)
			{
				if($row[csf('trans_type')]==2 && $row[csf('entry_form')]==3)
				{
					$yarnIssueQty+=$row[csf('quantity')];
				}
				if($row[csf('trans_type')]==1)
				{
					if($row[csf('entry_form')]==2)
					{
						$knittingFinishQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==22 || $row[csf('entry_form')]==23 || $row[csf('entry_form')]==58 || $row[csf('entry_form')]==82)
					{
						$greyRecQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==7 || $row[csf('entry_form')]==66)
					{
						$finishProdQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==37 || $row[csf('entry_form')]==225)
					{
						$finishRecQty+=$row[csf('quantity')];
					}
				}
			}
			unset($sqlstoreRes);
			
			$yarnIssePer=($yarnIssueQty/$fabreqQty)*100;			//Yarn Issued
			$knittingFinishPer=($knittingFinishQty/$fabreqQty)*100;	//Knitting Finished
			$greyRecPer=($greyRecQty/$fabreqQty)*100;				//Greige Fabric Received
			$finishProdPer=($finishProdQty/$fabreqQty)*100;			//Finished Fabric Production
			$finishRecPer=($finishRecQty/$fabreqQty)*100;			//Finished Fabric Received
			
			
			$sqlGmtsProd="select production_type, embel_name, production_quantity from pro_garments_production_mst where po_break_down_id in(".$poIds.") and production_type in (1,3,5,7,15,11,8) and status_active=1";
			$sqlGmtsProdRes=sql_select($sqlGmtsProd);
			$cutQty=$printQty=$embRecQty=$sewOutQty=$ironQty=$hangTagQty=$polyQty=$packFinQty=0;
			foreach($sqlGmtsProdRes as $row)
			{
				if($row[csf('production_type')]==1)
				{
					$cutQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==3 && $row[csf('embel_name')]==1)
				{
					$printQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==3 && $row[csf('embel_name')]==1)
				{
					$embRecQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==5)
				{
					$sewOutQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==7)
				{
					$ironQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==15)
				{
					$hangTagQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==11)
				{
					$polyQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==8)
				{
					$packFinQty+=$row[csf('production_quantity')];
				}
			}
			unset($sqlGmtsProdRes);
			$cutFinishPer=($cutQty/$jobqtypcs)*100;		//Cutting Finished
			$printRecPer=($printQty/$jobqtypcs)*100;	//Print Received
			$embRecPer=($embRecQty/$jobqtypcs)*100;		//Embroidery Received
			$sewOutPer=($sewOutQty/$jobqtypcs)*100;		//Sewing Completed
			$ironPer=($ironQty/$jobqtypcs)*100;			//Iron Completed
			$hangTagPer=($hangTagQty/$jobqtypcs)*100;	//Hang Tag Completed
			$polyPer=($polyQty/$jobqtypcs)*100;			//Poly Completed
			$packFinishPer=($packFinQty/$jobqtypcs)*100;//Packing Finishing Completed
			
			//Ex-factory Completed
			$sqlExFactory=return_field_value("sum(ex_factory_qnty) as exqty", "pro_ex_factory_mst", "po_break_down_id in(".$poIds.") and status_active=1", "exqty");
			$exFactoryPer=($sqlExFactory/$jobqtypcs)*100;
			
			?>
			<tr>
            	<td width="125"><b>Fabric Booking</b></td><td align="center" width="40"><?=number_format($fabbookingPer,2); ?></td>
                <td width="125"><b>Yarn Allocation</b></td><td align="center" width="40"><?=number_format($yarnAlloPer,2); ?></td>
                <td width="125"><b>Yarn Issued</b></td><td align="center" width="40"><?=number_format($yarnIssePer,2); ?></td>
                <td width="125"><b>Knitting Finished</b></td><td align="center" width="40"><?=number_format($knittingFinishPer,2); ?></td>
                <td width="125"><b>Greige Fabric Received</b></td><td align="center" width="40"><?=number_format($greyRecPer,2); ?></td>
                <td width="125"><b>Dye-Fin. Completed</b></td><td align="center" width="40"><?=number_format($finishProdPer,2); ?></td>
                <td width="125"><b>Finished Fabric Received</b></td><td align="center" width="40"><?=number_format($finishRecPer,2); ?></td>
                <td width="125"><b>Cutting Finished</b></td><td align="center"><?=number_format($cutFinishPer,2); ?></td>
            </tr>
            <tr>
            	<td><b>Print Received</b></td><td align="center"><?=number_format($printRecPer,2); ?></td>
            	<td><b>Embroidery Received</b></td><td align="center"><?=number_format($embRecPer,2); ?></td>
            	<td><b>Sewing Completed</b></td><td align="center"><?=number_format($sewOutPer,2); ?></td>
                <td><b>Iron Completed</b></td><td align="center"><?=number_format($ironPer,2); ?></td>
                <td><b>Hang Tag Completed</b></td><td align="center"><?=number_format($hangTagPer,2); ?></td>
                <td><b>Poly Completed</b></td><td align="center"><?=number_format($polyPer,2); ?></td>
                <td><b>Packing Finishing Completed</b></td><td align="center"><?=number_format($packFinishPer,2); ?></td>
                <td><b>Ex-factory Completed</b></td><td align="center"><?=number_format($exFactoryPer,2); ?></td>
            </tr>
        </table>
        <?
        	$grand_order_total=0; $grand_plan_total=0; $size_wise_total=array();
			$nameArray_size=sql_select( "select size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id ");
			?>
                <div id="div_size_color_matrix" class="pagebreak">
                    <fieldset id="div_size_color_matrix" >
                        <legend>Size and Color Breakdown</legend>
                        <table  class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                            <tr>
                            	<td>PO Number</td>
                            	<td>PO Received Date</td>
                            	<td>Ship Date</td>
                            	<td>Lead Time</td>
                            	<td>Ship.days in Hand</td>
                            	<td>Gmts Item</td>
                                <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                <?
                                foreach($nameArray_size  as $result_size)
                                {
									?>
                                	<td align="center" style="border:1px solid black"><?=$size_library[$result_size[csf('size_number_id')]];?></td>
                                <? } ?>
                                <td  align="center"> Total Order Qty(Pcs)</td>
                                <td  align="center"> Excess %</td>
                                <td  align="center"> Total Plan Cut Qty(Pcs)</td>
                            </tr>
                            <?
                            $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                           	$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
                           	$result_cs=sql_select( "select b.item_number_id,b.color_number_id,sum(b.order_quantity) as order_quantity,b.size_number_id,b.po_break_down_id from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.job_no_mst ='$job_no' and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 group by b.item_number_id,b.color_number_id,b.size_number_id,b.po_break_down_id");
                           	$color_size_data=array();
                           	foreach ($result_cs as $row) {
                           		$color_size_data[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]+=$row[csf('order_quantity')];
                           	}

                           	$sql_color="select a.po_number,a.id,a.po_received_date,a.shipment_date,b.item_number_id,b.color_number_id,sum(b.plan_cut_qnty) as plan_cut_qnty,a.shiping_status from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.job_no_mst ='$job_no' and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 group by a.po_number,a.id,a.po_received_date,a.shipment_date,b.item_number_id,b.color_number_id,a.shiping_status order by a.shipment_date asc ";
                           	//echo $sql_color;
							$result_color_size=sql_select( $sql_color);

							foreach ($result_color_size as $row) 
							{
								?>
								<tr>
									<td><?php echo $row[csf('po_number')] ?></td>
									<td><?php echo change_date_format($row[csf('po_received_date')]); ?></td>
									<td><?php echo change_date_format($row[csf('shipment_date')]); ?></td>
									<?php 

										$date1=date_create($row[csf('po_received_date')]);
										$date2=date_create($row[csf('shipment_date')]);
										$diff=date_diff($date1,$date2);
										$current_date=date_create(strval(date('Y-m-d')));
										$diff1=date_diff($current_date,$date2);
										
										$day_in_hand=$diff1->format("%R%a days");
										if($row[csf('shiping_status')]==3)
										{
											$day_in_hand='0 days';
										}
									 ?>
									<td><?php echo $diff->format("%a days"); ?></td>
									<td><?php echo str_replace("+", "", $day_in_hand); ?></td>
									<td><?php echo $garments_item[$row[csf('item_number_id')]]; ?></td>
									<td><?php echo $color_library[$row[csf('color_number_id')]]; ?></td>
									<?
									$total=0;

                                    foreach($nameArray_size  as $key)
                                    {
										?>
                                    	<td align="center" style="border:1px solid black">
                                    		<?
												$qnty=0;
												$qnty=$color_size_data[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$key[csf('size_number_id')]];
												echo number_format($qnty);
												$size_wise_total[$key[csf('size_number_id')]]+=$qnty;
												$total+=$qnty;
											?>
                                    	</td>
                                   	 	<? 
                                	}
                                	$grand_order_total+=$total;
        							$grand_plan_total+=$row[csf('plan_cut_qnty')];

        							$plan_cut_dif=$row[csf('plan_cut_qnty')]-$total;
        							$ex_cut_perc=($plan_cut_dif/$total)*100;

                                	?>
                                	<td align="center"><?php echo number_format($total); ?></td>
                                	<td align="center"><?php echo number_format($ex_cut_perc,2); ?>%</td>
                                	<td align="center"><?php echo number_format($row[csf('plan_cut_qnty')]); ?></td>
								</tr>
								<?
							}
                            ?>
                            <tr>
                            	<td align="right" colspan="7">Total</td>
                            	<?
                                    foreach($nameArray_size  as $key)
                                    {
										?>
                                    	<td align="center" style="border:1px solid black">
                                    		<strong><?=number_format($size_wise_total[$key[csf('size_number_id')]]); ?></strong>
                                    	</td>
                                   	 	<? 
                                	}
                                	?>
                                <td align="center"><strong><?=number_format($grand_order_total)?></strong></td>
                                <td></td>
                                <td align="center"><strong><?=number_format($grand_plan_total)?></strong></td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
			<?
			$actule_po_size=sql_select("select gmts_size_id from wo_po_acc_po_info where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by gmts_size_id ");
			$actule_po_data=sql_select( "SELECT a.id as po_id,a.po_number, b.acc_po_no, a.po_received_date, b.acc_ship_date, b.gmts_color_id, b.gmts_size_id, b.acc_po_qty, b.id as actule_po_id , b.gmts_item from wo_po_break_down a join wo_po_acc_po_info b on a.id=b.PO_BREAK_DOWN_ID where b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and b.is_deleted=0 and b.status_active=1 and a.is_deleted=0 and a.status_active=1");
			$actule_po_arr=array();
			$attribute=array('po_number','acc_po_no','po_received_date','acc_ship_date','gmts_color_id','gmts_size_id','acc_po_qty','gmts_item');
			foreach ($actule_po_data as $row) {
				foreach ($attribute as $attr) {
					$actule_po_arr[$row[csf('po_id')]][$row[csf('actule_po_id')]][$attr]=$row[csf($attr)];
				}
				$actual_color_size[$row[csf('po_id')]][$row[csf('actule_po_id')]][$row[csf('gmts_item')]][$row[csf('gmts_color_id')]][$row[csf('gmts_size_id')]] =$row[csf('acc_po_qty')];			
			}
			/*echo '<pre>';
			print_r($actule_po_arr); die;*/
		?>
		<div id="div_size_color_matrix" class="pagebreak">
            <fieldset id="div_size_color_matrix" >
                <legend>Actual PO Info</legend>
                <table  class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                    <tr>
                    	<td>PO Number</td>
                    	<td>Actual PO</td>
                    	<td>PO Received Date</td>
                    	<td>Ship Date</td>
                    	<td>Gmts Item</td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                        <?
                        foreach($actule_po_size  as $result_size)
                        {
							?>
                        	<td align="center" style="border:1px solid black"><?=$size_library[$result_size[csf('gmts_size_id')]];?></td>
                        <? } ?>
                        <td  align="center"> Total Order Qty(Pcs)</td>
                    </tr>
                    <?
					foreach ($actule_po_arr as $po_id=>$po_data) 
					{	$k=1;
						foreach ($po_data as $actule_po_id=>$data) {
							$total_size_qty=0;
							if($k==1){
						 	?>
							<tr>
								<td rowspan="<? echo count($po_data)?>"><?php echo $data['po_number'] ?></td>
								<td><?php echo $data['acc_po_no'] ?></td>								
								<td><?php echo change_date_format($data['po_received_date']) ?></td>		
								<td><?php echo change_date_format($data['acc_ship_date']) ?></td>			
								<td><?php echo $garments_item[$data['gmts_item']] ?></td>
								<td><?php echo $color_library[$data['gmts_color_id']] ?></td>
								<?php
								foreach($actule_po_size  as $result_size)
		                        {
		                        	$size_qty=$actual_color_size[$po_id][$actule_po_id][$data['gmts_item']][$data['gmts_color_id']][$result_size[csf('gmts_size_id')]];
		                        	$total_size_qty+=$size_qty;
									?>
		                        	<td align="center" width="30"><? echo $size_qty; ?></td>
		                        <? } ?>
		                        <td><? echo $total_size_qty ?></td>				
							</tr>
							<? 
							}
							else{ ?>
								<tr>
									<td><?php echo $data['acc_po_no'] ?></td>								
									<td><?php echo change_date_format($data['po_received_date']) ?></td>		
									<td><?php echo change_date_format($data['acc_ship_date']) ?></td>			
									<td><?php echo $garments_item[$data['gmts_item']] ?></td>
									<td><?php echo $color_library[$data['gmts_color_id']] ?></td>
									<?php
									foreach($actule_po_size  as $result_size)
			                        {
										$size_qty=$actual_color_size[$po_id][$actule_po_id][$data['gmts_item']][$data['gmts_color_id']][$result_size[csf('gmts_size_id')]];
										$total_size_qty+=$size_qty;
										?>
		                        	<td align="center" width="30"><? echo $size_qty; ?></td>
			                        <? } ?>
			                        <td><? echo $total_size_qty ?></td>					
								</tr>
							<? }
							$k++;
						}
					}
                    ?>       
                </table>
            </fieldset>
        </div>

         <!--<br><br><br><br>-->
        
       </div>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}
// B16 END

if($action=="show_fabric_booking_report23")
{
	extract($_REQUEST);
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
ob_start();
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
           <tr>
               <td width="100">
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>

								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$sample_booking_arr=array();
				$namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
				foreach($namesamplefab as $namesamplefabrow){
					$sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
					$sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
				}
				$sample_booking_no=implode($sample_booking_arr['booking_no']);
				$sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$booking_percent=0;
				$booking_po_id='';
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.tagged_booking_no, a.uom,a.pay_mode,a.booking_percent,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.order_repeat_no,b.repeat_job_no,a.fabric_composition,a.remarks from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
                foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$booking_uom=$result[csf('uom')];
					$booking_percent=$result[csf('booking_percent')];
					$po_no="";
					$booking_po_id=$result[csf('po_break_down_id')];
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff, DATEDIFF(pub_shipment_date,factory_received_date) as facdate_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff, (pub_shipment_date-factory_received_date) as  facdate_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					$cbdlead_time="";
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
						$cbdlead_time.=$row_lead_time[csf('facdate_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}

					}

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				?>
       <table width="100%" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:16px;"><b>Dept. <? if($result[csf('product_code')] !=""){ echo " (Prod Code)";} if($result[csf('pro_sub_dep')] !=0){ echo " (Sub Dep)";} ?></b></span></td>
                <td width="110" style="font-size:16px;">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:16px;"><b>Order Qnty</b></span></td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:16px;"><b>Garments Item</b></td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:16px;"><b>Booking Release Date</b></td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
				}
				$booking_date=$result[csf('insert_date')];
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td  width="100" style="font-size:16px;"><b>Style Des.</b></td>
                <td  width="110"style="font-size:16px;" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:16px"><b>Lead Time </b>   </td>
                <td width="110" style="font-size:16px;">:&nbsp;<?  echo rtrim($lead_time,",");?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td width="100" style="font-size:16px;"><b>Supplier Name</b>   </td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>    </td>
                <td width="100" style="font-size:16px;"><b>Delivery Date</b></td>
               	<td width="110" style="font-size:16px;">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>

                  <?
				if($db_type==0)
				{
					$last_update_date=return_field_value("max(date(update_date)) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
				}
				else
				{
					$last_update_date=return_field_value("max(to_char(update_date,'DD-MM-YYYY')) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
				}
				?>


            </tr>
            <tr>
                <td width="100" style="font-size:16px;"><b>Season</b></td>
                <td width="110" style="font-size:16px;">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  width="100" style="font-size:16px"><b>Last Update Date</b></td>
                <td width="100" style="font-size:18px">:&nbsp;<b><? if($last_update_date!="" && $last_update_date!="0000-00-00") echo change_date_format($last_update_date);?></b></td>
                <td  width="100" style="font-size:16px;"><b>Po Received Date</b></td>
                <td  width="110" style="font-size:16px;">:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Order No</b></td>
               <td width="110" style="font-size:18px" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>

            </tr>
            <tr>
               <td width="100" style="font-size:16px;"><b>Shipment Date</b></td>
                <td width="110" colspan="5" style="font-size:16px;"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>

            </tr>

            </tr>
            <tr>
               <td width="100" style="font-size:16px;"><b>WO Prepared After</b></td>
               <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($WOPreparedAfter,',').' Days' ?></td>

               <td width="100" style="font-size:12px;"><b>Ship.days in Hand</b></td>
               <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($daysInHand,',').' Days'?></td>

               <td width="100" style="font-size:12px"><b>Ex-factory status</b></td>
               <td width="110"> :&nbsp;<? echo rtrim($shiping_status,','); ?></td>

            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Internal Ref No</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>

               <td width="100" style="font-size:18px"><b>File no</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
               <td width="100" style="font-size:18px"><b>Order Repeat No</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $result[csf('order_repeat_no')];?></b></td>
            </tr>
             <tr>
               <td width="100" style="font-size:18px"><b>Remarks</b></td>
               <td style="font-size:18px" colspan="3"> :<? echo $result[csf('remarks')]?></td>
               <td width="100" style="font-size:18px"><b>Order Repeat Job No</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $result[csf('repeat_job_no')];?></b></td>
          </tr>

           <tr>
               <td width="130" style="font-size:18px"><b>Fabric Composition</b></td>
               <td style="font-size:18px" colspan="3"> :<? echo $result[csf('fabric_composition')]?></td>
               <td width="100" style="font-size:18px"><b>CBD Lead Time</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><?  echo rtrim($cbdlead_time,","); ?></b></td>
          </tr>
           <tr>
               <td width="130" style="font-size:18px"><b>Attention</b></td>
               <td style="font-size:18px" colspan="5"> : &nbsp; <? echo $result[csf('attention')]?></td>
          </tr>



            <?php if ($sample_booking_no != '') {?>
                <tr>
                    <td colspan="5" align="center">
                  <strong> <? echo "Fabric of Sample Fabric Booking No:".$sample_booking_no.", Total Fabric=".$sample_booking_qty." KG,
will be Dyed with this fabric."; ?> </strong>
                    </td>
                </tr>
            <?php }?>

        </table>
           <?
			}
			if($cbo_fabric_source==1)
			{
				$color_size_qty_arr=array();
				$nameArray_color_size_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, plan_cut_qnty as plan_cut_qnty, order_quantity as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).")  and  status_active=1 and is_deleted =0");//and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c]
				foreach($nameArray_color_size_qnty  as $rowcs)
				{
					$color_size_qty_arr[$rowcs[csf('item_number_id')]][$rowcs[csf('color_number_id')]][$rowcs[csf('size_number_id')]]['qty']+=$rowcs[csf('order_quantity')];
					$color_size_qty_arr[$rowcs[csf('item_number_id')]][$rowcs[csf('color_number_id')]][$rowcs[csf('size_number_id')]]['plan']+=$rowcs[csf('plan_cut_qnty')];
				}
				unset($nameArray_color_size_qnty);
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" style="font-family:Arial Narrow;" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						/*$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {*/
                        ?>
                            <td style="border:1px solid black; text-align:center; font-size:18px;">
							<?
								$order_quantity=$color_size_qty_arr[$gmts_item[$c]][$result_color[csf('color_number_id')]][$result_size[csf('size_number_id')]]['qty'];
								$plan_cut_qnty=$color_size_qty_arr[$gmts_item[$c]][$result_color[csf('color_number_id')]][$result_size[csf('size_number_id')]]['plan'];
								if($plan_cut_qnty!= "")
								{
									 echo number_format($order_quantity,0);
									 $color_total += $plan_cut_qnty;
									 $color_total_order += $order_quantity ;
									 $item_grand_total+=$plan_cut_qnty;
									 $item_grand_total_order+=$order_quantity;
								     $grand_total +=$plan_cut_qnty;
									 $grand_total_order +=$order_quantity;

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$plan_cut_qnty;
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$order_quantity;
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$plan_cut_qnty;
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$order_quantity;
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$plan_cut_qnty;
										$size_tatal_order[$result_size[csf('size_number_id')]]=$order_quantity;
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$plan_cut_qnty;
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$order_quantity;
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$plan_cut_qnty;
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$order_quantity;
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						//}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                    $path='../../';
                    }

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
			}// if($cbo_fabric_source==1) end

	  ?>
      <br/>

      <!--  Here will be the main portion  -->
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";

				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	 ?>

     <?
if($cbo_fabric_source==1)
{
$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id,a.item_number_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type,b.remarks, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , max(a.avg_cons) as requirmentt,avg(b.requirment) as  requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and
d.status_active=1 and
d.is_deleted=0 and
b.cons>0
group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.item_number_id,a.construction,a.composition,a.gsm_weight,b.remarks,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");// avg(b.requirment) as requirment

	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <!--<td  rowspan="10" width="50"><p>Total  Finish Fabric <?// if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="10" width="50"><p>Total Grey Fabric <?// if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>-->
        <td  rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
        <!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
             <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
       </tr>

        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			$determin_id=$result_fabric_description[csf('determin_id')];
			$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
			if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $s_length."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
		}
		?>

       </tr>
       <?
	   	$color_wise_wo_sql="select a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";

		$color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
		foreach($color_wise_wo_sql_res as $row)
		{
			$fin_grey_qty_arr[$row[csf('item_number_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('dia_width')]][$row[csf('remarks')]]['fin']+=$row[csf('fin_fab_qnty')];
			$fin_grey_qty_arr[$row[csf('item_number_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('dia_width')]][$row[csf('remarks')]]['grey']+=$row[csf('grey_fab_qnty')];

			$fin_grey_color_qty_arr[$row[csf('item_number_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('dia_width')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['fin']+=$row[csf('fin_fab_qnty')];
			$fin_grey_color_qty_arr[$row[csf('item_number_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('dia_width')]][$row[csf('remarks')]][$row[csf('fabric_color_id')]]['grey']+=$row[csf('grey_fab_qnty')];

		}
		unset($color_wise_wo_sql_res);

				/*a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and*/




		$gmt_color_library=array();
		$gmt_color_data=sql_select("select a.body_part_id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no  and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");

		foreach( $gmt_color_data as $gmt_color_row)
		{
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		}

		$lab_dip_no_arr=array();
		$lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
		foreach($lab_dip_no_sql as $row)
		{
			$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
		}
		unset($lab_dip_no_sql);

		$grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
		if ($db_type == 2) $group_concat = "listagg(gmts_color_id ,',') within group (order by gmts_color_id) as gmts_color_id ";
		else $group_concat = "group_concat(gmts_color_id) as gmts_color_id ";
		$color_wise_wo_sql=sql_select("select fabric_color_id,$group_concat FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
            <td><?
			/*$gmts_color_ids=array_unique(explode(",",$color_wise_wo_result[csf('gmts_color_id')]));
			$gmt_color="";
			foreach($gmts_color_ids as $color_id )
			{
				$gmt_color.=$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]][$color_id].',';
			}
			if(rtrim($gmt_color,',')=="") $gmt_color=$color_library[$color_wise_wo_result[csf('fabric_color_id')]];*/
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			 //echo rtrim($gmt_color,',');
			 ?></td>
            <td width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
			//return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and status_active=1 and is_deleted=0 and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}*/
				$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
				$color_wo_fin_qnty=$fin_grey_color_qty_arr[$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('determin_id')]][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('remarks')]][$color_wise_wo_result[csf('fabric_color_id')]]['fin'];

				$color_wo_grey_qnty=$fin_grey_color_qty_arr[$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('determin_id')]][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('remarks')]][$color_wise_wo_result[csf('fabric_color_id')]]['grey'];

				//list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='center' style="font-size:18px;">
			<?
			if($color_wo_fin_qnty!="")
			{
			echo number_format($color_wo_fin_qnty,2) ;
			$total_fin_fab_qnty+=$color_wo_fin_qnty;
			}
			?>
            </td>
            <td width='50' align='center' style="font-size:18px;">
			<?
			if($color_wo_grey_qnty!="")
			{
			echo number_format($color_wo_grey_qnty,2);
			$total_grey_fab_qnty+=$color_wo_grey_qnty;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

            <td align="center" style="font-size:18px;">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$wo_fin_qnty=0; $wo_grey_qnty=0;
				$wo_fin_qnty=$fin_grey_qty_arr[$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('determin_id')]][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('remarks')]]['fin'];

				$wo_grey_qnty=$fin_grey_qty_arr[$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('determin_id')]][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('remarks')]]['grey'];

				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
			?>
			<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
            <?
			}
			?>
            <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="center" style="font-size:18px;">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

			?>
			<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="center" style="font-size:18px;">
			<?
			//echo $grand_total_fin_fab_qnty;
			echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
			?>
            </td>
            <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="center" style="font-size:18px;">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	if($cbo_fabric_source==2)
	{
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id,  a.lib_yarn_count_deter_id as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       <!--<td  rowspan="10" width="50"><p>Total Fabric <?// if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="10" width="50"><p>Avg Rate <?// if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>-->

        <td  rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
        <td  rowspan="10" width="50"><p>Amount </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";

		}
		?>
        <!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
             <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			$determin_id=$result_fabric_description[csf('determin_id')];
			$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
			if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $s_length."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";

			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no=b.job_no and
		  b.job_no ='$job_no'");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {

			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;

			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,4);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    //$colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
													 $colar_excess_per=($plan_cut*$collar_ex_per)/100;
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty,0);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar,0); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty,0); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar,0); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>
        <table width="100%" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
            <tr align="center">
            	<td colspan="6"><b>Dye To Match</b></td>
            </tr>
            <tr align="center">
                <td>Sl</td>
                <td>Item </td>
                <td>Body Color</td>
                <td>Item Color</td>
                <td>Dyeing Qnty.</td>
                <td>UOM</td>
            </tr>
            <?
            $lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");

            $sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
            $bookingId=0;
            foreach($sql as $row)
            {
            	$bookingId= $row[csf('id')];
            }
            $sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
            $i=0; $dyeing_qty=0;
            foreach($sql_data  as $row)
            {
				$i++;
				?>
				<tr align="center">
                    <td><? echo $i; ?></td>
                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
                    <td align="right"><? echo number_format($row[csf('qty')],2);?></td>
                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
				</tr>
				<?
				$dyeing_qty+=$row[csf('qty')];
            }
            ?>
            <tr align="center">
                <td colspan="4" align="right">Total</td>
                <td align="right"><? echo number_format($dyeing_qty,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
        </table>
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <caption> <strong style="float:left"> Stripe Details</strong></caption>
        <?
		$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		$sql_stripe="SELECT c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ";
		//echo $sql_stripe; die;
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row){
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
		}
		?>

            <tr>
            <th width="30"> SL</th>
            <th width="100"> Body Part</th>
            <th width="80"> Fabric Color</th>
            <th width="70"> Fabric Qty(KG)</th>
            <th width="70"> Stripe Color</th>
            <th width="70"> Stripe Measurement</th>
            <th width="70"> Stripe Uom</th>
            <th  width="70"> Qty.(KG)</th>
            <th  width="70"> Y/D Req.</th>
            </tr>
            <?
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					/*if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
					?>
					<tr>
					<?
					//$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];//$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					$color_qty= array_sum($stripe_arr[$body_id][$color_id]['fabreqtotkg']);
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_qty;
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <tr align="center">
        <td colspan="10"><b>Comments</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
		<td>Order Status</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("
        select
        a.id,
        a.item_number_id,
        a.costing_per,
        b.po_break_down_id,
        b.color_size_table_id,
        b.requirment,
        c.po_number
        FROM
        wo_pre_cost_fabric_cost_dtls a,
        wo_pre_cos_fab_co_avg_con_dtls b,
        wo_po_break_down c
        WHERE
        a.job_no=b.job_no and
        a.job_no=c.job_no_mst and
        a.id=b.pre_cost_fabric_cost_dtls_id and
        b.po_break_down_id=c.id and
        b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
        order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,a.is_confirmed,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number,a.is_confirmed order by id");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
		 <td><? echo $order_status[$row[csf("is_confirmed")]]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="4">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>
       <br>

<fieldset id="div_size_color_matrix" style="max-width:1000;">
<?
//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		?>
        <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
         <br/> <br/>
         <?

		// $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");

	// $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
	// echo "select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc";

	 $lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
		 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
		 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
	//echo $mst_id.'ssD';
	//and b.un_approved_date is null
	 $approve_data_array=sql_select("select b.approved_by,min(b.approved_date) as approved_date from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  group by  b.approved_by order by b.sequence_no asc");


	 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");



     if(count($approve_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="40%" style="border:1px solid black;">Name</th>
				<th width="30%" style="border:1px solid black;">Designation</th>
				<th width="27%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
		<br>
		<?
		if(count($unapprove_data_array)>0)
		{
		$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
			$unapproved_request_arr=array();
			foreach($sql_unapproved as $rowu)
			{
				$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
			}
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($unapprove_data_array as $row){

			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<td width="20%" style="border:1px solid black;"><? echo '';?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
            </tr>
                <?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if($un_approved_date!="")
				{
				?>
			<tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
              </tr>

                <?
				$i++;
				}

			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}
/////////////////////////////////////////////////////
if($action=="show_fabric_booking_report1")
{

	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value("sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value("sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
ob_start();
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                                <!--<a href="requires/fabric_booking_urmi_controller.php?filename=welcome.html&action=download_file" style="text-transform:none">Download</a>-->
                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select("select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");

							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";
							}

                            foreach ($nameArray as $result)
                            {
							echo $location_name_arr[$location];
                            ?>
                                <!--Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No:   <? echo $result[csf('website')];


                            }
                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong>Fabric Dia & Garments Size Wise Finish Fabric Requirment<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.pay_mode,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time="";
                    if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:12px"><b>Garments Item</b></td>
                <td width="110">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Booking Release Date</b></td>
                <td width="110">:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>

            </tr>
             <tr>



                <td  width="100" style="font-size:12px"><b>Style Des.</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:12px"><b>Lead Time </b>   </td>
                <td width="110">:&nbsp;<?  echo rtrim($lead_time,",");;?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>



            </tr>

            <tr>
                <td width="100" style="font-size:12px"><b>Supplier Name</b>   </td>
                <td width="110">:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td width="100" style="font-size:12px"><b>Delivery Date</b></td>
               	<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>



            </tr>
            <tr>
                <td width="100" style="font-size:12px"><b>Season</b></td>
                <td width="110">:&nbsp;<? echo $result[csf('season')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Attention</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Po Received Date</b></td>
                <td  width="110" >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Order No</b></td>
                <td width="110" style="font-size:18px" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>

            </tr>
            <tr>
               <td width="100" style="font-size:12px"><b>Shipment Date</b></td>
                <td width="110" colspan="5"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>

            </tr>

        </table>
        <br/>
           <?
			}

	$po_color_size_qnty_array=array();
	$po_size_qnty_array=array();
		$sql="SELECT b.gmts_item_id as item_number_id, c.id as po_id, d.size_number_id, d.color_number_id, d.order_quantity as order_quantity, d.plan_cut_qnty as plan_cut_qnty
	FROM wo_po_details_master a, wo_po_details_mas_set_details b , wo_po_break_down c, wo_po_color_size_breakdown d
	WHERE
	a.job_no = b.job_no and
	a.job_no = c.job_no_mst and
	a.job_no = d.job_no_mst and
	b.gmts_item_id=d.item_number_id and
    c.id = d.po_break_down_id and
	c.id in(".str_replace("'","",$txt_order_no_id).") and
	a.is_deleted =0 and
	a.status_active=1 and
	c.is_deleted =0 and
	c.status_active =1 and
	d.is_deleted =0 and
	d.status_active =1
	";
	$sql_data = sql_select($sql);
	foreach( $sql_data as $row)
	{
	$po_color_size_qnty_array[$row[csf('po_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]+=$row[csf('plan_cut_qnty')];
	$po_size_qnty_array[$row[csf('size_number_id')]]+=$row[csf('plan_cut_qnty')];
	}

    $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.process_loss_percent) as  process_loss_percent FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and
a.body_part_id in(1,20) and
d.status_active=1 and
d.is_deleted=0
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="6" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="8" width="50"><p>Total  Finish Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>


       </tr>
     <tr align="center"><th colspan="6" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>

       </tr>
        <tr align="center"><th colspan="6" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>".$result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="6" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="6" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td  align='center' colspan='2'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="6" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td  align='center' colspan='2'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>
       </tr>

       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+6; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="50" align="left">Sl</th>
            <th  width="120" align="left">PO No</th>
            <th  width="120" align="left">Gmt Item</th>
            <th  width="120" align="left">Gmt Color</th>
            <th  width="120" align="left">Gmt Size</th>
            <th  width="100" align="left">Plan Cut Qty</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab.Color</th><th width='50'>Finish</th>";
		}
		?>

       </tr>
       <?
	   	$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");
	    $i=1;
		$total_plan_cut_qnty=0;
		$grand_total_fin_fab_qnty=0;
		$color_wise_wo_sql= sql_select("select b.po_break_down_id, c.item_number_id,c.color_number_id,c.size_number_id, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
		WHERE a.job_no=b.job_no and
		a.id=b.pre_cost_fabric_cost_dtls_id and
		c.job_no_mst=a.job_no and
		c.id=b.color_size_table_id and
		b.po_break_down_id=d.po_break_down_id and
		b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
		d.booking_no =$txt_booking_no and
		a.body_part_id in(1,20) and
		d.status_active=1 and
		d.is_deleted=0
		group by b.po_break_down_id,c.item_number_id,c.color_number_id,c.size_number_id order by b.po_break_down_id, c.item_number_id,c.color_number_id,c.size_number_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td>
            <?
			echo $i;
			?>
            </td>
            <td>
            <?
			echo $po_number[$color_wise_wo_result[csf('po_break_down_id')]];
			?>
            </td>
            <td>
            <?
			echo $garments_item[$color_wise_wo_result[csf('item_number_id')]];
			?>
            </td>
            <td>
            <?
			echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
			?>
            </td>

            <td  width="120" align="left">
			<?
			echo $size_library[$color_wise_wo_result[csf('size_number_id')]];
			?>
            </td>

            <td  width="100" align="right">
			<?
			$plan_cut_qty=$po_color_size_qnty_array[$color_wise_wo_result[csf('po_break_down_id')]][$color_wise_wo_result[csf('item_number_id')]][$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]];
			echo $po_color_size_qnty_array[$color_wise_wo_result[csf('po_break_down_id')]][$color_wise_wo_result[csf('item_number_id')]][$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]];
			$total_plan_cut_qnty+=$po_color_size_qnty_array[$color_wise_wo_result[csf('po_break_down_id')]][$color_wise_wo_result[csf('item_number_id')]][$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]];
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select avg(b.cons) as cons,min(d.fabric_color_id) as fabric_color_id, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.po_break_down_id=".$color_wise_wo_result[csf('po_break_down_id')]." and
				c.item_number_id=".$color_wise_wo_result[csf('item_number_id')]." and
				c.color_number_id=".$color_wise_wo_result[csf('color_number_id')]." and
				c.size_number_id=".$color_wise_wo_result[csf('size_number_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
            <td width='50' align='right'>
			<?


			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo $color_library[$color_wise_wo_result_qnty[csf('fabric_color_id')]] ;
			}
			?>
            </td>

			<td width='50' align='right'>
            <span style="border-bottom:1px solid; border-bottom-color:#000; width:100%">
            <?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4);
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </span>
            <br/>
            <span>
            <?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo "<font style='font-size:10px'>Cons:".number_format($color_wise_wo_result_qnty[csf('cons')],4)."</font>";
			}
			?>
            </span>

            </td>

            <?
			}
			?>
             <td align="right">
			 <? echo number_format($total_fin_fab_qnty,4); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?>
             </td>
            </tr>
         <?
		 $i++;
		}
		?>
        <tr style=" font-weight:bold">

        <td  width="120" align="left" colspan="5"><strong>Total</strong></td>
        <td  width="120" align="right"><? echo $total_plan_cut_qnty; ?></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
            <td width='50' align='right'><?  //echo number_format($color_wise_wo_result_qnty['fin_fab_qnty'],4) ;?></td>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4) ;?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,4);?></td>

            </tr>
    </table>
    <br/>
    <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo  $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>
                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report2")
{

	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value("sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value("sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
ob_start();
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="200">
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                              <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                           $nameArray=sql_select("select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						   if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";
							}

                            foreach ($nameArray as $result)
                            {
								echo $location_name_arr[$location];
                            ?>
                                <!--Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?>--><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')];


                            }
                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong>Fabric Dia & Garments Size Wise Finish Fabric Requirment<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
				listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
            	$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".str_replace("'","",$txt_order_no_id).") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.pay_mode,a.fabric_composition,a.rmg_process_breakdown,a.insert_date,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time="";

					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:12px"><b>Garments Item</b></td>
                <td width="110">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Booking Release Date</b></td>
                <td width="110">:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>

            </tr>
             <tr>



                <td  width="100" style="font-size:12px"><b>Style Des.</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:12px"><b>Lead Time </b>   </td>
                <td width="110">:&nbsp;<?  echo rtrim($lead_time,",");;?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>



            </tr>

            <tr>
                <td width="100" style="font-size:12px"><b>Supplier Name</b>   </td>
                <td width="110">:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td width="100" style="font-size:12px"><b>Delivery Date</b></td>
               	<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>



            </tr>
            <tr>
                <td width="100" style="font-size:12px"><b>Season</b></td>
                <td width="110">:&nbsp;<? echo $result[csf('season')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Attention</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Po Received Date</b></td>
                <td  width="110" >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
            <tr>
                <td style="font-size:18px"><b>Internal Ref No</b></td>
                <td style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>
                <td style="font-size:18px"><b>File no</b></td>
                <td style="font-size:18px" colspan="3"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Order No</b></td>
                <td width="110" style="font-size:18px" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>

            </tr>
            <tr>
               <td width="100" style="font-size:12px"><b>Shipment Date</b></td>
                <td width="110" colspan="5"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>

            </tr>
            <tr>
               <td width="100" style="font-size:12px"><b>Fab. Composition</b></td>
                <td width="110" colspan="5"> :&nbsp;<? echo $result[csf('fabric_composition')];; ?></td>

            </tr>

        </table>
        <br/>
           <?
			}

	$po_color_size_qnty_array=array();
	$po_size_qnty_array=array();
	$sql="SELECT b.gmts_item_id as item_number_id, c.id as po_id, d.size_number_id, d.color_number_id, d.order_quantity as order_quantity, d.plan_cut_qnty as plan_cut_qnty
	FROM wo_po_details_master a, wo_po_details_mas_set_details b , wo_po_break_down c, wo_po_color_size_breakdown d
	WHERE
	a.job_no = b.job_no and
	a.job_no = c.job_no_mst and
	a.job_no = d.job_no_mst and
	b.gmts_item_id=d.item_number_id and
    c.id = d.po_break_down_id and
	c.id in(".str_replace("'","",$txt_order_no_id).") and
	a.is_deleted =0 and
	a.status_active=1 and
	c.is_deleted =0 and
	c.status_active =1 and
	d.is_deleted =0 and
	d.status_active =1
	";
	$sql_data = sql_select($sql);
	foreach( $sql_data as $row)
	{
	$po_color_size_qnty_array[$row[csf('color_number_id')]][$row[csf('size_number_id')]][order_quantity]+=$row[csf('order_quantity')];
	$po_color_size_qnty_array[$row[csf('color_number_id')]][$row[csf('size_number_id')]][plan_cut_qnty]+=$row[csf('plan_cut_qnty')];
	$po_size_qnty_array[$row[csf('size_number_id')]]+=$row[csf('order_quantity')];
	$color_wise_row[$row[csf('color_number_id')]]+=1;
	}

    $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.uom FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and

d.status_active=1 and
d.is_deleted=0
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.uom order by a.body_part_id");


	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="7" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='4'>&nbsp</td>";
			else         		               echo "<td  colspan='4'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
		<? foreach($nameArray_fabric_description  as $row)
		{
			$uom_arr[$row[csf('uom')]] = $unit_of_measurement[$row[csf('uom')]];
		} ?>
        <td  rowspan="7" width="50"><p>Total  Finish Fabric <? echo implode(",", $uom_arr) ?></p></td>
        <? //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";}?>


       </tr>
     <tr align="center"><th colspan="7" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td colspan='4'>&nbsp</td>";
			else         		               echo "<td  colspan='4'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>

       </tr>
        <tr align="center"><th colspan="7" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='4'>&nbsp</td>";
			else         		               echo "<td  colspan='4'>".$result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="7" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td  colspan='4'>&nbsp</td>";
			else         		               echo "<td  colspan='4'>".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="7" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='4'>&nbsp</td>";
			else         		       echo "<td  align='center' colspan='4'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>


       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*4+7; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="50" align="left">Sl</th>
            <th  width="120" align="left">Gmt Color</th>
            <th  width="120" align="left">Gmt Size</th>
            <th  width="100" align="left">Article No</th>
            <th  width="120" align="left">Order Qty (Pcs)</th>
            <th  width="100" align="left">Excess Cut %</th>
            <th  width="120" align="left">Plan Cut Qty (Pcs)</th>

        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab.Color</th><th width='50'>Dia/Width</th><th width='50'>Cons/pcs</th><th width='50'>Finish</th>";
		}
		?>

       </tr>
       <?
	   $total_ord_cut_qnty=0;
	   $total_plan_cut_qnty=0;
	   $grand_total_fin_fab_qnty=0;
	    $i=1;
	   foreach($color_wise_row as $key => $value)
	   {

		$color_total_ord_cut_qnty=0;
	    $color_total_plan_cut_qnty=0;
		$color_grand_total_fin_fab_qnty=0;
		$color_wise_wo_sql= sql_select("select c.color_number_id,c.article_number,c.size_number_id, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d

		WHERE a.job_no=b.job_no and
		a.id=b.pre_cost_fabric_cost_dtls_id and
		c.job_no_mst=a.job_no and
		c.id=b.color_size_table_id and
		b.po_break_down_id=d.po_break_down_id and
		b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
		d.booking_no =$txt_booking_no and
		c.color_number_id = $key and
		d.status_active=1 and
		d.is_deleted=0
		group by c.color_number_id,c.size_number_id,c.article_number order by c.color_number_id,c.size_number_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td>
            <?
			echo $i;
			?>
            </td>
            <td>
            <?
			echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
			?>
            </td>
            <td>
            <?
			echo $size_library[$color_wise_wo_result[csf('size_number_id')]];
			?>
            </td>
             <td>
            <?
			 	echo $color_wise_wo_result[csf('article_number')];
			?>
            </td>
            <td align="right">
            <?
			$ord_cut_qty=$po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][order_quantity];
			echo number_format($ord_cut_qty,2);
			$total_ord_cut_qnty+=$po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][order_quantity];
			$color_total_ord_cut_qnty+=$po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][order_quantity];
			?>
            </td>
            <td  width="100" align="right">
			<?
			$excess_per=(($po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][plan_cut_qnty]-$ord_cut_qty)/$ord_cut_qty)*100;
			echo number_format($excess_per,2);
			?>
            </td>

            <td  width="120" align="right">
			<?
			$plan_cut_qty=$po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][plan_cut_qnty];
			echo number_format($plan_cut_qty,2);
			$total_plan_cut_qnty+=$po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][plan_cut_qnty];
			$color_total_plan_cut_qnty+=$po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][plan_cut_qnty];
			?>
            </td>


            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, min(a.width_dia_type) as width_dia_type, avg(b.cons) as cons ,min(b.dia_width) as dia_width , min(d.fabric_color_id) as fabric_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				c.color_number_id=".$color_wise_wo_result[csf('color_number_id')]." and
				c.size_number_id=".$color_wise_wo_result[csf('size_number_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
            <td width='50' align=''>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo $color_library[$color_wise_wo_result_qnty[csf('fabric_color_id')]] ;
			}
			?>
            </td>
            <td width='50' align=''>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo $color_wise_wo_result_qnty[csf('dia_width')].",".$fabric_typee[$color_wise_wo_result_qnty[csf('width_dia_type')]] ;
			}
			?>
            </td>
            <td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[Csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')]/$po_color_size_qnty_array[$color_wise_wo_result[csf('color_number_id')]][$color_wise_wo_result[csf('size_number_id')]][plan_cut_qnty],4);
			}
			?>
            </td>

			<td width='50' align='right'>

            <?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4);
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>



            </td>

            <?
			}
			?>
             <td align="right">
			 <? echo number_format($total_fin_fab_qnty,4); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty; $color_grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?>
             </td>
            </tr>
         <?
		 $i++;
		}
		?>
        <tr style=" font-weight:bold; background-color:#CCC">

        <td  width="120" align="left" colspan="4"><strong>Color Total</strong></td>
         <td  width="120" align="right"><? echo $color_total_ord_cut_qnty; ?></td>
         <td  width="120" align="right">
		 <?
		 $color_excess_per_tot=(($color_total_plan_cut_qnty-$color_total_ord_cut_qnty)/$color_total_ord_cut_qnty)*100;
		 echo number_format($color_excess_per_tot,2);
		 ?></td>
        <td  width="120" align="right"><? echo $color_total_plan_cut_qnty; ?></td>

        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												c.color_number_id=".$color_wise_wo_result[csf('color_number_id')]." and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
            <td width='50' align='right'><?  //echo number_format($color_wise_wo_result_qnty['fin_fab_qnty'],4) ;?></td>
            <td width='50' align='right'><?  //echo number_format($color_wise_wo_result_qnty['fin_fab_qnty'],4) ;?></td>
            <td width='50' align='right'><?  //echo number_format($color_wise_wo_result_qnty['fin_fab_qnty'],4) ;?></td>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4) ;?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($color_grand_total_fin_fab_qnty,4);?></td>

            </tr>
        <?
	   }
		?>
        <tr style=" font-weight:bold">

        <td  width="120" align="left" colspan="4"><strong>Grand Total</strong></td>
         <td  width="120" align="right"><? echo $total_ord_cut_qnty; ?></td>
         <td  width="120" align="right">
		 <?
		 $excess_per_tot=(($total_plan_cut_qnty-$total_ord_cut_qnty)/$total_ord_cut_qnty)*100;
		 echo number_format($excess_per_tot,2);
		 ?></td>
        <td  width="120" align="right"><? echo $total_plan_cut_qnty; ?></td>

        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and

												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
            <td width='50' align='right'><?  //echo number_format($color_wise_wo_result_qnty['fin_fab_qnty'],4) ;?></td>
            <td width='50' align='right'><?  //echo number_format($color_wise_wo_result_qnty['fin_fab_qnty'],4) ;?></td>
            <td width='50' align='right'><?  //echo number_format($color_wise_wo_result_qnty['fin_fab_qnty'],4) ;?></td>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4) ;?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,4);?></td>

            </tr>
    </table>
    <br/>
    <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo  $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
            <tr>
              <td width="2%">&nbsp;
            </td>
            </tr>
            <br/>
            <tr>
            <td width="49%" valign="top" align="center">
            <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
            </td>
            </tr>
        </table>
        <br/>
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}

		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report3")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");

	$po_number_arr=return_library_array( "select id,po_number from   wo_po_break_down",'id','po_number');
	$po_ship_date_arr=return_library_array( "select id,pub_shipment_date from   wo_po_break_down ",'id','pub_shipment_date');
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$nameArray2 = sql_select("select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.uom,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.pay_mode,a.rmg_process_breakdown,a.insert_date,a.update_date,a.booking_percent,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,a.po_break_down_id from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
foreach ($nameArray2 as $result) {
	if ($db_type == 2) {
		$group_concat_all = " listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
	} else { $group_concat_all = "group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

	$data_array3 = sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (" . $result[csf("po_break_down_id")] . ") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
	foreach ($data_array3 as $inv) {
		$grouping = implode(",", array_unique(explode(",", $inv[csf("grouping")])));
		$file_no = implode(",", array_unique(explode(",", $inv[csf("file_no")])));
	}
}
ob_start();
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
								echo $company_library[$cbo_company_name];
								?>
                            </td>
                            <td rowspan="3" width="250">

                                <!--<a href="requires/fabric_booking_urmi_controller.php?filename=welcome.html&action=download_file" style="text-transform:none">Download</a>-->
                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b><br><b>Internal Ref:&nbsp;&nbsp;<? echo $grouping; ?></b></span><br/>

                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                           $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";
							}
                            foreach ($nameArray as $result)
                            {
								echo $location_name_arr[$location];
                            ?>
                                <!--Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?>--> <br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No:   <? echo $result[csf('website')];



                            }
                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? echo $report_title;?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";} else if(str_replace("'","",$id_approved_id) ==3){ echo "(Partial Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$booking_percent=0;
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.uom,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.pay_mode,a.rmg_process_breakdown,a.insert_date,a.update_date,a.booking_percent,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,a.po_break_down_id from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$booking_percent=$result[csf('booking_percent')];
					$cons_uom=$result[csf('uom')];

					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
					else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

					$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf("po_break_down_id")].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
					foreach($data_array3 as $inv)
					{
					$grouping=implode(",",array_unique(explode(",",$inv[csf("grouping")])));
					$file_no=implode(",",array_unique(explode(",",$inv[csf("file_no")])));
					/*echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";
					echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";*/
					}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:12px"><b>Garments Item</b></td>
                <td width="110">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Booking Release Date</b></td>
                <td width="110">:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>

            </tr>
             <tr>



                <td  width="100" style="font-size:12px"><b>Style Des.</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:12px"><b>Lead Time </b>   </td>
                <td width="110">:&nbsp;<?  echo rtrim($lead_time,",");;?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>



            </tr>

            <tr>
                <td width="100" style="font-size:12px"><b>Supplier Name</b>   </td>
                <td width="110">:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Delivery Date</b></td>
               	<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>



            </tr>
            <tr>
                <td width="100" style="font-size:12px"><b>Season</b></td>
                <td width="110">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  width="100" style="font-size:12px"><b>Attention</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Po Received Date</b></td>
                <td  width="110" >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>


        </table>
           <?
			}

			$nameArray_size=sql_select( "select distinct size_number_id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by size_order");
		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown </legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>PO Number</strong></td>
                        <td style="border:1px solid black"><strong>Ship Date</strong></td>
                        <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					$order_id=explode(",",str_replace("'","",$txt_order_no_id));
					for($or=0;$or<count($order_id); $or++)
				    {
						for($c=0;$c<count($gmts_item); $c++)
					    {
							$item_size_tatal=array();
							$item_size_tatal_order=array();
							$item_grand_total=0;
							$item_grand_total_order=0;
							$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
							?>
		                   <!-- <tr>
		                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

		                    </tr>-->
		                    <?
							foreach($nameArray_color as $result_color)
		                    {
		                    ?>
		                    <tr>
		                        <td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
		                         <td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
		                          <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
		                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
		                        <?
								$color_total=0;
								$color_total_order=0;

								foreach($nameArray_size  as $result_size)
								{
								$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity, excess_cut_perc  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0 group by excess_cut_perc");
								
								?>
								<td style="border:1px solid black; text-align:right">
								<?
								foreach($nameArray_color_size_qnty as $result_color_size_qnty)
		                        {

		                    
										if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
										{
											 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
											$order_qnty=$result_color_size_qnty[csf('order_quantity')];
													// $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
													$color_total += $order_qnty+($order_qnty*$result_color_size_qnty[csf('excess_cut_perc')])/100;

													$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
													// $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$item_grand_total+=$order_qnty+($order_qnty*$result_color_size_qnty[csf('excess_cut_perc')])/100;;
													$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
													// $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
													$grand_total +=$order_qnty+($order_qnty*$result_color_size_qnty[csf('excess_cut_perc')])/100;;
													$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
											 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
											 {
													$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
											 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
											 {
													$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
										}
										else echo "0";
									
								}
								?>
								</td>

								<?
		                        }
		                        ?>
		                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
		                        <td style="border:1px solid black; text-align:right"><?// $excexss_per=($color_total-$color_total_order)/$color_total_order*100; 
								 echo number_format($result_color_size_qnty[csf('excess_cut_perc')],2)." %"; ?></td>
		                         <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
		                    </tr>
		                    <?
		                    }
							?>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
		                        <?
								foreach($nameArray_size  as $result_size)
		                        {
		                        ?>
		                        <td style="border:1px solid black;  text-align:right"><b><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></b></td>
		                        <?
		                        }
		                        ?>
		                        <td  style="border:1px solid black;  text-align:right"><b><?  echo number_format(round($item_grand_total_order),0); ?></b></td>
		                        <td  style="border:1px solid black;  text-align:right"><b><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100;// echo number_format($excess_item_gra_tot,2)." %"; ?></b></td>
		                        <td  style="border:1px solid black;  text-align:right"><b><?  echo number_format(round($item_grand_total),0); ?></b></td>
		                    </tr>
		                    <?
						}
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; //echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
            	<?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{

					?>
					<td>
						<img src="../../<? echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
      <br/>   									 <!--  Here will be the main portion  -->
     <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	 </style>
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	if($costing_per_id==1)
	{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;

	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;



	$nameArray_fabric_description= sql_select("select a.body_part_id,a.lib_yarn_count_deter_id as determin_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent,avg(b.requirment) as  requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="5" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total  Finish Fabric <?  echo $unit_of_measurement[$cons_uom];//if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="10" width="50"><p>Total Grey Fabric <?  echo $unit_of_measurement[$cons_uom];//if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="10" width="50"><p>Process Loss % </p></td>
       </tr>
     	<tr align="center"><th colspan="5" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="5" align="left">Fabric Construction</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="5" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="5" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="5" align="left">Stitch Length</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			$determin_id=$result_fabric_description[csf('determin_id')];
			$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
			if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $s_length."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="5" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="5" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'> Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+5; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">PO Number</th>
            <th  width="120" align="left">Ship Date</th>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
		}
		?>

       </tr>
       <?


		  $gmt_color_library=array();//color_wise_wo_result[csf('po_break_down_id')]
		  $sql_color=sql_select("select a.po_break_down_id as po_id,b.gmts_color_id,b.contrast_color_id from
		  wo_booking_dtls a  , wo_pre_cos_fab_co_color_dtls b  
		 where    a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id  and a.job_no=b.job_no and b.gmts_color_id=a.gmts_color_id and b.status_active=1 and a.job_no ='$job_no'    and   a.status_active=1 ");
		  foreach( $sql_color as $row)
		  {
			if($row[csf("gmts_color_id")]!='')
			{
			$gmt_color_library2[$row[csf("po_id")]][$row[csf("contrast_color_id")]].=$color_library[$row[csf("gmts_color_id")]].',';
			}
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			
			$color_wise_wo_sql=sql_select("SELECT fabric_color_id ,po_break_down_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by po_break_down_id,fabric_color_id order by po_break_down_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
          <td  width="120" align="left">
			<?
			echo $po_number_arr[$color_wise_wo_result[csf('po_break_down_id')]];
			?></td>
             <td  width="120" align="left">
			<?

			echo change_date_format($po_ship_date_arr[$color_wise_wo_result[csf('po_break_down_id')]],"dd-mm-yyyy","-");

			?></td>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td> 
            <?
			$gmt_color=rtrim($gmt_color_library2[$color_wise_wo_result[csf('po_break_down_id')]][$color_wise_wo_result[csf('fabric_color_id')]],',');
			
			echo implode(",",array_unique(explode(",",$gmt_color)));
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and status_active=1 and is_deleted=0 and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and a.construction='".$result_fabric_description[csf('construction')]."' and a.composition='".$result_fabric_description[csf('composition')]."' and a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and b.dia_width='".$result_fabric_description[csf('dia_width')]."' and d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and b.po_break_down_id=".$color_wise_wo_result[csf('po_break_down_id')]." and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.status_active=1 and a.is_deleted=0
					");
				}
				if($db_type==2)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and a.construction='".$result_fabric_description[csf('construction')]."' and a.composition='".$result_fabric_description[csf('composition')]."' and a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and b.dia_width='".$result_fabric_description[csf('dia_width')]."' and nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and b.po_break_down_id=".$color_wise_wo_result[csf('po_break_down_id')]." and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.status_active=1 and a.is_deleted=0 ");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and a.construction='".$result_fabric_description[csf('construction')]."' and a.composition='".$result_fabric_description[csf('composition')]."' and a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and b.dia_width='".$result_fabric_description[csf('dia_width')]."' and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.status_active=1 and a.is_deleted=0 ");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
          <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and a.construction='".$result_fabric_description[csf('construction')]."' and a.composition='".$result_fabric_description[csf('composition')]."' and a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and b.dia_width='".$result_fabric_description[csf('dia_width')]."' and d.status_active=1 and d.is_deleted=0  and c.status_active=1 and c.is_deleted=0 and a.status_active=1 and a.is_deleted=0 ");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? // echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>

        <br/>

        <?
		$booking_po_id=str_replace("'","",$txt_order_no_id);
		$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];

				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];

				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];

				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('item_number_id')]]=$collar_cuff_row[csf('item_number_id')];

			}
			/* echo '<pre>';
			print_r($collar_cuff_item_size_arr) ;
			die; */
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 /* foreach($size_number  as $item_size=>$val)
									 { */
										?>
										<td align="center" style="border:1px solid black"><strong><? echo implode(", ",$size_number);?></strong></td>
										<?
									 /* } */
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
													if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                   $tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
												    $collerqty=($plan_cut+$colar_excess_per);

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <!--<td><? //echo number_format(($row['yarn_required']/$po_qnty_tot)*$costing_per_qnty,2); ?></td>-->
                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
            if($result[csf("costing_per")]==1)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==2)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==3)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==4)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==5)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	$total_pre_cost=0;
	$total_booking_qnty_main=0;
	$total_booking_qnty_short=0;
	$total_booking_qnty_sample=0;
	$total_tot_bok_qty=0;
	$tot_balance=0;

	$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

	$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
	$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

	$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
	foreach($sql_data  as $row)
	{
	$col++;
	?>
	<tr align="center">
	<td><? echo $col; ?></td>
	<td><? echo $row[csf("po_number")]; ?></td>
		<td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
	<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
	<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
	<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
	<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
	<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
	<td align="right">
	<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
	</td>
	<td>
	<?
	if( $balance>0)
	{
		echo "Less Booking";
	}
	else if ($balance<0)
	{
		echo "Over Booking";
	}
	else
	{
		echo "";
	}
	?>
	</td>
	</tr>
	<?
	}
	?>
	<tfoot>

	<tr>
	<td colspan="3">Total:</td>

	<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
	<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
	<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
	<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
		<td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
	<td align="right"><? echo number_format($tot_balance,2); ?></td>
	<td></td>
	</tr>
	</tfoot>
	</table>
	</td>

		</tr>
	</table>

         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>

       </div>
       <?
	$emailBody=ob_get_contents();
	if($is_mail_send==1){	
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report4")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'"; 
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$color_arr=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	/*$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	
	$po_number_arr=return_library_array( "select id,po_number from   wo_po_break_down",'id','po_number');
	$po_ship_date_arr=return_library_array( "select id,pub_shipment_date from   wo_po_break_down ",'id','pub_shipment_date');*/
	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');
	
	$quot_sql="select a.quot_date,a.id as quotation_no from wo_price_quotation a, wo_po_details_master b where a.id=b.quotation_id and b.job_no=$txt_job_no and a.is_deleted=0 and a.status_active=1"; 
	$quot_result=sql_select($quot_sql);
	foreach($quot_result as $quot)
	{
		$quotation_id=$quot[csf('quotation_no')];
		$quot_date=$quot[csf('quot_date')];
	}
 
	?>
	<div style="width:1330px" align="left">       
    	<?php
		$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7"); 
		list($nameArray_approved_row)=$nameArray_approved;
		$nameArray_approved_date=sql_select( "select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='".$nameArray_approved_row[csf('approved_no')]."'");
		list($nameArray_approved_date_row)=$nameArray_approved_date;
		$path=str_replace("'","",$path);
		 if($path=="")
			{
			$path='../../';
			}
		
  ob_start();  
	?>									<!--    Header Company Information         --> 
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100"> 
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">                                     
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php      
                                    echo $company_library[$cbo_company_name];
                              ?>
                            </td>
                            <td rowspan="3" width="250">
                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span>
                               <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>

                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
                                  
								  <?
								 }
							  	?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">  
                            <?
                          $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name"); 
						   if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";	
							}


                            foreach ($nameArray as $result)
                            {
								echo $location_name_arr[$location];
 
                            ?>
                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?> 
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?> 
                                Block No: <? //echo $result[csf('block_no')];?> 
                                City No: <? //echo $result[csf('city')];?> 
                                Zip Code: <? //echo $result[csf('zip_code')]; ?> 
                                Province No: <?php //echo $result[csf('province')];?> 
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?>--> <br> 
                                Email Address: <? echo $result[csf('email')];?> 
                                Website No:<? echo $result[csf('website')];
							
                            }
                            ?>   
                               </td> 
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">  
                                <strong><? echo $report_title;?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td> 
                            </tr>
                      </table>
                </td>       
            </tr>
       </table>
                <?
				$job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $style_ref_no=""; $inserted_by=""; $currency_id="";
                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.pay_mode, a.currency_id, a.rmg_process_breakdown, a.insert_date, a.inserted_by, a.update_date, a.uom, b.job_no, b.company_name, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no"); 
				
				$po_id_all=$nameArray[0][csf('po_break_down_id')];
				$booking_uom=$nameArray[0][csf('uom')];
				
				if($db_type==0)
				{
					$date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
					$group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
				}
				else
				{
					$date_dif_cond="(pub_shipment_date-po_received_date)";
					$group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping, 
	                                   	listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
				}
				$po_number_arr=array(); $po_ship_date_arr=array(); 
				$po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, plan_cut, po_quantity, $date_dif_cond as date_diff, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, po_received_date");
				//$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
				//echo "select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, plan_cut, po_quantity, $date_dif_cond as date_diff from wo_po_break_down where id in(".$po_id_all.")"; die;
				foreach($po_sql as $row)
				{
					$po_qnty_tot+=$row[csf('plan_cut')];
					$po_qnty_tot1+=$row[csf('po_quantity')];
					$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
					$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
					$po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
					$po_no.=$row[csf('po_number')].", ";
					$shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
					$lead_time.=$row[csf('date_diff')].",";
					$po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
					$grouping.=$row[csf('grouping')].",";
					$file_no.=$row[csf('file_no')].",";
				}
				//$po_num_arr=return_library_array("select id, po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id, po_number_id, task_number, task_start_date, task_finish_date from tna_process_mst where status_active=1 and task_number in (31,47,60,61,73,84,86,110) and po_number_id in($po_id_all)");
								
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				
				foreach($tna_start_sql as $row)
				{
					if($row[csf("task_start_date")]!="" && $row[csf("task_finish_date")]!="0000-00-00" && $row[csf("task_number")]==31)
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("task_start_date")];
						}
					}
					if($row[csf("task_start_date")]!="" && $row[csf("task_finish_date")]!="0000-00-00")
					{
						if($row[csf("task_number")]==60)
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("task_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("task_finish_date")];
						}
						if($row[csf("task_number")]==61)
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("task_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("task_finish_date")];
						}
						if($row[csf("task_number")]==73)
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("task_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("task_finish_date")];
						}
						if($row[csf("task_number")]==84)
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("task_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("task_finish_date")];
						}
						if($row[csf("task_number")]==86)
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("task_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("task_finish_date")];
						}
						if($row[csf("task_number")]==110)
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("task_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("task_finish_date")];
						}
						if($row[csf("task_number")]==47)
						{
							$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("task_start_date")];
							$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("task_finish_date")];
						}
					}
				}
				
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$inserted_by=$result[csf('inserted_by')];
					$currency_id=$result[csf('currency_id')];
					/*$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number"; 
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")"; 
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")"; 
					}
					
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")"; 
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}*/
					
					
					/*if($db_type==2) 
					{
						$group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping, 
	                                   		listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
					}
					else 
					{ 
						$group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";
					}*/
				//$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
				?>
       <table width="100%" style="border:1px solid black" >                    	
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>                             
            </tr>                                                
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>	
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>
                
                <td width="100" style="font-size:12px"><b>Garments Item</b></td>
                <td width="110">:&nbsp;
				<? 
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Booking Release Date</b></td>
                <td width="110">:&nbsp;
				<? 
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;
                </td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;
                <b>
				<? 
				echo $result[csf('style_ref_no')];
				$style_ref_no=$result[csf('style_ref_no')];
				?> 
                </b>   
                </td>
                
            </tr>
             <tr>
                <td  width="100" style="font-size:12px"><b>Style Des.</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:12px"><b>Lead Time </b>   </td>
                <td width="110">:&nbsp;<?  echo rtrim($lead_time,",");;?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>
             
            <tr>
                <td width="100" style="font-size:12px"><b>Supplier Name</b>   </td>
                <td width="110">:&nbsp;<? 
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){ echo $company_library[$result[csf('supplier_id')]]; }
				else { echo $supplier_name_arr[$result[csf('supplier_id')]]; }
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td width="100" style="font-size:12px"><b>Delivery Date</b></td>
               	<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td> 
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
            </tr> 
            <tr>
                <td width="100" style="font-size:12px"><b>Season</b></td>
                <td width="110">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  width="100" style="font-size:12px"><b>Attention</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Po Received Date</b></td>
                <td  width="110" >:&nbsp;<? echo $po_received_date; ?></td>
            </tr>
             <tr>
               <td width="100" style="font-size:18px"><b>Internal Ref No</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$grouping))); ?></b></td>
                
               <td width="100" style="font-size:18px"><b>File no</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$file_no)));?></b></td>
               <td width="100" style="font-size:18px"><b>Quotation ID</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $quotation_id.' &nbsp;(Date:&nbsp;'.change_date_format($quot_date).')';?></b></td>
            </tr>  
        </table>  
           <?
			}
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >            
		    <tr>
            <td width="800">  
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>PO Namber</strong></td>
                        <td style="border:1px solid black"><strong>Ship Date</strong></td>
                        <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Style Ref</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?  
						$tot_size_plan_qty=0;				
						foreach($nameArray_size  as $result_size)
                        {
							
								     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>				
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$po_item_color_size_arr=array();
					$color_size_sql=sql_select( "select po_break_down_id, item_number_id, color_number_id, size_number_id, plan_cut_qnty as plan_cut_qnty, order_quantity as order_quantity  from wo_po_color_size_breakdown where status_active=1 and is_deleted =0 and po_break_down_id in(".str_replace("'","",$txt_order_no_id).")");
					foreach($color_size_sql as $rows)
					{
						$po_item_color_size_arr[$rows[csf('po_break_down_id')]][$rows[csf('item_number_id')]][$rows[csf('color_number_id')]][$rows[csf('size_number_id')]]['plan']+=$rows[csf('plan_cut_qnty')];
						$po_item_color_size_arr[$rows[csf('po_break_down_id')]][$rows[csf('item_number_id')]][$rows[csf('color_number_id')]][$rows[csf('size_number_id')]]['qty']+=$rows[csf('order_quantity')];
						
						$tot_size_plan_qty_arr[$rows[csf('color_number_id')]][$rows[csf('size_number_id')]]+=$rows[csf('plan_cut_qnty')];
						$tot_size_plan_qty+=$rows[csf('plan_cut_qnty')];
					}
					$color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array(); $order_id=explode(",",str_replace("'","",$txt_order_no_id));
					for($or=0;$or<count($order_id); $or++)
				    {
						for($c=0;$c<count($gmts_item); $c++)
						{
						$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
						
						$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id=$order_id[$or] and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
	
						foreach($nameArray_color as $result_color)
						{						
						?>
						<tr>
							<td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
							 <td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
							  <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
							  <td align="center" style="border:1px solid black"><? echo $style_ref_no; // echo $row_num_tr; ?></td>
							<td align="center" style="border:1px solid black"><? echo $color_arr[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
							<? 
							$color_total=0; $color_total_order=0;
							
							foreach($nameArray_size  as $result_size)
							{
								$plan_qty=0; $order_qty=0;
								$plan_qty=$po_item_color_size_arr[$order_id[$or]][$gmts_item[$c]][$result_color[csf('color_number_id')]][$result_size[csf('size_number_id')]]['plan']; 
								$order_qty=$po_item_color_size_arr[$order_id[$or]][$gmts_item[$c]][$result_color[csf('color_number_id')]][$result_size[csf('size_number_id')]]['qty'];
							/*$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");                          
							foreach($nameArray_color_size_qnty as $result_color_size_qnty)
							{*/
								
							?>
								<td style="border:1px solid black; text-align:right">
								<? 
									if($plan_qty!= "")
									{
										 echo number_format($order_qty,0);
										 $color_total += $plan_qty;
										 $color_total_order += $order_qty;
										 $item_grand_total+=$plan_qty;
										 $item_grand_total_order+=$order_qty;
										 $grand_total +=$plan_qty;
										 $grand_total_order +=$order_qty;
										 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$plan_qty;
										 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$order_qty;
										 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
										 {
												$size_tatal[$result_size[csf('size_number_id')]]+=$plan_qty;
												$size_tatal_order[$result_size[csf('size_number_id')]]+=$order_qty;
										 }
										 else
										 {
											$size_tatal[$result_size[csf('size_number_id')]]=$plan_qty; 
											$size_tatal_order[$result_size[csf('size_number_id')]]=$order_qty; 
										 }
										 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
										 {
												$item_size_tatal[$result_size[csf('size_number_id')]]+=$plan_qty;
												$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$order_qty;
										 }
										 else
										 {
											$item_size_tatal[$result_size[csf('size_number_id')]]=$plan_qty; 
											$item_size_tatal_order[$result_size[csf('size_number_id')]]=$order_qty; 
										 }
									}
									else echo "0";
								 ?>
								</td>
						<?   
							//}
							}
							?>
							<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
							 <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
							 <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
						</tr>
						<?
						}
						?>
						  <td align="center" style="border:1px solid black"><strong></strong></td>
						  <td align="center" style="border:1px solid black"><strong></strong></td>
						  <td align="center" style="border:1px solid black"><strong></strong></td>
						  <td align="center" style="border:1px solid black"><strong></strong></td>
						  <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
							<?
							foreach($nameArray_size  as $result_size)
							{
							?>
							<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
							<?
							}
							?>
							<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
							<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
							<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
						</tr>
						<?
						}
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+8; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>  
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
            	<?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				
				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>   
                </fieldset>
                
                 
                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6--> 
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12--> 
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                    <td width="130"> Cutting (Fabric)</td>
                    <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                    <td width="130">Others</td>
                    <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                    <td width="130">Sub Total</td>
                    <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?> </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                    <td width="130">Grand Total</td>
                    <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);?></td>
                </tr>
                <?
				}
				?>
           </table>   
           </fieldset>
           </div>  
                </td>
            <td width="330" valign="top" align="left">
            <? 
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{	
							
					?>
					<td>
						<img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?
					
					$img_counter++;
				}
				?>
                </tr>
           </table>   
           </fieldset>
           </div>         	
          </td>
        </tr>
       </table>
      <br/> 
      <?
	 
	  if($cbo_fabric_source==1)
	  {
	  ?><!--  Here will be the main portion  -->
    <strong>Grey Fabric Details</strong>
    <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
            <td width="49%">
             <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
               <tr>
                    <td  width="120" align="left">Fabric Color</td>
                    <td  width="120" align="left">Fabric</td>
                    <td  width="120" align="left">Composition</td>
                    <td  width="120" align="left">GSM</td>
                    <td  width="120" align="left">Process Loss</td>
                    <? foreach($nameArray_size  as $result_size){?>
                    <td align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <? } ?>	
                    <td   width="50">Total (<? if($booking_uom!=0) echo $unit_of_measurement[$booking_uom]; else echo "KG"; ?>)</td>
               </tr>
               <?
               
                $costing_per=""; $costing_per_qnty=0;
                $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
                if($costing_per_id==1)
                {
                    $costing_per="1 Dzn"; $costing_per_qnty=12;
                }
                if($costing_per_id==2)
                {
                    $costing_per="1 Pcs"; $costing_per_qnty=1;
                }
                if($costing_per_id==3)
                {
                    $costing_per="2 Dzn"; $costing_per_qnty=24;
                }
                if($costing_per_id==4)
                {
                    $costing_per="3 Dzn"; $costing_per_qnty=36;
                }
                if($costing_per_id==5)
                {
                    $costing_per="4 Dzn"; $costing_per_qnty=48;
                }
                
                $sql_dia_array=array();
               $sql_dia=sql_select("Select pre_cost_fabric_cost_dtls_id, color_number_id, dia_width, gmts_sizes from wo_pre_cos_fab_co_avg_con_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).")");
               
               foreach($sql_dia as $sql_dia_row)
               {
                    $sql_dia_array[$sql_dia_row[csf("pre_cost_fabric_cost_dtls_id")]][$sql_dia_row[csf("color_number_id")]][$sql_dia_row[csf("gmts_sizes")]][$sql_dia_row[csf("dia_width")]]= $sql_dia_row[csf("dia_width")];  
               }
               $color_wiseWoQty_arr=array(); 
               $color_wise_wo_sql_qnty=sql_select("select a.id, c.size_number_id, d.fabric_color_id, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d  
                            WHERE a.job_no=b.job_no and
                            a.id=b.pre_cost_fabric_cost_dtls_id and
                            c.job_no_mst=a.job_no and 
                            c.id=b.color_size_table_id and
                            b.po_break_down_id=d.po_break_down_id and 
                            b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
                            d.booking_no =$txt_booking_no and
                            d.status_active=1 and d.is_deleted=0 group by a.id, c.size_number_id, d.fabric_color_id");
                foreach($color_wise_wo_sql_qnty as $roww)
                {
                    $color_wiseWoQty_arr[$roww[csf("id")]][$roww[csf("size_number_id")]][$roww[csf("fabric_color_id")]]['fin']=$roww[csf("fin_fab_qnty")];
                    $color_wiseWoQty_arr[$roww[csf("id")]][$roww[csf("size_number_id")]][$roww[csf("fabric_color_id")]]['grey']=$roww[csf("grey_fab_qnty")];
                }
               
                $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
        
                $wo_pre_cost_fabric_cost_dtls_id=array(); $size_wiseWo_qty_arr=array();
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                    
                $color_wise_wo_sql=sql_select("select d.fabric_color_id, a.id, a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_type_id,a.color_size_sensitive, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment ,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
                    WHERE a.job_no=b.job_no and
                    a.id=b.pre_cost_fabric_cost_dtls_id and
                    c.job_no_mst=a.job_no and 
                    c.id=b.color_size_table_id and
                    b.po_break_down_id=d.po_break_down_id and 
                    b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
                    a.body_part_id in(1,20,10,150,446,132) and
                    d.booking_no =$txt_booking_no and 
                    d.status_active=1 and 
                    d.is_deleted=0 
                    group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_type_id,a.color_size_sensitive,d.fabric_color_id order by cid ");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                    $wo_pre_cost_fabric_cost_dtls_id[$color_wise_wo_result[csf('id')]]=$color_wise_wo_result[csf('id')];
                    $fabric_color_id="";
                    if($color_wise_wo_result[csf('color_size_sensitive')]==3)
                    {
                        $fabric_color_id=return_field_value( "gmts_color_id", "wo_pre_cos_fab_co_color_dtls","pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and contrast_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."'");	
                    }
                    else
                    {
                        $fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];	
                    }
                ?> 
                    <tr>
                        <td width="120" align="left"><? echo $fabric_typee[$color_wise_wo_result[csf('width_dia_type')]]; ?></td>
                        <td width="120" align="left">&nbsp;</td>
                        <td>&nbsp;</td>
                        <td width="120" align="left">&nbsp;</td>
                        <td width="120" align="left">&nbsp;</td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        
                        foreach($nameArray_size  as $result_size)
                        {
                            ?>
                            <td width='50' align='' >&nbsp; 
								<?
                                $dia=implode(",", $sql_dia_array[$color_wise_wo_result[csf('id')]][$fabric_color_id][$result_size[csf('size_number_id')]]);
                                echo $dia;
                                ?>
                            </td>
                            <?
                        }
                        ?>
                        <td align="right">&nbsp;</td>
                    </tr>
                    <tr>
                        <td  width="120" align="left"><? echo $color_arr[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td  width="120" align="left"><? echo $color_wise_wo_result[csf('construction')].",".$color_type[$color_wise_wo_result[csf('color_type_id')]]; ?></td>
                        <td><? echo $color_wise_wo_result[csf('composition')]; ?></td>
                        <td  width="120" align="left"><? echo $color_wise_wo_result[csf('gsm_weight')];?></td>
                        <td  width="120" align="left"><? echo number_format($color_wise_wo_result[csf('process_loss_percent')],4); ?></td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_size  as $result_size)
                        {
                            ?>
                            <td width='50' align='right' > 
                            <? 
                            $grey_qty=0; $fin_qty=0;
                            $grey_qty=$color_wiseWoQty_arr[$color_wise_wo_result[csf('id')]][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('fabric_color_id')]]['grey']; 
                            $fin_qty=$color_wiseWoQty_arr[$color_wise_wo_result[csf('id')]][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('fabric_color_id')]]['fin'];
                            if($grey_qty!="")
                            {
                                echo number_format($grey_qty,4); 
                                $total_grey_fab_qnty+=$grey_qty;
                                $size_wiseWo_qty_arr[$result_size[csf('size_number_id')]]+=$grey_qty;
                            }
                            ?>
                            </td>
                            <?
                        }
                        ?>
                        <td align="right"><? echo number_format($total_grey_fab_qnty,4); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                    </tr>
                 <?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th  width="120" align="left">&nbsp;</th>
                    <td  width="120" align="left">&nbsp;</td>
                    <td  width="120" align="left">&nbsp;</td>
                    <td  width="120" align="left">&nbsp;</td>
                    <td  width="120" align="left"><strong>Total:</strong></td>
                    <?
                    foreach($nameArray_size as $result_size)
                    {
                        ?>
                        <td width='50' align='right'><? echo number_format($size_wiseWo_qty_arr[$result_size[csf('size_number_id')]],4);?></td>
                        <?
                    }
                    ?>
                    <td align="right"><? echo number_format($grand_total_grey_fab_qnty,4);?></td>
               </tr> 
            </table>
             </td>
             <td width="2%">&nbsp;</td>
             <td width="49%" valign="top">
             <?
                $color_wise_wo_qnty_arr=array(); $wo_qty_arr=array();  $color_wise_finwo_qnty_arr=array();
                $color_wise_wo_sql_qnty=sql_select("select a.id, a.body_part_id, a.color_size_sensitive as sensity,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty,c.color_order,b.cons  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d  
                WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and 
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
                d.booking_no =$txt_booking_no and
                d.status_active=1 and d.is_deleted=0 and  c.status_active=1 and c.is_deleted=0");
				
                foreach ($color_wise_wo_sql_qnty as $row)
                {
                    $color_wise_wo_qnty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('fabric_color_id')]]['fin']+=$row[csf('fin_fab_qnty')];
					 $color_size_wise_wo_qnty_arr[$row[csf('id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('fabric_color_id')]][$row[csf('size_number_id')]]['fin_cons']+=$row[csf('cons')];
					//if($row[csf('body_part_id')]==141)echo $row[csf('body_part_id')].'='.$row[csf('color_type_id')].'='.$row[csf('construction')].'='.$row[csf('composition')].'='.$row[csf('gsm_weight')].'='.$row[csf('dia_width')].'='.$row[csf('fabric_color_id')].'<br>';
                    $color_wise_wo_qnty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('fabric_color_id')]]['grey']+=$row[csf('grey_fab_qnty')];
					
					 $color_wise_wo_qnty_sensity_arr[$row[csf('sensity')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('fabric_color_id')]]['grey']+=$row[csf('grey_fab_qnty')];
                    
                    $wo_qty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]]['fin']+=$row[csf('fin_fab_qnty')];
                    $wo_qty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]]['grey']+=$row[csf('grey_fab_qnty')];
					
					  $wo_qty_sensity_arr[$row[csf('sensity')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]]['grey']+=$row[csf('grey_fab_qnty')];
					
					$color_wise_finwo_qnty_arr[$row[csf('id')]][$row[csf('size_number_id')]][$row[csf('fabric_color_id')]]['fin']+=$row[csf('fin_fab_qnty')];
					
					$color_body_arr[$row[csf('id')]]['body']=$row[csf('body_part_id')];
                }
				unset($color_wise_wo_sql_qnty);
				//print_r($color_wise_finwo_qnty_arr);
				//print_r($color_wise_wo_qnty_arr[141][1]['Single Jersey']['CVC [Ctn 60% - Polyester 40%] 100%'][180][76]);
         
                $wo_pre_cost_fabric_cost_dtls_id_main_fabric=implode(",", $wo_pre_cost_fabric_cost_dtls_id);
                if( $wo_pre_cost_fabric_cost_dtls_id_main_fabric !="")
                {
                    $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond="and pre_cost_fabric_cost_dtls_id not in($wo_pre_cost_fabric_cost_dtls_id_main_fabric)"; 
                }
                $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_size_sensitive, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment, min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and 
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and 
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
                d.booking_no =$txt_booking_no and 
                a.body_part_id not in(1,20,10,150,446,132) and d.status_active=1 and d.is_deleted=0  and c.status_active=1 and c.is_deleted=0 
                group by a.body_part_id,a.color_size_sensitive,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by a.body_part_id");
             ?>
             <?
             	/*echo '<pre>';
				print_r($color_wise_wo_qnty_arr); die;*/
             ?>
             <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
                 <tr align="center">
                     <td width='50'>&nbsp;</td>
                    <? 
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";	
                        else echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]].",".$result_fabric_description[csf('construction')]."</td>";			
                    }
                    ?>
                 </tr>
                <tr align="center">
                    <td width='50'>&nbsp;</td>
                    <? 
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
                        else    echo "<td colspan='2' >".$result_fabric_description[csf('composition')].",". $color_type[$result_fabric_description[csf('color_type_id')]].",". $result_fabric_description[csf('gsm_weight')]."</td>";			
                    }
                    ?>
               </tr>
               <tr align="center">
                   <td width='50'></td>
                    <? 
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
                        else    echo "<td colspan='2' align='center'>".$fabric_typee[$result_fabric_description[csf('width_dia_type')]].",". $result_fabric_description[csf('dia_width')].",".number_format($result_fabric_description[csf('requirment')],4)."</td>";			
                    }
                    ?>
               </tr>
               <tr>
                   <th width='50'>Gmt Color </th>
                    <? 
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                          echo "<th width='50'>Color </th><th width='50' >Qty</th>";			
                    }
                    ?>
               </tr>
               <?
				$gmt_color_library=array(); 
				$gmt_color_data=sql_select("select a.body_part_id,a.costing_per, b.gmts_color_id, b.contrast_color_id, b.pre_cost_fabric_cost_dtls_id as fab_dtlsid FROM  wo_pre_cos_fab_co_color_dtls b,wo_pre_cost_fabric_cost_dtls a WHERE   a.id= b.pre_cost_fabric_cost_dtls_id and a.job_no= b.job_no and b.job_no ='$job_no' ");
				foreach( $gmt_color_data as $gmt_color_row)
				{
					// $color_body=$color_body_arr[$gmt_color_row[csf('fab_dtlsid')]]['body'];
					$gmt_color_library[$gmt_color_row[csf("body_part_id")]].=$color_arr[$gmt_color_row[csf("gmts_color_id")]]."," ;
					$gmt_color_library4[$gmt_color_row[csf("contrast_color_id")]].=$color_arr[$gmt_color_row[csf("gmts_color_id")]]."," ;
					
					//$gmtColorArr[$gmt_color_row[csf('gmts_color_id')]]=$gmt_color_row[csf('contrast_color_id')];
					
					$gmt_color_library2[$gmt_color_row[csf("contrast_color_id")]]=$gmt_color_row[csf("gmts_color_id")];
					$gmt_color_library3[$gmt_color_row[csf("gmts_color_id")]].=$color_arr[$gmt_color_row[csf("contrast_color_id")]].",";
					$contrast_color_library[$gmt_color_row[csf("body_part_id")]][$gmt_color_row[csf("gmts_color_id")]].=$color_arr[$gmt_color_row[csf("contrast_color_id")]]."," ;
					$contrast_color_library2[$gmt_color_row[csf("body_part_id")]][$gmt_color_row[csf("gmts_color_id")]].=$gmt_color_row[csf("contrast_color_id")]."," ;
					$costing_per_id=$gmt_color_row[csf("costing_per")];
				}
					if($costing_per_id==1){$order_price_per_dzn=12;}
					else if($costing_per_id==2){$order_price_per_dzn=1;}
					else if($costing_per_id==3){$order_price_per_dzn=24;}
					else if($costing_per_id==4){$order_price_per_dzn=36;}
					else if($costing_per_id==5){$order_price_per_dzn=48;}
				//print_r($contrast_color_library[141]);
				  
				 $dataArr_fabric_description= sql_select("select a.body_part_id, a.color_size_sensitive, a.color_type_id, a.construction, a.composition, a.gsm_weight,  b.dia_width, min(c.id) as cid, d.fabric_color_id, d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and 
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and 
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
                d.booking_no =$txt_booking_no and 
                a.body_part_id not in(1,20,10,150,446,132) and d.status_active=1 and d.is_deleted=0  and c.status_active=1 and c.is_deleted=0 
                group by a.body_part_id, a.color_size_sensitive, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, d.fabric_color_id, d.gmts_color_id order by a.body_part_id");
				
				
				$fabColorArr=array(); $qty_arr=array();
				foreach($dataArr_fabric_description as $rowData)
				{
					$gmt_color=rtrim($gmt_color_library4[$rowData[csf('fabric_color_id')]],",");
					$gmt_colors=implode(",",array_unique(explode(",",$gmt_color)));
					if($gmt_color_library4[$rowData[csf('fabric_color_id')]]!="") $fabcolor=$gmt_colors; else $fabcolor=$color_library[$rowData[csf('fabric_color_id')]];
					
					//$gmtColorArr[$rowData[csf('gmts_color_id')]]=$rowData[csf('fabric_color_id')];
					$gmtColorArr[$rowData[csf('body_part_id')]][$rowData[csf('color_type_id')]][$rowData[csf('gmts_color_id')]]=$rowData[csf('fabric_color_id')];
					//$fabColorArr[$rowData[csf('fabric_color_id')]]=$rowData[csf('gmts_color_id')];
					$grey_qty=0;
					$grey_qty=$color_wise_wo_qnty_arr[$rowData[csf('body_part_id')]][$rowData[csf('color_type_id')]][$rowData[csf('construction')]][$rowData[csf('composition')]][$rowData[csf('gsm_weight')]][$rowData[csf('dia_width')]][$rowData[csf('fabric_color_id')]]['grey'];
					
					$qty_arr[$rowData[csf('fabric_color_id')]][$rowData[csf('body_part_id')]][$rowData[csf('color_type_id')]][$rowData[csf('construction')]][$rowData[csf('composition')]][$rowData[csf('gsm_weight')]][$rowData[csf('dia_width')]][$rowData[csf('color_size_sensitive')]]['grey']=$grey_qty;
					//echo $rowData[csf('body_part_id')].'=';
					//$qty_arr[$rowData[csf('fabric_color_id')]][$rowData[csf('body_part_id')]][$rowData[csf('color_type_id')]][$rowData[csf('construction')]][$rowData[csf('composition')]][$rowData[csf('gsm_weight')]][$rowData[csf('dia_width')]]['sen']=$rowData[csf('color_size_sensitive')];
				}
				/*$gmtColorArr=array();
				$color_wise_sql=sql_select("select gmts_color_id, fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0  group by gmts_color_id, fabric_color_id");
				foreach($color_wise_sql as $row)
				{
					$gmtColorArr[$row[csf('gmts_color_id')]]=$row[csf('fabric_color_id')];
				}*/
				
				$color_wise_wo_sql=sql_select("select gmts_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0  group by gmts_color_id");
				//echo "select gmts_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0  group by gmts_color_id"; die;
				foreach($color_wise_wo_sql as $row)
                {
					/*foreach($fabColorArr as $gcolor_id=>$fcolorVal)
					{*/
					/*$colorData=explode("__",$fabColorArr[$gcolor_id]);//
					$color_id=$colorData[1];
					$fcolorVal=$colorData[0];
					echo $color_id.'--'.$fcolorVal.'<br>';*/
					//$color_id=$gmtColorArr[$row[csf('gmts_color_id')]];
					$gmt_color=rtrim($gmt_color_library4[$row[csf('fabric_color_id')]],",");
					$gmt_colors=implode(",",array_unique(explode(",",$gmt_color)));
					if($gmt_color_library4[$row[csf('fabric_color_id')]]!="") $fabcolor=$gmt_colors; else $fabcolor=$color_library[$row[csf('fabric_color_id')]];
					//$color_id=$row[csf('fabric_color_id')];
                ?> 
                    <tr>
                        <td width='50' align='right' title="<? echo $row[csf('gmts_color_id')] ?>"><?=$color_library[$row[csf('gmts_color_id')]]; ?></td>
                        <?
						foreach($nameArray_fabric_description as $rowmst)
                    	{
                    		$color_id=$gmtColorArr[$rowmst[csf('body_part_id')]][$rowmst[csf('color_type_id')]][$row[csf('gmts_color_id')]];
							?>
                            <td width='50' align='right' title="Sen=<?=$rowmst[csf('color_size_sensitive')].'='.$rowmst[csf('body_part_id')].'='.$color_id; ?>">
                            <? 
							$color_size_sensitive=$rowmst[csf('color_size_sensitive')];
							$grey_qty=0;							
                            $grey_qty=$color_wise_wo_qnty_sensity_arr[$color_size_sensitive][$rowmst[csf('body_part_id')]][$rowmst[csf('color_type_id')]][$rowmst[csf('construction')]][$rowmst[csf('composition')]][$rowmst[csf('gsm_weight')]][$rowmst[csf('dia_width')]][$color_id]['grey'];
                            //$grey_qty=$color_wise_wo_qnty_arr[$rowmst[csf('body_part_id')]][$rowmst[csf('color_type_id')]][$rowmst[csf('construction')]][$rowmst[csf('composition')]][$rowmst[csf('gsm_weight')]][$rowmst[csf('dia_width')]][$row[csf('gmts_color_id')]]['grey'];
							
							
							if($color_size_sensitive==3) 
							{ 
							 	$grey_qty=0;
								$contcolor_id=array_unique(array_filter(explode(",",$contrast_color_library2[$rowmst[csf("body_part_id")]][$row[csf("gmts_color_id")]])));
								$contrast_colors="";
								foreach ($contcolor_id as $cs_id)
								{
									//echo $color_id;
									if($contrast_colors=="") $contrast_colors=$color_library[$cs_id]; else $contrast_colors.=','.$color_library[$cs_id];
									$grey_qty+=$color_wise_wo_qnty_arr[$rowmst[csf('body_part_id')]][$rowmst[csf('color_type_id')]][$rowmst[csf('construction')]][$rowmst[csf('composition')]][$rowmst[csf('gsm_weight')]][$rowmst[csf('dia_width')]][$cs_id]['grey'];
								}
								
								$contrast_colors=implode(",",array_unique(explode(",",$contrast_colors)));
							}
                            if($color_size_sensitive==3) echo $contrast_colors; //else echo $color_library[$row[csf('gmts_color_id')]];
                                
                            ?>
                            </td>
                        <td width='50' align='right' > 
                            <? 
                            if($grey_qty!="")
                            {
                            echo number_format($grey_qty,4); 
                            $total_grey_fab_qnty+=$grey_qty;
                            }
                            ?>
                        </td>
                        <?
						}
                        ?>
                    </tr>
                 <?
					//}
                }
				?>
				<tr style=" font-weight:bold">
                    <td width='50' align='right'></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                        $gre_qty=0;
                        $gre_qty=$wo_qty_sensity_arr[$result_fabric_description[csf('color_size_sensitive')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]]['grey'];
						?>
						<td width='50' align='right'></td><td width='50' align='right' > <? echo number_format($gre_qty,4);?></td>
						<?
                    }
                    ?>
               </tr>
               <? 
				
				
        
                /*$grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0  group by fabric_color_id");
				
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?> 
                    <tr>
                        <td width='50' align='right'>
                        <? echo $color_wise_wo_result[csf('fabric_color_id')].'=';
						$gmt_color=rtrim($gmt_color_library4[$color_wise_wo_result[csf('fabric_color_id')]],",");
						$gmt_colors=implode(",",array_unique(explode(",",$gmt_color)));
                            
							  if($gmt_color_library4[$color_wise_wo_result[csf('fabric_color_id')]]!="") echo $gmt_colors;
                                else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
								
                        ?>
                        </td>
                        <?
						$dataArr_fabric_description= sql_select("select a.body_part_id,a.color_size_sensitive, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment, min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and 
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and 
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
					d.booking_no =$txt_booking_no and 
					a.body_part_id not in(1,20,10,150,446) and d.status_active=1 and d.is_deleted=0  and c.status_active=1 and c.is_deleted=0 
					and d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]."
					group by a.body_part_id,a.color_size_sensitive,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by a.body_part_id, b.dia_width, cid ");
					
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
                        ?>
                        <td width='50' align='right' title="Sen=<? echo $result_fabric_description[csf('color_size_sensitive')];?>">
							 <? 
                            $fin_qty= $grey_qty=0;
                            $fin_qty=$color_wise_wo_qnty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]][$color_wise_wo_result[csf('fabric_color_id')]]['fin'];
							
							//if($result_fabric_description[csf('body_part_id')]==59)echo $result_fabric_description[csf('body_part_id')].'='.$result_fabric_description[csf('color_type_id')].'='.$result_fabric_description[csf('construction')].'='.$result_fabric_description[csf('composition')].'='.$result_fabric_description[csf('gsm_weight')].'='.$result_fabric_description[csf('dia_width')].'='.$color_wise_wo_result[csf('fabric_color_id')].'<br>';
							
                            $grey_qty=$color_wise_wo_qnty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]][$color_wise_wo_result[csf('fabric_color_id')]]['grey'];
                            if($grey_qty!="")
                            {
                               
							    $color_size_sensitive=$result_fabric_description[csf('color_size_sensitive')];
							    $gmts_color=$gmt_color_library2[$color_wise_wo_result[csf("fabric_color_id")]];
									   $contrast_color=$contrast_color_library[$result_fabric_description[csf('body_part_id')]][$gmts_color];
									   
										$contrast_colors=rtrim($contrast_color,",");
										$contrast_colors=implode(",",array_unique(explode(",",$contrast_colors)));
										
										$contrast_colors2=rtrim($gmt_color_library[$result_fabric_description[csf('body_part_id')]],",");
										$contrast_colors2=implode(",",array_unique(explode(",",$contrast_colors2)));
										
							   		if($color_size_sensitive==3) echo $contrast_colors;else echo  $contrast_colors2;
									
								
								
                            }
							//echo $color_size_sensitive.'DD';
                            ?>
                        </td>
                        <td width='50' align='right' > 
                            <? 
                            if($grey_qty!="")
                            {
                            echo number_format($grey_qty,4); 
                            $total_grey_fab_qnty+=$grey_qty;
                            }
                            ?>
                        </td>
                        <?
                        }
                        ?>
                    </tr>
                 <?
                }
                ?>
                <tr style=" font-weight:bold">
                    <td width='50' align='right'></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                        $gre_qty=0;
                        $gre_qty=$wo_qty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]]['grey'];
						?>
						<td width='50' align='right'></td><td width='50' align='right' > <? echo number_format($gre_qty,4);?></td>
						<?
                    } </tr>*/
                    ?>
               
            </table>
        </td>
        </tr>
    </table>
    <br/>   									 <!--  Here will be the main portion  -->
    <strong>Finish Fabric Details  </strong>
    <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
            <td width="49%">
                <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
                    <tr>
                        <td width="120" align="left">Fabric Color</td>
                        <td width="120" align="left">Fabric</td>
                        <td width="120" align="left">Composition</td>
                        <td width="120" align="left">GSM</td>
                        <td width="120" align="left">Process Loss</td>
                        <td width="60" align="left">Uom</td>
                        <?  				
                        foreach($nameArray_size  as $result_size)
                        {?>
                        <td align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                        <? } ?>	
                        <td width="50">Total <? //if($booking_uom!=0) echo $unit_of_measurement[$booking_uom]; else echo "KG"; ?></td>
                    </tr>
                    <?
					$fabric_color_arr=array(); $size_wise_qty_sum_arr=array();
					$fabric_color_sql=sql_select( "select pre_cost_fabric_cost_dtls_id, contrast_color_id, gmts_color_id from wo_pre_cos_fab_co_color_dtls");
					foreach($fabric_color_sql as $row)
					{
						$fabric_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('contrast_color_id')]]=$row[csf('gmts_color_id')];
					}
					unset($fabric_color_sql);
					
                    $wo_pre_cost_fabric_cost_dtls_id=array(); $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0; $size_wise_avg_cons_arr=array();
                    $color_wise_wo_sql=sql_select("select d.fabric_color_id, a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_type_id,a.color_size_sensitive,  avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
                    WHERE a.job_no=b.job_no and
                    a.id=b.pre_cost_fabric_cost_dtls_id and
                    c.job_no_mst=a.job_no and 
                    c.id=b.color_size_table_id and
                    b.po_break_down_id=d.po_break_down_id and 
                    b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
                    a.body_part_id in(1,20,10,150,446,132) and
                    d.booking_no =$txt_booking_no and 
                    d.status_active=1 and 
                    d.is_deleted=0 
                    group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_type_id,a.color_size_sensitive,d.fabric_color_id order by cid");
                    foreach($color_wise_wo_sql as $color_wise_wo_result)
                    {
						$wo_pre_cost_fabric_cost_dtls_id[$color_wise_wo_result[csf('id')]]=$color_wise_wo_result[csf('id')];
						$fabric_color_id="";
						
						if($color_wise_wo_result[csf('color_size_sensitive')]==3) $fabric_color_id=$fabric_color_arr[$color_wise_wo_result[csf('id')]][$color_wise_wo_result[csf('fabric_color_id')]];
						else $fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];	
						?> 
						<tr>
							<td width="120" align="left"><? echo $fabric_typee[$color_wise_wo_result[csf('width_dia_type')]]; ?></td>
							<td width="120" align="left">&nbsp;</td>
							<td>&nbsp;</td>
							<td width="120" align="left">&nbsp;</td>
							<td width="120" align="left">&nbsp;</td>
							<td width="60" align="left">&nbsp;</td>
							<?
							$total_fin_fab_qnty=0; $total_grey_fab_qnty=0;$tot_avg_tot_percent=0;
							foreach($nameArray_size  as $result_size)
							{
								$size_wise_avg_cons_arr[$result_size[csf('size_number_id')]]=$color_wise_wo_result[csf('cons')];
								
									//$size_plan_qty=$tot_size_plan_qty_arr[$color_wise_wo_result[csf('fabric_color_id')]][$result_size[csf('size_number_id')]];
								//$plan_cut_percent=($size_plan_qty/$tot_size_plan_qty)*100;
								// $avg_tot_percent=($color_wise_wo_result[csf('cons')]*$plan_cut_percent)/100;
								 // $tot_avg_tot_percent+=($color_wise_wo_result[csf('cons')]*$plan_cut_percent)/100;
								//$size_wise_avg_cons_arr[$result_size[csf('size_number_id')]]+=$avg_tot_percent;
								?>
								<td width='50' align='' title="Tot PlanQty=<? echo $tot_size_plan_qty.',SizeQty='.$size_plan_qty.',Cons='.$color_wise_wo_result[csf('cons')].',Percent='.$plan_cut_percent;?>" >&nbsp; 
									 <?
                                    $dia=implode(",", $sql_dia_array[$color_wise_wo_result[csf('id')]][$fabric_color_id][$result_size[csf('size_number_id')]]);
                                    echo $dia;
                                    ?>
								</td>
								<?
							}
							?>
							<td align="right">&nbsp; </td>
						</tr>
						<tr>
							<td width="120" align="left" rowspan="2"> <? echo $color_arr[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
							<td width="120" align="left"  rowspan="2"><? echo $color_wise_wo_result[csf('construction')]; ?></td>
							<td  rowspan="2"><? echo $color_wise_wo_result[csf('composition')].",".$color_type[$color_wise_wo_result[csf('color_type_id')]];?></td>
							<td width="120" align="left"  rowspan="2"><? echo $color_wise_wo_result[csf('gsm_weight')]; ?></td>
							<td  width="120" align="left"  rowspan="2"><? echo number_format($color_wise_wo_result[csf('process_loss_percent')],4); ?></td>
							<td width="60" align="left">KG</td>
							<?
							$total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
							foreach($nameArray_size  as $result_size)
							{
								?>
								<td width='50' align='right'>
								<? 
								$fin_qty=0;
								$fin_qty=$color_wise_finwo_qnty_arr[$color_wise_wo_result[csf('id')]][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('fabric_color_id')]]['fin'];
							
									
								if($fin_qty!="")
								{
									echo number_format($fin_qty,4); 
									$total_fin_fab_qnty+=$fin_qty;
									$size_wise_qty_sum_arr[$result_size[csf('size_number_id')]]['kg']+=$fin_qty;
								}
								?>
								</td>
								<?
							}
							?>
							<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
						</tr>
						<tr>
							<td width="60" align="left">Mtr</td>
							<?
							$total_fin_fab_qnty_mtr=0;
							foreach($nameArray_size  as $result_size)
							{
								?>
								<td width='50' align='right'>
								<? 
								$fin_qty=0;
								$fin_qty=$color_wise_finwo_qnty_arr[$color_wise_wo_result[csf('id')]][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('fabric_color_id')]]['fin'];
								if($fin_qty!="")
								{
									$kg_to_mtr=0; $dia="";
									$dia=implode(",", $sql_dia_array[$color_wise_wo_result[csf('id')]][$fabric_color_id][$result_size[csf('size_number_id')]]);
									$kg_to_mtr=((($fin_qty/$dia)/$color_wise_wo_result[csf('gsm_weight')])*1550*1000*2.54)/100;
									echo number_format($kg_to_mtr,4); 
									$total_fin_fab_qnty_mtr+=$kg_to_mtr;
									$size_wise_qty_sum_arr[$result_size[csf('size_number_id')]]['mtr']+=$kg_to_mtr;
								}
								?>
								</td>
								<?
							}
							?>
							<td align="right"><? echo number_format($total_fin_fab_qnty_mtr,2); $grand_total_fin_fab_qnty_mtr+=$total_fin_fab_qnty_mtr;?></td>
						</tr>
						<?
                    }
                    ?>
                    <tr style=" font-weight:bold">
                        <th width="120" align="left" rowspan="2">&nbsp;</th>
                        <td width="120" align="left"  rowspan="2">&nbsp;</td>
                        <td width="120" align="left"  rowspan="2">&nbsp;</td>
                        <td width="120" align="left"  rowspan="2">&nbsp;</td>
                        <td width="120" align="left" rowspan="2"><strong>Total:</strong></td>
                        <td width="60" align="left">KG</td>
                        <?
                        foreach($nameArray_size  as $result_size)
                        {
							?>
							<td width='50' align='right' > <? echo number_format($size_wise_qty_sum_arr[$result_size[csf('size_number_id')]]['kg'],4);?></td>
							<?
                        }
                        ?>
                        <td align="right"><? echo number_format($grand_total_fin_fab_qnty,4);?></td>
                    </tr>
                    <tr style=" font-weight:bold">
                        <td width="60" align="left">Mtr</td>
                        <?
                        foreach($nameArray_size  as $result_size)
                        {
							?>
							<td width='50' align='right' > <? 
							$tot_kg_to_mtr=0; $mtr_qty=0;
							$mtr_qty=$size_wise_qty_sum_arr[$result_size[csf('size_number_id')]]['mtr'];
							$tot_kg_to_mtr=$mtr_qty;
							echo number_format($mtr_qty,4);?></td>
							<?
							$grand_tot_mtr+=$mtr_qty;
                        }
                        ?>
                        <td align="right"><? echo number_format($grand_tot_mtr,4);?></td>
                    </tr> 
                    <tr style=" font-weight:bold">
                        <th  width="120" align="left">&nbsp;</th>
                        <td  width="120" align="left">&nbsp;</td>
                        <td  width="120" align="left">&nbsp;</td>
                        <td  width="120" align="left">&nbsp;</td>
                        <td  width="120" align="left"><strong>Cons.</strong></td>
                        <td width="60" align="left">KG</td>
                        <?
						$tot_avg_tot_percent=0;
                        foreach($nameArray_size  as $result_size)
                        {
							//$avg_cons=0;
							$avg_cons=$size_wise_avg_cons_arr[$result_size[csf('size_number_id')]];
							//$tot_avg_tot_percent+=$size_wise_avg_cons_arr[$result_size[csf('size_number_id')]];
							?>
							<td width='50' align='right' > <? echo number_format($avg_cons,4);?></td>
							<?
                        }
                        ?>
                        <td align="right" title="CostPer=<? echo $order_price_per_dzn;?>">&nbsp;<? echo number_format(($grand_total_fin_fab_qnty/$tot_size_plan_qty)*$order_price_per_dzn,4); ?> <? //echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    </tr> 
                </table>
            </td>
            <td width="2%">&nbsp;</td>
            <td width="49%" valign="top">
				<?
                $wo_pre_cost_fabric_cost_dtls_id_main_fabric=implode(",", $wo_pre_cost_fabric_cost_dtls_id);
                if( $wo_pre_cost_fabric_cost_dtls_id_main_fabric !="")
                {
                    $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond="and pre_cost_fabric_cost_dtls_id not in($wo_pre_cost_fabric_cost_dtls_id_main_fabric)"; 
                }
                
                $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_size_sensitive,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and 
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and 
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
                d.booking_no =$txt_booking_no and 
                a.body_part_id not in(1,20,10,150,446,132) and
                d.status_active=1 and 
                d.is_deleted=0 
                group by a.body_part_id,a.color_size_sensitive,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width,cid");
                ?>
                <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
                    <tr align="center">
                        <td width='50' rowspan="3" colspan="2">&nbsp;</td>
                        <? 
                        foreach($nameArray_fabric_description  as $result_fabric_description)
                        {
                            if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";	
                            else  echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]].",".$result_fabric_description[csf('construction')]."</td>";			
                        }
                        ?>
                    </tr>
                    <tr align="center">
						<? 
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
                            if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
                            else echo "<td colspan='2' >".$result_fabric_description[csf('composition')].",". $color_type[$result_fabric_description[csf('color_type_id')]].",". $result_fabric_description[csf('gsm_weight')]."</td>";			
                        }
                        ?>
                    </tr>
                    <tr align="center">
						<? 
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
                        if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
                        else         		              echo "<td colspan='2' align='center'>".$fabric_typee[$result_fabric_description[csf('width_dia_type')]].",". $result_fabric_description[csf('dia_width')].",".number_format($result_fabric_description[csf('cons')],4)."</td>";			
                        }
                        ?>
                    </tr>
                    <tr>
                        <th width='50'>Gmt Color</th>
                        <th width='50'>Uom</th>
                        <? 
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
                        	echo "<th width='50'>Color</th><th width='50' >Qty</th>";			
                        }
                        ?>
                    </tr>
                    <?
                    $gmt_color_library=array();
                  //  $gmt_color_data=sql_select("select gmts_color_id, contrast_color_id FROM wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_no'");
					//echo "select gmts_color_id, contrast_color_id FROM wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_no'";
					  $gmt_color_data=sql_select("select a.body_part_id,b.gmts_color_id, b.contrast_color_id,b.pre_cost_fabric_cost_dtls_id as fab_dtlsid FROM  wo_pre_cos_fab_co_color_dtls b,wo_pre_cost_fabric_cost_dtls a WHERE   a.id= b.pre_cost_fabric_cost_dtls_id and a.job_no= b.job_no and b.job_no ='$job_no'");
                    foreach( $gmt_color_data as $gmt_color_row)
                    {
                    	$gmt_color_library[$gmt_color_row[csf("body_part_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
						$gmt_color_library4[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
						$gmt_color_library2[$gmt_color_row[csf("contrast_color_id")]]=$gmt_color_row[csf("gmts_color_id")];
						$contrast_color_library[$gmt_color_row[csf("body_part_id")]][$gmt_color_row[csf("gmts_color_id")]].=$color_arr[$gmt_color_row[csf("contrast_color_id")]]."," ;
                    }
                    
                    $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0; $rib_size_kg_to_mtr_arr=array();
                    $color_wise_wo_sql=sql_select("select gmts_color_id FROM wo_booking_dtls WHERE  booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0 group by gmts_color_id");
					//echo "select fabric_color_id FROM wo_booking_dtls WHERE  booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0 group by fabric_color_id";
                    foreach($color_wise_wo_sql as $color_wise_wo_result)
                    {
						?> 
						<tr>
                            <td width='50' align='right' rowspan="2" title="<? echo $color_wise_wo_result[csf('fabric_color_id')];?>">
								<? 
								$gmt_color=rtrim($gmt_color_library4[$color_wise_wo_result[csf('fabric_color_id')]],",");
								$gmt_colors=implode(",",array_unique(explode(",",$gmt_color)));
						
                                /*if($gmt_color_library4[$color_wise_wo_result[csf('fabric_color_id')]]!="") echo $gmt_colors;
                                else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];*/
								echo $color_library[$color_wise_wo_result[csf('gmts_color_id')]];
								//$color_id=$gmtColorArr[$color_wise_wo_result[csf('gmts_color_id')]]; 
                                ?>
                            </td>
                            <td>KG</td>
                            <?
                            $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                            
                            foreach($nameArray_fabric_description as $result_fabric_description)
                            {
                            	$color_id=$gmtColorArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$color_wise_wo_result[csf('gmts_color_id')]]; 
								$fin_qty=$grey_qty=0;
								$fin_qty=$color_wise_wo_qnty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]][$color_id]['fin'];
								$grey_qty=$color_wise_wo_qnty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]][$color_id]['grey'];
								?>
								<td width='50' align='right' title="Sensity=<? echo $result_fabric_description[csf('color_size_sensitive')];?>" rowspan="2">
									<? 
									$contrast_colors='';$contrast_colors2='';
									$color_size_sensitive=$result_fabric_description[csf('color_size_sensitive')];
									if($color_size_sensitive==3) 
									{ 
										$fin_qty=0;
										$contcolor_id=array_unique(array_filter(explode(",",$contrast_color_library2[$result_fabric_description[csf("body_part_id")]][$color_wise_wo_result[csf("gmts_color_id")]])));
										$contrast_colors="";
										foreach ($contcolor_id as $cs_id)
										{
											//echo $color_id;
											if($contrast_colors=="") $contrast_colors=$color_library[$cs_id]; else $contrast_colors.=','.$color_library[$cs_id];
											$fin_qty+=$color_wise_wo_qnty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]][$cs_id]['fin'];
										}
										
										$contrast_colors=implode(",",array_unique(explode(",",$contrast_colors)));
									}
                                    /*if($fin_qty!="")
                                    {
                                       // echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
									   $color_size_sensitive=$result_fabric_description[csf('color_size_sensitive')];
									   $gmts_colorid=$gmt_color_library2[$color_wise_wo_result[csf("fabric_color_id")]];
							  			$contrast_color=$contrast_color_library[$result_fabric_description[csf('body_part_id')]][$gmts_colorid];
										$contrast_colors=rtrim($contrast_color,",");
										$contrast_colors=implode(",",array_unique(explode(",",$contrast_colors)));
										$contrast_colors2=rtrim($gmt_color_library[$result_fabric_description[csf('body_part_id')]],",");
										$contrast_colors2=implode(",",array_unique(explode(",",$contrast_colors2)));*/
										
							   			if($color_size_sensitive==3) echo $contrast_colors;else echo  $contrast_colors2;
                                  //  }
                                    ?>
								</td>
								<td width='50' align='right' > 
									<? if($fin_qty!="")
									{
										echo number_format($fin_qty,4); 
										$rib_size_kg_to_mtr_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]]['kg']+=$fin_qty;
									}
									?>
								</td>
								<?
                            }
                            ?>
						</tr>
						<tr>
                            <td>Mtr</td>
                            <?
                            foreach($nameArray_fabric_description as $result_fabric_description)
                            {
								$fin_qty=0;
								$fin_qty=$color_wise_wo_qnty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]][$color_id]['fin'];
								?>
								<td width='50' align='right' > 
								<? 
								//echo $fin_qty.'='.$result_fabric_description[csf('dia_width')];
								
								$color_size_sensitive=$result_fabric_description[csf('color_size_sensitive')];
								if($color_size_sensitive==3) 
								{ 
									$fin_qty=0;
									$contcolor_id=array_unique(array_filter(explode(",",$contrast_color_library2[$result_fabric_description[csf("body_part_id")]][$color_wise_wo_result[csf("gmts_color_id")]])));
									$contrast_colors="";
									foreach ($contcolor_id as $cs_id)
									{
										//echo $color_id;
										if($contrast_colors=="") $contrast_colors=$color_library[$cs_id]; else $contrast_colors.=','.$color_library[$cs_id];
										$fin_qty+=$color_wise_wo_qnty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]][$cs_id]['fin'];
									}
									
									$contrast_colors=implode(",",array_unique(explode(",",$contrast_colors)));
								}
								
								if($fin_qty!="")
								{
									$kg_to_mtr=0;
									$kg_to_mtr=((($fin_qty/$result_fabric_description[csf('dia_width')])/$result_fabric_description[csf('gsm_weight')])*1550*1000*2.54)/100;
									echo number_format($kg_to_mtr,4); 
									$rib_size_kg_to_mtr_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]]['mtr']+=$kg_to_mtr;
								}
								?>
								</td>
								<?
                            }
                            ?>
						</tr>
						<?
                    }
                    ?>
                    <tr style=" font-weight:bold">
                        <td width='50' align='right' rowspan="2">Total:</td>
                        <td width='50' align='right'>KG</td>
                        <?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$tot_kg=0;
							$tot_kg=$rib_size_kg_to_mtr_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]]['kg'];
							?>
							<td width='50' align='right'></td><td width='50' align='right' > <? echo number_format($tot_kg,4);?></td>
							<?
                        }
                        ?>
                    </tr> 
                    <tr>
                        <td width='50' align='right'>Mtr</td>
                        <?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$tot_kg_mtr=0;
							$tot_kg_mtr=$rib_size_kg_to_mtr_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]]['mtr'];
							?>
							<td width='50' align='right'></td><td width='50' align='right' > <? echo number_format($tot_kg_mtr,4);?></td>
							<?
                        }
                        ?>
                    </tr> 
                </table>
            </td>
        </tr>
    </table>
    <?
	} //die;
	//=====================================================================Production End==============================================================
	
	//=====================================================================Purchase Start==============================================================

	  if($cbo_fabric_source==2)
	  {
	$color_wise_wo_sql=sql_select("select d.fabric_color_id, a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_type_id,a.color_size_sensitive, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment ,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and 
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and 
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
				a.body_part_id in(1,20,10,150,446,132) and
				d.booking_no =$txt_booking_no and 
				d.status_active=1 and 
				d.is_deleted=0 
				group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_type_id,a.color_size_sensitive,d.fabric_color_id order by cid ");
	
	  ?><!--  Here will be the main portion  -->
    <strong>Fabric Details</strong>
    <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
    <tr>
     <?
	if(count($color_wise_wo_sql)>0)
	{
	?>
    <td width="49%">
   
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
       <tr>
            <td  width="120" align="left">Fabric Color</td>
            <td  width="120" align="left">Fabric</td>
            <td  width="120" align="left">Composition</td>
            <td  width="120" align="left">GSM</td>
            <td  width="120" align="left">Process Loss</td>
			<? foreach($nameArray_size  as $result_size){?>
            <td align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
            <? } ?>	
            <td   width="50">Total (<? if($booking_uom!=0) echo $unit_of_measurement[$booking_uom]; else echo "KG"; ?>)</td>
            <td   width="50">Rate</td>
            <td   width="50">Amount</td>
       </tr>
       <?
	   
		$costing_per="";
		$costing_per_qnty=0;
		$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
		if($costing_per_id==1)
		{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;
		
		}
		if($costing_per_id==2)
		{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;
		
		}
		if($costing_per_id==3)
		{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;
		
		}
		if($costing_per_id==4)
		{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;
		
		}
		if($costing_per_id==5)
		{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;
		
		}
		$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");

		    $wo_pre_cost_fabric_cost_dtls_id=array();
	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$grand_total_amount=0;
			
				
			
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			
			$wo_pre_cost_fabric_cost_dtls_id[$color_wise_wo_result[csf('id')]]=$color_wise_wo_result[csf('id')];
			$fabric_color_id="";
			if($color_wise_wo_result[csf('color_size_sensitive')]==3)
			{
			$fabric_color_id=return_field_value( "gmts_color_id", "wo_pre_cos_fab_co_color_dtls","pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and contrast_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."'");	
			}
			else
			{
			$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];	
			}
			
			
			$sql_dia_array=array();
		   $sql_dia=sql_select("Select dia_width,gmts_sizes from wo_pre_cos_fab_co_avg_con_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and color_number_id='".$fabric_color_id."'");
		   
		   foreach($sql_dia as $sql_dia_row)
		   {
			$sql_dia_array[$sql_dia_row[csf("gmts_sizes")]][$sql_dia_row[csf("dia_width")]]= $sql_dia_row[csf("dia_width")];  
		   }
		?> 
			<tr>
            <td  width="120" align="left">
			<?
			echo $fabric_typee[$color_wise_wo_result[csf('width_dia_type')]];
			?>
            </td>

            <td  width="120" align="left">&nbsp;
			
            </td>
            <td>&nbsp;
           
            </td>
            <td  width="120" align="left">&nbsp;
			
            </td>
            
            <td  width="120" align="left">&nbsp;
			
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;
			
			foreach($nameArray_size  as $result_size)
		    {
			?>
		
            <td width='50' align='' >&nbsp; 
            <?
			$dia=implode(",", $sql_dia_array[$result_size[csf('size_number_id')]]);
			echo $dia;
			?>
            </td>
            <?
			}
			?>
            
            <td align="right">&nbsp;
            
            </td>
            <td align="right">&nbsp;
            
            </td>
            <td align="right">&nbsp;
            
            </td>
            </tr>
            
            <tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			
			?>
            </td>
            <td  width="120" align="left">
			<? 
			echo $color_wise_wo_result[csf('construction')].",".$color_type[$color_wise_wo_result[csf('color_type_id')]];
			?>
            </td>
            <td>
            <?
			echo $color_wise_wo_result[csf('composition')];
			?>
            </td>
            <td  width="120" align="left">
			<? 
			echo $color_wise_wo_result[csf('gsm_weight')];
			?>
            </td>
            
            <td  width="120" align="left">
			<? 
			echo $color_wise_wo_result[csf('process_loss_percent')];
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;
			
			foreach($nameArray_size  as $result_size)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d  
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and 
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and 
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
				d.booking_no =$txt_booking_no and
				a.id='".$color_wise_wo_result[csf('id')]."' and
				c.size_number_id='".$result_size[csf('size_number_id')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and 
				d.is_deleted=0 
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
		
            <td width='50' align='right' > 
			<? 
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4); 
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>
            
            <td align="right"><? echo number_format($total_grey_fab_qnty,4); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
            <td align="right">
			<? 
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4); 
			?>
            </td>
            <td align="right">
			<? 
			$amount=$total_grey_fab_qnty*$color_wise_wo_result_qnty[csf('rate')];
			echo number_format($amount,4); 
			$grand_total_amount+=$amount;?>
            </td>
            
           
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>

        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_size  as $result_size)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d  
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and 
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and 
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
												d.booking_no =$txt_booking_no and 
												a.body_part_id in(1,20,10,150,446,132) and
												c.size_number_id='".$result_size[csf('size_number_id')]."' and
												d.status_active=1 and 
												d.is_deleted=0 
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);?></td>
            <?
			}
			?>
           
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,4);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_grey_fab_qnty,4);?></td>
            <td align="right"><? echo number_format($grand_total_amount,4);?></td>
            
            </tr> 
    </table>
   
 </td>
 
 <td width="2%"></td>
  <?
	}
	?>
 <td width="49%" valign="top">
 <?
 $wo_pre_cost_fabric_cost_dtls_id_main_fabric=implode(",", $wo_pre_cost_fabric_cost_dtls_id);
 if( $wo_pre_cost_fabric_cost_dtls_id_main_fabric !="")
 {
	 $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond="and pre_cost_fabric_cost_dtls_id not in($wo_pre_cost_fabric_cost_dtls_id_main_fabric)"; 
 }
 $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d   
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and 
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and 
b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
d.booking_no =$txt_booking_no and 
a.body_part_id not in(1,20,10,150,446,132) and
d.status_active=1 and 
d.is_deleted=0 
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width,cid");
	 ?>
    
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <td width='50'></td>
        <? 
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='4'>&nbsp</td>";	
			else         		               echo "<td  colspan='4'>". $body_part[$result_fabric_description[csf('body_part_id')]].",".$result_fabric_description[csf('construction')]."</td>";			
		}
		?>
       
       
        
       </tr>
     
        
        <tr align="center">
        <td width='50'></td>
        <? 
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='4' >&nbsp</td>";
			else         		               echo "<td colspan='4' >".$result_fabric_description[csf('composition')].",". $color_type[$result_fabric_description[csf('color_type_id')]].",". $result_fabric_description[csf('gsm_weight')]."</td>";			
		}
		?>
       
       </tr>
       
       <tr align="center">
       <td width='50'></td>
        <? 
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='4'>&nbsp</td>";
			else         		              echo "<td colspan='4' align='center'>".$fabric_typee[$result_fabric_description[csf('width_dia_type')]].",". $result_fabric_description[csf('dia_width')].",".number_format($result_fabric_description[csf('requirment')],4)."</td>";			
		}
		?>
        
       </tr>
       <tr>
       <th width='50'>Gmt Color</th>
        <? 
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Color</th><th width='50' >Qty</th><th width='50'>Rate</th><th width='50' >Amount</th>";			
		}
		?>
       
       </tr>
       <?
	      
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id,contrast_color_id 
		  FROM 
		  wo_pre_cos_fab_co_color_dtls
		  WHERE 
		  job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("SELECT fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0 group by fabric_color_id"); 
			foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?> 
			<tr>
            <td width='50' align='right'>
			<? 
			//if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			//{
				if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]!="")
				{
					echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
				}
				else
				{
					echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
				}
			//}
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;
			$total_amount=0;
			
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d  
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and 
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and 
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and 
				a.construction='".$result_fabric_description[csf('construction')]."' and 
				a.composition='".$result_fabric_description[csf('composition')]."' and 
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and 
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and 
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and 
				d.is_deleted=0 
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
            
			<td width='50' align='right'>
			<? 
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			}
			?>
            </td>
            <td width='50' align='right' > 
			<? 
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{

			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4); 
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            
            <td width='50' align='right' > 
			<? 
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4); 
			}
			?>
            </td>
            
            <td width='50' align='right' > 
			<? 
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			echo number_format($amount,4); 
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            
           
            
           
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        
        <td width='50' align='right'></td>
        <?
		$other_fab_total=0;
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d  
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and 
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and 
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and 
												d.booking_no =$txt_booking_no and 
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and 
												a.construction='".$result_fabric_description[csf('construction')]."' and 
												a.composition='".$result_fabric_description[csf('composition')]."' and 
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and 
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and 
												d.status_active=1 and 
												d.is_deleted=0 
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'></td>
            <td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);?></td>
            <td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('rate')],4);?></td>
            <td width='50' align='right' > 
			<? 
			$fabwise_amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			echo number_format($fabwise_amount,4);
			$other_fab_total+=$fabwise_amount;
			?>
            </td>
            <?
			}
			?>
            
            
           
            </tr> 
    </table>
 </td>
 </tr>
 </table>
 <br/>
 <table width="100%" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" border="1">
 <tr>
 <td>
  <?
	   $mcurrency="";
	   $dcurrency="";
	   if($currency_id==1)
	   {
		$mcurrency='Taka';
		$dcurrency='Paisa'; 
	   }
	   if($currency_id==2)
	   {
		$mcurrency='USD';
		$dcurrency='CENTS'; 
	   }
	   if($currency_id==3)
	   {
		$mcurrency='EURO';
		$dcurrency='CENTS'; 
	   }
	   ?>
 <strong>Total Amount (In Words):</strong><? echo number_to_words(def_number_format($grand_total_amount+$other_fab_total,2,""),$mcurrency, $dcurrency);?>
 </td>
 </tr>
 </table>
    <?
	  }
	  //=====================================================================Purchase End==============================================================
	?>
	<br/><?
		$lab_dip_color_arr=array();
		$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
		foreach($lab_dip_color_sql as $row)
		{
			$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
		}
		$order_plan_qty_arr=array();
		$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in (".str_replace("'","",$txt_order_no_id).") and status_active=1 and is_deleted =0 group by color_number_id, size_number_id"); 
		foreach($color_wise_wo_sql_qnty as $row)
		{
			$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
			$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
		}
		
		$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();
		
		$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type 
		FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e 
		
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
		//echo $collar_cuff_sql;
		$collar_cuff_sql_res=sql_select($collar_cuff_sql);
		
		foreach($collar_cuff_sql_res as $collar_cuff_row)
		{
			$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
			$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
			$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
			$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
			$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
			
		}
		//print_r($collar_cuff_percent_arr[40]) ;
		unset($collar_cuff_sql_res);
		//$count_collar_cuff=count($collar_cuff_size_arr);
		foreach($collar_cuff_body_arr as $body_type=>$body_name)
		{
			foreach($body_name as $body_val)
			{
				$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
				$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
				
				?>
				<div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
				<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					<tr>
						<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
					</tr>
					<tr>
						<td width="100">Size</td>
							<?  
							foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
							{	     
								?>
								<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
								<?	
							}    
							?>	
						<td width="60" rowspan="2" align="center"><strong>Total</strong></td> 
						<td rowspan="2" align="center"><strong>Extra %</strong></td>
					</tr>
					<tr>
						<td style="font-size:12px"><? echo $body_val; ?> Size</td>
						<?
						foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
						{	
							if(count($size_number)>0) 
							{
								 foreach($size_number  as $item_size=>$val) 
								 {   
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
									<?
								 }
							}
							else 
							{
								?>
								<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
								<?
							}
						}    
						
						$pre_size_total_arr=array();
						foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
						{
							foreach($pre_cost_data as $color_number_id=>$color_number_data)
							{
								foreach($color_number_data as $color_size_sensitive=>$color_break_down)
								{
									$pre_color_total_collar=0;
									$pre_color_total_collar_order_qnty=0;
									$process_loss_method=$process_loss_method;
									$constrast_color_arr=array();
									if($color_size_sensitive==3)
									{
										$constrast_color=explode('__',$color_break_down);
										for($i=0;$i<count($constrast_color);$i++)
										{
											$constrast_color2=explode('_',$constrast_color[$i]);
											$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
										}
									}
									?> 
									<tr>
										<td>
											<?
											if( $color_size_sensitive==3)
											{
												echo strtoupper ($constrast_color_arr[$color_number_id]) ;
												$lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
											}
											else
											{
												echo $color_library[$color_number_id];
												$lab_dip_color_id=$color_number_id;
											}
											?>
										</td>
										<?
										foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
										{
											?>
											<td align="center" style="border:1px solid black">
												<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
												if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
												else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
												$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];
												
												$collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
												// echo $collar_ex_per.'=';
												if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
												else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
												$colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
												$collerqty=($plan_cut+$colar_excess_per);
												
												echo number_format($collerqty); 
												$pre_size_total_arr[$size_number_id]+=$collerqty;
												$pre_color_total_collar+=$collerqty; 
												$pre_color_total_collar_order_qnty+=$plan_cut; 
												?>
											</td>
											<?	
										}    
										?>	
										
										<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
										<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
									</tr>
									<?
									$pre_grand_collar_ex_per+=$collar_ex_per;
									$pre_grand_tot_collar+=$pre_color_total_collar; 
									$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty; 
								}
							}
						}
						?>
					</tr>
					<tr>
						<td>Size Total</td>
							<?
							foreach($pre_size_total_arr  as $size_qty)
							{
								?>
								<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
								<?
							}
							?>
						<td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
						<td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
					</tr>
				</table>
			</div>
			<br/>
			<?
		}
	}
   		
	$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');			
	$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
	?>
	<table width="100%" border="0" cellpadding="0" cellspacing="0" >
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
			</td>
			<td width="2%">&nbsp;</td>
			<td width="49%" valign="top" align="center">
				<?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id"); //order by a.id
				if(count($yarn_sql_array)>0)
				{
					?>
					<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr align="center">
							<td colspan="7"><b>Allocated Yarn</b></td>
						</tr>
						<tr align="center">
							<td>Sl</td>
							<td>Yarn Description</td>
							<td>Brand</td>
							<td>Lot</td>
							<td>Allocated Qty (Kg)</td>
						</tr>
						<?
						$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
						$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
						$i=0; $total_yarn=0; $total_allo=0;
						foreach($yarn_sql_array  as $row)
						{
							$i++;
							?>
							<tr align="center">
								<td><? echo $i; ?></td>
								<td><? echo $item[$row[csf('item_id')]]; ?></td>
								<td><? echo $supplier[$row[csf('supplier_id')]]; ?></td>
								<td><? echo $row[csf('lot')]; ?></td>
								<td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
							</tr>
							<?
						}
						?>
						<tr align="center">
							<td>Total:</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td align="right"><? echo number_format($total_allo,4); ?></td>
						</tr>
					</table>
					<?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1"); 
					if($is_yarn_allocated==1)
					{
						?>
						<font style=" font-size:30px"><b> Draft</b></font>
						<?
					}
					else echo "";
				}
				?>
			</td>
		</tr>
	</table>
	<br/>
	<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
		<tr align="center">
			<td colspan="6"><b>Dye To Match</b></td>
		</tr>
		<tr align="center">
			<td>Sl</td>
			<td>Item </td>
			<td>Body Color</td>
			<td>Item Color</td>
			<td>Dyeing Qnty.</td>
			<td>UOM</td>
		</tr>
		<?
		$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
		
		$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
		$bookingId=0;
		foreach($sql as $row)
		{
			$bookingId= $row[csf('id')];
		}
		$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color");
		$i=0; $dyeing_qty=0;
		foreach($sql_data  as $row)
		{
			$i++;
			?>
			<tr align="center">
				<td><? echo $i; ?></td>
				<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
				<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
				<td><? echo $color_library[$row[csf('item_color')]];?></td>
				<td align="right"><? echo number_format($row[csf('qty')],2);?></td>
				<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
			</tr>
			<?
			$dyeing_qty+=$row[csf('qty')];
		}
		?>
		<tr align="center">
			<td colspan="4" align="right">Total</td>
			<td align="right"><? echo number_format($dyeing_qty,2); ?></td>
			<td align="right">&nbsp;</td>
		</tr>
	</table>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" valign="top">
				<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					<tr align="center">
						<td colspan="10"><b>Comments</b></td>
					</tr>
					<tr align="center">
						<td>Sl</td>
						<td>Po NO</td>
						<td>Ship Date</td>
						<td>Pre-Cost Qty</td>
						<td>Mn.Book Qty</td>
						<td>Sht.Book Qty</td>
						<td>Smp.Book Qty</td>
						<td>Tot.Book Qty</td>
						<td>Balance</td>
						<td>Comments</td>
					</tr>
					<?
					$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
					$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
					if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'"; 
					if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'"; 
					$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
					$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
					$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c
					WHERE
					a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by a.id");
					$count=0;
					$tot_grey_req_as_pre_cost_arr=array();
					if (count($nameArray)>0 )
					{
						foreach ($nameArray as $result)
						{
							if($result[csf("costing_per")]==1) $costing_per_qty=12;
							else if($result[csf("costing_per")]==2) $costing_per_qty=1;
							else if($result[csf("costing_per")]==3) $costing_per_qty=24;
							else if($result[csf("costing_per")]==4) $costing_per_qty=36;
							else if($result[csf("costing_per")]==5) $costing_per_qty=48;
							else $costing_per_qty=0;
							$tot_grey_req_as_pre_cost=0;
							$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/($costing_per_qty*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
							$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
						}
					}
					$total_pre_cost=0; $total_booking_qnty_main=0; $total_booking_qnty_short=0; $total_booking_qnty_sample=0; $total_tot_bok_qty=0; $tot_balance=0;
					
					
					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					
					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					
					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
					{
						$col++;
						?>
						<tr align="center">
							<td><? echo $col; ?></td>
							<td><? echo $row[csf("po_number")]; ?></td>
							<td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
							<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
							<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
							<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
							<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
							<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
							<td align="right">
							<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
							</td>
							<td>
								<? 
								if( $balance>0) echo "Less Booking";
								else if ($balance<0) echo "Over Booking";
								else echo "";
								?>
							</td>
						</tr>
						<?
					}
					?>
					<tfoot>
						<tr>
							<td colspan="3">Total:</td>
							<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
							<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
							<td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
							<td align="right"><? echo number_format($tot_balance,2); ?></td>
							<td></td>
						</tr>
					</tfoot>
				</table>
			</td>
		</tr>
	</table> 
	<fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
	<legend>TNA Information</legend>
	<!--<span style="font-size:180; font-weight:bold;"></span>-->
	<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">                    	
		<tr>
			<td rowspan="2" align="center" valign="top">SL</td>
			<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
			<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
			<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
			<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
			<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
			<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
			<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
			<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
		</tr> 
		<tr>
			<td width="85" align="center" valign="top"><b>Start Date</b></td>
			<td width="85" align="center" valign="top"><b>End Date</b></td>
			<td width="85" align="center" valign="top"><b>Start Date</b></td>
			<td width="85" align="center" valign="top"><b>End Date</b></td>
			<td width="85" align="center" valign="top"><b>Start Date</b></td>
			<td width="85" align="center" valign="top"><b>End Date</b></td>
			<td width="85" align="center" valign="top"><b>Start Date</b></td>
			<td width="85" align="center" valign="top"><b>End Date</b></td>
			<td width="85" align="center" valign="top"><b>Start Date</b></td>
			<td width="85" align="center" valign="top"><b>End Date</b></td>
			<td width="85" align="center" valign="top"><b>Start Date</b></td>
			<td width="85" align="center" valign="top"><b>End Date</b></td>
			<td width="85" align="center" valign="top"><b>Start Date</b></td>
			<td width="85" align="center" valign="top"><b>End Date</b></td>
		</tr>
		<?
		$i=1;
		foreach($tna_date_task_arr as $order_id=>$row)
		{
			?>
			<tr>
				<td><? echo $i; ?></td>
				<td><? echo $po_num_arr[$order_id]; ?></td>
				<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
				<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
				<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
				<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
				<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
				<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
				<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
				<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
				<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
				<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
				<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
				<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
				<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
				<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
			</tr>
			<?
			$i++;
		}
		?> 
	</table>
	</fieldset>
	<?
	$sql = sql_select("select designation, name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
	$count=count($sql);
	$width=1330;
	$td_width=floor($width/$count);
	$standard_width=$count*150;
	if($standard_width>$width) $td_width=150;
	$no_coloumn_per_tr=floor($width/$td_width);
	$col=$count-2; $i=1;
	echo '<table width="'.$width.'"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$nameArray_approved_date_row[csf('approved_by')]].'</td></tr><tr>';
	foreach($sql as $row)	
	{
		echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';
		if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
		$i++;
	} 
	echo '</tr></table>';
	?>
    </div>
    <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report5")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$path = str_replace("'", "", $path);
if ($path == "") {
	$path = '../../';
}

ob_start();
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.pay_mode,a.rmg_process_breakdown,a.insert_date,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:12px"><b>Garments Item</b></td>
                <td width="110">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Booking Release Date</b></td>
                <td width="110">:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>

            </tr>
             <tr>



                <td  width="100" style="font-size:12px"><b>Style Des.</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:12px"><b>Lead Time </b>   </td>
                <td width="110">:&nbsp;<?  echo rtrim($lead_time,",");;?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>



            </tr>

            <tr>
                <td width="100" style="font-size:12px"><b>Supplier Name</b>   </td>
                <td width="110">:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td width="100" style="font-size:12px"><b>Delivery Date</b></td>
               	<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>



            </tr>
            <tr>
                <td width="100" style="font-size:12px"><b>Season</b></td>
                <td width="110">:&nbsp;<? echo $result[csf('season')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Attention</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Po Received Date</b></td>
                <td  width="110" >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Order No</b></td>
                <td width="110" style="font-size:18px" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>

            </tr>
            <tr>
               <td width="100" style="font-size:12px"><b>Shipment Date</b></td>
                <td width="110" colspan="5"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>

            </tr>

        </table>
           <?
			}
	        ?>
     <br/>
      <!--  Here will be the main portion  -->
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	 ?>

     <?


if($cbo_fabric_source==1)
{
$nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and
d.status_active=1 and
d.is_deleted=0
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="8" width="50"><p>Total  Finish Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="8" width="50"><p>Total Grey Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="8" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
        <!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
             <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>

       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
		}
		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}

	if($cbo_fabric_source==2)
	{

$nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and
d.status_active=1 and
d.is_deleted=0
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="8" width="50"><p>Total Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="8" width="50"><p>Avg Rate <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="8" width="50"><p>Amount </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
        <!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
             <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>

       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id,contrast_color_id
		  FROM
		  wo_pre_cos_fab_co_color_dtls
		  WHERE
		  job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,d.rate avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('fin_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>

            <td align="right">
            <?
			echo number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,4);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	?>
        <br/>
        <?
		if($cbo_fabric_source==1){
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">

                </td>

            </tr>
        </table>
        <?
		}// fabric Source End
		?>

         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>

       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_print4")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php

$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;

$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;

$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;

$path = str_replace("'", "", $path);
if ($path != "") {
	$path = $path;
} else {
	$path = "../../";
}
ob_start();
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$uom=0;
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.pay_mode, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season, b.season_matrix, b.order_repeat_no, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.qlty_label, b.client_id, a.fabric_composition from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
					}

					$shipment_date="";
					$sql_min= "select MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_min=sql_select($sql_min);
					foreach ($data_array_min as $sql_min)
					{
						$shipment_date.=change_date_format($sql_min[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}

					$Maxshipment_date="";
					$sql_max= "select MAX(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_max=sql_select($sql_max);
					foreach ($data_array_max as $row_max)
					{
						$Maxshipment_date.=change_date_format($row_max[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}

					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}
					}

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				?>
       <table width="100%" style="border:1px solid black;table-layout: fixed;" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="220">:&nbsp;<span style="font-size:18px"><b><?
					$buyer_name_str="";
					if($result[csf('client_id')]!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]."-".$buyer_name_arr[$result[csf('client_id')]]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]; echo $buyer_name_str; ?></b></span></td>
                <td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="220">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td>:&nbsp; <?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
            </tr>
            <tr>
                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Release Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b>
					<?
                        echo $result[csf('style_ref_no')];
                        $style_sting=$result[csf('style_ref_no')];
                    ?>
                 </b>
                 </td>
            </tr>
             <tr>
                <td style="font-size:12px"><b>Style Des.</b></td>
                <td>:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
                <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;
				<?
				$lead_time=implode(",",array_unique(explode(",",chop($lead_time,","))));
			   	echo $lead_time;
				?> </td>
                <td style="font-size:12px"><b>Dealing Merchant</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;
				<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3 ){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>
                </td>
                <td style="font-size:12px"><b>Delivery Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>



            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<? $season_matrix=return_field_value("season_name","lib_buyer_season","id=".$result[csf('season_matrix')],"season_name");echo $season_matrix; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>Po Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
               <td  style="font-size:12px"><b>Repeat No</b></td>
               <td  >:&nbsp;<? echo $result[csf('order_repeat_no')]; ?></td>
            </tr>
            <tr>
               <td style="font-size:12px"><b>Shipment Date</b></td>
                <td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">: First :&nbsp;<? echo rtrim($shipment_date,", "); ?>, Last: <? echo rtrim($Maxshipment_date,", ");  ?></td>
                <td  style="font-size:12px"><b>Quality Label</b></td>

               <td  >:&nbsp;<? echo $quality_label[$result[csf('qlty_label')]]; ?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
			   <?
			   $WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
			   echo $WOPreparedAfter.' Days' ;
			   ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
			   <?
			   $daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
			   echo $daysInHand.' Days' ;
			    //echo rtrim($daysInHand,',').' Days'
			   ?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
			   <?
			   $shiping_status=implode(",",array_unique(explode(",",chop($shiping_status,","))));
			   echo $shiping_status;
			   ?></td>

            </tr>
           <tr>
               <td style="font-size:18px"><b>Internal Ref No</b></td>
               <td style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>
               <td style="font-size:18px"><b>File no</b></td>
               <td style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
               <td style="font-size:18px"><b>Currency</b></td>
               <td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
          </tr>
           <tr>
               <td style="font-size:18px"><b>Remarks</b></td>
               <td style="font-size:18px" colspan="5"> :<? echo $result[csf('remarks')]?></td>
          </tr>
             <tr>
               <td style="font-size:18px"><b>Fabric Composition</b></td>
               <td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
          </tr>

        </table>
           <?
			}
			if($cbo_fabric_source==1 || $cbo_fabric_source==2)
			{
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image</legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                    $path='../../';
                    }

					?>
					<td>
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
			}// if($cbo_fabric_source==1) end

	  ?>
      <br/>
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	if($cbo_fabric_source==1){
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=12 and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in KG</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
        <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=12  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
			$gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and
			a.id=b.pre_cost_fabric_cost_dtls_id and
			c.job_no_mst=a.job_no and
			c.id=b.color_size_table_id and
			b.po_break_down_id=d.po_break_down_id and
			b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			d.booking_no =$txt_booking_no and
			a.uom=12 and
			d.status_active=1 and
			d.is_deleted=0  and
			b.cons>0
			group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
			foreach( $gmt_color_data as $gmt_color_row)
			{
				if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
					$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
				}
			}

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=12 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <br/>
    <?
	}
	//===========================

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Yds</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Yds)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate (Yds) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		 /* $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=27  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	foreach( $gmt_color_data as $gmt_color_row)
			{
				if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
					$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
				}
			}

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=27 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate ,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);//$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{

			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>



            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	//=================================PCS
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Pcs</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Pcs)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate (Pcs) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		 /* $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=1  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	foreach( $gmt_color_data as $gmt_color_row)
			{
				if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
					$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
				}
			}
	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=1 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate ,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);//$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>



            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	//==========================================Mtr
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Mtr</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Mtr)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate (Mtr) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?
		  $gmt_color_library=array();
		/*  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=23 and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/ //issue id :6003, urmi, date :20-08-2017
		  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=23 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate ,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);//$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>



            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}


	if($cbo_fabric_source==2){
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=12 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in KG</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}

		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2)
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>

       </tr>
       <?


		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=12  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		  	  $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=12 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, b.remarks, c.color_number_id, d.fabric_color_id order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=12 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=12 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')]),2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=12 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <br/>
    <?
	}
	//===========================

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Yds</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Yds)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <?
		if($cbo_fabric_source==2)
		{
			?>
            <td  rowspan="11" width="50"><p>Avg Rate (Yds) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>
            <?
		}
		?>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2) //Purchase
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>

       </tr>
       <?

		  $gmt_color_library=array();
		 /* $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=27  and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/
		   $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=27 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=27 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=27 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and

				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);


			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=27 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
			  									b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Pcs</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Pcs)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Pcs)";} ?></p></td>
        <?
		if($cbo_fabric_source==2)
		{
			?>
            <td  rowspan="11" width="50"><p>Avg Rate (Pcs) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Pcs)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>
            <?
		}
		?>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2) //Purchase
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>

       </tr>
       <?


		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=1 and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/


		   $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=1 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
				$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=1 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=1 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?

			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')]) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				                                b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')]) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=1 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}

	$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in Mtr</caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="11" width="50"><p>Total Finish Fabric (Mtr)<? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>
        <?
		if($cbo_fabric_source==2)
		{
			?>
            <td  rowspan="11" width="50"><p>Avg Rate (Mtr) <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Mtr)";} ?></p></td>
            <td  rowspan="11" width="50"><p>Amount </p></td>
            <?
		}
		?>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?

		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
		if( $result_fabric_description[csf('body_part_id')] == "")
			echo "<td colspan='3'>&nbsp</td>";
		else
			echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		if($cbo_fabric_source==2) //Purchase
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}
		}
		else
		{
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th>";
			}
		}

		?>


       </tr>
       <?

		  $gmt_color_library=array();
		  /*$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=23 and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }*/

		   $gmt_color_data= sql_select("select min(a.id) as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type , b.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment,c.color_number_id,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=23 and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.remarks,c.color_number_id,d.fabric_color_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			  if($gmt_color_row[csf("fabric_color_id")] !=$gmt_color_row[csf("color_number_id")]){
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]][$gmt_color_row[csf("color_number_id")]]=$color_library[$gmt_color_row[csf("color_number_id")]];
			  }
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
										  FROM
										  wo_pre_cost_fabric_cost_dtls a,
										  wo_booking_dtls b
										  WHERE
										  a.id=b.pre_cost_fabric_cost_dtls_id and
										  a.uom=23 and
										  b.booking_no =$txt_booking_no and
										  b.status_active=1 and
                                          b.is_deleted=0
										  group by b.fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>

            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=23 and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and

				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);

			if($amount!="")
			{
			echo $amount;
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo def_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo def_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {

				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.uom=23 and
												a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and

												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}
	?>
        <br/>

        <?

		if($cbo_fabric_source==2)
		{
			$booking_po_id=str_replace("'","",$txt_order_no_id);
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();
			$collar_cuff_qty_arr=array();

			$collar_cuff_sql="select a.id, a.body_part_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, d.grey_fab_qnty, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id and a.uom=1 and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";

			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_qty_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('size_number_id')]]+=$collar_cuff_row[csf('grey_fab_qnty')];
				//$collar_cuff_bodypart_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_item_size_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_type][$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size; ?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													/*if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];*/

													/*if($body_type==50) $plan_cut=($collar_cuff_qty_arr[$body_type][$body_val][$color_number_id][$size_number_id]+$colar_excess_per);
													else $plan_cut=$collar_cuff_qty_arr[$body_type][$body_val][$color_number_id][$size_number_id]+$colar_excess_per;*/
													$plan_cut=$collar_cuff_qty_arr[$body_type][$body_val][$color_number_id][$size_number_id]+$colar_excess_per;

                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
													$body_part_id=$collar_cuff_bodypart_arr[$body_type][$body_val];
                                                    $collerqty=($plan_cut+$colar_excess_per);
													//$collerqty=$color_size_qty_arr[$body_part_id][$color_number_id][$size_number_id];
													//$collerqty=$collar_cuff_qty_arr[$body_type][$body_val][$color_number_id][$size_number_id]+$colar_excess_per;

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
		?>
        <br/>


        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr align="center">
                        <td><b>Approved Instructions</b></td>

                        </tr>
                        <tr>
                        <td>
                    <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                    </td>
                    </tr>
                    </table>
                	<br />
                   <!--<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");



	$nameArray=sql_select("
	select
	a.id,
	a.item_number_id,
	a.costing_per,
	b.po_break_down_id,
	b.color_size_table_id,
	b.requirment,
	c.po_number
FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_po_break_down c
WHERE
	a.job_no=b.job_no and
	a.job_no=c.job_no_mst and
    a.id=b.pre_cost_fabric_cost_dtls_id and
	b.po_break_down_id=c.id and
	b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
	order by id");

	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
            if($result[csf("costing_per")]==1)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==2)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==3)
			{

				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==4)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==5)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0;
					$total_booking_qnty_main=0;
					$total_booking_qnty_short=0;
					$total_booking_qnty_sample=0;
					$total_tot_bok_qty=0;
					$tot_balance=0;


					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td>
					<?
					if( $balance>0)
					{
						echo "Less Booking";
					}
					else if ($balance<0)
					{
						echo "Over Booking";
					}
					else
					{
						echo "";
					}
					?>
                    </td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>-->
                </td>

            </tr>
        </table>
       <br>
        <?
     $desg_name=return_library_array( "select id, custom_designation from lib_designation", "id", "custom_designation"  );
	 $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')].'/'.$desg_name[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
        <br/>
       <?
       //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	?>

    <fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		?>

         <!--<br><br><br><br>-->
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
			echo "****".custom_file_name($txt_booking_no,$style_sting,$job_no);
		 ?>

       </div>
       <?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="create_file")
{
	$content=$data;
	$file=fopen("welcome.html","w+");
	fwrite($file,$data);
	$file = 'welcome.html';
}

if($action=="download_file")
{
	extract($_REQUEST);
	set_time_limit(0);
	$file_path=$_REQUEST['filename'];
	download_start($file_path, ''.$_REQUEST['filename'].'', 'text/plain');
}

function download_start($file, $name, $mime_type='')
{
	if(file_exists($file))
	{
		echo "file found";
	}
	else
	{
    	die('File not found');
	}

	//Check the file exist or not
	if(!is_readable($file)) die('File not found or inaccessible!');
	$size = filesize($file);
	$name = rawurldecode($name);
	/* MIME type check*/
	$known_mime_types=array(
	  "pdf" => "application/pdf",
	  "txt" => "text/plain",
	  "html" => "text/html",
	  "htm" => "text/html",
	  "exe" => "application/octet-stream",
	  "zip" => "application/zip",
	  "doc" => "application/msword",
	  "xls" => "application/vnd.ms-excel",
	  "ppt" => "application/vnd.ms-powerpoint",
	  "gif" => "image/gif",
	  "png" => "image/png",
	  "jpeg"=> "image/jpg",
	  "jpg" =>  "image/jpg",
	  "php" => "text/plain"
	);

	if($mime_type=='')
	{
		$file_extension = strtolower(substr(strrchr($file,"."),1));
		if(array_key_exists($file_extension, $known_mime_types))
		{
		$mime_type=$known_mime_types[$file_extension];
	    }
		else
		{
			$mime_type="application/force-download";
		}
    }
	//turn off output buffering to decrease cpu usage
	@ob_end_clean();
	// required for IE Only
	if(ini_get('zlib.output_compression'))
	ini_set('zlib.output_compression', 'Off');
	header('Content-Type: ' . $mime_type);
	header('Content-Disposition: attachment; filename="'.$name.'"');
	header("Content-Transfer-Encoding: binary");
	header('Accept-Ranges: bytes');
	/*non-cacheable */
	header("Cache-control: private");
	header('Pragma: private');
	header("Expires: Tue, 15 May 1984 12:00:00 GMT");

	// multipart-download and download resuming support
	if(isset($_SERVER['HTTP_RANGE']))
	{
		list($a, $range) = explode("=",$_SERVER['HTTP_RANGE'],2);
		list($range) = explode(",",$range,2);
		list($range, $range_end) = explode("-", $range);
		$range=intval($range);
		if(!$range_end) {
		 $range_end=$size-1;
		} else {
		 $range_end=intval($range_end);
		}
		$new_length = $range_end-$range+1;
		header("HTTP/1.1 206 Partial Content");
		header("Content-Length: $new_length");
		header("Content-Range: bytes $range-$range_end/$size");
	} else {
		$new_length=$size;
		header("Content-Length: ".$size);
	}

	/* Will output the file itself */
	$chunksize = 1*(1024*1024); //you may want to change this
	$bytes_send = 0;
	if ($file = fopen($file, 'r')){
	if(isset($_SERVER['HTTP_RANGE']))
	fseek($file, $range);

	while(!feof($file) && (!connection_aborted()) && ($bytes_send<$new_length))
	{
		$buffer = fread($file, $chunksize);
		print($buffer); //echo($buffer); // can also possible
		flush();
		$bytes_send += strlen($buffer);
	}
	fclose($file);
	} else
	//If no permissiion
	die('Error - can not open file.');
	//die
	die();
}

if ($action=="unapp_request_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$permission="1_1_1_1";

	$data_all=explode('_',$data);
	$booking_no=$data_all[0];
	$unapp_request=$data_all[1];

	//$wo_id=return_field_value("id", "wo_booking_mst", "booking_no='$booking_no' and status_active=1 and is_deleted=0");
	$sql_wo=sql_select("select id,is_approved from wo_booking_mst where booking_no='$booking_no' and status_active=1 and is_deleted=0");
	$is_approved=2;
	foreach($sql_wo as $row)
	{
		$wo_id=$row[csf('id')];	
		$is_approved=$row[csf('is_approved')];	
	}
	//$max_approved_no=return_field_value("max(approved_no) as approved_no", "approval_history", "mst_id='".$wo_id."'  and entry_form=7","approved_no");

	//$approval_cause=return_field_value("approval_cause", "approval_cause_refusing_his", "mst_id='".$wo_id."'  and entry_form=7");
	// $approval_cause=return_field_value("approval_cause as approval_cause", "approval_cause_refusing_his", "booking_id='".$wo_id."'  and entry_form=7","approval_cause");
	
	//echo $is_approved;

	/*if($unapp_request=="")
	{*/
		$sql_request="select MAX(id) as id from fabric_booking_approval_cause where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 group by booking_id";

		$nameArray_request=sql_select($sql_request);
		foreach($nameArray_request as $row)
		{
			$unapp_request=return_field_value("approval_cause", "fabric_booking_approval_cause", "id='".$row[csf('id')]."' and status_active=1 and is_deleted=0");
		}
	//}
	
	$un_sql_request="select MAX(id) as id,max(approval_no) as approved_no from fabric_booking_approval_cause where entry_form=7  and booking_id=".$wo_id." and approval_type=2 and status_active=1 and is_deleted=0";// page_id='$menu_id'
		//echo $sql_request;
		$nameArray_un_request=sql_select($un_sql_request);
		$cause_approved_no='';
		foreach($nameArray_un_request as $approw)
		{
			$cause_approved_no=$approw[csf("approved_no")];
		}
		
		$max_approved_no=return_field_value("max(approved_no) as max_approved_no", "approval_history", "mst_id='".$wo_id."'  and entry_form=7","max_approved_no");
	// echo $max_approved_no.'='.$cause_approved_no.',';die;
		
		 
		
		
	
	if(count($nameArray_request)>0 && $max_approved_no!=$cause_approved_no)
	{ 
		$unapp_request='';$button_chk=0;
	}
	else { $unapp_request=$unapp_request;$button_chk=1;}
	 //echo $unapp_request.'='.$max_approved_no.'='.$cause_approved_no;
	?>
    <script>

		$( document ).ready(function() {
			document.getElementById("unappv_request").value='<? echo preg_replace('/[\r\n]+/','\n',$unapp_request); ?>';
			//alert(document.getElementById("unappv_request").value);
		});

		var permission='<? echo $permission; ?>';

		function fnc_appv_entry(operation)
		{
			var unappv_request = $('#unappv_request').val();

			if (form_validation('unappv_request','Un Approval Request')==false)
			{
				if (unappv_request=='')
				{
					alert("Please write request.");
				}
				return;
			}
			else
			{
				var data="action=save_update_delete_unappv_request&operation="+operation+get_submitted_data_string('unappv_request*wo_id*page_id*user_id',"../../../");
				//alert (data);return;
				freeze_window(operation);
				http.open("POST","fabric_booking_urmi_controller.php",true);
				http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				http.send(data);
				http.onreadystatechange=fnc_appv_entry_Reply_info;
			}
		}

		function fnc_appv_entry_Reply_info()
		{
			if(http.readyState == 4)
			{
				// alert(http.responseText);//return;
				var reponse=trim(http.responseText).split('**');
				show_msg(reponse[0]);

				set_button_status(1, permission, 'fnc_appv_entry',1);
				document.getElementById('hidden_appv_cause').value=reponse[3];
				parent.emailwindow.hide();
				release_freezing();

				//generate_worder_mail(reponse[2],reponse[3],reponse[4],reponse[5]);
			}
		}

		function fnc_close()
		{
			unappv_request= $("#unappv_request").val();

			document.getElementById('hidden_appv_cause').value=unappv_request;

			parent.emailwindow.hide();
		}

    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	  <textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"></textarea>
                        <Input type="hidden" name="wo_id" class="text_boxes" ID="wo_id" value="<? echo $wo_id; ?>" style="width:30px" />
                        <Input type="hidden" name="page_id" class="text_boxes" ID="page_id" value="<? echo $menu_id; ?>" style="width:30px" />
                        <Input type="hidden" name="user_id" class="text_boxes" ID="user_id" value="<? echo $user_id; ?>" style="width:30px" />
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >

                <tr>
                    <td align="center" class="button_container">
                        <?
						//print_r ($id_up_all); //$is_approved
                           // if(count($nameArray_request)>0 && $is_approved!=1)
						   	if(count($nameArray_request)>0 && $button_chk==1)
                            { //echo 'A';
                                echo load_submit_buttons($permission, "fnc_appv_entry", 1,0,"reset_form('size_1','','','','','');",1);
                            }
                            else
                            {
								//echo 'B';
                                echo load_submit_buttons($permission, "fnc_appv_entry", 0,0,"reset_form('size_1','','','','','');",1);
                            }
                        ?>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes" />

                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
            <br/>
             <?
			$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
			$sqlHisRes=sql_select($sqlHis);
		?>
		<table align="center" cellspacing="0" width="420" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
				<th>Unapproved Request History</th>
			</thead>
		</table>
		<div style="width:420px; overflow-y:scroll; max-height:260px;" align="center">
			<table align="center" cellspacing="0" width="403" class="rpt_table" border="1" rules="all">
			<?
			$i=1;
			foreach($sqlHisRes as $hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
					<td width="30"><?=$i; ?></td>
					<td style="word-break:break-all"><?=$hrow[csf('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
			</table>
		</div> 
        </div>
       
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="save_update_delete_unappv_request") 
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	//echo "shajjad_".$unappv_request.'_'.$wo_id.'_'.$page_id.'_'.$user_id; die;
	$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=7 and mst_id=$wo_id","approved_no");
	
	//echo "10**select approval_cause from approval_cause_refusing_his where approval_cause='".str_replace("'", "", $unappv_request)."' and entry_form=7 and booking_id='".str_replace("'", "", $wo_id)."' and approval_type=2 and status_active=1 and is_deleted=0"; die;
	$flag=1;
	/*if(is_duplicate_field( "approval_cause", "approval_cause_refusing_his", "approval_cause='".str_replace("'", "", $unappv_request)."' and entry_form=7 and booking_id='".str_replace("'", "", $wo_id)."' and approval_type=2 and status_active=1 and is_deleted=0" )==1)
	{
		//
	}
	else
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$idpre=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=7 and approval_type=2 group by booking_id","id");
		$sqlHis="insert into approval_cause_refusing_his( id, cause_id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause)
				select '', id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause from fabric_booking_approval_cause where booking_id=".$wo_id." and approval_type=2 and entry_form=7 and id='$idpre'";
				//echo "10**".$sqlHis; die;
		
		if(count($sqlHis)>0)
		{
			$rID3=execute_query($sqlHis,0);
			if($flag==1)
			{
				if($rID3==1) $flag=1; else $flag=0;
			}
		}
	}*/
	
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$unapproved_request=return_field_value("id","fabric_booking_approval_cause","entry_form=7 and booking_id=$wo_id and approval_type=2 and approval_no=$approved_no");

		if($unapproved_request=="")
		{
			$id_mst=return_next_id( "id", "fabric_booking_approval_cause", 1 ) ;

			$field_array="id,page_id,entry_form,user_id,booking_id,approval_type,approval_no,approval_cause,inserted_by,insert_date,status_active,is_deleted";
			$data_array="(".$id_mst.",".$page_id.",7,".$user_id.",".$wo_id." ,2,".$approved_no.",".$unappv_request.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$rID=sql_insert("fabric_booking_approval_cause",$field_array,$data_array,0);
			//echo $rID; die;

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{

				echo "0**".$rID."**".$wo_id;
			}
			disconnect($con);
			die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			
			$idpre=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=7 and approval_type=2 group by booking_id","id");
			
			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*7*".$user_id."*".$wo_id."*2*".$approved_no."*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";
			
			$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$idpre."",0);
			if($rID==1 && $flag==1) $flag=1; else $flag=0;

			if($db_type==0)
			{
				if($flag==1)
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($flag==1)
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			else if($db_type==1 )
			{
				echo "1**".$rID."**".str_replace("'","",$wo_id);
			}
			disconnect($con);
			die;
		}
	}
	else if ($operation==1)  // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$update_id=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=7 and approval_type=2 group by booking_id","id");
		
		$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date";
		$data_array="".$page_id."*7*".$user_id."*".$wo_id."*2*".$approved_no."*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";
		
		$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$update_id."",0);
		if($rID==1 && $flag==1) $flag=1; else $flag=0;
	
		//echo "10**".$rID.'--'.$rID3.'--'.$flag; die;
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$rID;
			}
		}
		else if($db_type==2)
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID;
			}
		}
		else if($db_type==1 )
		{
			echo "1**".$rID."**".str_replace("'","",$wo_id);
		}
		disconnect($con);
		die;
	}
}

if ($action=="refusing_cause_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$data_all=explode('_',$data);
	$booking_no=$data_all[0];
	$unapp_request=$data_all[1];

	$wo_id=return_field_value("id", "wo_booking_mst", "booking_no='$booking_no' and status_active=1 and is_deleted=0");

	$refusing_reason=return_field_value("refusing_reason", "refusing_cause_history", "mst_id='".$wo_id."'  and entry_form=7");
	
		
	?>
    <script type="text/javascript">
    	function fnc_close()
		{
			unappv_request= $("#unappv_request").val();

			document.getElementById('hidden_appv_cause').value=unappv_request;

			parent.emailwindow.hide();
		}
    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character" readonly><?=$refusing_reason?></textarea>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
        <?
			$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=7 and booking_id='$wo_id' and approval_type='1' and status_active=1 and is_deleted=0 order by id Desc";
			$sqlHisRes=sql_select($sqlHis);
		?>
		<table align="center" cellspacing="0" width="420" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
				<th>Refusing History</th>
			</thead>
		</table>
		<div style="width:420px; overflow-y:scroll; max-height:260px;" align="center">
			<table align="center" cellspacing="0" width="403" class="rpt_table" border="1" rules="all">
			<?
			$i=1;
			foreach($sqlHisRes as $hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
					<td width="30"><?=$i; ?></td>
					<td style="word-break:break-all"><?=$hrow[csf('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
			</table>
		</div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="show_fabric_booking_report_mf")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut) as plan_cut", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")","plan_cut");
	$po_qnty_tot1=return_field_value( "sum(po_quantity) as po_quantity", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")","po_quantity");


	//echo $txt_order_no_id.'='.$po_qnty_tot; die;

	$po_number_arr=return_library_array( "select id,po_number from   wo_po_break_down",'id','po_number');
	$po_ship_date_arr=return_library_array( "select id,pub_shipment_date from   wo_po_break_down ",'id','pub_shipment_date');
	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");

	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");

	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$path = str_replace("'", "", $path);
	if ($path == "") {
		$path = '../../';
	}
ob_start();
	?>									<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php echo $company_library[$cbo_company_name]; ?>
                            </td>
                            <td rowspan="3" width="250">
                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span>
                               <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
							//echo "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name";
							//echo "select location_name from wo_po_details_master where job_no=$txt_job_no";die;
                          $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						   if($txt_job_no!="") $location=return_field_value( "location_name as location_name", "wo_po_details_master","job_no=$txt_job_no","location_name"); else $location="";

                            foreach ($nameArray as $result)
                            {
								echo $location_name_arr[$location];
                            	?>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No:<? echo $result[csf('website')];
                            }

							$nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.fabric_composition, a.remarks, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.currency_id, a.pay_mode, a.rmg_process_breakdown, a.sustainability_standard, a.fab_material, a.insert_date, a.inserted_by, a.update_date, a.quality_level, a.is_approved,  b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no from wo_booking_mst a, wo_po_details_master b where a.is_deleted=0 and b.is_deleted=0  and  a.job_no=b.job_no and a.booking_no=$txt_booking_no");

							$qualityLevel=$nameArray[0][csf('quality_level')];
							if($nameArray[0][csf('is_approved')]==1){
                				$approved_msg= "(Fully approved)";
                			}
                			elseif ($nameArray[0][csf('is_approved')]==3) {
                				$approved_msg= "(Partial approved)";
                			}
                			else{
                				$approved_msg='';
                			}
                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong>&nbsp; &nbsp;&nbsp;&nbsp;<? echo $report_title;?> &nbsp;&nbsp;&nbsp;<font style="color:#F00"><? echo $approved_msg; if($qualityLevel>0) echo " (".$fbooking_order_nature[$qualityLevel].")"; else echo ""; ?>  </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $style_ref_no=""; $inserted_by=""; $currency_id="";

				$po_id_all=$nameArray[0][csf('po_break_down_id')];
				if($po_id_all!="") $po_id_all_cond="id in($po_id_all)";else $po_id_all_cond="id in(0)";
				if($po_id_all!="") $po_id_all_cond2="po_number_id in($po_id_all)";else $po_id_all_cond2="po_number_id in(0)";
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where $po_id_all_cond",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and $po_id_all_cond2");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$inserted_by=$result[csf('inserted_by')];
					$currency_id=$result[csf('currency_id')];
					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
						$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
						$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time[$row_lead_time[csf('date_diff')]]=$row_lead_time[csf('date_diff')];
					}

					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					$intRef=array();
					$sql_grouping= "select  grouping from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_grouping=sql_select($sql_grouping);
					foreach ($data_array_grouping as $row_array_grouping)
					{
						$intRef[$row_array_grouping[csf('grouping')]]=$row_array_grouping[csf('grouping')];
					}

					if($db_type==2)
					{
						$group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                   		listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
					}
					else $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				?>
                <table width="100%" style="border:1px solid black; margin-top:1px;font-family:Arial Narrow; font-size:16px" >
                    <tr>
                        <td colspan="5" valign="top" style="font-size:16px; color:#F00">
                        <?
                        if($result[csf('is_apply_last_update')]==2){
                       	 echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]];
                        }
                        else echo "";
                        ?>
                        </td>
                    </tr>
                    <tr>
                        <td width="120"><span style="font-size:16px"><b>Buyer/Agent Name</b></span></td>
                        <td width="225">:&nbsp;<span style="font-size:16px">:<b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                        <td width="120" style="font-size:16px"><b>Booking No </b>   </td>
                        <td width="225" style="font-size:16px">:<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
                        <td rowspan="6">
                        <? $data_array=sql_select("select b.approved_no, b.approved_date, b.comments from  wo_booking_mst a , approval_history b where a.id=b.mst_id  and a.booking_no=$txt_booking_no and b.entry_form=7 group by b.approved_no, b.approved_date, b.comments order by b.approved_no"); ?>
                        <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
                        	<?
							$i;
							foreach($data_array as $row)
							{
								?>
								<tr style="border:1px solid black;">
                                    <td width="10%" style="border:1px solid black;"><? echo "Revise-0".$row[csf('approved_no')];?></td>
                                    <td width="30%" style="border:1px solid black;"><? echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td>
                                    <td width="60%" style="border:1px solid black;"><? echo $row[csf('comments')];?></td>
								</tr>
								<?
								$i++;
							}

							//for Un approve request comment
							$menu_id=$_SESSION['menu_id'];
							$user_id=$_SESSION['logic_erp']['user_id'];
							$un_pprove_reques_data_array=sql_select("select b.approval_cause from wo_booking_mst a , fabric_booking_approval_cause b where a.id=b.booking_id and a.booking_no=$txt_booking_no and b.entry_form=7 and b.approval_type=2 order by b.approval_no");//and b.page_id=$menu_id and b.user_id=$user_id

							if(count($un_pprove_reques_data_array)>0)
							{
								foreach($un_pprove_reques_data_array as $row)
								{
									?>
									<tr>
										<td colspan="3"><? echo  "<b>Un-approve request: </b>". $row[csf('approval_cause')]; ?></td>
									</tr>
									<?
								}
							}
							?>
                        </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Style Ref.</b>   </td>
                        <td style="font-size:16px">: <b><? echo $result[csf('style_ref_no')];  $style_ref_no=$result[csf('style_ref_no')]; ?></b></td>
                        <td style="font-size:16px"><b>Booking Release Date</b></td>
                        <td>:<? $booking_date=$result[csf('update_date')]; if($booking_date=="" || $booking_date=="0000-00-00 00:00:00") $booking_date=$result[csf('insert_date')]; echo change_date_format($booking_date,'dd-mm-yyyy','-',''); ?>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Style Des.</b></td>
                        <td>:<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                        <td style="font-size:16px"><b>Po Received Date</b></td>
                        <td>:<? echo $po_received_date; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Supplier Name</b></td>
                        <td><? if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]]; else echo $supplier_name_arr[$result[csf('supplier_id')]]; ?>
                        </td>
                        <td style="font-size:16px"><b>Lead Time </b>   </td>
                        <td>:<? echo implode(",",$lead_time);?> </td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Season</b></td>
                        <td>:<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                        <td style="font-size:16px"><b>Dealing Merchant</b></td>
                        <td>:<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
                    </tr>
                    <tr>
                        <td><span style="font-size:16px"><b>Order Qnty</b></span></td>
                        <td>:<? echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]]; ?></td>
                        <td style="font-size:16px"><b>Attention</b></td>
                        <td>:<? echo $result[csf('attention')]; ?></td>
                    </tr>
                    <tr>
                        <td><span style="font-size:16px"><b>Int. Ref.</b></span></td>
                        <td>:<? echo implode(",",$intRef); ?></td>
                        <td width="100" style="font-size:16px"><b>Order Repeat No</b></td>
                        <td width="110" style="font-size:16px"> :&nbsp;<b><? echo  $result[csf('order_repeat_no')];?></b></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Remarks</b></td>
                        <td> :<? echo $result[csf('remarks')]?></td>
						<td style="font-size:16px"><b>Sustainability Standard</b></td>
                        <td title="<?=$result[csf('sustainability_standard')];?>"> :<? echo $sustainability_standard[$result[csf('sustainability_standard')]]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Fabric Composition</b></td>
                        <td> :<? echo $result[csf('fabric_composition')]?></td>
						<?php $fab_material=array(1=>"Organic",2=>"BCI"); ?>
						<td style="font-size:16px"><b>Fab. Material</b></td>
                        <td> :<? echo $fab_material[$result[csf('fab_material')]]; ?></td>
                    </tr>
                </table>
			<?
            }

		$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by size_order");
	   ?>
		<table width="100%" style="font-family:Arial Narrow" >
			<tr>
				<td width="1000">
					<table  class="rpt_table"  border="1" align="left" cellpadding="2" width="100%" cellspacing="0" rules="all" >
					<caption style="font-weight:bold">Color Size Info</caption>
						<tr>
							<td style="border:1px solid black"><strong>PO Number</strong></td>
							<td style="border:1px solid black"><strong>Ship Date</strong></td>
							<td style="border:1px solid black"><strong>Gmts Item</strong></td>
							<td style="border:1px solid black"><strong>Color/Size</strong></td>
							<?
							foreach($nameArray_size  as $result_size){ ?>
							<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
							<? } ?>
							<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
							<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
							<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
						</tr>
						<?
						$color_size_order_qnty_array=array(); $color_size_qnty_array=array();  $size_tatal=array(); $size_tatal_order=array(); $color_dtls_arr=array(); $item_wise_color_arr=array(); $size_qty_arr=array();
						$order_id=explode(",",str_replace("'","",$txt_order_no_id));

						$nameArray_color=sql_select( "select po_break_down_id, item_number_id, color_number_id, size_number_id, min(id) as id,min(color_order) as color_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by po_break_down_id, item_number_id, color_number_id, size_number_id  order by color_order");
						foreach($nameArray_color as $row)
						{
							$item_wise_color_arr[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]].=$row[csf('color_number_id')].',';
							$color_dtls_arr[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]['id']=$row[csf('id')];
							$color_dtls_arr[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]['color_order']=$row[csf('color_order')];
							$size_qty_arr[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']+=$row[csf('plan_cut_qnty')];
							$size_qty_arr[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']+=$row[csf('order_quantity')];
						}
						unset($nameArray_color);

						for($or=0;$or<count($order_id); $or++)
						{
							for($c=0;$c<count($gmts_item); $c++)
							{
								$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
								$ex_color_id=array_filter(array_unique(explode(",",$item_wise_color_arr[$order_id[$or]][$gmts_item[$c]])));
								foreach($ex_color_id as $excolor_id)
								{
									?>
									<tr>
										<td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; ?></td>
										<td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); ?></td>
										<td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; ?></td>
										<td align="center" style="border:1px solid black"><? echo $color_library[$excolor_id]; ?></td>
										<?
										$color_total=0; $color_total_order=0;
										foreach($nameArray_size  as $result_size)
										{
											$size_plan_qty=$size_qty_arr[$order_id[$or]][$gmts_item[$c]][$excolor_id][$result_size[csf('size_number_id')]]['plan'];
											$size_po_qty=$size_qty_arr[$order_id[$or]][$gmts_item[$c]][$excolor_id][$result_size[csf('size_number_id')]]['order'];
											?>
											<td style="border:1px solid black; text-align:right">
											<?
											if($size_plan_qty!= "")
											{
												echo number_format($size_po_qty,0);
												$color_total += $size_plan_qty ;
												$color_total_order += $size_po_qty ;
												$item_grand_total+=$size_plan_qty;
												$item_grand_total_order+=$size_po_qty;
												$grand_total +=$size_plan_qty;
												$grand_total_order +=$size_po_qty;
												$color_size_qnty_array[$result_size[csf('size_number_id')]][$excolor_id]=$size_plan_qty;
												$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$excolor_id]=$size_po_qty;
												if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
												{
													$size_tatal[$result_size[csf('size_number_id')]]+=$size_plan_qty;
													$size_tatal_order[$result_size[csf('size_number_id')]]+=$size_po_qty;
												}
												else
												{
													$size_tatal[$result_size[csf('size_number_id')]]=$size_plan_qty;
													$size_tatal_order[$result_size[csf('size_number_id')]]=$size_po_qty;
												}
												if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
												{
													$item_size_tatal[$result_size[csf('size_number_id')]]+=$size_plan_qty;
													$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$size_po_qty;
												}
												else
												{
													$item_size_tatal[$result_size[csf('size_number_id')]]=$size_plan_qty;
													$item_size_tatal_order[$result_size[csf('size_number_id')]]=$size_po_qty;
												}
											}
											else echo "0";
											?>
											</td>
											<?
										}
										?>
										<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
										<td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
										<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
									</tr>
									<?
								}
								?>
								<tr style="display:none">
									<td align="center" style="border:1px solid black"><strong></strong></td>
									<td align="center" style="border:1px solid black"><strong></strong></td>
									<td align="center" style="border:1px solid black"><strong></strong></td>
									<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
									<?
									foreach($nameArray_size  as $result_size)
									{
										?>
										<td style="border:1px solid black; text-align:right"><? echo number_format($item_size_tatal_order[$result_size[csf('size_number_id')]],0); ?></td>

										<?
									}
									?>
									<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
									<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
									<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
								</tr>
								<?
							}
						}
						?>
						<tr>
							<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+7; ?>"><strong>&nbsp;</strong></td>
						</tr>
						<tr>
							<td align="center" style="border:1px solid black"><strong></strong></td>
							<td align="center" style="border:1px solid black"><strong></strong></td>
							<td align="center" style="border:1px solid black"><strong></strong></td>
							<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
							<?
							foreach($nameArray_size  as $result_size)
							{
								?>
								<td style="border:1px solid black; text-align:right"><? echo number_format($size_tatal_order[$result_size[csf('size_number_id')]],0); ?></td>
								<?
							}
							?>
							<td style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
							<td style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
							<td style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
						</tr>
					</table>
				</td>
				<td width="330" valign="top" align="left">
					<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
					<table width="310">
						<caption style="font-weight:bold">Image</caption>
						<tr>
							<?
							$img_counter = 0;
							foreach($nameArray_imge as $result_imge)
							{
								?><td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td><?
								$img_counter++;
							}
							?>
						</tr>
					</table>
				</td>
			</tr>
		</table>
      	<br/>
      	<?
		if($cbo_fabric_source==1)
		{
			?>
			<strong>Finish Fabric Details</strong>
			<table class="rpt_table" width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow">
                <tr>
                    <td width="120" align="left">Fabric Color</td>
                    <td width="120" align="left">Fabric</td>
                    <td width="120" align="left">Composition</td>
                    <td width="120" align="left">GSM</td>
                    <td width="80" align="left">Process Loss</td>
                    <?
                    foreach($nameArray_size  as $result_size)
                    {?>
                    <td align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <? } ?>
                    <td width="50">Fin. Fab. Total (Kg)</td>
                    <td width="50">Grey Fab. Total (Kg)</td>
                </tr>
                <?
                $fabric_color_arr=array();
                $sql_contrast="select pre_cost_fabric_cost_dtls_id, contrast_color_id, gmts_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'";
                $sql_contrast_res=sql_select($sql_contrast);
                foreach($sql_contrast_res as $crow)
                {
                	$fabric_color_arr[$crow[csf('pre_cost_fabric_cost_dtls_id')]][$crow[csf('contrast_color_id')]]=$crow[csf('gmts_color_id')];
                }
                unset($sql_contrast_res);


                $color_wise_wo_qty_arr=array();
                $color_wise_wo_sql_qnty=sql_select("select  a.id, c.size_number_id, d.fabric_color_id, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and d.job_no='$job_no' and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.id, c.size_number_id, d.fabric_color_id");
                foreach($color_wise_wo_sql_qnty as $row)
                {
					$color_wise_wo_qty_arr[$row[csf("id")]][$row[csf("size_number_id")]][$row[csf("fabric_color_id")]]['fin']=$row[csf("fin_fab_qnty")];
					$color_wise_wo_qty_arr[$row[csf("id")]][$row[csf("size_number_id")]][$row[csf("fabric_color_id")]]['grey']=$row[csf("grey_fab_qnty")];
                }
                unset($color_wise_wo_sql_qnty);

                $sql_dia_array=array();
                $sql_dia=sql_select("Select pre_cost_fabric_cost_dtls_id, color_number_id, dia_width, gmts_sizes from wo_pre_cos_fab_co_avg_con_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") ");
                foreach($sql_dia as $sql_dia_row)
                {
                	$sql_dia_array[$sql_dia_row[csf("pre_cost_fabric_cost_dtls_id")]][$sql_dia_row[csf("color_number_id")]][$sql_dia_row[csf("gmts_sizes")]][$sql_dia_row[csf("dia_width")]]= $sql_dia_row[csf("dia_width")];
                }
                unset($sql_dia);

                $wo_pre_cost_fabric_cost_dtls_id=array();
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select d.fabric_color_id, a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_type_id,a.color_size_sensitive,  avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and  c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.body_part_id in(1,20) and  d.booking_no =$txt_booking_no and d.job_no='$job_no' and d.status_active=1 and  d.is_deleted=0 group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_type_id,a.color_size_sensitive,d.fabric_color_id order by cid");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					$wo_pre_cost_fabric_cost_dtls_id[$color_wise_wo_result[csf('id')]]=$color_wise_wo_result[csf('id')];
					$fabric_color_id="";
					if($color_wise_wo_result[csf('color_size_sensitive')]==3) $fabric_color_id=$fabric_color_arr[$color_wise_wo_result[csf('id')]][$color_wise_wo_result[csf('fabric_color_id')]];
					else $fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
					?>
					<tr>
                        <td width="120" align="left"><? echo $fabric_typee[$color_wise_wo_result[csf('width_dia_type')]]; ?></td>
                        <td width="120" align="left">&nbsp;</td>
                        <td>&nbsp;</td>
                        <td width="120" align="left">&nbsp;</td>
                        <td width="80" align="left">&nbsp;</td>
                        <?
                        foreach($nameArray_size  as $result_size){
							?>
							<td width='50'>&nbsp;
							<? $dia=implode(",", $sql_dia_array[$color_wise_wo_result[csf('id')]][$fabric_color_id][$result_size[csf('size_number_id')]]);
							echo $dia; ?>
							</td>
							<?
                        }
                        ?>
                        <td align="right">&nbsp;</td>
                        <td align="right">&nbsp;</td>
					</tr>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120" align="left"><? echo $color_wise_wo_result[csf('construction')]; ?></td>
                        <td><? echo $color_wise_wo_result[csf('composition')].",".$color_type[$color_wise_wo_result[csf('color_type_id')]]; ?></td>
                        <td width="120" align="left"><? echo $color_wise_wo_result[csf('gsm_weight')]; ?></td>
                        <td width="80" align="left"><? echo number_format($color_wise_wo_result[csf('process_loss_percent')],2); ?></td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;

                        foreach($nameArray_size  as $result_size)
                        {
							$fin_qty=$color_wise_wo_qty_arr[$color_wise_wo_result[csf('id')]][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('fabric_color_id')]]['fin'];
							$grey_qty=$color_wise_wo_qty_arr[$color_wise_wo_result[csf('id')]][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('fabric_color_id')]]['grey'];
							?>
							<td width='50' align='right' >
								<?
                                if($fin_qty!="")
                                {
									echo number_format($fin_qty,2); $total_fin_fab_qnty+=$fin_qty; $total_grey_fab_qnty+=$grey_qty;
                                }
                                ?>
							</td>
							<?
                        }
                        ?>
                        <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty; ?></td>
                        <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty; ?></td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="80" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_size  as $result_size)
                    {
						$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(b.cons) as avg_cons FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no ='$job_no' and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_id in(1,20) and c.size_number_id='".$result_size[csf('size_number_id')]."' and d.status_active=1 and  d.is_deleted=0");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2);?></td>
						<?
                    }
                    ?>
                    <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                </tr>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="80" align="left"><strong>Consumption</strong></td>
                    <?
                    foreach($nameArray_size  as $result_size)
                    {
						$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(b.cons) as avg_cons FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no ='$job_no' and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_id in(1,20) and c.size_number_id='".$result_size[csf('size_number_id')]."' and d.status_active=1 and d.is_deleted=0 ");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('avg_cons')],4);?></td>
						<?
                    }
                    ?>
                    <td align="right"></td>
                    <td align="right"></td>
                </tr>
			</table>
			<br/>
			<?
			$wo_pre_cost_fabric_cost_dtls_id_main_fabric=implode(",", $wo_pre_cost_fabric_cost_dtls_id);
			if( $wo_pre_cost_fabric_cost_dtls_id_main_fabric !="")
			{
				$wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond="and pre_cost_fabric_cost_dtls_id not in($wo_pre_cost_fabric_cost_dtls_id_main_fabric)";
			}

			$nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.uom,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id not in(1,20) and d.status_active=1 and d.is_deleted=0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.uom,b.dia_width order by a.body_part_id,b.dia_width,cid");
			?>
            <table class="rpt_table" width="100%"  border="1" cellpadding="2" cellspacing="0" rules="all" style="font-family:Arial Narrow" >
                <tr align="center">
                    <td width='50'></td>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                    	if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>"; else  echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]].",".$result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <td width='50'></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>"; else echo "<td colspan='3' >".$result_fabric_description[csf('composition')].",". $color_type[$result_fabric_description[csf('color_type_id')]].",". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <td width='50'></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')]== "") echo "<td colspan='3'>&nbsp</td>"; else echo "<td colspan='3' align='center'>".$fabric_typee[$result_fabric_description[csf('width_dia_type')]].",". $result_fabric_description[csf('dia_width')].",".number_format($result_fabric_description[csf('cons')],4)."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <td width='50'></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('uom')] == "")   echo "<td colspan='3'>&nbsp</td>"; else echo "<td colspan='3' align='center'>".$unit_of_measurement[$result_fabric_description[csf('uom')]]."</td>";
                    }
                    ?>
                </tr>
                <tr>
                    <th width='50'>Gmt Color</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Color</th><th width='50'>Fin. Qty</th><th width='50'>Grey. Qty</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select gmts_color_id, contrast_color_id FROM wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
					if($gmt_color_row[csf("contrast_color_id")]!=$gmt_color_row[csf("gmts_color_id")]){
						$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]] ;
					}
                }

                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select gmts_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0 group by gmts_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width='50' align='right'>
                        <?
                        if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]!="") echo $color_library[$color_wise_wo_result[csf('gmts_color_id')]];
                        else echo $color_library[$color_wise_wo_result[csf('gmts_color_id')]];
                        ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        $color_wise_qty_arr=array(); $grey_fin_qty_arr=array(); $grey_fab_color_arr=array();
                        $color_wise_wo_sql_qnty=sql_select("select a.body_part_id, a.color_type_id, d.fabric_color_id, a.construction, a.composition, a.gsm_weight, a.uom, b.dia_width,  d.gmts_color_id, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                        WHERE a.job_no=b.job_no and
                        a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and
                        b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						
						
						c.id=d.color_size_table_id AND a.status_active = 1  AND a.is_deleted = 0  AND b.status_active = 1 AND b.is_deleted = 0 AND c.is_deleted = 0 and
						
                        d.booking_no =$txt_booking_no and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.color_type_id, d.fabric_color_id, a.construction, a.composition, a.gsm_weight, a.uom, b.dia_width, d.gmts_color_id");
                        foreach($color_wise_wo_sql_qnty as $row)
                        {
							$color_wise_qty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('uom')]][$row[csf('dia_width')]][$row[csf('gmts_color_id')]][$row[csf('fabric_color_id')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
							$color_wise_qty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('uom')]][$row[csf('dia_width')]][$row[csf('gmts_color_id')]][$row[csf('fabric_color_id')]]['grey_fab_qnty']+=$row[csf('grey_fab_qnty')];

							$grey_fin_qty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('uom')]][$row[csf('dia_width')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
							$grey_fin_qty_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('uom')]][$row[csf('dia_width')]]['grey_fab_qnty']+=$row[csf('grey_fab_qnty')];
							$grey_fab_color_arr[$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('uom')]][$row[csf('dia_width')]][$row[csf('gmts_color_id')]]['fabric_color_id']=$row[csf('fabric_color_id')];
                        }
                        unset($color_wise_wo_sql_qnty);

                        foreach($nameArray_fabric_description as $result_fabric_description)
						{
							?>
							<td width='50' align='right'>
								<?
                                $fabric_color_id=$grey_fab_color_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('uom')]][$result_fabric_description[csf('dia_width')]][$color_wise_wo_result[csf('gmts_color_id')]]['fabric_color_id'];

                                $color_wise_fin_qty=$color_wise_qty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('uom')]][$result_fabric_description[csf('dia_width')]][$color_wise_wo_result[csf('gmts_color_id')]][$fabric_color_id]['fin_fab_qnty'];

                                $color_wise_grey_qty=$color_wise_qty_arr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('uom')]][$result_fabric_description[csf('dia_width')]][$color_wise_wo_result[csf('gmts_color_id')]][$fabric_color_id]['grey_fab_qnty'];

                                if($color_wise_fin_qty!="") echo $color_library[$fabric_color_id];
                                ?>
							</td>
							<td width='50' align='right' ><? if($color_wise_fin_qty!="") echo number_format($color_wise_fin_qty,2); ?></td>
							<td width='50' align='right' ><? if($color_wise_grey_qty!="") echo number_format($color_wise_grey_qty,2); ?></td>
							<?
                        }
                        ?>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <td width='50' align='right'></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fab_des)
                    {
						$fin_fab_qnty=$grey_fin_qty_arr[$result_fab_des[csf('body_part_id')]][$result_fab_des[csf('color_type_id')]][$result_fab_des[csf('construction')]][$result_fab_des[csf('composition')]][$result_fab_des[csf('gsm_weight')]][$result_fab_des[csf('uom')]][$result_fab_des[csf('dia_width')]]['fin_fab_qnty'];
						$grey_fab_qnty=$grey_fin_qty_arr[$result_fab_des[csf('body_part_id')]][$result_fab_des[csf('color_type_id')]][$result_fab_des[csf('construction')]][$result_fab_des[csf('composition')]][$result_fab_des[csf('gsm_weight')]][$result_fab_des[csf('uom')]][$result_fab_des[csf('dia_width')]]['grey_fab_qnty'];
						?>
						<td width='50' align='right'></td>
						<td width='50' align='right' > <? echo number_format($fin_fab_qnty,2);?></td>
						<td width='50' align='right' > <? echo number_format($grey_fab_qnty,2);?></td>
						<?
                    }
                    ?>
                </tr>
			</table>
			<?
		}
	  //=====================================================================Production End==============================================================
	  //=====================================================================Purchase Start==============================================================
	  if($cbo_fabric_source==2)
	  {
	$color_wise_wo_sql=sql_select("select d.fabric_color_id, a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_type_id,a.color_size_sensitive, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment ,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.body_part_id in(1,20) and
				d.booking_no =$txt_booking_no and
				d.status_active=1 and
				d.is_deleted=0
				group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_type_id,a.color_size_sensitive,d.fabric_color_id order by cid ");

	  ?><!--  Here will be the main portion  -->
    <strong>Fabric Details</strong>
    <table  width="100%"  border="0" cellpadding="2" cellspacing="0" style="font-family:Arial Narrow" >
    <tr>
     <?
	if(count($color_wise_wo_sql)>0)
	{
	?>
    <td width="49%">
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
       <tr>
            <td  width="120" align="left">Fabric Color</td>
            <td  width="120" align="left">Fabric</td>
            <td  width="120" align="left">Composition</td>
            <td  width="120" align="left">GSM</td>
            <td  width="120" align="left">Process Loss</td>
			<? foreach($nameArray_size  as $result_size){?>
            	<td align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
            <? } ?>
            <td width="50">Total (Kg)</td>
            <td width="50">Rate</td>
            <td width="50">Amount</td>
       </tr>
       <?
		$costing_per=""; $costing_per_qnty=0;
		$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
		if($costing_per_id==1)
		{
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
		}
		if($costing_per_id==2)
		{
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
		}
		if($costing_per_id==3)
		{
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
		}
		if($costing_per_id==4)
		{
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
		}
		if($costing_per_id==5)
		{
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
		}
		$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");


		$wo_pre_cost_fabric_cost_dtls_id=array();
		$grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0; $grand_total_amount=0;
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$wo_pre_cost_fabric_cost_dtls_id[$color_wise_wo_result[csf('id')]]=$color_wise_wo_result[csf('id')];
			$fabric_color_id="";
			if($color_wise_wo_result[csf('color_size_sensitive')]==3)
			{
			$fabric_color_id=return_field_value( "gmts_color_id", "wo_pre_cos_fab_co_color_dtls","pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and contrast_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."'");
			}
			else
			{
			$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
			}


			$sql_dia_array=array();
		   $sql_dia=sql_select("Select dia_width,gmts_sizes from wo_pre_cos_fab_co_avg_con_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and color_number_id='".$fabric_color_id."'");

		   foreach($sql_dia as $sql_dia_row)
		   {
			$sql_dia_array[$sql_dia_row[csf("gmts_sizes")]][$sql_dia_row[csf("dia_width")]]= $sql_dia_row[csf("dia_width")];
		   }
		?>
			<tr>
                <td width="120" align="left"><? echo $fabric_typee[$color_wise_wo_result[csf('width_dia_type')]]; ?></td>
                <td width="120" align="left">&nbsp;</td>
                <td>&nbsp;</td>
                <td width="120" align="left">&nbsp;</td>
                <td  width="120" align="left">&nbsp;</td>
                <?
                $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                foreach($nameArray_size  as $result_size)
                {
					?>
					<td width='50'>&nbsp;
						<? $dia=implode(",", $sql_dia_array[$result_size[csf('size_number_id')]]); echo $dia; ?>
					</td>
					<?
                }
                ?>
                <td align="right">&nbsp;</td>
                <td align="right">&nbsp;</td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                <td width="120" align="left"><? echo $color_wise_wo_result[csf('construction')].",".$color_type[$color_wise_wo_result[csf('color_type_id')]]; ?></td>
                <td><? echo $color_wise_wo_result[csf('composition')]; ?></td>
                <td width="120" align="left"><? echo $color_wise_wo_result[csf('gsm_weight')]; ?></td>
                <td width="120" align="left"><? echo $color_wise_wo_result[csf('process_loss_percent')]; ?></td>
                <?
                $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                foreach($nameArray_size  as $result_size)
                {
                    $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                    WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and  b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.id='".$color_wise_wo_result[csf('id')]."' and c.size_number_id='".$result_size[csf('size_number_id')]."' and d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and d.status_active=1 and d.is_deleted=0");
                    list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
					?>
					<td width='50' align='right' >
					<?
					if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
					{
						echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);
						$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					}
					?>
					</td>
					<?
                }
                ?>
                <td align="right"><? echo number_format($total_grey_fab_qnty,4); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                <td align="right"><? echo number_format($color_wise_wo_result_qnty[csf('rate')],4); ?></td>
                <td align="right"><? $amount=$total_grey_fab_qnty*$color_wise_wo_result_qnty[csf('rate')]; echo number_format($amount,4); $grand_total_amount+=$amount;?></td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
            <!--<td  width="120" align="left">&nbsp;</td>-->
            <th  width="120" align="left">&nbsp;</th>
            <td  width="120" align="left">&nbsp;</td>
            <td  width="120" align="left">&nbsp;</td>
            <td  width="120" align="left">&nbsp;</td>
            <td  width="120" align="left"><strong>Total</strong></td>
            <?
                foreach($nameArray_size  as $result_size)
                {
                    $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                                                    WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id in(1,20) and c.size_number_id='".$result_size[csf('size_number_id')]."' and d.status_active=1 and d.is_deleted=0 ");
                    list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                    ?>
                    <td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);?></td>
                    <?
                }
                ?>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,4);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_grey_fab_qnty,4);?></td>
            <td align="right"><? echo number_format($grand_total_amount,4);?></td>
        </tr>
    </table>
    </td>
    <td width="2%"></td>
  	<?
	}
	?>
 	<td width="49%" valign="top">
	 <?
     $wo_pre_cost_fabric_cost_dtls_id_main_fabric=implode(",", $wo_pre_cost_fabric_cost_dtls_id);
     if( $wo_pre_cost_fabric_cost_dtls_id_main_fabric !="")
     {
         $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond="and pre_cost_fabric_cost_dtls_id not in($wo_pre_cost_fabric_cost_dtls_id_main_fabric)";
     }
     $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
    WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id not in(1,20) and d.status_active=1 and d.is_deleted=0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width,cid"); ?>
        <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
            <tr align="center">
                <td width='50'></td>
                <?
                foreach($nameArray_fabric_description  as $result_fabric_description)
                {
                if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='4'>&nbsp</td>"; else  echo "<td  colspan='4'>". $body_part[$result_fabric_description[csf('body_part_id')]].",".$result_fabric_description[csf('construction')]."</td>";
                }
                ?>
            </tr>
            <tr align="center">
                <td width='50'></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='4' >&nbsp</td>"; else echo "<td colspan='4' >".$result_fabric_description[csf('composition')].",". $color_type[$result_fabric_description[csf('color_type_id')]].",". $result_fabric_description[csf('gsm_weight')]."</td>";
                }
                ?>
            </tr>
            <tr align="center">
                <td width='50'></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
					if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='4'>&nbsp</td>"; else echo "<td colspan='4' align='center'>".$fabric_typee[$result_fabric_description[csf('width_dia_type')]].",". $result_fabric_description[csf('dia_width')].",".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                }
                ?>
            </tr>
            <tr>
                <th width='50'>Gmt Color</th>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                	echo "<th width='50'>Color</th><th width='50' >Qty</th><th width='50'>Rate</th><th width='50' >Amount</th>";
                }
                ?>
            </tr>
            <?
            $gmt_color_library=array();
            $gmt_color_data=sql_select("select gmts_color_id,contrast_color_id FROM wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_no'");
            foreach( $gmt_color_data as $gmt_color_row)
            {
            	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
            }

            $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
            $color_wise_wo_sql=sql_select("select gmts_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no $wo_pre_cost_fabric_cost_dtls_id_main_fabric_cond and status_active=1 and is_deleted=0  group by gmts_color_id");
            foreach($color_wise_wo_sql as $color_wise_wo_result)
            {
				?>
				<tr>
                    <td width='50' align='right'>
						<?
                        if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]!="") echo $color_library[$color_wise_wo_result[csf('gmts_color_id')]];
                        else echo $color_library[$color_wise_wo_result[csf('gmts_color_id')]];
                        ?>
                    </td>
                    <?
                    $total_fin_fab_qnty=0; $total_grey_fab_qnty=0; $total_amount=0;
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$color_wise_wo_sql_qnty=sql_select("select d.fabric_color_id,  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and  b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and a.construction='".$result_fabric_description[csf('construction')]."' and a.composition='".$result_fabric_description[csf('composition')]."' and a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and b.dia_width='".$result_fabric_description[csf('dia_width')]."' and d.gmts_color_id=".$color_wise_wo_result[csf('gmts_color_id')]." and d.status_active=1 and d.is_deleted=0 group by d.fabric_color_id ");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
						?>
						<td width='50' align='right'><? if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="") echo $color_library[$color_wise_wo_result_qnty[csf('fabric_color_id')]]; ?></td>
						<td width='50' align='right'><?
							if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
							{
							echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);
							$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
							}
							?>
						</td>
						<td width='50' align='right'><? if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="") echo number_format($color_wise_wo_result_qnty[csf('rate')],4); ?></td>
						<td width='50' align='right' >
						<?
						if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
						{
							$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
							echo number_format($amount,4);
							$total_amount+=$amount;
						}
						?>
						</td>
						<?
                    }
                    ?>
                </tr>
                <?
            }
            ?>
            <tr style=" font-weight:bold">
                <td width='50' align='right'></td>
                <?
                $other_fab_total=0;
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id and
					c.job_no_mst=a.job_no and
					c.id=b.color_size_table_id and
					b.po_break_down_id=d.po_break_down_id and
					b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.status_active=1 and
					d.is_deleted=0
					");
					list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
					?>
					<td width='50' align='right'></td>
					<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);?></td>
					<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('rate')],4);?></td>
					<td width='50' align='right' >
					<?
					$fabwise_amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
					echo number_format($fabwise_amount,4);
					$other_fab_total+=$fabwise_amount;
					?>
					</td>
					<?
                }
                ?>
            </tr>
        </table>
 		</td>
 	</tr>
 </table>
    <br/>
    <table width="100%" cellpadding="2" cellspacing="0" class="rpt_table" rules="all" border="1" style="font-family:Arial Narrow">
        <tr>
            <td>
				<?
                $mcurrency=""; $dcurrency="";
                if($currency_id==1)
                {
                    $mcurrency='Taka';
                    $dcurrency='Paisa';
                }
                if($currency_id==2)
                {
                    $mcurrency='USD';
                    $dcurrency='CENTS';
                }
                if($currency_id==3)
                {
                    $mcurrency='EURO';
                    $dcurrency='CENTS';
                }
                ?>
                <strong>Total Amount (In Words):</strong><? echo number_to_words(def_number_format($grand_total_amount+$other_fab_total,2,""),$mcurrency, $dcurrency);?>
            </td>
        </tr>
    </table>
    <?
	}
	  //=====================================================================Purchase End==============================================================

	$lab_dip_color_arr=array();
	$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
	foreach($lab_dip_color_sql as $row)
	{
		$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
	}
	$order_plan_qty_arr=array();
	$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($po_id_all) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
	foreach($color_wise_wo_sql_qnty as $row)
	{
		$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
		$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
	}

	$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

	$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
	FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
	//echo $collar_cuff_sql;
	$collar_cuff_sql_res=sql_select($collar_cuff_sql);

	foreach($collar_cuff_sql_res as $collar_cuff_row)
	{
		$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
		$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
		$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
		$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
		$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

	}
	//print_r($collar_cuff_percent_arr[40]) ;
	unset($collar_cuff_sql_res);
	//$count_collar_cuff=count($collar_cuff_size_arr);
	foreach($collar_cuff_body_arr as $body_type=>$body_name)
	{
		foreach($body_name as $body_val)
		{
			$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
			$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

			?>
			<div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
			<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
				<tr>
					<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
				</tr>
				<tr>
					<td width="100">Size</td>
						<?
						foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
						{
							?>
							<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
							<?
						}
						?>
					<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
					<td rowspan="2" align="center"><strong>Extra %</strong></td>
				</tr>
				<tr>
					<td style="font-size:12px"><? echo $body_val; ?> Size</td>
					<?
					foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
					{
						if(count($size_number)>0)
						{
							 foreach($size_number  as $item_size=>$val)

							 {
								?>
								<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
								<?
							 }
						}
						else
						{
							?>
							<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
							<?
						}
					}

					$pre_size_total_arr=array();
					foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
					{
						foreach($pre_cost_data as $color_number_id=>$color_number_data)
						{
							foreach($color_number_data as $color_size_sensitive=>$color_break_down)
							{
								$pre_color_total_collar=0;
								$pre_color_total_collar_order_qnty=0;
								$process_loss_method=$process_loss_method;
								$constrast_color_arr=array();
								if($color_size_sensitive==3)
								{
									$constrast_color=explode('__',$color_break_down);
									for($i=0;$i<count($constrast_color);$i++)
									{
										$constrast_color2=explode('_',$constrast_color[$i]);
										$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
									}
								}
								?>
								<tr>
									<td>
										<?
										if( $color_size_sensitive==3)
										{
											echo strtoupper ($constrast_color_arr[$color_number_id]) ;
											$lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
										}
										else
										{
											echo $color_library[$color_number_id];
											$lab_dip_color_id=$color_number_id;
										}
										?>
									</td>
									<?
									foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
									{
										?>
										<td align="center" style="border:1px solid black">
											<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
											if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
											else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
											$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

											$collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
											// echo $collar_ex_per.'=';

											if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
											else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
											$colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
											$collerqty=($plan_cut+$colar_excess_per);

											//$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

											echo number_format($collerqty);
											$pre_size_total_arr[$size_number_id]+=$collerqty;
											$pre_color_total_collar+=$collerqty;
											$pre_color_total_collar_order_qnty+=$plan_cut;

											//$pre_grand_tot_collar_order_qty+=$plan_cut;
											?>
										</td>
										<?
									}
									?>

									<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
									<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
								</tr>
								<?
								$pre_grand_collar_ex_per+=$collar_ex_per;
								$pre_grand_tot_collar+=$pre_color_total_collar;
								$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
							}
						}
					}
					?>
				</tr>
				<tr>
					<td>Size Total</td>
						<?
						foreach($pre_size_total_arr  as $size_qty)
						{
							?>
							<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
							<?
						}
						?>
					<td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
					<td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
				</tr>
			</table>
		</div>
		<br/>
		<?
	}
}
        $sql=sql_select("select id,rmg_process_breakdown from wo_booking_mst where booking_no=$txt_booking_no");
        $bookingId=0;
		$rmg_process_breakdown="";
        foreach($sql as $row){
        	$bookingId= $row[csf('id')];
			$rmg_process_breakdown= $row[csf('rmg_process_breakdown')];
        }
		$rmg_breakdown=explode("_",$rmg_process_breakdown);
		$cut_panel=$rmg_breakdown[8];
		$chest_printing=$rmg_breakdown[2];
		$neck_sleeve=$rmg_breakdown[10];
		$embrodery=$rmg_breakdown[1];
		$sewing_input=$rmg_breakdown[4];
		$garments_wash=$rmg_breakdown[3];
		$gmts_finishing=$rmg_breakdown[15];
		$knitting=$rmg_breakdown[6];
		$yarn_dyeing=$rmg_breakdown[12];
		$dyeing_finishing=$rmg_breakdown[5];
		$aop=$rmg_breakdown[13];
		$lay_wash_fab=$rmg_breakdown[14];
		$dyeing=$rmg_breakdown[7];
		$cutting_fab=$rmg_breakdown[0];
		$others=$rmg_breakdown[9];
  if($rmg_process_breakdown!="")
  {
   ?>
     <br/>
   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr align="center">
        	<td colspan="10"><b>Process Loss% Details</b></td>
        </tr>
        <tr align="center">
			<?
            if($cut_panel)
            {
            ?>
            <td  align="center"> Cut Panel rejection </td>
			<?
            }
			if($chest_printing)
            {
            ?>
            <td  align="center">Chest Printing</td>
            <?
			}
			if($neck_sleeve)
            {
			?>
            <td  align="center">Neck/Sleeve Printing</td>
            <?
			}
			if($embrodery)
            {
			?>
            <td  align="center">Embroidery</td>
             <?
			}
			if($sewing_input)
            {
			?>
            <td  align="center"> Sewing/Input </td>
            <?
			}
			if($garments_wash)
            {
			?>
            <td  align="center"> Garments Wash</td>
            <?
			}
			if($gmts_finishing)
            {
			?>
            <td  align="center"> Gmts Finishing </td>
            <?
			}
			if($knitting)
            {
			?>
            <td  align="center"> Knitting </td>
            <?
			}
			if($yarn_dyeing)
            {
			?>
            <td  align="center"> Yarn Dyeing </td>
            <?
			}
			if($dyeing_finishing)
            {
			?>
            <td  align="center">Dyeing & Finishing </td>
            <?
			}
			if($aop)
            {
			?>
            <td  align="center">All Over Print </td>
            <?
			}
			if($lay_wash_fab)
            {
			?>
            <td  align="center">Lay Wash(Fabric)</td>
            <?
			}
			if($dyeing)
            {
			?>
            <td align="center"> Dyeing </td>
            <?
			}
			if($cutting_fab)
            {
			?>
            <td  align="center">Cutting (Febric)</td>
            <?
			}
			if($others)
            {
			?>
            <td  align="center">Others</td>
            <?
			}
			?>
        </tr>
        <?
      
			?>
			<tr>
                <?
            if($cut_panel)
            {
            ?>
            <td  align="center"> <? echo $cut_panel;?> </td>
			<?
            }
			if($chest_printing)
            {
            ?>
            <td  align="center"><? echo $chest_printing;?></td>
            <?
			}
			if($neck_sleeve)
            {
			?>
            <td  align="center"><? echo $neck_sleeve;?></td>
            <?
			}
			if($embrodery)
            {
			?>
            <td  align="center"><? echo $embrodery;?></td>
             <?
			}
			if($sewing_input)
            {
			?>
            <td  align="center"> <? echo $sewing_input;?> </td>
            <?
			}
			if($garments_wash)
            {
			?>
            <td  align="center"> <? echo $garments_wash;?></td>
            <?
			}
			if($gmts_finishing)
            {
			?>
            <td  align="center"> <? echo $gmts_finishing;?> </td>
            <?
			}
			if($knitting)
            {
			?>
            <td  align="center"> <? echo $knitting;?> </td>
            <?
			}
			if($yarn_dyeing)
            {
			?>
            <td  align="center"> <? echo $yarn_dyeing;?> </td>
            <?
			}
			if($dyeing_finishing)
            {
			?>
            <td  align="center"><? echo $dyeing_finishing;?> </td>
            <?
			}
			if($aop)
            {
			?>
            <td  align="center"><? echo $aop;?> </td>
            <?
			}
			if($lay_wash_fab)
            {
			?>
            <td  align="center"><? echo $lay_wash_fab;?></td>
            <?
			}
			if($dyeing)
            {
			?>
            <td align="center"> <? echo $dyeing;?> </td>
            <?
			}
			if($cutting_fab)
            {
			?>
            <td  align="center"><? echo $cutting_fab;?></td>
            <?
			}
			if($others)
            {
			?>
            <td  align="center"><? echo $others;?></td>
            <?
			}
			?>
                
			</tr>
			<?
        
        ?>
    </table>
    <?
  }
	?>
     <br/>
    <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr align="center">
        	<td colspan="10"><b>Dyes To Match</b></td>
        </tr>
        <tr align="center">
            <td>Sl</td>
            <td>Item</td>
            <td>Body Color</td>
            <td>Item Color</td>
            <td>Finish Qty.</td>
            <td>UOM</td>
        </tr>
        <?
        $lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
        /*$sql=sql_select("select id,rmg_process_breakdown from wo_booking_mst where booking_no=$txt_booking_no");
        $bookingId=0;
        foreach($sql as $row){
        	$bookingId= $row[csf('id')];
			$rmg_process_breakdown= $row[csf('rmg_process_breakdown')];
        }*/

        $select_d=sql_select("SELECT pre_cost_fabric_cost_dtls_id,fabric_color_id FROM wo_booking_dtls WHERE booking_no=$txt_booking_no AND IS_DELETED=0 AND STATUS_ACTIVE=1 GROUP BY pre_cost_fabric_cost_dtls_id,fabric_color_id");
        $pre_cost_id=array();
        $fabric_color_id=array();
        foreach ($select_d as $row) 
        {
        	$pre_cost_id[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
			if($row[csf('fabric_color_id')]>0)
			{
        	$fabric_color_id[$row[csf('fabric_color_id')]]=$row[csf('fabric_color_id')];
			}
        }
       $pre_cost_id_cond= where_con_using_array($pre_cost_id,0,"a.pre_cost_fabric_cost_id");
       $fabric_color_id_cond= where_con_using_array($fabric_color_id,0,"a.fabric_color");
        $co=0;
        $sql_d="select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1 $pre_cost_id_cond $fabric_color_id_cond  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color";
        //echo $sql_d;
        $sql_data=sql_select($sql_d);

        foreach($sql_data  as $row)
        {
			$co++;
			?>
			<tr>
                <td><? echo $co; ?></td>
                <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
                <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
                <td><? echo $color_library[$row[csf('item_color')]];?></td>
                <td align="right"><? echo $row[csf('qty')];?></td>
                <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
			</tr>
			<?
        }
        ?>
    </table>
    <br/>
    <?
    $yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
	// $yarn_rate_arr=return_library_array( "select prod_id,cons_rate from inv_transaction",'prod_id','cons_rate');
    $yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
    ?>
    <table width="100%"  border="0" cellpadding="2" cellspacing="0" style="font-family:Arial Narrow" >
        <tr>
            <td width="49%" style="border:none;" valign="top"><? echo get_spacial_instruction($txt_booking_no,'',118); ?></td>
            <td width="2%"></td>
            <td width="49%" valign="top" align="center">
            <?
			
           $yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty, b.brand, b.lot,b.id as prod_id from inv_material_allocation_dtls a, product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 group by a.item_id, b.brand, b.lot,b.id");

	

            if(count($yarn_sql_array)>0)
            {
                ?>
                <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                        <td colspan="7"><b>Allocated Details</b></td>
                    </tr>
                    <tr align="center">
                        <td>SL</td>
                        <td>Yarn Description</td>
                        <td>Brand</td>
                        <td>Lot</td>
						<?
						if($show_yarn_rate==1){?>
						<td>Yarn Rate</td>
						<?}?>
                        <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
                    $item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
                    $supplier=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
                    $brand_arr=return_library_array( "select id, brand_name from lib_brand",'id','brand_name');
                    $i=0; $total_yarn=0; $total_allo=0;
                    foreach($yarn_sql_array  as $row)
                    {
						$prod_id=$row[csf('prod_id')];
						$yarn_rate_data=sql_select( "SELECT max(c.id) as trans_id,c.prod_id,c.cons_rate
						from inv_material_allocation_dtls a, product_details_master b ,inv_transaction c
						where a.item_id=b.id and b.id=c.prod_id  and a.booking_no=$txt_booking_no and c.prod_id='$prod_id' and a.status_active=1 and a.is_deleted=0 group by c.cons_rate,c.prod_id  order by trans_id desc ");
                        $i++;
                        ?>
                        <tr align="center">
                            <td><? echo $i; ?></td>
                            <td><? echo $item[$row[csf('item_id')]]; ?></td>
                            <td><? echo $brand_arr[$row[csf('brand')]]; ?></td>
							<td><? echo $row[csf('lot')]; ?></td>
							<?if($show_yarn_rate==1){?>
							<td><? echo number_format($yarn_rate_data[0][csf('cons_rate')]/80,2); ?></td>
							<?}?>
                            <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                        </tr>
                        <?
                    }
                    ?>
                    <tr align="center">
                  		<td>Total</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>						
						<td>&nbsp;</td>
						<?if($show_yarn_rate==1){?>
                        <td>&nbsp;</td>
						<?}?>                     
                        <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                </table>
                <?
            }
            else
            {
                $is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
                if($is_yarn_allocated==1)
                {
                    ?><font style=" font-size:30px"><b>Allocation Not Found.</b></font><?
                }
                else
                {
                    ?><font style=" font-size:30px"><b> Draft</b></font><?
                }
            }
            ?>
            </td>
        </tr>
    </table>
    <br/>
	<?
    $bookingData=sql_select("select booking_percent,item_category from  wo_booking_mst where booking_no=$txt_booking_no");
    $booking_percent=$bookingData[0][csf('booking_percent')];
    $item_category=$bookingData[0][csf('item_category')];
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name"  );
    $condition= new condition();
    if(str_replace("'","",$txt_order_no_id) !=''){
        $ord=str_replace("'","",$txt_order_no_id);
        $condition->po_id("in($ord)");
    }
    $condition->init();
    $fabric= new fabric($condition);
	$fab_data_array=$fabric->getQtyArray_by_CountryCutupdateAndGmtsColor_knitAndwoven_greyAndfinish();
    // $fab_data_array=$fabric->getQtyArray_by_CountryAndCutupdate_knitAndwoven_greyAndfinish();
// 	echo "<pre>";
// print_r($fab_data_array);
    $cutoffData=array();
    $cutupQty=array();

    $sql_c=sql_select("select po_break_down_id,cutup_date,country_id, order_quantity as order_quantity,color_number_id from wo_po_color_size_breakdown where po_break_down_id  in(".str_replace("'","",$txt_order_no_id).") and status_active=1 and is_deleted=0 order by cutup_date asc");
    foreach($sql_c as $row){
        $cutoffData[$row[csf('cutup_date')]]['country'][$row[csf('country_id')]]=$country_arr[$row[csf('country_id')]];
        // $cutoffData[$row[csf('cutup_date')]]['poQty'][$row[csf('country_id')]]+=$row[csf('order_quantity')];
		$cutoffData[$row[csf('cutup_date')]]['poQty'][$row[csf('country_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
		$order_qty_arr[$row[csf('cutup_date')]][$row[csf('country_id')]][$row[csf('color_number_id')]]['order_qty']+=$row[csf('order_quantity')];
    }
	//  echo "<pre>";
	//  print_r($order_qty_arr);
    ?>
    <table  width="100%"  border="0" cellpadding="0" cellspacing="2" style="font-family:Arial Narrow" >
        <tr>
            <td width="49%" valign="top">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <caption> <strong style="float:left"> CutOff Details</strong></caption>
                    <tr align="center">
                        <td style="">Del. Date</td>
                        <td>Country</td>
						<td>Color</td>
                        <td>Gmt Qty (Pcs)</td>
                        <td>KG</td>
                        <td>YDS</td>
                        <td>PCS</td>
                        <td>MTR</td>
                    </tr>
                    <?
                    $tot=0;
				
					$county_date_wise_arr=array();
					foreach($cutoffData  as $cutup_date=>$value){
						foreach($value['poQty']  as $country_id=>$countrydata){
						  foreach($countrydata  as $color_id=>$colordata){
							$i++;
							$fabReqQtyKg=0; $fabReqQtyYds=0; $fabReqQtyPcs=0; $fabReqQtyMtr=0;
							foreach($value['country'] as $countryId=>$countryValue)
								{
									if($item_category==2){
										$fabReqQtyKg+=$fab_data_array['knit']['finish'][$countryId][$cutup_date][$color_id][12];
										$fabReqQtyYds+=$fab_data_array['knit']['finish'][$countryId][$cutup_date][$color_id][27];
										$fabReqQtyPcs+=$fab_data_array['knit']['finish'][$countryId][$cutup_date][$color_id][1];
										$fabReqQtyMtr+=$fab_data_array['knit']['finish'][$countryId][$cutup_date][$color_id][23];
									}
									if($item_category==3){
										$fabReqQtyKg+=$fab_data_array['woven']['finish'][$countryId][$cutup_date][$color_id][12];
										$fabReqQtyYds+=$fab_data_array['woven']['finish'][$countryId][$cutup_date][$color_id][27];
										$fabReqQtyPcs+=$fab_data_array['woven']['finish'][$countryId][$cutup_date][$color_id][1];
										$fabReqQtyMtr+=$fab_data_array['woven']['finish'][$countryId][$cutup_date][$color_id][23];
									}
								}
							$val=implode(",",$value['country']);
							$county_date_wise_arr[$cutup_date]=implode(",",$value['country']);
							$color_date_wise_arr[$cutup_date][$val][$color_id]['color'] +=$colordata;
							$color_date_wise_arr[$cutup_date][$val][$color_id]['kg'] =$fabReqQtyKg;
							$color_date_wise_arr[$cutup_date][$val][$color_id]['yds'] =$fabReqQtyYds;
							$color_date_wise_arr[$cutup_date][$val][$color_id]['pcs'] =$fabReqQtyPcs;
							$color_date_wise_arr[$cutup_date][$val][$color_id]['mtr'] =$fabReqQtyMtr;

						  }
						}
					}
			
					    //  echo "<pre>";
						//   print_r($color_date_wise_arr);
						
                    foreach($color_date_wise_arr  as $cutup_date=>$cutup_data){
					  foreach($cutup_data  as $country_id=>$countrydata){
						$rowspan=count($color_date_wise_arr[$cutup_date][$country_id]);
						$i=0;
						foreach($countrydata  as $color_id=>$value){
						?>
						<tr align="center">
                            <td><? echo $cutup_date; ?></td>
							<?
							if($i==0){?>
                            <td align="left" rowspan="<?echo $rowspan;?>"><? echo $country_id;?></td>
							<?$i++;}?>

							<td align="left"><? echo $color_library[$color_id];?></td>
                            <td align="right"><? echo $value['color'];?></td>
                            <td align="right"><? echo number_format(($value['kg']*$booking_percent)/100,4);?></td>
                            <td align="right"><? echo number_format(($value['yds']*$booking_percent)/100,4);?></td>
                            <td align="right"><? echo number_format(($value['pcs']*$booking_percent)/100,4);?></td>
                            <td align="right"><? echo number_format(($value['mtr']*$booking_percent)/100,4);?></td>
						</tr>
						<?
						$po_qty+=$value['color'];
						$kg_qty+=($value['kg']*$booking_percent)/100;
						$yds_qty+=($value['yds']*$booking_percent)/100;
						$pcs_qty+=($value['pcs']*$booking_percent)/100;
						$mtr_qty+=($value['mtr']*$booking_percent)/100;

                     	  }
					  
						}?>
						<tr align="center">
							<td align="right" colspan="3"><b>Delivery & Country Total</b></td>
                            <td align="right"><b><? echo $po_qty;?></b></td>
                            <td align="right"><b><? echo $kg_qty;?></b></td>
                            <td align="right"><b><? echo $yds_qty;?></b></td>
                            <td align="right"><b><? echo $pcs_qty;?></b></td>
                            <td align="right"><b><? echo $mtr_qty;?></b></td>
						</tr>
			    	<?
					$po_qty=0;$kg_qty=0;$yds_qty=0;	$pcs_qty=0;	$mtr_qty=0;
				}
                    ?>
                </table>
            </td>
        	<td width="2%"></td>
            <td width="49%" valign="top">
            <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
            <caption> <strong style="float:left"> Stripe Details</strong></caption>
                <?
                $color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
                $sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.stripe_color,d.id as did,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,d.id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,b.dia_width order by d.id");
                $result_data=sql_select($sql_stripe);
                foreach($result_data as $row){
                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
                    $stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
                    $stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
                }
                ?>
                <tr>
                    <th width="30"> SL</th>
                    <th width="100"> Body Part</th>
                    <th width="80"> Fabric Color</th>
                    <th width="70"> Fabric Qty(KG)</th>
                    <th width="70"> Stripe Color</th>
                    <th width="70"> Stripe Measurement</th>
                    <th width="70"> Qty.(KG)</th>
                    <th width="70"> Y/D Req.</th>
                </tr>
                <?
                $i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
                foreach($stripe_arr as $body_id=>$body_data)
                {
                    foreach($body_data as $color_id=>$color_val)
                    {
                        $rowspan=count($color_val['stripe_color']);
                        $composition=$stripe_arr2[$body_id][$color_id]['composition'];
                        $construction=$stripe_arr2[$body_id][$color_id]['construction'];
                        $gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
                        $color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
                        $dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

                        $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                        WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id='".$body_id."' and a.color_type_id='".$color_type_id."' and a.construction='".$construction."' and a.composition='".$composition."' and a.gsm_weight='".$gsm_weight."' and nvl(d.fabric_color_id,0)=nvl('".$color_id."',0) and d.status_active=1 and d.is_deleted=0 ");
                        list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
                        ?>
                        <tr>
                            <?
                            $color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                            ?>
                            <td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
                            <td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
                            <td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
                            <td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
                            <?
                                $total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                                foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
                                {
                                    $measurement=$color_val['measurement'][$strip_color_id];
                                    $fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
                                    $yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
                                    ?>
                                    <td><?  echo  $color_name_arr[$s_color_val]; ?></td>
                                    <td align="right"> <? echo  number_format($measurement,2); ?></td>
                                    <td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
                                    <td> <? echo  $yes_no[$yarn_dyed]; ?></td>
                                </tr>
                                <?
                                $total_fabreqtotkg+=$fabreqtotkg;
                            }
                            $i++;
                        }
                    }
                ?>
                <tfoot>
                    <tr>
                        <td colspan="3">Total </td>
                        <td align="right"><? echo  number_format($total_fab_qty,2); ?> </td>
                        <td></td>
                        <td></td>
                        <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </td>
        </tr>
    </table>
    <br>
    <?
    //echo signature_table(1, $cbo_company_name, "1330px");
    $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
    $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
    ?>
    <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
        <thead>
        <tr style="border:1px solid black;">
            <th colspan="3" style="border:1px solid black;">Approval Status</th>
            </tr>
            <tr style="border:1px solid black;">
            <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
            </tr>
        </thead>
        <tbody>
        <?
        $i=1;
        foreach($data_array as $row)
        {
            ?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                <td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td>
                <td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); ?></td>
                <td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
            </tr>
            <?
            $i++;
        }
        ?>
        </tbody>
    </table>
    <br>
    <fieldset id="div_size_color_matrix" style="max-width:1000;">
    <legend>TNA Information</legend>
    <table width="100%" style="border:1px solid black; font-size:16px;font-family:Arial Narrow" cellpadding="2" cellspacing="0" rules="all">
        <tr>
            <td rowspan="2" align="center" valign="top">SL</td>
            <td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
            <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
            <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
            <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
            <td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
            <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
            <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
            <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
        </tr>
        <tr>
            <td width="85" align="center" valign="top"><b>Start Date</b></td>
            <td width="85" align="center" valign="top"><b>End Date</b></td>
            <td width="85" align="center" valign="top"><b>Start Date</b></td>
            <td width="85" align="center" valign="top"><b>End Date</b></td>
            <td width="85" align="center" valign="top"><b>Start Date</b></td>
            <td width="85" align="center" valign="top"><b>End Date</b></td>
            <td width="85" align="center" valign="top"><b>Start Date</b></td>
            <td width="85" align="center" valign="top"><b>End Date</b></td>
            <td width="85" align="center" valign="top"><b>Start Date</b></td>
            <td width="85" align="center" valign="top"><b>End Date</b></td>
            <td width="85" align="center" valign="top"><b>Start Date</b></td>
            <td width="85" align="center" valign="top"><b>End Date</b></td>
            <td width="85" align="center" valign="top"><b>Start Date</b></td>
            <td width="85" align="center" valign="top"><b>End Date</b></td>
        </tr>
        <?
        $i=1;
        foreach($tna_date_task_arr as $order_id=>$row)
        {
            ?>
            <tr>
                <td><? echo $i; ?></td>
                <td><? echo $po_num_arr[$order_id]; ?></td>
                <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                <td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
            </tr>
            <?
            $i++;
        }
        ?>
    </table>
    </fieldset>
    <?
    $sql = sql_select("select designation,name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
    $count=count($sql);

    $width=1330;
    $td_width=floor($width/$count);

    $standard_width=$count*150;

    if($standard_width>$width) $td_width=150;

    $no_coloumn_per_tr=floor($width/$td_width);
    $col=$count-2;
    $i=1;
    echo '<table width="'.$width.'" style="font-family:Arial Narrow"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom"></td></tr><tr>';
    foreach($sql as $row)
    {
        echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';
        if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
        $i++;
    }
    echo '</tr></table>';
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/	



	$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
	$mail_sql_res=sql_select($sql);
	
	$mailArr=array();
	foreach($mail_sql_res as $row)
	{
		$mailArr[$row[EMAIL]]=$row[EMAIL]; 
	}

	
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");


		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_knit")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');

	$po_arr= sql_select("select a.job_no, a.product_dept, a.total_set_qnty, b.id, b.po_number, MIN(b.po_received_date) as po_received_date, b.pub_shipment_date, b.grouping, sum(b.plan_cut) as plan_cut, sum(b.po_quantity) as po_quantity from wo_po_details_master a,wo_po_break_down b
	 where a.job_no=b.job_no_mst and b.status_active=1 and b.id in(".str_replace("'","",$txt_order_no_id).") group by a.job_no, a.total_set_qnty, a.product_dept, b.id, b.po_number, b.pub_shipment_date, b.grouping");
	$po_qnty_tot1=$po_qnty_tot=$tot_po_qnty_tot_pcs=0;
	$internal_ref_no="";
	foreach($po_arr as $row)
	{
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$po_qnty_tot+=$row[csf('po_quantity')];
		$tot_po_qnty_tot_pcs+=$row[csf('po_quantity')]*$row[csf('total_set_qnty')];
		if($internal_ref_no=="") $internal_ref_no=$row[csf('grouping')];else $internal_ref_no.=",".$row[csf('grouping')];
		$intRef[$row[csf('grouping')]]=$row[csf('grouping')];
		$po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
		$prod_dept=$product_dept[$row[csf('product_dept')]];
		$job_no_aarr.=$row[csf('job_no')].',';

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	$job_numbers=implode(",",array_unique(explode(",",$job_nos)));

	$revised_no = return_field_value("revised_no", "wo_booking_mst", "booking_no=$txt_booking_no");

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	//$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;

	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$path = str_replace("'", "", $path);
	if ($path == "") $path = '../../';

ob_start();		
		
		?>									<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
							echo $company_library[$cbo_company_name];
							?>
                            </td>
                            <td rowspan="3" width="250">
                               <span style="font-size:20px"><b> Job No:&nbsp;&nbsp;<?
							    $jobnos=trim($job_numbers);
							   $jobnos=implode(",",array_unique(explode(",",$jobnos)));
							   echo $jobnos; ?></b></span><br>
							   <span style="font-size:20px"><b> Internal Ref.:&nbsp;&nbsp;<?
							   $ref_no=trim($internal_ref_no,"'");
							   $ref_nos=implode(", ",array_unique(explode(",",$ref_no)));
							    echo $ref_nos; ?></b></span><br>
                                <?
								if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								?>
                                 <span style="font-size:20px"><b>Revised No.:&nbsp;<?
							   	 echo $nameArray_approved_row[csf('approved_no')]; ?></b></span>
                                <?
								}
								?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                          $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						   if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no"); else $location=""; ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? echo $report_title;?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $style_ref_no=""; $inserted_by=""; $currency_id="";
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.fabric_composition,a.revised_no,a.remarks,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.currency_id,a.pay_mode,a.booking_percent,a.rmg_process_breakdown,a.insert_date,a.inserted_by,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.order_repeat_no from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				$po_id_all=$nameArray[0][csf('po_break_down_id')];

				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$inserted_by=$result[csf('inserted_by')];
					$currency_id=$result[csf('currency_id')];
					$booking_percent=$result[csf('booking_percent')];

					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time[$row_lead_time[csf('date_diff')]]=$row_lead_time[csf('date_diff')];
					}

				  $gmts_item=explode(',',$result[csf('gmts_item_id')]);
				  foreach($gmts_item as $gm_item)
				  {
				  	$gm_item_name.=$garments_item[$gm_item].',';
				  }

				?>
                <table width="100%" style="border:1px solid black; margin-top:1px;font-family:Arial Narrow; font-size:16px" >
                <tr>
                <td colspan="5" valign="top" style="font-size:16px; color:#F00">
				<?
				if($result[csf('is_apply_last_update')]==2){
					echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]];
				}
				else{
					echo "";
				}
				?>
                </td>
                </tr>
                <tr>
                <td width="120"><span style="font-size:16px"><b>Buyer/Agent Name</b></span></td>
                <td width="225">:&nbsp;<span style="font-size:16px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="120" style="font-size:16px"><b>Dept. </b>   </td>
                <td width="225" style="font-size:16px">:<b><? echo  $prod_dept; ?></b></td>
                </tr>
                <tr>
                 <td width="120" style="font-size:16px"><b>Order Qnty </b>   </td>
                <td width="225" style="font-size:16px">:<b><? echo  $tot_po_qnty_tot_pcs;?>&nbsp;Pcs</b></td>

                <td width="" style="font-size:16px"><b>Garments Item</b>   </td>
                <td width="" style="font-size:16px">: <b><? echo rtrim($gm_item_name,','); ?></b></td>
                </tr>
                <tr>
				<td width="" style="font-size:16px"><b>Style Ref.</b></td>
                <td width="">:
                <? echo $result[csf('style_ref_no')];
               $style_ref_no=$result[csf('style_ref_no')]; ?>
                </td>
               <td  width="" style="font-size:16px"><b>Style Des.</b></td>
                <td  width="" >:<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                </tr>
                <tr>
                  <td width="" style="font-size:16px"><b>BookingRelease Date</b></td>
                <td width="">:
                <?
                $booking_date=$result[csf('update_date')];
                if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
                $booking_date=$result[csf('insert_date')];
                }
                echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                ?>
                </td>

                <td  width="" style="font-size:16px"><b>Po Received Date</b></td>
                <td  width="" >:<? echo $po_received_date; ?></td>
                </tr>
                <tr>
                <td  width="" style="font-size:16px"><b>Dealing Merchant</b></td>
                <td  width="" >:<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
                <td width="" style="font-size:16px"><b>Supplier Name</b></td>
                <td width="">
				:<? //echo $marchentrArr[$result[csf('dealing_marchant')]]; ?>
                <?
                if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]]; else echo $supplier_name_arr[$result[csf('supplier_id')]];
                ?>
                </td>
                </tr>
                <tr>
                <td width="" style="font-size:16px"><b>Delivery Date</b>   </td>
                <td width="">:<?  echo change_date_format($result[csf('delivery_date')]);//?> </td>
				<td width="" style="font-size:16px"><b>Booking No </b>   </td>
                <td width="">:<b><?  echo $result[csf('booking_no')];?><? echo "(".$fabric_source[$result[csf('fabric_source')]].")";?></b> </td>
                </tr>
                <tr>
                <td width="" style="font-size:16px"><b>Season</b></td>
                <td width="">:<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td width="" style="font-size:16px"><b>Attention</b></td>
                <td width="">:<? echo $result[csf('attention')]; ?></td>
                </tr>
                <tr>
                 <td width="" style="font-size:16px"><b>Lead Time </b></td>
               	 <td width="">:<? echo implode(",",$lead_time); ?></td>
                </tr>
                </table>
           <?
			}

			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
             <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown </legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>PO Number</strong></td>
                        <td style="border:1px solid black"><strong>Ship Date</strong></td>
                        <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
					$order_id=explode(",",str_replace("'","",$txt_order_no_id));
					for($or=0;$or<count($order_id); $or++)
				    {
						for($c=0;$c<count($gmts_item); $c++)
					    {
							$item_size_tatal=array(); $item_size_tatal_order=array();
							$item_grand_total=0; $item_grand_total_order=0;
							$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
							?>
		                    <?
							foreach($nameArray_color as $result_color)
		                    {
		                    ?>
		                    <tr>
		                        <td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
		                         <td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
		                          <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
		                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
		                        <?
								$color_total=0; $color_total_order=0;

								foreach($nameArray_size  as $result_size)
								{
								$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
								foreach($nameArray_color_size_qnty as $result_color_size_qnty)
		                        {

		                        ?>
		                            <td style="border:1px solid black; text-align:right">
									<?
										if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
										{
											 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
											 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
											 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
											 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
										     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
											 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
											 {
													$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
											 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
											 {
													$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
										}
										else echo "0";
									 ?>
									</td>
		                    <?
								}
		                        }
		                        ?>
		                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
		                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
		                         <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
		                    </tr>
		                    <?
		                    }
							?>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
		                        <?
								foreach($nameArray_size  as $result_size)
		                        {
		                        ?>
		                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
		                        <?
		                        }
		                        ?>
		                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
		                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
		                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
		                    </tr>
		                    <?
						}
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
             </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
            	<?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
					?>
					<tr>
                        <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?> </td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
					?>
					<tr>
                        <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                        <td align="right"><?  echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
					?>
					<tr>
                        <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
					?>
					<tr>
                        <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                        <td align="right"><?  echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
					?>
					<tr>
                        <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
					?>
					<tr>
                        <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
					?>
					<tr>
                        <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
					?>
					<tr>
                        <td width="130">Others <!-- New breack Down 11--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
					</tr>
					<?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Sub Total <!-- New breack Down 11--></td>
                        <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
					</tr>
					<?
				}
				?>
                </table>
                </fieldset>
                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
					?>
					<tr>
                        <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
					?>
					<tr>
                        <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
					?>
					<tr>
                        <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
					?>
					<tr>
                        <td width="130">All Over Print <!-- new  breack Down 13--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
					?>
					<tr>
                        <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
					?>
					<tr>
                        <td width="130">Dying   <!-- breack Down 7--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
					?>
					<tr>
                        <td width="130"> Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
					?>
					<tr>
                        <td width="130">Others  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
					</tr>
					<?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
					</tr>
					<?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
					</tr>
					<?
				}
				?>
           </table>
         	  </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in('$job_nos') and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
					?>
					<td><img src="../../<? echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td>
					<?
					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
      <br/>
       <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	 </style>
     <?
	 $costing_per=""; $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
	 if($costing_per_id==1)
	{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;
	}
	if($costing_per_id==2)
	{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;
	}
	if($costing_per_id==3)
	{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;
	}
	if($costing_per_id==4)
	{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;
	}
	if($costing_per_id==5)
	{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	$nameArray_fabric_description= sql_select("select a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, b.remarks, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, b.remarks order by a.body_part_id, b.dia_width");
	?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="5" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else  echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total  Finish Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
        <td  rowspan="10" width="50"><p>Total Grey Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
        <td  rowspan="10" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="5" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else  echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="5" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>
       </tr>

        <tr align="center"><th   colspan="5" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if($result_fabric_description[csf('composition')]=="") echo "<td colspan='2' >&nbsp</td>"; else  echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>
       </tr>
       <tr align="center"><th  colspan="5" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')]== "") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>
       </tr>
       <tr align="center"><th  colspan="5" align="left">Stitch Length</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			$determin_id=$result_fabric_description[csf('determin_id')];
			$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
			if( $result_fabric_description[csf('determin_id')] == "") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>". $s_length."</td>";
		}
		?>
       </tr>
       <tr align="center"><th   colspan="5" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>
       </tr>
       <tr align="center"><th   colspan="5" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'> Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
		}
		?>
       </tr>
       <tr align="center"><th colspan="5" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')]== "")   echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>
       </tr>
       <tr>
       		<th colspan="<? echo  count($nameArray_fabric_description)*2+5; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>
       <tr>
            <th  width="120" align="left">PO Number</th>
            <th  width="120" align="left">Ship Date</th>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
		}
		?>
       </tr>
       <?
		  $gmt_color_library=array(); 
		  $gmt_color_data=sql_select("select gmts_color_id, contrast_color_id FROM  wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_nos' and status_active=1");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	      $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
		$color_wise_wo_sql=sql_select("select a.fabric_color_id, a.po_break_down_id,listagg(cast(b.color_size_sensitive as varchar2(4000)),',') within group (order by b.color_size_sensitive) AS color_size_sensitive FROM wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b WHERE   a.job_no = b.job_no and a.pre_cost_fabric_cost_dtls_id = b.id and a.booking_no =$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active = 1 and b.is_deleted = 0 group by a.po_break_down_id,a.fabric_color_id order by a.po_break_down_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$bodyColor='';
	    	$pre_cost_fabric_cost_dtls_id_arr=array_unique(explode(",", $color_wise_wo_result[csf('color_size_sensitive')]));
	    	$as_per_garments=0;
	    	foreach ($pre_cost_fabric_cost_dtls_id_arr as $value) 
	    	{
	    		if($value==3)
	    		{
	    			if(!empty($bodyColor))
	    			{
	    				$bodyColor=$bodyColor.",";
	    			}
	    			$bodyColor.=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	    		}
	    		else if($value==1)
	    		{
	    			$as_per_garments=1;
	    		}
	    		
	    	}
	    	
			//$bodyColor=implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			if($bodyColor=="")
			{
				$bodyColor=$color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			} 
			else if($as_per_garments==1){
				if(!empty($bodyColor))
    			{
    				$bodyColor=$bodyColor.",";
    			}
				$bodyColor.=$color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			}
			$bodyColor=implode(",", array_filter(explode(",", $bodyColor)));
		?>
			<tr>
          <td width="120" align="left"><? echo $po_number_arr[$color_wise_wo_result[csf('po_break_down_id')]]; ?></td>
            <td width="120" align="left"><? echo change_date_format($po_ship_date_arr[$color_wise_wo_result[csf('po_break_down_id')]],"dd-mm-yyyy","-"); ?></td>
            <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
            <td><?=$bodyColor; ?></td>
            <td width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_nos."' and status_active=1 and is_deleted=0 and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0; $total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				b.po_break_down_id=".$color_wise_wo_result[csf('po_break_down_id')]." and
				d.status_active=1 and
				d.is_deleted=0 and
				c.status_active=1 and
				c.is_deleted=0 and
				a.status_active=1 and
				a.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				b.remarks='".$result_fabric_description[csf('remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				b.po_break_down_id=".$color_wise_wo_result[csf('po_break_down_id')]." and
				d.status_active=1 and
				d.is_deleted=0 and
				c.status_active=1 and
				c.is_deleted=0 and
				a.status_active=1 and
				a.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
            <td align="right">
            <?
			if($process_loss_method==1) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			if($process_loss_method==2) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			echo number_format($process_percent,2);
			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0 and
												c.status_active=1 and
												c.is_deleted=0 and
												a.status_active=1 and
												a.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1) $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;// markup
			if($process_loss_method==2) $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;//margin

			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
          <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												b.remarks='".$result_fabric_description[csf('remarks')]."' and
												d.status_active=1 and
												d.is_deleted=0  and
												c.status_active=1 and
												c.is_deleted=0 and
												a.status_active=1 and
												a.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'></td><td width='50' align='right' ></td>
            <?
			}
			?>
            <td align="right"><? echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			if($process_loss_method==2) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
      <br/>
     <?
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_nos' and status_active=1");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($po_id_all) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)

									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
   ?>
        <br/>

	<table style="margin-top: 10px;" class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<tr>
	<td valign="top">

	<?
 		$condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.job_no,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.job_no,a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");

			?>
		   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
						?> <td>Rate</td><?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {
						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$row[csf("job_no")]],4);//echo number_format($row[csf('yarn_required')],4); ?></td>
                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>

      </td>
       <td>
       <table  width="100%" style="margin: 0px;padding: 0px;">
        <?php $stripe_color_wise=array(); ?>
       
        <tr>
        	<td width="70%" style="float: left;">
        		<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >
        		       
        		        <tr>
        		            <td align="center" colspan="9">  Stripe Details</td>
        		            
    		            </tr>
        		        <?
        				$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
        				$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,(d.fabreqtotkg) as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.measurement,d.uom,c.composition,c.construction,b.dia_width,d.fabreqtotkg order by d.id "); 
        				//echo $sql_stripe;       				
        				$result_data=sql_select($sql_stripe);
        				foreach($result_data as $row)
        				{
        					//$index=$row[csf('body_part_id')]."***".$row[csf('id')];
        					$index=$row[csf('body_part_id')]."***".$row[csf('id')];
        					
        					$stripe_arr[$index][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
        					$stripe_arr[$index][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
        					$stripe_arr[$index][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
        					$stripe_arr[$index][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
        					$stripe_arr[$index][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

        					$stripe_arr2[$index][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
        					$stripe_arr2[$index][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
        					$stripe_arr2[$index][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
        					$stripe_arr2[$index][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
        					$stripe_arr2[$index][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
        				}
        				?>
        		            <tr>
	        		            <td align="center" width="30"> SL</td>
	        		            <td align="center" width="100"> Body Part</td>
	        		            <td align="center" width="80"> Fabric Color</td>
	        		            <td align="center" width="70"> Fabric Qty(KG)</td>
	        		            <td align="center" width="70"> Stripe Color</td>
	        		            <td align="center" width="70"> Stripe Measurement</td>
	        		            <td align="center" width="70"> Stripe Uom</td>
	        		            <td  align="center" width="70"> Qty.(KG)</td>
	        		            <td  align="center" width="70"> Y/D Req.</td>
        		            </tr>
        		            <?
        					//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        					//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
        						//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


        					$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
        		            foreach($stripe_arr as $index=>$body_data)
        		            {
        		            	$expld=explode("***", $index);
        		            	$body_id=$expld[0];
        						foreach($body_data as $color_id=>$color_val)
        						{
        							$rowspan=count($color_val['stripe_color']);
        							$composition=$stripe_arr2[$index][$color_id]['composition'];
        							$construction=$stripe_arr2[$index][$color_id]['construction'];
        							$gsm_weight=$stripe_arr2[$index][$color_id]['gsm_weight'];
        							$color_type_id=$stripe_arr2[$index][$color_id]['color_type_id'];
        							$dia_width=$stripe_arr2[$index][$color_id]['dia_width'];

        							/*if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        							else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";*/
									if($db_type==0) $color_cond="d.gmts_color_id='".$color_id."'";
        							else if($db_type==2) $color_cond="nvl(d.gmts_color_id,0)=nvl('".$color_id."',0)";

        							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
        								WHERE a.job_no=b.job_no and
        								a.id=b.pre_cost_fabric_cost_dtls_id and
        								c.job_no_mst=a.job_no and
        								c.id=b.color_size_table_id and
        								b.po_break_down_id=d.po_break_down_id and
        								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
        								d.booking_no =$txt_booking_no and
        								a.body_part_id='".$body_id."' and
        								a.color_type_id='".$color_type_id."' and
        								a.construction='".$construction."' and
        								a.composition='".$composition."' and
        								a.gsm_weight='".$gsm_weight."' and
        								$color_cond and
        								d.status_active=1 and
        								d.is_deleted=0
        								");
        						
        								list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
        							?>
        							<tr>
	        							<?
	        							$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	        							?>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
	        							<td title="composition=<?=$composition;?> , construction=<?=$construction;?> , gsm weight=<?=$gsm_weight;?> , color_type_id=<?=$color_type_id;?> " rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
	        							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
	        							<?
	        							$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	        							$sk=0;
	        							foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
	        							{

	        								$measurement=$color_val['measurement'][$strip_color_id];
	        								$uom=$color_val['uom'][$strip_color_id];
	        								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
	        								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
	        								if($sk>0)
	        								{
	        									echo "<tr>";
	        								}
	        								?>
	        							
		        								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
		        								<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
		        		                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
		        								<td align="right"> <? echo  number_format($fabreqtotkg,2); ?> &nbsp;</td>
		        								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
	        								
	        								<?
	        								if($sk>0)
	        								{
	        									echo "</tr>";
	        								}
	        								$sk++;
	        								$total_fabreqtotkg+=$fabreqtotkg;
	        								$stripe_color_wise[$color_name_arr[$s_color_val]]+=$fabreqtotkg;
	        							}
	        							$i++;
	        							?>
        							</tr>
        							<?
        						}
        					}
        					?>
	        		            <tfoot>
		        		            <tr>
			        		            <td colspan="3">Total </td>
			        		            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
			        		            <td></td>
			        		            <td></td>
			        		            <td>   </td>
			        		            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
			        		        </tr>
	        		            </tfoot>
        		            </table>
        	</td>
        	
        	<td width="20%" style="float: right;">
        		        <table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;"  >
        		       

        		        <tr>
        		            <td align="left" colspan="3"> Stripe  Color wise Summary</td>
        		            
        		           
        		           
    		            </tr>
        		        <?
        				
        				?>
        		            <tr>
	        		            <td width="30"> SL</td>
	        		            
	        		            <td width="70"> Stripe Color</td>
	        		           
	        		            <td  width="70"> Qty.(KG)</td>
	        		           
        		            </tr>
        		            <?
        					//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        					//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
        						//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


        					$i=1;$total_stripe_qnt=0;        		            
        						foreach($stripe_color_wise as $color=>$val)
        						{
        							
        							
        							?>
        							<tr>
	        							<td> <? echo $i; ?></td>
	        							
	        							<td > <? echo $color; ?></td>
	        							<td align="right"> <?php echo number_format($val,2); ?></td>
	        						</tr>
        							
        							<?
        							$total_stripe_qnt+=$val;
        							
        							$i++;
        						}
        					
        					?>
        		            <tfoot>
        		            <tr>
        		            
        		            <td></td>
        		            <td></td>
        		            
        		            <td align="right"><? echo  number_format($total_stripe_qnt,2); ?> </td>
        		            </tr>
        		            </tfoot>
        		            </table>
        	</td>
        </tr>
         </table >

            </td>
          </tr>
          <tr>
          <td colspan="2">
          <?
          $sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	if(count($data_array)>0)
	{
		  ?>
          <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:550px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="50">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
          </div>
          <?
        }
          ?>
          </td>
          </tr>
        </table>
	</table>
			<br>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                 <tr>
                 <td>
                 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

                   <tr align="center">
                    <td colspan="10"><b>Dyes To Match</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Item</td>
                    <td>Body Color</td>
                    <td>Item Color</td>
                    <td>Finish Qty.</td>
                    <td>UOM</td>
                    </tr>
                    <?
					$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
		$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
		$bookingId=0;
		foreach($sql as $row){
			$bookingId= $row[csf('id')];
		}
					$co=0;
					$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color");

					foreach($sql_data  as $row)
                    {
					$co++;
					?>
                    <tr>
                    <td><? echo $co; ?></td>
                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
                    <td align="right"><? echo $row[csf('qty')];?></td>
                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
                    </tr>
                    <?
					}
					?>
                    </table>
                    </td>
                    <td>
                  <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {
						$i++;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td><? echo $item[$row[csf('item_id')]]; ?></td>
                            <td><? echo $supplier[$row[csf('supplier_id')]]; ?></td>
                            <td><? echo $row[csf('lot')]; ?></td>
                            <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
						</tr>
						<?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else echo "";
				}
					?>
                    </td>
                    </tr>
                 </table>
        <br/>
        <?
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_nos' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
		?>
        <br/>
        <br>

		<?
		 $lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
		 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
		 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
	//echo $mst_id.'ssD';
	//and b.un_approved_date is null
	 $approve_data_array=sql_select("select b.approved_by,min(b.approved_date) as approved_date from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  group by  b.approved_by order by b.sequence_no asc");


	 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");



     if(count($approve_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="40%" style="border:1px solid black;">Name</th>
				<th width="30%" style="border:1px solid black;">Designation</th>
				<th width="27%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
		<br>
		<?
		if(count($unapprove_data_array)>0)
		{
		$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
			$unapproved_request_arr=array();
			foreach($sql_unapproved as $rowu)
			{
				$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
			}
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($unapprove_data_array as $row){

			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<td width="20%" style="border:1px solid black;"><? echo '';?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
            </tr>
                <?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if($un_approved_date!="")
				{
				?>
			<tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
              </tr>

                <?
				$i++;
				}

			}
				?>
            </tbody>
        </table>
		<?
		}

      //Not used
        $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
        $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
        ?>
       <br> <br>
        <table  width="100%" class="rpt_table" style="display:none"   border="1" cellpadding="0" cellspacing="0" rules="all">
        	<tr>
            <td>
            <table  width="95%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <tr>
            <td>
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
            $i=1;
            foreach($data_array as $row){
            ?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
                $i++;
            }
                ?>
            </tbody>
        	</table>
            </td>
            <td>
            	 <table  width="96%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                 <?
                 $nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
				 $nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
				 ?>
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>
                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>
            </td>
            </tr>
        </table>
		  <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
			$costing_per=0;
            if($result[csf("costing_per")]==1) $costing_per=12;
			else if($result[csf("costing_per")]==2) $costing_per=1;
			else if($result[csf("costing_per")]==3) $costing_per=24;
			else if($result[csf("costing_per")]==4) $costing_per=36;
			else if($result[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;

			$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/($costing_per*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");

			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0; $total_booking_qnty_main=0; $total_booking_qnty_short=0; $total_booking_qnty_sample=0; $total_tot_bok_qty=0; $tot_balance=0;

					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td><? if( $balance>0) echo "Less Booking"; else if ($balance<0) echo "Over Booking"; else echo ""; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                </td>

            </tr>
        </table>
         <br>
         <?
		 $sql = sql_select("select designation,name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
	     $count=count($sql);
		$width=1330;
		$td_width=floor($width/$count);
		$standard_width=$count*150;
		if($standard_width>$width) $td_width=150;
		$no_coloumn_per_tr=floor($width/$td_width);
		$col=$count-2;
		$i=1;
		echo '<table width="'.$width.'" style="font-family:Arial Narrow"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom"></td></tr><tr>';
		foreach($sql as $row)
		{
			echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';
			if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
			$i++;
		}
	echo '</tr></table>';
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
	$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
	$mail_sql_res=sql_select($sql);
	
	$mailArr=array();
	foreach($mail_sql_res as $row)
	{
		$mailArr[$row[EMAIL]]=$row[EMAIL]; 
	}

	
	

		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report17")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');

	$po_arr= sql_select("select a.job_no, a.product_dept, a.total_set_qnty, b.id, b.po_number, MIN(b.po_received_date) as po_received_date, b.pub_shipment_date, b.grouping, sum(b.plan_cut) as plan_cut, sum(b.po_quantity) as po_quantity from wo_po_details_master a,wo_po_break_down b
	 where a.job_no=b.job_no_mst and b.status_active=1 and b.id in(".str_replace("'","",$txt_order_no_id).") group by a.job_no, a.total_set_qnty, a.product_dept, b.id, b.po_number, b.pub_shipment_date, b.grouping");
	$po_qnty_tot1=$po_qnty_tot=$tot_po_qnty_tot_pcs=0;
	$internal_ref_no="";
	$report_title="Knitting and Dyeing Program (KDP)";
	foreach($po_arr as $row)
	{
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$po_qnty_tot+=$row[csf('po_quantity')];
		$tot_po_qnty_tot_pcs+=$row[csf('po_quantity')]*$row[csf('total_set_qnty')];
		if($internal_ref_no=="") $internal_ref_no=$row[csf('grouping')];else $internal_ref_no.=",".$row[csf('grouping')];
		$intRef[$row[csf('grouping')]]=$row[csf('grouping')];
		$po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
		$prod_dept=$product_dept[$row[csf('product_dept')]];
		$job_no_aarr.=$row[csf('job_no')].',';

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	$job_numbers=implode(",",array_unique(explode(",",$job_nos)));

	$revised_no = return_field_value("revised_no", "wo_booking_mst", "booking_no=$txt_booking_no");

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	//$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;

	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$path = str_replace("'", "", $path);
	if ($path == "") $path = '../../';
	ob_start();

		?>									<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow" >
           <tr>
               <td width="100">
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:24px;">
                              <b><?php echo $company_library[$cbo_company_name]; ?></b>
                            </td>
                            <td rowspan="3" width="280">
                               <span style="font-size:24px"><b> Booking NO.:&nbsp;&nbsp;<?
							    echo str_replace("'","",$txt_booking_no); ?>  </b></span><br>
							   <span style="font-size:20px"><b> Internal Ref.:&nbsp;&nbsp;<?
							   $ref_no=trim($internal_ref_no,"'");
							   $ref_nos=implode(", ",array_unique(explode(",",$ref_no)));
							    echo $ref_nos; ?></b></span><br>
                                <?
								if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								?>
                                 <span style="font-size:20px"><b>Revised No.:&nbsp;<?
							   	 echo $nameArray_approved_row[csf('approved_no')]; ?></b></span>
                                <?
								}
								?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                           $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
                            if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
                            else $location="";
                            
                            
                            foreach ($nameArray as $result)
                            {
								echo  $location_name_arr[$location];
								?>
								<!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
								Level No: <? //echo $result[csf('level_no')]?>
								Road No: <? //echo $result[csf('road_no')]; ?>
								Block No: <? //echo $result[csf('block_no')];?>
								City No: <? //echo $result[csf('city')];?>
								Zip Code: <? //echo $result[csf('zip_code')]; ?>
								Province No: <?php //echo $result[csf('province')];?>
								Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
								Email Address: <? echo $result[csf('email')];?>
								Website No: <? echo $result[csf('website')]; ?>
								<?
                            }
                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:24px;justify-content: center;text-align: center;">
                                <strong style="justify-content: center;text-align: center;"><? echo $report_title;?> &nbsp; &nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $style_ref_no=""; $inserted_by=""; $currency_id="";
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.fabric_composition,a.revised_no,a.remarks,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.currency_id,a.pay_mode,a.booking_percent,a.rmg_process_breakdown,a.insert_date,a.inserted_by,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.order_repeat_no from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				$po_id_all=$nameArray[0][csf('po_break_down_id')];

				$remarks="";
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$inserted_by=$result[csf('inserted_by')];
					$currency_id=$result[csf('currency_id')];
					$booking_percent=$result[csf('booking_percent')];
					$remarks=$result[csf('remarks')];

					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time[$row_lead_time[csf('date_diff')]]=$row_lead_time[csf('date_diff')];
					}

				  $gmts_item=explode(',',$result[csf('gmts_item_id')]);
				  foreach($gmts_item as $gm_item)
				  {
				  	$gm_item_name.=$garments_item[$gm_item].',';
				  }

				?>
                <table width="100%" style="border:1px solid black; margin-top:1px;font-family:Arial Narrow; font-size:16px" >
                <tr>
                <td colspan="5" valign="top" style="font-size:16px; color:#F00">
				<?
				if($result[csf('is_apply_last_update')]==2){
					echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]];
				}
				else{
					echo "";
				}
				?>
                </td>
                </tr>
                <tr>
                <td width="120"><span style="font-size:16px"><b>Buyer/Agent Name</b></span></td>
                <td width="225">:&nbsp;<span style="font-size:16px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="120" style="font-size:16px"><b>Dept. </b>   </td>
                <td width="225" style="font-size:16px">:<b><? echo  $prod_dept; ?></b></td>
                </tr>
                <tr>
                 <td width="120" style="font-size:16px"><b>Order Qnty </b>   </td>
                <td width="225" style="font-size:16px">:<b><? echo  $tot_po_qnty_tot_pcs;?>&nbsp;Pcs</b></td>

                <td width="" style="font-size:16px"><b>Garments Item</b>   </td>
                <td width="" style="font-size:16px">: <b><? echo rtrim($gm_item_name,','); ?></b></td>
                </tr>
                <tr>
				<td width="" style="font-size:16px"><b>Style Ref.</b></td>
                <td width="">:
                <? echo $result[csf('style_ref_no')];
               $style_ref_no=$result[csf('style_ref_no')]; ?>
                </td>
               <td  width="" style="font-size:16px"><b>Style Des.</b></td>
                <td  width="" >:<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                </tr>
                <tr>
                  <td width="" style="font-size:16px"><b>BookingRelease Date</b></td>
                <td width="">:
                <?
                $booking_date=$result[csf('update_date')];
                if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
                $booking_date=$result[csf('insert_date')];
                }
                echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                ?>
                </td>

                <td  width="" style="font-size:16px"><b>Po Received Date</b></td>
                <td  width="" >:<? echo $po_received_date; ?></td>
                </tr>
                <tr>
                <td  width="" style="font-size:16px"><b>Dealing Merchant</b></td>
                <td  width="" >:<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
                <td width="" style="font-size:16px"><b>Supplier Name</b></td>
                <td width="">
				:<? //echo $marchentrArr[$result[csf('dealing_marchant')]]; ?>
                <?
                if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]]; else echo $supplier_name_arr[$result[csf('supplier_id')]];
                ?>
                </td>
                </tr>
                <tr>
                <td width="" style="font-size:16px"><b>Delivery Date</b>   </td>
                <td width="">:<?  echo change_date_format($result[csf('delivery_date')]);//?> </td>
				<td width="" style="font-size:16px"><b>Job No</b>   </td>
                <td width="">:<b><?  $jobnos=trim($job_numbers); $jobnos=implode(",",array_unique(explode(",",$jobnos))); echo $jobnos; ?></b> </td>
                </tr>
                <tr>
                <td width="" style="font-size:16px"><b>Season</b></td>
                <td width="">:<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td width="" style="font-size:16px"><b>Attention</b></td>
                <td width="">:<? echo $result[csf('attention')]; ?></td>
                </tr>
                <tr>
                 <td width="" style="font-size:16px"><b>Lead Time </b></td>
               	 <td width="">:<? echo implode(",",$lead_time); ?></td>
                </tr>
                </table>
           <?
			}

			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
             <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown </legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>PO Number</strong></td>
                        <td style="border:1px solid black"><strong>Ship Date</strong></td>
                        <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
					$order_id=explode(",",str_replace("'","",$txt_order_no_id));
					for($or=0;$or<count($order_id); $or++)
				    {
						for($c=0;$c<count($gmts_item); $c++)
					    {
							$item_size_tatal=array(); $item_size_tatal_order=array();
							$item_grand_total=0; $item_grand_total_order=0;
							$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
							?>
		                    <?
							foreach($nameArray_color as $result_color)
		                    {
		                    ?>
		                    <tr>
		                        <td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
		                         <td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
		                          <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
		                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
		                        <?
								$color_total=0; $color_total_order=0;

								foreach($nameArray_size  as $result_size)
								{
								$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
								foreach($nameArray_color_size_qnty as $result_color_size_qnty)
		                        {

		                        ?>
		                            <td style="border:1px solid black; text-align:right">
									<?
										if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
										{
											 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
											 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
											 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
											 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
										     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
											 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
											 {
													$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
											 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
											 {
													$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
										}
										else echo "0";
									 ?>
									</td>
		                    <?
								}
		                        }
		                        ?>
		                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
		                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
		                         <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
		                    </tr>
		                    <?
		                    }
							?>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                      <td align="center" style="border:1px solid black"><strong></strong></td>
		                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
		                        <?
								foreach($nameArray_size  as $result_size)
		                        {
		                        ?>
		                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
		                        <?
		                        }
		                        ?>
		                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
		                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
		                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
		                    </tr>
		                    <?
						}
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
             </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
            	<?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
					?>
					<tr>
                        <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?> </td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
					?>
					<tr>
                        <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                        <td align="right"><?  echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
					?>
					<tr>
                        <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
					?>
					<tr>
                        <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                        <td align="right"><?  echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
					?>
					<tr>
                        <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
					?>
					<tr>
                        <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
					?>
					<tr>
                        <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
					?>
					<tr>
                        <td width="130">Others <!-- New breack Down 11--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
					</tr>
					<?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Sub Total <!-- New breack Down 11--></td>
                        <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
					</tr>
					<?
				}
				?>
                </table>
                </fieldset>
                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
					?>
					<tr>
                        <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
					?>
					<tr>
                        <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
					?>
					<tr>
                        <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
					?>
					<tr>
                        <td width="130">All Over Print <!-- new  breack Down 13--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
					?>
					<tr>
                        <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
					?>
					<tr>
                        <td width="130">Dying   <!-- breack Down 7--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
					?>
					<tr>
                        <td width="130"> Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
					?>
					<tr>
                        <td width="130">Others  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
					</tr>
					<?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
					</tr>
					<?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
					</tr>
					<?
				}
				?>
           </table>
         	  </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in('$job_nos') and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
					?>
					<td><img src="../../<? echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td>
					<?
					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
      <br/>
       <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	 </style>
     <?
	 $costing_per=""; $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
	 if($costing_per_id==1)
	{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;
	}
	if($costing_per_id==2)
	{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;
	}
	if($costing_per_id==3)
	{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;
	}
	if($costing_per_id==4)
	{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;
	}
	if($costing_per_id==5)
	{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	$nameArray_fabric_description= sql_select("select a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, b.remarks, avg(b.cons) as cons, b.process_loss_percent, avg(b.requirment) as requirment,b.po_break_down_id,  d.fabric_color_id, d.gmts_color_id, d.id as dtls_id, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0  AND a.status_active = 1 AND a.is_deleted = 0   AND c.status_active = 1  AND c.is_deleted = 0  AND b.status_active = 1  AND b.is_deleted = 0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, b.remarks,d.fabric_color_id, d.gmts_color_id, d.id,b.po_break_down_id, b.process_loss_percent order by a.body_part_id, b.dia_width");



	foreach ($nameArray_fabric_description as $row) {	
		$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."'  and approval_status=3 and color_name_id=".$row[csf('fabric_color_id')]."");

		$grouping_item=$row[csf('fabric_color_id')].'*'.$row[csf('body_part_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('color_type_id')];	
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gmts_color_id'] = $row[csf('gmts_color_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_color_id'] = $row[csf('fabric_color_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['lapdip_no'] = $lapdip_no;
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['body_part_id'] = $row[csf('body_part_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_des'] = $row[csf('construction')].','.$row[csf('composition')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gsm'] = $row[csf('gsm_weight')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_dia'] = $row[csf('dia_width')].",".$fabric_typee[$row[csf('width_dia_type')]];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['color_type_id'] = $row[csf('color_type_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['finsh_cons'] = $row[csf('cons')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gray_cons'] = $row[csf('requirment')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fin_fab_qnty'] += $row[csf('fin_fab_qnty')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['grey_fab_qnty'] += $row[csf('grey_fab_qnty')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['process_loss_percent'] = $row[csf('process_loss_percent')];

	}

	/*echo '<pre>';
	print_r($fabric_data_arr); die;*/

	?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-size: 18px;">
     	<tr>
     		<th>Gmts Color</th>
     		<th>Fabric Color</th>
			<th>Lab Dip No</th>
     		<th>Body Part</th>
     		<th>Fabrication</th>
     		<th>GSM</th>
     		<th>Dia Type with </br> Fabric Dia</th>
		
     		<th>Color Type</th>
     		<th>Finsh Cons.</th>
     		<th>Finish  Qty</th>
     		<th>Grey Cons.</th>
     		<th>Grey Qty</th>
     		<th>Process Loss %</th>
     	</tr>
     	<? 
     	foreach ($fabric_data_arr as $gmts_id=>$fabric_data_arr) {  
     	$i=1;     		  		
     		foreach ($fabric_data_arr as $fabric_id => $value) {
     				$fin_fab_qnty+=$value['fin_fab_qnty'];   		 	
     				$grey_fab_qnty+=$value['grey_fab_qnty'];   		 	
     		 		if($i==1){
     		 	 	?>
	     		 	<tr>
		     			<td rowspan="<? echo count($fabric_data_arr) ?>"><? echo $color_library[$gmts_id] ?></td>
		     			<td><? echo $color_library[$value['fabric_color_id']] ?></td>
						<td><? echo $value['lapdip_no']; ?></td>
		     			<td><? echo $body_part[$value['body_part_id']] ?></td>
		     			<td><? echo $value['fabric_des'] ?></td>
		     			<td><? echo $value['gsm'] ?></td>
		     			<td><? echo $value['fabric_dia'] ?></td>
		     			<td><? echo $color_type[$value['color_type_id']] ?></td>
		     			<td><? echo $value['finsh_cons'] ?></td>
		     			<td><? echo $value['fin_fab_qnty'] ?></td>
		     			<td><? echo $value['gray_cons'] ?></td>		     			
		     			<td><? echo $value['grey_fab_qnty'] ?></td>
		     			<td><? echo $value['process_loss_percent'] ?></td>
	     			</tr>
     		 		<? } 
     		 		else { ?>
     		 			<tr>
			     			<td><? echo $color_library[$value['fabric_color_id']] ?></td>
							 <td><? echo $color_library[$value['fabric_color_id']] ?></td>
		     				<td><? echo $body_part[$value['body_part_id']] ?></td>
			     			<td><? echo $value['fabric_des'] ?></td>
			     			<td><? echo $value['gsm'] ?></td>
			     			<td><? echo $value['fabric_dia'] ?></td>
			     			<td><? echo $color_type[$value['color_type_id']] ?></td>
			     			<td><? echo $value['finsh_cons'] ?></td>
			     			<td><? echo number_format($value['fin_fab_qnty'],2) ?></td>
			     			<td><? echo $value['gray_cons'] ?></td>			     			
			     			<td><? echo number_format($value['grey_fab_qnty'],2) ?></td>
			     			<td><? echo $value['process_loss_percent'] ?></td>
	     				</tr>
     		 		<? }
     		 		$i++;
     		 	//}
     		}
     	} 
     	?>
     	<tr>
     		<th colspan="9">Total</th>
     		<th><?echo number_format($fin_fab_qnty);  ?></th>
     		<th></th>
     		<th><?echo number_format($grey_fab_qnty);  ?></th>
     		<th></th>
     	</tr>
     </table>
      <br/>
     <?
	$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_nos' and status_active=1");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($po_id_all) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)

									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    //$colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
													  $colar_excess_per=($plan_cut*$collar_ex_per)/100;
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
   ?>
        <br/>

	<table style="margin-top: 10px;" class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<tr>
	<td valign="top">

	<?
 	$condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.job_no,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.job_no,a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");

			?>
		   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
						?> <td>Rate</td><?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {
						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$row[csf("job_no")]],4);//echo number_format($row[csf('yarn_required')],4); ?></td>
                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>

      </td>
       <td>
       	<table  width="100%" style="margin: 0px;padding: 0px;">
        <?php $stripe_color_wise=array(); ?>
       
        <tr>
        	<td width="70%" style="float: left;">
        		<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >
        		       
        		        <tr>
        		            <td align="center" colspan="9">  Stripe Details</td>
        		            
    		            </tr>
        		        <?
        				$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
        				$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");        				
        				$result_data=sql_select($sql_stripe);
        				foreach($result_data as $row)
        				{
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
        				}
        				?>
        		            <tr>
	        		            <td align="center" width="30"> SL</td>
	        		            <td align="center" width="100"> Body Part</td>
	        		            <td align="center" width="80"> Fabric Color</td>
	        		            <td align="center" width="70"> Fabric Qty(KG)</td>
	        		            <td align="center" width="70"> Stripe Color</td>
	        		            <td align="center" width="70"> Stripe Measurement</td>
	        		            <td align="center" width="70"> Stripe Uom</td>
	        		            <td  align="center" width="70"> Qty.(KG)</td>
	        		            <td  align="center" width="70"> Y/D Req.</td>
        		            </tr>
        		            <?

        					$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
        		            foreach($stripe_arr as $body_id=>$body_data)
        		            {
        						foreach($body_data as $color_id=>$color_val)
        						{
        							$rowspan=count($color_val['stripe_color']);
        							$composition=$stripe_arr2[$body_id][$color_id]['composition'];
        							$construction=$stripe_arr2[$body_id][$color_id]['construction'];
        							$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
        							$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
        							$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

        							if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        							else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

        							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
        								WHERE a.job_no=b.job_no and
        								a.id=b.pre_cost_fabric_cost_dtls_id and
        								c.job_no_mst=a.job_no and
        								c.id=b.color_size_table_id and
        								b.po_break_down_id=d.po_break_down_id and
        								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
        								d.booking_no =$txt_booking_no and
        								a.body_part_id='".$body_id."' and
        								a.color_type_id='".$color_type_id."' and
        								a.construction='".$construction."' and
        								a.composition='".$composition."' and
        								a.gsm_weight='".$gsm_weight."' and
        								$color_cond and
        								d.status_active=1 and
        								d.is_deleted=0
        								");
        						
        								list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
        							?>
        							<tr>
	        							<?
	        							$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	        							?>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
	        							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
	        							<?
	        							$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	        							$sk=0;
	        							foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
	        							{

	        								$measurement=$color_val['measurement'][$strip_color_id];
	        								$uom=$color_val['uom'][$strip_color_id];
	        								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
	        								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
	        								if($sk>0)
	        								{
	        									echo "<tr>";
	        								}
	        								?>
	        							
		        								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
		        								<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
		        		                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
		        								<td align="right"> <? echo  number_format($fabreqtotkg,2); ?> &nbsp;</td>
		        								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
	        								
	        								<?
	        								if($sk>0)
	        								{
	        									echo "</tr>";
	        								}
	        								$sk++;
	        								$total_fabreqtotkg+=$fabreqtotkg;
	        								$stripe_color_wise[$color_name_arr[$s_color_val]]+=$fabreqtotkg;
	        							}
	        							$i++;
	        							?>
        							</tr>
        							<?
        						}
        					}
        					?>
	        		            <tfoot>
		        		            <tr>
			        		            <td colspan="3">Total </td>
			        		            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
			        		            <td></td>
			        		            <td></td>
			        		            <td>   </td>
			        		            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
			        		        </tr>
	        		            </tfoot>
        		            </table>
        	</td>
        	
        	<td width="20%" style="float: right;">
        		        <table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;"  >
        		       

        		        <tr>
        		            <td align="left" colspan="3"> Stripe  Color wise Summary</td>
        		            
        		           
        		           
    		            </tr>
        		        <?
        				
        				?>
        		            <tr>
	        		            <td width="30"> SL</td>
	        		            
	        		            <td width="70"> Stripe Color</td>
	        		           
	        		            <td  width="70"> Qty.(KG)</td>
	        		           
        		            </tr>
        		            <?
        					$i=1;$total_stripe_qnt=0;        		            
        						foreach($stripe_color_wise as $color=>$val)
        						{
        							
        							
        							?>
        							<tr>
	        							<td> <? echo $i; ?></td>
	        							
	        							<td > <? echo $color; ?></td>
	        							<td align="right"> <?php echo number_format($val,2); ?></td>
	        						</tr>
        							
        							<?
        							$total_stripe_qnt+=$val;
        							
        							$i++;
        						}
        					
        					?>
        		            <tfoot>
        		            <tr>
        		            
        		            <td></td>
        		            <td></td>
        		            
        		            <td align="right"><? echo  number_format($total_stripe_qnt,2); ?> </td>
        		            </tr>
        		            </tfoot>
        		            </table>
        	</td>
        </tr>
         </table >

        </td>
          </tr>
          <tr>
          <td colspan="2">
          <?
          $sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	if(count($data_array)>0)
	{
		  ?>
          <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:550px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="50">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
          </div>
          <?
        }
          ?>
          </td>
          </tr>
        </table>
	</table>
			<br>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                 <tr>
                 <td>
                 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

                   <tr align="center">
                    <td colspan="10"><b>Dyes To Match</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Item</td>
                    <td>Body Color</td>
                    <td>Item Color</td>
                    <td>Finish Qty.</td>
                    <td>UOM</td>
                    </tr>
                    <?
					$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
		$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
		$bookingId=0;
		foreach($sql as $row){
			$bookingId= $row[csf('id')];
		}
					$co=0;
					$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color");

					foreach($sql_data  as $row)
                    {
					$co++;
					?>
                    <tr>
                    <td><? echo $co; ?></td>
                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
                    <td align="right"><? echo $row[csf('qty')];?></td>
                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
                    </tr>
                    <?
					}
					?>
                    </table>
                    </td>
                    <td>
                  <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {
						$i++;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td><? echo $item[$row[csf('item_id')]]; ?></td>
                            <td><? echo $supplier[$row[csf('supplier_id')]]; ?></td>
                            <td><? echo $row[csf('lot')]; ?></td>
                            <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
						</tr>
						<?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else echo "";
				}
					?>
                    </td>
                    </tr>
                 </table>
        <br/>
        <?
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_nos' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
		?>
        <br/>
        <br>

		<?
		 $lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
		 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
		 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
	//echo $mst_id.'ssD';
	//and b.un_approved_date is null
	 $approve_data_array=sql_select("select b.approved_by,min(b.approved_date) as approved_date from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  group by  b.approved_by order by b.sequence_no asc");


	 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");



     if(count($approve_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="40%" style="border:1px solid black;">Name</th>
				<th width="30%" style="border:1px solid black;">Designation</th>
				<th width="27%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
		<br>
		<?
		if(count($unapprove_data_array)>0)
		{
		$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
			$unapproved_request_arr=array();
			foreach($sql_unapproved as $rowu)
			{
				$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
			}
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($unapprove_data_array as $row){

			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<td width="20%" style="border:1px solid black;"><? echo '';?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
            </tr>
                <?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if($un_approved_date!="")
				{
				?>
			<tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
              </tr>

                <?
				$i++;
				}

			}
				?>
            </tbody>
        </table>
		<?
		}

      //Not used
        $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
        $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
        ?>
       <br> <br>
        <table  width="100%" class="rpt_table" style="display:none"   border="1" cellpadding="0" cellspacing="0" rules="all">
        	<tr>
            <td>
            <table  width="95%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <tr>
            <td>
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
            $i=1;
            foreach($data_array as $row){
            ?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
                $i++;
            }
                ?>
            </tbody>
        	</table>
            </td>
            <td>
            	 <table  width="96%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                 <?
                 $nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
				 $nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
				 ?>
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>
                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>
            </td>
            </tr>
        </table>
		  <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
			$costing_per=0;
            if($result[csf("costing_per")]==1) $costing_per=12;
			else if($result[csf("costing_per")]==2) $costing_per=1;
			else if($result[csf("costing_per")]==3) $costing_per=24;
			else if($result[csf("costing_per")]==4) $costing_per=36;
			else if($result[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;

			$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/($costing_per*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");

			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0; $total_booking_qnty_main=0; $total_booking_qnty_short=0; $total_booking_qnty_sample=0; $total_tot_bok_qty=0; $tot_balance=0;

					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td><? if( $balance>0) echo "Less Booking"; else if ($balance<0) echo "Over Booking"; else echo ""; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                </td>

            </tr>
        </table>
         <br>

         <?
		 echo "Note:".$remarks."<br>";
		 $sql = sql_select("select designation,name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
	     $count=count($sql);
		$width=1330;
		$td_width=floor($width/$count);
		$standard_width=$count*150;
		if($standard_width>$width) $td_width=150;
		$no_coloumn_per_tr=floor($width/$td_width);
		$col=$count-2;
		$i=1;
		echo '<table width="'.$width.'" style="font-family:Arial Narrow"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom"></td></tr><tr>';
		foreach($sql as $row)
		{
			echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';
			if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
			$i++;
		}
	echo '</tr></table>';

	
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_print14") // reduce execution time 18019
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');

	$po_arr= sql_select("select a.job_no,a.product_dept,a.total_set_qnty,b.id,b.po_number,MIN(b.po_received_date) as po_received_date, b.pub_shipment_date,b.grouping,sum(b.plan_cut) as plan_cut,sum(b.po_quantity) as po_quantity from wo_po_details_master a,wo_po_break_down b
	 where a.job_no=b.job_no_mst and b.status_active=1 and b.id in(".str_replace("'","",$txt_order_no_id).") group by a.job_no,a.total_set_qnty,a.product_dept,b.id,b.po_number,b.pub_shipment_date,b.grouping");
	$po_qnty_tot1=$po_qnty_tot=$tot_po_qnty_tot_pcs=0;
	$internal_ref_no="";
	foreach($po_arr as $row)
	{
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$po_qnty_tot+=$row[csf('po_quantity')];
		$tot_po_qnty_tot_pcs+=$row[csf('po_quantity')]*$row[csf('total_set_qnty')];
		if($internal_ref_no=="") $internal_ref_no=$row[csf('grouping')];else $internal_ref_no.=",".$row[csf('grouping')];
		$intRef[$row[csf('grouping')]]=$row[csf('grouping')];
		$po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
		$prod_dept=$product_dept[$row[csf('product_dept')]];
		$job_no_aarr.=$row[csf('job_no')].',';

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	$job_numbers=implode(",",array_unique(explode(",",$job_nos)));

	$revised_no = return_field_value("revised_no", "wo_booking_mst", "booking_no=$txt_booking_no");

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	//$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;

	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$path = str_replace("'", "", $path);
	if ($path == "") $path = '../../';
	$condition= new condition();
    if(str_replace("'","",$txt_order_no_id) !=''){
        $condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
    }

    $condition->init();

	?>									<!--    Header Company Information         -->
	<style type="text/css" media="print">
		@media print {
		  table tr th {
			font-size: 18px;
			font-family: Arial Narrow;
		  }
		  table tr td {
			font-size: 18px;
			font-family: Arial Narrow;
		  }
		}
		
		
	</style>
    <table width="100%" cellpadding="5" style="border:1px solid black; font-family:Arial Narrow" >
        <tr>
            <td width="100">
            	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
            </td>
            <td width="1250">
                <table width="100%" cellpadding="0" cellspacing="0"  >
                    <tr>
                        <td align="center" style="font-size:20px;"><?php echo $company_library[$cbo_company_name]; ?></td>
                        <td rowspan="3" width="250">
                            <span style="font-size:20px"><b> Job No:&nbsp;&nbsp;<?
                            $jobnos=trim($job_numbers);
                            $jobnos=implode(",",array_unique(explode(",",$jobnos)));
                            echo $jobnos; ?></b></span><br>
                            <span style="font-size:20px"><b> Internal Ref.:&nbsp;&nbsp;<?
                            $ref_no=trim($internal_ref_no,"'");
                            $ref_nos=implode(", ",array_unique(explode(",",$ref_no)));
                            echo $ref_nos; ?></b></span><br>
                        <?
                        if($nameArray_approved_row[csf('approved_no')]>1)
                        {
							?>
							<span style="font-size:20px"><b>Revised No.:&nbsp;<?
							echo $nameArray_approved_row[csf('approved_no')]; ?></b></span>
							<?
                        }
                        ?>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="font-size:14px">
                        <?
                        $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
                        if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no"); else $location=""; ?>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="font-size:20px">
                        <strong><? echo $report_title;?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        
    </table>
                <?
				$job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $style_ref_no=""; $inserted_by=""; $currency_id="";
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.fabric_composition,a.revised_no,a.remarks,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.currency_id,a.pay_mode,a.booking_percent,a.rmg_process_breakdown,a.insert_date,a.inserted_by,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.order_repeat_no from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				$po_id_all=$nameArray[0][csf('po_break_down_id')];

				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$inserted_by=$result[csf('inserted_by')];
					$currency_id=$result[csf('currency_id')];
					$booking_percent=$result[csf('booking_percent')];

					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time[$row_lead_time[csf('date_diff')]]=$row_lead_time[csf('date_diff')];
					}

				  $gmts_item=explode(',',$result[csf('gmts_item_id')]);
				  foreach($gmts_item as $gm_item)
				  {
				  	$gm_item_name.=$garments_item[$gm_item].',';
				  }

				?>
                <table width="100%" style="border:1px solid black; margin-top:1px;font-family:Arial Narrow; font-size:16px" cellpadding="5">
                    <tr>
                        <td colspan="5" valign="top" style="font-size:16px; color:#F00">
                        <?
                        if($result[csf('is_apply_last_update')]==2){ echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]];
                        }
                        else echo "";
                        ?>
                        </td>
                    </tr>
                    <tr>
                        <td width="120"><span style="font-size:16px"><b>Buyer/Agent Name</b></span></td>
                        <td width="225">:&nbsp;<span style="font-size:16px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                        <td width="120" style="font-size:16px"><b>Dept. </b>   </td>
                        <td width="225" style="font-size:16px">:<b><? echo  $prod_dept; ?></b></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Order Qnty </b>   </td>
                        <td style="font-size:16px">:<b><? echo  $tot_po_qnty_tot_pcs;?>&nbsp;Pcs</b></td>
                        <td style="font-size:16px"><b>Garments Item</b>   </td>
                        <td style="font-size:16px">: <b><? echo rtrim($gm_item_name,','); ?></b></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Style Ref.</b></td>
                        <td>:<? echo $result[csf('style_ref_no')]; $style_ref_no=$result[csf('style_ref_no')]; ?></td>
                        <td style="font-size:16px"><b>Style Des.</b></td>
                        <td>:<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>BookingRelease Date</b></td>
                        <td>:
							<?
                            $booking_date=$result[csf('update_date')];
                            if($booking_date=="" || $booking_date=="0000-00-00 00:00:00") $booking_date=$result[csf('insert_date')];
                            echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                            ?>
                        </td>
                        <td style="font-size:16px"><b>Po Received Date</b></td>
                        <td>:<? echo $po_received_date; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Dealing Merchant</b></td>
                        <td>:<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
                        <td style="font-size:16px"><b>Supplier Name</b></td>
                        <td>:
                        <?
                        if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]]; else echo $supplier_name_arr[$result[csf('supplier_id')]];
                        ?>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Delivery Date</b>   </td>
                        <td>:<?  echo change_date_format($result[csf('delivery_date')]);//?> </td>
                        <td style="font-size:16px"><b>Booking No </b>   </td>
                        <td>:<?  echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")";?> </td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Season</b></td>
                        <td>:<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                        <td style="font-size:16px"><b>Attention</b></td>
                        <td>:<? echo $result[csf('attention')]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Lead Time </b></td>
                        <td>:<? echo implode(",",$lead_time); ?></td>
                    </tr>
                    
                </table>
           <?
			}

			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			$emblishment= new emblishment($condition);
			$emb_qty_arr= $emblishment->getQtyArray_by_orderGmtsitemGmtscolorAndEmbname();
			$wash = new wash($condition);
			$wash_qty_arr= $wash->getQtyArray_by_OrderGmtsitemGmtscolorAndEmbname();
			/*echo '<pre>';
			print_r($wash_qty_arr); die;*/

		   ?>
    <br clear="all">
    <caption style="text-align:left"><b>Size and Color Breakdown </b></caption>
    	<table  class="rpt_table" width="100%" rules="all"  border="1">
            <thead>
            	<tr>
                    <td style="border:1px solid black; text-align: center;"><strong>PO Number</strong></td>
                    <td style="border:1px solid black; text-align: center;"><strong>Ship Date</strong></td>
                    <td style="border:1px solid black; text-align: center;"><strong>Gmts Item</strong></td>
                    <td style="border:1px solid black; text-align: center;"><strong>&nbsp;Color/Size&nbsp;</strong></td>
                    <?
                    foreach($nameArray_size  as $result_size)
                    {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                    <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                    <td style="border:1px solid black; width:50px" align="center"><strong> Ex %</strong></td>
                    <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Printing Qty</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Embroidery Qty</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Gmt Wash Qty</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Sp. Work Qty</strong></td>
                </tr>
            </thead>
        	<tbody>
                <?
                $costing_per=""; $costing_per_qnty=0;
				$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
				if($costing_per_id==1)
				{
					$costing_per="1 Dzn"; $costing_per_qnty=12;
				}
				else if($costing_per_id==2)
				{
					$costing_per="1 Pcs"; $costing_per_qnty=1;
				}
				else if($costing_per_id==3)
				{
					$costing_per="2 Dzn"; $costing_per_qnty=24;
				}
				else if($costing_per_id==4)
				{
					$costing_per="3 Dzn"; $costing_per_qnty=36;
				}
				else if($costing_per_id==5)
				{
					$costing_per="4 Dzn"; $costing_per_qnty=48;
				}
                $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                $order_id=explode(",",str_replace("'","",$txt_order_no_id));
   				$m=1;

   				if(count(array_unique(array_filter($gmts_item))))
   				{
   					$item_number_id_cond=where_con_using_array(array_unique(array_filter($gmts_item)),0,"item_number_id");
   				}
   				else{
   					$item_number_id_cond='';
   				}
   				if(count(array_unique(array_filter($order_id))))
   				{
   					$po_id_cond=where_con_using_array(array_unique(array_filter($order_id)),0,"po_break_down_id");
   				}
   				else{
   					$po_id_cond='';
   				}
   				
   				$nameArray_color=sql_select( "select item_number_id, color_number_id,po_break_down_id from wo_po_color_size_breakdown where is_deleted=0 and status_active=1 $item_number_id_cond $po_id_cond group by item_number_id, color_number_id,po_break_down_id order by color_number_id");
   				//echo  "select item_number_id, color_number_id,po_break_down_id from wo_po_color_size_breakdown where and is_deleted=0 and status_active=1 $item_number_id_cond $po_id_cond group by item_number_id, color_number_id,po_break_down_id order by color_number_id";
   				$po_and_item_wise_color=array();
   				$color_id_arr=array();
   				foreach ($nameArray_color as $row) {
   					$po_item=$row[csf('po_break_down_id')]."***".$row[csf('item_number_id')];
   					$po_and_item_wise_color[$po_item][]=$row[csf('color_number_id')];
   					array_push($color_id_arr, $row[csf('color_number_id')]);
   				}
   				// echo "<pre>";
   				// print_r($po_and_item_wise_color);
   				// echo "</pre>";
   				if(count(array_unique(array_filter($color_id_arr))))
   				{
   					$color_id_cond=where_con_using_array(array_unique(array_filter($color_id_arr)),0,"color_number_id");
   				}
   				else{
   					$color_id_cond='';
   				}
   				if(count(array_unique(array_filter($size_id_arr))))
   				{
   					$size_id_cond=where_con_using_array(array_unique(array_filter($size_id_arr)),0,"size_number_id");
   				}
   				else{
   					$size_id_cond='';
   				}
   				
   				$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity,color_number_id,size_number_id,po_break_down_id,item_number_id  from wo_po_color_size_breakdown where status_active=1 and is_deleted =0  $color_id_cond  $item_number_id_cond  $po_id_cond  $size_id_cond group by color_number_id,size_number_id,po_break_down_id,item_number_id");
   				//echo "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity,color_number_id,size_number_id,po_break_down_id,item_number_id  from wo_po_color_size_breakdown where status_active=1 and is_deleted =0  $color_id_cond  $item_number_id_cond  $po_id_cond  $size_id_cond group by color_number_id,size_number_id,po_break_down_id,item_number_id";
   				$po_item_color_size_wise=array();
   				foreach ($nameArray_color_size_qnty as $row) {
   					$po_item_color_size_wise[$row[csf('po_break_down_id')]."***".$row[csf('size_number_id')]."***".$row[csf('item_number_id')]."***".$row[csf('color_number_id')]]['plan_cut_qnty']+=$row[csf('plan_cut_qnty')];
   					$po_item_color_size_wise[$row[csf('po_break_down_id')]."***".$row[csf('size_number_id')]."***".$row[csf('item_number_id')]."***".$row[csf('color_number_id')]]['order_quantity']+=$row[csf('order_quantity')];
   				}
   				// echo "<pre>";
   				// print_r($po_item_color_size_wise);
   				// echo "</pre>";

   				
                  for($or=0;$or<count($order_id); $or++)
                   {
                       for($c=0;$c<count($gmts_item); $c++)
                       {
                           $item_size_tatal=array(); $item_size_tatal_order=array();
                           $item_grand_total=0; $item_grand_total_order=0;
                          // $nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
                           $po_item=$order_id[$or]."***".$gmts_item[$c];
   						$color_ar=$po_and_item_wise_color[$po_item];
   						// echo "<pre>";
   						// print_r($color_ar);
   						// echo "<pre>";
                           ?>
                           <?
                           $printing_sub_total=0; $embroy_sub_total=0; $wash_sub_total=0; $sp_sub_total=0;
                           foreach($color_ar as $order_item=>$color_number_id)
                           {
                           ?>
                           <tr>
                               <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? echo $po_number_arr[$order_id[$or]]; ?>&nbsp;</td>
                                <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); ?>&nbsp;</td>
                                 <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? echo $garments_item[$gmts_item[$c]]; ?>&nbsp;</td>
                               <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? echo $color_library[$color_number_id];?>&nbsp;</td>
                               <?
                               $color_total=0; $color_total_order=0;

                               foreach($nameArray_size  as $result_size)
                               {
   								?>
                                  
                                   <?
   								//$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_number_id."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
   								$color_size_qnty=$po_item_color_size_wise[$order_id[$or]."***".$result_size[csf('size_number_id')]."***".$gmts_item[$c]."***".$color_number_id];
   								// echo "<pre>";
   								// print_r($color_size_qnty_arr);
   								// echo "</pre>";
   								//$result_color_size_qnty;
   								//foreach($color_size_qnty_arr as $po_size_item_color=>$color_size_qnty)
   								//{
   									?>
   									 <td style="border:1px solid black; text-align:center; width: 35px">
   									<?
   										if($color_size_qnty['plan_cut_qnty']!= "")
   										{
   											 echo number_format($color_size_qnty['order_quantity'],0);
   											 $color_total += $color_size_qnty['plan_cut_qnty'] ;
   											 $color_total_order += $color_size_qnty['order_quantity'] ;
   											 $item_grand_total+=$color_size_qnty['plan_cut_qnty'];
   											 $item_grand_total_order+=$color_size_qnty['order_quantity'];
   											 $grand_total +=$color_size_qnty['plan_cut_qnty'];
   											 $grand_total_order +=$color_size_qnty['order_quantity'];
   											 $color_size_qnty_array[$result_size[csf('size_number_id')]][$color_number_id]=$color_size_qnty['plan_cut_qnty'];
   											 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$color_number_id]=$color_size_qnty['order_quantity'];
   											 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
   											 {
   													$size_tatal[$result_size[csf('size_number_id')]]+=$color_size_qnty['plan_cut_qnty'];
   													$size_tatal_order[$result_size[csf('size_number_id')]]+=$color_size_qnty['order_quantity'];
   											 }
   											 else
   											 {
   												$size_tatal[$result_size[csf('size_number_id')]]=$color_size_qnty['plan_cut_qnty'];
   												$size_tatal_order[$result_size[csf('size_number_id')]]=$color_size_qnty['order_quantity'];
   											 }
   											 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
   											 {
   													$item_size_tatal[$result_size[csf('size_number_id')]]+=$color_size_qnty['plan_cut_qnty'];
   													$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$color_size_qnty['order_quantity'];
   											 }
   											 else
   											 {
   												$item_size_tatal[$result_size[csf('size_number_id')]]=$color_size_qnty['plan_cut_qnty'];
   												$item_size_tatal_order[$result_size[csf('size_number_id')]]=$color_size_qnty['order_quantity'];
   											 }
   										}
   										else echo "0";
   									 ?>
   									  </td>
   							<?
   								//}
   								?>
                                 
                                   <?
                               }
                               $excexss_per=($color_total-$color_total_order)/$color_total_order*100;
                               $printing_qty = $emb_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][1]*$costing_per_qnty;
                               $plan_cut_printing = $printing_qty*$excexss_per/100;
                               $printing_plan_cut_qty= $printing_qty+$plan_cut_printing;

                               $embrodery_qty= $emb_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][2]*$costing_per_qnty;
                               $plan_cut_embrodery = $embrodery_qty*$excexss_per/100;
                               $embrodery_plan_cut_qty= $embrodery_qty+$plan_cut_embrodery;

                               $wash_qty= $wash_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][3]*$costing_per_qnty;
                               $wash_cut_embrodery = $wash_qty*$excexss_per/100;
                               $wash_plan_cut_qty= $wash_qty+$wash_cut_embrodery;

                               $sp_qty= $emb_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][4]*$costing_per_qnty;
                               $sp_cut_embrodery = $sp_qty*$excexss_per/100;
                               $sp_plan_cut_qty= $sp_qty+$sp_cut_embrodery;
                               ?>
                               <td style="border:1px solid black; text-align:center;"><? echo number_format(round($color_total_order),0); ?></td>
                                <td style="border:1px solid black; text-align:center"><?  echo number_format($excexss_per,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo number_format(round($color_total),2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo number_format($printing_plan_cut_qty,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo number_format($embrodery_plan_cut_qty,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo number_format($wash_plan_cut_qty,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo number_format($sp_plan_cut_qty,2); ?></td>
                           </tr>
                           <?
                           $printing_sub_total +=$printing_plan_cut_qty;
                           $embroy_sub_total +=$embrodery_plan_cut_qty;
                           $wash_sub_total +=$wash_plan_cut_qty;
                           $sp_sub_total +=$sp_plan_cut_qty;
   						$m++;
   						
   						
   						 //if($m==20) break;
                           }
   						
                           ?>
                             <tr>
                             <td align="center" style="border:1px solid black"><strong></strong></td>
                             <td align="center" style="border:1px solid black"><strong></strong></td>
                             <td align="center" style="border:1px solid black"><strong></strong></td>
                               <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                               <?
                               foreach($nameArray_size  as $result_size)
                               {
                               ?>
                               <td style="border:1px solid black;  text-align:center; font-size: 18px; width: 53px"><? echo number_format($item_size_tatal_order[$result_size[csf('size_number_id')]],0);  ?></td>
                               <?
                               }
                               ?>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format(round($item_grand_total),0); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($printing_sub_total,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($embroy_sub_total,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($wash_sub_total,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($sp_sub_total,2); ?></td>
                           </tr>
                           <?
   						$printing_grand_total += $printing_sub_total;
   						$embroy_grand_total += $embroy_sub_total;
   						$wash_grand_total += $wash_sub_total;
   						$sp_grand_total += $sp_sub_total;
                       }
   					
                   }
                   
                   
                ?>
                <tr>
                    <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
                </tr>
               
                <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                    <?
                    foreach($nameArray_size  as $result_size)
                    {
                        ?>
                        <td style="border:1px solid black;  text-align:center; font-size: 18px; width: 53px"><? echo number_format($size_tatal_order[$result_size[csf('size_number_id')]],0);  ?></td>
                        <?
                    }
                    ?>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format(round($grand_total_order),0); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format(round($grand_total),0); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($printing_grand_total,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($embroy_grand_total,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($wash_grand_total,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($sp_grand_total,2); ?></td>
                </tr>
            </tbody>
        </table>
      <br/>
       <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:18px;
		 outline: 0;
		 font-family:Arial Narrow;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:18px;
		 outline: 0;
		 font-family:Arial Narrow;
	 }
	 </style>
     <?
	
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	
	$nameArray_fabric_description= sql_select("select a.item_number_id, a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.item_number_id, a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by a.body_part_id, b.dia_width");
	?>
    
	<table class="rpt_table" width="100%"  border="1" cellpadding="5" cellspacing="0" rules="all" style="font-family:Arial Narrow;">
        <tr align="center">
            <th colspan="5" align="left">Body Part</th>
            <?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('body_part_id')]=="") echo "<td  colspan='2'>&nbsp</td>"; else echo "<td colspan='2'>". $body_part[$frow[csf('body_part_id')]]."</td>";
            }
            ?>

            <td rowspan="9" width="50"><p>Total  Finish Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
            <td rowspan="9" width="50"><p>Total Grey Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
            <td rowspan="9" width="50"><p>Process Loss %</p></td>

        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Color Type</th>
			<?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('color_type_id')]=="") echo "<td  colspan='2'>&nbsp</td>"; else echo "<td colspan='2'>". $color_type[$frow[csf('color_type_id')]]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Fabric Construction</th>
			<?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('construction')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2'>". $frow[csf('construction')]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Fabric Composition</th>
			<?
            foreach($nameArray_fabric_description as $frow)
            {
            	if($frow[csf('composition')]=="") echo "<td colspan='2' >&nbsp</td>"; else  echo "<td colspan='2' >".$frow[csf('composition')]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">GSM</th>
			<?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('gsm_weight')]== "") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>". $frow[csf('gsm_weight')]."</td>";
            }
            ?>
        </tr>
        <!--<tr align="center">
        	<th colspan="5" align="left">Stitch Length</th>
			<?
            /*foreach($nameArray_fabric_description  as $result_fabric_description)
            {
            $determin_id=$result_fabric_description[csf('determin_id')];
            $s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
            if( $result_fabric_description[csf('determin_id')] == "") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>". $s_length."</td>";
            }*/
            ?>
        </tr>-->
        <tr align="center">
        	<th colspan="5" align="left">Dia/Width (Inch)</th>
			<?
            foreach($nameArray_fabric_description as $frow)
            {
            	if( $frow[csf('dia_width')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>".$frow[csf('dia_width')].",".$fabric_typee[$frow[csf('width_dia_type')]]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Consumption For <? echo $costing_per; ?></th>
			<?
            foreach($nameArray_fabric_description as $frow)
            {
            	if( $frow[csf('requirment')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'> Fin: ".number_format($frow[csf('cons')],2).", Grey: ".number_format($frow[csf('requirment')],2)."</td>";
            }
            ?>
        </tr>
        <tr>
        	<th colspan="<? echo  count($nameArray_fabric_description)*2+5; ?>" align="left" style="height:30px">&nbsp;</th>
        </tr>
        <tr>
            <th width="120" align="center">PO Number</th>
            <th width="120" align="center">Ship Date</th>
            <th width="120" align="center">Fabric Color</th>
            <th width="120" align="center">Body Color</th>
            <th width="120" align="center">Lab Dip No</th>
            <?
            foreach($nameArray_fabric_description as $result_fabric_description)
            {
            	echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
            }
            ?>
        </tr>
        <?
        $gmt_color_library=array();
        $gmt_color_data=sql_select("select gmts_color_id, contrast_color_id FROM  wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_nos'");
        foreach( $gmt_color_data as $gmt_color_row)
        {
       		$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
        }
		unset($gmt_color_data);

		$labdip_arr=array();
		$labdip_sql=sql_select("select color_name_id, lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_nos."' and status_active=1 and is_deleted=0 and approval_status=3");
		foreach( $labdip_sql as $labdiprow)
        {
       		$labdip_arr[$labdiprow[csf("color_name_id")]]=$labdiprow[csf("lapdip_no")];
        }
		unset($labdip_sql);

		$color_wise_bookedQty_arr=array(); $color_wiseTotQty_arr=array();
		$color_wise_wo_sql_qnty=sql_select("select a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, nvl(d.fabric_color_id,0) as fabric_color_id, b.po_break_down_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty
			FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.status_active=1 and a.is_deleted=0");

		foreach( $color_wise_wo_sql_qnty as $qrow)
        {
       		$color_wise_bookedQty_arr[$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]][$qrow[csf("fabric_color_id")]][$qrow[csf("po_break_down_id")]]['fin']+=$qrow[csf("fin_fab_qnty")];
			$color_wise_bookedQty_arr[$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]][$qrow[csf("fabric_color_id")]][$qrow[csf("po_break_down_id")]]['grey']+=$qrow[csf("grey_fab_qnty")];

			$color_wiseTotQty_arr[$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]]['fin']+=$qrow[csf("fin_fab_qnty")];
			$color_wiseTotQty_arr[$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]]['grey']+=$qrow[csf("grey_fab_qnty")];
        }
		unset($color_wise_wo_sql_qnty);

        $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;

        $color_wise_wo_sql=sql_select("select fabric_color_id, po_break_down_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by po_break_down_id, fabric_color_id order by po_break_down_id");
        foreach($color_wise_wo_sql as $color_wise_wo_result)
        {
			?>
			<tr>
                <td width="120" align="left"><? echo $po_number_arr[$color_wise_wo_result[csf('po_break_down_id')]]; ?></td>
                <td width="120" align="left"><? echo change_date_format($po_ship_date_arr[$color_wise_wo_result[csf('po_break_down_id')]],"dd-mm-yyyy","-"); ?></td>
                <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                <td><? echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
                <td width="120" align="left">
					<?
                    $lapdip_no="";
                    $lapdip_no=$labdip_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                    if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                    ?>
                </td>
					<?
                    $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;

                    foreach($nameArray_fabric_description as $frow)
                    {
						$finQty=0; $greyQty=0;
						$finQty=$color_wise_bookedQty_arr[$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]][$color_wise_wo_result[csf("fabric_color_id")]][$color_wise_wo_result[csf("po_break_down_id")]]['fin'];
						$greyQty=$color_wise_bookedQty_arr[$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]][$color_wise_wo_result[csf("fabric_color_id")]][$color_wise_wo_result[csf("po_break_down_id")]]['grey'];
					?>
					<td width='50' align='center' style="font-size:18px">
						<?
                        if($finQty!="")
                        {
                        	echo number_format($finQty,2); $total_fin_fab_qnty+=$finQty;
                        }
                        ?>
					</td>
					<td width='50' align='center' style="font-size:18px" >
						<?
                        if($greyQty!="")
                        {
                            echo number_format($greyQty,2); $total_grey_fab_qnty+=$greyQty;
                        }
                        ?>
					</td>
					<?
                }
                ?>
                <td align="center" style="font-size: 18px"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="center" style="font-size: 18px"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                <td align="center" style="font-size: 18px">
					<?
						if($process_loss_method==1) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
						if($process_loss_method==2) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
						echo number_format($process_percent,2);
                    ?>
                </td>
			</tr>
			<?
        }
        ?>
        <tr style=" font-weight:bold">
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left">&nbsp;</td>
            <th width="120" align="left">&nbsp;</th>
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left"><strong>Total</strong></td>
            <?
            foreach($nameArray_fabric_description as $frow)
            {
				$finTotQty=0; $greyTotQty=0;

				$finTotQty=$color_wiseTotQty_arr[$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['fin'];
				$greyTotQty=$color_wiseTotQty_arr[$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['grey'];

				?>
				<td width='50' align='center'><? echo number_format($finTotQty,2) ;?></td>
				<td width='50' align='center'><? echo number_format($greyTotQty,2);?></td>
				<?
            }
            ?>
            <td align="center"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="center"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="center">
				<?
					if($process_loss_method==1) $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;// markup
					if($process_loss_method==2) $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;//margin
					echo number_format($totalprocess_percent,2);
                ?>
            </td>
        </tr>
        <tr style="font-weight:bold">
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left">&nbsp;</td>
            <th width="120" align="left">&nbsp;</th>
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left"><strong>Cons. For <? echo $costing_per; ?></strong></td>
            <?
            foreach($nameArray_fabric_description as $result_fabric_description)
            {
				?><td width='50' align='right'>&nbsp;</td><td width='50' align='right'>&nbsp;</td><?
            }
            ?>
            <td align="center"><? echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="center"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="center">
				<?
                if($process_loss_method==1) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                if($process_loss_method==2) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                echo number_format($totalprocess_percent_dzn,2);
                ?>
            </td>
        </tr>
    </table>
      <br/>
     <?
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_nos'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($po_id_all) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative; font-family:Arial Narrow;">
					<table width="625" border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)

									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
   ?>
	<br/>

    <table style="margin-top: 10px; font-family:Arial Narrow;" class="rpt_table" width="100%" border="1" cellpadding="5" cellspacing="0" rules="all">
        <tr>
            <td valign="top">
            <?            
            $cos_per_arr=$condition->getCostingPerArr();
            $yarn= new yarn($condition);
            $yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
            $yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
            $yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.job_no,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.job_no,a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");

            ?>
                <table  width="100%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    	<td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                        <td>Sl</td>
                        <td>Yarn Description</td>
                        <td>Brand</td>
                        <td>Lot</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        	?> <td>Rate</td><?
                        }
                        ?>
                        <td>Cons for <? echo $costing_per; ?> Gmts</td>
                        <td>Total (KG)</td>
                    </tr>
                    <?
                    $i=0;
                    $total_yarn=0;
                    foreach($yarn_sql_array  as $row)
                    {
						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td>
                            <?
                            $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
                            $yarn_des.=$color_library[$row[csf('color')]]." ";
                            $yarn_des.=$yarn_type[$row[csf('type_id')]];
                            echo $yarn_des;
                            ?>
                            </td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <?
                            if($show_yarn_rate==1)
                            {
								?><td><? echo number_format($row[csf('rate')],4); ?></td><?
                            }
                            ?>
                            <td><? echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$row[csf("job_no")]],4); ?></td>
                            <td align="right">
                            <? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
						</tr>
						<?
                    }
                    ?>
                    <tr align="center">
                        <td>Total</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        	?><td>&nbsp;</td><?
                        }
                        ?>
                        <td>&nbsp;</td>
                        <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                </table>
        	</td>
			<?
            $color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
            $sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no in('$job_nos')  and d.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
            $result_data=sql_select($sql_stripe);
            foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
            }
            if(count($stripe_arr)>0){
            ?>
            <td>
                <table width="95%" border="1" style="margin:5px; font-family:Arial Narrow;" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                    <caption> <strong style="float:left"> Stripe Details</strong></caption>
                    <tr>
                        <th width="30"> SL</th>
                        <th width="100"> Body Part</th>
                        <th width="80"> Fabric Color</th>
                        <th width="70"> Fabric Qty(KG)</th>
                        <th width="70"> Stripe Color</th>
                        <th width="70"> Stripe Measurement</th>
                        <th width="70"> Stripe Uom</th>
                        <th width="70"> Qty.(KG)</th>
                        <th width="70"> Y/D Req.</th>
                    </tr>
                    <?
                    $i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
                    foreach($stripe_arr as $body_id=>$body_data)
					{
						foreach($body_data as $color_id=>$color_val)
						{
							$rowspan=count($color_val['stripe_color']);
							$composition=$stripe_arr2[$body_id][$color_id]['composition'];
							$construction=$stripe_arr2[$body_id][$color_id]['construction'];
							$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
							$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
							$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];
							$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];
							?>
							<tr>
							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
							<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
							<?
							$total_fab_qty+=$color_qty;
							foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
							{
								$measurement=$color_val['measurement'][$strip_color_id];
								$uom=$color_val['uom'][$strip_color_id];
								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
								?>
								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
								<td align="right"> <? echo  number_format($measurement,2); ?></td>
								<td> <? echo  $unit_of_measurement[$uom]; ?></td>
								<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
								</tr>
								<?
								$total_fabreqtotkg+=$fabreqtotkg;
							}
							$i++;
						}
                    }
                    ?>
                    <tfoot>
                        <tr>
                            <td colspan="3">Total </td>
                            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
                        </tr>
                    </tfoot>
                </table>
            </td>
            <? } ?>

        </tr>
    </table>
	<?
	$yarn_sql_array =array();
		//$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
		$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
		$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
		$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
		$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
		$bookingId=0;
		foreach($sql as $row){
			$bookingId= $row[csf('id')];
		}
		$co=0;
		$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color");
	?>

	<br>
	<table  width="100%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
		<tr>
			<? if(count($yarn_sql_array) >0){ ?>
				<td>
					<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
	                    <tr align="center">
	                        <td colspan="7"><b>Allocated Yarn</b></td>
	                    </tr>
	                    <tr align="center">
	                        <th>Sl</th>
	                        <th>Yarn Description</th>
	                        <th>Brand</th>
	                        <th>Lot</th>
	                        <th>Allocated Qty (Kg)</th>
	                    </tr>
	                    <?
						$total_allo=0;
						$i=0;
						$total_yarn=0;
						foreach($yarn_sql_array  as $row)
	                    {
							$i++;
							?>
							<tr align="center">
	                            <td><? echo $i; ?></td>
	                            <td><? echo $item[$row[csf('item_id')]]; ?></td>
	                            <td><? echo $supplier[$row[csf('supplier_id')]]; ?></td>
	                            <td><? echo $row[csf('lot')]; ?></td>
	                            <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
							</tr>
							<?
						}
						?>
						<tr align="center">
	                        <td>Total</td>
	                        <td></td>
	                        <td></td>
	                        <td></td>
	                        <td align="right"><? echo number_format($total_allo,4); ?></td>
                    	</tr>
                	</table>
				</td>
			<? } ?>
			<? if(count($sql_data)>0){ ?>
			<td>
				<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
					<tr align="center">
	                    <td colspan="10"><b>Dyes To Match</b></td>
                    </tr>
                    <tr align="center">
	                    <td>Sl</td>
	                    <td>Item</td>
	                    <td>Body Color</td>
	                    <td>Item Color</td>
	                    <td>Finish Qty.</td>
	                    <td>UOM</td>
                    </tr>
                    <?
                    foreach($sql_data  as $row)
                    {
						$co++;
						?>
	                    <tr>
		                    <td><? echo $co; ?></td>
		                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
		                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
		                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
		                    <td align="right"><? echo $row[csf('qty')];?></td>
		                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
	                    </tr>
	                    <?
					}?>
				</table>
			</td>
			<? } ?>
		</tr>
	</table>


        <?
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_nos' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
		?>
        <br>
		<?
        //echo signature_table(1, $cbo_company_name, "1330px");
        $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
        $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
        ?>
        <table  width="100%" class="rpt_table"   border="1" cellpadding="5" cellspacing="0" rules="all" style="font-family:Arial Narrow;">
        	<tr>
            <td>
            <table  width="95%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <tr>
            <td>
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
            $i=1;
            foreach($data_array as $row){
            ?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
                $i++;
            }
                ?>
            </tbody>
        	</table>
            </td>
            <td>
            	 <table  width="96%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                 <?
                 $nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
				 $nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
				 ?>
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>
                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>
            </td>
            </tr>
        </table>
		  <br/>
        <table  width="100%"  border="0" cellpadding="5" cellspacing="0" style="font-family:Arial Narrow;">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                   <table width="100%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>
                    </tr>
                    <tr align="center">
                    <th>Sl</th>
                    <th>Po NO</th>
                    <th>Ship Date</th>
                    <th>Pre-Cost Qty</th>
                    <th>Mn.Book Qty</th>
                    <th>Sht.Book Qty</th>
                    <th>Smp.Book Qty</th>
                    <th>Tot.Book Qty</th>
                    <th>Balance</th>
                    <th>Comments</th>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
			$costing_per=0;
            if($result[csf("costing_per")]==1) $costing_per=12;
			else if($result[csf("costing_per")]==2) $costing_per=1;
			else if($result[csf("costing_per")]==3) $costing_per=24;
			else if($result[csf("costing_per")]==4) $costing_per=36;
			else if($result[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;

			$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/($costing_per*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");

			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0; $total_booking_qnty_main=0; $total_booking_qnty_short=0; $total_booking_qnty_sample=0; $total_tot_bok_qty=0; $tot_balance=0;

					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td><? if( $balance>0) echo "Less Booking"; else if ($balance<0) echo "Over Booking"; else echo ""; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                </td>

            </tr>
        </table>
        <div style="width: 900px">
        	<div style="width: 400px">
        		<?
	            $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in('$job_nos') and file_type=1");
	            if(count($nameArray_imge)>0){
	                ?>
	                <div id="div_size_color_matrix" style="float:left; font-family:Arial Narrow;">
	                    
	                        <b style="text-align:left">Image </b>
	                        <table width="310">
	                            <tr>
	                                <?
	                                $img_counter = 0;
	                                foreach($nameArray_imge as $result_imge)
	                                {
	                                    ?><td><img src="../../<? echo $result_imge[csf('image_location')]; ?>" width="180" height="150" border="2" /></td><?
	                                    $img_counter++;
	                                }
	                                ?>
	                            </tr>
	                        </table>
	                   
	                </div>
	            <? } ?>
        	</div>
        	<!-- <div style="width: 500px">
        		<?
					$emblishment= new emblishment($condition);
					$emb_qty_arr= $emblishment->getQtyArray_by_jobAndEmbtype();
        			$sql_embelishment = sql_select("SELECT a.emb_name,a.emb_type,b.color_number_id from wo_pre_cost_embe_cost_dtls a join wo_pre_cos_emb_co_avg_con_dtls b on a.id=b.pre_cost_emb_cost_dtls_id where a.job_no='$job_nos'and a.status_active=1 and a.is_deleted=0 group by a.emb_name,a.emb_type,b.color_number_id"); 
        			$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name"  );

        			if(count($sql_embelishment)>0)
					{
						?>
						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr align="center">
						<td colspan="7"><b>Embelishment (Pre Cost)</b></td>

						</tr>
						<tr align="center">
						<th>Sl</th>
						<th>Type</th>
						<th>Color</th>
						<th>Qty</th>

						</tr>
						<?
						//$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$txt_job_no' and status_active=1 and 	is_deleted=0");
						$i=0;
						foreach($sql_embelishment  as $row_embelishment)
						{

							$i++;
						?>
						<tr align="center">
						<td><? echo $i; ?></td>
						<td>
						<?
						if($row_embelishment[csf('emb_name')]==1)
						{
						echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==2)
						{
						echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==3)
						{
						echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==4)
						{
						echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==5)
						{
						echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
						}
						?>

						</td>
						<td>
						<?
							echo $color_library[$row_embelishment[csf('color_number_id')]];
						?>
						</td>
						<td>
						<?
							echo $emb_qty_arr[$job_nos][$row_embelishment[csf('emb_type')]];
						?>
						</td>


						</tr>
						<?
							$total_qty +=$emb_qty_arr[$job_nos][$row_embelishment[csf('emb_type')]]; 
						}
						?>
						<tr>
							<tr>
								<th colspan="3" align="right">Total</th>
								<th align="center"><? echo $total_qty; ?></th>
							</tr>
						</tr>
						</table>
						<?

					}
							?>
        	</div> -->
        </div>
         <br><br><br><br><br>
                <?
		 $sql = sql_select("select designation,name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
	     $count=count($sql);
		$width=1330;
		$td_width=floor($width/$count);
		$standard_width=$count*150;
		if($standard_width>$width) $td_width=150;
		$no_coloumn_per_tr=floor($width/$td_width);
		$col=$count-2;
		$i=1;
		echo '<table width="'.$width.'" style="font-family:Arial Narrow"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom"></td></tr><tr>';
		foreach($sql as $row)
		{
			echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';
			if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
			$i++;
		}
	echo '</tr></table>';
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_print19") // reduce execution time 18019
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
	$fabric_composition=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");

	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');

	$po_arr= sql_select("select a.job_no,a.product_dept,a.total_set_qnty,b.id,b.po_number,MIN(b.po_received_date) as po_received_date, b.pub_shipment_date,b.grouping,sum(b.plan_cut) as plan_cut,sum(b.po_quantity) as po_quantity from wo_po_details_master a,wo_po_break_down b
	 where a.job_no=b.job_no_mst and b.status_active=1 and b.id in(".str_replace("'","",$txt_order_no_id).") group by a.job_no,a.total_set_qnty,a.product_dept,b.id,b.po_number,b.pub_shipment_date,b.grouping");
	
	$po_qnty_tot1=$po_qnty_tot=$tot_po_qnty_tot_pcs=0;
	$internal_ref_no="";
	foreach($po_arr as $row)
	{
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$po_qnty_tot+=$row[csf('po_quantity')];
		$tot_po_qnty_tot_pcs+=$row[csf('po_quantity')]*$row[csf('total_set_qnty')];
		if($internal_ref_no=="") $internal_ref_no=$row[csf('grouping')];else $internal_ref_no.=",".$row[csf('grouping')];
		$intRef[$row[csf('grouping')]]=$row[csf('grouping')];
		$po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
		$prod_dept=$product_dept[$row[csf('product_dept')]];
		$job_no_aarr.=$row[csf('job_no')].',';

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	$job_numbers=implode(",",array_unique(explode(",",$job_nos)));

	$revised_no = return_field_value("revised_no", "wo_booking_mst", "booking_no=$txt_booking_no");

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	//$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;

	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$path = str_replace("'", "", $path);
	if ($path == "") $path = '../../';
	$condition= new condition();
    if(str_replace("'","",$txt_order_no_id) !=''){
        $condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
    }

    $condition->init();

    function f_number_format($val,$after_point=0,$dot='',$null=''){
			if(is_nan($val) || is_infinite($val)){return 0;}
			else if($dot==''){return number_format($val,$after_point);}
			else{return number_format($val,$after_point,$dot,$null);}
	}

	?>									<!--    Header Company Information         -->
	<style type="text/css" media="print">
		@media print {
		  table tr th {
			font-size: 18px;
			font-family: Arial Narrow;
		  }
		  table tr td {
			font-size: 18px;
			font-family: Arial Narrow;
		  }
		}
		
		
	</style>
    <table width="100%" cellpadding="5" style="border:1px solid black; font-family:Arial Narrow" >
        <tr>
            <td width="100">
            	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
            </td>
            <td width="1250">
                <table width="100%" cellpadding="0" cellspacing="0"  >
                    <tr>
                        <td align="center" style="font-size:20px;"><?php echo $company_library[$cbo_company_name]; ?></td>
                        <td rowspan="3" width="250">
                            <span style="font-size:20px"><b> Job No:&nbsp;&nbsp;<?
                            $jobnos=trim($job_numbers);
                            $jobnos=implode(",",array_unique(explode(",",$jobnos)));
                            echo $jobnos; ?></b></span><br>
                            <span style="font-size:20px"><b> Internal Ref.:&nbsp;&nbsp;<?
                            $ref_no=trim($internal_ref_no,"'");
                            $ref_nos=implode(", ",array_unique(explode(",",$ref_no)));
                            echo $ref_nos; ?></b></span><br>
                        <?
                        if($nameArray_approved_row[csf('approved_no')]>1)
                        {
							?>
							<span style="font-size:20px"><b>Revised No.:&nbsp;<?
							echo $nameArray_approved_row[csf('approved_no')]; ?></b></span>
							<span style="font-size:20px"><b>Revised Date.:&nbsp;<?
							echo $nameArray_approved_row[csf('approved_date')]; ?></b></span>
							<?
                        }
                        ?>
						
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="font-size:14px">
                        <?
                        $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
                        if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no"); else $location=""; ?>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="font-size:20px">
                        <strong><? echo $report_title;?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        
    </table>
                <?
				$job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $style_ref_no=""; $inserted_by=""; $currency_id="";
                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.fabric_composition, a.revised_no, a.remarks, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.currency_id, a.pay_mode, a.booking_percent, a.rmg_process_breakdown, a.insert_date, a.inserted_by, a.update_date, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, a.sustainability_standard from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				$po_id_all=$nameArray[0][csf('po_break_down_id')];

				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$inserted_by=$result[csf('inserted_by')];
					$currency_id=$result[csf('currency_id')];
					$booking_percent=$result[csf('booking_percent')];

					$po_no="";
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time[$row_lead_time[csf('date_diff')]]=$row_lead_time[csf('date_diff')];
					}

				  $gmts_item=explode(',',$result[csf('gmts_item_id')]);
				  foreach($gmts_item as $gm_item)
				  {
				  	$gm_item_name.=$garments_item[$gm_item].',';
				  }

				?>
                <table width="100%" style="border:1px solid black; margin-top:1px;font-family:Arial Narrow; font-size:16px" cellpadding="5">
                    <tr>
                        <td colspan="5" valign="top" style="font-size:16px; color:#F00">
                        <?
                        if($result[csf('is_apply_last_update')]==2){ echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]];
                        }
                        else echo "";
                        ?>
                        </td>
                    </tr>
                    <tr>
                        <td width="120"><span style="font-size:16px"><b>Buyer/Agent Name</b></span></td>
                        <td width="225">:&nbsp;<span style="font-size:16px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                        <td width="120" style="font-size:16px"><b>Dept. </b>   </td>
                        <td width="225" style="font-size:16px">:<b><? echo  $prod_dept; ?></b></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Order Qnty </b>   </td>
                        <td style="font-size:16px">:<b><? echo  $tot_po_qnty_tot_pcs;?>&nbsp;Pcs</b></td>
                        <td style="font-size:16px"><b>Garments Item</b>   </td>
                        <td style="font-size:16px">: <b><? echo rtrim($gm_item_name,','); ?></b></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Style Ref.</b></td>
                        <td>:<? echo $result[csf('style_ref_no')]; $style_ref_no=$result[csf('style_ref_no')]; ?></td>
                        <td style="font-size:16px"><b>Style Des.</b></td>
                        <td>:<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>BookingRelease Date</b></td>
                        <td>:
							<?
                            $booking_date=$result[csf('update_date')];
                            if($booking_date=="" || $booking_date=="0000-00-00 00:00:00") $booking_date=$result[csf('insert_date')];
                            echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                            ?>
                        </td>
                        <td style="font-size:16px"><b>Po Received Date</b></td>
                        <td>:<? echo $po_received_date; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Dealing Merchant</b></td>
                        <td>:<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
                        <td style="font-size:16px"><b>Supplier Name</b></td>
                        <td>:
                        <?
                        if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3) echo $company_library[$result[csf('supplier_id')]]; else echo $supplier_name_arr[$result[csf('supplier_id')]];
                        ?>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Delivery Date</b>   </td>
                        <td>:<?  echo change_date_format($result[csf('delivery_date')]);//?> </td>
                        <td style="font-size:16px"><b>Booking No </b>   </td>
                        <td>:<?  echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")";?> </td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Season</b></td>
                        <td>:<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                        <td style="font-size:16px"><b>Attention</b></td>
                        <td>:<? echo $result[csf('attention')]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Lead Time </b></td>
                        <td>:<? echo implode(",",$lead_time); ?></td>
                        <td style="font-size:16px"><b>Sustainability Standard</b></td>
                        <td>:<? echo $sustainability_standard[$result[csf('sustainability_standard')]]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:16px"><b>Remarks</b></td>
                        <td colspan="3" style="word-break:break-all">:<?=$result[csf('remarks')]; ?></td>
                    </tr>
                </table>
           <?
			}


			$country_data=sql_select("select po_break_down_id ,item_number_id, country_ship_date, country_id
			from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active in (1,2,3) 
			group by po_break_down_id ,item_number_id, country_ship_date, country_id order by country_ship_date");
				foreach($country_data  as $row){
					// $po_wise_country_arr[$row[csf('po_break_down_id')]][$row[csf('country_ship_date')]][$row[csf('item_number_id')]][$row[csf('country_id')]]=$country_arr[$row[csf('country_id')]];
					$po_wise_country_arr[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('country_id')]]=$country_arr[$row[csf('country_id')]];
				
				}

				//  echo "<pre>";
				//  print_r($po_wise_country_arr);
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			$emblishment= new emblishment($condition);
			$emb_qty_arr= $emblishment->getQtyArray_by_orderGmtsitemGmtscolorAndEmbname();
			$wash = new wash($condition);
			$wash_qty_arr= $wash->getQtyArray_by_OrderGmtsitemGmtscolorAndEmbname();
			/*echo '<pre>';
			print_r($wash_qty_arr); die;*/

		   ?>
    <br clear="all">
    <caption style="text-align:left"><b>Size and Color Breakdown </b></caption>
    	<table  class="rpt_table" width="100%" rules="all"  border="1">
            <thead>
            	<tr>
                    <td style="border:1px solid black; text-align: center;"><strong>PO Number</strong></td>
                    <td style="border:1px solid black; text-align: center;"><strong>Country Ship Date</strong></td>
                    <td style="border:1px solid black; text-align: center;"><strong>Gmts Item</strong></td>
					<td style="border:1px solid black; text-align: center;"><strong>Country</strong></td>
                    <td style="border:1px solid black; text-align: center;"><strong>&nbsp;Color/Size&nbsp;</strong></td>
				
                    <?
                    foreach($nameArray_size  as $result_size)
                    {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                    <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                    <td style="border:1px solid black; width:50px" align="center"><strong> Ex %</strong></td>
                    <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Printing Qty</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Embroidery Qty</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Gmt Wash Qty</strong></td>
                    <td style="border:1px solid black; width:60px" align="center"><strong> Sp. Work Qty</strong></td>
                </tr>
            </thead>
        	<tbody>
                <?
                $costing_per=""; $costing_per_qnty=0;
				$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
				if($costing_per_id==1)
				{
					$costing_per="1 Dzn"; $costing_per_qnty=12;
				}
				else if($costing_per_id==2)
				{
					$costing_per="1 Pcs"; $costing_per_qnty=1;
				}
				else if($costing_per_id==3)
				{
					$costing_per="2 Dzn"; $costing_per_qnty=24;
				}
				else if($costing_per_id==4)
				{
					$costing_per="3 Dzn"; $costing_per_qnty=36;
				}
				else if($costing_per_id==5)
				{
					$costing_per="4 Dzn"; $costing_per_qnty=48;
				}
                $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                $order_id=explode(",",str_replace("'","",$txt_order_no_id));
   				$m=1;

   				if(count(array_unique(array_filter($gmts_item))))
   				{
   					$item_number_id_cond=where_con_using_array(array_unique(array_filter($gmts_item)),0,"item_number_id");
   				}
   				else{
   					$item_number_id_cond='';
   				}
   				if(count(array_unique(array_filter($order_id))))
   				{
   					$po_id_cond=where_con_using_array(array_unique(array_filter($order_id)),0,"po_break_down_id");
   				}
   				else{
   					$po_id_cond='';
   				}
   				
   				$nameArray_color=sql_select( "select item_number_id, color_number_id,po_break_down_id, country_id,country_ship_date from wo_po_color_size_breakdown where is_deleted=0 and status_active=1 $item_number_id_cond $po_id_cond group by item_number_id, color_number_id,po_break_down_id, country_id,country_ship_date order by color_number_id");
   				//echo  "select item_number_id, color_number_id,po_break_down_id from wo_po_color_size_breakdown where and is_deleted=0 and status_active=1 $item_number_id_cond $po_id_cond group by item_number_id, color_number_id,po_break_down_id order by color_number_id";
   				$po_and_item_wise_color=array();
   				$color_id_arr=array();
   				foreach ($nameArray_color as $row) {
   					$po_item=$row[csf('po_break_down_id')]."***".$row[csf('item_number_id')]."***".$row[csf('country_id')];
   					$po_and_item_wise_color[$po_item][]=$row[csf('color_number_id')];
   					array_push($color_id_arr, $row[csf('color_number_id')]);
					   $po_wise_country_ship_date[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('country_id')]]=$row[csf('country_ship_date')];
   				}
   				//  echo "<pre>";
   				//  print_r($po_and_item_wise_color);
   				// echo "</pre>";
   				if(count(array_unique(array_filter($color_id_arr))))
   				{
   					$color_id_cond=where_con_using_array(array_unique(array_filter($color_id_arr)),0,"color_number_id");
   				}
   				else{
   					$color_id_cond='';
   				}
   				if(count(array_unique(array_filter($size_id_arr))))
   				{
   					$size_id_cond=where_con_using_array(array_unique(array_filter($size_id_arr)),0,"size_number_id");
   				}
   				else{
   					$size_id_cond='';
   				}
   				
   				$nameArray_color_size_qnty=sql_select( "select plan_cut_qnty,order_quantity,color_number_id,size_number_id,po_break_down_id,item_number_id,country_id  from wo_po_color_size_breakdown where status_active=1 and is_deleted =0  $color_id_cond  $item_number_id_cond  $po_id_cond  $size_id_cond group by color_number_id,size_number_id,po_break_down_id,item_number_id,plan_cut_qnty,order_quantity,country_id");
   				//echo "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity,color_number_id,size_number_id,po_break_down_id,item_number_id  from wo_po_color_size_breakdown where status_active=1 and is_deleted =0  $color_id_cond  $item_number_id_cond  $po_id_cond  $size_id_cond group by color_number_id,size_number_id,po_break_down_id,item_number_id";
   				$po_item_color_size_wise=array();
   				foreach ($nameArray_color_size_qnty as $row) {
   					$po_item_color_size_wise[$row[csf('po_break_down_id')]."***".$row[csf('size_number_id')]."***".$row[csf('item_number_id')]."***".$row[csf('color_number_id')]."***".$row[csf('country_id')]]['plan_cut_qnty']+=$row[csf('plan_cut_qnty')];
   					$po_item_color_size_wise[$row[csf('po_break_down_id')]."***".$row[csf('size_number_id')]."***".$row[csf('item_number_id')]."***".$row[csf('color_number_id')]."***".$row[csf('country_id')]]['order_quantity']+=$row[csf('order_quantity')];
   				}
   				// echo "<pre>";
   				// print_r($po_item_color_size_wise);
   				//  echo "</pre>";

				//    	print_r($order_id);

				
   				
                  for($or=0;$or<count($order_id); $or++)
                   {
                       for($c=0;$c<count($gmts_item); $c++)
                       {
						   
						 foreach($po_wise_country_arr[$order_id[$or]][$gmts_item[$c]] as $cId=> $ctry_data){

						// $po_wise_country_arr[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('country_id')]]
                           $item_size_tatal=array(); $item_size_tatal_order=array();
                           $item_grand_total=0; $item_grand_total_order=0;
                          // $nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
                           $po_item=$order_id[$or]."***".$gmts_item[$c]."***".$cId;
						//    echo $po_item;
   						$color_ar=$po_and_item_wise_color[$po_item];
   						//   echo "<pre>";
   						//   print_r($po_wise_country_arr[$order_id[$or]][$gmts_item[$c]]);
   						// echo "<pre>";
                           ?>
                           <?
                           $printing_sub_total=0; $embroy_sub_total=0; $wash_sub_total=0; $sp_sub_total=0;
                           foreach($color_ar as $order_item=>$color_number_id)
                           {
							//    echo count($color_ar)."=>";
                           ?>
                           <tr>
                               <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? echo $po_number_arr[$order_id[$or]]; ?>&nbsp;</td>
                                <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? 
								// echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); 
								echo change_date_format($po_wise_country_ship_date[$order_id[$or]][$gmts_item[$c]][$cId],"dd-mm-yyyy","-"); 
								
								?>&nbsp;</td>
                                 <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? echo $garments_item[$gmts_item[$c]]; ?>&nbsp;</td>
								 <td align="center"  style="border:1px solid black; font-size: 18px">&nbsp;<? echo $ctry_data;?>&nbsp;</td>
                               <td align="center" style="border:1px solid black; font-size: 18px">&nbsp;<? echo $color_library[$color_number_id];?>&nbsp;</td>
							  
                               <?
                               $color_total=0; $color_total_order=0;

                               foreach($nameArray_size  as $result_size)
                               {
   								?>
                                  
                                   <?
								   	$color_size_qnty=$po_item_color_size_wise[$order_id[$or]."***".$result_size[csf('size_number_id')]."***".$gmts_item[$c]."***".$color_number_id."***".$cId];
									   
   								//$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_number_id."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
   							
   								// echo "<pre>";
   								// print_r($color_size_qnty_arr);
   								// echo "</pre>";
   								//$result_color_size_qnty;
   								//foreach($color_size_qnty_arr as $po_size_item_color=>$color_size_qnty)
   								//{
   									?>
   									 <td style="border:1px solid black; text-align:center; width: 35px">
   									<?
   										if($color_size_qnty['plan_cut_qnty']!= "")
   										{
   											 echo f_number_format($color_size_qnty['order_quantity'],0);
   											 $color_total += $color_size_qnty['plan_cut_qnty'] ;
   											 $color_total_order += $color_size_qnty['order_quantity'] ;
   											 $item_grand_total+=$color_size_qnty['plan_cut_qnty'];
   											 $item_grand_total_order+=$color_size_qnty['order_quantity'];
   											 $grand_total +=$color_size_qnty['plan_cut_qnty'];
   											 $grand_total_order +=$color_size_qnty['order_quantity'];
   											 $color_size_qnty_array[$result_size[csf('size_number_id')]][$color_number_id]=$color_size_qnty['plan_cut_qnty'];
   											 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$color_number_id]=$color_size_qnty['order_quantity'];
   											 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
   											 {
   													$size_tatal[$result_size[csf('size_number_id')]]+=$color_size_qnty['plan_cut_qnty'];
   													$size_tatal_order[$result_size[csf('size_number_id')]]+=$color_size_qnty['order_quantity'];
   											 }
   											 else
   											 {
   												$size_tatal[$result_size[csf('size_number_id')]]=$color_size_qnty['plan_cut_qnty'];
   												$size_tatal_order[$result_size[csf('size_number_id')]]=$color_size_qnty['order_quantity'];
   											 }
   											 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
   											 {
   													$item_size_tatal[$result_size[csf('size_number_id')]]+=$color_size_qnty['plan_cut_qnty'];
   													$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$color_size_qnty['order_quantity'];
   											 }
   											 else
   											 {
   												$item_size_tatal[$result_size[csf('size_number_id')]]=$color_size_qnty['plan_cut_qnty'];
   												$item_size_tatal_order[$result_size[csf('size_number_id')]]=$color_size_qnty['order_quantity'];
   											 }
   										}
   										else echo "0";
   									 ?>
   									  </td>
   							<?
   								//}
   								?>
                                 
                                   <?
                               }
							   $pre_cost_cons_dzn_gmts=sql_select("select  job_no, emb_name, emb_type, country,cons_dzn_gmts from wo_pre_cost_embe_cost_dtls   where emb_name in (1,2,3,4)  and job_no='$job_nos' and status_active=1 and is_deleted=0 order by emb_name");

							//    echo "<pre>";
							//    print_r($pre_cost_cons_dzn_gmts);

							// $print_cons_dzn_gmts="";$emb_cons_dzn_gmts="";$wash_cons_dzn_gmts="";$sp_cons_dzn_gmts="";

							 foreach($pre_cost_cons_dzn_gmts as $row){
									if($row[csf('emb_name')]==1){
										$print_cons_dzn_gmts=$row[csf('cons_dzn_gmts')];
									}elseif($row[csf('emb_name')]==2){
										$emb_cons_dzn_gmts=$row[csf('cons_dzn_gmts')];

									}elseif($row[csf('emb_name')]==3){
										$wash_cons_dzn_gmts=$row[csf('cons_dzn_gmts')];

									}elseif($row[csf('emb_name')]==4){
										$sp_cons_dzn_gmts=$row[csf('cons_dzn_gmts')];
									}
							 }

							

                               $excexss_per=($color_total-$color_total_order)/$color_total_order*100;

                            //    $printing_qty = $emb_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][1]*$costing_per_qnty;
                            //    $plan_cut_printing = $printing_qty*$excexss_per/100;
                            //    $printing_plan_cut_qty= $printing_qty+$plan_cut_printing;

                            //    $embrodery_qty= $emb_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][2]*$costing_per_qnty;
                            //    $plan_cut_embrodery = $embrodery_qty*$excexss_per/100;
                            //    $embrodery_plan_cut_qty= $embrodery_qty+$plan_cut_embrodery;

                            //    $wash_qty= $wash_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][3]*$costing_per_qnty;
                            //    $wash_cut_embrodery = $wash_qty*$excexss_per/100;
                            //    $wash_plan_cut_qty= $wash_qty+$wash_cut_embrodery;

                            //    $sp_qty= $emb_qty_arr[$order_id[$or]][$gmts_item[$c]][$color_number_id][4]*$costing_per_qnty;
                            //    $sp_cut_embrodery = $sp_qty*$excexss_per/100;
                            //    $sp_plan_cut_qty= $sp_qty+$sp_cut_embrodery;
							$printing_plan_cut_qty=round($color_total)*$print_cons_dzn_gmts;
							$embrodery_plan_cut_qty=round($color_total)*$emb_cons_dzn_gmts;
							$wash_plan_cut_qty=round($color_total)*$wash_cons_dzn_gmts;
							$sp_plan_cut_qty=round($color_total)*$sp_cons_dzn_gmts;
                               ?>
                               <td style="border:1px solid black; text-align:center;"><? echo f_number_format(round($color_total_order),0); ?></td>
                                <td style="border:1px solid black; text-align:center"><?  echo f_number_format($excexss_per,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo f_number_format(round($color_total),2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo f_number_format($printing_plan_cut_qty,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo f_number_format($embrodery_plan_cut_qty,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo f_number_format($wash_plan_cut_qty,2); ?></td>
                                <td style="border:1px solid black; text-align:center"><? echo f_number_format($sp_plan_cut_qty,2); ?></td>
                           </tr>
                           <?
                           $printing_sub_total +=$printing_plan_cut_qty;
                           $embroy_sub_total +=$embrodery_plan_cut_qty;
                           $wash_sub_total +=$wash_plan_cut_qty;
                           $sp_sub_total +=$sp_plan_cut_qty;
   						$m++;
   						
   						
   						 //if($m==20) break;
                           }
   						
                           ?>
                             <!-- <tr>
                             <td align="center" style="border:1px solid black"><strong></strong></td>
                             <td align="center" style="border:1px solid black"><strong></strong></td>
                             <td align="center" style="border:1px solid black"><strong></strong></td>
							 <td align="center" style="border:1px solid black"><strong></strong></td>
                               <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                               <?
                               foreach($nameArray_size  as $result_size)
                               {
                               ?>
                               <td style="border:1px solid black;  text-align:center; font-size: 18px; width: 53px"><? echo number_format($item_size_tatal_order[$result_size[csf('size_number_id')]],0);  ?></td>
                               <?
                               }
                               ?>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format(round($item_grand_total),0); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($printing_sub_total,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($embroy_sub_total,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($wash_sub_total,2); ?></td>
                               <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo number_format($sp_sub_total,2); ?></td>
                           </tr> -->
                           <?
   						$printing_grand_total += $printing_sub_total;
   						$embroy_grand_total += $embroy_sub_total;
   						$wash_grand_total += $wash_sub_total;
   						$sp_grand_total += $sp_sub_total;
						 }
                       }
   					
                   }
                   
                   
                ?>
                <tr>
                    <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
                </tr>
               
                <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
					<td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                    <?
                    foreach($nameArray_size  as $result_size)
                    {
                        ?>
                        <td style="border:1px solid black;  text-align:center; font-size: 18px; width: 53px"><? echo f_number_format($size_tatal_order[$result_size[csf('size_number_id')]],0);  ?></td>
                        <?
                    }
                    ?>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo f_number_format(round($grand_total_order),0); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo f_number_format($excess_gra_tot,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo f_number_format(round($grand_total),0); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo f_number_format($printing_grand_total,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo f_number_format($embroy_grand_total,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo f_number_format($wash_grand_total,2); ?></td>
                    <td  style="border:1px solid black;  text-align:center; font-size: 18px"><?  echo f_number_format($sp_grand_total,2); ?></td>
                </tr>
            </tbody>
        </table>
      <br/>
       <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:18px;
		 outline: 0;
		 font-family:Arial Narrow;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:18px;
		 outline: 0;
		 font-family:Arial Narrow;
	 }
	 </style>
     <?
	
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	
	$nameArray_fabric_description= sql_select("select a.id,a.item_number_id, a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.item_number_id, a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width,a.id order by a.id,a.body_part_id, b.dia_width");
	// echo "select a.id,a.item_number_id, a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.item_number_id, a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width,a.id order by a.id,a.body_part_id, b.dia_width";die;
	?>
    
	<table class="rpt_table" width="100%"  border="1" cellpadding="5" cellspacing="0" rules="all" style="font-family:Arial Narrow;">
        <tr align="center">
            <th colspan="5" align="left">Body Part</th>
            <?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('body_part_id')]=="") echo "<td  colspan='3'>&nbsp</td>"; else echo "<td colspan='3'>". $body_part[$frow[csf('body_part_id')]]."</td>";
            }
            ?>

            <td rowspan="9" width="50"><p>Total  Finish Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
            <td rowspan="9" width="50"><p>Total Grey Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
            <td rowspan="9" width="50"><p>Process Loss %</p></td>

        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Color Type</th>
			<?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('color_type_id')]=="") echo "<td  colspan='3'>&nbsp</td>"; else echo "<td colspan='3'>". $color_type[$frow[csf('color_type_id')]]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Fabric Construction</th>
			<?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('construction')]=="") echo "<td colspan='3'>&nbsp</td>"; else echo "<td colspan='3'>". $frow[csf('construction')]."</td>";
            }
            ?>
        </tr>
		<tr align="center">
        	<th colspan="5" align="left">Fabric Composition</th>
			<?
            foreach($nameArray_fabric_description  as $frow)
            {
            	if( $frow[csf('determin_id')]=="") echo "<td colspan='3'>&nbsp</td>"; else echo "<td colspan='3'>". $fabric_composition[$lip_yarn_count[$frow[csf('determin_id')]]]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Yarn Composition</th>
			<?
            foreach($nameArray_fabric_description as $frow)
            {
            	if($frow[csf('composition')]=="") echo "<td colspan='3' >&nbsp</td>"; else  echo "<td colspan='3' >".$frow[csf('composition')]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">GSM</th>
			<?
		
            foreach($nameArray_fabric_description  as $frow)
            {
				
            	if( $frow[csf('gsm_weight')]== "") echo "<td colspan='3'>&nbsp</td>"; else echo "<td colspan='3' align='center'>". $frow[csf('gsm_weight')]."</td>";
            }
            ?>
        </tr>
        <!--<tr align="center">
        	<th colspan="5" align="left">Stitch Length</th>
			<?
            /*foreach($nameArray_fabric_description  as $result_fabric_description)
            {
            $determin_id=$result_fabric_description[csf('determin_id')];
            $s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
            if( $result_fabric_description[csf('determin_id')] == "") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>". $s_length."</td>";
            }*/
            ?>
        </tr>-->
        <tr align="center">
        	<th colspan="5" align="left">Dia/Width (Inch)</th>
			<?
			
            foreach($nameArray_fabric_description as $frow)
            {
				
            	if( $frow[csf('dia_width')]=="") echo "<td colspan='3'>&nbsp</td>"; else echo "<td colspan='3' align='center'>".$frow[csf('dia_width')].",".$fabric_typee[$frow[csf('width_dia_type')]]."</td>";
            }
            ?>
        </tr>
        <tr align="center">
        	<th colspan="5" align="left">Consumption For <? echo $costing_per; ?></th>
			<?
            foreach($nameArray_fabric_description as $frow)
            {
            	if( $frow[csf('requirment')]=="") echo "<td colspan='3'>&nbsp</td>"; else echo "<td colspan='3' align='center'> Fin: ".f_number_format($frow[csf('cons')],2).", Grey: ".f_number_format($frow[csf('requirment')],2)."</td>";
            }
            ?>
        </tr>
        <tr>
        	<th colspan="<? echo  count($nameArray_fabric_description)*2+5; ?>" align="left" style="height:30px">&nbsp;</th>
        </tr>
        <tr>
			<th width="120" align="center">Ship Date</th>
            <th width="120" align="center">PO Number</th>            
            <th width="120" align="center">Fabric Color</th>
            <th width="120" align="center">Body Color</th>
            <th width="120" align="center">Lab Dip No</th>
            <?
            foreach($nameArray_fabric_description as $result_fabric_description)
            {
            	echo "<th width='50'>Finish</th><th width='50'>Required Finish Fabric In MTR</th><th width='50' >Gray</th>";
            }
            ?>
        </tr>
        <?
        $gmt_color_library=array();
        $gmt_color_data=sql_select("select gmts_color_id, contrast_color_id,pre_cost_fabric_cost_dtls_id FROM  wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_nos'  and status_active=1 and is_deleted=0");
        foreach( $gmt_color_data as $gmt_color_row)
        {
       		$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
			$gmt_color_library2[$gmt_color_row[csf("pre_cost_fabric_cost_dtls_id")]][$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]].',';
        }
		unset($gmt_color_data);

		$labdip_arr=array();
		$labdip_sql=sql_select("select color_name_id, lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_nos."' and status_active=1 and is_deleted=0 and approval_status=3");
		foreach( $labdip_sql as $labdiprow)
        {
       		$labdip_arr[$labdiprow[csf("color_name_id")]]=$labdiprow[csf("lapdip_no")];
        }
		unset($labdip_sql);

		$color_wise_bookedQty_arr=array(); $color_wiseTotQty_arr=array();
		$color_wise_wo_sql_qnty=sql_select("select a.id,a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, nvl(d.fabric_color_id,0) as fabric_color_id, b.po_break_down_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty
			FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.status_active=1 and a.is_deleted=0");

		foreach( $color_wise_wo_sql_qnty as $qrow)
        {
       		$color_wise_bookedQty_arr[$qrow[csf("id")]][$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]][$qrow[csf("fabric_color_id")]][$qrow[csf("po_break_down_id")]]['fin']+=$qrow[csf("fin_fab_qnty")];
			$color_wise_bookedQty_arr[$qrow[csf("id")]][$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]][$qrow[csf("fabric_color_id")]][$qrow[csf("po_break_down_id")]]['grey']+=$qrow[csf("grey_fab_qnty")];

			$color_wiseTotQty_arr[$qrow[csf("id")]][$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]]['fin']+=$qrow[csf("fin_fab_qnty")];
			$color_wiseTotQty_arr[$qrow[csf("id")]][$qrow[csf("item_number_id")]][$qrow[csf("body_part_id")]][$qrow[csf("color_type_id")]][$qrow[csf("construction")]][$qrow[csf("composition")]][$qrow[csf("gsm_weight")]][$qrow[csf("dia_width")]]['grey']+=$qrow[csf("grey_fab_qnty")];
        }
		unset($color_wise_wo_sql_qnty);

        $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;

        $color_wise_wo_sql=sql_select("select fabric_color_id,  po_break_down_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by po_break_down_id, fabric_color_id order by po_break_down_id");

       
		foreach($color_wise_wo_sql as $color_wise_wo_result)
        {

			$date=change_date_format($po_ship_date_arr[$color_wise_wo_result[csf('po_break_down_id')]],"dd-mm-yyyy","-");
			$po_num=$po_number_arr[$color_wise_wo_result[csf('po_break_down_id')]];
			if($color_wise_wo_result[csf('fabric_color_id')]=='') $color_wise_wo_result[csf('fabric_color_id')]=0;
			
			$color=$color_library[$color_wise_wo_result[csf('gmts_color_id')]];
			$labdip=$labdip_arr[$color_wise_wo_result[csf('fabric_color_id')]];
			$shipdate_po_arr[$date][$po_num]=$po_num;
			//$shipdate_color_arr[$date][$color_wise_wo_result[csf('fabric_color_id')]]=$color;
			$shipdate_lab_arr[$date][$labdip]=$labdip;

			foreach($nameArray_fabric_description as $frow)
			{
				$finQty=0; $greyQty=0;
				
				$color_id=0;
				if(!empty($color_wise_wo_result[csf("fabric_color_id")]))
				{
					$color_id=$color_wise_wo_result[csf("fabric_color_id")];
				}
				$gmt_color=rtrim($gmt_color_library2[$frow[csf("id")]][$color_id],',');
				$gmt_colors=implode(",",array_unique(explode(",",$gmt_color)));
				
				$shipdate_color_arr[$date][$color_id]=$gmt_colors;
				
				$finQty=$color_wise_bookedQty_arr[$frow[csf("id")]][$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]][$color_id][$color_wise_wo_result[csf("po_break_down_id")]]['fin'];
				$greyQty=$color_wise_bookedQty_arr[$frow[csf("id")]][$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]][$color_id][$color_wise_wo_result[csf("po_break_down_id")]]['grey'];
				$shipdate_arr[$date][$color_id]['fin_qty']+=$finQty;
				$shipdate_qty_arr[$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['fin_qty']+=$finQty;
				$shipdate_qty_arr[$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['grey_qty']+=$greyQty;
				
				$shipdate_qty_cal_arr[$frow[csf("id")]][$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['grey_qty']+=$greyQty;
				$shipdate_qty_cal_arr[$frow[csf("id")]][$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['fin_qty']+=$finQty;


					$dia_with=$frow[csf('dia_width')];
					$gsm=$frow[csf('gsm_weight')];
					$finfab_qty_mtr=($finQty*1000)/($dia_with*0.0254*$gsm);
                	// echo number_format($finfab_qty_mtr,2); $total_finfab_qty_mtr+=$finfab_qty_mtr;
					$shipdate_arr[$date][$color_id]['fin_qty_mtr']+=$finfab_qty_mtr;
					$shipdate_qty_arr[$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("construction")]]['fin_qty_mtr']+=$finfab_qty_mtr;
            }

	}

		// echo "<pre>";
		// print_r($shipdate_qty_arr);
		$datespan=array();
		foreach($shipdate_arr as $date=>$date_wise)
        {
        	$sp=0;
        	foreach ($date_wise as $color_id => $color_wise) 
        	{
        		$sp++;
        	}
        	$datespan[$date]=$sp;

        }

		foreach($shipdate_arr as $date=>$date_wise)
        {
        	$sp=0;
        	foreach ($date_wise as $color_id => $color_wise) 
        	{
        		$sp++;
				?>
				<tr>
					<?php if ($sp==1): ?>
						
						<td width="120" align="left" rowspan="<?=$datespan[$date];?>"><? echo $date ?></td>
					<?php endif ?>
	                <td width="120" align="left"><? echo implode(",",$shipdate_po_arr[$date]); ?></td>                
	                <td width="120" align="left"><? echo $color_library[$color_id]; ?></td>
	                <td><? echo $shipdate_color_arr[$date][$color_id];//implode(",",$shipdate_color_arr[$date][$color_id]); ?></td>
	                <td width="120" align="left"><?  echo implode(",",$shipdate_lab_arr[$date]); ?></td>
						<?
	                    $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;

	                    foreach($nameArray_fabric_description as $frow)
	                    {
							$finQty=0; $greyQty=0;
							//$finQty=$shipdate_qty_arr[$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['fin_qty'];
							//$greyQty=$shipdate_qty_arr[$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['grey_qty'];
							$greyQty=$shipdate_qty_cal_arr[$frow[csf("id")]][$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['grey_qty'];
							$finQty=$shipdate_qty_cal_arr[$frow[csf("id")]][$date][$color_id][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['fin_qty'];
							$dia_with=$frow[csf('dia_width')];$gsm=$frow[csf('gsm_weight')];
							$finfab_qty_mtr=($finQty*1000)/($dia_with*0.0254*$gsm);
						?>
						<td width='50' align='center' style="font-size:18px"><?   echo f_number_format($finQty,2); $total_fin_fab_qnty+=$finQty;	?></td>
						<td width='50' align='center' style="font-size:18px"><?   echo f_number_format($finfab_qty_mtr,2); $total_finfab_qty_mtr+=$finfab_qty_mtr; ?></td>
						<td width='50' align='center' style="font-size:18px" ><?  echo f_number_format($greyQty,2); $total_grey_fab_qnty+=$greyQty; ?></td>
						<?
	                }
	                ?>
	                <td align="center" style="font-size: 18px"><? echo f_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
					<!-- <td align="center" style="font-size: 18px"><? echo f_number_format($total_finfab_qty_mtr,2); $grand_total_finfab_qty_mtr+=$total_finfab_qty_mtr;?></td> -->
	                <td align="center" style="font-size: 18px"><? echo f_number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
	                <td align="center" style="font-size: 18px">
						<?
							if($process_loss_method==1) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
							if($process_loss_method==2) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							echo f_number_format($process_percent,2);
	                    ?>
	                </td>
				</tr>
				<?
			}
        }
        ?>
        <tr style=" font-weight:bold">
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left">&nbsp;</td>
            <th width="120" align="left">&nbsp;</th>
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left"><strong>Total</strong></td>
            <?
            foreach($nameArray_fabric_description as $frow)
            {
				$finTotQty=0; $greyTotQty=0;
				$finTotQty_mtr=0;
				$finTotQty=$color_wiseTotQty_arr[$frow[csf("id")]][$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['fin'];
				$greyTotQty=$color_wiseTotQty_arr[$frow[csf("id")]][$frow[csf("item_number_id")]][$frow[csf("body_part_id")]][$frow[csf("color_type_id")]][$frow[csf("construction")]][$frow[csf("composition")]][$frow[csf("gsm_weight")]][$frow[csf("dia_width")]]['grey'];

				if($finQty!="")
				{
					$dia_with=$frow[csf('dia_width')];
					$gsm=$frow[csf('gsm_weight')];
					$finTotQty_mtr+=($finTotQty*1000)/($dia_with*0.0254*$gsm);
				}
				?>
				<td width='50' align='center'><? echo f_number_format($finTotQty,2) ;?></td>
				<td width='50' align='center'><? echo f_number_format($finTotQty_mtr,2) ;?></td>
				<td width='50' align='center'><? echo f_number_format($greyTotQty,2);?></td>
				<?
            }
            ?>
            <td align="center"><? echo f_number_format($grand_total_fin_fab_qnty,2);?></td>
			<!-- <td align="center"><? echo f_number_format($grand_total_finfab_qty_mtr,2);?></td> -->
            <td align="center"><? echo f_number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="center">
				<?
					if($process_loss_method==1) $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;// markup
					if($process_loss_method==2) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
						echo f_number_format($process_percent,2);
                ?>
            </td>
        </tr>
        <tr style="font-weight:bold">
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left">&nbsp;</td>
            <th width="120" align="left">&nbsp;</th>
            <td width="120" align="left">&nbsp;</td>
            <td width="120" align="left"><strong>Cons. For <? echo $costing_per; ?></strong></td>
            <?
            foreach($nameArray_fabric_description as $result_fabric_description)
            {
				?><td width='50' align='right'>&nbsp;</td><td width='50' align='right'>&nbsp;</td><td width='50' align='right'>&nbsp;</td><?
            }
            ?>
            <td align="center"><? echo f_number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="center"><? echo f_number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="center">
				<?
                if($process_loss_method==1) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                if($process_loss_method==2) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                echo f_number_format($totalprocess_percent_dzn,2);
                ?>
            </td>
        </tr>
    </table>
      <br/>
     <?
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_nos'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($po_id_all) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative; font-family:Arial Narrow;">
					<table width="625" border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)

									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo f_number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo f_number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo f_number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo f_number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo f_number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo f_number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
   ?>
	<br/>

    <table style="margin-top: 10px; font-family:Arial Narrow;" class="rpt_table" width="100%" border="1" cellpadding="5" cellspacing="0" rules="all">
        <tr>
            <td valign="top" width="45%" style="float: left;">
            <?            
            $cos_per_arr=$condition->getCostingPerArr();
            $yarn= new yarn($condition);
            $yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
            $yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
            $yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.job_no,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.job_no,a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");

            ?>
                <table  width="100%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    	<td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                        <td>Sl</td>
                        <td>Yarn Description</td>
                        <td>Brand</td>
                        <td>Lot</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        	?> <td>Rate</td><?
                        }
                        ?>
                        <td>Cons for <? echo $costing_per; ?> Gmts</td>
                        <td>Total (KG)</td>
                    </tr>
                    <?
                    $i=0;
                    $total_yarn=0;
                    foreach($yarn_sql_array  as $row)
                    {
						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td>
                            <?
                            $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
                            $yarn_des.=$color_library[$row[csf('color')]]." ";
                            $yarn_des.=$yarn_type[$row[csf('type_id')]];
                            echo $yarn_des;
                            ?>
                            </td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <?
                            if($show_yarn_rate==1)
                            {
								?><td><? echo f_number_format($row[csf('rate')],4); ?></td><?
                            }
                            ?>
                            <td><? echo f_number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$row[csf("job_no")]],4); ?></td>
                            <td align="right">
                            <? echo f_number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
						</tr>
						<?
                    }
                    ?>
                    <tr align="center">
                        <td>Total</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        	?><td>&nbsp;</td><?
                        }
                        ?>
                        <td>&nbsp;</td>
                        <td align="right"><? echo f_number_format($total_yarn,4); ?></td>
                    </tr>
                </table>
        	</td>
					<?php 

       		 				$sql_purchase="SELECT a.booking_no, a.uom, sum(b.fin_fab_qnty) as qnty , b.construction, b.copmposition, b.gsm_weight as dia, b.dia_width as gsm from wo_booking_mst a, wo_booking_dtls b where     a.booking_no = b.booking_no and a.fabric_source = 2 and b.job_no =$txt_job_no and b.status_active = 1 and b.is_deleted = 0 and a.status_active = 1 and a.is_deleted = 0 and  a.booking_type=1 group by a.booking_no, a.uom, b.construction, b.copmposition, b.dia, b.gsm_weight, b.dia_width"; 
       		 				//echo $sql_purchase;
							$purchase_res=sql_select($sql_purchase);
						if(count($purchase_res)>0){
							?>
			<td width="45%" style="float: left;">
       		 			
							<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <thead>
				                   <tr align="center">
				                    	<th colspan="5"><b>Purchased Booking Info</b></th>
				                    </tr>
				                    <tr align="center">
					                    <th>Sl</th>
					                    <th>Booking No</th>
					                    <th>Fabric Data</th>
					                    <th>UOM</th>
					                    <th>Qnty</th>
					                   
				                    </tr>
 			                   </thead>
 			                   <tbody>
 			                   		<?
												$p=1;
 			                   			foreach ($purchase_res as  $row) 
 			                   			{
 			                   				?>
 			                   				<tr>
 			                   					<td><?=$p;?></td>
 			                   					<td><p><?=$row[csf('booking_no')];?></p></td>
 			                   					<td><p><?=$row[csf('construction')] .", ".$row[csf('copmposition')].", ".$row[csf('gsm')].", ".$row[csf('dia')];?></p></td>
 			                   					<td><p><?=$unit_of_measurement[$row[csf('uom')]];?></p></td>
 			                   					<td><p><?=number_format($row[csf('qnty')],2);?></p></td>
 			                   				</tr>
 			                   				<?
 			                   			$p++;}


 			                   		?>
 			                   </tbody>
 			                   
 			            </table>

       		 			 
       		 		</td>
					<?
						}
            $color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
            $sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no in('$job_nos')  and d.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
            $result_data=sql_select($sql_stripe);
            foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
            }
			
            if(count($stripe_arr)>0){
            ?>
            <td width="45%" style="float: right;">
                <table width="95%" border="1" style="margin:5px; font-family:Arial Narrow;" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                    <caption> <strong style="float:left"> Stripe Details</strong></caption>
                    <tr>
                        <th width="30"> SL</th>
                        <th width="100"> Body Part</th>
                        <th width="80"> Fabric Color</th>
                        <th width="70"> Fabric Qty(KG)</th>
                        <th width="70"> Stripe Color</th>
                        <th width="70"> Stripe Measurement</th>
                        <th width="70"> Stripe Uom</th>
                        <th width="70"> Qty.(KG)</th>
                        <th width="70"> Y/D Req.</th>
                    </tr>
                    <?
                    $i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
                    foreach($stripe_arr as $body_id=>$body_data)
					{
						foreach($body_data as $color_id=>$color_val)
						{
							$rowspan=count($color_val['stripe_color']);
							$composition=$stripe_arr2[$body_id][$color_id]['composition'];
							$construction=$stripe_arr2[$body_id][$color_id]['construction'];
							$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
							$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
							$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];
							$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];
							?>
							<tr>
							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
							<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo f_number_format($color_qty,2); ?></td>
							<?
							$total_fab_qty+=$color_qty;
							foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
							{
								$measurement=$color_val['measurement'][$strip_color_id];
								$uom=$color_val['uom'][$strip_color_id];
								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
								?>
								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
								<td align="right"> <? echo  f_number_format($measurement,2); ?></td>
								<td> <? echo  $unit_of_measurement[$uom]; ?></td>
								<td align="right"> <? echo  f_number_format($fabreqtotkg,2); ?></td>
								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
								</tr>
								<?
								$total_fabreqtotkg+=$fabreqtotkg;
							}
							$i++;
						}
                    }
                    ?>
                    <tfoot>
                        <tr>
                            <td colspan="3">Total </td>
                            <td align="right">  <? echo  f_number_format($total_fab_qty,2); ?> </td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td align="right"><? echo  f_number_format($total_fabreqtotkg,2); ?> </td>
                        </tr>
                    </tfoot>
                </table>
            </td>
            <? } ?>

        </tr>
    </table>
	<?
	$yarn_sql_array =array();
		//$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
		$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
		$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
		$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
		$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
		$bookingId=0;
		foreach($sql as $row){
			$bookingId= $row[csf('id')];
		}
		$co=0;
		$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color");
	?>

	<br>
	<table  width="100%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
		<tr>
			<? if(count($yarn_sql_array) >0){ ?>
				<td>
					<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
	                    <tr align="center">
	                        <td colspan="7"><b>Allocated Yarn</b></td>
	                    </tr>
	                    <tr align="center">
	                        <th>Sl</th>
	                        <th>Yarn Description</th>
	                        <th>Brand</th>
	                        <th>Lot</th>
	                        <th>Allocated Qty (Kg)</th>
	                    </tr>
	                    <?
						$total_allo=0;
						$i=0;
						$total_yarn=0;
						foreach($yarn_sql_array  as $row)
	                    {
							$i++;
							?>
							<tr align="center">
	                            <td><? echo $i; ?></td>
	                            <td><? echo $item[$row[csf('item_id')]]; ?></td>
	                            <td><? echo $supplier[$row[csf('supplier_id')]]; ?></td>
	                            <td><? echo $row[csf('lot')]; ?></td>
	                            <td align="right"><? echo f_number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
							</tr>
							<?
						}
						?>
						<tr align="center">
	                        <td>Total</td>
	                        <td></td>
	                        <td></td>
	                        <td></td>
	                        <td align="right"><? echo f_number_format($total_allo,4); ?></td>
                    	</tr>
                	</table>
				</td>
			<? } ?>
			<? if(count($sql_data)>0){ ?>
			<td>
				<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
					<tr align="center">
	                    <td colspan="10"><b>Dyes To Match</b></td>
                    </tr>
                    <tr align="center">
	                    <td>Sl</td>
	                    <td>Item</td>
	                    <td>Body Color</td>
	                    <td>Item Color</td>
	                    <td>Finish Qty.</td>
	                    <td>UOM</td>
                    </tr>
                    <?
                    foreach($sql_data  as $row)
                    {
						$co++;
						?>
	                    <tr>
		                    <td><? echo $co; ?></td>
		                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
		                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
		                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
		                    <td align="right"><? echo $row[csf('qty')];?></td>
		                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
	                    </tr>
	                    <?
					}?>
				</table>
			</td>
			<? } ?>
		</tr>
	</table>


        <?
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_nos' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
		?>
        <br>
		<?
        //echo signature_table(1, $cbo_company_name, "1330px");
        $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
        $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
        ?>
        <table  width="100%" class="rpt_table"   border="1" cellpadding="5" cellspacing="0" rules="all" style="font-family:Arial Narrow;">
        	<tr>
            <td>
            <table  width="95%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <tr>
            <td>
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
            $i=1;
            foreach($data_array as $row){
            ?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
                $i++;
            }
                ?>
            </tbody>
        	</table>
            </td>
            <td>
            	 <table  width="96%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                 <?
                 $nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
				 $nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
				 ?>
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>
                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>
            </td>
            </tr>
        </table>
		  <br/>
        <table  width="100%"  border="0" cellpadding="5" cellspacing="0" style="font-family:Arial Narrow;">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                   <table width="100%"  border="1" cellpadding="5" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>
                    </tr>
                    <tr align="center">
                    <th>Sl</th>
                    <th>Po NO</th>
                    <th>Ship Date</th>
                    <th>Pre-Cost Qty</th>
                    <th>Mn.Book Qty</th>
                    <th>Sht.Book Qty</th>
                    <th>Smp.Book Qty</th>
                    <th>Tot.Book Qty</th>
                    <th>Balance</th>
                    <th>Comments</th>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
			$costing_per=0;
            if($result[csf("costing_per")]==1) $costing_per=12;
			else if($result[csf("costing_per")]==2) $costing_per=1;
			else if($result[csf("costing_per")]==3) $costing_per=24;
			else if($result[csf("costing_per")]==4) $costing_per=36;
			else if($result[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;

			$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/($costing_per*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");

			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0; $total_booking_qnty_main=0; $total_booking_qnty_short=0; $total_booking_qnty_sample=0; $total_tot_bok_qty=0; $tot_balance=0;

					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo f_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo f_number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo f_number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo f_number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo f_number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo f_number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td><? if( $balance>0) echo "Less Booking"; else if ($balance<0) echo "Over Booking"; else echo ""; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo f_number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo f_number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo f_number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo f_number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo f_number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo f_number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                </td>

            </tr>
        </table>
        <div style="width: 900px">
        	<div style="width: 400px">
        		<?
	            $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in('$job_nos') and file_type=1");
	            if(count($nameArray_imge)>0){
	                ?>
	                <div id="div_size_color_matrix" style="float:left; font-family:Arial Narrow;">
	                    
	                        <b style="text-align:left">Image </b>
	                        <table width="310">
	                            <tr>
	                                <?
	                                $img_counter = 0;
	                                foreach($nameArray_imge as $result_imge)
	                                {
	                                    ?><td><img src="../../<? echo $result_imge[csf('image_location')]; ?>" width="180" height="150" border="2" /></td><?
	                                    $img_counter++;
	                                }
	                                ?>
	                            </tr>
	                        </table>
	                   
	                </div>
	            <? } ?>
        	</div>
        	<!-- <div style="width: 500px">
        		<?
					$emblishment= new emblishment($condition);
					$emb_qty_arr= $emblishment->getQtyArray_by_jobAndEmbtype();
        			$sql_embelishment = sql_select("SELECT a.emb_name,a.emb_type,b.color_number_id from wo_pre_cost_embe_cost_dtls a join wo_pre_cos_emb_co_avg_con_dtls b on a.id=b.pre_cost_emb_cost_dtls_id where a.job_no='$job_nos'and a.status_active=1 and a.is_deleted=0 group by a.emb_name,a.emb_type,b.color_number_id"); 
        			$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name"  );

        			if(count($sql_embelishment)>0)
					{
						?>
						<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr align="center">
						<td colspan="7"><b>Embelishment (Pre Cost)</b></td>

						</tr>
						<tr align="center">
						<th>Sl</th>
						<th>Type</th>
						<th>Color</th>
						<th>Qty</th>

						</tr>
						<?
						//$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$txt_job_no' and status_active=1 and 	is_deleted=0");
						$i=0;
						foreach($sql_embelishment  as $row_embelishment)
						{

							$i++;
						?>
						<tr align="center">
						<td><? echo $i; ?></td>
						<td>
						<?
						if($row_embelishment[csf('emb_name')]==1)
						{
						echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==2)
						{
						echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==3)
						{
						echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==4)
						{
						echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
						}
						if($row_embelishment[csf('emb_name')]==5)
						{
						echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
						}
						?>

						</td>
						<td>
						<?
							echo $color_library[$row_embelishment[csf('color_number_id')]];
						?>
						</td>
						<td>
						<?
							echo $emb_qty_arr[$job_nos][$row_embelishment[csf('emb_type')]];
						?>
						</td>


						</tr>
						<?
							$total_qty +=$emb_qty_arr[$job_nos][$row_embelishment[csf('emb_type')]]; 
						}
						?>
						<tr>
							<tr>
								<th colspan="3" align="right">Total</th>
								<th align="center"><? echo $total_qty; ?></th>
							</tr>
						</tr>
						</table>
						<?

					}
							?>
        	</div> -->
        </div>
         <br><br><br><br><br>
                <?
		 $sql = sql_select("select designation,name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
	     $count=count($sql);
		$width=1330;
		$td_width=floor($width/$count);
		$standard_width=$count*150;
		if($standard_width>$width) $td_width=150;
		$no_coloumn_per_tr=floor($width/$td_width);
		$col=$count-2;
		$i=1;
		echo '<table width="'.$width.'" style="font-family:Arial Narrow"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom"></td></tr><tr>';
		foreach($sql as $row)
		{
			echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';
			if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
			$i++;
		}
	echo '</tr></table>';
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_print5") //Rehan for chaity
{
	//extract($_REQUEST);
	extract(check_magic_quote_gpc($_REQUEST));
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "SELECT master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "SELECT id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "SELECT id,color_name from lib_color ", "id", "color_name");
	$supplier_name_arr=return_library_array( "SELECT id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "SELECT id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("SELECT id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "SELECT id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');


	$nameArray_approved=sql_select( "SELECT max(b.approved_no) as approved_no,a.is_approved, count(b.id) as revised_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 group by a.is_approved");
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no,a.is_approved, count(b.id) as revised_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 group by a.is_approved");
	list($nameArray_approved_row)=$nameArray_approved;
	$nameArray_approved_date=sql_select( "select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='".$nameArray_approved_row[csf('approved_no')]."'");
	list($nameArray_approved_date_row)=$nameArray_approved_date;
	$nameArray_approved_comments=sql_select( "select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='".$nameArray_approved_row[csf('approved_no')]."'");
	list($nameArray_approved_comments_row)=$nameArray_approved_comments;


	$job_po_arr=array();
	$ref_no='';$file_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select( "SELECT  a.job_no,a.style_ref_no,b.po_break_down_id,c.po_number,c.grouping,c.file_no  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.file_no ,c.po_number");
	foreach ($nameArray_per_job as $row_per_job)
	{
		$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
		$all_po_id_arr[$row_per_job[csf('po_break_down_id')]]=$row_per_job[csf('po_break_down_id')];
		$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];
		//if($file_no=='') $file_no=$row_per_job[csf('file_no')]; else $file_no.=",".$row_per_job[csf('file_no')];
		$file_no[$row_per_job[csf('file_no')]] = $row_per_job[csf('file_no')];
		$job_arr[$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];

	}

	$job_nos=rtrim($job_no_aarr,',');
	$txt_order_no_id=implode(",",$all_po_id_arr);
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';
	}

	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
 	$nameArray=sql_select( "SELECT a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.fabric_source,a.remarks,a.pay_mode,a.fabric_composition,a.booking_percent from wo_booking_mst a   where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
 	foreach ($nameArray as $result_job)
 	{
 		$booking_date=$result_job[csf('booking_date')];
 		$buyer_id=$result_job[csf('buyer_id')];
 		$currency_id=$result_job[csf('currency_id')];
 		$attention=$result_job[csf('attention')];
 		$delivery_date=$result_job[csf('delivery_date')];
 		$supplier_id=$result_job[csf('supplier_id')];
 		$remarks=$result_job[csf('remarks')];
 		$pay_mode=$result_job[csf('pay_mode')];
 		$booking_percent=$result_job[csf('booking_percent')];
 	}

 	$lapdip_no_sql=sql_select("SELECT job_no_mst, lapdip_no,color_name_id from wo_po_lapdip_approval_info where  job_no_mst in ($job_nos) and status_active = 1 and approval_status = 3 ");
 	foreach($lapdip_no_sql as $key=>$vals)
 	{
 		$lapdip_no_arr[$vals[csf("job_no_mst")]][$vals[csf("color_name_id")]]=$vals[csf("lapdip_no")];
 	}


	?>
	<style>

		@media print
		{
			.page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}
		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
  <div style="width:1310px" align="center">
		<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<tr>
				<td width="100">
					<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
				</td>
				<td width="1250">
					<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
						<tr>
							<td align="center">
								<?php
echo $company_library[$cbo_company_name];
?>
							</td>
							<td rowspan="3" width="250">
								<span><b> Booking No:&nbsp;&nbsp;<? echo trim($txt_booking_no,"'"); ?></b></span><br/>
								<span><b> Booking Date :&nbsp;&nbsp;<? echo change_date_format($booking_date); ?></b></span><br/>
								 <?
								if($nameArray_approved_row[csf('approved_no')]==1 && $nameArray_approved_row[csf('is_approved')]==0){
									?>
                                    <b> Revised No :  <? echo $nameArray_approved_row[csf('revised_no')]; ?></b>
                                      <br/>
                                      Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
                                    <?

								}
								 if($nameArray_approved_row[csf('approved_no')]>1 && $nameArray_approved_row[csf('is_approved')]==0)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('revised_no')];?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1 && ($nameArray_approved_row[csf('is_approved')]==1 || $nameArray_approved_row[csf('is_approved')]==3))
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('revised_no')]-1;?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?

								 }
							  	?>
							</td>
						</tr>
						<tr>
							<td align="center">
								<?
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");

								if($txt_job_no!="")
								{
									$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								}
								else
								{
									$location="";
								}
								foreach ($nameArray as $result)
								{
									$email=$result[csf('email')];
									$city=$result[csf('city')];
									?>
									Email Address: <? echo $email;?>
									Website: <? echo $result[csf('website')]; ?>
									<?
								}
								?>
							</td>
						</tr>
						<tr>
							<td align="center">
								<strong><? if($report_title !=""){ echo $report_title.'-'.$fabric_source[$cbo_fabric_source];}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		<table width="100%" style="border:0px solid black;table-layout: fixed;" >
			<tr>
				<td width="200"><span><b>To </b></span></td>
				<td width="280">&nbsp;<span></span></td>
				<td width="200"><span><b>Buyer</b></span></td>
				<td width="230"><span> :&nbsp;<b><? echo $buyer_name_arr[$buyer_id]; ?></b></span></td>
			</tr>
			<tr>
				<td width="200"><b>Supplier Name</b>   </td>
				<td width="280">:&nbsp;
					<?
					if($pay_mode==5 || $pay_mode==3){
						echo $company_library[$supplier_id];
						$suplier_address=$city.','.$email;
					}
					else{
						echo $supplier_name_arr[$supplier_id];
						$suplier_address=$supplier_address_arr[$supplier_id];
					}
					?>    </td>
					<td width="200"><b>Dealing Marchant</b></td>
					<td width="" colspan="2">:&nbsp;<? echo $dealing_marchants;?></td>
			</tr>
			<tr>
				<td width="200"><b>Address</b></td>
				<td width="280">:&nbsp;<? echo $suplier_address; ?></td>
				<td width="200"><b>Currency </b>   </td>
				<td width="230">:&nbsp;
					<?
					echo $currency[$currency_id];
					?>
				</td>
			</tr>
			<tr>
				<td width="200"><b>Attention</b></td>
				<td  width="280">:&nbsp;<? echo $attention; ?></td>
				<td width="200"><b>Internal Ref. No </b>   </td>
				<td colspan="2">:&nbsp;
					<?
					echo $ref_nos;
					?>
				</td>
			</tr>
			<tr>
				<td width="200"><b>Delivery Date</b></td>
				<td width="280">:&nbsp;<? echo change_date_format($delivery_date); ?></td>
				<td><b>File No</b></td>
				<td>:&nbsp;<? echo implode(', ', $file_no);?></td>
			</tr>
			<tr>
				<td width="200"><b>Remark</b></td>
				<td colspan="4"> :<? echo $remarks;?></td>
			</tr>
	    </table>
	    <?

	    $color_wise_process_loss=sql_select("SELECT  a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.") and b.process_loss_percent>0 group by a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
	    foreach($color_wise_process_loss as $val)
	    {
	    	$loss_arr[$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
	    	$loss_arr[$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
	    }


	    $sql_booking="SELECT  a.job_no,a.id as fabric_cost_dtls_id, a.body_part_id,a.color_type_id as c_type, a.construction, a.composition, a.gsm_weight as gsm, d.dia_width as dia,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,c.style_ref_no,c.job_no_prefix_num,d.fabric_color_id as fab_color,d.gmts_color_id as gmt_color
	    FROM wo_pre_cost_fabric_cost_dtls a,  wo_booking_dtls d,wo_po_details_master c
	    WHERE   a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id  and a.job_no=c.job_no  and d.job_no=c.job_no
	    and d.booking_no =$txt_booking_no and d.job_no in(".$job_nos.") and d.status_active=1 and d.is_deleted=0
	    group by  a.job_no,a.id, a.body_part_id,a.color_type_id, a.construction, a.composition,d.fabric_color_id,d.gmts_color_id, a.gsm_weight, d.dia_width,a.uom,c.style_ref_no,c.job_no_prefix_num  order by a.job_no,d.fabric_color_id ";
	    $result_set=sql_select($sql_booking);
	    foreach( $result_set as $row)
	    {
	    	$body_part_id=$body_part[$row[csf("body_part_id")]];
	    	$uom_data_arr[$row[csf("uom")]]=$unit_of_measurement[$row[csf("uom")]];
	    	$construction=$row[csf("construction")];
	    	$compositions= $row[csf("composition")];
	    	$item_desc=$body_part_id.','.$row[csf("construction")].','.$compositions;


	    	$process_loss=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss'];
	    	$process_loss_method=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss_method'];

	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['uom']=$row[csf("uom")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['job_prefix']=$row[csf("job_no_prefix_num")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['full_job']=$row[csf("job_no")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];

	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['fin_qty']+=$row[csf("fin_fab_qntys")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['grey_qty']+=$row[csf("grey_fab_qntys")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['amounts']=$row[csf("amounts")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['rates']=$row[csf("rates")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss']=$process_loss;
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss_method']=$process_loss_method;
	    }
	    $fab_row_span_arr=array();
	    foreach($fabric_detail_arr as $job_key=>$job_data)
	    {
	    	$desc_rowspan=0;
	    	foreach($job_data as $desc_key=>$desc_data)
	    	{
	    		foreach($desc_data as $gsm_key=>$gsm_data)
	    		{
	    			foreach($gsm_data as $dia_key=>$dia_data)
	    			{
	    				foreach($dia_data as $c_type_key=>$color_data)
	    				{
	    					foreach($color_data as $gmt_color_key=>$gmt_color_data)
	    					{
	    						foreach($gmt_color_data as $fab_color_key=>$val)
	    						{
	    							$desc_rowspan++;
	    						}
	    						$fab_row_span_arr[$job_key]=$desc_rowspan;
	    					}
	    				}
	    			}
	    		}
	    	}
	    }
	foreach($uom_data_arr as $uom_id=>$uom_val)
	{
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >

			<tr>
				<th  width="30" align="center" style="word-break: break-all;word-wrap: break-word;">SL</th>
				<th  width="70" align="center" style="word-break: break-all;word-wrap: break-word;">Job No</th>
				<th  width="120" align="center" style="word-break: break-all;word-wrap: break-word;">Style Ref</th>
				<th  width="120" align="center" style="word-break: break-all;word-wrap: break-word;">Order No</th>
				<th  width="300" align="center" style="word-break: break-all;word-wrap: break-word;">Item Description</th>
				<th  width="50" align="center" style="word-break: break-all;word-wrap: break-word;">GSM</th>
				<th  width="60" align="center" style="word-break: break-all;word-wrap: break-word;">Fabric Dia</th>
				<th  width="80" align="center" style="word-break: break-all;word-wrap: break-word;">Color Type</th>
				<th  width="100" align="center" style="word-break: break-all;word-wrap: break-word;">Gmts Color</th>
				<th  width="100" align="center" style="word-break: break-all;word-wrap: break-word;">Fabric Color</th>
				<th  width="120" align="center" style="word-break: break-all;word-wrap: break-word;">Lab Dip No</th>
				<th  width="50" align="center" style="word-break: break-all;word-wrap: break-word;">UOM</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Finish Fab. Qty</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Grey Fab. Qty</th>
				<th width='80' align="center" style="word-break: break-all;word-wrap: break-word;">Avg Rate</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Amount</th>
			</tr>
			<?
 			$k=$p=1;$total_fin_qty=$total_grey_qty=$total_amount=0;


			foreach($fabric_detail_arr as $job_key=>$job_data)
			{
				$y=1;
				foreach($job_data as $desc_key=>$desc_data)
				{
					foreach($desc_data as $gsm_key=>$gsm_data)
					{
						foreach($gsm_data as $dia_key=>$dia_data)
						{
							foreach($dia_data as $c_type_key=>$color_data)
							{
								foreach($color_data as $gmt_color_key=>$gmt_color_data)
								{
									foreach($gmt_color_data as $fab_color_key=>$val)
									{
										$po_nos=rtrim($job_po_arr[$job_key],',');
										$po_nos=implode(",",array_unique(explode(",",$po_nos)));
										$fab_row_span=$fab_row_span_arr[$job_key];
										$p_loss_method=$val['p_loss_method'];
										$process_loss=$val['p_loss'];
										$labtest_no=$lab_dip_arr[$job_key]['labtest_no'];
										if($process_loss) $process_loss=$process_loss;else $process_loss=0;
		 								if($p_loss_method==1) //markup
										{

											$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/(100+$process_loss));
										}
										else if($p_loss_method==2) //margin
										{
											$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/100);
										}
										if($uom_id==$val['uom'])
										{
											?>
											<tr>
												<?
												if($y==1)
												{
													?>
													<td style="word-break: break-all;word-wrap: break-word;" width="30"  rowspan="<? echo $fab_row_span;?>"><? echo $p; ?></td>
													<td style="word-break: break-all;word-wrap: break-word;" width="70" align="center" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['job_prefix']; ?>&nbsp;</p></td>
													<td style="word-break: break-all;word-wrap: break-word;" width="120" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['style_ref_no']; ?>&nbsp;</p></td>
													<td style="word-break: break-all;word-wrap: break-word;" width="120" rowspan="<? echo $fab_row_span;?>">&nbsp;<p><? echo $po_nos; ?>&nbsp;</p></td>
													<?
												}
												?>
												<td style="word-break: break-all;word-wrap: break-word;" width="300"><p><? echo $desc_key; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="50"><p><? echo $gsm_key; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="60"><p><? echo $dia_key; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="80"><p><? echo $color_type[$c_type_key]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100"><p><? echo $color_library[$gmt_color_key]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100"><p><? echo $color_library[$fab_color_key]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="120"><p><? echo $lapdip_no_arr[$val['full_job']][$fab_color_key]; ?>&nbsp;</p></td>
												<td  style="word-break: break-all;word-wrap: break-word;"width="50"><p><? echo $unit_of_measurement[$val['uom']]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100" align="right" title="(Markup/Margin Method) Process Loss=<? echo $process_loss;?>,Fin Qty=<? echo $val['fin_qty'];?>"><p><? echo number_format($val['fin_qty'],2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100" align="right"><p><? echo number_format($val['grey_qty'],2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="80" align="right"><p><? echo number_format($val['rates'],2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;"width="100" align="right"><p><? echo number_format($val['amounts'],2); ?>&nbsp;</p></td>
											</tr>
											<?
											$k++;$y++;
											$total_fin_qty+=$val['fin_qty'];
											$total_grey_qty+=$val['grey_qty'];
											$total_amount+=$val['amounts'];
										}
							        }
						        }
					        }
				        }
			        }
		        }
				$p++;
	        }
			?>
			<tfoot>
				<tr>
					<th colspan="12" align="right"> Total </th>
					<th align="right"> <? echo number_format($total_fin_qty,2); ?> </th>
					<th align="right"> <? echo number_format($total_grey_qty,2); ?> </th>
					<th align="right"> <? //echo number_format($total_fin_qty,2); ?> </th>
					<th align="right"> <? echo number_format($total_amount,2); ?> </th>
				</tr>
			</tfoot>
		</table>
		<?
    }
	?>
	<br>
		<?
		    $size_lib_arr = return_library_array("select id,size_name from  lib_size ","id","size_name");
		    $color_lib_arr = return_library_array("select id,color_name from  lib_color ","id","color_name");
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "SELECT job_no_mst, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($txt_order_no_id) and status_active=1 and is_deleted =0 group by job_no_mst,color_number_id, size_number_id");
 			$is_collar_cuff_exists=sql_select("SELECT job_no from wo_pre_cost_fabric_cost_dtls where status_active=1 and is_deleted=0 and body_part_id in(2,3) and job_no in ($job_nos) ");
 			foreach($is_collar_cuff_exists as $k=>$v)
 			{
 				$job_wise_collar_cuff[$v[csf("job_no")]]=$v[csf("job_no")];
 			}

 			if(count($is_collar_cuff_exists)>0)
 			{
 				foreach($color_wise_wo_sql_qnty as $row)
 				{
 					if($job_wise_collar_cuff[$row[csf("job_no_mst")]])
 					{
 						$order_plan_qty_arr[$row[csf('job_no_mst')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
 						$order_plan_qty_arr[$row[csf('job_no_mst')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
 						$size_number_id_arr[$row[csf('size_number_id')]]=$row[csf('size_number_id')];
 						$job_no_mst_arr[$row[csf('job_no_mst')]][$row[csf('color_number_id')]]=$row[csf('color_number_id')];
 						$job_no_sizetotal_arr[$row[csf('job_no_mst')]][$row[csf('size_number_id')]]+=$row[csf('order_quantity')];
 						$job_wise_colortotal[$row[csf('job_no_mst')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
 					}
 				}
 			}

			foreach( sql_select($collar_sql_dtls) as $key=>$vals)
			{
				$job_wise_size_collar[$vals[csf("job_no")]][$vals[csf("size_number_id")]]=$vals[csf("qty")];
			}

			foreach($order_plan_qty_arr as $job_no=>$color_number_data)
			{
				$m=0;
				foreach($color_number_data as $color_number_id=>$size_number_data)
				{
					$m++;
					foreach($size_number_data as $size_number_id=>$data)
					{
					}
				}
				$job_wise_span[$job_no]=$m+2;
			}
			$head_col_span=count($size_number_id_arr)+3;

            $colar_percent_size_wise_array=array();
            $colar_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,b.color_number_id,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0");
            $colar_excess_percent_arr=array();
            foreach($colar_percent_size_wise_sql as $colar_percent_size_wise_row)
            {
            	$colar_percent_size_wise_array[$colar_percent_size_wise_row[csf('color_number_id')]][$colar_percent_size_wise_row[csf('gmts_sizes')]]=$colar_percent_size_wise_row[csf('colar_cuff_per')];

            }

            $nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id,c.size_order order by  c.size_order,id");

            if(count($job_no_mst_arr)>0)
            {
	            ?>
	            <div style="float: left;width: 450px;">

	            	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
		            	<tr>
		            		<td><strong>Job No</strong> </td>
		            		<td colspan="<? echo $head_col_span; ?>"> <strong>Collar-Color Size Breakdown in Pcs.</strong></td>
		            	</tr>
		            	<?
		            		$kk=0;
		            		$nn=0;
			            	foreach($job_no_mst_arr as $job_no=>$color_data)
						    {
						    	if($kk==0)
								{
									?>
									<tr>
										<td rowspan="<? echo $job_wise_span[$job_no]; ?>"><? echo $job_no;?></td>
										<td><strong> Size </strong></td>
										 <?
										 foreach($size_number_id_arr as $key=>$val)
										 {
											?>
												<td> <strong><? echo $size_lib_arr[$val]; ?></strong> </td>
											<?
										 }
										 ?>
										 <td rowspan="2"> <strong> Total</strong></td>
										 <td rowspan="2"><strong>Extra %</strong></td>
									</tr>
									<?
								}
								$pp=0;

						    	foreach($color_data as $color_number_id=>$data)
						    	{
								    if($pp==0)
								    {
								    	?>
								    	<tr>
								    		<td><strong>Collar Size</strong> </td>
								    		 <?
								    		 foreach($size_number_id_arr as $key=>$val)
								    		 {
								    		 	?>
								    		 		<td> <? echo $job_wise_size_collar[$job_no][$key]; ?> </td>
								    		 	<?
								    		 }
								    		 ?>

								    	</tr>
								    	<?
								    }
								    $pp++;
								    ?>
						    	<tr>
						    		<td><? echo $color_lib_arr[$data]; ?></td>
						    		 <?
						    		 foreach($size_number_id_arr as $key=>$val)
						    		 {
						    		 	?>
						    		 		<td> <? echo $order_plan_qty_arr[$job_no][$color_number_id][$key]["order"]; ?> </td>
						    		 	<?
						    		 }
						    		 ?>
						    		 <td> <? echo $job_wise_colortotal[$job_no][$color_number_id]; ?> </td>
						    		 <td> <? echo $job_wise_colortotal[$job_no][$color_number_id]["extra"]; ?> </td>
						    	</tr>
						    	<?
						    	}
						    	?>
						    	<tr>
						    	<td colspan="2" align="right"><strong>Size Total</strong></td>
						    	<?
						    		foreach($size_number_id_arr as $key=>$val)
						    		 {
						    		 	?>
						    		 		<td> <? echo $job_no_sizetotal_arr[$job_no][$key]; ?> </td>
						    		 	<?
						    		 }
						    	?>
						    	</tr>
						    	<?
			 			    }
		            	?>
		            	<tr>
		            	</tr>
	            	</table>
	            </div>
	            <div style="float: left;width: 10px;" >&nbsp;</div>
	            <div style="float: left;width: 450px;">
	            	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
		            	<tr>
		            		<td><strong>Job No</strong> </td>
		            		<td colspan="<? echo $head_col_span; ?>"> <strong>Cuff-Color Size Breakdown in Pcs.</strong></td>
		            	</tr>
		            	<?
		            		$kk=0;
		            		$nn=0;
			            	foreach($job_no_mst_arr as $job_no=>$color_data)
						    {
						    	if($kk==0)
								{
									?>
									<tr>
										<td rowspan="<? echo $job_wise_span[$job_no]; ?>"><? echo $job_no;?></td>
										<td><strong> Size </strong></td>
										 <?
										 foreach($size_number_id_arr as $key=>$val)
										 {
											?>
												<td> <strong><? echo $size_lib_arr[$val]; ?></strong> </td>
											<?
										 }
										 ?>
										 <td rowspan="2"><strong>Total</strong></td>
										 <td rowspan="2"><strong>Extra %</strong></td>
									</tr>
									<?
								}
								$pp=0;

						    	foreach($color_data as $color_number_id=>$data)
						    	{
								    if($pp==0)
								    {
								    	?>
								    	<tr>
								    		<td><strong>Collar Size</strong> </td>
								    		 <?
								    		 foreach($size_number_id_arr as $key=>$val)
								    		 {
								    		 	?>
								    		 		<td> <? echo $job_wise_size_collar[$job_no][$key]; ?> </td>
								    		 	<?
								    		 }
								    		 ?>
								    	</tr>
								    	<?
								    }
								    $pp++;
								    ?>
						    	<tr>
						    		<td><? echo $color_lib_arr[$data]; ?></td>
						    		 <?
						    		 foreach($size_number_id_arr as $key=>$val)
						    		 {
						    		 	?>
						    		 		<td> <? echo $order_plan_qty_arr[$job_no][$color_number_id][$key]["order"]; ?> </td>
						    		 	<?
						    		 }
						    		 ?>
						    		 <td> <? echo $job_wise_colortotal[$job_no][$color_number_id]; ?> </td>
						    		 <td> <? echo $job_wise_colortotal[$job_no][$color_number_id]["extra"]; ?> </td>
						    	</tr>
						    	<?
						    	}
						    	?>
						    	<tr>
						    	<td colspan="2" align="right"><strong>Size Total</strong></td>
						    	<?
						    		foreach($size_number_id_arr as $key=>$val)
						    		 {
						    		 	?>
						    		 		<td> <? echo $job_no_sizetotal_arr[$job_no][$key]; ?> </td>
						    		 	<?
						    		 }
						    	?>
						    	</tr>
						    	<?
			 			    }
		            	?>
		            	<tr>
		            	</tr>
	            	</table>
	            </div>
	            <br>
	            <br>
            	<?
       		}

	$condition= new condition();
	if(str_replace("'","",$txt_order_no_id) !='')
	{
		$condition->po_id("in($txt_order_no_id)");
	}

	$condition->init();
	$cos_per_arr=$condition->getCostingPerArr();
	$yarn= new yarn($condition);
	$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
 	$yarn_count_arr=return_library_array( "SELECT id,yarn_count from lib_yarn_count",'id','yarn_count');
 	$po_qnty_tot=return_field_value("sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");

 	if($db_type==0)
 	{
 		$job_listagg=" group_concat(a.job_no) as job_no";
 	}
 	else
 	{

 		$job_listagg=" rtrim(xmlagg(xmlelement(e,a.job_no,',').extract('//text()') order by a.job_no).GetClobVal(),',') as job_no";
 	}
	$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate,$job_listagg    from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no in ($job_nos) and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate ");
	?>
	<br/>
	<br/>
	<br/>
	<table style="margin-top: 10px;" class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
		<tr align="center">
             <td colspan="7"><b>Yarn Required Summary (Pre Cost) </b></td>
        </tr>
        <tr align="center">
        	<td width="25" style="word-wrap: break-word;word-break: break-all;">Sl</td>
        	<td width="400" style="word-wrap: break-word;word-break: break-all;">Yarn Description</td>
        	<td width="60" style="word-wrap: break-word;word-break: break-all;">Brand</td>
        	<td width="60" style="word-wrap: break-word;word-break: break-all;">Lot</td>
        	<td width="50" style="word-wrap: break-word;word-break: break-all;">Rate</td>
        	<td width="120" style="word-wrap: break-word;word-break: break-all;">Cons for Dzn Gmts</td>
        	<td width="110" style="word-wrap: break-word;word-break: break-all;">Total (KG)</td>
        </tr>

        <?
		$i=0;
		$total_yarn=0;
		foreach($yarn_sql_array  as $row)
        {
			if($db_type==2) $row[csf("job_no")]=$row[csf("job_no")]->load();
			$i++;
			$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
			$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];

			$rate=$rowcons_Amt/$rowcons_qnty;
			$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
			$job_no=$row[csf("job_no")];
			$cos_per_value=0;
			foreach($job_arr as $job)
			{
				//echo $job_nos.'DD';
				$cos_per_value=$cos_per_arr[$job];
				$job_no=$job;
			}
			?>
            <tr align="center">
            	<td width="25" style="word-wrap: break-word;word-break: break-all;"><? echo $i; ?></td>

            	<td width="400" style="word-wrap: break-word;word-break: break-all;" align="left">
            		<?
            		$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
            		$yarn_des.=$color_library[$row[csf('color')]]." ";
            		$yarn_des.=$yarn_type[$row[csf('type_id')]];
            		echo $yarn_des;
            		?>
            	</td>
            	<td width="60" style="word-wrap: break-word;word-break: break-all;"></td>
            	<td width="60" style="word-wrap: break-word;word-break: break-all;"></td>
            	<td width="50" style="word-wrap: break-word;word-break: break-all;"><? echo number_format($row[csf('rate')],4);  $cos_per_arr[$job_no].' c'; ?></td>
            	<td width="120" style="word-wrap: break-word;word-break: break-all;"><? echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_value,4);?></td>

            	<td align="right" width="110" style="word-wrap: break-word;word-break: break-all;"><? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
            </tr>
            <?
		}
		?>
       <tr align="center">
	       	<td colspan="6" align="right">Total</td>
	       	<td align="right"><? echo number_format($total_yarn,4); ?></td>
        </tr>
	</table>

	<br>
	<?
	$color_name_arr=return_library_array( "SELECT id,color_name from lib_color",'id','color_name');
	$sql_stripe="SELECT c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom,b.job_no  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no in($job_nos)  and d.job_no in($job_nos) and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width ,b.job_no order by b.job_no ";
	$result_data=sql_select($sql_stripe);
	foreach($result_data as $row)
	{
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['job_no']=$row[csf('job_no')];

	}

	if(count($stripe_arr)>0)
	{
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
			<tr>
	             <td colspan="9" align="center"><b>Stripe Details</b></td>
	        </tr>
	        <tr align="center">
	        	<th width="30"> SL</th>
	        	<th width="50"> Job</th>
	            <th width="100"> Body Part</th>
	            <th width="80"> Fabric Color</th>
	            <th width="70"> Fabric Qty(KG)</th>
	            <th width="70"> Stripe Color</th>
	            <th width="70"> Stripe Measurement</th>
	            <th width="70"> Stripe Uom</th>
	            <th  width="70"> Qty.(KG)</th>
	            <th  width="70"> Y/D Req.</th>
	        </tr>
	        <?
			$i=1;$total_fab_qty=0;
			$total_fabreqtotkg=0;
			$fab_data_array=array();
			$stripe_wise_fabkg_arr=array();

			$stripe_wise_fabkg_sql="SELECT a.job_no,a.body_part_id,a.color_type_id,b.gmts_color_id as fabric_color_id, sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where  a.color_type_id=2 and a.job_no=b.job_no  and b.booking_no=$txt_booking_no
			and a.id=b.pre_cost_fabric_cost_dtls_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no,a.body_part_id,a.color_type_id,b.gmts_color_id";
			foreach(sql_select($stripe_wise_fabkg_sql) as $keys=>$vals)
			{
				$stripe_wise_fabkg_arr[$vals[csf("job_no")]][$vals[csf("body_part_id")]][$vals[csf("color_type_id")]][$vals[csf("fabric_color_id")]] +=$vals[csf("grey_fab_qnty")];
			}
	        foreach($stripe_arr as $body_id=>$body_data)
	        {
				foreach($body_data as $color_id=>$color_val)
				{
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];
					?>
					<tr>
						<?
						$jobs=$stripe_arr2[$body_id][$color_id]['job_no'];

						$color_qty=$stripe_wise_fabkg_arr[$jobs][$body_id][$color_type_id][$color_id];
						?>
						<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $jobs; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
						<?
						//$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						$total_fab_qty+=$color_qty;
						foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
						{
							$measurement=$color_val['measurement'][$strip_color_id];
							$uom=$color_val['uom'][$strip_color_id];
							$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
							$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
							?>
							<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
							<td align="right"> <? echo  number_format($measurement,2); ?></td>
		                    <td> <? echo  $unit_of_measurement[$uom]; ?></td>
							<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
							<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
					</tr>
							<?
							$total_fabreqtotkg+=$fabreqtotkg;
						}
						$i++;
				}
			}
			?>
	        <tfoot>
	        	<tr>
	        		<td colspan="4">Total </td>
	        		<td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
	        		<td></td>
	        		<td></td>
	        		<td>   </td>
	        		<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
	        	</tr>
	        </tfoot>
		</table>
		<?
	}
	?>


	<br/>
    <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
    	<tr align="center">
    		<td colspan="10"><b>Comments</b></td>
    	</tr>
    	<tr align="center">
    		<td>Sl</td>
    		<td width="200" style="word-wrap: break-word;word-break: break-all;">Po NO</td>
    		<td>Ship Date</td>
    		<td>Pre-Cost Qty</td>
    		<td>Mn./PB Book Qty</td>
    		<td>Sht.Book Qty</td>
    		<td>Smp.Book Qty</td>
    		<td>Tot.Book Qty</td>
    		<td>Balance</td>
    		<td>Comments</td>
    	</tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no in($job_nos)", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        	if (count($nameArray)>0 )
        	{
				$costing_per=0;
        		if($result[csf("costing_per")]==1) $costing_per=12;
				else if($result[csf("costing_per")]==2) $costing_per=1;
				else if($result[csf("costing_per")]==3) $costing_per=24;
				else if($result[csf("costing_per")]==4) $costing_per=36;
				else if($result[csf("costing_per")]==5) $costing_per=48;
				else $costing_per=0;

				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/($costing_per*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");

        		$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        	}
        }

        $total_pre_cost=0; $total_booking_qnty_main=0; $total_booking_qnty_short=0; $total_booking_qnty_sample=0; $total_tot_bok_qty=0; $tot_balance=0;
        $booking_qnty_main=return_library_array( "SELECT max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst  and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "SELECT max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst   and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "SELECT max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst   and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "SELECT max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
        foreach($sql_data  as $row)
        {
        	$col++;
        	?>
        	<tr align="center">
        		<td><? echo $col; ?></td>
        		<td style="word-wrap: break-word;word-break: break-all;"><? echo $row[csf("po_number")]; ?></td>
        		<td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        		<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        		<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        		<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        		<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        		<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        		<td align="right">
        			<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        		</td>
        		<td>
        			<?
        			if( $balance>0) echo "Less Booking"; else if ($balance<0) echo "Over Booking"; else echo "";
        			?>
        		</td>
        	</tr>
        	<?
        }
   		 ?>
   		 <tfoot>
   		 	<tr>
   		 		<td colspan="3">Total:</td>
   		 		<td align="right"><? echo number_format($total_pre_cost,2); ?></td>
   		 		<td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
   		 		<td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
   		 		<td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
   		 		<td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
   		 		<td align="right"><? echo number_format($tot_balance,2); ?></td>
   		 		<td></td>
   		 	</tr>
   		 </tfoot>
    </table>


    <fieldset id="div_size_color_matrix" style="max-width:1000;">
		<?
	    //Query for TNA start-
		$po_id_all=str_replace("'","",$txt_order_no_id);
		$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
		$tna_start_sql=sql_select( "select id,po_number_id,
						(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
						(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
						(case when task_number=60 then task_start_date else null end) as knitting_start_date,
						(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
						(case when task_number=61 then task_start_date else null end) as dying_start_date,
						(case when task_number=61 then task_finish_date else null end) as dying_end_date,
						(case when task_number=64 then task_start_date else null end) as finishing_start_date,
						(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
						(case when task_number=84 then task_start_date else null end) as cutting_start_date,
						(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
						(case when task_number=86 then task_start_date else null end) as sewing_start_date,
						(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
						(case when task_number=110 then task_start_date else null end) as exfact_start_date,
						(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
						(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
						(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
						from tna_process_mst
						where status_active=1 and po_number_id in($po_id_all)");
		$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
		$tna_date_task_arr=array();
		foreach($tna_start_sql as $row)
		{
			if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
			{
				if($tna_fab_start=="") $tna_fab_start=$row[csf("fab_booking_start_date")];
			}

			if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
			}
			if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
			}
			if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
			}
			if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
			}

			if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
			}
			if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
			}
			if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
			}
		}
		?>
        <legend>TNA Information</legend>

        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
        	<tr>
        		<td rowspan="2" align="center" valign="top">SL</td>
        		<td width="180" rowspan="2"  align="center" valign="top" style="word-wrap: break-word;word-break: break-all;"><b>Order No</b></td>
        		<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
        		<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
        		<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
        		<td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
        		<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
        		<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
        		<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
        	</tr>
        	<tr>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        	</tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				?>
				<tr>
					<td><? echo $i; ?></td>
					<td style="word-wrap: break-word;word-break: break-all;"><? echo $po_num_arr[$order_id]; ?></td>
					<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
				</tr>
                <?
				$i++;
			}
			?>

        </table>
    </fieldset>
    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
	<br>
	<? echo signature_table(121, $cbo_company_name, "1000px"); ?>
  </div>
	<?
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_islam")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');

	$po_arr= sql_select("select a.job_no,a.product_dept,a.total_set_qnty,b.id,b.po_number,MIN(b.po_received_date) as po_received_date, b.pub_shipment_date,b.grouping,sum(b.plan_cut) as plan_cut,sum(b.po_quantity) as po_quantity from wo_po_details_master a,wo_po_break_down b
	 where a.job_no=b.job_no_mst and b.status_active=1 and b.id in(".str_replace("'","",$txt_order_no_id).") group by a.job_no,a.total_set_qnty,a.product_dept,b.id,b.po_number,b.pub_shipment_date,b.grouping");
	$po_qnty_tot1=$po_qnty_tot=$tot_po_qnty_tot_pcs=0;
	$internal_ref_no="";
	foreach($po_arr as $row)
	{
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$po_qnty_tot+=$row[csf('po_quantity')];
		$tot_po_qnty_tot_pcs+=$row[csf('po_quantity')]*$row[csf('total_set_qnty')];
		if($internal_ref_no=="") $internal_ref_no=$row[csf('grouping')];else $internal_ref_no.=",".$row[csf('grouping')];
		$intRef[$row[csf('grouping')]]=$row[csf('grouping')];
		$po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
		$prod_dept=$product_dept[$row[csf('product_dept')]];
		$job_no_aarr.=$row[csf('job_no')].',';

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	$job_numbers=implode(",",array_unique(explode(",",$job_nos)));

	$revised_no = return_field_value("revised_no", "wo_booking_mst", "booking_no=$txt_booking_no");

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	//$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
	list($nameArray_approved_row) = $nameArray_approved;

	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$path = str_replace("'", "", $path);
	if ($path == "") $path = '../../';

?>				<!--    Header Company Information         -->
<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
           <tr>
               <td width="100">
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>

                <?

				$sample_booking_arr=array();
				$namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
				foreach($namesamplefab as $namesamplefabrow){
					$sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
					$sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
				}
				$sample_booking_no=implode($sample_booking_arr['booking_no']);
				$sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$booking_percent=0;
				$booking_po_id='';
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.inserted_by,a.update_date,a.tagged_booking_no, a.uom,a.pay_mode,a.booking_percent,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season_buyer_wise as season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant,b.order_repeat_no,b.repeat_job_no,a.fabric_composition,a.remarks from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
                foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$booking_uom=$result[csf('uom')];
					$booking_percent=$result[csf('booking_percent')];
					$po_no="";
					$booking_po_id=$result[csf('po_break_down_id')];
					$inserted_by=$result[csf('inserted_by')];
					$shipment_date="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
					}
					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff, DATEDIFF(pub_shipment_date,factory_received_date) as facdate_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff, (pub_shipment_date-factory_received_date) as  facdate_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					$cbdlead_time="";
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
						$cbdlead_time.=$row_lead_time[csf('facdate_diff')].",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
					}

					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

						if($rows[csf('shiping_status')]==1)
						{
						$shiping_status.= "FP".",";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						$shiping_status.= "PS".",";
						}
						else if($rows[csf('shiping_status')]==3)
						{
						$shiping_status.= "FS".",";
						}

					}

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");

				?>
       <table width="100%" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:16px;"><b>Dept. <? if($result[csf('product_code')] !=""){ echo " (Prod Code)";} if($result[csf('pro_sub_dep')] !=0){ echo " (Sub Dep)";} ?></b></span></td>
                <td width="110" style="font-size:16px;">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:16px;"><b>Order Qnty</b></span></td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:16px;"><b>Garments Item</b></td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:16px;"><b>Booking Release Date</b></td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
				}
				$booking_date=$result[csf('insert_date')];
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td  width="100" style="font-size:16px;"><b>Style Des.</b></td>
                <td  width="110"style="font-size:16px;" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:16px"><b>Lead Time </b>   </td>
                <td width="110" style="font-size:16px;">:&nbsp;<?  echo rtrim($lead_time,",");?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchant</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td width="100" style="font-size:16px;"><b>Supplier Name</b>   </td>
                <td width="110" style="font-size:16px;">:&nbsp;
				<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
				echo $company_library[$result[csf('supplier_id')]];
				}
				else{
				echo $supplier_name_arr[$result[csf('supplier_id')]];
				}
				?>    </td>
                <td width="100" style="font-size:16px;"><b>Delivery Date</b></td>
               	<td width="110" style="font-size:16px;">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>

                  <?
				if($db_type==0)
				{
					$last_update_date=return_field_value("max(date(update_date)) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
				}
				else
				{
					$last_update_date=return_field_value("max(to_char(update_date,'DD-MM-YYYY')) as update_date","wo_booking_dtls","status_active=1 and is_deleted=0 and booking_no=$txt_booking_no","update_date");
				}
				?>


            </tr>
            <tr>
                <td width="100" style="font-size:16px;"><b>Season</b></td>
                <td width="110" style="font-size:16px;">:&nbsp;<? echo $season_name_arr[$result[csf('season')]]; ?></td>
                <td  width="100" style="font-size:16px"><b>Last Update Date</b></td>
                <td width="100" style="font-size:18px">:&nbsp;<b><? if($last_update_date!="" && $last_update_date!="0000-00-00") echo change_date_format($last_update_date);?></b></td>
                <td  width="100" style="font-size:16px;"><b>Po Received Date</b></td>
                <td  width="110" style="font-size:16px;">:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Order No</b></td>
               <td width="110" style="font-size:18px" colspan="5">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>

            </tr>
            <tr>
               <td width="100" style="font-size:16px;"><b>Shipment Date</b></td>
                <td width="110" colspan="5" style="font-size:16px;"> :&nbsp;<? echo rtrim($shipment_date,", "); ?></td>

            </tr>

            </tr>
            <tr>
               <td width="100" style="font-size:16px;"><b>WO Prepared After</b></td>
               <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($WOPreparedAfter,',').' Days' ?></td>

               <td width="100" style="font-size:12px;"><b>Ship.days in Hand</b></td>
               <td width="110" style="font-size:16px;"> :&nbsp;<? echo rtrim($daysInHand,',').' Days'?></td>

               <td width="100" style="font-size:12px"><b>Ex-factory status</b></td>
               <td width="110"> :&nbsp;<? echo rtrim($shiping_status,','); ?></td>

            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Internal Ref No</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>

               <td width="100" style="font-size:18px"><b>File no</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
               <td width="100" style="font-size:18px"><b>Order Repeat No</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $result[csf('order_repeat_no')];?></b></td>
            </tr>
             <tr>
               <td width="100" style="font-size:18px"><b>Remarks</b></td>
               <td style="font-size:18px" colspan="3"> :<? echo $result[csf('remarks')]?></td>
               <td width="100" style="font-size:18px"><b>Order Repeat Job No</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><? echo  $result[csf('repeat_job_no')];?></b></td>
          </tr>

           <tr>
               <td width="130" style="font-size:18px"><b>Fabric Composition</b></td>
               <td style="font-size:18px" colspan="3"> :<? echo $result[csf('fabric_composition')]?></td>
               <td width="100" style="font-size:18px"><b>CBD Lead Time</b></td>
               <td width="110" style="font-size:18px"> :&nbsp;<b><?  echo rtrim($cbdlead_time,","); ?></b></td>
          </tr>
           <tr>
               <td width="130" style="font-size:18px"><b>Attention</b></td>
               <td style="font-size:18px" colspan="5"> : &nbsp; <? echo $result[csf('attention')]?></td>
          </tr>



            <?php if ($sample_booking_no != '') {?>
                <tr>
                    <td colspan="5" align="center">
                  <strong> <? echo "Fabric of Sample Fabric Booking No:".$sample_booking_no.", Total Fabric=".$sample_booking_qty." KG,
will be Dyed with this fabric."; ?> </strong>
                    </td>
                </tr>
            <?php }?>

        </table>
           <?
			}

			$nameArray_artl=sql_select( "select  po_break_down_id as po_id,color_number_id,article_number from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  is_deleted=0 and status_active=1 group by po_break_down_id,article_number,color_number_id order by po_break_down_id");
			foreach($nameArray_artl as $row)
			{
				$po_article_arr[$row[csf('po_id')]][$row[csf('color_number_id')]].=$row[csf('article_number')].',';
			}

			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			$po_id_all=str_replace("'","",$txt_order_no_id);
		   ?>
             <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown </legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>PO Number</strong></td>
                        <td style="border:1px solid black"><strong>Article No</strong></td>
                        <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
					$order_id=explode(",",str_replace("'","",$txt_order_no_id));
					for($or=0;$or<count($order_id); $or++)
				    {
						for($c=0;$c<count($gmts_item); $c++)
					    {
							$item_size_tatal=array(); $item_size_tatal_order=array();
							$item_grand_total=0; $item_grand_total_order=0;
							$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 order by color_number_id");
							?>
		                    <?
							foreach($nameArray_color as $result_color)
		                    {
								$article_no=rtrim($po_article_arr[$order_id[$or]][$result_color[csf('color_number_id')]],',');
								$article_nos=implode(",",array_unique(explode(",",$article_no)));
		                    ?>
		                    <tr>
		                        <td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
		                         <td align="center" style="border:1px solid black"><? echo $article_nos; // echo $row_num_tr; ?></td>
		                          <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
		                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
		                        <?
								$color_total=0; $color_total_order=0;

								foreach($nameArray_size  as $result_size)
								{
								$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
								foreach($nameArray_color_size_qnty as $result_color_size_qnty)
		                        {

		                        ?>
		                            <td style="border:1px solid black; text-align:right">
									<?
										if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
										{
											 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
											 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
											 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
											 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
										     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
											 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
											 {
													$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
											 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
											 {
													$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
										}
										else echo "0";
									 ?>
									</td>
		                    <?
								}
		                        }
		                        ?>
		                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
		                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
		                         <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
		                    </tr>
		                    <?
		                    }

						}
					}
                    ?>

                    <tr>
                    <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
             </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
            	<?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
					?>
					<tr>
                        <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?> </td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
					?>
					<tr>
                        <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                        <td align="right"><?  echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
					?>
					<tr>
                        <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
					?>
					<tr>
                        <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                        <td align="right"><?  echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
					?>
					<tr>
                        <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
					?>
					<tr>
                        <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
					?>
					<tr>
                        <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
					</tr>
					<?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
					?>
					<tr>
                        <td width="130">Others <!-- New breack Down 11--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
					</tr>
					<?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Sub Total <!-- New breack Down 11--></td>
                        <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
					</tr>
					<?
				}
				?>
                </table>
                </fieldset>
                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
					?>
					<tr>
                        <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
					?>
					<tr>
                        <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
					?>
					<tr>
                        <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
					?>
					<tr>
                        <td width="130">All Over Print <!-- new  breack Down 13--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
					?>
					<tr>
                        <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
					?>
					<tr>
                        <td width="130">Dying   <!-- breack Down 7--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
					?>
					<tr>
                        <td width="130"> Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
					</tr>
					<?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
					?>
					<tr>
                        <td width="130">Others  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
					</tr>
					<?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
					</tr>
					<?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
					?>
					<tr>
                        <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                        <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
					</tr>
					<?
				}
				?>
           </table>
         	  </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in('$job_nos') and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
					?>
					<td><img src="../../<? echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" /></td>
					<?
					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
      <br/>
       <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	 </style>
     <?
	 $costing_per=""; $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
	 if($costing_per_id==1)
	{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;
	}
	if($costing_per_id==2)
	{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;
	}
	if($costing_per_id==3)
	{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;
	}
	if($costing_per_id==4)
	{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;
	}
	if($costing_per_id==5)
	{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	$nameArray_fabric_description= sql_select("select a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width");
?>
      <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="4" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else  echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total  Finish Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
        <td  rowspan="10" width="50"><p>Total Grey Fabric <?  echo $unit_of_measurement[$cons_uom]; ?></p></td>
        <td  rowspan="10" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="4" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else  echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="4" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th   colspan="4" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if($result_fabric_description[csf('composition')]=="") echo "<td colspan='2' >&nbsp</td>"; else  echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>
       </tr>
       <tr align="center"><th  colspan="4" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')]== "") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>
       </tr>
       <tr align="center"><th  colspan="4" align="left">Stitch Length</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			$determin_id=$result_fabric_description[csf('determin_id')];
			$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
			if( $result_fabric_description[csf('determin_id')] == "") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>". $s_length."</td>";
		}
		?>
       </tr>
       <tr align="center"><th   colspan="4" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>
       </tr>
       <tr align="center"><th   colspan="4" align="left">Consumption For <? echo $costing_per; ?></th>
         <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')]=="") echo "<td colspan='2'>&nbsp</td>"; else echo "<td colspan='2' align='center'>  Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
		}
		?>
       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+4; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>
       <tr>
            <th  width="120" align="left">PO Number</th>
            <th  width="120" align="left">Article No</th>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <!--<th  width="120" align="left">Lab Dip No</th>-->
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
		}
		?>
       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id, contrast_color_id FROM  wo_pre_cos_fab_co_color_dtls WHERE job_no ='$job_nos'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	      $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
		$color_wise_wo_sql=sql_select("select fabric_color_id, po_break_down_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by po_break_down_id,fabric_color_id order by po_break_down_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$article_number=rtrim($po_article_arr[$color_wise_wo_result[csf('po_break_down_id')]][$color_wise_wo_result[csf('fabric_color_id')]],',');
			//echo $po_article_arr[$color_wise_wo_result[csf('po_break_down_id')]][$color_wise_wo_result[csf('fabric_color_id')]].'dd';die;
			$article_numbers=implode(",",array_unique(explode(",",$article_number)));
		?>
			<tr>
          <td  width="120" align="left"><? echo $po_number_arr[$color_wise_wo_result[csf('po_break_down_id')]]; ?></td>
             <td  width="120" align="left"><? echo $article_numbers; ?></td>
            <td  width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
            <td><? echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
           <!-- <td  width="120" align="left">
			<?
			/*$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_nos."' and status_active=1 and is_deleted=0 and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;*/
			?>
            </td>-->
            <?
			$total_fin_fab_qnty=0; $total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				b.po_break_down_id=".$color_wise_wo_result[csf('po_break_down_id')]." and
				d.status_active=1 and
				d.is_deleted=0 and
				c.status_active=1 and
				c.is_deleted=0 and
				a.status_active=1 and
				a.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				b.po_break_down_id=".$color_wise_wo_result[csf('po_break_down_id')]." and
				d.status_active=1 and
				d.is_deleted=0 and
				c.status_active=1 and
				c.is_deleted=0 and
				a.status_active=1 and
				a.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>

			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
            <td align="right">
            <?
			if($process_loss_method==1) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			if($process_loss_method==2) $process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			echo number_format($process_percent,2);
			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
       <!-- <td  width="120" align="left">&nbsp;</td-->
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0 and
												c.status_active=1 and
												c.is_deleted=0 and
												a.status_active=1 and
												a.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1) $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;// markup
			if($process_loss_method==2) $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;//margin
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
          <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
      <!--  <td  width="120" align="left">&nbsp;</td>-->
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0  and
												c.status_active=1 and
												c.is_deleted=0 and
												a.status_active=1 and
												a.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'></td><td width='50' align='right' ></td>
            <?
			}
			?>
            <td align="right"><? echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4); $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			if($process_loss_method==2) $totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			echo number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
      <br/>
     <?
	$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_nos'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($po_id_all) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)

									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
   ?>
        <br/>

<table style="margin-top: 10px;" class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
<tr>
<td valign="top">

<?
 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.job_no,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.job_no,a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");

?>
		   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
						?> <td>Rate</td><?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {
						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$row[csf("job_no")]],4);//echo number_format($row[csf('yarn_required')],4); ?></td>
                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>

      </td>
       <td>
       <table width="95%"  border="1" style="margin:5px;" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <caption> <strong style="float:left"> Stripe Details</strong></caption>
        <?
		$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no in('$job_nos')  and d.job_no in('$job_nos') and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row){
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
		}
		?>

            <tr>
            <th width="30"> SL</th>
            <th width="100"> Body Part</th>
            <th width="80"> Fabric Color</th>
            <th width="70"> Fabric Qty(KG)</th>
            <th width="70"> Stripe Color</th>
            <th width="70"> Stripe Measurement</th>
            <th width="70"> Stripe Uom</th>
            <th  width="70"> Qty.(KG)</th>
            <th  width="70"> Y/D Req.</th>
            </tr>
            <?
			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];
					?>
					<tr>
					<?
					$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];//$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_qty;
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
            </td>
          </tr>
        </table>
	</table>
			<br>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                 <tr>
                 <td>
                 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

                   <tr align="center">
                    <td colspan="10"><b>Dyes To Match</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Item</td>
                    <td>Body Color</td>
                    <td>Item Color</td>
                    <td>Finish Qty.</td>
                    <td>UOM</td>
                    </tr>
                    <?
					$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
$bookingId=0;
foreach($sql as $row){
	$bookingId= $row[csf('id')];
}
					$co=0;
					$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color");

					foreach($sql_data  as $row)
                    {
					$co++;
					?>
                    <tr>
                    <td><? echo $co; ?></td>
                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
                    <td align="right"><? echo $row[csf('qty')];?></td>
                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
                    </tr>
                    <?
					}
					?>
                    </table>
                    </td>
                    <td>
                  <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {
						$i++;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td><? echo $item[$row[csf('item_id')]]; ?></td>
                            <td><? echo $supplier[$row[csf('supplier_id')]]; ?></td>
                            <td><? echo $row[csf('lot')]; ?></td>
                            <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
						</tr>
						<?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else echo "";
				}
					?>
                    </td>
                    </tr>
                 </table>
        <br/>
        <?
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_nos' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
		?>
        <br/>
        <br>
		<?
        //echo signature_table(1, $cbo_company_name, "1330px");
        $lib_designation=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
        $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation  from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
        ?>
        <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
        	<tr>
            <td>
            <table  width="95%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <tr>
            <td>
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th><th width="50%" style="border:1px solid black;">Name/Designation</th><th width="27%" style="border:1px solid black;">Approval Date</th><th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
            $i=1;
            foreach($data_array as $row){
            ?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')]." / ". $lib_designation[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
                $i++;
            }
                ?>
            </tbody>
        	</table>
            </td>
            <td>
            	 <table  width="96%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                 <?
                 $nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
list($nameArray_approved_row) = $nameArray_approved;
				 $nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
				 ?>
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>
                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>
            </td>
            </tr>
        </table>
		  <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",118);?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>
                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
			$costing_per=0;
            if($result[csf("costing_per")]==1) $costing_per=12;
			else if($result[csf("costing_per")]==2) $costing_per=1;
			else if($result[csf("costing_per")]==3) $costing_per=24;
			else if($result[csf("costing_per")]==4) $costing_per=36;
			else if($result[csf("costing_per")]==5) $costing_per=48;
			else $costing_per=0;

			$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/($costing_per*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");

			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0; $total_booking_qnty_main=0; $total_booking_qnty_short=0; $total_booking_qnty_sample=0; $total_tot_bok_qty=0; $tot_balance=0;

					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td><? if( $balance>0) echo "Less Booking"; else if ($balance<0) echo "Over Booking"; else echo ""; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>
                    <tr>
                    <td colspan="3">Total:</td>
                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                </td>

            </tr>
        </table>
         <br>
         <?
		 $sql = sql_select("select designation,name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
	     $count=count($sql);
		$width=1330;
		$td_width=floor($width/$count);
		$standard_width=$count*150;
		if($standard_width>$width) $td_width=150;
		$no_coloumn_per_tr=floor($width/$td_width);
		$col=$count-2;
		$i=1;
		echo '<table width="'.$width.'" style="font-family:Arial Narrow"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom"></td></tr><tr>';
		foreach($sql as $row)
		{
			echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';
			if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
			$i++;
		}
	echo '</tr></table>';
	$emailBody=ob_get_contents();
//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
*/		
		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}

		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_print20")//Print B20
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id, brand_name from lib_buyer_brand ",'id','brand_name');
	$user_name_arr=return_library_array( "select id, user_full_name from user_passwd ",'id','user_full_name');

	//$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//wo_pre_cost_fabric_cost_dtls
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<style type="text/css">
		@media print {
		    .pagebreak { page-break-before: always; } /* page-break-after works, as well */
		}
	</style>
	<div style="width:1330px" align="center">
    <?php
    	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
		$fabric_composition=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
		
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		$max_approve_date_data = sql_select("select min(b.approved_date) as approved_date,max(b.approved_date) as last_approve_date,max(b.un_approved_date) as un_approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		$first_approve_date='';
		$last_approve_date='';
		$un_approved_date='';
		if(count($max_approve_date_data))
		{
			$last_approve_date=$max_approve_date_data[0][csf('last_approve_date')];
			$first_approve_date=$max_approve_date_data[0][csf('approved_date')];
			$un_approved_date=$max_approve_date_data[0][csf('un_approved_date')];
		}
		
		if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'"); else $location="";
		$sql_loc=sql_select("select id,location_name,address from lib_location where company_id=$cbo_company_name");
		foreach($sql_loc as $row)
		{
			$location_name_arr[$row[csf('id')]]= $row[csf('location_name')];
			$location_address_arr[$row[csf('id')]]= $row[csf('address')];
		}		
		$yes_no_sql=sql_select("select job_no,cons_process from  wo_pre_cost_fab_conv_cost_dtls where job_no='$txt_job_no'  and status_active=1 and is_deleted=0  order by id");
		
		$peach=''; $brush=''; $fab_wash='';

		$emb_print=sql_select("select id, job_no, emb_name, emb_type from wo_pre_cost_embe_cost_dtls where  job_no='$txt_job_no' and status_active=1 and is_deleted=0 and cons_dzn_gmts>0 and emb_name in (1,2,3) order by id");
		
		$emb_print_data=array();
		$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,99=>$blank_array);
		
		foreach ($emb_print as $row) 
		{
			$emb_print_data[$row[csf('job_no')]][$row[csf('emb_name')]].=$type_array[$row[csf("emb_name")]][$row[csf('emb_type')]].",";
		}
		
		// echo "<pre>";
		// print_r();

		$nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, (b.job_quantity*b.total_set_qnty) as jobqtypcs, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant,b.factory_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks, a.sustainability_standard, b.brand_id, a.quality_level, a.fab_material, a.requisition_no, b.qlty_label, b.packing, b.job_no, a.proceed_knitting, a.proceed_dyeing from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$job_no_str=$nameArray[0][csf('job_no')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		$delivery_date=$nameArray[0][csf('delivery_date')];
		$requisition_no=$nameArray[0][csf('requisition_no')];
		$jobqtypcs=$nameArray[0][csf('jobqtypcs')];
		
		$job_yes_no=sql_select("select id, job_id,job_no, gmts_item_id, set_item_ratio, smv_pcs, smv_set, smv_pcs_precost, smv_set_precost, complexity, embelishment, cutsmv_pcs, cutsmv_set, finsmv_pcs, finsmv_set, printseq, embro, embroseq, wash, washseq, spworks, spworksseq, gmtsdying, gmtsdyingseq, ws_id, aop, aopseq,bush,bushseq,peach,peachseq,yd,ydseq from wo_po_details_mas_set_details where job_no='$job_no_str'");

		$po_shipment_date=sql_select("select  MIN(pub_shipment_date) as min_shipment_date,max(pub_shipment_date) as max_shipment_date from wo_po_break_down where id in(".$po_id_all.") order by shipment_date asc ");
         $min_shipment_date='';
         $max_shipment_date='';
         foreach ($po_shipment_date as $row) {
         	 $min_shipment_date=$row[csf('min_shipment_date')];
         	 $max_shipment_date=$row[csf('max_shipment_date')];
         	 break;
         }

        $po_running_cancel= sql_select("select case when status_active=1 then  PO_NUMBER end as running_po, case when status_active>1 then po_number end as cancel_po,po_quantity from wo_po_break_down  where id in(".$po_id_all.") order by shipment_date asc ");
        $running_po='';
        $cancel_po='';
        $running_po_qnty=0;
        foreach ($po_running_cancel as $row) {
        	if(!empty($row[csf('running_po')]))
        	{
        		if(!empty($running_po))
        		{
        			$running_po.=",".$row[csf('running_po')];
        		}
        		else{
        			$running_po.=$row[csf('running_po')];
        		}
        		$running_po_qnty+=$row[csf('po_quantity')];
        	}
        	if(!empty($row[csf('cancel_po')]))
        	{
        		if(!empty($cancel_po))
        		{
        			$cancel_po.=",".$row[csf('cancel_po')];
        		}
        		else{
        			$cancel_po.=$row[csf('cancel_po')];
        		}
        	}
        }
        $stype_color_res=sql_select("select  stripe_type from wo_pre_stripe_color where job_no='$txt_job_no' and status_active=1 and is_deleted=0 group by stripe_type");
        $stype_color='';
        foreach ($stype_color_res as $val) {
        	if(!empty($stype_color))
        	{
        		$stype_color.=", ".$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        	else
        	{
        		$stype_color=$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        	
        }
        $yd_aop_sql=sql_select("select id, job_no,  color_type_id from wo_pre_cost_fabric_cost_dtls where job_no='$txt_job_no' and status_active=1 and is_deleted=0 order by id asc");

        $yd=''; $aop='';
		foreach ($yes_no_sql as $row) {
			
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'peach') !== false)
        	{
			    if(!empty($peach))
			    {
			    	$peach.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$peach.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brush') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brush [With Finish]') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brushing') !== false)
        	{
			    if(!empty($brush))
			    {
			    	$brush.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$brush.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'wash') !== false || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'washing') !== false)
        	{
			    if(!empty($fab_wash))
			    {
			    	$fab_wash.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$fab_wash.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'y/d') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('YD at Main Fabric Booking') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'yarn dyeing') !== false)
        	{
			    if(!empty($yd))
			    {
			    	$yd.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$yd.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'aop') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('All Over Printing'))
        	{
			    if(!empty($aop))
			    {
			    	$aop.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$aop.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
		}
  		ob_start();     
		?>	
											<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td width="200" style="font-size:28px"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:28px;"> <?php echo $company_library[$cbo_company_name]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:18px"><?=$location_address_arr[$location]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:24px">
                            	<span style="float:center;"><b><strong> <font style="color:black">Main Fabric Booking </font></strong></b></span> 
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:20px">
							<?
							if(str_replace("'","",$id_approved_id) ==1){ ?>
                            <span style="font-size:20px; float:center;"><strong> <font style="color:green"> <? echo "[Approved]"; ?> </font></strong></span> 
                               <? }else{ ?>
								<span style="font-size:20px; float:center;"><strong> <font style="color:red"><? echo "[Not Approved]"; ?> </font></strong></span> 
							   <? } ?>
                            </td>
                        </tr>
                    </table>
                </td>
                <td width="200">
                	<table style="border:1px solid black; font-family:Arial Narrow;" width="100%">
                		<tr>
                			<td><b>Min. Ship Date:</b></td>
                			<td><b><?php echo  date('d-m-Y',strtotime($min_shipment_date));?></b></td>
                		</tr>
                		<tr>
                			<td><b>Max. Ship Date:</b></td>
                			<td><b><?php echo date('d-m-Y',strtotime($max_shipment_date));?></b></td>
                		</tr>
                	</table>
                	<br>
                	<table style="border:1px solid black; font-family:Arial Narrow;font-size: 10px;" width="100%">
                		<tr>
                			<td>Printing Date :</td>
                			<td><?php echo  date('d-m-Y');?></td>
                		</tr>
                		<tr>
                			<td>Printing Time:</td>
                			<td><?php echo  date('h:i:sa');?></td>
                		</tr>
                		<tr>
                			<td>User Name:</td>
                			<td><?php echo $user_name_arr[$user_id];?></td>
                		</tr>
                		<tr>
                			<?php 
                				function get_client_ip() {
								    $ipaddress = '';
								    if (getenv('HTTP_CLIENT_IP'))
								        $ipaddress = getenv('HTTP_CLIENT_IP');
								    else if(getenv('HTTP_X_FORWARDED_FOR'))
								        $ipaddress = getenv('HTTP_X_FORWARDED_FOR');
								    else if(getenv('HTTP_X_FORWARDED'))
								        $ipaddress = getenv('HTTP_X_FORWARDED');
								    else if(getenv('HTTP_FORWARDED_FOR'))
								        $ipaddress = getenv('HTTP_FORWARDED_FOR');
								    else if(getenv('HTTP_FORWARDED'))
								       $ipaddress = getenv('HTTP_FORWARDED');
								    else if(getenv('REMOTE_ADDR'))
								        $ipaddress = getenv('REMOTE_ADDR');
								    else
								        $ipaddress = 'UNKNOWN';
								    return $ipaddress;
								}

                			 ?>
                			<td>IP Address:</td>
                			<td><?php if(empty($user_ip)){echo get_client_ip();} echo $user_ip;?></td>
                		</tr>
                	</table>
                </td>
            </tr>
        </table>
		<?
        $job_no=trim($txt_job_no,"'"); $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff,min(factory_received_date) as factory_received_date, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
      
        $to_ship=0; $fp_ship=0; $f_ship=0;

        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $factory_received_date=change_date_format($row[csf('factory_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) {
				$shiping_status.= "FP".",";
				$to_ship++;
				$fp_ship++;
			}
			else if($row[csf('shiping_status')]==2){
				$shiping_status.= "PD".",";
				$to_ship++;
			} 
			else if($row[csf('shiping_status')]==3){
				$shiping_status.= "FS".",";
				$to_ship++;
				$f_ship++;
			} 
        }

        if($to_ship==$f_ship) $shiping_status= "Full shipped";
        else if($to_ship==$fp_ship) $shiping_status= "Full Pending";
        else $shiping_status= "Partial Delivery";
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$factory_received_date=implode(",",array_filter(array_unique(explode(",",$factory_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];
			?>
			<table width="100%" class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all"  style="font-size:18px; font-family:Arial Narrow;" >
				<tr>
					<td colspan="2" rowspan="6" width="210">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" width="210">
                                <legend>Image </legend>
                                <table width="208">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="200" height="200" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
					</td>
					<td width="100"><b>Job No</b></td>
					<?php 
					 	$revised_no=$nameArray_approved_row[csf('approved_no')]-1;
						if($revised_no<0) $revised_no=0;
					 ?>
					<td width="140"> <span style="font-size:18px"><b style="float:left;font-size:18px"><? echo trim($txt_job_no,"'");if(!empty($revised_no)){ ?>&nbsp;<span style="color: red;">/&nbsp;<? echo $revised_no; }?></span></b> </span> </td>
					<td colspan="7" width="760">
						<b><?php if(!empty($result[csf('remarks')])){ ?><span style="font-size: 25px;">&#8592;</span><? echo $result[csf('remarks')]; } ?></b>
					</td>
				</tr>
				<?php
					$order_yes_no=sql_select("Select embelishment ,embro ,wash  ,spworks ,gmtsdying , ws_id , aop , aopseq , bush ,  peach, yd    from wo_po_details_mas_set_details where job_no='$txt_job_no' order by id");			
				?>
				<tr>
					<td width="100" style="font-size:16px;"><b>Style</b></td>
					<td width="110"style="font-size:16px;" >&nbsp;<? echo $result[csf('style_ref_no')]; ?></td>
					
					<td width="100" style="font-size:16px;"><b>Dept. (Prod Code)</b></td>
					<td width="140"style="font-size:16px;" >&nbsp;<? echo $product_dept[$result[csf('product_dept')]]; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} ?></td>
					
					<td width="100"><b>YD</b></td>
					<td width="110"><?php echo (!empty($yd) || $order_yes_no[0][csf('yd')]==1)  ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php 	echo $yd; ?></td>
					<td width="110"><b>Fac. Order Received Date</b></td>
					<td width="100"><?php echo $factory_received_date; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></span></td>
					<td width="100"><b>Sub Dep</b></td>
					<td width="140"><? if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
					<td width="100"><b>AOP</b></td>
					<td width="110"><?php echo   ($order_yes_no[0][csf('aop')]==1 || (!empty($aop))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$aop;?></td>
					<td width="110"><b>Booking Start<br>Appoval Date</b></td>
					<td width="100">
						<?php if(!empty($first_approve_date)){ echo date('d-m-Y',strtotime($first_approve_date)); } ?><br>
						<?php if(!empty($last_approve_date)){ echo date('d-m-Y',strtotime($last_approve_date)); } ?>
							
					</td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Garments Item</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"> <?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?></span></td>
					<td width="100"><b>Season</b></td>
					<td width="140"><? echo $season_name_arr[$result[csf('season')]]; ?></td>
					<td width="100"><b>Peach</b></td>
					
					<td width="110"><?php echo  ($job_yes_no[0][csf('peach')]==1 || (!empty($peach))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$peach;?></td>
					<td width="110"><b>Approved Status</b></td>
					<td width="100">
					<? if(str_replace("'","",$id_approved_id) ==1){ ?>
					<b style="color:green"><?="Yes"; ?></b>
					<? }else{ ?><b style="color:red"><?	echo "No";?></b><? }; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Sample Req. No</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"><?php echo $requisition_no; ?></span></td>
					<td width="100"><b>Brand</b></td>
					<td width="140"><?php echo $brand_name_arr[$result[csf('brand_id')]]; ?></td>
					<td width="100"><b>Brushing</b></td>
					<td width="110"><?php echo  ($job_yes_no[0][csf('bush')]==1 ||  (!empty($brush))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$brush;?></td>
					<td width="110"><b>Booking Date</b></td>
					<td width="100"> <?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>
                    </td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Booking No</b></span></td>
					<td width="110"><span style="font-size:18px"><b><?=$result[csf('booking_no')];?></b><?="<br>(".$fabric_source[$result[csf('fabric_source')]].")" ?> </span> </td>
					<td width="100"><b>Order Repeat No</b></td>
					<td width="140"><?=$result[csf('order_repeat_no')];?></td>

					<td width="100"><b>Print / Type</b></td>
					<td width="110"><?=($order_yes_no[0][csf('embelishment')]==1 || (!empty($emb_print_data[$txt_job_no][1]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=!empty($emb_print_data[$txt_job_no][1]) ? chop($emb_print_data[$txt_job_no][1],",") : '' ;?></td>
					
					<td width="110"><b>Delivery Date</b></td>
					<td width="100"><? echo change_date_format($delivery_date); ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Running PO No</b></span></td>
					<td width="350" colspan="3" style="word-break: break-all;"><p style="font-size:12px;width: 450px;word-break: break-all;" ><? echo $running_po; ?></p></td>
					<td width="100"><b>Order Repeat Job No</b></td>
					<td width="110"><? echo $result[csf('repeat_job_no')];?></td>
					<td width="100"><b>EMB / Type</b></td>
					<td width="110"><?php echo  ($order_yes_no[0][csf('embro')]==1 || (!empty($emb_print_data[$txt_job_no][2]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo  !empty($emb_print_data[$txt_job_no][2]) ? chop($emb_print_data[$txt_job_no][2],",") : '' ;?></td>
					<td width="110"><b>Amendment Date</b></td>
					<td width="100"><? if(!empty($un_approved_date)){echo change_date_format($un_approved_date);} ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Cancelled PO</b></span></td>
					<td width="350" colspan="3" ><p style="font-size:12px;width: 450px;word-break: break-all;"><? echo $cancel_po; ?></p></td>		
					<?php $fab_material=array(1=>"Organic",2=>"BCI"); ?>
					<td width="100"><b>Fab. Material</b> </td>
					<td width="110"><?php echo $fab_material[$result[csf('fab_material')]]; ?></td>
					<td width="100"><b>GMT Wash</b></td>
					
					<td width="110"><?php echo  ($order_yes_no[0][csf('wash')]==1 || (!empty($emb_print_data[$txt_job_no][3]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo  !empty($emb_print_data[$txt_job_no][3]) ? chop($emb_print_data[$txt_job_no][3],",") : '' ;?></td>

					<td width="110"><b>Dealing Merchandiser</b></td>
					<td width="100"><? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>GMT/ Style Description</b></span></td>
					<td width="350" colspan="3"><span style="font-size:18px"><? echo $result[csf('style_description')]; ?></span></td>
					<td width="100"><b>Sustainability Standard</b></td>
					<td width="110"><?php echo $sustainability_standard[$result[csf('sustainability_standard')]]; ?></td>
					<td width="100"><b>Fab Wash</b></td>
					<td width="110"><?php echo !empty($fab_wash)? 'Yes' : 'No'; ?></td>
					<td width="100"><?=$fab_wash?></td>
					<td width="110"><b>Factory Merchandiser</b></td>
					<td width="100"><? echo $marchentrArr[$result[csf('factory_marchant')]]; ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Fabric Description</b></span></td>
					<td width="350" colspan="3"><span style="font-size:18px">
						<? 
							$sql_fab="SELECT a.lib_yarn_count_deter_id AS determin_id, a.construction
							    FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							   WHERE a.job_id = b.job_id AND a.id = b.pre_cost_fabric_cost_dtls_id AND a.id = d.pre_cost_fabric_cost_dtls_id AND b.po_break_down_id = d.po_break_down_id AND b.color_size_table_id = d.color_size_table_id AND b.pre_cost_fabric_cost_dtls_id = d.pre_cost_fabric_cost_dtls_id AND d.booking_no = $txt_booking_no AND a.status_active = 1 AND d.status_active = 1 AND d.is_deleted = 0 and a.body_part_id in (1,20) group by a.lib_yarn_count_deter_id , a.construction";
							//echo $sql_fab;
							$res_fab=sql_select($sql_fab);
							$des='';
							foreach ($res_fab as $row) 
							{
								if(!empty($des))
								{
									$des."***";
								}
								$des.=$row[csf('construction')] . " ". $fabric_composition[$lip_yarn_count[$row[csf('determin_id')]]];
							}
							echo implode(",", array_unique(explode("***", $des)));
						?>
						</span></td>
					<td width="100"><b>Order Nature</b></td>
					<td width="110"><?php echo $fbooking_order_nature[$result[csf('quality_level')]] ?></td>
					<td width="100"><b>Running Order Qty</b></td>
					<?php $order_uom_res=sql_select( "select a.order_uom from wo_po_details_master a where a.status_active=1 and a.is_deleted=0  and a.job_no='$txt_job_no' ");
						$order_uom='';
						if(count($order_uom_res))
						{
							$order_uom=$unit_of_measurement[$order_uom_res[0][csf('order_uom')]];
						}
					 ?>
					<td width="210" colspan="2" align="center"><b> <?php echo number_format($running_po_qnty,0); ?>&nbsp;(<?=$order_uom;?>)</b></td>
					<td width="110"><b>Shipment Status</b></td>
					<td width="100"><? echo rtrim($shiping_status,','); ?></td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Attention</b></span></td>
					<td  width="350" colspan="3"><span style="font-size:18px"><? echo $result[csf('attention')]?></span></td>
					<td width="100"><b>Quality Label</b></td>
					<td width="110"><?php echo $quality_label[$result[csf('qlty_label')]] ?></td>
					<td width="100"><b>Packing</b></td>
					<td width="420" colspan="4" align="center"><b> <?php echo $packing[$result[csf('packing')]]; ?></b></td>					
				</tr>
                <tr>
					<td><span style="font-size:18px"><b>Proceed for Knitting</b></span></td>
					<td><span style="font-size:18px"><? echo $yes_no[$result[csf('proceed_knitting')]]; ?></span></td>
					<td><b>Proceed for Dyeing</b></td>
					<td><?php echo $yes_no[$result[csf('proceed_dyeing')]]; ?></td>
					<td colspan="7">&nbsp;</td>
				</tr>				
			</table>
			<br>
			<?
		}	
			
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			<table width="100%" style="font-family:Arial Narrow;font-size:18px" >
                <tr>
                    <td width="900">
                        <div id="div_size_color_matrix" style="float:left; max-width:1000;">
                            <fieldset id="div_size_color_matrix" style="max-width:1000;">
                                <legend>Size and Color Breakdown</legend>
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="1000" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style="border:1px solid black"><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="border:1px solid black; text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <td width="130" valign="top" align="left">
                        <div id="div_size_color_matrix" style="float:left;">
							
                        </div>
                    </td>
                    <td width="200" valign="top" align="right">
						
                        <div id="div_size_color_matrix" style="float:right;font-size:18px;font-family:Arial Narrow;">
                           <? $rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown); ?>
                            <fieldset id="" >
                                <legend>RMG Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all">
									<?
                                    if(number_format($rmg_process_breakdown_arr[8],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cut Panel rejection <!-- Extra Cutting % breack Down 8--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[8],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[2],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[10],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Neck/Sleeve Printing <!-- New breack Down 10--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[1],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Embroidery   <!-- Embroidery  % breack Down 1--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[4],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sewing /Input<!-- Sewing % breack Down 4--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[3],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Garments Wash <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[15],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Gmts Finishing <!-- Washing %breack Down 3--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[11],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[11],2); ?></td>
										</tr>
										<?
                                    }
                                    $gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
                                    if($gmts_pro_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total <!-- New breack Down 11--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                            <fieldset id="" >
                                <legend>Fabric Process Loss % </legend>
                                <table width="180" class="rpt_table" border="1" rules="all" style="font-family:Arial Narrow;">
                                    <?
                                    if(number_format($rmg_process_breakdown_arr[6],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Knitting  <!--  Knitting % breack Down 6--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[12],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Yarn Dyeing  <!--  New breack Down 12--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[5],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dyeing & Finishing  <!-- Finishing % breack Down 5--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[13],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130"> All Over Print <!-- new  breack Down 13--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[14],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Lay Wash (Fabric) <!-- new  breack Down 14--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[7],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Dying   <!-- breack Down 7--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[0],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Cutting (Fabric) <!-- Cutting % breack Down 0--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[0],2); ?></td>
										</tr>
										<?
                                    }
                                    if(number_format($rmg_process_breakdown_arr[9],2)>0)
                                    {
										?>
										<tr>
                                            <td width="130">Others  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
										</tr>
										<?
                                    }

                                    $fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
                                    if(fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Sub Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
                                    {
										?>
										<tr>
                                            <td width="130">Grand Total  <!-- Others% breack Down 9--></td>
                                            <td align="right"><? echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                </tr>
			</table>
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		<br/>
		<br>
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }

        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');		
		if($cbo_fabric_source==1)
		{
			$fb_desc_sq="SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type,  b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight,  b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width";
			$nameArray_fabric_description= sql_select($fb_desc_sq);
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                 <tr align="center">
                    <th colspan="3" align="left">Fabric Composition</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('determin_id')]== "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td  colspan='2'>". $fabric_composition[$lip_yarn_count[$result_fabric_description[csf('determin_id')]]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Yarn Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='2' >&nbsp</td>";
						else echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
               
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else echo "<td colspan='2' align='center'>A Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">GMT Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
                $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td><? echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }
                        
                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
						<?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							?>
							<td width='50' align='center' style="font-size:18px;"></td>
                            <td width='50' align='right' > </td>
							<?
                        }
                        ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(a.avg_finish_cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(a.avg_cons) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_id=a.job_id and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");


			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('determin_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $fabric_composition[$lip_yarn_count[$result_fabric_description[csf('determin_id')]]]."</td>";

						
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Yarn Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">GMT Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id as fab_id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and

                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				if(!empty($collar_cuff_row[csf('item_size')]))
				{
					$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				}
				
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);

			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;font-size:18px;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }
                            ?>
                        </tr>
                            <?

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        
                        <tr>
                            <td>Size Total</td>
								<?
                               // foreach($pre_size_total_arr  as $size_qty)
                               // {
                                	foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
									{
										$size_qty=$pre_size_total_arr[$size_number_id];
										?>
										<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
										<?
									}

                               // }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

        ?>

       		 <table width="98%">
       		 	<tr>
       		 		<td width="45%" style="float: left;">
       		 			<?php 

       		 				$sql_purchase="SELECT a.booking_no, a.uom, sum(b.fin_fab_qnty) as qnty , b.construction, b.copmposition, b.gsm_weight as dia, b.dia_width as gsm from wo_booking_mst a, wo_booking_dtls b where     a.booking_no = b.booking_no and a.fabric_source = 2 and b.job_no = '$txt_job_no'and b.status_active = 1 and b.is_deleted = 0 and a.status_active = 1 and a.is_deleted = 0 and  a.booking_type=1 group by a.booking_no, a.uom, b.construction, b.copmposition, b.dia, b.gsm_weight, b.dia_width"; 
       		 				//echo $sql_purchase;
							$purchase_res=sql_select($sql_purchase);
							?>
							<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <thead>
				                   <tr align="center">
				                    	<th colspan="5"><b>Purchased Booking Info</b></th>
				                    </tr>
				                    <tr align="center">
					                    <th>Sl</th>
					                    <th>Booking No</th>
					                    <th>Fabric Data</th>
					                    <th>UOM</th>
					                    <th>Qnty</th>
					                   
				                    </tr>
 			                   </thead>
 			                   <tbody>
 			                   		<?

 			                   			foreach ($purchase_res as  $row) 
 			                   			{
 			                   				?>
 			                   				<tr>
 			                   					<td><?=$p++;?></td>
 			                   					<td><p><?=$row[csf('booking_no')];?></p></td>
 			                   					<td><p><?=$row[csf('construction')] .", ".$row[csf('copmposition')].", ".$row[csf('gsm')].", ".$row[csf('dia')];?></p></td>
 			                   					<td><p><?=$unit_of_measurement[$row[csf('uom')]];?></p></td>
 			                   					<td><p><?=number_format($row[csf('qnty')],2);?></p></td>
 			                   				</tr>
 			                   				<?
 			                   			}


 			                   		?>
 			                   </tbody>
 			                   
 			            </table>

       		 			 
       		 		</td>
       		 		<td width="45%" style="float: right;">
 			       		 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <tr align="center">
 			                    	<td colspan="10"><b>Dyes To Match</b></td>
 			                    </tr>
 			                    <tr align="center">
 				                    <td>Sl</td>
 				                    <td>Item</td>
 				                    <td>Item Description</td>
 				                    <td>Body Color</td>
 				                    <td>Item Color</td>
 				                    <td>Finish Qty.</td>
 				                    <td>UOM</td>
 			                    </tr>
 			                    <?
 								$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
 								$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
 								$bookingId=0;
 								foreach($sql as $row){
 									$bookingId= $row[csf('id')];
 								}
 								$co=0;
 								$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty, b.description   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom, b.description order by a.fabric_color");

 								foreach($sql_data  as $row)
 			                    {
 									$co++;
 									?>
 				                    <tr>
 				                    <td><? echo $co; ?></td>
 				                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
 				                    <td><p> <? echo $row[csf('description')];?></p></td>
 				                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
 				                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
 				                    <td align="right"><? echo $row[csf('qty')];?></td>
 				                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
 				                    </tr>
 				                    <?
 								}
 								?>
 			            </table>
       		 		</td>
       		 	</tr>
       		 </table>
            <br>

        <?

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  style="font-size:18px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> </b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
                 <td width="49%" valign="top" align="center">
                	
               	
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                				<?
                				$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
									 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
									 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

								$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
                				 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");


                				if(count($unapprove_data_array)>0)
                				{
                				$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
                					$unapproved_request_arr=array();
                					foreach($sql_unapproved as $rowu)
                					{
                						$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
                					}
                		 		?>
                		       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
                		            <thead>
                		            <tr style="border:1px solid black;">
                		                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                		                </tr>
                		                <tr style="border:1px solid black;">
                		                <th width="3%" style="border:1px solid black;">Sl</th>
                						<th width="30%" style="border:1px solid black;">Name</th>
                						<th width="20%" style="border:1px solid black;">Designation</th>
                						<th width="5%" style="border:1px solid black;">Approval Status</th>
                						<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                						<th width="22%" style="border:1px solid black;"> Date</th>

                		                </tr>
                		            </thead>
                		            <tbody>
                		            <?
                					$i=1;
                					foreach($unapprove_data_array as $row){

                					?>
                		            <tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
                						<td width="20%" style="border:1px solid black;"><? echo '';?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
                		            </tr>
                		                <?
                						$i++;
                						$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
                						$un_approved_date=$un_approved_date[0];
                						if($db_type==0) //Mysql
                						{
                							if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}
                						else
                						{
                							if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}

                						if($un_approved_date!="")
                						{
                						?>
                					<tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
                		              </tr>

                		                <?
                						$i++;
                						}

                					}
                						?>
                		            </tbody>
                		        </table>
                				<?
                				}
                				?>

                </td>
            </tr>
        </table>
        <br/>
        <table  width="100%" style="margin: 0px;padding: 0px;">
        <?php $stripe_color_wise=array(); ?>
       
        <tr>
        	<td width="70%">
        		<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >
        		       
        		        <tr>
        		            <td align="center" colspan="9">  Stripe Details</td>
        		            
    		            </tr>
        		        <?
        				$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
        				$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d, wo_po_color_size_breakdown e where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1 and b.is_deleted=0 and e.id=b.color_size_table_id and e.is_deleted=0 and e.status_active=1 and e.color_number_id=d.color_number_id  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");        				
        				$result_data=sql_select($sql_stripe);
        				foreach($result_data as $row)
        				{
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
        				}
        				?>
        		            <tr>
	        		            <td align="center" width="30"> SL</td>
	        		            <td align="center" width="100"> Body Part</td>
	        		            <td align="center" width="80"> Fabric Color</td>
	        		            <td align="center" width="70"> Fabric Qty(KG)</td>
	        		            <td align="center" width="70"> Stripe Color</td>
	        		            <td align="center" width="70"> Stripe Measurement</td>
	        		            <td align="center" width="70"> Stripe Uom</td>
	        		            <td  align="center" width="70"> Qty.(KG)</td>
	        		            <td  align="center" width="70"> Y/D Req.</td>
        		            </tr>
        		            <?
        					$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
        		            foreach($stripe_arr as $body_id=>$body_data)
        		            {
        						foreach($body_data as $color_id=>$color_val)
        						{
        							$rowspan=count($color_val['stripe_color']);
        							$composition=$stripe_arr2[$body_id][$color_id]['composition'];
        							$construction=$stripe_arr2[$body_id][$color_id]['construction'];
        							$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
        							$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
        							$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

        							if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        							else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

        							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
        								WHERE a.job_id=b.job_id and
        								a.id=b.pre_cost_fabric_cost_dtls_id and
        								c.job_no_mst=a.job_no and
        								c.id=b.color_size_table_id and
        								b.po_break_down_id=d.po_break_down_id and
        								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
        								d.booking_no =$txt_booking_no and
        								a.body_part_id='".$body_id."' and
        								a.color_type_id='".$color_type_id."' and
        								a.construction='".$construction."' and
        								a.composition='".$composition."' and
        								a.gsm_weight='".$gsm_weight."' and
        								$color_cond and
        								d.status_active=1 and
        								d.is_deleted=0
        								");
        						
        								list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
        							$sk=0;
    								foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
        							{
        								
        								?>
	        							<tr>
		        							<?
		        							if($sk==0)
		        							{


			        							$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			        							?>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
			        							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
			        							<?
			        							$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			        							$i++;
			        						}
		        							$sk=0;
		        							

		        								$measurement=$color_val['measurement'][$strip_color_id];
		        								$uom=$color_val['uom'][$strip_color_id];
		        								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
		        								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
		        								
		        								?>
		        							
			        								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
			        								<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
			        		                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
			        								<td align="right"> <? echo  number_format($fabreqtotkg,2); ?> &nbsp;</td>
			        								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
		        								
		        								<?
		        								
		        								$sk++;
		        								$total_fabreqtotkg+=$fabreqtotkg;
		        								$stripe_color_wise[$color_name_arr[$s_color_val]]+=$fabreqtotkg;
		        							
		        							
		        							?>
	        							</tr>
	        							<?
	        						}
        						}
        					}
        					?>
	        		            <tfoot>
		        		            <tr>
			        		            <td colspan="3">Total </td>
			        		            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
			        		            <td></td>
			        		            <td></td>
			        		            <td>   </td>
			        		            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
			        		        </tr>
	        		            </tfoot>
        		            </table>
        	</td>
        	
        	<td width="20%" >
        		        <table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;"  >
        		       

        		        <tr>
        		            <td align="left" colspan="3"> Stripe  Color wise Summary</td>
        		            
        		           
        		           
    		            </tr>
        		        <?
        				
        				?>
        		            <tr>
	        		            <td width="30"> SL</td>
	        		            
	        		            <td width="70"> Stripe Color</td>
	        		           
	        		            <td  width="70"> Qty.(KG)</td>
	        		           
        		            </tr>
        		            <?

        					$i=1;$total_stripe_qnt=0;        		            
        						foreach($stripe_color_wise as $color=>$val)
        						{
        							
        							
        							?>
        							<tr>
	        							<td> <? echo $i; ?></td>
	        							
	        							<td > <? echo $color; ?></td>
	        							<td align="right"> <?php echo number_format($val,2); ?></td>
	        						</tr>
        							
        							<?
        							$total_stripe_qnt+=$val;
        							
        							$i++;
        						}
        					
        					?>
        		            <tfoot>
        		            <tr>
        		            
        		            <td></td>
        		            <td></td>
        		            
        		            <td align="right"><? echo  number_format($total_stripe_qnt,2); ?> </td>
        		            </tr>
        		            </tfoot>
        		            </table>
        	</td>
        </tr>
         </table >
      
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Production) </b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("SELECT a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_id=b.job_id and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>

        <?
         if(count($purchase_res))
        {
        	?>
         <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Purchase)</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Purchase<br>Booking Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and c.job_no_mst = '$txt_job_no'  and a.fab_nature_id=3 and   a.fabric_source = '2'  and a.status_active=1 and a.is_deleted=0 order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and   a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1  and c.fabric_source = 2  and a.is_short=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");


        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1 and c.fabric_source=2 and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =4 and c.fabric_source=2 and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.job_no_mst='$txt_job_no' group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
       
        </tfoot>
        </table>
         <?
        	}
        ?>
       <br>

		<fieldset id="div_size_color_matrix" style="max-width:1000;">
		<?
		//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "SELECT id,po_number_id, (case when task_number=31 then task_start_date else null end) as fab_booking_start_date, (case when task_number=31 then task_finish_date else null end) as fab_booking_end_date, (case when task_number=60 then task_start_date else null end) as knitting_start_date, (case when task_number=60 then task_finish_date else null end) as knitting_end_date, (case when task_number=61 then task_start_date else null end) as dying_start_date, (case when task_number=61 then task_finish_date else null end) as dying_end_date, (case when task_number=64 then task_start_date else null end) as finishing_start_date, (case when task_number=64 then task_finish_date else null end) as finishing_end_date, (case when task_number=84 then task_start_date else null end) as cutting_start_date, (case when task_number=84 then task_finish_date else null end) as cutting_end_date, (case when task_number=86 then task_start_date else null end) as sewing_start_date, (case when task_number=86 then task_finish_date else null end) as sewing_end_date, (case when task_number=110 then task_start_date else null end) as exfact_start_date, (case when task_number=110 then task_finish_date else null end) as exfact_end_date, (case when task_number=47 then task_start_date else null end) as yarn_rec_start_date, (case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date from tna_process_mst where status_active=1 and po_number_id in($po_id_all)"); 
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

			//------------------------------ Query for TNA end-----------------------------------
		?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:17px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } echo get_spacial_instruction($txt_booking_no,"97%",118); ?>
        
        <div style="font-family:Arial Narrow;"><?=signature_table(1, $cbo_company_name, "1400px"); ?></div>
		<br>
       <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="1300" cellspacing="0" rules="all" >
        	<thead>
            	<th colspan="16"><b>Job Progress Status: </b></th>
            </thead>
            <?
			$condition= new condition();
			if(str_replace("'","",$job_no) !=''){
				$condition->job_no("='$job_no'");
			}
			//Fabric Booking
			$condition->init();
			$fabric= new fabric($condition);  //echo $fabric->getQuery();
			$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabreqQty=0;
			foreach($fabric_qty['knit']['grey'] as $fid=>$fdata)
			{
				foreach($fdata as $fuom=>$fuomdata)
				{
					$fabreqQty+=$fuomdata;
				}
			}
			
			$sqlJobPo=sql_select("select id from wo_po_break_down where job_no_mst='$job_no' and status_active=1 and is_deleted=0");
			$poIds="";
			foreach($sqlJobPo as $row)
			{
				if($poIds=="") $poIds=$row[csf('id')]; else $poIds.=','.$row[csf('id')];
			}
			unset($sqlJobPo);
			
			$sqlFabbooking=sql_select("select sum(grey_fab_qnty) as grey_fab_qnty from wo_booking_dtls where job_no='$job_no' and booking_type=1 and status_active=1 and is_deleted=0");
			$fabbookingQty=$sqlFabbooking[0][csf('grey_fab_qnty')];
			
			$fabbookingPer=($fabbookingQty/$fabreqQty)*100;
			
			//Yarn Allocation
			$sqlYarnAll=sql_select("select sum(qnty) as qnty from inv_material_allocation_dtls where job_no='$job_no' and item_category=1 and status_active=1 and is_deleted=0");
			$yarnAlloQty=$sqlYarnAll[0][csf('qnty')];
			$yarnAlloPer=($yarnAlloQty/$fabreqQty)*100;
			
			$sqlStore="select entry_form, trans_type, quantity from order_wise_pro_details where po_breakdown_id in(".$poIds.") and trans_type in (1,2) and entry_form in (2,3,22,23,58,82,7,66,37,225) and status_active=1";
			$sqlstoreRes=sql_select($sqlStore);
			
			$yarnIssueQty=$knittingFinishQty=$greyRecQty=$finishProdQty=$finishRecQty=0;
			foreach($sqlstoreRes as $row)
			{
				if($row[csf('trans_type')]==2 && $row[csf('entry_form')]==3)
				{
					$yarnIssueQty+=$row[csf('quantity')];
				}
				if($row[csf('trans_type')]==1)
				{
					if($row[csf('entry_form')]==2)
					{
						$knittingFinishQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==22 || $row[csf('entry_form')]==23 || $row[csf('entry_form')]==58 || $row[csf('entry_form')]==82)
					{
						$greyRecQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==7 || $row[csf('entry_form')]==66)
					{
						$finishProdQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==37 || $row[csf('entry_form')]==225)
					{
						$finishRecQty+=$row[csf('quantity')];
					}
				}
			}
			unset($sqlstoreRes);
			
			$yarnIssePer=($yarnIssueQty/$fabreqQty)*100;			//Yarn Issued
			$knittingFinishPer=($knittingFinishQty/$fabreqQty)*100;	//Knitting Finished
			$greyRecPer=($greyRecQty/$fabreqQty)*100;				//Greige Fabric Received
			$finishProdPer=($finishProdQty/$fabreqQty)*100;			//Finished Fabric Production
			$finishRecPer=($finishRecQty/$fabreqQty)*100;			//Finished Fabric Received
			
			
			$sqlGmtsProd="select production_type, embel_name, production_quantity from pro_garments_production_mst where po_break_down_id in(".$poIds.") and production_type in (1,3,5,7,15,11,8) and status_active=1";
			$sqlGmtsProdRes=sql_select($sqlGmtsProd);
			$cutQty=$printQty=$embRecQty=$sewOutQty=$ironQty=$hangTagQty=$polyQty=$packFinQty=0;
			foreach($sqlGmtsProdRes as $row)
			{
				if($row[csf('production_type')]==1)
				{
					$cutQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==3 && $row[csf('embel_name')]==1)
				{
					$printQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==3 && $row[csf('embel_name')]==1)
				{
					$embRecQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==5)
				{
					$sewOutQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==7)
				{
					$ironQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==15)
				{
					$hangTagQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==11)
				{
					$polyQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==8)
				{
					$packFinQty+=$row[csf('production_quantity')];
				}
			}
			unset($sqlGmtsProdRes);
			$cutFinishPer=($cutQty/$jobqtypcs)*100;		//Cutting Finished
			$printRecPer=($printQty/$jobqtypcs)*100;	//Print Received
			$embRecPer=($embRecQty/$jobqtypcs)*100;		//Embroidery Received
			$sewOutPer=($sewOutQty/$jobqtypcs)*100;		//Sewing Completed
			$ironPer=($ironQty/$jobqtypcs)*100;			//Iron Completed
			$hangTagPer=($hangTagQty/$jobqtypcs)*100;	//Hang Tag Completed
			$polyPer=($polyQty/$jobqtypcs)*100;			//Poly Completed
			$packFinishPer=($packFinQty/$jobqtypcs)*100;//Packing Finishing Completed
			
			//Ex-factory Completed
			$sqlExFactory=return_field_value("sum(ex_factory_qnty) as exqty", "pro_ex_factory_mst", "po_break_down_id in(".$poIds.") and status_active=1", "exqty");
			$exFactoryPer=($sqlExFactory/$jobqtypcs)*100;
			
			?>
			<tr>
            	<td width="125"><b>Fabric Booking</b></td><td align="center" width="40"><?=number_format($fabbookingPer,2); ?></td>
                <td width="125"><b>Yarn Allocation</b></td><td align="center" width="40"><?=number_format($yarnAlloPer,2); ?></td>
                <td width="125"><b>Yarn Issued</b></td><td align="center" width="40"><?=number_format($yarnIssePer,2); ?></td>
                <td width="125"><b>Knitting Finished</b></td><td align="center" width="40"><?=number_format($knittingFinishPer,2); ?></td>
                <td width="125"><b>Greige Fabric Received</b></td><td align="center" width="40"><?=number_format($greyRecPer,2); ?></td>
                <td width="125"><b>Dye-Fin. Completed</b></td><td align="center" width="40"><?=number_format($finishProdPer,2); ?></td>
                <td width="125"><b>Finished Fabric Received</b></td><td align="center" width="40"><?=number_format($finishRecPer,2); ?></td>
                <td width="125"><b>Cutting Finished</b></td><td align="center"><?=number_format($cutFinishPer,2); ?></td>
            </tr>
            <tr>
            	<td><b>Print Received</b></td><td align="center"><?=number_format($printRecPer,2); ?></td>
            	<td><b>Embroidery Received</b></td><td align="center"><?=number_format($embRecPer,2); ?></td>
            	<td><b>Sewing Completed</b></td><td align="center"><?=number_format($sewOutPer,2); ?></td>
                <td><b>Iron Completed</b></td><td align="center"><?=number_format($ironPer,2); ?></td>
                <td><b>Hang Tag Completed</b></td><td align="center"><?=number_format($hangTagPer,2); ?></td>
                <td><b>Poly Completed</b></td><td align="center"><?=number_format($polyPer,2); ?></td>
                <td><b>Packing Finishing Completed</b></td><td align="center"><?=number_format($packFinishPer,2); ?></td>
                <td><b>Ex-factory Completed</b></td><td align="center"><?=number_format($exFactoryPer,2); ?></td>
            </tr>
        </table>
        <br>
        <?
        	$grand_order_total=0; $grand_plan_total=0; $size_wise_total=array();
			$nameArray_size=sql_select( "select size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id ");
			?>
                <div id="div_size_color_matrix" class="pagebreak">
                    <fieldset id="div_size_color_matrix" >
                        <legend>Size and Color Breakdown</legend>
                        <table  class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                            <tr>
                            	<td>PO Number</td>
                            	<td>PO Received Date</td>
                            	<td>Ship Date</td>
                            	<td>Lead Time</td>
                            	<td>Ship.days in Hand</td>
                            	<td>Gmts Item</td>
                                <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                <?
                                foreach($nameArray_size  as $result_size)
                                {
									?>
                                	<td align="center" style="border:1px solid black"><?=$size_library[$result_size[csf('size_number_id')]];?></td>
                                <? } ?>
                                <td  align="center"> Total Order Qty(Pcs)</td>
                                <td  align="center"> Excess %</td>
                                <td  align="center"> Total Plan Cut Qty(Pcs)</td>
                            </tr>
                            <?
                            $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                           	$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
                           	$result_cs=sql_select( "select b.item_number_id,b.color_number_id,sum(b.order_quantity) as order_quantity,b.size_number_id,b.po_break_down_id from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.job_no_mst ='$job_no' and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 group by b.item_number_id,b.color_number_id,b.size_number_id,b.po_break_down_id");
                           	$color_size_data=array();
                           	foreach ($result_cs as $row) {
                           		$color_size_data[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]+=$row[csf('order_quantity')];
                           	}

                           	$sql_color="select a.po_number,a.id,a.po_received_date,a.shipment_date,b.item_number_id,b.color_number_id,sum(b.plan_cut_qnty) as plan_cut_qnty,a.shiping_status from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.job_no_mst ='$job_no' and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 group by a.po_number,a.id,a.po_received_date,a.shipment_date,b.item_number_id,b.color_number_id,a.shiping_status order by a.shipment_date asc ";
                           	//echo $sql_color;
							$result_color_size=sql_select( $sql_color);

							foreach ($result_color_size as $row) 
							{
								?>
								<tr>
									<td><?php echo $row[csf('po_number')] ?></td>
									<td><?php echo change_date_format($row[csf('po_received_date')]); ?></td>
									<td><?php echo change_date_format($row[csf('shipment_date')]); ?></td>
									<?php 

										$date1=date_create($row[csf('po_received_date')]);
										$date2=date_create($row[csf('shipment_date')]);
										$diff=date_diff($date1,$date2);
										$current_date=date_create(strval(date('Y-m-d')));
										$diff1=date_diff($current_date,$date2);
										
										$day_in_hand=$diff1->format("%R%a days");
										if($row[csf('shiping_status')]==3)
										{
											$day_in_hand='0 days';
										}
									 ?>
									<td><?php echo $diff->format("%a days"); ?></td>
									<td><?php echo str_replace("+", "", $day_in_hand); ?></td>
									<td><?php echo $garments_item[$row[csf('item_number_id')]]; ?></td>
									<td><?php echo $color_library[$row[csf('color_number_id')]]; ?></td>
									<?
									$total=0;

                                    foreach($nameArray_size  as $key)
                                    {
										?>
                                    	<td align="center" style="border:1px solid black">
                                    		<?
                                    				$qnty=0;
                                    				$qnty=$color_size_data[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$key[csf('size_number_id')]];

                                    				echo number_format($qnty);
                                    				$size_wise_total[$key[csf('size_number_id')]]+=$qnty;
                                    				$total+=$qnty;
                                    			?>
                                    	</td>
                                   	 	<? 
                                	}

                                	$grand_order_total+=$total;
        							$grand_plan_total+=$row[csf('plan_cut_qnty')];

        							$plan_cut_dif=$row[csf('plan_cut_qnty')]-$total;
        							$ex_cut_perc=($plan_cut_dif/$total)*100;

                                	?>
                                	<td align="center"><?php echo number_format($total); ?></td>
                                	<td align="center"><?php echo number_format($ex_cut_perc,2); ?>%</td>
                                	<td align="center"><?php echo number_format($row[csf('plan_cut_qnty')]); ?></td>
								</tr>
								<?
							}
                            ?>
                            <tr>
                            	<td align="right" colspan="7">Total</td>
                            	<?
                                    foreach($nameArray_size  as $key)
                                    {
										?>
                                    	<td align="center" style="border:1px solid black">
                                    		<strong><?
                                    				echo number_format($size_wise_total[$key[csf('size_number_id')]])
                                    			?>
                                    	</strong>
                                    	</td>
                                   	 	<? 
                                	}
                                	?>
                                <td align="center"><strong><?=number_format($grand_order_total)?></strong></td>
                                <td></td>
                                <td align="center"><strong><?=number_format($grand_plan_total)?></strong></td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
			<?

			$actule_po_size=sql_select("select gmts_size_id from wo_po_acc_po_info where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by gmts_size_id ");
			$actule_po_data=sql_select( "SELECT a.id as po_id,a.po_number, b.acc_po_no, a.po_received_date, b.acc_ship_date, b.gmts_color_id, b.gmts_size_id, b.acc_po_qty, b.id as actule_po_id , b.gmts_item from wo_po_break_down a join wo_po_acc_po_info b on a.id=b.PO_BREAK_DOWN_ID where b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and b.is_deleted=0 and b.status_active=1 and a.is_deleted=0 and a.status_active=1");
			$actule_po_arr=array();
			$attribute=array('po_number','acc_po_no','po_received_date','acc_ship_date','gmts_color_id','gmts_size_id','acc_po_qty','gmts_item');
			foreach ($actule_po_data as $row) {
				foreach ($attribute as $attr) {
					$actule_po_arr[$row[csf('po_id')]][$row[csf('actule_po_id')]][$attr]=$row[csf($attr)];
				}
				$actual_color_size[$row[csf('po_id')]][$row[csf('actule_po_id')]][$row[csf('gmts_item')]][$row[csf('gmts_color_id')]][$row[csf('gmts_size_id')]] =$row[csf('acc_po_qty')];				
			}

			$booking_dtls_data=sql_select(" SELECT a.po_number, a.pub_shipment_date,b.fabric_color_id,b.gmts_color_id, b.fin_fab_qnty, b.grey_fab_qnty, c.size_number_id,c.excess_cut_perc from wo_po_break_down a join wo_booking_dtls b on a.id=b.po_break_down_id join WO_PO_COLOR_SIZE_BREAKDOWN c on c.id=b.color_size_table_id where b.booking_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 order by a.id, c.color_order, c.size_order ASC");
			$size_lib_arr = return_library_array("select id,size_name from  lib_size ","id","size_name");
		
		?>
		<div id="div_size_color_matrix" class="pagebreak">
            <fieldset id="div_size_color_matrix" >
                <legend>Actual PO Info</legend>
                <table  class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                    <tr>
                    	<td>PO Number</td>
                    	<td>Actual PO</td>
                    	<td>PO Received Date</td>
                    	<td>Ship Date</td>
                    	<td>Gmts Item</td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                        <?
                        foreach($actule_po_size  as $result_size)
                        {
							?>
                        	<td align="center" style="border:1px solid black"><?=$size_library[$result_size[csf('gmts_size_id')]];?></td>
                        <? } ?>
                        <td  align="center"> Total Order Qty(Pcs)</td>
                    </tr>
                    <?

					foreach ($actule_po_arr as $po_id=>$po_data) 
					{	$k=1;
						foreach ($po_data as $actule_po_id=>$data) {
							$total_size_qty=0;
							if($k==1){
						 	?>
							<tr>
								<td rowspan="<? echo count($po_data)?>"><?php echo $data['po_number'] ?></td>
								<td><?php echo $data['acc_po_no'] ?></td>								
								<td><?php echo change_date_format($data['po_received_date']) ?></td>		
								<td><?php echo change_date_format($data['acc_ship_date']) ?></td>			
								<td><?php echo $garments_item[$data['gmts_item']] ?></td>
								<td><?php echo $color_library[$data['gmts_color_id']] ?></td>
								<?php
								foreach($actule_po_size  as $result_size)
		                        {
		                        	$size_qty=$actual_color_size[$po_id][$actule_po_id][$data['gmts_item']][$data['gmts_color_id']][$result_size[csf('gmts_size_id')]];
		                        	$total_size_qty+=$size_qty;
									?>
		                        	<td align="center" width="30"><? echo $size_qty; ?></td>
		                        <? } ?>
		                        <td><? echo $total_size_qty ?></td>				
							</tr>
							<? 
							}
							else{ ?>
								<tr>
									<td><?php echo $data['acc_po_no'] ?></td>								
									<td><?php echo change_date_format($data['po_received_date']) ?></td>		
									<td><?php echo change_date_format($data['acc_ship_date']) ?></td>			
									<td><?php echo $garments_item[$data['gmts_item']] ?></td>
									<td><?php echo $color_library[$data['gmts_color_id']] ?></td>
									<?php
									foreach($actule_po_size  as $result_size)
			                        {
										$size_qty=$actual_color_size[$po_id][$actule_po_id][$data['gmts_item']][$data['gmts_color_id']][$result_size[csf('gmts_size_id')]];
										$total_size_qty+=$size_qty;
										?>
		                        	<td align="center" width="30"><? echo $size_qty; ?></td>
			                        <? } ?>
			                        <td><? echo $total_size_qty ?></td>					
								</tr>
							<? }
							$k++;
						}
					}						
                    ?>       
                   
                </table>
            </fieldset>
        </div>
        <div id="div_size_color_matrix" class="pagebreak">
            <fieldset id="div_size_color_matrix" >
                <legend>PO, Color and Size wise fabric Required Quantity</legend>
                <table  class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                	<tr>
                    	<th>PO Number</th>
                    	<th>Ship Date</th>
                    	<th>Fabric Color</th>
                    	<th>Body Color</th>
                    	<th>Size</th>
                    	<th>Total Finish Fabric (Kg)</th>
                    	<th>Total Greige Fabric (Kg)</th>
                    	<th>Process Loss %</th>
                    </tr>
                    <? $k=1;
					foreach ($booking_dtls_data as $row) { 
						$str=$row[csf('po_number')].'_'.$row[csf('gmts_color_id')];
						if (!in_array($str,$pocolortmparray) )
						{
							if($k!=1)
							{
							?>
								<tr class="tbl_bottom">
									<th colspan="5" align="right">PO & GMTS. Color Total:</th>
                                    <th><? echo number_format($subFinQty,2) ?></th>
                                    <th><? echo number_format($subGreyQty,2) ?></th>
								</tr>
							<?
								unset($subFinQty);
								unset($subGreyQty);
							}
							$pocolortmparray[]=$str;  
							$k++;
						}
						
						?>
                    	<tr>
	                    	<td><? echo $row[csf('po_number')]; ?></td>
	                    	<td><? echo change_date_format($row[csf('pub_shipment_date')]) ?></td>
	                    	<td><? echo $color_library[$row[csf('fabric_color_id')]] ?></td>
	                    	<td><? echo $color_library[$row[csf('gmts_color_id')]] ?></td>
	                    	<td align="center"><? echo $size_lib_arr[$row[csf('size_number_id')]] ?></td>
	                    	<td align="center"><? echo number_format($row[csf('fin_fab_qnty')],2) ?></td>
	                    	<td align="center"><? echo number_format($row[csf('grey_fab_qnty')],2) ?></td>
	                    	<td align="center"><? echo $row[csf('excess_cut_perc')] ?></td>
                    	</tr>
                    <?
						$subFinQty+=$row[csf('fin_fab_qnty')];
						$subGreyQty+=$row[csf('grey_fab_qnty')];
                    	$atotal_fin_fab_qnty+=$row[csf('fin_fab_qnty')];
                    	$atotal_grey_fab_qnty+=$row[csf('grey_fab_qnty')];
                    	} 
                    ?>
                    <tr class="tbl_bottom">
                        <th colspan="5" align="right">PO & GMTS. Color Total:</th>
                        <th><? echo number_format($subFinQty,2) ?></th>
                        <th><? echo number_format($subGreyQty,2) ?></th>
                    </tr>
                    <tr>
                    	<th colspan="5" align="right">Total</th>
                    	<th><? echo number_format($atotal_fin_fab_qnty,2) ?></th>
                    	<th><? echo number_format($atotal_grey_fab_qnty,2) ?></th>
                    </tr>
                </table>
            </fieldset>
        </div>        
       </div>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report25")//Print B25
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id, brand_name from lib_buyer_brand ",'id','brand_name');
	$user_name_arr=return_library_array( "select id, user_full_name from user_passwd ",'id','user_full_name');

	//$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//wo_pre_cost_fabric_cost_dtls
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<style type="text/css">
		@media print {
		    .pagebreak { page-break-before: always; } /* page-break-after works, as well */
		}
	</style>
	<div style="width:1330px" align="center">
    <?php
    	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
		$fabric_composition=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
		
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		$max_approve_date_data = sql_select("select min(b.approved_date) as approved_date,max(b.approved_date) as last_approve_date,max(b.un_approved_date) as un_approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		$first_approve_date='';
		$last_approve_date='';
		$un_approved_date='';
		if(count($max_approve_date_data))
		{
			$last_approve_date=$max_approve_date_data[0][csf('last_approve_date')];
			$first_approve_date=$max_approve_date_data[0][csf('approved_date')];
			$un_approved_date=$max_approve_date_data[0][csf('un_approved_date')];
		}
		
		if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'"); else $location="";
		$sql_loc=sql_select("select id,location_name,address from lib_location where company_id=$cbo_company_name");
		foreach($sql_loc as $row)
		{
			$location_name_arr[$row[csf('id')]]= $row[csf('location_name')];
			$location_address_arr[$row[csf('id')]]= $row[csf('address')];
		}		
		$yes_no_sql=sql_select("select job_no,cons_process from  wo_pre_cost_fab_conv_cost_dtls where job_no='$txt_job_no'  and status_active=1 and is_deleted=0  order by id");
		
		$peach=''; $brush=''; $fab_wash='';

		$emb_print=sql_select("select id, job_no, emb_name, emb_type from wo_pre_cost_embe_cost_dtls where  job_no='$txt_job_no' and status_active=1 and is_deleted=0 and cons_dzn_gmts>0 and emb_name in (1,2,3) order by id");
		
		$emb_print_data=array();
		$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,99=>$blank_array);
		
		foreach ($emb_print as $row) 
		{
			$emb_print_data[$row[csf('job_no')]][$row[csf('emb_name')]].=$type_array[$row[csf("emb_name")]][$row[csf('emb_type')]].",";
		}
		
		// echo "<pre>";
		// print_r();

		$nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, (b.job_quantity*b.total_set_qnty) as jobqtypcs, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant,b.factory_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks, a.sustainability_standard, b.brand_id, a.quality_level, a.fab_material, a.requisition_no, b.qlty_label, b.packing, b.job_no, a.proceed_knitting, a.proceed_dyeing from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$job_no_str=$nameArray[0][csf('job_no')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		$delivery_date=$nameArray[0][csf('delivery_date')];
		$requisition_no=$nameArray[0][csf('requisition_no')];
		$jobqtypcs=$nameArray[0][csf('jobqtypcs')];
		
		$job_yes_no=sql_select("select id, job_id,job_no, gmts_item_id, set_item_ratio, smv_pcs, smv_set, smv_pcs_precost, smv_set_precost, complexity, embelishment, cutsmv_pcs, cutsmv_set, finsmv_pcs, finsmv_set, printseq, embro, embroseq, wash, washseq, spworks, spworksseq, gmtsdying, gmtsdyingseq, ws_id, aop, aopseq,bush,bushseq,peach,peachseq,yd,ydseq from wo_po_details_mas_set_details where job_no='$job_no_str'");

		$po_shipment_date=sql_select("select  MIN(pub_shipment_date) as min_shipment_date,max(pub_shipment_date) as max_shipment_date from wo_po_break_down where id in(".$po_id_all.") order by shipment_date asc ");
         $min_shipment_date='';
         $max_shipment_date='';
         foreach ($po_shipment_date as $row) {
         	 $min_shipment_date=$row[csf('min_shipment_date')];
         	 $max_shipment_date=$row[csf('max_shipment_date')];
         	 break;
         }

        $po_running_cancel= sql_select("select case when status_active=1 then  PO_NUMBER end as running_po, case when status_active>1 then po_number end as cancel_po,po_quantity from wo_po_break_down  where id in(".$po_id_all.") order by shipment_date asc ");
        $running_po='';
        $cancel_po='';
        $running_po_qnty=0;
        foreach ($po_running_cancel as $row) {
        	if(!empty($row[csf('running_po')]))
        	{
        		if(!empty($running_po))
        		{
        			$running_po.=",".$row[csf('running_po')];
        		}
        		else{
        			$running_po.=$row[csf('running_po')];
        		}
        		$running_po_qnty+=$row[csf('po_quantity')];
        	}
        	if(!empty($row[csf('cancel_po')]))
        	{
        		if(!empty($cancel_po))
        		{
        			$cancel_po.=",".$row[csf('cancel_po')];
        		}
        		else{
        			$cancel_po.=$row[csf('cancel_po')];
        		}
        	}
        }
        $stype_color_res=sql_select("select  stripe_type from wo_pre_stripe_color where job_no='$txt_job_no' and status_active=1 and is_deleted=0 group by stripe_type");
        $stype_color='';
        foreach ($stype_color_res as $val) {
        	if(!empty($stype_color))
        	{
        		$stype_color.=", ".$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        	else
        	{
        		$stype_color=$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        	
        }
        $yd_aop_sql=sql_select("select id, job_no,  color_type_id from wo_pre_cost_fabric_cost_dtls where job_no='$txt_job_no' and status_active=1 and is_deleted=0 order by id asc");

        $yd=''; $aop='';
		foreach ($yes_no_sql as $row) {
			
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'peach') !== false)
        	{
			    if(!empty($peach))
			    {
			    	$peach.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$peach.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brush') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brush [With Finish]') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brushing') !== false)
        	{
			    if(!empty($brush))
			    {
			    	$brush.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$brush.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'wash') !== false || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'washing') !== false)
        	{
			    if(!empty($fab_wash))
			    {
			    	$fab_wash.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$fab_wash.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'y/d') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('YD at Main Fabric Booking') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'yarn dyeing') !== false)
        	{
			    if(!empty($yd))
			    {
			    	$yd.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$yd.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'aop') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('All Over Printing'))
        	{
			    if(!empty($aop))
			    {
			    	$aop.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$aop.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
		}
  		ob_start();     
		?>	
											<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td width="200" style="font-size:28px"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:28px;"> <?php echo $company_library[$cbo_company_name]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:18px"><?=$location_address_arr[$location]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:24px">
                            	<span style="float:center;"><b><strong> <font style="color:black">Main Fabric Booking </font></strong></b></span> 
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:20px">
							<?
							if(str_replace("'","",$id_approved_id) ==1){ ?>
                            <span style="font-size:20px; float:center;"><strong> <font style="color:green"> <? echo "[Approved]"; ?> </font></strong></span> 
                               <? }else{ ?>
								<span style="font-size:20px; float:center;"><strong> <font style="color:red"><? echo "[Not Approved]"; ?> </font></strong></span> 
							   <? } ?>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
		<?
        $job_no=trim($txt_job_no,"'"); $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff,min(factory_received_date) as factory_received_date, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
      
        $to_ship=0; $fp_ship=0; $f_ship=0;

        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $factory_received_date=change_date_format($row[csf('factory_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) {
				$shiping_status.= "FP".",";
				$to_ship++;
				$fp_ship++;
			}
			else if($row[csf('shiping_status')]==2){
				$shiping_status.= "PD".",";
				$to_ship++;
			} 
			else if($row[csf('shiping_status')]==3){
				$shiping_status.= "FS".",";
				$to_ship++;
				$f_ship++;
			} 
        }

        if($to_ship==$f_ship) $shiping_status= "Full shipped";
        else if($to_ship==$fp_ship) $shiping_status= "Full Pending";
        else $shiping_status= "Partial Delivery";
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$factory_received_date=implode(",",array_filter(array_unique(explode(",",$factory_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];
			$a_process_loss=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[1];//+$extra[13]
			$b_process_loss=$extra[4]+$extra[3]+$extra[15];
			$tot_pro_loss=$a_process_loss+$b_process_loss;
			?>
			<table width="100%" class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all"  style="font-size:18px; font-family:Arial Narrow;" >
				<tr>
					<td colspan="2" rowspan="6" width="210">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" width="210">
                                <legend>Image </legend>
                                <table width="208">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="200" height="200" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
					</td>
					<td width="100"><b>Job No</b></td>
					<?php 
					 	$revised_no=$nameArray_approved_row[csf('approved_no')]-1;
						if($revised_no<0) $revised_no=0;
					 ?>
					<td width="350" colspan="3"> <span style="font-size:18px"><b style="float:left;font-size:18px"><? echo trim($txt_job_no,"'");if(!empty($revised_no)){ ?>&nbsp;<span style="color: red;">/&nbsp;<? echo $revised_no; }?></span></b> </span> </td>
					<td width="100"><span style="font-size:18px"><b>Fabric Booking No</b></span></td>
					<td  width="350" colspan="3"><span style="font-size:18px"><b><?=$result[csf('booking_no')];?></b><?="<br>(".$fabric_source[$result[csf('fabric_source')]].")" ?> </span> </td>
				</tr>
 					<?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
						$order_uom_res=sql_select( "select a.order_uom from wo_po_details_master a where a.status_active=1 and a.is_deleted=0  and a.job_no='$txt_job_no' ");
						$order_uom='';
						if(count($order_uom_res))
						{
							$order_uom=$unit_of_measurement[$order_uom_res[0][csf('order_uom')]];
						}
					 ?>
				<tr>
					<td width="100" style="font-size:16px;"><b>Style Ref</b></td>
					<td  width="350" colspan="3" style="font-size:16px;" >&nbsp;<? echo $result[csf('style_ref_no')]; ?></td>
					<td width="110"><b>Booking Date</b></td>
					<td  width="350" colspan="3"> <?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>
                    </td>
				</tr>
				<tr>
					<td width="100"><span style="font-size:18px"><b>Con</b></span></td>
					<td  width="350" colspan="3">&nbsp;<span style="font-size:18px"><?=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);?><?=number_format(($sum_fin_fabqnty[0][csf('qty')]/$po_qnty_tot1)*12,2); ?></span></td>
					<td width="100"><span style="font-size:18px"><b>Buyer Name</b></span></td>
					<td  width="350" colspan="3">&nbsp;<span style="font-size:18px"><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></span></td>
				</tr>
				<tr>
				<td width="100"><span style="font-size:18px"><b>Description</b></span></td>
					<td width="350" colspan="3"><span style="font-size:18px">
						<? 
							$sql_fab="SELECT a.lib_yarn_count_deter_id AS determin_id, a.construction
							    FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							   WHERE a.job_id = b.job_id AND a.id = b.pre_cost_fabric_cost_dtls_id AND a.id = d.pre_cost_fabric_cost_dtls_id AND b.po_break_down_id = d.po_break_down_id AND b.color_size_table_id = d.color_size_table_id AND b.pre_cost_fabric_cost_dtls_id = d.pre_cost_fabric_cost_dtls_id AND d.booking_no = $txt_booking_no AND a.status_active = 1 AND d.status_active = 1 AND d.is_deleted = 0 and a.body_part_id in (1,20) group by a.lib_yarn_count_deter_id , a.construction";
							//echo $sql_fab;
							$res_fab=sql_select($sql_fab);
							$des='';
							foreach ($res_fab as $row) 
							{
								if(!empty($des))
								{
									$des."***";
								}
								$des.=$row[csf('construction')] . " ". $fabric_composition[$lip_yarn_count[$row[csf('determin_id')]]];
							}
							echo implode(",", array_unique(explode("***", $des)));
						?>
						</span></td>
						<td width="110"><b>Finish Fabric Delivary Date</b></td>
						<td  width="350" colspan="3"><? echo change_date_format($delivery_date); ?></td>
				</tr>
				<tr>
					<td width="100"><b>Fabric Source</b></td>
					<td  width="350" colspan="3"><?php echo $brand_name_arr[$result[csf('brand_id')]]; ?></td>	
					<td width="100"><b>Shipment Date</b></td>
                	<td  width="350" colspan="3"><?php echo  date('d-m-Y',strtotime($min_shipment_date));?></td>				
				</tr>
				
				<tr>
					<td width="100"><span style="font-size:18px"><b>Remarks</b></span></td>
					<td  width="350" colspan="3"><b><?php if(!empty($result[csf('remarks')])){ ?><span style="font-size: 25px;">&#8592;</span><? echo $result[csf('remarks')]; } ?></b></td>
					<td width="100"><b>Sustainability Standard</b></td>
					<td width="350" colspan="3"><?php echo $sustainability_standard[$result[csf('sustainability_standard')]]; ?></td>
				</tr>
				
                <tr>
					<td width="100"><span style="font-size:18px"><b>PO No</b></span></td>
					<td width="350" colspan="7" style="word-break: break-all;"><p style="font-size:12px;width: 450px;word-break: break-all;" ><? echo $running_po; ?></p></td>
				</tr>		
								
			</table>
			<br>
			<?
		}	
			
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			<table width="100%" style="font-family:Arial Narrow;font-size:18px" >
                <tr>
                    <td width="900">
                        <div id="div_size_color_matrix" style="float:left; max-width:1000;">
                            <fieldset id="div_size_color_matrix" style="max-width:1000;">
                                <legend>Size and Color Breakdown</legend>
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="1000" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style="border:1px solid black"><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="border:1px solid black; text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                    </td>
                    <!-- <td width="130" valign="top" align="left">
                        <div id="div_size_color_matrix" style="float:left;">
							
                        </div>
                    </td> -->
                    
                    </td>
                </tr>
			</table>
			<?
		}
		// if($cbo_fabric_source==1) end
	
	
	  	?>
		<br/>
		<br>
      	<!--  Here will be the fabric details  -->
		  <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	 </style>
     <?
	 $costing_per=""; $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
	 if($costing_per_id==1)
	{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;
	}
	if($costing_per_id==2)
	{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;
	}
	if($costing_per_id==3)
	{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;
	}
	if($costing_per_id==4)
	{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;
	}
	if($costing_per_id==5)
	{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	$nameArray_fabric_description= sql_select("select a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, b.remarks, avg(b.cons) as cons, b.process_loss_percent, avg(b.requirment) as requirment,b.po_break_down_id,  d.fabric_color_id, d.gmts_color_id, d.id as dtls_id, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0  AND a.status_active = 1 AND a.is_deleted = 0   AND c.status_active = 1  AND c.is_deleted = 0  AND b.status_active = 1  AND b.is_deleted = 0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, b.remarks,d.fabric_color_id, d.gmts_color_id, d.id,b.po_break_down_id, b.process_loss_percent order by a.body_part_id, b.dia_width");



	foreach ($nameArray_fabric_description as $row) {	
		$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."'  and approval_status=3 and color_name_id=".$row[csf('fabric_color_id')]."");

		$grouping_item=$row[csf('fabric_color_id')].'*'.$row[csf('body_part_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('color_type_id')];	
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gmts_color_id'] = $row[csf('gmts_color_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_color_id'] = $row[csf('fabric_color_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['lapdip_no'] = $lapdip_no;
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['body_part_id'] = $row[csf('body_part_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['construction'] = $row[csf('construction')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['composition'] = $row[csf('composition')];

		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gsm'] = $row[csf('gsm_weight')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_dia'] = $row[csf('dia_width')].",".$fabric_typee[$row[csf('width_dia_type')]];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['color_type_id'] = $row[csf('color_type_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['finsh_cons'] = $row[csf('cons')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gray_cons'] = $row[csf('requirment')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fin_fab_qnty'] += $row[csf('fin_fab_qnty')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['grey_fab_qnty'] += $row[csf('grey_fab_qnty')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['process_loss_percent'] = $row[csf('process_loss_percent')];

	}

	/*echo '<pre>';
	print_r($fabric_data_arr); die;*/

	?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-size: 18px;">
     	<tr>
		 	<th>Body Part</th>  
			<th>Color Name</th> 		
     		<th>Composition</th>
			<th>Construction</th>
     		<th>GSM</th>
			<th>Lab Dip No</th> 
     		<th>Dia Type with </br> Fabric Dia</th>		
     		<th>Color Type</th>
     		<th>Finish Cons</th>
     		<th>Total Finish Fabric </br>KG</th>
     	</tr>
     	<? 
     	foreach ($fabric_data_arr as $gmts_id=>$fabric_data_arr) {  
     	$i=1;     		  		
     		foreach ($fabric_data_arr as $fabric_id => $value) {
     				$fin_fab_qnty+=$value['fin_fab_qnty'];   		 	
     				$grey_fab_qnty+=$value['grey_fab_qnty'];   		 	
     		 		if($i==1){
     		 	 	?>
	     		 	<tr>
		     			<td rowspan="<? echo count($fabric_data_arr) ?>"><? echo $body_part[$value['body_part_id']] ?></td>
						<td><? echo $color_library[$gmts_id] ?></td>
						<td><? echo $value['composition'] ?></td>
		     			<td><? echo $value['construction'] ?></td>
		     			<td><? echo $value['gsm'] ?></td>
						<td><? echo $value['lapdip_no']; ?></td>
		     			<td><? echo $value['fabric_dia'] ?></td>
		     			<td><? echo $color_type[$value['color_type_id']] ?></td>
		     			<td align="right";><? echo $value['finsh_cons'] ?></td>
		     			<td align="center";><? echo $value['fin_fab_qnty'],2 ?></td>
	     			</tr>
     		 		<? } 
     		 		else { ?>
     		 			<tr>
						  <td><? echo $body_part[$value['body_part_id']] ?></td>
			     			<td><? echo $color_library[$value['fabric_color_id']] ?></td>
							<td><? echo $value['composition'] ?></td>
		     				<td><? echo $value['construction'] ?></td>
			     			<td><? echo $value['gsm'] ?></td>
							<td><? echo $value['lapdip_no']; ?></td>
			     			<td><? echo $value['fabric_dia'] ?></td>
			     			<td><? echo $color_type[$value['color_type_id']] ?></td>
			     			<td><? echo $value['finsh_cons'] ?></td>
			     			<td><? echo number_format($value['fin_fab_qnty'],2) ?></td>
	     				</tr>
     		 		<? }
     		 		$i++;
     		 	//}
     		}
     	} 
     	?>
     	<tr>
     		<th colspan="9">Total</th>
     		<th align="center";><?echo number_format($fin_fab_qnty);  ?></th>
     	</tr>
     </table>
      <br/>
     <?
	$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_nos' and status_active=1");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($po_id_all) and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)

									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    //$colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
													  $colar_excess_per=($plan_cut*$collar_ex_per)/100;
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }
   ?>
        <br/>

		<!--  Here will be the fabric details end  -->

       		 <table width="100%">
       		 	<tr>
       		 		<td width="100%" style="float: right;">
 			       		 <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <tr align="center">
 			                    	<td colspan="10"><b>Trims Dyes To Match</b></td>
 			                    </tr>
 			                    <tr align="center">
 				                    <td>Sl</td>
 				                    <td>Item</td>
 				                    <td>Item Description</td>
 				                    <td>Body Color</td>
 				                    <td>Item Color</td>
 				                    <td>Finish Qty.</td>
 				                    <td>UOM</td>
 			                    </tr>
 			                    <?
 								$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
 								$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
 								$bookingId=0;
 								foreach($sql as $row){
 									$bookingId= $row[csf('id')];
 								}
 								$co=0;
 								$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty, b.description   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom, b.description order by a.fabric_color");

 								foreach($sql_data  as $row)
 			                    {
 									$co++;
 									?>
 				                    <tr>
 				                    <td><? echo $co; ?></td>
 				                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
 				                    <td><p> <? echo $row[csf('description')];?></p></td>
 				                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
 				                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
 				                    <td align="right"><? echo $row[csf('qty')];?></td>
 				                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
 				                    </tr>
 				                    <?
 								}
 								?>
 			            </table>
       		 		</td>
       		 	</tr>
       		 </table>
            <br>
			<br>

        <table  width="100%" style="margin: 0px;padding: 0px;">
        <?php $stripe_color_wise=array(); ?>
       
        <tr>
        	<td width="100%">
        		<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >
        		       
        		        <tr>
        		            <td align="center" colspan="9">  <b>Stripe Details</b></td>
        		            
    		            </tr>
        		        <?
        				$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
        				$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d, wo_po_color_size_breakdown e where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1 and b.is_deleted=0 and e.id=b.color_size_table_id and e.is_deleted=0 and e.status_active=1 and e.color_number_id=d.color_number_id  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");        				
        				$result_data=sql_select($sql_stripe);
        				foreach($result_data as $row)
        				{
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
        				}
        				?>
        		            <tr>
	        		            <td align="center" width="30"> SL</td>
	        		            <td align="center" width="100"> Body Part</td>
	        		            <td align="center" width="80"> Fabric Color</td>
	        		            <td align="center" width="70"> Fabric Qty(KG)</td>
	        		            <td align="center" width="70"> Stripe Color</td>
	        		            <td align="center" width="70"> Stripe Measurement</td>
	        		            <td align="center" width="70"> Stripe Uom</td>
	        		            <td  align="center" width="70"> Qty.(KG)</td>
	        		            <td  align="center" width="70"> Y/D Req.</td>
        		            </tr>
        		            <?
        					$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
        		            foreach($stripe_arr as $body_id=>$body_data)
        		            {
        						foreach($body_data as $color_id=>$color_val)
        						{
        							$rowspan=count($color_val['stripe_color']);
        							$composition=$stripe_arr2[$body_id][$color_id]['composition'];
        							$construction=$stripe_arr2[$body_id][$color_id]['construction'];
        							$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
        							$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
        							$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

        							if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        							else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

        							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
        								WHERE a.job_id=b.job_id and
        								a.id=b.pre_cost_fabric_cost_dtls_id and
        								c.job_no_mst=a.job_no and
        								c.id=b.color_size_table_id and
        								b.po_break_down_id=d.po_break_down_id and
        								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
        								d.booking_no =$txt_booking_no and
        								a.body_part_id='".$body_id."' and
        								a.color_type_id='".$color_type_id."' and
        								a.construction='".$construction."' and
        								a.composition='".$composition."' and
        								a.gsm_weight='".$gsm_weight."' and
        								$color_cond and
        								d.status_active=1 and
        								d.is_deleted=0
        								");
        						
        								list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
        							$sk=0;
    								foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
        							{
        								
        								?>
	        							<tr>
		        							<?
		        							if($sk==0)
		        							{


			        							$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			        							?>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
			        							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
			        							<?
			        							$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			        							$i++;
			        						}
		        							$sk=0;
		        							

		        								$measurement=$color_val['measurement'][$strip_color_id];
		        								$uom=$color_val['uom'][$strip_color_id];
		        								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
		        								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
		        								
		        								?>
		        							
			        								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
			        								<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
			        		                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
			        								<td align="right"> <? echo  number_format($fabreqtotkg,2); ?> &nbsp;</td>
			        								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
		        								
		        								<?
		        								
		        								$sk++;
		        								$total_fabreqtotkg+=$fabreqtotkg;
		        								$stripe_color_wise[$color_name_arr[$s_color_val]]+=$fabreqtotkg;
		        							
		        							
		        							?>
	        							</tr>
	        							<?
	        						}
        						}
        					}
        					?>
	        		            <tfoot>
		        		            <tr>
			        		            <td colspan="3">Total </td>
			        		            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
			        		            <td></td>
			        		            <td></td>
			        		            <td>   </td>
			        		            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
			        		        </tr>
	        		            </tfoot>
        		            </table>
        	</td>
        </tr>
         </table >
      
        <br/>
		<br/>
		<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff Information</strong>
			  				</td>

			  			</tr>
			  		</table>



					<br/><br/>

					

			</div>
				<?php



		$lab_dip_color_arr=array();
		$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
		$style_name_arr=return_library_array( "select job_no, style_ref_no from wo_po_details_master", "job_no", "style_ref_no"  );
		foreach($lab_dip_color_sql as $row)
		{
			$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
		}



			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type,a.width_dia_type,a.gsm_weight,a.composition,a.construction,a.job_no,a.color_type_id
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order,e.body_part_type";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$style=$style_name_arr[$collar_cuff_row[csf('job_no')]];
				$comp=$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]];
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
				// $collar_cuff_data_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]['composition']=$comp;
				$collar_cuff_data_arr[$style][$collar_cuff_row[csf('item_number_id')]][$collar_cuff_row[csf('body_part_type')]][$comp][$collar_cuff_row[csf('color_type_id')]][$collar_cuff_row[csf('color_size_sensitive')]][$collar_cuff_row[csf('color_number_id')]]['color_break_down']=$collar_cuff_row[csf('color_break_down')];
				$collar_cuff_data_arr[$style][$collar_cuff_row[csf('item_number_id')]][$collar_cuff_row[csf('body_part_type')]][$comp][$collar_cuff_row[csf('color_type_id')]][$collar_cuff_row[csf('color_size_sensitive')]][$collar_cuff_row[csf('color_number_id')]]['job_no']=$collar_cuff_row[csf('job_no')];
				$collar_cuff_data_arr[$style][$collar_cuff_row[csf('item_number_id')]][$collar_cuff_row[csf('body_part_type')]][$comp][$collar_cuff_row[csf('color_type_id')]][$collar_cuff_row[csf('color_size_sensitive')]][$collar_cuff_row[csf('color_number_id')]]['body_part_full_name']=$collar_cuff_row[csf('body_part_full_name')];
			}
		
		unset($collar_cuff_sql_res);
		//$count_collar_cuff=count($collar_cuff_size_arr);
	    //  echo "<pre>";
		//  print_r($collar_cuff_data_arr) ;

		$order_plan_qty_arr=array();
		$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($txt_order_no_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
		foreach($color_wise_wo_sql_qnty as $row)
		{
			$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
			$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
		}
		unset($color_wise_wo_sql_qnty);

	

			if(count($collar_cuff_item_size_arr[40])>0){

				$count_collar_cuff=count($collar_cuff_size_arr[40]);
				$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
					<div width="100%" style="overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="100%" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
							<td colspan="8" align="center"><b>Collar Details(Collar)</b></td>
						</tr>
						<tr>
							<td width="100" rowspan="2">Style Name</td>
							<td width="100" rowspan="2">Gmts Item</td>
							<td width="100" rowspan="2">Body Part</td>
							<td width="100" rowspan="2">Actual Qty(Pcs)</td>
							<td width="100" rowspan="2">Collar Composition</td>
							<td width="100" rowspan="2">Color Type</td>
							<td width="100" rowspan="2">Combo</td>
							<td width="100" rowspan="2">Fabric Color</td>
								<?
								foreach($collar_cuff_size_arr[40]  as $size_number_id)
								{
									?>
									<td align="center" style="border:1px solid black" width="100"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
								}
								?>
							<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
							<td rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
						<tr>
							
							<?
							
							// foreach($collar_cuff_data_arr[40]  as $size_number_id=>$size_number)
							// {
							foreach($collar_cuff_item_size_arr[40]  as $size_number_id=>$size_number)
							{
								if(count($size_number)>0)
								{
									foreach($size_number  as $item_size=>$val)
									{
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									}
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
							}

							$pre_size_total_arr=array();

							foreach($collar_cuff_data_arr as $style_id=>$style_data){
								foreach($style_data as $item_id=>$item_data){
									foreach($item_data[40] as $desc_id=>$desc_data){
										foreach($desc_data as $colortype_id=>$color_size_sensitive_arr){							
									foreach($color_size_sensitive_arr as $pre_cost_id=>$pre_cost_data)
									{
										foreach($pre_cost_data as $color_number_id=>$val)
										{
											// foreach($color_number_data as $color_size_sensitive=>$color_break_down)
											// {










										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										$total_gmt_actual_qty=0;
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td><?=$style_id;?></td>
											<td><?=$garments_item[$item_id];?></td>
											<td><?=$val[('body_part_full_name')];?></td>
											<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$val[('job_no')]][$item_id][$color_number_id][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
											<td><?=$desc_id;?></td>
											<td><?=$color_type[$colortype_id];?></td>
											<td>
												<?
												if( $color_size_sensitive==3)
												{
													echo strtoupper ($constrast_color_arr[$color_number_id]) ;
													$lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
												}
												else
												{
													echo $color_library[$color_number_id];
													$lab_dip_color_id=$color_number_id;
												}
												?>
											</td>
											<td><?=$color_library[$color_number_id];;?></td>
											<?
											foreach($collar_cuff_size_arr[40] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
												
														// if($body_type==50) $plan_cut+=($order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'])*2;
														 $plan_cut+=$order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'];
													
													
													//$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

													$collar_ex_per=$collar_cuff_percent_arr[40][$color_number_id][$size_number_id];
													// echo $collar_ex_per.'=';

												
												if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; 

												// $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
												$tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
													$collerqty=($plan_cut+$colar_excess_per);

													//$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

													echo number_format($collerqty);
													$pre_size_total_arr[40][$size_number_id]+=$collerqty;
													$grand_size_total_arr[$size_number_id]+=$collerqty;
													
													$pre_color_total_collar+=$collerqty;
													$pre_color_total_collar_order_qnty+=$plan_cut;

													//$pre_grand_tot_collar_order_qty+=$plan_cut;
													?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar[40]+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty[40]+=$pre_color_total_collar_order_qnty;

										$grand_tot_collar+=$pre_color_total_collar;
										$grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
											}
										}
									}
								}
							}
						}
							?>
						</tr>
						<tr>
					
							<td colspan="8" width="100"> Total</td>
								<?
								foreach($pre_size_total_arr[40]  as $size_qty)
								{
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
								}
								?>
							<td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar[40]); ?></td>
							<td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar[40]-$pre_grand_tot_collar_order_qty[40])/$pre_grand_tot_collar_order_qty[40])*100,2); ?></td>
						</tr>
					</table>
					<?}?>
					<br>
					<br>
					<?php

				if(count($collar_cuff_item_size_arr[50])>0){

						


					?>
					<table width="100%" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
							<td colspan="8" align="center"><b>Cuff Details  (Cuff)  </b></td>
						</tr>
						<tr>
							<td width="100" rowspan="2">Style Name</td>
							<td width="100" rowspan="2">Gmts Item</td>
							<td width="100" rowspan="2">Body Part</td>
							<td width="100" rowspan="2">Actual Qty(Pcs)</td>
							<td width="100" rowspan="2">Collar Composition</td>
							<td width="100" rowspan="2">Color Type</td>
							<td width="100" rowspan="2">Combo</td>
							<td width="100" rowspan="2">Fabric Color</td>
								<?
								foreach($collar_cuff_size_arr[50]  as $size_number_id)
								{
									?>
									<td align="center" style="border:1px solid black" width="100"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
								}
								?>
							<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
							<td rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
						<tr>
							
							<?
							
							// foreach($collar_cuff_data_arr[40]  as $size_number_id=>$size_number)
							// {
							foreach($collar_cuff_item_size_arr[50]  as $size_number_id=>$size_number)
							{
								if(count($size_number)>0)
								{
									foreach($size_number  as $item_size=>$val)
									{
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									}
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
							}

							$pre_size_total_arr=array();

							foreach($collar_cuff_data_arr as $style_id=>$style_data){
								foreach($style_data as $item_id=>$item_data){
									foreach($item_data[50] as $desc_id=>$desc_data){
										foreach($desc_data as $colortype_id=>$color_size_sensitive_arr){							
									foreach($color_size_sensitive_arr as $pre_cost_id=>$pre_cost_data)
									{
										foreach($pre_cost_data as $color_number_id=>$val)
										{
											// foreach($color_number_data as $color_size_sensitive=>$color_break_down)
											// {




										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										$total_gmt_actual_qty=0;
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td><?=$style_id;?></td>
											<td><?=$garments_item[$item_id];?></td>
											<td><?=$val[('body_part_full_name')];?></td>
											<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$val[('job_no')]][$item_id][$color_number_id][50];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
											<td><?=$desc_id;?></td>
											<td><?=$color_type[$colortype_id];?></td>
											<td>
												<?
												if( $color_size_sensitive==3)
												{
													echo strtoupper ($constrast_color_arr[$color_number_id]) ;
													$lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
												}
												else
												{
													echo $color_library[$color_number_id];
													$lab_dip_color_id=$color_number_id;
												}
												?>
											</td>
											<td><?=$color_library[$color_number_id];;?></td>
											<?
											foreach($collar_cuff_size_arr[50] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
												
													 $plan_cut+=($order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'])*2;
													
													
													
													//$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

													$collar_ex_per=$collar_cuff_percent_arr[50][$color_number_id][$size_number_id];
													// echo $collar_ex_per.'=';

												 if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; 
													
												// $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
												$tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
													$collerqty=($plan_cut+$colar_excess_per);

													//$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

													echo number_format($collerqty);
													$pre_size_total_arr[50][$size_number_id]+=$collerqty;
													$pre_color_total_collar+=$collerqty;
													$pre_color_total_collar_order_qnty+=$plan_cut;

													//$pre_grand_tot_collar_order_qty+=$plan_cut;
													?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar[50]+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty[50]+=$pre_color_total_collar_order_qnty;

										$grand_tot_collar+=$pre_color_total_collar;
										$grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
											}
										}
									}
								}
							}
						}
							?>
						</tr>
						<tr>
					
							<td colspan="8"> Total</td>
								<?
								foreach($pre_size_total_arr[50]  as $size_qty)
								{
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
								}
								?>
							<td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar[50]); ?></td>
							<td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty[50])/$pre_grand_tot_collar_order_qty[50])*100,2); ?></td>
						</tr>
						<?php
						}
						?>
						<!-- <tr>
								
								<td colspan="8">Grand Total</td>
									<?
									foreach($grand_size_total_arr  as $size_qty)
									{
										?>
										<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
										<?
									}
									?>
								<td style="border:1px solid black; text-align:center"><? echo number_format($grand_tot_collar); ?></td>
								<td align="center" style="border:1px solid black"><? echo number_format((($grand_tot_collar-$grand_tot_collar_order_qty)/$grand_tot_collar_order_qty)*100,2); ?></td>
						 </tr> -->
					</table>

				
				
					</div>
			
				<?
				
				
				?>



				<br>

		
		
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;">
            <tr>
                <td width="49%" valign="top">
				<?  echo get_spacial_instruction($txt_booking_no,"97%",118); ?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                				<?
                				$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
									 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
									 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

								$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
                				 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");


                				if(count($unapprove_data_array)>0)
                				{
                				$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
                					$unapproved_request_arr=array();
                					foreach($sql_unapproved as $rowu)
                					{
                						$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
                					}
                		 		?>
                		       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
                		            <thead>
                		            <tr style="border:1px solid black;">
                		                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                		                </tr>
                		                <tr style="border:1px solid black;">
                		                <th width="3%" style="border:1px solid black;">Sl</th>
                						<th width="30%" style="border:1px solid black;">Name</th>
                						<th width="20%" style="border:1px solid black;">Designation</th>
                						<th width="5%" style="border:1px solid black;">Approval Status</th>
                						<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                						<th width="22%" style="border:1px solid black;"> Date</th>

                		                </tr>
                		            </thead>
                		            <tbody>
                		            <?
                					$i=1;
                					foreach($unapprove_data_array as $row){

                					?>
                		            <tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
                						<td width="20%" style="border:1px solid black;"><? echo '';?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
                		            </tr>
                		                <?
                						$i++;
                						$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
                						$un_approved_date=$un_approved_date[0];
                						if($db_type==0) //Mysql
                						{
                							if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}
                						else
                						{
                							if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}

                						if($un_approved_date!="")
                						{
                						?>
                					<tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
                		              </tr>

                		                <?
                						$i++;
                						}

                					}
                						?>
                		            </tbody>
                		        </table>
                				<?
                				}
                				?>

                </td>
            </tr>
        </table>
        <br/>
        
        <div style="font-family:Arial Narrow;"><?=signature_table(1, $cbo_company_name, "1400px"); ?></div>
		<br>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="show_fabric_booking_report_print23")//Print B23=>13-03-2022(md mamun ahmed sagor)
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id, brand_name from lib_buyer_brand ",'id','brand_name');
	//$user_name_arr=return_library_array( "select id, user_full_name from user_passwd ",'id','user_full_name');
	$user_name_arr=return_library_array( "select id, user_name from user_passwd ",'id','user_name');
	$team_leader_arr=return_library_array( "select id,team_leader_name from lib_marketing_team",'id','team_leader_name');
 
	//$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//wo_pre_cost_fabric_cost_dtls
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<style type="text/css">
		@media print {
		    .pagebreak { page-break-before: always; } /* page-break-after works, as well */
		}
	</style>
	<div style="width:1330px" align="center">
    <?php
    	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
		$fabric_composition=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
		
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		$max_approve_date_data = sql_select("select min(b.approved_date) as approved_date,max(b.approved_date) as last_approve_date,max(b.un_approved_date) as un_approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		$first_approve_date='';
		$last_approve_date='';
		$un_approved_date='';
		if(count($max_approve_date_data))
		{
			$last_approve_date=$max_approve_date_data[0][csf('last_approve_date')];
			$first_approve_date=$max_approve_date_data[0][csf('approved_date')];
			$un_approved_date=$max_approve_date_data[0][csf('un_approved_date')];
		}
		
		if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'"); else $location="";
		$sql_loc=sql_select("select id,location_name,address from lib_location where company_id=$cbo_company_name");
		foreach($sql_loc as $row)
		{
			$location_name_arr[$row[csf('id')]]= $row[csf('location_name')];
			$location_address_arr[$row[csf('id')]]= $row[csf('address')];
		}		
		$yes_no_sql=sql_select("select job_no,cons_process from  wo_pre_cost_fab_conv_cost_dtls where job_no='$txt_job_no'  and status_active=1 and is_deleted=0  order by id");
		
		$peach=''; $brush=''; $fab_wash='';

		$emb_print=sql_select("select id, job_no, emb_name, emb_type from wo_pre_cost_embe_cost_dtls where  job_no='$txt_job_no' and status_active=1 and is_deleted=0 and cons_dzn_gmts>0 and emb_name in (1,2,3) order by id");
		
		$emb_print_data=array();
		$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,99=>$blank_array);
		
		foreach ($emb_print as $row) 
		{
			$emb_print_data[$row[csf('job_no')]][$row[csf('emb_name')]].=$type_array[$row[csf("emb_name")]][$row[csf('emb_type')]].",";
		}
		
		// echo "<pre>";
		// print_r();

		$nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.inserted_by,a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, (b.job_quantity*b.total_set_qnty) as jobqtypcs, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant,b.factory_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks, a.sustainability_standard, b.brand_id, a.quality_level, a.fab_material, a.requisition_no, b.qlty_label, b.packing, b.job_no, a.proceed_knitting, a.proceed_dyeing,b.team_leader from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");


		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$job_no_str=$nameArray[0][csf('job_no')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		$delivery_date=$nameArray[0][csf('delivery_date')];
		$requisition_no=$nameArray[0][csf('requisition_no')];
		$jobqtypcs=$nameArray[0][csf('jobqtypcs')];
		$inserted_by2=$user_name_arr[$nameArray[0][csf('inserted_by')]];

		$service_knitting_dyeing=sql_select("SELECT booking_no_prefix_num, supplier_id, entry_form from wo_booking_mst  where booking_type=3 and entry_form in (534, 535) and status_active=1 and is_deleted=0 and item_category=12 and tagged_booking_no=$txt_booking_no and process in (1,31)");
		foreach($service_knitting_dyeing as $row){
			$service_working_company[$row[csf('entry_form')]]['booking_no'][$row[csf('booking_no_prefix_num')]]=$row[csf('booking_no_prefix_num')];
			$service_working_company[$row[csf('entry_form')]]['working_company'][$row[csf('supplier_id')]]=$supplier_name_arr[$row[csf('supplier_id')]];
		}
		
		$job_yes_no=sql_select("select id, job_id,job_no, gmts_item_id, set_item_ratio, smv_pcs, smv_set, smv_pcs_precost, smv_set_precost, complexity, embelishment, cutsmv_pcs, cutsmv_set, finsmv_pcs, finsmv_set, printseq, embro, embroseq, wash, washseq, spworks, spworksseq, gmtsdying, gmtsdyingseq, ws_id, aop, aopseq,bush,bushseq,peach,peachseq,yd,ydseq from wo_po_details_mas_set_details where job_no='$job_no_str'");

	

		 $cancel_po_arr=return_library_array( "select po_number,po_number from wo_po_break_down where job_no_mst='$job_no_str' and status_active=3", "po_number", "po_number");
	

		$po_shipment_date=sql_select("select  MIN(pub_shipment_date) as min_shipment_date,max(pub_shipment_date) as max_shipment_date from wo_po_break_down where id in(".$po_id_all.") order by shipment_date asc ");
         $min_shipment_date='';
         $max_shipment_date='';
         foreach ($po_shipment_date as $row) {
         	 $min_shipment_date=$row[csf('min_shipment_date')];
         	 $max_shipment_date=$row[csf('max_shipment_date')];
         	 break;
         }

        $po_running_cancel= sql_select("select case when status_active=1 then  PO_NUMBER end as running_po, case when status_active>1 then po_number end as cancel_po,po_quantity from wo_po_break_down  where id in(".$po_id_all.") order by shipment_date asc ");
		
        $running_po='';
        $cancel_po='';
        $running_po_qnty=0;
        foreach ($po_running_cancel as $row) {
        	if(!empty($row[csf('running_po')]))
        	{
        		if(!empty($running_po))
        		{
        			$running_po.=",".$row[csf('running_po')];
        		}
        		else{
        			$running_po.=$row[csf('running_po')];
        		}
        		$running_po_qnty+=$row[csf('po_quantity')];
        	}
        	if(!empty($row[csf('cancel_po')]))
        	{
        		if(!empty($cancel_po))
        		{
        			$cancel_po.=",".$row[csf('cancel_po')];
        		}
        		else{
        			$cancel_po.=$row[csf('cancel_po')];
        		}
        	}
        }
        $stype_color_res=sql_select("select  stripe_type from wo_pre_stripe_color where job_no='$txt_job_no' and status_active=1 and is_deleted=0 group by stripe_type");
        $stype_color='';
        foreach ($stype_color_res as $val) {
        	if(!empty($stype_color))
        	{
        		$stype_color.=", ".$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        	else
        	{
        		$stype_color=$stripe_type_arr[$val[csf('stripe_type')]];
        	}
        	
        }
        $yd_aop_sql=sql_select("select id, job_no,  color_type_id from wo_pre_cost_fabric_cost_dtls where job_no='$txt_job_no' and status_active=1 and is_deleted=0 order by id asc");

        $yd=''; $aop='';
		foreach ($yes_no_sql as $row) {
			
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'peach') !== false)
        	{
			    if(!empty($peach))
			    {
			    	$peach.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$peach.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brush') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brushing at Main Fabric Booking') || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('Brush [With Finish]') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'brushing') !== false)
        	{
			    if(!empty($brush))
			    {
			    	$brush.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$brush.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'wash') !== false || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'washing') !== false)
        	{
			    if(!empty($fab_wash))
			    {
			    	$fab_wash.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$fab_wash.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'y/d') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('YD at Main Fabric Booking') || strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'yarn dyeing') !== false)
        	{
			    if(!empty($yd))
			    {
			    	$yd.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$yd.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
			if (strpos(strtolower($conversion_cost_head_array[$row[csf('cons_process')]]), 'aop') !== false || strtolower($conversion_cost_head_array[$row[csf('cons_process')]])==strtolower('All Over Printing'))
        	{
			    if(!empty($aop))
			    {
			    	$aop.=",".$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			    else{
			    	$aop.=$conversion_cost_head_array[$row[csf('cons_process')]];
			    }
			}
		}
  		ob_start();     
		?>	
											<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
                <td width="200" style="font-size:28px"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  style="position: relative;">
                        <tr>
                            <td align="center" style="font-size:28px;"> <?php echo $company_library[$cbo_company_name]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:18px;position: relative;"><?=$location_address_arr[$location]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:24px">
                            	<span style="float:center;"><b><strong> <font style="color:black">Main Fabric Booking </font></strong></b></span> 
                            </td>
                        </tr>                        
						<tr>
                            <td align="center" style="font-size:20px">
							<?
							//$booking_no=str_replace("'",$txt_booking_no);
							if(str_replace("'","",$id_approved_id) ==1){ ?>
                            <span style="font-size:20px; float:center;"><strong> <font style="color:green"> <? echo "[Approved]"; ?> </font></strong></span> 
                               <? }else{ ?>
								<span style="font-size:20px; float:center;"><strong> <font style="color:red"><? echo "[Not Approved]"; ?> </font></strong></span> 
							   <? } ?>
							  
                            </td>
                            
							
                        </tr>
                        <tr>
                         <!-- <td align="center" style="font-size:24px">
                            	<span style="float:center;padding:2%;"><strong style="background-color:yellow;font-size: 30px;"><? echo str_replace("'","",$txt_booking_no);?></strong></span> 
                            </td> -->
							<td align="right"><strong style="background-color:yellow;font-size: 30px;margin-right:10%;"><?=str_replace("'","",$txt_booking_no);;?></strong></td>
                        </tr>
                        
						
                    </table>
					
                </td>
                <td width="200">
                	<table style="border:1px solid black; font-family:Arial Narrow;" width="100%">
                		<tr>
                			<td><b>Min. Ship Date:</b></td>
                			<td><b><?php echo  date('d-m-Y',strtotime($min_shipment_date));?></b></td>
                		</tr>
                		<tr>
                			<td><b>Max. Ship Date:</b></td>
                			<td><b><?php echo date('d-m-Y',strtotime($max_shipment_date));?></b></td>
                		</tr>
                	</table>
                	<br>
                	<table style="border:1px solid black; font-family:Arial Narrow;font-size: 10px;" width="100%">
                		<tr>
                			<td>Printing Date :</td>
                			<td><?php echo  date('d-m-Y');?></td>
                		</tr>
                		<tr>
                			<td>Printing Time:</td>
                			<td><?php echo  date('h:i:sa');?></td>
                		</tr>
                		<tr>
                			<td>User Name:</td>
                			<td><?php echo $user_name_arr[$user_id];?></td>
                		</tr>
                		<tr>
                			<?php 
                				function get_client_ip() {
								    $ipaddress = '';
								    if (getenv('HTTP_CLIENT_IP'))
								        $ipaddress = getenv('HTTP_CLIENT_IP');
								    else if(getenv('HTTP_X_FORWARDED_FOR'))
								        $ipaddress = getenv('HTTP_X_FORWARDED_FOR');
								    else if(getenv('HTTP_X_FORWARDED'))
								        $ipaddress = getenv('HTTP_X_FORWARDED');
								    else if(getenv('HTTP_FORWARDED_FOR'))
								        $ipaddress = getenv('HTTP_FORWARDED_FOR');
								    else if(getenv('HTTP_FORWARDED'))
								       $ipaddress = getenv('HTTP_FORWARDED');
								    else if(getenv('REMOTE_ADDR'))
								        $ipaddress = getenv('REMOTE_ADDR');
								    else
								        $ipaddress = 'UNKNOWN';
								    return $ipaddress;
								}

                			 ?>
                			<td>IP Address:</td>
                			<td><?php if(empty($user_ip)){echo get_client_ip();} echo $user_ip;?></td>
                		</tr>
                	</table>
                </td>
            </tr>
        </table>
		<?
        $job_no=trim($txt_job_no,"'"); $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff,min(factory_received_date) as factory_received_date, $group_concat_all,status_active from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date,status_active ");
      
		
        $to_ship=0; $fp_ship=0; $f_ship=0;

        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $factory_received_date=change_date_format($row[csf('factory_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			if($row[csf('status_active')]==3){
				$cancel_po_no[$row[csf('po_number')]]=$row[csf('po_number')];
			}

			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) {
				$shiping_status.= "FP".",";
				$to_ship++;
				$fp_ship++;
			}
			else if($row[csf('shiping_status')]==2){
				$shiping_status.= "PD".",";
				$to_ship++;
			} 
			else if($row[csf('shiping_status')]==3){
				$shiping_status.= "FS".",";
				$to_ship++;
				$f_ship++;
			} 
        }

        if($to_ship==$f_ship) $shiping_status= "<b style='color:green'>Full shipped</b>";
        else if($to_ship==$fp_ship) $shiping_status= "<b style='color:red'>Full Pending</b>";
        else $shiping_status= "<b style='color:red'>Partial Delivery</b>";
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$factory_received_date=implode(",",array_filter(array_unique(explode(",",$factory_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];
			?>
			<table width="100%" class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all"  style="font-size:18px; font-family:Arial Narrow;" >
				<tr>
					<td colspan="2" rowspan="6" width="210">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" width="210">
                                <legend>Image </legend>
                                <table width="208">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="200" height="200" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
					</td>
					<td align="center" width="100" style="background-color:#808080"><b>Job No</b></td>
					<?php 
					 	$revised_no=$nameArray_approved_row[csf('approved_no')]-1;
						if($revised_no<0) $revised_no=0;
					 ?>
					 
					<td align="center" width="140" colspan="3" style="background-color:#808080"> <span style="font-size:18px"><b style="float:left;font-size:18px"><? echo trim($txt_job_no,"'");if(!empty($revised_no)){ ?>&nbsp;<span style="color: red;">/&nbsp;<? echo $revised_no; }?></span></b> </span> </td>
					<td align="center" width="100" style="background-color:#808080"><span style="font-size:18px"><b>Booking No</b></span></td>
					<td align="center" width="110" style="background-color:#808080"><span style="font-size:18px"><b><?=$result[csf('booking_no')];?></b><?="<br>(".$fabric_source[$result[csf('fabric_source')]].")" ?> </span> </td>
					<td align="center" width="100" style="background-color:#808080"><span style="font-size:18px"><b>Sample Req. No</b></span></td>
					<td align="center" width="110" colspan="2" style="background-color:#808080">&nbsp;<span style="font-size:18px" ><?php echo $requisition_no; ?></span></td>
					
					<!-- <td align="center" colspan="2" width="340"></td> -->
				</tr>
				<?php
					$order_yes_no=sql_select("Select embelishment ,embro ,wash  ,spworks ,gmtsdying , ws_id , aop , aopseq , bush ,  peach, yd    from wo_po_details_mas_set_details where job_no='$txt_job_no' order by id");			
				?>
				<tr style="text-align:center">
					<td align="center"width="100" style="font-size:16px;"><b>Style</b></td>
					<td width="110"style="font-size:16px;" >&nbsp;<? echo $result[csf('style_ref_no')]; ?></td>
					
					<td width="100" style="font-size:16px;"><b>Dept. (Prod Code)</b></td>
					<td width="140"style="font-size:16px;" >&nbsp;<? echo $product_dept[$result[csf('product_dept')]]; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} ?></td>
					
					<td width="100"><b>Print / Type</b></td>
					<td width="110" align="center"><?=($order_yes_no[0][csf('embelishment')]==1 || (!empty($emb_print_data[$txt_job_no][1]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=!empty($emb_print_data[$txt_job_no][1]) ? chop($emb_print_data[$txt_job_no][1],",") : '' ;?></td>
				
					<td width="110"><b>Booking Date</b></td>
					<td width="100"> <?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>
                    </td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></span></td>
					<td width="100"><b>Sub Dep</b></td>
					<td width="140"><? if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
					<td width="100"><b>EMB / Type</b></td>
					<td width="110" align="center"><?php echo  ($order_yes_no[0][csf('embro')]==1 || (!empty($emb_print_data[$txt_job_no][2]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo  !empty($emb_print_data[$txt_job_no][2]) ? chop($emb_print_data[$txt_job_no][2],",") : '' ;?></td>

				
					<td width="110"><b>Delivery Date</b></td>
					<td width="100"><? echo change_date_format($delivery_date); ?></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Garments Item</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"> <?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?></span></td>
					<td width="100"><b>Season</b></td>
					<td width="140"><? echo $season_name_arr[$result[csf('season')]]; ?></td>

							
					<td width="100"><b>AOP</b></td>
					<td width="110" align="center"><?php echo   ($order_yes_no[0][csf('aop')]==1 || (!empty($aop))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$aop;?></td>
				
					<td width="110"><b>Approved Date</b></td>
					<td width="100" align="center">	<b style="color:green"><?=change_date_format($nameArray_approved_date_row); ?></b></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Order Repeat No</b></span></td>
					<td width="110">&nbsp;<span style="font-size:18px"><?=$result[csf('order_repeat_no')];?></span></td>
					<td width="100"><b>Brand</b></td>
					<td width="140"><?php echo $brand_name_arr[$result[csf('brand_id')]]; ?></td>
					<td width="100"><b>YD</b></td>
					<td width="110" align="center"><?php echo (!empty($yd) || $order_yes_no[0][csf('yd')]==1)  ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php 	echo $yd; ?></td>
					
					<td width="110"><b>Approved Status</b></td>
					<td width="100" align="center">
					<? if(str_replace("'","",$id_approved_id) ==1){ ?>
					<b style="color:green"><?="Yes"; ?></b>
					<? }else{ ?><b style="color:red"><?	echo "No";?></b><? }; ?></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Order Repeat Job No</b></span></td>
					<td width="110"><span style="font-size:18px"><? echo $result[csf('repeat_job_no')];?><b> </span> </td>
					<td width="100"><b>Fab. Material</b></td>
					<td width="140"><?php echo $fab_material[$result[csf('fab_material')]]; ?></td>
					<td width="100"><b>Peach</b></td>
					
					<td width="110" align="center"><?php echo  ($job_yes_no[0][csf('peach')]==1 || (!empty($peach))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$peach;?></td>
					<td width="110"><b>Amendment Date</b></td>
					<td width="100"><? if(!empty($un_approved_date)){echo change_date_format($un_approved_date);} ?></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Running PO No</b></span></td>
					<td width="350" colspan="3" style="word-break: break-all;"><p style="font-size:12px;width: 450px;word-break: break-all;" ><? echo $running_po; ?></p></td>
					<td width="100"><b>Sustainability Standard</b></td>
					<td width="110"><?php echo $sustainability_standard[$result[csf('sustainability_standard')]]; ?></td>

					<td width="100"><b>Brushing</b></td>
					<td width="110" align="center"><?php echo  ($job_yes_no[0][csf('bush')]==1 ||  (!empty($brush))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?=$brush;?></td>
					<td width="110"><b>Team Leader</b></td>
					<td width="100"><?=$team_leader_arr[$result[csf('team_leader')]];?></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Cancelled PO</b></span></td>
					<td width="350" colspan="3" ><p style="font-size:12px;width: 450px;word-break: break-all;"><? 	echo implode(",",$cancel_po_arr);;//$cancel_po; ?></p></td>		
					<?php $fab_material=array(1=>"Organic",2=>"BCI"); ?>
					<td width="100"><b>Order Nature</b> </td>
					<td width="110"><?php echo $fbooking_order_nature[$result[csf('quality_level')]] ?></td>
					<td width="100"><b>Fab Wash</b></td>
					<td width="110" align="center"><?php echo !empty($fab_wash)? 'Yes' : 'No'; ?></td>
					<td width="100"><?=$fab_wash?></td>
				

					<td width="110"><b>Dealing Merchandiser</b></td>
					<td width="100"><? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>GMT/ Style Description</b></span></td>
					<td width="350" colspan="3"><span style="font-size:18px"><? echo $result[csf('style_description')]; ?></span></td>
					<td width="100"><b>Quality Label</b></td>
					<td width="110"><?php echo $quality_label[$result[csf('qlty_label')]] ?></td>

					<td width="100"><b>GMT Wash</b></td>
					
					<td width="110" align="center"><?php echo  ($order_yes_no[0][csf('wash')]==1 || (!empty($emb_print_data[$txt_job_no][3]))) ? 'Yes' : 'No' ;?></td>
					<td width="100"><?php echo  !empty($emb_print_data[$txt_job_no][3]) ? chop($emb_print_data[$txt_job_no][3],",") : '' ;?></td>

					<td width="110"><b>Factory Merchandiser</b></td>
					<td width="100"><? echo $marchentrArr[$result[csf('factory_marchant')]]; ?></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Fabric Description</b></span></td>
					<td width="350" colspan="3"><span style="font-size:18px">
						<? 
							$sql_fab="SELECT a.lib_yarn_count_deter_id AS determin_id, a.construction
							    FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
							   WHERE a.job_id = b.job_id AND a.id = b.pre_cost_fabric_cost_dtls_id AND a.id = d.pre_cost_fabric_cost_dtls_id AND b.po_break_down_id = d.po_break_down_id AND b.color_size_table_id = d.color_size_table_id AND b.pre_cost_fabric_cost_dtls_id = d.pre_cost_fabric_cost_dtls_id AND d.booking_no = $txt_booking_no AND a.status_active = 1 AND d.status_active = 1 AND d.is_deleted = 0 and a.body_part_id in (1,20) group by a.lib_yarn_count_deter_id , a.construction";
							//echo $sql_fab;
							$res_fab=sql_select($sql_fab);
							$des='';
							foreach ($res_fab as $row) 
							{
								if(!empty($des))
								{
									$des."***";
								}
								$des.=$row[csf('construction')] . " ". $fabric_composition[$lip_yarn_count[$row[csf('determin_id')]]].",";
							}
							echo implode(",", array_unique(explode("***", $des)));
						?>
						</span></td>
					<td width="100"><b>Packing</b></td>
					<td width="110"><?php echo $packing[$result[csf('packing')]]; ?></td>
					<td width="100" style="background-color:#808080"><b>Running Order Qty</b></td>
					<?php $order_uom_res=sql_select( "select a.order_uom from wo_po_details_master a where a.status_active=1 and a.is_deleted=0  and a.job_no='$txt_job_no' ");
						$order_uom='';
						if(count($order_uom_res))
						{
							$order_uom=$unit_of_measurement[$order_uom_res[0][csf('order_uom')]];
						}
					 ?>
					<td width="210" colspan="2" align="center" style="background-color:#808080"><b> <?php echo number_format($running_po_qnty,0); ?>&nbsp;(<?=$order_uom;?>)</b></td>
					<td width="110" style="background-color:#808080"><b>Shipment Status</b></td>
					<td width="100" style="background-color:#808080"><? echo rtrim($shiping_status,','); ?></td>
				</tr>
				<tr style="text-align:center">
					<td width="100"><span style="font-size:18px"><b>Attention</b></span></td>
					<td  width="350" colspan="3"><span style="font-size:18px"><? echo $result[csf('attention')]?></span></td>
					<td width="100"><b>Proceed for Knitting</b></td>
					<td width="110">	<?php 
					if($result[csf('proceed_knitting')]==1){?>
					<b style="color:green"><? echo $yes_no[$result[csf('proceed_knitting')]]; ?></b>
					<?}else{?>
						<b style="color:red"><? echo $yes_no[$result[csf('proceed_knitting')]]; ?></b>
						<?}?></td>
					<td width="100"><b>Working Company</b></td>
					<td width="210"  align="center" colspan="2"><? echo implode(",",$service_working_company[534]['working_company'])  ?></td>
					<td width="100"><b>Work Order No</b></td>
					<td width="110"  align="center"><? echo implode(",",$service_working_company[534]['booking_no'])  ?></td>					
				</tr>
                <tr style="text-align:center">
				<td width="100"><span style="font-size:18px"><b>Remarks</b></span></td>
				<td  width="350" colspan="3"><b><?php if(!empty($result[csf('remarks')])){ ?><span style="font-size: 25px;">&#8592;</span><? echo $result[csf('remarks')]; } ?></b></td>
				<td><b>Proceed for Dyeing</b></td>
					<td>
						
					<?php 
					if($result[csf('proceed_dyeing')]==1){?>
					<b style="color:green"><? echo $yes_no[$result[csf('proceed_dyeing')]]; ?></b>
					<?}else{?>
						<b style="color:red"><? echo $yes_no[$result[csf('proceed_dyeing')]]; ?></b>
						<?}?>
					</td>
					<td><b>Working Company</b></td>
					<td width="210"  align="center" colspan="2"><? echo implode(",",$service_working_company[535]['working_company'])  ?></td>
					<td width="100"><b>Work Order No</b></td>
					<td width="110" align="center"><? echo implode(",",$service_working_company[535]['booking_no'])  ?></td>
				</tr>				
			</table>
			
			<?
		}	
			
	  	?>
		<span style="color:red; font-size:14px">PLS NOTE: BEFORE START KNITTING MUST CHECK ALL THE BELLOW INFORMATIONS, SPECIALLY DIA, GREY GSM, S/L & COUNT ETC. ANTIQUE WHITE MUST BE TEFLON FINISH TREATMENT</span>
		

		<?php
	
		$nameArray_fabric_description= sql_select("select a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, b.remarks, avg(b.cons) as cons, b.process_loss_percent, avg(b.requirment) as requirment,b.po_break_down_id,  d.fabric_color_id, d.gmts_color_id, d.id as dtls_id, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty,a.id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0  AND a.status_active = 1 AND a.is_deleted = 0   AND c.status_active = 1  AND c.is_deleted = 0  AND b.status_active = 1  AND b.is_deleted = 0 group by a.body_part_id,a.id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, b.remarks,d.fabric_color_id, d.gmts_color_id, d.id,b.po_break_down_id, b.process_loss_percent order by a.id, a.body_part_id, b.dia_width");
	
	
	
		foreach ($nameArray_fabric_description as $row) {	
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."'  and approval_status=3 and is_deleted=0  and color_name_id=".$row[csf('fabric_color_id')]." and  po_break_down_id=".$row[csf('po_break_down_id')]."  and status_active=1 and is_deleted=0 ");
	
			$grouping_item=$row[csf('fabric_color_id')].'*'.$row[csf('body_part_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('color_type_id')];	
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gmts_color_id'] = $row[csf('gmts_color_id')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_color_id'] = $row[csf('fabric_color_id')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['lapdip_no'] = $lapdip_no;
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['body_part_id'] = $row[csf('body_part_id')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_des'] = $row[csf('construction')].','.$row[csf('composition')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gsm'] = $row[csf('gsm_weight')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_dia'] = $row[csf('dia_width')].",".$fabric_typee[$row[csf('width_dia_type')]];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['color_type_id'] = $row[csf('color_type_id')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['finsh_cons'] = $row[csf('cons')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gray_cons'] = $row[csf('requirment')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fin_fab_qnty'] += $row[csf('fin_fab_qnty')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['grey_fab_qnty'] += $row[csf('grey_fab_qnty')];
			$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['process_loss_percent'] = $row[csf('process_loss_percent')];
	
		}
	
		// /*echo '<pre>';
		// print_r($fabric_data_arr); die;*/
	
		?>
		 <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-size: 18px;">
			 <tr>
				 <th>Gmts Color</th>
				 <th>Fabric Color</th>
				 <th>Lab Dip No</th>
				 <th>Body Part</th>
				 <th>Fabrication</th>
				 <th>GSM</th>
				 <th>Dia Type with </br> Fabric Dia</th>			
				 <th>Color Type</th>
				 <th>Finsh Cons.</th>
				 <th>Finish  Qty</th>
				 <th>Grey Cons.</th>
				 <th>Grey Qty</th>
				 <th>Process Loss %</th>
			 </tr>
			 <? 
			 foreach ($fabric_data_arr as $gmts_id=>$fabric_data_arr) {  
			 $i=1;     		  		
				 foreach ($fabric_data_arr as $fabric_id => $value) {
						 $fin_fab_qnty+=$value['fin_fab_qnty'];   		 	
						 $grey_fab_qnty+=$value['grey_fab_qnty'];   		 	
						  if($i==1){
						   ?>
						  <tr>
							 <td rowspan="<? echo count($fabric_data_arr) ?>"><? echo $color_library[$gmts_id] ?></td>
							 <td><? echo $color_library[$value['fabric_color_id']] ?></td>
							<td><? echo $value['lapdip_no']; ?></td>
							 <td><? echo $body_part[$value['body_part_id']] ?></td>
							 <td><? echo $value['fabric_des'] ?></td>
							 <td><? echo $value['gsm'] ?></td>
							 <td><? echo $value['fabric_dia'] ?></td>
							 <td><? echo $color_type[$value['color_type_id']] ?></td>
							 <td align="right"><? echo fn_number_format($value['finsh_cons'],4) ; ?></td>
							 <td align="right"><? echo fn_number_format($value['fin_fab_qnty'],4) ; ?></td>
							 <td align="right"><? echo fn_number_format($value['gray_cons'],4) ; ?></td>		     			
							 <td align="right"><? echo fn_number_format($value['grey_fab_qnty'],4) ; ?></td>
							 <td align="center"><? echo $value['process_loss_percent'] ?></td>
						 </tr>
						  <? } 
						  else { ?>
							  <tr>
								 <td><? echo $color_library[$value['fabric_color_id']] ?></td>
								 <td><? echo $value['lapdip_no'];?></td>
								 <td><? echo $body_part[$value['body_part_id']] ?></td>
								 <td><? echo $value['fabric_des'] ?></td>
								 <td><? echo $value['gsm'] ?></td>
								 <td><? echo $value['fabric_dia'] ?></td>
								 <td><? echo $color_type[$value['color_type_id']] ?></td> 
								 <td align="right"><? echo fn_number_format($value['finsh_cons'],4) ; ?></td>
								 <td align="right"><? echo number_format($value['fin_fab_qnty'],2) ?></td>
								 <td align="right"><? echo fn_number_format($value['gray_cons'],4) ; ?></td>			     			
								 <td align="right"><? echo number_format($value['grey_fab_qnty'],2) ?></td>
								 <td align="center"><? echo $value['process_loss_percent'] ?></td>
							 </tr>
						  <? }
						  $i++;
				 }
			 } 
			 ?>
			 <tr>
				 <th colspan="9">Total</th>
				 <th><? echo number_format($fin_fab_qnty);  ?></th>
				 <th></th>
				 <th><? echo number_format($grey_fab_qnty);  ?></th>
				 <th></th>
			 </tr>
		 </table>
		  <br/>



      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }




        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');		
		if($cbo_fabric_source==1)
		{
			$fb_desc_sq="SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type,  b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight,  b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width";
			$nameArray_fabric_description= sql_select($fb_desc_sq);
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="2" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='2'>&nbsp</td>";
						else echo "<td colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                   <th colspan="2" align="center">Total</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50' >Grey</th>";
                    }
                    ?>
					<th width='50'>Finish</th>
					<th width='50' >Grey</th>
                </tr>
                <?
                $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";
                
                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120"><? echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]); ?></td>
                       
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							
							
							<?
                        }
                        ?>
						<td width='50' align='center' style="font-size:18px;">
								<?
                                
									echo number_format($total_fin_fab_qnty,2);
									 $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;
                                
                                ?>
							</td>
							
							<td width='50' align='center' style="font-size:18px;">
								<?
                               
									echo number_format($total_grey_fab_qnty,2);
									 $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;
                                
                                ?>
							</td>
                        
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>      
					                
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
					<td width='50' align='center' style="font-size:18px;"><?  echo number_format($grand_total_fin_fab_qnty,2) ;?></td><td width='50' align='center' style="font-size:18px;" > <? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                   
                </tr>
               
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(a.avg_finish_cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(a.avg_cons) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_id=a.job_id and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");


			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;font-size:18px;" >
                <tr align="center">
                    <th colspan="2" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
             
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                   
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select a.id as fab_id,b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no' and a.status_active=1 and b.status_active=1 order by a.id");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
               
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and

                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
              
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
           
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_id=b.job_id and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_id=a.job_id and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				if(!empty($collar_cuff_row[csf('item_size')]))
				{
					$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				}
				
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);

			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;font-size:18px;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }
                            ?>
                        </tr>
                            <?

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														// if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														// else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];

														$plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=($plan_cut*$collar_ex_per)/100;

                                                	if($body_type==50){
														$collerqty=($plan_cut+$colar_excess_per)*2;
													}else{
														$collerqty=($plan_cut+$colar_excess_per);
													}

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<!-- <td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td> -->
												<td align="center"><? echo $collar_ex_per; ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        
                        <tr>
                            <td>Size Total</td>
								<?
                               // foreach($pre_size_total_arr  as $size_qty)
                               // {
                                	foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
									{
										$size_qty=$pre_size_total_arr[$size_number_id];
										?>
										<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
										<?
									}

                               // }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <!-- <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td> -->
							<td align="center" style="border:1px solid black"></td>
                        </tr>
					</table>
                </div>
                <?
            }
        }

        ?>

       		

        <?

	if($show_yarn_rate==1)
	{
		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
	
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;" >
            <tr>
                <td width="100%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td width="40">Sl</td>
                    <td width="40">Yarn Count</td>
                    <td width="40">Yarn Type</td>
                    <td width="120">Yarn Description</td>
                    <td width="40">Brand</td>
                    <td width="40">Lot</td>                   
                    <td width="40">Rate</td>                  
                    <td width="40">Cons for <? echo $costing_per; ?> Gmts</td>
                    <td width="40">Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td><?	echo $yarn_count_arr[$row[csf('count_id')]];?>
                    </td>
					<td><? echo $yarn_type[$row[csf('type_id')]] ?></td>
                    <td>
						<? 
							$yarn_des=$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					echo $yarn_des;
						?>
					</td>
                    <td></td>                   
                    <td></td>                   
                    <td><? echo number_format($row[csf('rate')],4); ?></td>
                     
                    <td title="<?="(".$rowcons_qnty."/".$po_qnty_tot.")*".$cos_per_arr[$job_no];?>"><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>                  
                    <td></td>                   
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
                </td>
               
                </td>
            </tr>
        </table>
        <?
	}
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;">
            <tr>
                <td width="49%" valign="top">
                <?
				/* if(count($sql_embelishment)>0)
				{ */
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				//}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                				<?
                				$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
									 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
									 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

								$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
                				 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");


                				/* if(count($unapprove_data_array)>0)
                				{ */
                				$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
                					$unapproved_request_arr=array();
                					foreach($sql_unapproved as $rowu)
                					{
                						$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
                					}
                		 		?>
                		       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
                		            <thead>
                		            <tr style="border:1px solid black;">
                		                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                		                </tr>
                		                <tr style="border:1px solid black;">
                		                <th width="3%" style="border:1px solid black;">Sl</th>
                						<th width="30%" style="border:1px solid black;">Name</th>
                						<th width="20%" style="border:1px solid black;">Designation</th>
                						<th width="5%" style="border:1px solid black;">Approval Status</th>
                						<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                						<th width="22%" style="border:1px solid black;"> Date</th>

                		                </tr>
                		            </thead>
                		            <tbody>
                		            <?
                					$i=1;
                					foreach($unapprove_data_array as $row){

                					?>
                		            <tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
                						<td width="20%" style="border:1px solid black;"><? echo '';?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
                		            </tr>
                		                <?
                						$i++;
                						$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
                						$un_approved_date=$un_approved_date[0];
                						if($db_type==0) //Mysql
                						{
                							if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}
                						else
                						{
                							if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}

                						if($un_approved_date!="")
                						{
                						?>
                					<tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
                		              </tr>

                		                <?
                						$i++;
                						}

                					}
                						?>
                		            </tbody>
                		        </table>
                				<?
                				//}
                				?>

                </td>
            </tr>
        </table>
        <table  width="100%" style="margin: 0px;padding: 0px;">
        <?php $stripe_color_wise=array(); ?>
       
        <tr>
        	<td width="70%">
        		<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >
        		       
        		        <tr>
        		            <td align="center" colspan="10">  Stripe Details</td>
        		            
    		            </tr>
        		        <?
        				$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
        				$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.totfidder,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d, wo_po_color_size_breakdown e where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1 and b.is_deleted=0 and e.id=b.color_size_table_id and e.is_deleted=0 and e.status_active=1 and e.color_number_id=d.color_number_id  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width,d.totfidder order by d.id ");        				
        				$result_data=sql_select($sql_stripe);
        				foreach($result_data as $row)
        				{
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];	
							$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['totfidder'][$row[csf('did')]]=$row[csf('totfidder')];
							$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['subtotal_measurement'][$row[csf('did')]]=$row[csf('measurement')];;

        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
					

        				}
						// echo "<pre>";
						// print_r($stripe_arr2);
        				?>
        		            <tr>
	        		            <td align="center" width="30"> SL</td>
	        		            <td align="center" width="100"> Body Part</td>
	        		            <td align="center" width="80"> Fabric Color</td>
	        		            <td align="center" width="70"> Fabric Qty(KG)</td>
	        		            <td align="center" width="70"> Stripe Color</td>
	        		            <td align="center" width="70"> Stripe Measurement</td>
	        		            <td align="center" width="70"> Stripe Uom</td>
                                  <td  align="center" width="70"> Total Feeder</td>
	        		            <td  align="center" width="70"> Qty.(KG)</td>
                               
	        		            <td  align="center" width="70"> Y/D Req.</td>
        		            </tr>
        		            <?
							$color_wise_qty=sql_select("select  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.gmts_color_id,(d.fin_fab_qnty) as fin_fab_qnty,(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
        								WHERE a.job_id=b.job_id and
        								a.id=b.pre_cost_fabric_cost_dtls_id and
        								c.job_no_mst=a.job_no and
        								c.id=b.color_size_table_id and
        								b.po_break_down_id=d.po_break_down_id and
        								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
        								d.booking_no =$txt_booking_no and
        								d.status_active=1 and
        								d.is_deleted=0
        								");
										$tot_color_qty=0;
										foreach($color_wise_qty as $row)
										{
											$data_str=$row[csf('body_part_id')].$row[csf('color_type_id')].$row[csf('gmts_color_id')];
											$tot_color_qtyArr[$data_str]+=$row[csf('fin_fab_qnty')];
										}
										//echo $tot_color_qty.'=A';
										unset($color_wise_qty);
										
        					$i=1;$total_fab_qty=0;$total_fabreqtotkg=$total_totfidder=0;$fab_data_array=array();$qnty=0;
        		            foreach($stripe_arr as $body_id=>$body_data)
        		            {
        						foreach($body_data as $color_id=>$color_val)
        						{
        							$rowspan=count($color_val['stripe_color']);
        							$composition=$stripe_arr2[$body_id][$color_id]['composition'];
        							$construction=$stripe_arr2[$body_id][$color_id]['construction'];
        							$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
        							$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
        							$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];
									$subtotal_measurement=array_sum($color_val['subtotal_measurement']);
									

        							/*if($db_type==0) $color_cond="d.gmts_color_id='".$color_id."'";
        							else if($db_type==2) $color_cond="nvl(d.gmts_color_id,0)=nvl('".$color_id."',0)";

        							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
        								WHERE a.job_id=b.job_id and
        								a.id=b.pre_cost_fabric_cost_dtls_id and
        								c.job_no_mst=a.job_no and
        								c.id=b.color_size_table_id and
        								b.po_break_down_id=d.po_break_down_id and
        								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
        								d.booking_no =$txt_booking_no and
        								a.body_part_id='".$body_id."' and
        								a.color_type_id='".$color_type_id."' and
        								a.construction='".$construction."' and
        								a.composition='".$composition."' and
        								a.gsm_weight='".$gsm_weight."' and
        								$color_cond and
        								d.status_active=1 and
        								d.is_deleted=0
        								");
        						
        								list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
        							$sk=0;
    								foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
        							{
        								
        								?>
	        							<tr>
		        							<?
		        							if($sk==0)
		        							{

												$data_str=$body_id.$color_type_id.$color_id;
			        							$color_qty=$tot_color_qtyArr[$data_str];
			        							//$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
												$qnty=$color_qty/$subtotal_measurement;
			        							?>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
			        							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
			        							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
			        							<?
			        							$total_fab_qty+=$color_qty;
											
			        							$i++;
			        						}
		        							$sk=0;
		        							

		        								$measurement=$color_val['measurement'][$strip_color_id];
												$totfidder=$color_val['totfidder'][$strip_color_id];
		        								$uom=$color_val['uom'][$strip_color_id];
		        								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
		        								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
												$qnty_kg=$qnty*$measurement;
		        								
		        								?>
		        							
			        								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
			        								<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
			        		                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
                                                      <td align="right"> <? echo  number_format($totfidder,2); ?> &nbsp;</td>
			        								<td align="right"> <? echo  number_format($qnty_kg,2); ?> &nbsp;</td>
                                                  
			        								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
		        								
		        								<?
		        								
		        								$sk++;
		        								$total_fabreqtotkg+=$qnty_kg;
												$total_totfidder+=$totfidder;
		        								$stripe_color_wise[$color_name_arr[$s_color_val]]+=$qnty_kg;
		        								$color_sub_tot[$body_id][$color_id]['fab_qnty']+=$qnty_kg;
		        							
											
		        							?>
	        							</tr>
	        							<?
	        						}
									?>
								  <tr>
			        		            <td colspan="4">&nbsp; </td>
			        		            <td align="center" colspan="4"><b> Sub Total </b></td>
			        		            <td align="right"><b><? echo  number_format($color_sub_tot[$body_id][$color_id]['fab_qnty'],2); ?></b> &nbsp;</td>
			        		        </tr>

							<? }  
        						}?>
	        		            <tfoot>
		        		            <tr>
			        		            <td colspan="3">Total </td>
			        		            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
			        		            <td></td>
			        		            <td></td>
                                       
			        		            <td>   </td>
                                          <td  align="right"><? echo  number_format($total_totfidder,2); ?></td>
			        		            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
			        		        </tr>
	        		            </tfoot>
        		            </table>
        	</td>
        	
        	<td width="20%" >
        		        <table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;"  >
        		       

        		        <tr>
        		            <td align="left" colspan="3"> Stripe  Color wise Summary</td>
        		            
        		           
        		           
    		            </tr>
        		        <?
        				
        				?>
        		            <tr>
	        		            <td width="30"> SL</td>
	        		            
	        		            <td width="70"> Stripe Color</td>
	        		           
	        		            <td  width="70"> Qty.(KG)</td>
	        		           
        		            </tr>
        		            <?

        					$i=1;$total_stripe_qnt=0;        		            
        						foreach($stripe_color_wise as $color=>$val)
        						{
        							
        							
        							?>
        							<tr>
	        							<td> <? echo $i; ?></td>
	        							
	        							<td > <? echo $color; ?></td>
	        							<td align="right"> <?php echo number_format($val,2); ?></td>
	        						</tr>
        							
        							<?
        							$total_stripe_qnt+=$val;
        							
        							$i++;
        						}
        					
        					?>
        		            <tfoot>
        		            <tr>
        		            
        		            <td></td>
        		            <td></td>
        		            
        		            <td align="right"><? echo  number_format($total_stripe_qnt,2); ?> </td>
        		            </tr>
        		            </tfoot>
        		            </table>
        	</td>
        </tr>
         </table >
			<table width="98%">
       		 	<tr>
       		 		<td width="45%" style="float: left;">
       		 			<?php 

       		 				$sql_purchase="SELECT a.booking_no, a.uom, sum(b.fin_fab_qnty) as qnty , b.construction, b.copmposition, b.gsm_weight as dia, b.dia_width as gsm from wo_booking_mst a, wo_booking_dtls b where     a.booking_no = b.booking_no and a.fabric_source = 2 and b.job_no = '$txt_job_no'and b.status_active = 1 and b.is_deleted = 0 and a.status_active = 1 and a.is_deleted = 0 and  a.booking_type=1 group by a.booking_no, a.uom, b.construction, b.copmposition, b.dia, b.gsm_weight, b.dia_width"; 
       		 				//echo $sql_purchase;
							$purchase_res=sql_select($sql_purchase);
							?>
							<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <thead>
				                   <tr align="center">
				                    	<th colspan="5"><b>Purchased Booking Info</b></th>
				                    </tr>
				                    <tr align="center">
					                    <th>Sl</th>
					                    <th>Booking No</th>
					                    <th>Fabric Data</th>
					                    <th>UOM</th>
					                    <th>Qnty</th>
					                   
				                    </tr>
 			                   </thead>
 			                   <tbody>
 			                   		<?

 			                   			foreach ($purchase_res as  $row) 
 			                   			{
 			                   				?>
 			                   				<tr>
 			                   					<td><?=$p++;?></td>
 			                   					<td><p><?=$row[csf('booking_no')];?></p></td>
 			                   					<td><p><?=$row[csf('construction')] .", ".$row[csf('copmposition')].", ".$row[csf('gsm')].", ".$row[csf('dia')];?></p></td>
 			                   					<td><p><?=$unit_of_measurement[$row[csf('uom')]];?></p></td>
 			                   					<td><p><?=number_format($row[csf('qnty')],2);?></p></td>
 			                   				</tr>
 			                   				<?
 			                   			}


 			                   		?>
 			                   </tbody>
 			                   
 			            </table>

       		 			 
       		 		</td>
       		 		<td width="45%" style="float: right;">
 			       		 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <tr align="center">
 			                    	<td colspan="10"><b>Dyes To Match</b></td>
 			                    </tr>
 			                    <tr align="center">
 				                    <td>Sl</td>
 				                    <td>Item</td>
 				                    <td>Item Description</td>
 				                    <td>Body Color</td>
 				                    <td>Item Color</td>
 				                    <td>Finish Qty.</td>
 				                    <td>UOM</td>
 			                    </tr>
 			                    <?
 								$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
 								$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
 								$bookingId=0;
 								foreach($sql as $row){
 									$bookingId= $row[csf('id')];
 								}
 								$co=0;
 								$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty, b.description   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom, b.description order by a.fabric_color");

 								foreach($sql_data  as $row)
 			                    {
 									$co++;
 									?>
 				                    <tr>
 				                    <td><? echo $co; ?></td>
 				                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
 				                    <td><p> <? echo $row[csf('description')];?></p></td>
 				                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
 				                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
 				                    <td align="right"><? echo $row[csf('qty')];?></td>
 				                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
 				                    </tr>
 				                    <?
 								}
 								?>
 			            </table>
       		 		</td>
       		 	</tr>
       		 </table>

			<table width="98%">
       		 	<tr>
       		 		<td width="45%" style="float: left;">
       		 			<?php 
							$rmg_process_breakdown_arr=array();
							$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown);
							?>
							<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <thead>
				                   <tr align="center">
				                    	<th colspan="9"><b>Fabrics Process Loss %</b></th>
				                    </tr>
				                    <tr align="center">
					                    <th>Yarn Dyeing</th>
					                    <th>Knitting </th>
					                    <th>Fabric Dyeing </th>
					                    <th>AOP</th>									
					                    <th>Dyeing & Finishing  </th>					                    
					                    <th>Others</th>
					                    <th>Total</th>
					                   
				                    </tr>
 			                   </thead>
 			                   <tbody>
									<tr>
										<td><? echo number_format($rmg_process_breakdown_arr[12],2); ?></td>
										<td><? echo number_format($rmg_process_breakdown_arr[6],2); ?></td>
										<td><? echo number_format($rmg_process_breakdown_arr[7],2); ?></td>
										<td><? echo number_format($rmg_process_breakdown_arr[13],2); ?></td>									
										<td><? echo number_format($rmg_process_breakdown_arr[5],2); ?></td>										
										<td><? echo number_format($rmg_process_breakdown_arr[9],2); ?></td>
										<? $total_fab=$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[9];?>
										<td><p><?=number_format($total_fab,2);?></p></td>
									</tr>
 			                   		
 			                   </tbody>
 			                   
 			            </table>

       		 			 
       		 		</td>
       		 		<td width="45%" style="float: right;">
 			       		 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <tr align="center">
 			                    	<td colspan="8"><b>RMG Process Loss %</b></td>
 			                    </tr>
 			                    <tr align="center">
 				                    <td>Cutting</td>
 				                    <td>Sewing</td>
 				                    <td>Chest Printing</td>
 				                    <td>Embroidery</td>
 				                    <td>Finishing</td>
									<td>Cut Panel rejection</td>
 				                    <td>Neck/Sleeve Printing</td>
									<td> Garments Wash</td>
									<td> Lay Wash (Fabric) </td>
 				                    <td>Total</td>
 				                   
 			                    </tr>
									<? if($rmg_process_breakdown_arr[0]==''){
										$rmg_process_breakdown_arr[0]=0;
									} ?>
 				                    <tr>
 				                    <td><? echo fn_number_format($rmg_process_breakdown_arr[0],2); ?></td>
 				                    <td><? echo number_format($rmg_process_breakdown_arr[4],2); ?></td>
 				                    <td><? echo number_format($rmg_process_breakdown_arr[2],2); ?></td>
 				                    <td><? echo number_format($rmg_process_breakdown_arr[1],2); ?></td>
 				                    <td><? echo number_format($rmg_process_breakdown_arr[15],2); ?></td>
									<td><? echo number_format($rmg_process_breakdown_arr[8],2); ?></td>
 				                    <td><? echo number_format($rmg_process_breakdown_arr[10],2); ?></td>
									 <td><? echo number_format($rmg_process_breakdown_arr[3],2); ?></td>
									 <td><? echo number_format($rmg_process_breakdown_arr[14],2); ?></td>
									 <?php
										$total_rmg+=$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[15]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[14];
									 ?>
 				                    <td align="right"><? echo number_format($total_rmg,2);?></td>
 				                    
 				                    </tr>
 				                    <?
 								
 								?>
 			            </table>
       		 		</td>
       		 	</tr>
       		 </table>
        <?
			if($cbo_fabric_source==1)
			{
				$po_data=sql_select("select a.po_break_down_id	from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and  a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") 
				and a.booking_no=$txt_booking_no and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id");

			
				foreach($po_data as $val){

					$po_ids[$val[csf('po_break_down_id')]]=$val[csf('po_break_down_id')];
				}



        	$grand_order_total=0; $grand_plan_total=0; $size_wise_total=array();
			$nameArray_size=sql_select( "select size_number_id,size_order from wo_po_color_size_breakdown where  is_deleted=0 ".where_con_using_array($po_ids,1,'po_break_down_id')." and status_active=1 group by size_number_id,size_order  order by size_order");
			
			?>
                <div id="div_size_color_matrix" class="pagebreak">
                    <fieldset id="div_size_color_matrix" >
                        <legend>Size and Color Breakdown</legend>
                        <table  class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                            <tr>
                            	<td>PO Number</td>
                            	<td>PO Received Date </td>
                                <td>Lab Dip No </td>
                            	<td>Ship Date</td>
                            	
                            	<td>Gmts Item</td>
                                <td style="border:1px solid black"><strong>Color/Size</strong></td>
                                <?
                                foreach($nameArray_size  as $result_size)
                                {
									?>
                                	<td align="center" style="border:1px solid black"><?=$size_library[$result_size[csf('size_number_id')]];?></td>
                                <? } ?>
                                <td  align="center"> Total Order Qty(Pcs)</td>
                                <td  align="center"> Excess %</td>
                                <td  align="center"> Total Plan Cut Qty(Pcs)</td>
                            </tr>
                            <?
                            $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                           	$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
                           	$result_cs=sql_select( "select b.item_number_id,b.color_number_id,sum(b.order_quantity) as order_quantity,b.size_number_id,b.po_break_down_id,b.size_order from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.job_no_mst ='$job_no' ".where_con_using_array($po_ids,1,'b.po_break_down_id')." and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 group by b.item_number_id,b.color_number_id,b.size_number_id,b.po_break_down_id,b.size_order order by b.size_order ");
                           	$color_size_data=array();
                           	foreach ($result_cs as $row) {
                           		$color_size_data[$row[csf('po_break_down_id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]+=$row[csf('order_quantity')];
                           	}

                           	$sql_color="select a.po_number,a.id,a.po_received_date,a.shipment_date,b.item_number_id,b.color_number_id,sum(b.plan_cut_qnty) as plan_cut_qnty,a.shiping_status from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.job_no_mst ='$job_no' ".where_con_using_array($po_ids,1,'b.po_break_down_id')." and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 group by a.po_number,a.id,a.po_received_date,a.shipment_date,b.item_number_id,b.color_number_id,a.shiping_status order by a.po_number,a.shipment_date asc ";
                           	//echo $sql_color;
							$result_color_size=sql_select( $sql_color);

							foreach ($result_color_size as $row) 
							{
								$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."'  and approval_status=3   and color_name_id=".$row[csf('color_number_id')]."  and po_break_down_id=".$row[csf('id')]."  and status_active=1 and is_deleted=0");
								?>
								<tr>
									<td><?php echo $row[csf('po_number')] ?></td>
									<td><?php echo change_date_format($row[csf('po_received_date')]); ?></td>
                                     <td><?php  echo $lapdip_no; ?></td>
									<td><?php echo change_date_format($row[csf('shipment_date')]); ?></td>	
                                   								
									<td><?php echo $garments_item[$row[csf('item_number_id')]]; ?></td>
									<td><?php echo $color_library[$row[csf('color_number_id')]]; ?></td>
									<?
									$total=0;

                                    foreach($nameArray_size  as $key)
                                    {
										?>
                                    	<td align="center" style="border:1px solid black">
                                    		<?
                                    				$qnty=0;
                                    				$qnty=$color_size_data[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$key[csf('size_number_id')]];

                                    				echo number_format($qnty);
                                    				$size_wise_total[$key[csf('size_number_id')]]+=$qnty;
                                    				$total+=$qnty;
                                    			?>
                                    	</td>
                                   	 	<? 
                                	}

                                	$grand_order_total+=$total;
        							$grand_plan_total+=$row[csf('plan_cut_qnty')];

        							$plan_cut_dif=$row[csf('plan_cut_qnty')]-$total;
        							$ex_cut_perc=($plan_cut_dif/$total)*100;

                                	?>
                                	<td align="center"><?php echo number_format($total); ?></td>
                                	<td align="center"><?php echo number_format($ex_cut_perc,2); ?>%</td>
                                	<td align="center"><?php echo number_format($row[csf('plan_cut_qnty')]); ?></td>
								</tr>
								<?
							}
                            ?>
                            <tr>
                            	<td align="right" colspan="6">Total</td>
                            	<?
                                    foreach($nameArray_size  as $key)
                                    {
										?>
                                    	<td align="center" style="border:1px solid black">
                                    		<strong><?
                                    				echo number_format($size_wise_total[$key[csf('size_number_id')]])
                                    			?>
                                    	</strong>
                                    	</td>
                                   	 	<? 
                                	}
                                	?>
                                <td align="center"><strong><?=number_format($grand_order_total)?></strong></td>
                                <td></td>
                                <td align="center"><strong><?=number_format($grand_plan_total)?></strong></td>
                            </tr>  
                        </table>
                    </fieldset>
                </div>

			<?php
				}
			?>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Production) </b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("SELECT a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_id=b.job_id and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by id");
        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
			<tr align="center">
				<td><? echo $col; ?></td>
				<td><? echo $row[csf("po_number")]; ?></td>
				<td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
				<td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
				<td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
				<td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
				<td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
				<td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
				<td align="right">
				<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
				</td>
				<td>
				<?
				if( $balance>0)
				{
				echo "Less Booking";
				}
				else if ($balance<0)
				{
				echo "Extra Booking";
				}
				else
				{
				echo "";
				}
				?>
				</td>
			</tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>

        <?
       /*   if(count($purchase_res))
        { */
        	?>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Purchase)</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Purchase<br>Booking Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and c.job_no_mst = '$txt_job_no'   and   a.fabric_source = '2'  and a.status_active=1 and a.is_deleted=0 order by id");
		//echo "select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and c.job_no_mst = '$txt_job_no'   and   a.fabric_source = '2'  and a.status_active=1 and a.is_deleted=0 order by id";
		 

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and   a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1  and c.fabric_source = 2  and a.is_short=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");


        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1 and c.fabric_source=2 and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =4 and c.fabric_source=2 and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.job_no_mst='$txt_job_no' group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
       
        </tfoot>
        </table>
         <?
        	//}
        ?>

		<fieldset id="div_size_color_matrix" style="max-width:1000;">
		<?
		//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "SELECT id,po_number_id, (case when task_number=31 then task_start_date else null end) as fab_booking_start_date, (case when task_number=31 then task_finish_date else null end) as fab_booking_end_date, (case when task_number=60 then task_start_date else null end) as knitting_start_date, (case when task_number=60 then task_finish_date else null end) as knitting_end_date, (case when task_number=61 then task_start_date else null end) as dying_start_date, (case when task_number=61 then task_finish_date else null end) as dying_end_date, (case when task_number=64 then task_start_date else null end) as finishing_start_date, (case when task_number=64 then task_finish_date else null end) as finishing_end_date, (case when task_number=84 then task_start_date else null end) as cutting_start_date, (case when task_number=84 then task_finish_date else null end) as cutting_end_date, (case when task_number=86 then task_start_date else null end) as sewing_start_date, (case when task_number=86 then task_finish_date else null end) as sewing_end_date, (case when task_number=110 then task_start_date else null end) as exfact_start_date, (case when task_number=110 then task_finish_date else null end) as exfact_end_date, (case when task_number=47 then task_start_date else null end) as yarn_rec_start_date, (case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date from tna_process_mst where status_active=1 and po_number_id in($po_id_all)"); 
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

			//------------------------------ Query for TNA end-----------------------------------
		?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:17px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                <?
				}
				?>
        	</table>
            <br>
		<? } echo get_spacial_instruction($txt_booking_no,"97%",118); ?>
        
        <div ><? echo signature_table(1, $cbo_company_name, "1400px",'',70,$inserted_by2);  //signature_table(1, $cbo_company_name, "1400px"); //$user_name_arr[$user_id] ?></div>
		<br>
       <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="1300" cellspacing="0" rules="all" >
        	<thead>
            	<th colspan="16"><b>Job Progress Status: </b></th>
            </thead>
            <?
			$condition= new condition();
			if(str_replace("'","",$job_no) !=''){
				$condition->job_no("='$job_no'");
			}
			//Fabric Booking
			$condition->init();
			$fabric= new fabric($condition);  //echo $fabric->getQuery();
			$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabreqQty=0;
			foreach($fabric_qty['knit']['grey'] as $fid=>$fdata)
			{
				foreach($fdata as $fuom=>$fuomdata)
				{
					$fabreqQty+=$fuomdata;
				}
			}
			
			$sqlJobPo=sql_select("select id from wo_po_break_down where job_no_mst='$job_no' and status_active=1 and is_deleted=0");
			$poIds="";
			foreach($sqlJobPo as $row)
			{
				if($poIds=="") $poIds=$row[csf('id')]; else $poIds.=','.$row[csf('id')];
			}
			unset($sqlJobPo);
			
			$sqlFabbooking=sql_select("select sum(grey_fab_qnty) as grey_fab_qnty from wo_booking_dtls where job_no='$job_no' and booking_type=1 and status_active=1 and is_deleted=0");
			$fabbookingQty=$sqlFabbooking[0][csf('grey_fab_qnty')];
			
			$fabbookingPer=($fabbookingQty/$fabreqQty)*100;
			
			//Yarn Allocation
			$sqlYarnAll=sql_select("select sum(qnty) as qnty from inv_material_allocation_dtls where job_no='$job_no' and item_category=1 and status_active=1 and is_deleted=0");
			$yarnAlloQty=$sqlYarnAll[0][csf('qnty')];
			$yarnAlloPer=($yarnAlloQty/$fabreqQty)*100;
			
			$sqlStore="select entry_form, trans_type, quantity from order_wise_pro_details where po_breakdown_id in(".$poIds.") and trans_type in (1,2) and entry_form in (2,3,22,23,58,82,7,66,37,225) and status_active=1";
			$sqlstoreRes=sql_select($sqlStore);
			
			$yarnIssueQty=$knittingFinishQty=$greyRecQty=$finishProdQty=$finishRecQty=0;
			foreach($sqlstoreRes as $row)
			{
				if($row[csf('trans_type')]==2 && $row[csf('entry_form')]==3)
				{
					$yarnIssueQty+=$row[csf('quantity')];
				}
				if($row[csf('trans_type')]==1)
				{
					if($row[csf('entry_form')]==2)
					{
						$knittingFinishQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==22 || $row[csf('entry_form')]==23 || $row[csf('entry_form')]==58 || $row[csf('entry_form')]==82)
					{
						$greyRecQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==7 || $row[csf('entry_form')]==66)
					{
						$finishProdQty+=$row[csf('quantity')];
					}
					else if($row[csf('entry_form')]==37 || $row[csf('entry_form')]==225)
					{
						$finishRecQty+=$row[csf('quantity')];
					}
				}
			}
			unset($sqlstoreRes);
			
			$yarnIssePer=($yarnIssueQty/$fabreqQty)*100;			//Yarn Issued
			$knittingFinishPer=($knittingFinishQty/$fabreqQty)*100;	//Knitting Finished
			$greyRecPer=($greyRecQty/$fabreqQty)*100;				//Greige Fabric Received
			$finishProdPer=($finishProdQty/$fabreqQty)*100;			//Finished Fabric Production
			$finishRecPer=($finishRecQty/$fabreqQty)*100;			//Finished Fabric Received
			
			
			$sqlGmtsProd="select production_type, embel_name, production_quantity from pro_garments_production_mst where po_break_down_id in(".$poIds.") and production_type in (1,3,5,7,15,11,8) and status_active=1";
			$sqlGmtsProdRes=sql_select($sqlGmtsProd);
			$cutQty=$printQty=$embRecQty=$sewOutQty=$ironQty=$hangTagQty=$polyQty=$packFinQty=0;
			foreach($sqlGmtsProdRes as $row)
			{
				if($row[csf('production_type')]==1)
				{
					$cutQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==3 && $row[csf('embel_name')]==1)
				{
					$printQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==3 && $row[csf('embel_name')]==1)
				{
					$embRecQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==5)
				{
					$sewOutQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==7)
				{
					$ironQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==15)
				{
					$hangTagQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==11)
				{
					$polyQty+=$row[csf('production_quantity')];
				}
				else if($row[csf('production_type')]==8)
				{
					$packFinQty+=$row[csf('production_quantity')];
				}
			}
			unset($sqlGmtsProdRes);
			$cutFinishPer=($cutQty/$jobqtypcs)*100;		//Cutting Finished
			$printRecPer=($printQty/$jobqtypcs)*100;	//Print Received
			$embRecPer=($embRecQty/$jobqtypcs)*100;		//Embroidery Received
			$sewOutPer=($sewOutQty/$jobqtypcs)*100;		//Sewing Completed
			$ironPer=($ironQty/$jobqtypcs)*100;			//Iron Completed
			$hangTagPer=($hangTagQty/$jobqtypcs)*100;	//Hang Tag Completed
			$polyPer=($polyQty/$jobqtypcs)*100;			//Poly Completed
			$packFinishPer=($packFinQty/$jobqtypcs)*100;//Packing Finishing Completed
			
			//Ex-factory Completed
			$sqlExFactory=return_field_value("sum(ex_factory_qnty) as exqty", "pro_ex_factory_mst", "po_break_down_id in(".$poIds.") and status_active=1", "exqty");
			$exFactoryPer=($sqlExFactory/$jobqtypcs)*100;
			
			?>
			<tr>
            	<td width="125"><b>Fabric Booking</b></td><td align="center" width="40"><?=number_format($fabbookingPer,2); ?></td>
                <td width="125"><b>Yarn Allocation</b></td><td align="center" width="40"><?=number_format($yarnAlloPer,2); ?></td>
                <td width="125"><b>Yarn Issued</b></td><td align="center" width="40"><?=number_format($yarnIssePer,2); ?></td>
                <td width="125"><b>Knitting Finished</b></td><td align="center" width="40"><?=number_format($knittingFinishPer,2); ?></td>
                <td width="125"><b>Greige Fabric Received</b></td><td align="center" width="40"><?=number_format($greyRecPer,2); ?></td>
                <td width="125"><b>Dye-Fin. Completed</b></td><td align="center" width="40"><?=number_format($finishProdPer,2); ?></td>
                <td width="125"><b>Finished Fabric Received</b></td><td align="center" width="40"><?=number_format($finishRecPer,2); ?></td>
                <td width="125"><b>Cutting Finished</b></td><td align="center"><?=number_format($cutFinishPer,2); ?></td>
            </tr>
            <tr>
            	<td><b>Print Received</b></td><td align="center"><?=number_format($printRecPer,2); ?></td>
            	<td><b>Embroidery Received</b></td><td align="center"><?=number_format($embRecPer,2); ?></td>
            	<td><b>Sewing Completed</b></td><td align="center"><?=number_format($sewOutPer,2); ?></td>
                <td><b>Iron Completed</b></td><td align="center"><?=number_format($ironPer,2); ?></td>
                <td><b>Hang Tag Completed</b></td><td align="center"><?=number_format($hangTagPer,2); ?></td>
                <td><b>Poly Completed</b></td><td align="center"><?=number_format($polyPer,2); ?></td>
                <td><b>Packing Finishing Completed</b></td><td align="center"><?=number_format($packFinishPer,2); ?></td>
                <td><b>Ex-factory Completed</b></td><td align="center"><?=number_format($exFactoryPer,2); ?></td>
            </tr>
        </table>

		
		<div >
                    <fieldset id="div_size_color_matrix" >
                        <legend>Actual PO Information</legend>
                        <table  class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                            <tr>
                            	<th>PO Number</th>                            
                            	<th>Actual PO</th>
								<th>PO Recieve Date</th>
								<th>Ship Date</th>                           	
                                <th>GMTS Items</th>
                                <th >Gmts  Color</th>
								<th>Gmts Size</th>
                                <th>Total Order Qty(pcs)</th>
                            </tr>
			<?php
			$colorLibArr=return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
			$sizeLibArr=return_library_array("select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");

					$ac_sql="select  b.po_number,a.acc_po_no, a.country_id, a.gmts_item, a.gmts_color_id,a.acc_po_qty as qnty, a.acc_ship_date,a.po_break_down_id,b.po_received_date,a.gmts_size_id
					from wo_po_acc_po_info a,wo_po_break_down b where  b.id=a.po_break_down_id and a.po_break_down_id=60252 and a.job_no='FAL-22-00707' and a.status_active=1 and a.is_deleted=0 ";
					$ac_po_data=sql_select($ac_sql);


					foreach($ac_po_data as $val){?>

						<tr>
							<td><?=$val[csf('po_number')];?></td>
							<td><?=$val[csf('acc_po_no')];?></td>
							<td><?=$val[csf('po_received_date')];?></td>
							<td><?=$val[csf('acc_ship_date')];?></td>
							<td><?=$garments_item[$val[csf('gmts_item')]];?></td>
							<td align="center"><?=$colorLibArr[$val[csf('gmts_color_id')]];?></td>
							<td align="center"><?=$sizeLibArr[$val[csf('gmts_size_id')]];?></td>
							<td align="center"><?=$val[csf('qnty')];?></td>
						</tr>


					<?}	?>


		                </table>
					
				</fieldset>


		</div >







        <?


					$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$job_no'", "gmts_item_id", "set_item_ratio");
					$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down  where job_no_mst ='$job_no'", "id", "po_number");
					$shipment_date_arr=return_library_array( "select id,shipment_date from wo_po_break_down  where job_no_mst ='$job_no'", "id", "shipment_date");
        	$grand_order_total=0; $grand_plan_total=0; $size_wise_total=array();
			$nameArray_size=sql_select( "select size_number_id,size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id,size_order order by size_order ");



			
			$booking_dtls_sql="SELECT a.id as booking_dtls_id, b.id, a.fabric_color_id, a.fin_fab_qnty, a.grey_fab_qnty, a.amount, a.rate, a.colar_cuff_per  from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_pre_cost_fabric_cost_dtls c where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_no=$txt_booking_no and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
			$booking_dtls_res=sql_select($booking_dtls_sql);
			
			$booking_dtls_id_array=array(); $fabric_color_array=array(); $finish_fabric_qnty_array=array(); $grey_fabric_qnty_array=array(); $grey_fabric_amount_array=array(); $grey_fabric_rate_array=array(); $colar_cuff_percent_array=array();
	
			foreach($booking_dtls_res as $row)
			{
				$booking_dtls_id_array[$row[csf("id")]]=$row[csf("booking_dtls_id")];
				//$job_no=$row[csf("job_no")];
				$fabric_color_array[$row[csf("id")]]=$row[csf("fabric_color_id")];
				$finish_fabric_qnty_array[$row[csf("id")]]+=$row[csf("fin_fab_qnty")];
				$grey_fabric_qnty_array[$row[csf("id")]]+=$row[csf("grey_fab_qnty")];
				$grey_fabric_amount_array[$row[csf("id")]]=$row[csf("amount")];
				$grey_fabric_rate_array[$row[csf("id")]]['rate']=$row[csf("rate")];
				$grey_fabric_rate_array[$row[csf("id")]]['colar_cuff_per']=$row[csf("colar_cuff_per")];
			}
			unset($booking_dtls_res);
		

			$name_sql="select a.id as pre_cost_fabric_cost_dtls_id, a.job_no, a.item_number_id, a.body_part_id, a.fab_nature_id, a.fabric_source, a.color_type_id, a.gsm_weight, a.construction, a.composition, a.color_size_sensitive, a.costing_per, a.color, a.color_break_down, a.rate as rate_mst, b.id, b.po_break_down_id, b.color_size_table_id, b.color_number_id, b.gmts_sizes as size_number_id, b.dia_width, b.item_size, b.cons, b.process_loss_percent, b.requirment, b.rate, b.pcs, b.remarks FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).")   and a.status_active=1 and a.is_deleted=0 order by a.id,b.color_size_table_id";
			
	
			$nameArray=sql_select($name_sql);

			$po_fabric_wise_data=array();
			foreach ($nameArray as $result){

								if($finish_fabric_qnty_array[$result[csf("id")]]>0  || $grey_fabric_qnty_array[$result[csf("id")]]> 0  )
								{

									$ship_date=change_date_format($shipment_date_arr[$result[csf('po_break_down_id')]]);

									$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['finish_kg']+=$finish_fabric_qnty_array[$result[csf("id")]];
									$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['grey_kg']+=$grey_fabric_qnty_array[$result[csf("id")]];
									$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['process_loss']=$result[csf('process_loss_percent')];
									$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['color_size_sensitive']=$result[csf('color_size_sensitive')];
									$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['id']=$result[csf('id')];
							
								}
			  }

			?>
                <div id="div_size_color_matrix" class="pagebreak">
                    <fieldset id="div_size_color_matrix" >
                        <legend>Size and Color Breakdown</legend>
						<table  class="rpt_table"  border="1" align="left" style="float:left;" cellpadding="0"  cellspacing="0" rules="all" >
                            <tr>
                            	<td>PO Number</td>
                            
                            	<td>Ship Date</td>
								<td>fabric color</td>
								<td>Body Color</td>                           	
                                <td  align="center"> Total Finish Fabric(kg)</td>
                                <td  align="center"> Total Grey Fabric(kg)</td>
                                <td  align="center"> Process Loss</td>
                            </tr>
                            <?
                           
							foreach ($po_fabric_wise_data as $po_id=>$shipdate_data){
								foreach ($shipdate_data as $date_id=>$color_data) {
									foreach ($color_data as  $color_id=>$result){

								?>
								<tr>
									<td title="<?=$po_id;?>"><?php echo $po_number_arr[$po_id]; ?></td>
									
									<td><?php echo $date_id; ?></td>									
									<td><? if($result["color_size_sensitive"]!=0) echo $color_library[$color_id]; ?></td>									
									<td><?php
									
									$type=1;
									$color_id="";
									if($type==1)
									{
										echo $color_library[$fabric_color_array[$result["id"]]];
										$color_id=$fabric_color_array[$result["id"]];
									}
									else if($type==2)
									{
										if($result["color_size_sensitive"]==3)
										{
											echo $constrast_color_arr[$result["color_number_id"]]; $color_id=$contrastcolor_arr[$result["job_no"]][$result["pre_cost_fabric_cost_dtls_id"]][$result["color_number_id"]];
										}
										else if($result["color_size_sensitive"]==0)
										{
											echo $color_library[$result["color"]]; $color_id=$result["color"];
										}
										else
										{
											echo $color_library[$result["color_number_id"]]; $color_id=$result["color_number_id"];
										}
									}
									 ?></td>
									<?

                                	$grand_fabric_total+=$result["finish_kg"];
        							$grand_grey_total+=$result["grey_kg"];

                                    $po_fabric_tot[$po_id]+=$result["finish_kg"];
        							$po_grey_tot[$po_id]+=$result["grey_kg"];
                                    $color_wise_arr[$color_id]['finish_kg']+=$result["finish_kg"];
                                    $color_wise_arr[$color_id]['grey_kg']+=$result["grey_kg"];

        			

                                	?>
                                	<td align="center"><?php echo number_format($result["finish_kg"],2); ?></td>
                                	<td align="center"><?php echo number_format($result["grey_kg"],2); ?></td>
                                	<td align="center"><?php echo number_format($result['process_loss']); ?></td>
								</tr>
								<?
							     }
						      }?>

                            <tr>
                            	<td align="right" colspan="4"><b>Po Wise Total</b></td>                            	
                                <td align="center"><strong><?=number_format($po_fabric_tot[$po_id],2)?></strong></td>                                
                                <td align="center"><strong><?=number_format($po_grey_tot[$po_id],2)?></strong></td>
								<td></td>
                            </tr>
                            <?

							}
                            ?>
                            <tr>
                            	<td align="right" colspan="4"><b>Grand Total</b></td>                            	
                                <td align="center"><strong><?=number_format($grand_fabric_total,2)?></strong></td>                                
                                <td align="center"><strong><?=number_format($grand_grey_total,2)?></strong></td>
								<td></td>
                            </tr>
                        </table>
                        <table  class="rpt_table"  style="float:left;margin-left:5px;" border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
                            <tr>
                                <td colspan="4" align="center">Color wise Summary</td>                               
                            </tr>
                            <tr>
                                <td>Sl</td>
                                <td>Color Name</td>
                                <td>Finish Fabric(kg)</td>
                                <td>Grey Fabric(kg)</td>
                            </tr>
                            <?php
                            $sl=1;
                                foreach($color_wise_arr as $cid=> $val){
                            ?>
                            <tr>
                                <td width="30"><?=$sl;?></td>
                                <td width="100"><?=$color_library[$cid];?></td>
                                <td width="100" align="right"><?=number_format($val['finish_kg'],2);?></td>
                                <td width="100" align="right"><?=number_format($val['grey_kg'],2);?></td>
                            </tr>
                            <?$sl++;
                        
                                    $grand_fabric_tot+=$val['finish_kg'];
        							$grand_grey_tot+=$val['grey_kg'];
                        }?>
                            <tr>
                              
                                <td colspan="2">Total</td>
                                <td align="right"><?=number_format($grand_fabric_tot,2);?></td>
                                <td align="right"><?=number_format($grand_grey_tot,2);?></td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
			<?

			$actule_po_size=sql_select("select gmts_size_id from wo_po_acc_po_info where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by gmts_size_id ");
			$actule_po_data=sql_select( "SELECT a.id as po_id,a.po_number, b.acc_po_no, a.po_received_date, b.acc_ship_date, b.gmts_color_id, b.gmts_size_id, b.acc_po_qty, b.id as actule_po_id , b.gmts_item from wo_po_break_down a join wo_po_acc_po_info b on a.id=b.PO_BREAK_DOWN_ID where b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and b.is_deleted=0 and b.status_active=1 and a.is_deleted=0 and a.status_active=1");
			$actule_po_arr=array();
			$attribute=array('po_number','acc_po_no','po_received_date','acc_ship_date','gmts_color_id','gmts_size_id','acc_po_qty','gmts_item');
			foreach ($actule_po_data as $row) {
				foreach ($attribute as $attr) {
					$actule_po_arr[$row[csf('po_id')]][$row[csf('actule_po_id')]][$attr]=$row[csf($attr)];
				}
				$actual_color_size[$row[csf('po_id')]][$row[csf('actule_po_id')]][$row[csf('gmts_item')]][$row[csf('gmts_color_id')]][$row[csf('gmts_size_id')]] =$row[csf('acc_po_qty')];				
			}

			$booking_dtls_data=sql_select(" SELECT a.po_number, a.pub_shipment_date,b.fabric_color_id,b.gmts_color_id, b.fin_fab_qnty, b.grey_fab_qnty, c.size_number_id,c.excess_cut_perc from wo_po_break_down a join wo_booking_dtls b on a.id=b.po_break_down_id join WO_PO_COLOR_SIZE_BREAKDOWN c on c.id=b.color_size_table_id where b.booking_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
			$size_lib_arr = return_library_array("select id,size_name from  lib_size ","id","size_name");
		
		?>
		    
       </div>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}
if($action=="show_fabric_booking_report_print24") //Print B24=>19-05-2022(md mamun ahmed sagor)
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');


	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	$po_job_no="";
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$vals[csf('job_no')]]=$vals[csf('job_no')];
		$joball['style_ref_no'][$vals[csf('job_no')]]=$vals[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];

		$all_job_arr_season[$vals[csf("job_no")]]=$season_arr[$vals[csf("season_buyer_wise")]];

		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_job_arr_dept[$vals[csf("job_no")]]=$product_dept[$vals[csf("product_dept")]];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
		$po_job_no=$vals[csf('job_no')];
	}
	//echo $po_job_no.'DDD';die;
	$all_jobs_id=implode(",",$all_jobs );
	$seasons=implode(",",$all_job_arr_season );
	$depts=implode(",",$all_job_arr_dept );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no,a.order_uom as uom from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no,a.order_uom");
 	$shipment_dates="";
 	$job_uom_array=array();
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 		$job_uom_array[$data[csf("job_no")]]=$unit_of_measurement[$data[csf("uom")]];


 	}
 	$unites=implode(",", $job_uom_array);


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  and a.job_no in ($all_jobs_id) ");

	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" rowspan="2"><img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>
					
					<td width="200" align="left" style="font-size: 16px;"><b><?php echo $company_library[$cbo_company_name]; ?></b></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
					<td width="150" rowspan="2"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' height='100' width='100' /></td>
				</tr>
				<tr>
				
					<td width="200" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{
							?>
							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
						}
							?>

					</td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="200" align="left" style="font-size: 16px;"><b>Fabric Booking Sheet </b></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>

				<tr>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
				</tr>
				<tr>
					<td colspan="4" height="10">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><b>To</b></td>

					<td width="200" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
					<td align="left"><b>Season : </b>&nbsp;<? echo $seasons;?></td>

				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><?
					$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode!=3 && $pay_mode!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>

					<td width="200" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?>&nbsp;<? echo $unites;?></td>
					<td><b>Dept : </b> &nbsp;<? echo $depts; ?></td>
					<td></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<!-- <td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td> -->

					<td width="200" align="left"><b>Dealing Merchandiser:   </b> <? echo $marchentrArr[$nameArray_per_job[0][csf("dealing_marchant")]]; ?></td>

					<td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>

				   <td width="400" align="left"><b>Currency:   </b> <? echo $currency[$nameArray_per_job[0][csf("currency_id")]]; ?></td>
				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<!-- <tr>
				   <td colspan="2" width="800"><b>Shipment Date: </b><? echo trim($shipment_dates);?></td>

				</tr> -->


				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>WO Prepared After:   </b>    </td>

				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>


				</tr>
			</thead>
		</table>


			<?php
			$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
			list($nameArray_approved_row) = $nameArray_approved;
			$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
			list($nameArray_approved_date_row) = $nameArray_approved_date;
			$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
			list($nameArray_approved_comments_row) = $nameArray_approved_comments;

			$po_data = array();
			if ($db_type == 0) {
				$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
			}
			if ($db_type == 2) {
				$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
			}
			foreach ($nameArray_job as $result_job) {
				$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
				$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
				$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
				$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
				$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
				$ddd = strtotime($result_job[csf('pub_shipment_date')]);
				$po_data['pub_shipment_date'][$ddd] = $ddd;

				$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

				if ($result_job[csf('shiping_status')] == 1) {
					$shiping_status = "FP";
				} else if ($result_job[csf('shiping_status')] == 2) {
					$shiping_status = "PS";
				} else if ($result_job[csf('shiping_status')] == 3) {
					$shiping_status = "FS";
				}
				$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
				$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];

				$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
			}
		$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
		$leadtime = implode(",", array_unique($po_data['leadtime']));
		$po_quantity = array_sum($po_data['po_quantity']);
		$po_received_date = implode(",", array_unique($po_data['po_received_date']));
		$po_number = implode(",", array_unique($po_data['po_number']));
		$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
		$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
		//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
		$shiping_status = implode(",", array_unique($po_data['shiping_status']));
		$file_no = implode(",", array_unique($po_data['file_no']));
		$grouping = implode(",", array_unique($po_data['grouping']));

		$colar_excess_percent = 0;
		$cuff_excess_percent = 0;
		$rmg_process_breakdown = 0;
		$nameArray = sql_select("select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
		foreach ($nameArray as $result) {
		$total_set_qnty = $result[csf('total_set_qnty')];
		$colar_excess_percent = $result[csf('colar_excess_percent')];
		$cuff_excess_percent = $result[csf('cuff_excess_percent')];
		$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id => $po_val) {
			$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
			$booking_date = $result[csf('update_date')];
			if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
				$booking_date = $result[csf('insert_date')];
			}
			$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
		}

		}

	?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;

		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_qty_arr = sql_select("select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.job_no=c.job_no_mst and a.status_active =1 and b.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ");
			
		//echo "select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ";
			foreach($nameArray_qty_arr as $row)
			{
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][40]+=$row[csf('order_quantity')];
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][50]+=$row[csf('order_quantity')];
				$fab_gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$gmts_color_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]]['color'].=$row[csf('color_number_id')].',';
			}

			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,min(c.color_order) as color_order,c.job_no_mst,sum(c.order_quantity) as order_quantity_pcs,avg(b.cons) as cad_consumption,avg(b.requirment) as consumption,avg(b.process_loss_percent) as wastage,d.fin_fab_qnty,d.remark  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.dia_width=d.dia_width and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id
				and
				d.booking_no =$txt_booking_no and
				d.job_no in ($all_jobs_id) and

				d.status_active=1 and
				c.status_active=1 and
				d.is_deleted=0 and
				b.cons>0
				group by  a.id , a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type  , b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,d.fin_fab_qnty,c.job_no_mst,d.remark  order by a.body_part_id,d.fabric_color_id ");


				

				


			$uom_data_arr=array();$b_part_array_not=array(40,50);
			foreach($nameArray_fabric_description as $row)
			{
				if(!in_array($row[csf('body_part_type')],$b_part_array_not))
				{
					$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				}
				// $uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				if($row[csf('body_part_type')]==40 || $row[csf('body_part_type')]==50)
				{
					//$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('fabric_color_id')]][$row[csf('body_part_type')]]+=$row[csf('order_quantity_pcs')];
					$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('gmts_color_id')]][$row[csf('body_part_type')]]=$row[csf('order_quantity_pcs')];
				}
			}

			// echo "<pre>";
			// print_r($uom_data_arr);
			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Summary </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style</th>
										<th  width="140" align="center">Gmts Item</th>
										<th  width="130" align="center">Body Parts</th>
										<th  width="100" align="center">Gmts Qty (Pcs)</th>
										<th  width="100" align="center">Plan Cut Qty (Pcs)</th>
										<th  width="390" align="left">Fabric Composition</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fabric Dia</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Combo</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="80" align="center">CAD Consumption (Kg/Dzn)</th>
							
										<th  width="60" align="center">UOM</th>
										<!-- <th width='120' align="center"></th> -->
										<th width='120' align="center" title="Based on avg grey consumption">Finish Fab. Qty</th>
										<th width='100' align="center">Avg Rate/<? echo $unit_of_measurement[$uom_id];?></th>
										<th width='60' align="center">Amount</th>
										<th  align="center">Remarks</th>

									</tr>
									<? //wo_pre_cos_fab_co_color_dtls
									$color_wise_process_loss=sql_select("SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss FROM  wo_pre_cos_fab_co_avg_con_dtls  b,wo_pre_cost_fabric_cost_dtls a WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)  group by a.body_part_id,b.color_number_id order by a.body_part_id,b.color_number_id");
									//echo "SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss,g.contrast_color_id FROM  wo_pre_cos_fab_co_avg_con_dtls  b,wo_pre_cost_fabric_cost_dtls a left join wo_pre_cos_fab_co_color_dtls g on a.job_no=g.job_no and a.id=g.pre_cost_fabric_cost_dtls_id 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)  group by a.body_part_id,b.color_number_id,g.contrast_color_id";

									foreach($color_wise_process_loss as $val)
									{
										$loss_arr[$val[csf("body_part_id")]][$val[csf("color_number_id")]]=$val[csf("loss")];

									}

									$total_fin_fab_qnty=$total_gmt_qty_pcs=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";
										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and
											a.id='".$val[csf('fabric_cost_dtls_id')]."' and
											a.uom='".$uom_id."' and

											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond
											");
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];

											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('gmts_color_id')]];
											$order_quantity_pcs=0;
											if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
											{
												$gmt_colorName=$color_library[$val[csf('fabric_color_id')]];
												$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											}
											else
											{
												$color_break_down=$val[csf('color_break_down')];
												if($color_break_down)
												{
													$gmts_color="";
													if (strpos($color_break_down, '__') !== false)
													{
														$color_break_down=explode('__', $color_break_down);
														foreach ($color_break_down as $key => $value)
														{
															$cols=explode('_', $value);
															if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
															{
																if($gmts_color=="")
																{
																	$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

																}
																else
																{
																	$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

																}

															}
														}
													}
													else
													{
														$cols=explode('_', $color_break_down);
														if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
														{
															if($gmts_color=="")
															{
																$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

															}
															else
															{
																$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

															}

														}
													}

													$gmt_colorName=$gmts_color;
												}

											}

											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>

												
												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];?></td>
												<td align="center"> <? echo $garments_item[$val[csf("item_number_id")]];?></td>
												<td align="center"><? echo $body_part[$val[csf('body_part_id')]];?></td>
												<td align="center"><? echo number_format($order_quantity_pcs,2);?></td>
												<td align="center"><? echo number_format($val[csf("grey_fab_qntys")],2);?></td>
												<td align="left"> <? echo $val[csf('construction')].','.$val[csf('composition')].', '.$pre_cost_remarks; ?> </td>

												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center">
													<?
													echo $gmt_colorName;
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												
												<td align="center"> <? echo def_number_format($val[csf('consumption')],2); ?></td>
												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<!-- <td align="center"> <?   //$greys= $color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")] /(1+($loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]/100)) ;
													//echo def_number_format($greys,2);
													
													$val[csf('fin_fab_qnty')]='';
													$val[csf('fin_fab_qnty')]=$color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];

													?> </td> -->



													<td align="center"> <? echo def_number_format($val[csf('fin_fab_qnty')],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")]/$val[csf('fin_fab_qnty')],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));

													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($val[csf('fin_fab_qnty')],2));
													$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;
													$total_gmt_qty_pcs +=$order_quantity_pcs;


													?>
												<td align="center"> <? echo $val[csf('remark')]; ?> </td>


												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">

									<td  align="right" colspan="5"><strong>Total</strong></td>
									 <td align="right"><? //echo def_number_format($total_gmt_qty_pcs,2);?></td>
									<td  align="right" colspan="8">&nbsp;</td>

									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>
									<td  align="right" >&nbsp;</td>

									</tr>

						</table>

					<?
				}
			}
		}


	
					?>
		
			<br>
				<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>



					<br/><br/>

					

			</div>
				<?php



		$lab_dip_color_arr=array();
		$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
		$style_name_arr=return_library_array( "select job_no, style_ref_no from wo_po_details_master", "job_no", "style_ref_no"  );
		foreach($lab_dip_color_sql as $row)
		{
			$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
		}



			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type,a.width_dia_type,a.gsm_weight,a.composition,a.construction,a.job_no,a.color_type_id
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order,e.body_part_type";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$style=$style_name_arr[$collar_cuff_row[csf('job_no')]];
				$comp=$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]];
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
				// $collar_cuff_data_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]['composition']=$comp;
				$collar_cuff_data_arr[$style][$collar_cuff_row[csf('item_number_id')]][$collar_cuff_row[csf('body_part_type')]][$comp][$collar_cuff_row[csf('color_type_id')]][$collar_cuff_row[csf('color_size_sensitive')]][$collar_cuff_row[csf('color_number_id')]]['color_break_down']=$collar_cuff_row[csf('color_break_down')];
				$collar_cuff_data_arr[$style][$collar_cuff_row[csf('item_number_id')]][$collar_cuff_row[csf('body_part_type')]][$comp][$collar_cuff_row[csf('color_type_id')]][$collar_cuff_row[csf('color_size_sensitive')]][$collar_cuff_row[csf('color_number_id')]]['job_no']=$collar_cuff_row[csf('job_no')];
				$collar_cuff_data_arr[$style][$collar_cuff_row[csf('item_number_id')]][$collar_cuff_row[csf('body_part_type')]][$comp][$collar_cuff_row[csf('color_type_id')]][$collar_cuff_row[csf('color_size_sensitive')]][$collar_cuff_row[csf('color_number_id')]]['body_part_full_name']=$collar_cuff_row[csf('body_part_full_name')];
			}
		
		unset($collar_cuff_sql_res);
		//$count_collar_cuff=count($collar_cuff_size_arr);
	    //  echo "<pre>";
		//  print_r($collar_cuff_data_arr) ;

		$order_plan_qty_arr=array();
		$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($txt_order_no_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
		foreach($color_wise_wo_sql_qnty as $row)
		{
			$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
			$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
		}
		unset($color_wise_wo_sql_qnty);

	

			if(count($collar_cuff_item_size_arr[40])>0){

				$count_collar_cuff=count($collar_cuff_size_arr[40]);
				$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
					<div width="100%" style="overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="100%" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
							<td colspan="8" align="center"><b>Collar Details(Collar)</b></td>
						</tr>
						<tr>
							<td width="100" rowspan="2">Style Name</td>
							<td width="100" rowspan="2">Gmts Item</td>
							<td width="100" rowspan="2">Body Part</td>
							<td width="100" rowspan="2">Actual Qty(Pcs)</td>
							<td width="100" rowspan="2">Collar Composition</td>
							<td width="100" rowspan="2">Color Type</td>
							<td width="100" rowspan="2">Combo</td>
							<td width="100" rowspan="2">Fabric Color</td>
								<?
								foreach($collar_cuff_size_arr[40]  as $size_number_id)
								{
									?>
									<td align="center" style="border:1px solid black" width="100"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
								}
								?>
							<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
							<td rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
						<tr>
							
							<?
							
							// foreach($collar_cuff_data_arr[40]  as $size_number_id=>$size_number)
							// {
							foreach($collar_cuff_item_size_arr[40]  as $size_number_id=>$size_number)
							{
								if(count($size_number)>0)
								{
									foreach($size_number  as $item_size=>$val)
									{
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									}
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
							}

							$pre_size_total_arr=array();

							foreach($collar_cuff_data_arr as $style_id=>$style_data){
								foreach($style_data as $item_id=>$item_data){
									foreach($item_data[40] as $desc_id=>$desc_data){
										foreach($desc_data as $colortype_id=>$color_size_sensitive_arr){							
									foreach($color_size_sensitive_arr as $pre_cost_id=>$pre_cost_data)
									{
										foreach($pre_cost_data as $color_number_id=>$val)
										{
											// foreach($color_number_data as $color_size_sensitive=>$color_break_down)
											// {










										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										$total_gmt_actual_qty=0;
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td><?=$style_id;?></td>
											<td><?=$garments_item[$item_id];?></td>
											<td><?=$val[('body_part_full_name')];?></td>
											<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$val[('job_no')]][$item_id][$color_number_id][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
											<td><?=$desc_id;?></td>
											<td><?=$color_type[$colortype_id];?></td>
											<td>
												<?
												if( $color_size_sensitive==3)
												{
													echo strtoupper ($constrast_color_arr[$color_number_id]) ;
													$lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
												}
												else
												{
													echo $color_library[$color_number_id];
													$lab_dip_color_id=$color_number_id;
												}
												?>
											</td>
											<td><?=$color_library[$color_number_id];;?></td>
											<?
											foreach($collar_cuff_size_arr[40] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
												
														// if($body_type==50) $plan_cut+=($order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'])*2;
														 $plan_cut+=$order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'];
													
													
													//$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

													$collar_ex_per=$collar_cuff_percent_arr[40][$color_number_id][$size_number_id];
													// echo $collar_ex_per.'=';

												
												if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; 

												// $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
												$tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
													$collerqty=($plan_cut+$colar_excess_per);

													//$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

													echo number_format($collerqty);
													$pre_size_total_arr[40][$size_number_id]+=$collerqty;
													$grand_size_total_arr[$size_number_id]+=$collerqty;
													
													$pre_color_total_collar+=$collerqty;
													$pre_color_total_collar_order_qnty+=$plan_cut;

													//$pre_grand_tot_collar_order_qty+=$plan_cut;
													?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar[40]+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty[40]+=$pre_color_total_collar_order_qnty;

										$grand_tot_collar+=$pre_color_total_collar;
										$grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
											}
										}
									}
								}
							}
						}
							?>
						</tr>
						<tr>
					
							<td colspan="8" width="100"> Total</td>
								<?
								foreach($pre_size_total_arr[40]  as $size_qty)
								{
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
								}
								?>
							<td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar[40]); ?></td>
							<td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar[40]-$pre_grand_tot_collar_order_qty[40])/$pre_grand_tot_collar_order_qty[40])*100,2); ?></td>
						</tr>
					</table>
					<?}?>
					<br>
					<br>
					<?php

				if(count($collar_cuff_item_size_arr[50])>0){

						


					?>
					<table width="100%" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
							<td colspan="8" align="center"><b>Cuff Details  (Cuff)  </b></td>
						</tr>
						<tr>
							<td width="100" rowspan="2">Style Name</td>
							<td width="100" rowspan="2">Gmts Item</td>
							<td width="100" rowspan="2">Body Part</td>
							<td width="100" rowspan="2">Actual Qty(Pcs)</td>
							<td width="100" rowspan="2">Collar Composition</td>
							<td width="100" rowspan="2">Color Type</td>
							<td width="100" rowspan="2">Combo</td>
							<td width="100" rowspan="2">Fabric Color</td>
								<?
								foreach($collar_cuff_size_arr[50]  as $size_number_id)
								{
									?>
									<td align="center" style="border:1px solid black" width="100"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
								}
								?>
							<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
							<td rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
						<tr>
							
							<?
							
							// foreach($collar_cuff_data_arr[40]  as $size_number_id=>$size_number)
							// {
							foreach($collar_cuff_item_size_arr[50]  as $size_number_id=>$size_number)
							{
								if(count($size_number)>0)
								{
									foreach($size_number  as $item_size=>$val)
									{
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									}
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
							}

							$pre_size_total_arr=array();

							foreach($collar_cuff_data_arr as $style_id=>$style_data){
								foreach($style_data as $item_id=>$item_data){
									foreach($item_data[50] as $desc_id=>$desc_data){
										foreach($desc_data as $colortype_id=>$color_size_sensitive_arr){							
									foreach($color_size_sensitive_arr as $pre_cost_id=>$pre_cost_data)
									{
										foreach($pre_cost_data as $color_number_id=>$val)
										{
											// foreach($color_number_data as $color_size_sensitive=>$color_break_down)
											// {




										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										$total_gmt_actual_qty=0;
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td><?=$style_id;?></td>
											<td><?=$garments_item[$item_id];?></td>
											<td><?=$val[('body_part_full_name')];?></td>
											<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$val[('job_no')]][$item_id][$color_number_id][50];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
											<td><?=$desc_id;?></td>
											<td><?=$color_type[$colortype_id];?></td>
											<td>
												<?
												if( $color_size_sensitive==3)
												{
													echo strtoupper ($constrast_color_arr[$color_number_id]) ;
													$lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
												}
												else
												{
													echo $color_library[$color_number_id];
													$lab_dip_color_id=$color_number_id;
												}
												?>
											</td>
											<td><?=$color_library[$color_number_id];;?></td>
											<?
											foreach($collar_cuff_size_arr[50] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
												
													 $plan_cut+=($order_plan_qty_arr[$item_id][$color_number_id][$size_number_id]['plan'])*2;
													
													
													
													//$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

													$collar_ex_per=$collar_cuff_percent_arr[50][$color_number_id][$size_number_id];
													// echo $collar_ex_per.'=';

												 if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; 
													
												// $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
												$tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
													$collerqty=($plan_cut+$colar_excess_per);

													//$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

													echo number_format($collerqty);
													$pre_size_total_arr[50][$size_number_id]+=$collerqty;
													$pre_color_total_collar+=$collerqty;
													$pre_color_total_collar_order_qnty+=$plan_cut;

													//$pre_grand_tot_collar_order_qty+=$plan_cut;
													?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar[50]+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty[50]+=$pre_color_total_collar_order_qnty;

										$grand_tot_collar+=$pre_color_total_collar;
										$grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
											}
										}
									}
								}
							}
						}
							?>
						</tr>
						<tr>
					
							<td colspan="8"> Total</td>
								<?
								foreach($pre_size_total_arr[50]  as $size_qty)
								{
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
								}
								?>
							<td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar[50]); ?></td>
							<td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty[50])/$pre_grand_tot_collar_order_qty[50])*100,2); ?></td>
						</tr>
						<?php
						}
						?>
						<!-- <tr>
								
								<td colspan="8">Grand Total</td>
									<?
									foreach($grand_size_total_arr  as $size_qty)
									{
										?>
										<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
										<?
									}
									?>
								<td style="border:1px solid black; text-align:center"><? echo number_format($grand_tot_collar); ?></td>
								<td align="center" style="border:1px solid black"><? echo number_format((($grand_tot_collar-$grand_tot_collar_order_qty)/$grand_tot_collar_order_qty)*100,2); ?></td>
						 </tr> -->
					</table>

				
				
					</div>
			
				<?
				
				
				?>



				<br>
				<?
		$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		$sql_stripe=("select c.id,c.job_no,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,c.uom as type_uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id,c.job_no,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,b.dia_width,c.uom order by c.job_no,c.id,d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row)
		{
		$style_ref_no=$job_data_arr['style_ref_no'][$row[csf('job_no')]];
		//echo $style_ref_no.'XXXX';
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no'][$row[csf('did')]]=$style_ref_no;
			if($row[csf('type_uom')]==12){
				$type_uom_arr[$row[csf('type_uom')]]='kg';
			}elseif($row[csf('type_uom')]==1){
				$type_uom_arr[$row[csf('type_uom')]]='pcs';
			}
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['type_uom']=$row[csf('type_uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['stripe_color']=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['measurement']=$row[csf('measurement')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['yarn_dyed']=$row[csf('yarn_dyed')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['uom']=$row[csf('uom')];
		
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['style_ref_no']=$style_ref_no;

			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no']=$style_ref_no;
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['type_uom']=$row[csf('type_uom')];
		}
	
	// print_r($type_uom_arr);

		foreach($type_uom_arr as $uom_id=>$uom_arr){
		?>
			

			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
       		 <caption> <strong style="float:left"> Stripe Details (<?=$uom_arr;?>)</strong></caption>
      

            <tr>
                <th width="30"> SL</th>
                <th width="100">Style</th>
				<th width="100">Body Part</th>
				<th width="100">Fab. Desc.</th>
                <th width="80">Gmts Color</th>
                <th width="70">Fabric Qty(<?=$uom_arr;?>)</th>
                <th width="70">Stripe Color</th>
                <th width="70">Stripe Measurement</th>
				<th  width="70">Stripe Uom</th>
                <th  width="70">Qty.(<?=$uom_arr;?>)</th>

				<th  width="70">Y/D Req.</th>
            </tr>
            <?
				$job_strip_color_rowspan=array();$fab_strip_color_rowspan=array();$color_strip_color_rowspan=array();
			  foreach($stripe_arr as $job_id=>$job_data)
			  {	 $job_row_span=0;
					 foreach($job_data as $body_id=>$body_data)
					 {
						   $fab_row_span=0;
						   foreach($body_data as $color_id=>$color_data)
						   {
								$color_row_span=0;
								foreach($color_data as $strip_color_id=>$color_val)
								{
									$job_row_span++;$fab_row_span++;$color_row_span++;

								}
								$job_strip_color_rowspan[$job_id]=$job_row_span;
								$fab_strip_color_rowspan[$job_id][$body_id]=$fab_row_span;
								$color_strip_color_rowspan[$job_id][$body_id][$color_id]=$color_row_span;
								$color_strip_color_qty_arr[$job_id][$body_id][$color_id]=$stripe_arr2[$job_id][$body_id][$color_id]['fabreqtotkg'];


						   }
					 }
			  }
			 // print_r($job_strip_color_rowspan);


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=$total_color_qty=0;$fab_data_array=array();
            foreach($stripe_arr as $job_id=>$job_data)	{
			 $job_span=1;
			 foreach($job_data as $body_id=>$body_data)    {
			  $fab_span=1;
			   foreach($body_data as $color_id=>$color_data)  {
			     $color_span=1;
				foreach($color_data as $strip_color_id=>$color_val)   {
					//$rowspan=count($color_val['stripe_color']);

					if($uom_id==$color_val['type_uom'])
					{
					?>
					<tr>
					<?

					if($job_span==1)
					{
					?>
                        <td align="center" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $i; ?></td>
                        <td align="center" title="<? echo $job_id;?>" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $color_val['style_ref_no']; ?></td>
						<?
					}
					if($fab_span==1)
					{
						?>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $body_part[$body_id]; ?></td>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $color_val['fabric_description']; ?></td>
						<?
					}
					if($color_span==1)
					{
					$color_qty= $color_strip_color_qty_arr[$job_id][$body_id][$color_id];//$color_val['fabreqtotkg'];
					$total_color_qty+=$color_qty;
					?>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo $color_name_arr[$color_id]; ?></td>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo number_format($color_qty,2); ?></td>
					<?
					}

						?>
						<td align="center"><?  echo  $color_name_arr[$strip_color_id]; ?></td>
						<td align="center"> <? echo  number_format($color_val['measurement'],2); ?></td>
						<td align="center"> <? echo  $unit_of_measurement[$color_val['uom']]; ?></td>
						<td align="center" title="Stripe Measurement/Tot Stripe Measurement*Fabric Qty(KG)"> <? echo  number_format($color_val['fabreqtotkg'],2); ?></td>

						<td align="center"> <? echo  $yes_no[$color_val['yarn_dyed']]; ?></td>
					</tr>
						<?
					
						$total_fabreqtotkg+=$color_val['fabreqtotkg'];

					$job_span++;$fab_span++;$color_span++;
					}
				  }
				}
				$i++;
			}
			}
			?>
        <tfoot>
        <tr>
            <td align="right" colspan="5">Total </td>
            <td align="center"><? echo  number_format($total_color_qty,2); ?> </td>
            <td></td>
            <td></td>

            <td> </td>
			 <td align="center"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
			<td> </td>
        </tr>
        </tfoot>
   </table>
   <?}?>
   <br/>
			<table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>
				</tr>
				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>
				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<!-- <table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table> -->
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>
									<td>
										<strong style="font-size:16px"> <? echo $row[csf('terms')]; ?></strong>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>
	<br/><br/><br/><br/>
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
	exit();
}
if ($action=="get_first_selected_print_report"){
	
	list($company_id,$mail_id)=explode('**',$data);
	
	$print_report_format=return_field_value("format_id","lib_report_template","template_name ='".$company_id."' and module_id=2 and report_id=1 and is_deleted=0 and status_active=1");
	$print_report_format_arr=explode(',',$print_report_format);
	$button_id=$print_report_format_arr[0];
		
	if($button_id==1)
	{
		echo "generate_fabric_report_gr('show_fabric_booking_report_gr',1,'".$mail_id."',1)";
	}
	if($button_id==2)
	{
		echo "generate_fabric_report('show_fabric_booking_report',1,'".$mail_id."',1)";
	}
	if($button_id==3)
	{
		echo "generate_fabric_report('show_fabric_booking_report3',1,'".$mail_id."',1)";
	}
	if($button_id==4)
	{
		echo "generate_fabric_report('show_fabric_booking_report1',1,'".$mail_id."',1)";
	}
	if($button_id==5)
	{
		echo "generate_fabric_report('show_fabric_booking_report2',1,'".$mail_id."',1)";
	}
	if($button_id==6)
	{
		echo "generate_fabric_report('show_fabric_booking_report4',1,'".$mail_id."',1)";
	}
	if($button_id==7)
	{
		echo "generate_fabric_report('show_fabric_booking_report5',1,'".$mail_id."',1)";
	}
	if($button_id==28)
	{
		echo "generate_fabric_report('show_fabric_booking_report_akh',1,'".$mail_id."',1)";
	}
	if($button_id==45)
	{
		echo "generate_fabric_report('show_fabric_booking_report_urmi',1,'".$mail_id."',1)";
	}
	if($button_id==53)
	{
		echo "generate_fabric_report('show_fabric_booking_report_jk',1,'".$mail_id."',1)";
	}
	if($button_id==432)
	{
		echo "generate_fabric_report('show_fabric_booking_report_fn',1,'".$mail_id."',1)";
	}
	if($button_id==73)
	{
		echo "generate_fabric_report('show_fabric_booking_report_mf',1,'".$mail_id."',1)";
	}
	if($button_id==84)
	{
		echo "generate_fabric_report('show_fabric_booking_report_islam',1,'".$mail_id."',1)";
	}
	if($button_id==93)
	{
		echo "generate_fabric_report('show_fabric_booking_report_libas',1,'".$mail_id."',1)";
	}
	if($button_id==129)
	{
		echo "generate_fabric_report('show_fabric_booking_report_print5',1,'".$mail_id."',1)";
	}
	if($button_id==193)
	{
		echo "generate_fabric_report('show_fabric_booking_report_print4',1,'".$mail_id."',1)";
	}
	if($button_id==269)
	{
		echo "generate_fabric_report('show_fabric_booking_report_knit',1,'".$mail_id."',1)" ;
	}
	if($button_id==280)
	{
		echo "generate_fabric_report('show_fabric_booking_report_print14',1,'".$mail_id."',1)";
	}
	if($button_id==39)
	{
		echo "generate_fabric_report('show_fabric_booking_report_print39',1,'".$mail_id."',1)";
	}
	if($button_id==304)
	{
		echo "generate_fabric_report('show_fabric_booking_report10',1,'".$mail_id."',1)";
	}
	if($button_id==719)
	{
		echo "generate_fabric_report('show_fabric_booking_report16',1,'".$mail_id."',1)";
	}
	if($button_id==723)
	{
		echo "generate_fabric_report('show_fabric_booking_report17',1,'".$mail_id."',1)";
	}
	if($button_id==339)
	{
		echo "generate_fabric_report('show_fabric_booking_report18',1,'".$mail_id."',1)";
	}
	if($button_id==370)
	{
		echo "generate_fabric_report('show_fabric_booking_report_print19',1,'".$mail_id."',1)";
	}
	if($button_id==383)
	{
		echo "generate_fabric_report('show_fabric_booking_report_print20',1,'".$mail_id."',1)";
	}
	if($button_id==404)
	{
		echo "generate_fabric_report('show_fabric_booking_report21',1,'".$mail_id."',1)";
	}
	if($button_id==786)
	{
		echo "generate_fabric_report('show_fabric_booking_report25',1,'".$mail_id."',1)";
	}
	exit();
}

if($action=="reorder_fabric_color")
{
	echo load_html_head_contents("Fabric Color Pop Up","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
	var permission='<? echo $permission; ?>';

	function fnc_color_reorder(operation)
	{
		freeze_window(operation);
		var row_num_color=$('#color_order tbody tr').length;
		var data_all_color="";
		for (var i=1; i<=row_num_color; i++)
		{
			if (form_validation('colorordering_'+i,'Color Ordering')==false)
			{
				release_freezing();
				return;
			}
			data_all_color=data_all_color+get_submitted_data_string('txt_booking_no*colorid_'+i+'*colorordering_'+i,"../../../",i);
		}
		

		var data="action=save_update_color_ordering&operation="+operation+'&total_row_color='+row_num_color+data_all_color;
		//alert(data); release_freezing(); return;
		
		http.open("POST","fabric_booking_urmi_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_color_reorder_reponse;
	}

	function fnc_color_reorder_reponse()
	{
		if(http.readyState == 4)
		{
			var reponse=http.responseText.split('**');
			if(reponse[0]==0)
			{
			alert('Data update is successfully');	
			parent.emailwindow.hide();
			}
			 
			release_freezing();
		}
	}
	</script>
	</head>
	<body onLoad="set_hotkey()">
	<div style="width:100%;" align="center">
        <input type="hidden" id="garments_nature" value="2">
        <div style="display:none"><?=load_freeze_divs ("../../../",$permission); ?></div>
        <div  style="font-size:18px; color:#33F">Fabric Color Ordering</div>
        <fieldset style="width:500px;">
            <form id="colororder_1">
            <input type="hidden" class="text_boxes_numeric" id="txt_booking_no" value="<?=$txt_booking_no; ?>" style="widows:60px"/>
                <table id="color_order" class="rpt_table" border="1" rules="all">
                    <thead>
                        <tr>
                            <th width="30">Sl</th>
                            <th width="150">Color</th>
                            <th>Color Ordering</th>
                        </tr>
                    </thead>
                    <tbody>
                    <? $sql_data=sql_select("select min(id) as id, fabric_color_id, min(color_order) as color_order from wo_booking_dtls where booking_no='$txt_booking_no' and status_active!=0 and is_deleted=0 group by fabric_color_id order by color_order");
                    $i=1;
                    foreach($sql_data as $sql_row)
                    {
                        ?>
                        <tr>
                            <td align="center"><?=$i; ?></td>
                            <td style="word-break:break-all"><?=$color_library[$sql_row[csf('fabric_color_id')]]; ?><input type="hidden" class="text_boxes_numeric" id="colorid_<?=$i; ?>" value="<?=$sql_row[csf('fabric_color_id')]; ?>" style="widows:60px"/></td>
                            <td><input type="text" class="text_boxes_numeric" id="colorordering_<?=$i; ?>" style="widows:60px" value="<?=$sql_row[csf('color_order')];  ?>"/></td>
                        </tr>
                        <?
                        $i++;
                    }
                    ?>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td align="center" colspan="3" class="button_container">
                                <?=load_submit_buttons( $permission, "fnc_color_reorder", 1,0 ,"",1); ?>
                            </td>
                        </tr>
                    </tfoot>
                </table>
                		
            </form>
        </fieldset>
    </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="save_update_color_ordering")
{
    $process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($operation==1)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		
		for ($i=1;$i<=$total_row_color; $i++)
		{
			$colorid="colorid_".$i;
			$colorordering="colorordering_".$i;
			$rID=execute_query("update wo_booking_dtls set color_order=".$$colorordering." where fabric_color_id =".$$colorid." and booking_no=".$txt_booking_no."",0);
		}
		 
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
?>