<?
header('Content-type:text/html; charset=utf-8');
session_start();
if( $_SESSION['logic_erp']['user_id'] == "" ) header("location:login.php");
include('../../../includes/common.php');
include('../../../includes/class4/class.conditions.php');
include('../../../includes/class4/class.reports.php');
include('../../../includes/class4/class.fabrics.php');
include('../../../includes/class4/class.yarns.php');
include('../../../includes/class4/class.conversions.php');
include('../../../includes/class4/class.trims.php');
include('../../../includes/class4/class.emblishments.php');
include('../../../includes/class4/class.washes.php');
include('../../../includes/class4/class.commercials.php');
include('../../../includes/class4/class.commisions.php');
include('../../../includes/class4/class.others.php');

if($_SESSION['app_notification'] == 1){
	include('../../../includes/class4/Notifications.php');
}

$data=$_REQUEST['data'];
$action=$_REQUEST['action'];
$type=$_REQUEST['type'];
$permission=$_SESSION['page_permission'];
$user_id=$_SESSION['logic_erp']['user_id'];
$israte_popup=2;
$is_component_app=1;

//----------------------------------------------------Start---------------------------------------------------------
//*************************************************Master Form Start************************************************
if($action=="save_post_session"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn']="";
	$_SESSION['logic_erp']['msmnt_breack_downn']="";
	$_SESSION['logic_erp']['marker_breack_down']="";
	$_SESSION['logic_erp']['cons_breck_downn']=$cons_breck_downn;
	$_SESSION['logic_erp']['msmnt_breack_downn']=$msmnt_breack_downn;
	$_SESSION['logic_erp']['marker_breack_down']=$marker_breack_down;
	echo 1;
	die;
}

if ($action=="load_drop_down_buyer"){
	echo create_drop_down( "cbo_buyer_name", 120, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "" );
	exit();
}

if ($action=="load_drop_down_agent"){
	echo create_drop_down( "cbo_agent", 120, "select a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$data' and a.id in (select buyer_id from lib_buyer_party_type where party_type in (20,21)) group by a.id, a.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Agent --", $selected, "" );
	exit();
}

if ($action=="check_variable_setting"){

	list($company,$job_no)=explode("**",$data);

	$copy_quotation=return_field_value("copy_quotation", "variable_order_tracking", "company_name=$company and variable_list=20 and status_active=1 and is_deleted=0");
	$cost_control_source=return_field_value("cost_control_source", "variable_order_tracking", "company_name=$company and variable_list=53 and status_active=1 and is_deleted=0");
	$publish_shipment_date=return_field_value("publish_shipment_date", "variable_order_tracking", "company_name=$company and variable_list=47 and status_active=1 and is_deleted=0");
	if($copy_quotation==1 && $cost_control_source==2 && $publish_shipment_date==2){
		$fabric_data=sql_select("select id from wo_pre_cost_fabric_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		if(count($fabric_data)==0){	$checkid="1";}else{	$checkid="0";}

		$trims_data=sql_select("select id from wo_pre_cost_trim_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		if(count($trims_data)==0){	$checkid =$checkid."_2";}else{	$checkid=$checkid."_0";	}

		$emble_data=sql_select("select id from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and emb_name!=3 and status_active=1 and is_deleted=0");
		if(count($emble_data)==0){	$checkid =$checkid."_3";}else{	$checkid=$checkid."_0"; }

		$wash_data=sql_select("select id from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and emb_name=3 and status_active=1 and is_deleted=0");
		if(count($wash_data)==0){	$checkid =$checkid."_4";}else{	$checkid=$checkid."_0"; }

		$commer_data=sql_select("select id from wo_pre_cost_comarci_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		if(count($commer_data)==0){	$checkid =$checkid."_5";}else{	$checkid=$checkid."_0";	}

		$commi_data=sql_select("select id from wo_pre_cost_commiss_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		if(count($commi_data)==0){	$checkid =$checkid."_6";}else{	$checkid=$checkid."_0"; }

		echo "document.getElementById('hidd_variableCheck_id').value = '".$checkid."';\n";
	}
	exit();
}
//check_supplier_country
if ($action=="check_supplier_country")
{
	$supp_country_data=sql_select("select country_id from lib_supplier where id='$data' and status_active=1 and is_deleted=0");
	//echo "select country_id from lib_supplier where id='$data' and status_active=1 and is_deleted=0";
	$country_id=$supp_country_data[0][csf('country_id')];
	if($country_id=="") $country_id=0;
	echo $country_id;
	exit();
}
if ($action=="cm_cost_predefined_method")
{
	$cm_cost_method=0; $cm_cost_editable=0; $compulsory =0;
	$cm_cost_sql=sql_select("select cm_cost_method, editable, cm_cost_compulsory from variable_order_tracking where company_name=$data and variable_list=22 and status_active=1 and is_deleted=0");
	if($cm_cost_sql[0][csf('cm_cost_method')]=="") $cm_cost_method=0; else $cm_cost_method=$cm_cost_sql[0][csf('cm_cost_method')];
	if($cm_cost_sql[0][csf('editable')]=="") $cm_cost_editable=0; else $cm_cost_editable=$cm_cost_sql[0][csf('editable')];
	if($cm_cost_sql[0][csf('cm_cost_compulsory')]=="") $compulsory=0; else $compulsory=$cm_cost_sql[0][csf('cm_cost_compulsory')];
	echo $cm_cost_method.'___'.$cm_cost_editable.'___'.$compulsory;
	exit();
}

function lib_variable_data($data)
{
	$copy_quotation=$cm_cost_method=$cm_cost_editable=$compulsory=$is_manual_app=$currier_cost_per_percent=$budget_exceeds_quot=$cost_control_source=$trim_rate_source=0;
	//$cm_cost_method=return_field_value("cm_cost_method", "variable_order_tracking", "company_name=$data  and variable_list=22 and status_active=1 and is_deleted=0");
	$cm_cost_sql=sql_select("select variable_list, copy_quotation, commercial_cost_percent, cm_cost_method, editable, budget_exceeds_quot, cm_cost_compulsory, cost_control_source, pre_cost_approval, trim_rate, tna_integrated as buyer_id, profit_calculative as brand_id from variable_order_tracking where company_name=$data  and variable_list in (20,22,37,41,53,57,35) and status_active=1 and is_deleted=0");
	foreach($cm_cost_sql as $row)
	{
		if($row[csf('variable_list')]==20)
		{
			if($row[csf('copy_quotation')]=="") $copy_quotation=0; else $copy_quotation=$row[csf('copy_quotation')];
		}
		else if($row[csf('variable_list')]==22)
		{
			if($row[csf('cm_cost_method')]=="") $cm_cost_method=0; else $cm_cost_method=$row[csf('cm_cost_method')];
			if($row[csf('editable')]=="") $cm_cost_editable=0; else $cm_cost_editable=$row[csf('editable')];
			if($row[csf('cm_cost_compulsory')]=="") $compulsory=0; else $compulsory=$row[csf('cm_cost_compulsory')];
		}
		else if($row[csf('variable_list')]==37)
		{
			if($row[csf('budget_exceeds_quot')]=="") $budget_exceeds_quot=0; else $budget_exceeds_quot=$row[csf('budget_exceeds_quot')];
		}
		else if($row[csf('variable_list')]==41)
		{
			if($row[csf('pre_cost_approval')]=="") $is_manual_app=0; else $is_manual_app=$row[csf('pre_cost_approval')];
		}
		else if($row[csf('variable_list')]==53)
		{
			if($row[csf('cost_control_source')]=="") $cost_control_source=0; else $cost_control_source=$row[csf('cost_control_source')];
		}
		else if($row[csf('variable_list')]==57)
		{
			if($row[csf('cm_cost_compulsory')]=="") $currier_cost_per_percent=0; else $currier_cost_per_percent=$row[csf('commercial_cost_percent')];
		}
		else if($row[csf('variable_list')]==35)
		{
			if($row[csf('trim_rate')]=="") $trim_rate_source=0; else $trim_rate_source=$row[csf('trim_rate')];
		}
	}
	return $cm_cost_method.'___'.$cm_cost_editable.'___'.$compulsory.'___'.$currier_cost_per_percent.'___'.$is_manual_app.'___'.$copy_quotation.'___'.$budget_exceeds_quot.'___'.$cost_control_source.'___'.$trim_rate_source;
	exit();
}

if($action=="check_conversion_rate")
{
	$data=explode("**",$data);
	if($db_type==0) $conversion_date=change_date_format($data[1], "Y-m-d", "-",1);
	else $conversion_date=change_date_format($data[1], "d-M-y", "-",1);

	$currency_rate=set_conversion_rate( $data[0], $conversion_date,$data[2] );
	echo "1"."_".$currency_rate;
	exit();
}

function buyer_profit_deffd_lc_per($buyer){
	$sql=sql_select("select deffd_lc_cost_percent, min_budgeted_profit_parcent from lib_buyer where id='$buyer'");
	$deffd_lc_cost_percent=$sql[0][csf('deffd_lc_cost_percent')];
	$buyer_profit_percent=$sql[0][csf('min_budgeted_profit_parcent')];
	return $deffd_lc_cost_percent.'_'.$buyer_profit_percent;
}

function get_job_data($company,$job){
	$data_array=sql_select("select a.order_repeat_no, a.total_set_qnty, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty  from wo_po_details_master a,wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and  a.job_no='$job' and a.company_name=$company  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.order_repeat_no,a.total_set_qnty");
	$job_data=array();
	foreach($data_array as $row){
		$order_repeat_no=$row[csf('order_repeat_no')];
		$total_set_qnty=$row[csf('total_set_qnty')];
		$order_quantity=$row[csf('order_quantity')];
		$plan_cut_qnty=$row[csf('plan_cut_qnty')];

		$order_quantity_set=$order_quantity/$total_set_qnty;
		$plan_cut_qnty_set=$plan_cut_qnty/$total_set_qnty;

		$job_data['order_quantity_set']=$order_quantity_set;
		$job_data['plan_cut_qnty_set']=$plan_cut_qnty_set;
		$job_data['order_quantity']=$order_quantity;
		$job_data['plan_cut_qnty']=$plan_cut_qnty;
		$job_data['order_repeat_no']=$order_repeat_no;
	}
	unset($data_array);
	return $job_data;
}

function get_efficiency_percent($company,$job,$smv)
{
	$efficiency_source=return_field_value("efficiency_source_for_pre_cost", "variable_order_tracking", "company_name=$company and variable_list=54 and status_active=1 and is_deleted=0");
	//$efficiency_source=get_efficiency_source($company);
	if($efficiency_source== "" || $efficiency_source==0) $efficiency_source=1; else $efficiency_source=$efficiency_source;

	if($efficiency_source!=1) $job_data=get_job_data($company,$job);

	if($efficiency_source==1) $efficiency_percent=0;
	if($efficiency_source==2) $efficiency_percent=get_efficiency_percent_from_work_study($company,$job);
	if($efficiency_source==3) $efficiency_percent=get_efficiency_percent_from_slab($company,$job_data['order_repeat_no'],$job_data['order_quantity_set'],$smv);
	return array("efficiency_source"=>$efficiency_source,"efficiency_percent"=>$efficiency_percent);
	exit();
}

function get_efficiency_percent_from_slab($company,$order_repeat_no,$order_quantity,$smv)
{
	$efficiency_percent=0;
	$sql=sql_select("select efficiency_new_order, efficiency_repeat_order from efficiency_percentage_slab where ($smv between smv_lower_limit and  smv_upper_limit) and ($order_quantity between order_qty_lower_limit and order_qty_upper_limit) and company_id=$company and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		if($order_repeat_no) $efficiency_percent=$row[csf('efficiency_repeat_order')];
		else $efficiency_percent=$row[csf('efficiency_new_order')];
	}
	return $efficiency_percent;
	exit();
}

function get_efficiency_percent_from_work_study($company,$jobno){
	$sqlwsid=sql_select("select ws_id from wo_po_details_mas_set_details where job_no='$jobno'");
	$wsidstr="";
	foreach($sqlwsid as $jrow){
		if($jrow[csf('ws_id')]=="") $jrow[csf('ws_id')]=0;
		if($jrow[csf('ws_id')]!=0)
		{
			if($wsidstr=="") $wsidstr=$jrow[csf('ws_id')]; else $wsidstr.=','.$jrow[csf('ws_id')];
		}
	}
	unset($sqlwsid);

	$eff_percentws=0;
	if($wsidstr!="")
	{
		$sql=sql_select("select id, efficiency from ppl_balancing_mst_entry where gsd_mst_id in ($wsidstr) and status_active=1 and is_deleted=0");
		$countwseff=count($sql); $efficiency_percent=0;
		foreach($sql as $row){
			$efficiency_percent+=$row[csf('efficiency')];
		}
		if($countwseff==1) $eff_percentws=$efficiency_percent; else if($countwseff>1) $eff_percentws=fn_number_format($efficiency_percent/$countwseff,2); else $eff_percentws=0;
	}

	return $eff_percentws;
	exit();
}

if($action=="get_efficiency_percent"){
	$data=explode("**",$data);
	$efficiency_data=get_efficiency_percent($data[0],$data[1],$data[2]);
	echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
}

if ($action=="cost_per_minute")
{
	$data=explode("_",$data);
	$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$data[0]  and variable_list=22 and status_active=1 and is_deleted=0");
	if($cm_cost_method_based_on=="") $cm_cost_method_based_on=1;
	$location_cpm_cost=0;
	$sql_data=sql_select("select yarn_iss_with_serv_app from variable_order_tracking where company_name='$data[0]' and variable_list=67 and status_active=1 and is_deleted=0");
	foreach($sql_data as $sql_row)
	{
		$location_cpm_cost=$sql_row[csf('yarn_iss_with_serv_app')];
	}
	//echo $location_cpm_cost;
	$job_location_id=0;
	if($location_cpm_cost==1)
	{
		$job_location_id=return_field_value("location_name", "wo_po_details_master", "company_name=$data[0] and job_no='$data[2]' and status_active=1 and is_deleted=0");
	}
	//echo $location_cpm_cost.'===='.$job_location_name;die;

	$txt_costing_date="";
	if($cm_cost_method_based_on==1){
		if($data[1]=="" || $data[1]==0)
		{
			if($db_type==0) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-");
			if($db_type==2) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
		}
		else
		{
			if($db_type==0) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
			if($db_type==2) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
		}
	}
	else if($cm_cost_method_based_on==2){
		$min_shipment_sql=sql_select("select job_no_mst, min(shipment_date) as min_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_shipment_date="";
		foreach($min_shipment_sql as $row){
			$min_shipment_date=$row[csf('min_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==3){
		$max_shipment_sql=sql_select("select job_no_mst, max(shipment_date) as max_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_shipment_date=$row[csf('max_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==4){

		$max_shipment_sql=sql_select("select job_no_mst, min(pub_shipment_date) as min_pub_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$min_pub_shipment_date=$row[csf('min_pub_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==4){
		$max_shipment_sql=sql_select("select job_no_mst, max(pub_shipment_date) as max_pub_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_pub_shipment_date=$row[csf('max_pub_shipment_date')];
		}

		if($db_type==0)  $txt_costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}

	$monthly_cm_expense=0; $no_factory_machine=0; $working_hour=0; $cost_per_minute=0; $depreciation_amorti=0; $operating_expn=0; $interest_expense=0; $income_tax=0;
	if($db_type==0) $limit_cond="LIMIT 1"; else if($db_type==2) $limit_cond="";

	if($data[1]=="" || $data[1]==0)
	{
		if($db_type==0) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
	}
	else
	{
		if($db_type==0) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
	}
	if($location_cpm_cost==1)//Location Wse variable Yes
	{
		$sql="select a.depreciation_amorti, a.operating_expn, a.interest_expense, a.income_tax, b.monthly_cm_expense, b.no_factory_machine, b.working_hour, b.cost_per_minute from lib_standard_cm_entry a,lib_standard_cm_entry_dtls b where a.id=b.mst_id and a.company_id=$data[0] and b.location_id=$job_location_id and '$txt_costing_date' between b.applying_period_date and b.applying_period_to_date  and b.status_active=1 and b.is_deleted=0 $limit_cond";
	}
	else
	{
		$sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
	}
	$data_array=sql_select($sql);
	foreach ($data_array as $row)
	{
		if($row[csf("monthly_cm_expense")] !="") $monthly_cm_expense=$row[csf("monthly_cm_expense")];
		if($row[csf("no_factory_machine")] !="") $no_factory_machine=$row[csf("no_factory_machine")];
		if($row[csf("working_hour")] !="") $working_hour=$row[csf("working_hour")];
		if($row[csf("cost_per_minute")] !="") $cost_per_minute=$row[csf("cost_per_minute")];
		if($row[csf("depreciation_amorti")] !="") $depreciation_amorti=$row[csf("depreciation_amorti")];
		if($row[csf("operating_expn")] !="") $operating_expn=$row[csf("operating_expn")];
		if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
		if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
	}
	$data=$monthly_cm_expense."_".$no_factory_machine."_".$working_hour."_".$cost_per_minute."_".$depreciation_amorti."_".$operating_expn."_".$interest_expense."_".$income_tax;
	echo $data;
	exit();
}

if ($action=="order_popup")
{
  	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	//echo "DDDDDDDDDDDDD";die;
	?>
	<script>
		function set_checkvalue()
		{
			if(document.getElementById('chk_job_wo_po').value==0) document.getElementById('chk_job_wo_po').value=1;
			else document.getElementById('chk_job_wo_po').value=0;
		}

		function js_set_value( job_no )
		{
			var job_arr=job_no.split("_");
			if(job_arr[1]==111){
				alert('This Job is in Pre-cost V1');
				return;
			}
			else if(job_arr[1]==520){
				alert('This Job is in Pre-cost V3');
				return;
			}
			else{
				document.getElementById('selected_job').value=job_arr[0];
				parent.emailwindow.hide();
			}

		}
    </script>
    </head>
    <body>
    <div align="center" style="width:100%;" >
    <form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
        <table width="1080" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center" rules="all">
            <thead>
                <tr>
                 <th width="150" colspan="4"> </th>
                    <th><? echo create_drop_down( "cbo_string_search_type", 100, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
                  <th width="150" colspan="4"> </th>
                </tr>
                <tr>
                    <th width="150" class="must_entry_caption">Company Name</th>
                    <th width="120">Buyer Name</th>
                    <th width="80">Job No</th>
                    <th width="100">Style Ref </th>
                    <th width="100">Internal Ref </th>
                    <th width="100">File No </th>
                    <th width="100">Order No</th>
                    <th width="160">Date Range</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
            <tr class="general">
                <td> <input type="hidden" id="selected_job">
                    <? echo create_drop_down( "cbo_company_mst", 150, "select id,company_name from lib_company comp where status_active =1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name","id,company_name",1, "-- Select Company --", '',"load_drop_down( 'pre_cost_entry_controller_v2', this.value, 'load_drop_down_buyer', 'buyer_td' );" ); ?></td>
                <td id="buyer_td"><? echo create_drop_down( "cbo_buyer_name", 120, $blank_array,'', 1, "-- Select Buyer --" ); ?></td>
                <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:70px"></td>
                <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:90px"></td>
                <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:90px"></td>
                <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:90px"></td>
                <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:90px"></td>
                <td>
                    <input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px">
                    <input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px">
                </td>
                <td align="center">
                    <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value, 'create_po_search_list_view', 'search_div', 'pre_cost_entry_controller_v2', 'setFilterGrid(\'list_view\',-1)')" style="width:100px;" /></td>
            </tr>
            <tr>
                <td align="center" valign="middle" colspan="9">
                    <?=load_month_buttons(1); ?>
                </td>
            </tr>
     </table>
     <div id="search_div"></div>
        </form>
       </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="create_po_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company=" and a.company_name='$data[0]'"; else { echo "Please Select Company First."; die; }
	if ($data[1]!=0){ $buyer=" and a.buyer_name='$data[1]'"; }
	else
	{
		$buyer=""; $bu_arr=array();
		$pri_buyer=sql_select("select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data[0]' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name");
		foreach($pri_buyer as $pri_buyer_row)
		{
			$bu_arr[$pri_buyer_row[csf('id')]]=$pri_buyer_row[csf('id')];
		}
		$bu_arr_str=implode(",",$bu_arr);
		$buyer=" and a.buyer_name in ($bu_arr_str)";
	}
	$job_cond=""; $order_cond=""; $style_cond="";
	if($data[8]==1)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number = '$data[6]'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no ='$data[7]'"; //else  $style_cond="";
	}
	else if($data[8]==2)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '$data[4]%'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '$data[6]%'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '$data[7]%'  "; //else  $style_cond="";
	}
	else if($data[8]==3)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '%$data[6]'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '%$data[7]'"; //else  $style_cond="";
	}
	else if($data[8]==4 || $data[8]==0)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]%'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '%$data[6]%'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '%$data[7]%'"; //else  $style_cond="";
	}

	$internal_ref = str_replace("'","",$data[9]);
	$file_no = str_replace("'","",$data[10]);
	if($file_no=="") $file_no_cond=""; else $file_no_cond=" and b.file_no='".trim($file_no)."' ";
	if($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and b.grouping='".trim($internal_ref)."' ";

	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $shipment_date ="";
		$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$data[5]";
		$insert_year="YEAR(a.insert_date)";
	}
	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $shipment_date ="";
		$year_cond=" and to_char(a.insert_date,'YYYY')=$data[5]";
		$insert_year="to_char(a.insert_date,'YYYY')";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');


	/*$quotation_status_arr=array(); $approval_necessity_setup=0;
	$sql_cost_control_source=sql_select("select cost_control_source from variable_order_tracking where company_name='$data[0]' and variable_list=53 and status_active=1 and is_deleted=0");
	list($cost_control_source)= $sql_cost_control_source;
	$cost_control_source_id=$cost_control_source[csf('cost_control_source')];
	$variable_copy_quotation_check=return_field_value("copy_quotation","variable_order_tracking","company_name='$data[0]' and variable_list=20 and status_active=1 and is_deleted=0 ","copy_quotation");
	if($cost_control_source_id==1) $page_idCond="and b.page_id=28"; else if($cost_control_source_id==2) $page_idCond="and b.page_id=1";
	if($variable_copy_quotation_check==1)
	{
		$approval_necessity_setup=return_field_value("approval_need","approval_setup_mst a, approval_setup_dtls b","a.id=b.mst_id and a.company_id='$data[0]' and a.status_active=1 and a.is_deleted=0 $page_idCond order by a.setup_date desc","approval_need");
		if($approval_necessity_setup==1)
		{
			if($cost_control_source_id==2) $quotation_status_arr=return_library_array( "select id, approved from wo_price_quotation",'id','approved');
			else if($cost_control_source_id==1) $quotation_status_arr=return_library_array( "select cost_sheet_id, approved from qc_confirm_mst",'cost_sheet_id','approved');
		}
	}*/

	$quotation_status_arr=array(); $approval_necessity_setup=0;
	/*$sql_cost_control_source=sql_select("select cost_control_source from variable_order_tracking where company_name='$data[0]' and variable_list=53 and status_active=1 and is_deleted=0");
	list($cost_control_source)= $sql_cost_control_source;
	$cost_control_source_id=$cost_control_source[csf('cost_control_source')];*/
	$variable_copy_quotation_check=return_field_value("copy_quotation","variable_order_tracking","company_name='$data[0]' and variable_list=20 and status_active=1 and is_deleted=0 ","copy_quotation");
	if($variable_copy_quotation_check==1)
	{
		$approval_necessity_setup=return_field_value("approval_need","approval_setup_mst a, approval_setup_dtls b","a.id=b.mst_id and a.company_id='$data[0]' and b.page_id=1 and a.status_active=1 and a.is_deleted=0 order by a.setup_date desc","approval_need");
		if($approval_necessity_setup==1)
		{
			$quotation_status_arr=return_library_array( "select id, approved from wo_price_quotation where status_active=1",'id','approved');
		}
	}
	$pre_Cost_approv_status = array(0 =>'No',1=>'Yes',2=>'No',3=>'Yes');
	$sql= "SELECT $insert_year as year,a.quotation_id, a.job_no_prefix_num, a.company_name, a.buyer_name, a.style_ref_no, a.job_quantity, b.po_number, b.grouping,b.file_no, b.po_quantity, b.shipment_date, a.job_no, c.approved,c.id as pre_id, c.entry_from from wo_po_details_master a join  wo_po_break_down b on a.id=b.job_id left join wo_pre_cost_mst c on a.id=c.job_id and c.status_active=1 and c.is_deleted=0 where a.garments_nature=2  and a.status_active=1 and b.status_active=1  $shipment_date $company $buyer $job_cond $style_cond $order_cond $file_no_cond $internal_ref_cond $year_cond order by a.id DESC";
	//echo $sql;
	$result=sql_select($sql);
	?>
 	<div align="left" style=" margin-left:5px;margin-top:10px">
    	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1130" align="left" class="rpt_table" >
 			<thead>
 				<th width="30">SL</th>
 				<th width="50">Year</th>
 				<th width="50">Job No</th>
 				<th width="120">Company</th>
 				<th width="100">Buyer Name</th>
                <th width="100">Style Ref. No</th>
 				<th width="100">Internal Ref</th>
 				<th width="100">File No</th>
 				<th width="80">Job Qty.</th>
 				<th width="100">PO Number</th>
                <th width="80">PO Qty.</th>
 				<th width="70">Shipment Date</th>
                <th width="70">Approve Status</th>
 				<th>Precost id</th>
 			</thead>
 		</table>
    	<div style="width:1150px; max-height:270px; overflow-y:scroll" id="container_batch" >
 			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1130" class="rpt_table" id="list_view">
 				<?
 				$i=1;
 				foreach ($result as $row)
 				{
 					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$status=1;
					if($approval_necessity_setup==1)
					{
						if($row[csf('quotation_id')]>0) $status=$quotation_status_arr[$row[csf('quotation_id')]];
					}
					if($row[csf('pre_id')]=="") $row[csf('entry_from')]=158;

					if($status==1)
					{
						if($row[csf('entry_from')]==158)
						{
							?>
							<tr bgcolor="<?=$bgcolor; ?>" style="cursor:pointer" onClick="js_set_value('<?=$row[csf('job_no')].'_'.$row[csf('entry_from')]; ?>');">
								<td width="30"><?=$i; ?>  </td>
								<td width="50" style="word-break:break-all" align="center"><?=$row[csf('year')]; ?></td>
								<td width="50" style="word-break:break-all"><?=$row[csf('job_no_prefix_num')]; ?></td>
								<td width="120" style="word-break:break-all"><?=$comp[$row[csf('company_name')]]; ?></td>
								<td width="100" style="word-break:break-all"><?=$buyer_arr[$row[csf('buyer_name')]]; ?></td>
								<td width="100" style="word-break:break-all"><?=$row[csf('style_ref_no')]; ?></td>
								<td width="100" style="word-break:break-all"><?=$row[csf('grouping')]; ?></td>
								<td width="100" style="word-break:break-all"><?=$row[csf('file_no')]; ?></td>
								<td width="80" style="word-break:break-all" align="right"><?=$row[csf('job_quantity')]; ?></td>
								<td width="100" style="word-break:break-all"><?=$row[csf('po_number')]; ?></td>
								<td width="80" style="word-break:break-all" align="right"><?=$row[csf('po_quantity')]; ?></td>
								<td width="70" style="word-break:break-all"><?=change_date_format($row[csf('shipment_date')]); ?></td>
								<td width="70" style="word-break:break-all"><?=$pre_Cost_approv_status[$row[csf('approved')]]; ?></td>
								<td style="word-break:break-all"><?=$row[csf('pre_id')]; ?></td>
							</tr>
							<?
							$i++;
						}
					}
 				}
 				?>
 			</table>
 		</div>
 	</div>
    <?php
	exit();
}

function cost_per_minute($data)
{
	global $db_type;
	$data=explode("_",$data);
	if($data[1]=="" || $data[1]==0)
	{
		if($db_type==0) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
	}
	else
	{
		if($db_type==0) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
	}

	$monthly_cm_expense=$no_factory_machine=$working_hour=$cost_per_minute=$depreciation_amorti=$operating_expn=$interest_expense=$income_tax=0;

	if($db_type==0)
	{
		 $sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1";
	}
	else if($db_type==2)
	{
		 $sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
	}

	$data_array=sql_select($sql);
	foreach ($data_array as $row)
	{
		if($row[csf("monthly_cm_expense")] !="") $monthly_cm_expense=$row[csf("monthly_cm_expense")];
		if($row[csf("no_factory_machine")] !="") $no_factory_machine=$row[csf("no_factory_machine")];
		if($row[csf("working_hour")] !="") $working_hour=$row[csf("working_hour")];
		if($row[csf("cost_per_minute")] !="") $cost_per_minute=$row[csf("cost_per_minute")];
		if($row[csf("depreciation_amorti")] !="") $depreciation_amorti=$row[csf("depreciation_amorti")];
		if($row[csf("operating_expn")] !="") $operating_expn=$row[csf("operating_expn")];
		if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
		if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
	}
	unset($data_array);
	$data=$monthly_cm_expense."_".$no_factory_machine."_".$working_hour."_".$cost_per_minute."_".$depreciation_amorti."_".$operating_expn."_".$interest_expense."_".$income_tax;
	return  $data;
	exit();
}

if ($action=="populate_data_from_job_table")
{
	//$entry_from=0;
	//$data_entry_from=sql_select("select id,entry_from from wo_pre_cost_mst where job_no='$data' and is_deleted=0 and status_active=1");
	
	$company_name=""; $copy_quotation_id=""; $quotation_id=''; $avg_unit_price=''; $price_costing_per='';

	if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping, listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no ";
	else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

	$job_data_arr=array(); $set_ratio=0;
	$data_array=sql_select("select a.job_no, a.total_set_qnty, $group_concat_all from wo_po_details_master a, wo_po_break_down b where a.job_no='$data' and a.id=b.job_id and b.status_active=1 and a.status_active=1 group by a.job_no, a.total_set_qnty");
	foreach($data_array as $row)
	{
		$job_data_arr[$row[csf('job_no')]]['file']=$row[csf('file_no')];
		$job_data_arr[$row[csf('job_no')]]['ref']=$row[csf('grouping')];
		$set_ratio=$row[csf('total_set_qnty')];
	}
	unset($data_array);

	$component_approved_lab=$component_approved_ins=$component_approved_friegt=$component_approved_currier=$component_approved_certificate=$component_approved_others=0;
	$sql=sql_select("select cost_component_id, current_approval_status as approved from co_com_pre_costing_approval where cost_component_id in (7,8,9,10,11,12) and job_no='$data'");
	foreach($sql as $row){
		$approved=$row[csf('approved')];
		if($approved==3){
			$approved=1;
		}
		if($row[csf('cost_component_id')]==7 && $approved==1) $component_approved_lab=1;
		else if($row[csf('cost_component_id')]==8 && $approved==1) $component_approved_ins=1;
		else if($row[csf('cost_component_id')]==9 && $approved==1) $component_approved_friegt=1;
		else if($row[csf('cost_component_id')]==10 && $approved==1) $component_approved_currier =1;
		else if($row[csf('cost_component_id')]==11 && $approved==1) $component_approved_certificate =1;
		else if($row[csf('cost_component_id')]==12 && $approved==1) $component_approved_others=1;
	}

	$data_array=sql_select("select id, garments_nature, job_no, job_no_prefix, job_no_prefix_num, copy_from, company_name, buyer_name, location_name, style_ref_no, style_description, product_dept, product_code, currency_id, agent_name, order_repeat_no, region, team_leader, dealing_marchant, packing,remarks, job_quantity, avg_unit_price, ship_mode, order_uom, set_break_down, gmts_item_id, total_set_qnty, set_smv, quotation_id from wo_po_details_master where job_no='$data' and is_deleted=0 and status_active=1");
	foreach ($data_array as $row)
	{
		$var_dia_width_type=2; 
		$job_location_id=$row[csf('location_name')];
		$var_dia_width_type=return_field_value("style_from_library","variable_order_tracking","company_name ='".$row[csf("company_name")]."'  and status_active=1  and variable_list=80 ");
		$var_aop_type=return_field_value("conversion_from_chart","variable_order_tracking","company_name ='".$row[csf("company_name")]."' and rate_type=25 and status_active=1  and variable_list=21 ");
		if($var_aop_type=="") $var_aop_type=2;

		echo "reset_form('quotationdtls_2','','');\n";

		$cbo_buyer_name= create_drop_down( "cbo_buyer_name", 120, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='".$row[csf("company_name")]."' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "" );
		$cbo_agent= create_drop_down( "cbo_agent", 120, "select a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='".$row[csf("company_name")]."' and a.id in (select buyer_id from lib_buyer_party_type where party_type in (20,21)) order by buyer_name","id,buyer_name", 1, "-- Select Agent --", $selected, "" );

		$company_id=$row[csf("company_name")];
		$cost_per_minute=cost_per_minute($row[csf("company_name")]."_".date("d-m-Y"));

		$buyer_profit_deffd_lc_per=buyer_profit_deffd_lc_per($row[csf("buyer_name")]);
		$exbuyer_profit_deffd_lc_per=explode("_",$buyer_profit_deffd_lc_per);
		$deffd_lc_per=$exbuyer_profit_deffd_lc_per[0];
		$buyer_profit_per=$exbuyer_profit_deffd_lc_per[1];//buyer_profit_per($row[csf("buyer_name")]);

		//$currier_cost_per=currier_cost_per($row[csf("company_name")]);

		$cm_cost_predefined_method=$cm_cost_editable=$currier_cost_per=$is_manula_approved=$copy_quotation_id=$budget_exceeds_quot_id=$cost_control_source_id=0;
		$lib_variable_data=lib_variable_data($row[csf("company_name")]);
		//echo $lib_variable_data;
		$cm_cost_predefined_data=explode("___",$lib_variable_data);

		$cm_cost_predefined_method=$cm_cost_predefined_data[0];
		$cm_cost_editable=$cm_cost_predefined_data[1];
		$currier_cost_per=$cm_cost_predefined_data[3];

		$currier_cm_cost_data=$cm_cost_predefined_method.'___'.$cm_cost_editable.'___'.$cm_cost_predefined_data[2];

		$is_manula_approved=$cm_cost_predefined_data[4];
		$copy_quotation_id=$cm_cost_predefined_data[5];
		$budget_exceeds_quot_id=$cm_cost_predefined_data[6];
		$cost_control_source_id=$cm_cost_predefined_data[7];
		$trim_rate_source_id=$cm_cost_predefined_data[8];
		if($cm_cost_editable==1)
		{
			echo "$('#txt_cm_pre_cost').attr('disabled',false);\n";
		}
		else
		{
			echo "$('#txt_cm_pre_cost').attr('disabled',true);\n";
		}
		//==========user wise print button======

		$print_report_format = set_print_button(['COMPANY_ID'=>$company_id,'MODULE_ID'=>2,'REPORT_ID'=>43,'USER_ID'=>$user_id]);
		echo "print_report_button_setting('".$print_report_format."');\n";


		echo "document.getElementById('var_conv_aop_chart_id').value = '".$var_aop_type."';\n";
		echo "document.getElementById('var_mandatory_id').value = '".$var_dia_width_type."';\n";
		echo "document.getElementById('cost_per_minute').value = '".$cost_per_minute."';\n";

		$excostper_minute=explode("_",$cost_per_minute);

		echo "$('#txtoptexpper').val('".$excostper_minute[5]."');\n";
		echo "$('#txtinterestper').val('".$excostper_minute[6]."');\n";
		echo "$('#txtincometexper').val('".$excostper_minute[7]."');\n";
		echo "$('#txtdepramortper').val('".$excostper_minute[4]."');\n";

		echo "document.getElementById('txt_deffd_lc_cost_percent').value = '".$deffd_lc_per."';\n";
		echo "document.getElementById('txt_deffdlc_po_price').value = '".$deffd_lc_per."';\n";
		echo "document.getElementById('txt_currier_po_price').value = '".$currier_cost_per."';\n";

		echo "$('#txt_margin_dzn_po_price').attr('buyer_profit_per','".$buyer_profit_per."');\n";
		echo "$('#cm_cost_predefined_method_id').attr('lib_variable_data','".$currier_cm_cost_data."');\n";

		echo "document.getElementById('buyer_td').innerHTML = '".$cbo_buyer_name."';\n";
		echo "document.getElementById('agent_td').innerHTML = '".$cbo_agent."';\n";

		echo "change_caption_cost_dtls('".$row[csf("order_uom")]."','change_caption_pcs')\n";
		echo "document.getElementById('txt_job_no').value = '".$row[csf("job_no")]."';\n";
		echo "document.getElementById('hidd_job_id').value = '".$row[csf("id")]."';\n";
		echo "document.getElementById('txt_copy_form').value = '".$row[csf("copy_from")]."';\n";

		$grouping=implode(",",array_unique(explode(",",$job_data_arr[$row[csf('job_no')]]['ref'])));
		$file_no=implode(",",array_unique(explode(",",$job_data_arr[$row[csf('job_no')]]['file'])));
		echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";
		echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";

		echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_name")]."';\n";
		echo "$('#cbo_company_name').change();\n";

		echo "document.getElementById('txt_quotation_id').value = '".$row[csf("quotation_id")]."';\n";
		echo "document.getElementById('txt_style_ref').value = '".$row[csf("style_ref_no")]."';\n";
		echo "document.getElementById('txt_style_desc').value = '".$row[csf("style_description")]."';\n";
		echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_name")]."';\n";
		echo "document.getElementById('cbo_pord_dept').value = '".$row[csf("product_dept")]."';\n";
		echo "document.getElementById('txt_product_code').value = '".$row[csf("product_code")]."';\n";
		echo "document.getElementById('cbo_currercy').value = '".$row[csf("currency_id")]."';\n";
		echo "document.getElementById('cbo_agent').value = '".$row[csf("agent_name")]."';\n";
		echo "document.getElementById('txt_offer_qnty').value = '".$row[csf("job_quantity")]."';\n";
		echo "document.getElementById('cbo_region').value = '".$row[csf("region")]."';\n";
		echo "document.getElementById('cbo_order_uom').value = '".$row[csf("order_uom")]."';\n";
		echo "document.getElementById('set_breck_down').value = '".$row[csf("set_break_down")]."';\n";
		echo "document.getElementById('item_id').value = '".$row[csf("gmts_item_id")]."';\n";
		echo "document.getElementById('tot_set_qnty').value = '".$row[csf("total_set_qnty")]."';\n";
		echo "document.getElementById('txt_sew_smv').value = '".fn_number_format($row[csf("set_smv")],2)."';\n";

		echo "document.getElementById('update_id').value = '".$row[csf("job_no")]."';\n";

		$quotation_id=$row[csf("quotation_id")];
		$company_name=$row[csf("company_name")];

		echo "document.getElementById('copy_quatation_id').value = '".$copy_quotation_id."';\n";
		echo "document.getElementById('budget_exceeds_quot_id').value = '".$budget_exceeds_quot_id."';\n";
		echo "document.getElementById('txt_cost_control_source').value = '".$cost_control_source_id."';\n";
		echo "document.getElementById('hidd_trim_rate').value = '".$trim_rate_source_id."';\n";

		$avg_unit_price=$row[csf("avg_unit_price")];

		echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
		echo "document.getElementById('app_sms').innerHTML = '';\n";
		echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
		echo "document.getElementById('txt_un_appv_request').value = '';\n";

		if (count($data_entry_from)<1)
		{
			echo "calculate_confirm_price_dzn(0)\n";
			echo "cm_cost_predefined_method('".$currier_cm_cost_data."')\n";
			$efficiency_data=get_efficiency_percent($row[csf("company_name")],$row[csf("job_no")],$row[csf("set_smv")]);
			echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
			//echo "document.getElementById('txt_sew_efficiency_per').value = '".$efficiency_data."';\n";

			echo "set_currier_cost_method_variable(".$company_id.")\n";
		}

		if($is_manula_approved==1){
			echo "$('#approve1').hide()".";\n";
		}
		else {
			echo "$('#approve1').show()".";\n";
		}
	}


	$copy_quotation=return_field_value("copy_quotation", "variable_order_tracking", "company_name=$company_name and variable_list=20 and status_active=1 and is_deleted=0");
	$cost_control_source=return_field_value("cost_control_source", "variable_order_tracking", "company_name=$company_name and variable_list=53 and status_active=1 and is_deleted=0");
	$publish_shipment_date=return_field_value("publish_shipment_date", "variable_order_tracking", "company_name=$company_name and variable_list=47 and status_active=1 and is_deleted=0");

	if($copy_quotation==1 && $cost_control_source==2 && $publish_shipment_date==2){
		$fabric_data=sql_select("select id from wo_pre_cost_fabric_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
		if(count($fabric_data)==0){	$checkid="1";}else{	$checkid="0";}

		$trims_data=sql_select("select id from wo_pre_cost_trim_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
		if(count($trims_data)==0){	$checkid =$checkid."_2";}else{	$checkid=$checkid."_0";	}

		$emble_data=sql_select("select id from wo_pre_cost_embe_cost_dtls where job_no='$data' and emb_name!=3 and status_active=1 and is_deleted=0");
		if(count($emble_data)==0){	$checkid =$checkid."_3";}else{	$checkid=$checkid."_0"; }

		$wash_data=sql_select("select id from wo_pre_cost_embe_cost_dtls where job_no='$data' and emb_name=3 and status_active=1 and is_deleted=0");
		if(count($wash_data)==0){	$checkid =$checkid."_4";}else{	$checkid=$checkid."_0"; }

		$commer_data=sql_select("select id from wo_pre_cost_comarci_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
		if(count($commer_data)==0){	$checkid =$checkid."_5";}else{	$checkid=$checkid."_0";	}

		$commi_data=sql_select("select id from wo_pre_cost_commiss_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
		if(count($commi_data)==0){	$checkid =$checkid."_6";}else{	$checkid=$checkid."_0"; }

		echo "document.getElementById('hidd_variableCheck_id').value = '".$checkid."';\n";
	}

	//die;
	$cbo_approved_status="";
	$data_array=sql_select("select id, costing_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, copy_quatation, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, sew_efficiency_source, remarks, approved,refusing_cause, ready_to_approved, budget_minute from wo_pre_cost_mst where job_no='$data' and is_deleted=0 and status_active=1");
	if (count($data_array)>0)
	{
		foreach ($data_array as $row)
		{
			$costing_date=$row[csf('costing_date')];
			$cost_per_minute=cost_per_minute($company_name."_".change_date_format($row[csf("costing_date")],'dd-mm-yyyy','-'));
			echo "document.getElementById('cost_per_minute').value = '".$cost_per_minute."';\n";
			echo "document.getElementById('txt_costing_date').value = '".change_date_format($row[csf("costing_date")],'dd-mm-yyyy','-')."';\n";
			echo "document.getElementById('cbo_inco_term').value = '".$row[csf("incoterm")]."';\n";
			echo "document.getElementById('txt_incoterm_place').value = '".$row[csf("incoterm_place")]."';\n";
			echo "document.getElementById('txt_machine_line').value = '".$row[csf("machine_line")]."';\n";
			echo "document.getElementById('txt_prod_line_hr').value = '".$row[csf("prod_line_hr")]."';\n";
			echo "document.getElementById('cbo_costing_per').value = '".$row[csf("costing_per")]."';\n";
			echo "document.getElementById('copy_quatation_id').value = '".$row[csf("copy_quatation")]."';\n";
			echo "document.getElementById('pre_cost_id').value = '".$row[csf("id")]."';\n";
			echo "document.getElementById('txt_refusing').value = '".$row[csf("refusing_cause")]."';\n";
			echo "document.getElementById('cm_cost_predefined_method_id').value = '".$row[csf("cm_cost_predefined_method_id")]."';\n";
			echo "document.getElementById('cm_cost_editable').value = '".$cm_cost_editable."';\n";
			if($row[csf("cm_cost_predefined_method_id")]==0) { echo "cm_cost_predefined_method('".$currier_cm_cost_data."')\n"; }
			//echo "set_currier_cost_method_variable(".$company_id.")\n";
			echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
			echo "document.getElementById('txt_sew_smv').value = '".fn_number_format($row[csf("sew_smv")],2)."';\n";
			echo "document.getElementById('txt_cut_smv').value = '".$row[csf("cut_smv")]."';\n";
			echo "document.getElementById('txt_sew_efficiency_per').value = '".$row[csf("sew_effi_percent")]."';\n";
			echo "document.getElementById('txt_sew_efficiency_source').value = '".$row[csf("sew_efficiency_source")]."';\n";
			echo "document.getElementById('txt_cut_efficiency_per').value = '".$row[csf("cut_effi_percent")]."';\n";
			echo "document.getElementById('txt_efficiency_wastage').value = '".$row[csf("efficiency_wastage_percent")]."';\n";
			echo "document.getElementById('txt_remarks').value = '".$row[csf("remarks")]."';\n";
			$cbo_approved_status= $row[csf("approved")];
			if($cbo_approved_status==3) $cbo_approved_status=1;
			echo "document.getElementById('cbo_approved_status').value = '".$cbo_approved_status."';\n";
			echo "document.getElementById('cbo_ready_to_approved').value = '".$row[csf("ready_to_approved")]."';\n";
			echo "document.getElementById('txt_budget_minute').value = '".$row[csf("budget_minute")]."';\n";

			echo "change_caption_cost_dtls('".$row[csf("costing_per")]."','change_caption_dzn')\n";
			echo "fncChangeButton('".$row[csf("ready_to_approved")]."')\n";

			if($row[csf("costing_per")]==1) $price_costing_per=$avg_unit_price*1*12;
			if($row[csf("costing_per")]==2) $price_costing_per=$avg_unit_price*1*1;
			if($row[csf("costing_per")]==3) $price_costing_per=$avg_unit_price*2*12;
			if($row[csf("costing_per")]==4) $price_costing_per=$avg_unit_price*3*12;
			if($row[csf("costing_per")]==5) $price_costing_per=$avg_unit_price*4*12;

			$ap_msg="";
			if($row[csf("approved")]==1){ $ap_msg="This Job Is Full Approved.";}
			else if($row[csf("approved")]==3){
				$approval_allow=sql_select("select b.id, b.page_id, b.approval_need, b.allow_partial, b.validate_page,a.setup_date from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id='$company_id' and a.status_active=1 and b.page_id=25 and b.status_active=1 and b.is_deleted=0 order by b.id desc ");
				if($approval_allow[0][csf("approval_need")]==1 && $approval_allow[0][csf("allow_partial")]==1){
					$ap_msg="This Job Is Approved.";
				}else{
					$ap_msg="This Job Partially Approved.";
				}
			}
			else{ $ap_msg=" ";}

			if($cbo_approved_status==1)
			{
				$approval_cause='';
				$menu_id=$_SESSION['menu_id'];
				$user_id=$_SESSION['logic_erp']['user_id'];
				$sql_request="select MAX(id) as id, approval_cause from fabric_booking_approval_cause where entry_form=15 and user_id='$user_id' and booking_id=".$row[csf("id")]." and approval_type=2 and status_active=1 and is_deleted=0 group by approval_cause";//page_id='$menu_id' and

				$nameArray_request=sql_select($sql_request);
				foreach($nameArray_request as $approw)
				{
					$approval_cause=str_replace("\n", "\\n",$approw[csf("approval_cause")]);
				}
				unset($nameArray_request);

				echo "document.getElementById('approve1').value = 'Un-Approved';\n";
				echo "$('#txt_costing_date').attr('disabled','true')".";\n";
				echo "$('#cbo_inco_term').attr('disabled','true')".";\n";
				echo "$('#txt_incoterm_place').attr('disabled','true')".";\n";
				//echo "$('#txt_machine_line').attr('disabled','true')".";\n";
				//echo "$('#txt_prod_line_hr').attr('disabled','true')".";\n";
				echo "$('#cbo_costing_per').attr('disabled','true')".";\n";
				//echo "$('#copy_quatation_id').attr('disabled','true')".";\n";
				echo "$('#txt_remarks').attr('disabled','true')".";\n";
				echo "$('#save1').attr('disabled','true')".";\n";
				echo "$('#update1').attr('disabled','true')".";\n";
				echo "$('#Delete1').attr('disabled','true')".";\n";
				echo "document.getElementById('app_sms').innerHTML = '".$ap_msg."';\n";
				echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
				echo "document.getElementById('txt_un_appv_request').value = '".$approval_cause."';\n";
			}
			else
			{
				echo "document.getElementById('approve1').value = 'Approved';\n";
				echo "$('#txt_costing_date').removeAttr('disabled')".";\n";
				echo "$('#cbo_inco_term').removeAttr('disabled')".";\n";
				echo "$('#txt_incoterm_place').removeAttr('disabled')".";\n";
				echo "$('#txt_machine_line').removeAttr('disabled')".";\n";
				echo "$('#txt_prod_line_hr').removeAttr('disabled')".";\n";
				echo "$('#cbo_costing_per').removeAttr('disabled')".";\n";
				//echo "$('#copy_quatation_id').removeAttr('disabled')".";\n";
				echo "$('#txt_remarks').removeAttr('disabled')".";\n";
				echo "$('#save1').removeAttr('disabled')".";\n";
				echo "$('#update1').removeAttr('disabled')".";\n";
				echo "$('#Delete1').removeAttr('disabled')".";\n";
				echo "document.getElementById('app_sms').innerHTML = '';\n";
				echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
				echo "document.getElementById('txt_un_appv_request').value = '';\n";
				//$efficiency_data=get_efficiency_percent($row[csf("company_name")],$row[csf("job_no")],$row[csf("set_smv")]);
				//echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
			}
			echo "set_button_status(1, permission, 'fnc_precosting_entry',1)\n";
		}
	}
	else
	{
		if($copy_quotation_id==1 && $cost_control_source_id==2)
		{
			$data_array=sql_select("select quot_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, remarks from wo_price_quotation where id='$quotation_id' and is_deleted=0 and status_active=1");
			foreach ($data_array as $row)
			{
				echo "document.getElementById('cbo_inco_term').value = '".$row[csf("incoterm")]."';\n";
				echo "document.getElementById('txt_incoterm_place').value = '".$row[csf("incoterm_place")]."';\n";
				echo "document.getElementById('txt_machine_line').value = '".$row[csf("machine_line")]."';\n";
				echo "document.getElementById('txt_prod_line_hr').value = '".$row[csf("prod_line_hr")]."';\n";
				echo "document.getElementById('cbo_costing_per').value = '".$row[csf("costing_per")]."';\n";
				echo "document.getElementById('cm_cost_predefined_method_id').value = '".$row[csf("cm_cost_predefined_method_id")]."';\n";
				echo "document.getElementById('cm_cost_editable').value = '".$cm_cost_editable."';\n";
				if($row[csf("cm_cost_predefined_method_id")]==0)
				{
					echo "cm_cost_predefined_method('".$cm_cost_predefined_method."')\n";
				}
				echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
				//echo "document.getElementById('txt_sew_smv').value = '".fn_number_format($row[csf("sew_smv")],2)."';\n";
				//echo "document.getElementById('txt_cut_smv').value = '".$row[csf("cut_smv")]."';\n";
				echo "document.getElementById('txt_sew_efficiency_per').value = '".$row[csf("sew_effi_percent")]."';\n";
				echo "document.getElementById('txt_cut_efficiency_per').value = '".$row[csf("cut_effi_percent")]."';\n";
				echo "document.getElementById('txt_efficiency_wastage').value = '".$row[csf("efficiency_wastage_percent")]."';\n";
				echo "document.getElementById('txt_remarks').value = '".$row[csf("remarks")]."';\n";
				echo "change_caption_cost_dtls('".$row[csf("costing_per")]."','change_caption_dzn')\n";
				echo "set_button_status(0, permission, 'fnc_precosting_entry',1)\n";

				if($row[csf("costing_per")]==1) $price_costing_per=$avg_unit_price*1*12;
				if($row[csf("costing_per")]==2) $price_costing_per=$avg_unit_price*1*1;
				if($row[csf("costing_per")]==3) $price_costing_per=$avg_unit_price*2*12;
				if($row[csf("costing_per")]==4) $price_costing_per=$avg_unit_price*3*12;
				if($row[csf("costing_per")]==5) $price_costing_per=$avg_unit_price*4*12;
			}
		}
	}
	$data_array=sql_select("select id, job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent,incentives_pre_cost,incentives_pre_cost_per,incentives_pre_rate, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, calculative_cmcost, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, operatingex_per, common_oh, common_oh_percent, depramortexper, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interestexper, interest_cost, interest_percent, incometexexper, incometax_cost, incometax_percent, design_cost, design_percent, studio_cost, studio_percent, margin_pcs_bom, margin_bom_per from wo_pre_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
	if (count($data_array)>0)
	{
		$po_data=sql_select("SELECT job_id, sum(po_total_price) as order_total from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst='$data' group by job_id");
		 foreach($po_data as $row){
			$total_fob_value=$row[csf('order_total')];
		}
		/*$location_cpm_cost=0;
		$sql_data=sql_select("select yarn_iss_with_serv_app from variable_order_tracking where company_name='$company_name' and variable_list=67 and status_active=1 and is_deleted=0");
		foreach($sql_data as $sql_row)
		{
			$location_cpm_cost=$sql_row[csf('yarn_iss_with_serv_app')];
		}
		$txt_costing_date=change_date_format($costing_date, "yyyy-mm-dd", "-",1);
		if($db_type==0) $limit_cond="LIMIT 1"; else if($db_type==2) $limit_cond="";
		if($location_cpm_cost==1)//Location Wse variable Yes
		{
			$sql="select a.interest_expense, a.income_tax from lib_standard_cm_entry a,lib_standard_cm_entry_dtls b where a.id=b.mst_id and a.company_id=$company_name and b.location_id=$job_location_id and '$txt_costing_date' between b.applying_period_date and b.applying_period_to_date  and b.status_active=1 and b.is_deleted=0 $limit_cond";
		}
		else
		{
			$sql="select interest_expense, income_tax from lib_standard_cm_entry where company_id=$company_name and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
		}
		//echo $sql; die;
		$variable_data=sql_select($sql);
		foreach ($variable_data as $row)
		{
			if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
			if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
		}*/

		$interest_expense=$excostper_minute[6];
		$income_tax=$excostper_minute[7];

		foreach ($data_array as $row)
		{
			echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
			echo "$('#txt_fabric_pre_cost').attr('pre_fab_cost','".$row[csf("fabric_cost")]."');\n";

			echo "document.getElementById('txt_fabric_po_price').value = '".$row[csf("fabric_cost_percent")]."';\n";
			echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
			echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";

			echo "document.getElementById('txt_trim_po_price').value = '".$row[csf("trims_cost_percent")]."';\n";
			echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
			echo "$('#txt_embel_pre_cost').attr('pre_emb_cost','".$row[csf("embel_cost")]."');\n";

			echo "document.getElementById('txt_embel_po_price').value = '".$row[csf("embel_cost_percent")]."';\n";
			echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
			echo "$('#txt_wash_pre_cost').attr('pre_wash_cost','".$row[csf("wash_cost")]."');\n";

			echo "document.getElementById('txt_wash_po_price').value = '".$row[csf("wash_cost_percent")]."';\n";
			echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("comm_cost")]."';\n";
			echo "$('#txt_comml_pre_cost').attr('pre_comml_cost','".$row[csf("comm_cost")]."');\n";

			echo "document.getElementById('txt_comml_po_price').value = '".$row[csf("comm_cost_percent")]."';\n";
			echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
			echo "$('#txt_commission_pre_cost').attr('pre_commis_cost','".$row[csf("commission")]."');\n";

			echo "document.getElementById('txt_incentives_pre_cost').value = '".$row[csf("incentives_pre_cost")]."';\n";
			echo "document.getElementById('txt_incentives_pre_cost_per').value = '".$row[csf("incentives_pre_cost_per")]."';\n";
			echo "document.getElementById('txt_incentives_pre_rate').value = '".$row[csf("incentives_pre_rate")]."';\n";
			echo "$('#txt_incentives_pre_cost').attr('pre_inspection_pre_cost','".$row[csf("incentives_pre_cost")]."');\n";

			echo "document.getElementById('txt_commission_po_price').value = '".$row[csf("commission_percent")]."';\n";
			echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_test")]."';\n";
			echo "document.getElementById('txt_lab_test_po_price').value = '".$row[csf("lab_test_percent")]."';\n";
			echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection")]."';\n";
			echo "document.getElementById('txt_inspection_po_price').value = '".$row[csf("inspection_percent")]."';\n";
			echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
			echo "document.getElementById('txt_cm_po_price').value = '".$row[csf("cm_cost_percent")]."';\n";
			echo "document.getElementById('txtcmcost').value = '".$row[csf("calculative_cmcost")]."';\n";
			echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
			echo "document.getElementById('txt_freight_po_price').value = '".$row[csf("freight_percent")]."';\n";
			echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("currier_pre_cost")]."';\n";
			echo "document.getElementById('txt_currier_po_price').value = '".$row[csf("currier_percent")]."';\n";
			echo "document.getElementById('txt_certificate_pre_cost').value = '".$row[csf("certificate_pre_cost")]."';\n";
			echo "document.getElementById('txt_certificate_po_price').value = '".$row[csf("certificate_percent")]."';\n";

			echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
			echo "document.getElementById('txt_common_oh_po_price').value = '".$row[csf("common_oh_percent")]."';\n";

			echo "document.getElementById('txt_depr_amor_pre_cost').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
			echo "document.getElementById('txt_depr_amor_po_price').value = '".$row[csf("depr_amor_po_price")]."';\n";

			echo "document.getElementById('txt_deffdlc_pre_cost').value = '".$row[csf("deffdlc_cost")]."';\n";
			echo "document.getElementById('txt_deffdlc_po_price').value = '".$row[csf("deffdlc_percent")]."';\n";

			$netfobvalue=$row[csf("price_dzn")]-$row[csf("commission_percent")];
			//echo $netfobvalue; die;
			if($row[csf("interest_cost")]>0){
				$interest_pre_cost=$row[csf("interest_cost")];
				$interest_po_price=$row[csf("interest_percent")];
			}
			else{
				$interest_pre_cost=$netfobvalue*$interest_expense/100;
				$interest_po_price=$interest_expense;
			}
			if($row[csf("incometax_cost")]>0){
				$income_tax_pre_cost=$row[csf("incometax_cost")];
				$income_tax_po_price=$row[csf("incometax_percent")];
			}
			else{
				$income_tax_pre_cost=$netfobvalue*$income_tax/100;
				$income_tax_po_price=$income_tax;
			}

			echo "$('#txtoptexpper').val('".$row[csf("operatingex_per")]."');\n";
			echo "$('#txtinterestper').val('".$row[csf("interestexper")]."');\n";
			echo "$('#txtincometexper').val('".$row[csf("incometexexper")]."');\n";
			echo "$('#txtdepramortper').val('".$row[csf("depramortexper")]."');\n";

			echo "document.getElementById('txt_interest_pre_cost').value = '".$interest_pre_cost."';\n";
			echo "document.getElementById('txt_interest_po_price').value = '".$interest_po_price."';\n";

			echo "document.getElementById('txt_incometax_pre_cost').value = '".$income_tax_pre_cost."';\n";
			echo "document.getElementById('txt_incometax_po_price').value = '".$income_tax_po_price."';\n";

			echo "document.getElementById('txt_design_pre_cost').value = '".$row[csf("design_cost")]."';\n";
			echo "document.getElementById('txt_design_po_price').value = '".$row[csf("design_percent")]."';\n";

			echo "document.getElementById('txt_studio_pre_cost').value = '".$row[csf("studio_cost")]."';\n";
			echo "document.getElementById('txt_studio_po_price').value = '".$row[csf("studio_percent")]."';\n";
			//$margin_pcs_percent=($row[csf("margin_pcs_set")]/$row[csf("price_pcs_or_set")]*100);
			echo "document.getElementById('txt_total_pre_cost').value = '".$row[csf("total_cost")]."';\n";
			echo "document.getElementById('txt_total_po_price').value = '".$row[csf("total_cost_percent")]."';\n";
			echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$row[csf("price_dzn")]."';\n";//price_pcs_or_set
			echo "document.getElementById('txt_final_price_dzn_po_price').value = '".$row[csf("price_dzn_percent")]."';\n";
			echo "document.getElementById('txt_margin_dzn_pre_cost').value = '".$row[csf("margin_dzn")]."';\n";
			echo "document.getElementById('txt_margin_dzn_po_price').value = '".$row[csf("margin_dzn_percent")]."';\n";
			echo "document.getElementById('txt_total_pre_cost_psc_set').value = '".$row[csf("cost_pcs_set")]."';\n";
			echo "document.getElementById('txt_total_pre_cost_psc_set_po_price').value = '".$row[csf("cost_pcs_set_percent")]."';\n";
			echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$row[csf("price_pcs_or_set")]."';\n";
			echo "document.getElementById('txt_final_price_pcs_po_price').value = '".$row[csf("price_pcs_or_set_percent")]."';\n";
			echo "document.getElementById('txt_margin_pcs_pre_cost').value = '".$row[csf("margin_pcs_set")]."';\n";
			echo "document.getElementById('txt_margin_pcs_po_price').value = '".$row[csf("margin_pcs_set_percent")]."';\n";
			//echo "document.getElementById('txt_margin_pcs_po_price').value = '".number_format($margin_pcs_percent,2,'.','')."';\n";

			echo "document.getElementById('txt_margin_pcs_bom_cost').value = '".$row[csf("margin_pcs_bom")]."';\n";
			echo "document.getElementById('txt_margin_pcs_bom_per').value = '".$row[csf("margin_bom_per")]."';\n";
			echo "document.getElementById('update_id_dtls').value = '".$row[csf("id")]."';\n";
			if($row[csf("margin_dzn")]<0)
			{
				echo "document.getElementById('txt_margin_dzn_pre_cost').style.backgroundColor = '#F00';\n";
			}
			else
			{
				echo "document.getElementById('txt_margin_dzn_pre_cost').style.backgroundColor = '';\n";
			}

			if($row[csf("margin_pcs_set")]<0)
			{
				echo "document.getElementById('txt_margin_pcs_pre_cost').style.backgroundColor = '#F00';\n";
			}
			else
			{
				echo "document.getElementById('txt_margin_pcs_pre_cost').style.backgroundColor = '';\n";
			}
			if($cbo_approved_status==1)
			{
				echo "$('#txt_lab_test_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_inspection_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_cm_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_freight_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_common_oh_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_1st_quoted_price_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_first_quoted_price_date').attr('disabled','true')".";\n";
				echo "$('#txt_revised_price_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_revised_price_date').attr('disabled','true')".";\n";
				echo "$('#txt_confirm_price_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_confirm_date_pre_cost').attr('disabled','true')".";\n";
				//echo "$('#txt_margin_pcs_bom_cost').attr('disabled','true')".";\n";

				echo "$('#save2').attr('disabled','true')".";\n";
				echo "$('#update2').attr('disabled','true')".";\n";
				echo "$('#Delete2').attr('disabled','true')".";\n";
			}
			else
			{
				echo "$('#txt_lab_test_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_inspection_pre_cost').removeAttr('disabled')".";\n";
				//echo "$('#txt_cm_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_freight_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_common_oh_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_1st_quoted_price_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_first_quoted_price_date').removeAttr('disabled')".";\n";
				echo "$('#txt_revised_price_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_revised_price_date').removeAttr('disabled')".";\n";
				echo "$('#txt_confirm_price_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_confirm_date_pre_cost').removeAttr('disabled')".";\n";
				//echo "$('#txt_margin_pcs_bom_cost').removeAttr('disabled')".";\n";
				echo "$('#save2').removeAttr('disabled')".";\n";
				echo "$('#update2').removeAttr('disabled')".";\n";
				echo "$('#Delete2').removeAttr('disabled')".";\n";
			}
			if($component_approved_lab==1) echo "$('#txt_lab_test_pre_cost').attr('disabled','true');\n"; else echo "$('#txt_lab_test_pre_cost').removeAttr('disabled');\n";
			if($component_approved_ins==1) echo "$('#txt_inspection_pre_cost').attr('disabled','true');\n"; else echo "$('#txt_inspection_pre_cost').removeAttr('disabled');\n";
			if($component_approved_friegt==1) echo "$('#txt_freight_pre_cost').attr('disabled','true');\n"; else echo "$('#txt_freight_pre_cost').removeAttr('disabled');\n";
			if($component_approved_currier==1) echo "$('#txt_currier_pre_cost').attr('disabled','true');\n"; else echo "$('#txt_currier_pre_cost').removeAttr('disabled');\n";
			if($component_approved_certificate==1) echo "$('#txt_certificate_pre_cost').attr('disabled','true');\n"; else echo "$('#txt_certificate_pre_cost').removeAttr('disabled');\n";
			if($component_approved_others==1)
			{
				echo "$('#txt_interest_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_incometax_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_common_oh_pre_cost').attr('disabled','true')".";\n";
				echo "$('#txt_depr_amor_pre_cost').attr('disabled','true')".";\n";
			}
			else
			{
				echo "$('#txt_interest_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_incometax_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_common_oh_pre_cost').removeAttr('disabled')".";\n";
				echo "$('#txt_depr_amor_pre_cost').removeAttr('disabled')".";\n";
			}
			echo "set_button_status(1, permission, 'fnc_quotation_entry_dtls',2)\n";
		}

		if($copy_quotation_id==1 && $cost_control_source_id==2)
		{
			$data_array=sql_select("select id, quotation_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent,wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent,currier_pre_cost, 	currier_percent, certificate_pre_cost,incentives_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, commission, commission_percent, final_cost_dzn, final_cost_dzn_percent, final_cost_pcs, final_cost_set_pcs_rate, a1st_quoted_price, a1st_quoted_price_date, revised_price,revised_price_date, confirm_price, confirm_price_set_pcs_rate, confirm_price_dzn, confirm_price_dzn_percent, margin_dzn, margin_dzn_percent, confirm_date, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted from wo_price_quotation_costing_mst where quotation_id='$quotation_id' and status_active=1 and is_deleted=0");

			if (count($data_array)>0)
			{
				foreach ($data_array as $row)
				{
					echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".fn_number_format($row[csf("fabric_cost")],6)."')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".fn_number_format($row[csf("trims_cost")],6)."')".";\n";
					echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".fn_number_format($row[csf("embel_cost")],6)."')".";\n";
					echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".fn_number_format($row[csf("wash_cost")],6)."')".";\n";
					echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".fn_number_format($row[csf("comm_cost")],6)."')".";\n";
					echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".fn_number_format($row[csf("commission")],6)."')".";\n";
					echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".fn_number_format($row[csf("lab_test")],6)."')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','".fn_number_format($row[csf("inspection")],6)."')".";\n";
					echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".fn_number_format($row[csf("cm_cost")],6)."')".";\n";
					echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".fn_number_format($row[csf("freight")],6)."')".";\n";
					echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".fn_number_format($row[csf("currier_pre_cost")],6)."')".";\n";
					echo "$('#txt_incentives_pre_cost').attr('pri_incentives_pre_cost','".fn_number_format($row[csf("incentives_pre_cost")],6)."')".";\n";
					echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','".fn_number_format($row[csf("certificate_pre_cost")],6)."')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".fn_number_format($row[csf("common_oh")],6)."')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','".fn_number_format($row[csf("depr_amor_pre_cost")],6)."')".";\n";
					echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','".fn_number_format($row[csf("total_cost")],6)."')".";\n";
				}
			}
			else
			{
				echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
				echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
				echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
				echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
				echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
				echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
				echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
				echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
				echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
				echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
				echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";
				echo "$('#txt_incentives_pre_cost').attr('pri_incentives_pre_cost','0')".";\n";
				echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
				echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
				echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
				echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
			}
		}
	}
	else
	{
		if($copy_quotation_id==1 && $cost_control_source_id==2)//Price Quotation
		{
			$data_array=sql_select("select id, quotation_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, 	currier_percent, certificate_pre_cost,incentives_pre_cost,incentives_po_per, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, commission, commission_percent, final_cost_dzn, final_cost_dzn_percent, final_cost_pcs, final_cost_set_pcs_rate, a1st_quoted_price, a1st_quoted_price_date, revised_price, revised_price_date, confirm_price, confirm_price_set_pcs_rate, confirm_price_dzn, confirm_price_dzn_percent, margin_dzn, margin_dzn_percent, confirm_date, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, design_pre_cost, design_percent, studio_pre_cost, studio_percent, interest_pre_cost, interest_po_price, income_tax_pre_cost, income_tax_po_price from wo_price_quotation_costing_mst where quotation_id='$quotation_id' and status_active=1 and is_deleted=0");
			if(count($data_array)>0)
			{
				$po_data=sql_select("SELECT job_id, sum(po_total_price) as order_total from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst='$data' group by job_id");
				foreach($po_data as $row){
					$total_fob_value=$row[csf('order_total')];
				}
				$location_cpm_cost=0;
				$sql_data=sql_select("select yarn_iss_with_serv_app from variable_order_tracking where company_name='$company_name' and variable_list=67 and status_active=1 and is_deleted=0");
				foreach($sql_data as $sql_row)
				{
					$location_cpm_cost=$sql_row[csf('yarn_iss_with_serv_app')];
				}
				$txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
				if($db_type==0) $limit_cond="LIMIT 1"; else if($db_type==2) $limit_cond="";
				if($location_cpm_cost==1)//Location Wse variable Yes
				{
					$sql="select a.interest_expense, a.income_tax from lib_standard_cm_entry a,lib_standard_cm_entry_dtls b where a.id=b.mst_id and a.company_id=$company_name and b.location_id=$job_location_id and '$txt_costing_date' between b.applying_period_date and b.applying_period_to_date  and b.status_active=1 and b.is_deleted=0 $limit_cond";
				}
				else
				{
					$sql="select interest_expense, income_tax from lib_standard_cm_entry where company_id=$company_name and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
				}
				$variable_data=sql_select($sql);
				foreach ($variable_data as $row)
				{
					if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
					if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
				}
				foreach ($data_array as $row)
				{
					//echo "reset_form('quotationdtls_2','','');\n";
					echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
					echo "$('#txt_fabric_pre_cost').attr('pre_fab_cost','".$row[csf("fabric_cost")]."');\n";

					echo "document.getElementById('txt_fabric_po_price').value = '".$row[csf("fabric_cost_percent")]."';\n";
					echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
					echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";

					echo "document.getElementById('txt_trim_po_price').value = '".$row[csf("trims_cost_percent")]."';\n";
					echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
					echo "$('#txt_embel_pre_cost').attr('pre_emb_cost','".$row[csf("embel_cost")]."');\n";

					echo "document.getElementById('txt_embel_po_price').value = '".$row[csf("embel_cost_percent")]."';\n";
					echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
					echo "$('#txt_wash_pre_cost').attr('pre_wash_cost','".$row[csf("wash_cost")]."');\n";

					echo "document.getElementById('txt_wash_po_price').value = '".$row[csf("wash_cost_percent")]."';\n";
					echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("comm_cost")]."';\n";
					echo "$('#txt_comml_pre_cost').attr('pre_comml_cost','".$row[csf("comm_cost")]."');\n";

					echo "document.getElementById('txt_incentives_pre_cost').value = '".$row[csf("incentives_pre_cost")]."';\n";
					echo "$('#txt_incentives_pre_cost').attr('pri_incentives_pre_cost','".$row[csf("incentives_pre_cost")]."');\n";
					echo "document.getElementById('txt_incentives_pre_cost_per').value = '".$row[csf("incentives_po_per")]."';\n";


					echo "document.getElementById('txt_comml_po_price').value = '".$row[csf("comm_cost_percent")]."';\n";
					echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
					echo "$('#txt_commission_pre_cost').attr('pre_commis_cost','".$row[csf("commission")]."');\n";

					echo "document.getElementById('txt_commission_po_price').value = '".$row[csf("commission_percent")]."';\n";
					echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_test")]."';\n";
					echo "document.getElementById('txt_lab_test_po_price').value = '".$row[csf("lab_test_percent")]."';\n";
					echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection")]."';\n";
					echo "document.getElementById('txt_inspection_po_price').value = '".$row[csf("inspection_percent")]."';\n";
					echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
					echo "document.getElementById('txt_cm_po_price').value = '".$row[csf("cm_cost_percent")]."';\n";
					echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
					echo "document.getElementById('txt_freight_po_price').value = '".$row[csf("freight_percent")]."';\n";
					echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("currier_pre_cost")]."';\n";
					echo "document.getElementById('txt_currier_po_price').value = '".$row[csf("currier_percent")]."';\n";
					echo "document.getElementById('txt_certificate_pre_cost').value = '".$row[csf("certificate_pre_cost")]."';\n";
					echo "document.getElementById('txt_certificate_po_price').value = '".$row[csf("certificate_percent")]."';\n";

					echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
					echo "document.getElementById('txt_common_oh_po_price').value = '".$row[csf("common_oh_percent")]."';\n";

					echo "document.getElementById('txt_depr_amor_pre_cost').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
					echo "document.getElementById('txt_depr_amor_po_price').value = '".$row[csf("depr_amor_po_price")]."';\n";

					$netfobvalue=$price_costing_per-$row[csf("commission_percent")];

					if($row[csf("interest_pre_cost")]>0){
						$interest_pre_cost=$row[csf("interest_pre_cost")];
						$interest_po_price=$row[csf("interest_po_price")];
					}
					else{
						$interest_pre_cost=$netfobvalue*$interest_expense/100;
						$interest_po_price=$interest_expense;
					}
					if($row[csf("income_tax_pre_cost")]>0){
						$income_tax_pre_cost=$row[csf("income_tax_pre_cost")];
						$income_tax_po_price=$row[csf("income_tax_po_price")];
					}
					else{
						$income_tax_pre_cost=$netfobvalue*$income_tax/100;
						$income_tax_po_price=$income_tax;
					}

					echo "document.getElementById('txt_interest_pre_cost').value = '".$interest_pre_cost."';\n";
					echo "document.getElementById('txt_interest_po_price').value = '".$interest_po_price."';\n";

					echo "document.getElementById('txt_incometax_pre_cost').value = '".$income_tax_pre_cost."';\n";
					echo "document.getElementById('txt_incometax_po_price').value = '".$income_tax_po_price."';\n";

					echo "document.getElementById('txt_total_pre_cost').value = '".$row[csf("total_cost")]."';\n";
					echo "document.getElementById('txt_total_po_price').value = '".$row[csf("total_cost_percent")]."';\n";
					echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
					echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$price_costing_per."';\n";

					echo "document.getElementById('txt_design_pre_cost').value = '".$row[csf("design_pre_cost")]."';\n";
					echo "document.getElementById('txt_design_po_price').value = '".$row[csf("design_percent")]."';\n";

					echo "document.getElementById('txt_studio_pre_cost').value = '".$row[csf("studio_pre_cost")]."';\n";
					echo "document.getElementById('txt_studio_po_price').value = '".$row[csf("studio_percent")]."';\n";

					echo "calculate_confirm_price_dzn(1)\n";
					echo "set_button_status(0, permission, 'fnc_quotation_entry_dtls',2)\n";

					echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".$row[csf("fabric_cost")]."')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".$row[csf("trims_cost")]."')".";\n";
					echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".$row[csf("embel_cost")]."')".";\n";
					echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".$row[csf("wash_cost")]."')".";\n";
					echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".$row[csf("comm_cost")]."')".";\n";
					echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".$row[csf("commission")]."')".";\n";
					echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".$row[csf("lab_test")]."')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','".$row[csf("inspection")]."')".";\n";
					echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".$row[csf("cm_cost")]."')".";\n";
					echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".$row[csf("freight")]."')".";\n";
					echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".$row[csf("currier_pre_cost")]."')".";\n";
					echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','".$row[csf("certificate_pre_cost")]."')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".$row[csf("common_oh")]."')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','".$row[csf("depr_amor_pre_cost")]."')".";\n";
					echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','".$row[csf("total_cost")]."')".";\n";
				}
			}
			else
			{
				echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
				echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
				echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
				echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
				echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
				echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
				echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
				echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
				echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
				echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
				echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";

				echo "$('#txt_incentives_pre_cost').attr('pri_incentives_pre_cost','0')".";\n";

				echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
				echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
				echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
				echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
			}
		}
		else if($copy_quotation_id==1 && $cost_control_source_id==8)//Short Quotation -V6
		{
			$data_array=sql_select("select sum(fab_amount) as fabric_cost, sum(sp_oparation_amount) as embel_cost, sum(wash_amount) as wash_cost, sum(acc_amount) as trims_cost, sum(fright_amount) as freight, sum(lab_amount) as lab_cost, sum(inspection_cost) as inspection_cost, sum(operating_exp) as operating_exp, sum(commercial_cost) as commercial_cost, sum(comm_amount) as commission, sum(cm_amount) as cm_cost, sum(courier_amount) as courier_amount, sum(lc_cost) as lc_cost from qc_confirm_dtls where cost_sheet_id='$quotation_id' and status_active=1 and is_deleted=0");
			//echo "select sum(fab_amount) as fabric_cost, sum(sp_oparation_amount) as embel_cost, sum(wash_amount) as wash_cost, sum(acc_amount) as trims_cost, sum(fright_amount) as freight, sum(lab_amount) as lab_cost, sum(commercial_cost) as commercial_cost, sum(comm_amount) as commission, sum(cm_amount) as cm_cost, sum(courier_amount) as courier_amount, sum(lc_cost) as lc_cost from qc_confirm_dtls where cost_sheet_id='$quotation_id' and status_active=1 and is_deleted=0";
			if(count($data_array)>0)
			{
				foreach ($data_array as $row)
				{
					echo "reset_form('quotationdtls_2','','');\n";
					echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
					echo "$('#txt_fabric_pre_cost').attr('pre_fab_cost','".$row[csf("fabric_cost")]."');\n";
					echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
					echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";
					echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
					echo "$('#txt_embel_pre_cost').attr('pre_emb_cost','".$row[csf("embel_cost")]."');\n";
					echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
					echo "$('#txt_wash_pre_cost').attr('pre_wash_cost','".$row[csf("wash_cost")]."');\n";
					echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("commercial_cost")]."';\n";
					echo "$('#txt_comml_pre_cost').attr('pre_comml_cost','".$row[csf("commercial_cost")]."');\n";
					echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
					echo "$('#txt_commission_pre_cost').attr('pre_commis_cost','".$row[csf("commission")]."');\n";
					echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_cost")]."';\n";
					echo "$('#txt_lab_test_pre_cost').attr('pre_lab_cost','".$row[csf("lab_cost")]."');\n";
					
					echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection_cost")]."';\n";
					echo "$('#txt_inspection_pre_cost').attr('pre_insp_cost','".$row[csf("inspection_cost")]."');\n";
					
					echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("operating_exp")]."';\n";
					echo "$('#txt_common_oh_pre_cost').attr('pre_insp_cost','".$row[csf("operating_exp")]."');\n";
					
					echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
					echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
					echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("courier_amount")]."';\n";
					echo "document.getElementById('txt_deffdlc_pre_cost').value = '".$row[csf("lc_cost")]."';\n";
					echo "set_currier_cost_method_variable(".$company_id.");\n";
					echo "calculate_confirm_price_dzn(1);\n";
					echo "set_button_status(0, permission, 'fnc_quotation_entry_dtls',2)\n";

					echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".$row[csf("fabric_cost")]."')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".$row[csf("trims_cost")]."')".";\n";
					echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".$row[csf("embel_cost")]."')".";\n";
					echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".$row[csf("wash_cost")]."')".";\n";
					echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".$row[csf("commercial_cost")]."')".";\n";
					echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".$row[csf("commission")]."')".";\n";
					echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".$row[csf("lab_cost")]."')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','".$row[csf("inspection_cost")]."')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".$row[csf("operating_exp")]."')".";\n";
					echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".$row[csf("cm_cost")]."')".";\n";
					echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".$row[csf("freight")]."')".";\n";
					echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".$row[csf("courier_amount")]."')".";\n";
					
					echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
					echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$price_costing_per."';\n";
				}
			}
		}
		else
		{
			echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
			echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
			echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
			echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
			echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
			echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
			echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
			echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
			echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
			echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
			echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";

			echo "$('#txt_incentives_pre_cost').attr('pri_incentives_pre_cost','0')".";\n";

			echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
			echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
			echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
			echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
		}
	}
	
	$REFUSING_REASON=return_field_value("REFUSING_REASON", "REFUSING_CAUSE_HISTORY", "MST_ID='".$data_entry_from[0][csf('id')]."' and ENTRY_FORM=15 order by id desc");
	if (count($REFUSING_REASON)<1)
	{
		//echo "select REFUSING_REASON from PRECOST_COMPONENT_NOT_APP_CA where MST_ID='".$data_entry_from[0][csf('id')]."' and ENTRY_FORM=11 order by id desc";
		$REFUSING_REASON=return_field_value("REFUSING_REASON", "PRECOST_COMPONENT_NOT_APP_CA", "MST_ID='".$data_entry_from[0][csf('id')]."' and ENTRY_FORM=11 order by id desc");
	}
	echo "$('#txt_refusing').val('".$REFUSING_REASON."')".";\n";
	exit();
}

if ($action=="partial_pre_cost_copy_popup")
{
  	echo load_html_head_contents("Popup Partial Pre Cost Copy","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	//die; // die by kausar
	?>
	<script>
	var permission = '<? echo $permission; ?>';
	function fnc_copy_pre_cost()
	{
		//alert( operation);
		if (form_validation('txt_popup_job_no','Job No')==false)
		{
			return;
		}
		else
		{
			var txt_popup_job_no=$("#txt_popup_job_no").val();
			var txt_main_job_no_hidden=$("#txt_main_job_no_hidden").val();
			var hidd_job_id=$("#hidd_job_id").val();
			var cons_variable=$("#hidd_cons_variable").val();
			$("#pre_cost_copy_btn").attr("disabled","disabled");
			var data="action=save_partial_pre_cost_copy&datas="+txt_popup_job_no+'*'+txt_main_job_no_hidden+'*'+hidd_job_id+'*'+cons_variable;
			//alert(data);
			http.open("POST","pre_cost_entry_controller_v2.php",true);
			http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			http.send(data);
			http.onreadystatechange = fnc_pre_cost_copy_reponse;
		}

		function fnc_pre_cost_copy_reponse()
		{
			if(http.readyState == 4)
			{
				//alert (http.responseText); //return ;
				var reponse=http.responseText.split('**');
				show_msg(trim(reponse[0]));
				if(reponse[0]==0) alert('Data is copy successfully'); else alert('Data is copy failed');
				$("#pre_cost_copy_btn").removeAttr('disabled');
				reset_form('partialcopyfrm_1','','');
			}
		}
	}

	</script>
    </head>
    <body>
    <div align="center" style="width:100%;" >
    <form name="partialcopyfrm_1"  id="partialcopyfrm_1" autocomplete="off">
        <table width="300" cellspacing="0" cellpadding="0" border="0"  align="center">
            <tr>
                <td align="left" width="60" class="must_entry_caption">Job No</td>
                <td  width="150">
                    <input type="hidden" id="txt_main_job_no_hidden" name="txt_main_job_no_hidden" class="text_boxes" style="width:100px;" value="<? echo $txt_job_no; ?>" />
                    <input type="hidden" id="hidd_job_id" name="hidd_job_id" class="text_boxes" style="width:100px;" value="<?=$hidd_job_id; ?>" />
                    <input type="hidden" id="hidd_cons_variable" name="hidd_cons_variable" value="<?=$cons_variable; ?>" />
                    <input type="text" id="txt_popup_job_no" name="txt_popup_job_no" class="text_boxes" style="width:150px;" />
                </td>
                <td align="right" width="60">
                    <input type="button" id="pre_cost_copy_btn" class="formbutton" value="Copy" onClick="fnc_copy_pre_cost()" />
                </td>
            </tr>
        </table>
        </form>
       </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}
// END  partial pre cost copy popup action//
//START  partial pre cost copy SAVE action here...............................
if($action=="save_partial_pre_cost_copy") // Save here....
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$datas=explode('*',$datas);
	$popup_job_no=$datas[0];
	$main_job_no=$datas[1];
	$hidd_job_id=$datas[2];
	$cons_variable=$datas[3];
	//echo 'got it';
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$company_name=return_field_value("company_name","wo_po_details_master","job_no ='".$popup_job_no."'   and is_deleted=0 and status_active=1");

	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name=$company_name and variable_list=56 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
		//$embelt_budget_qty_id_arr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')];
	}
	//print_r($variArr);
	//echo "10**=A";die;
	$flag=1;
	$fabric_cost_id_maping=array();
	if($cons_variable==1) $fabConsRateAmt="avg_cons, rate, amount, avg_finish_cons, avg_process_loss,"; else if($cons_variable==2) $fabConsRateAmt="0 as avg_cons, 0 as rate, 0 as amount, 0 as avg_finish_cons, 0 as avg_process_loss,";
	//echo "select id from wo_pre_cost_fabric_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC"; die;
	$sql_se_set_2=sql_select("select id from wo_pre_cost_fabric_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_2 as $row_se_set)
	{
		$id2=return_next_id( "id", "wo_pre_cost_fabric_cost_dtls", 1 );

		$sql_insert_22="insert into  wo_pre_cost_fabric_cost_dtls (id, job_id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, fabric_source, avg_cons, rate, amount, avg_finish_cons, avg_process_loss, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, nominated_supp, sample_id, inserted_by, insert_date, status_active, is_deleted)

		select $id2, '".$hidd_job_id."', '".$main_job_no."', item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, fabric_source, $fabConsRateAmt company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, nominated_supp, sample_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from wo_pre_cost_fabric_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID2=execute_query($sql_insert_22,1);
		$fabric_cost_id_maping[$row_se_set[csf('id')]]=$id2;
		//echo $sql_insert_22;
	}

	//echo "10**";
	if($cons_variable==1)
	{
		$cSizeArr=array();
		$sqlCZ="select b.id, min(c.id) as color_size_table_id, min(c.color_order) as color_order, min(c.size_order) as size_order, c.color_number_id, c.size_number_id from wo_po_break_down b, wo_po_color_size_breakdown c where b.id=c.po_break_down_id and b.job_no_mst='".$main_job_no."' and b.status_active=1 and c.status_active=1 and c.is_deleted=0 group by b.id, c.color_number_id, c.size_number_id order by b.id, color_order, size_order";
		$sqlCZRes=sql_select($sqlCZ);

		foreach($sqlCZRes as $czrow)
		{
			$cSizeArr[$czrow[csf('color_number_id')]][$czrow[csf('size_number_id')]][$czrow[csf('id')]][$czrow[csf('color_size_table_id')]]=$czrow[csf('color_size_table_id')];
		}
		//print_r($cSizeArr);

		//echo "select id, pre_cost_fabric_cost_dtls_id, color_number_id, gmts_sizes, dia_width, item_size from wo_pre_cos_fab_co_avg_con_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id";
		$fabConsSql=sql_select("select id, pre_cost_fabric_cost_dtls_id, color_number_id, gmts_sizes, dia_width, item_size from wo_pre_cos_fab_co_avg_con_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id");
		foreach($fabConsSql as $frow)
		{
			foreach($cSizeArr[$frow[csf('color_number_id')]][$frow[csf('gmts_sizes')]] as $poid=>$podata)
			{
				foreach($podata as $color_size_table_id)
				{
					if($color_size_table_id!="")
					{
						$fabcon_tbl_id=return_next_id( "id", "wo_pre_cos_fab_co_avg_con_dtls", 1) ;
						$sql_insert_fabcons_avg="insert into wo_pre_cos_fab_co_avg_con_dtls (id, job_id, pre_cost_fabric_cost_dtls_id, job_no, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length, front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, rate, amount, length, inserted_by, insert_date, status_active, is_deleted, length_sleeve, width_sleeve )
						select $fabcon_tbl_id, '".$hidd_job_id."', ".$fabric_cost_id_maping[$frow[csf('pre_cost_fabric_cost_dtls_id')]].", '".$main_job_no."', '".$poid."', color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs,'".$color_size_table_id."', body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length, front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, rate, amount, length, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1, 0, length_sleeve, width_sleeve from wo_pre_cos_fab_co_avg_con_dtls where job_no='$popup_job_no' and id=".$frow[csf('id')]."";
						//echo $sql_insert_fabcons_avg.'<br>';

						$rIDfCons=execute_query($sql_insert_fabcons_avg,0);
						//oci_commit($con);
					}
				}
			}
		}
	}
	//die;
	//wo_pre_cost_fab_yarn_cost_dtls
	if($cons_variable==1) $yarnConsRateAmt="cons_qnty, rate, amount, avg_cons_qnty,"; else if($cons_variable==2) $yarnConsRateAmt="0 as cons_qnty, 0 as rate, 0 as amount, 0 as avg_cons_qnty,";
	$sql_se_set_3=sql_select("select id, fabric_cost_dtls_id from wo_pre_cost_fab_yarn_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_3 as $row_se_set)
	{
		$id3=return_next_id( "id", "wo_pre_cost_fab_yarn_cost_dtls", 1 );

		$sql_insert_33="insert into wo_pre_cost_fab_yarn_cost_dtls (id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, avg_cons_qnty, supplier_id, color, consdznlbs, rate_dzn, inserted_by, insert_date, status_active, is_deleted)
		select $id3, '".$hidd_job_id."', '".$fabric_cost_id_maping[$row_se_set[csf('fabric_cost_dtls_id')]]."', '".$main_job_no."', count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, $yarnConsRateAmt supplier_id, color, consdznlbs, rate_dzn, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from wo_pre_cost_fab_yarn_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID3=execute_query($sql_insert_33,1);
		//echo $sql_insert_33;
	}
	//wo_pre_cost_fab_conv_cost_dtls
	if($cons_variable==1) $convConsRateAmt="req_qnty, charge_unit, amount, color_break_down, charge_lib_id, avg_req_qnty, process_loss,"; else if($cons_variable==2) $convConsRateAmt="0 as req_qnty, 0 as charge_unit, 0 as amount, 0 as color_break_down, 0 as charge_lib_id, 0 as avg_req_qnty, 0 as process_loss,";
	$sql_se_set_4=sql_select("select id, fabric_description from wo_pre_cost_fab_conv_cost_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_4 as $row_se_set)
	{
		$id4=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 );

		$sql_insert_44="insert into  wo_pre_cost_fab_conv_cost_dtls (id, job_id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, avg_req_qnty, process_loss, inserted_by, insert_date, status_active, is_deleted)
		select $id4, '".$hidd_job_id."', '".$main_job_no."', '".$fabric_cost_id_maping[$row_se_set[csf('fabric_description')]]."', cons_process, $convConsRateAmt ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from  wo_pre_cost_fab_conv_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID4=execute_query($sql_insert_44,1);
		//echo $sql_insert_44;
	}
	//wo_pre_cost_trim_cost_dtls
	if($cons_variable==1) $trimConsRateAmt="cons_dzn_gmts, rate, amount,"; else if($cons_variable==2) $trimConsRateAmt="0 as cons_dzn_gmts, 0 as rate, 0 as amount,";
	$sql_se_set_5=sql_select("select id from wo_pre_cost_trim_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_5 as $row_se_set)
	{
		$id5=return_next_id( "id", "wo_pre_cost_trim_cost_dtls", 1 );

		$sql_insert_55="insert into  wo_pre_cost_trim_cost_dtls (id, job_id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, cons_breack_down, remark, country, seq, calculatorstring, unit_price, inco_term, add_price, inserted_by, insert_date, status_active, is_deleted, nominated_supp_multi)
		select $id5, '".$hidd_job_id."', '".$main_job_no."', trim_group, description, brand_sup_ref, cons_uom, $trimConsRateAmt apvl_req, nominated_supp, cons_breack_down, remark, country, seq, calculatorstring, unit_price, inco_term, add_price, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted, nominated_supp_multi from wo_pre_cost_trim_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID5=execute_query($sql_insert_55,1);
		$trims_cost_id_maping[$row_se_set[csf('id')]]=$id5;
		//echo $sql_insert_55;
	}

	if($cons_variable==1)
	{
		//echo "10**";
		$trimConsSql=sql_select("select id, wo_pre_cost_trim_cost_dtls_id, item_number_id, color_number_id, size_number_id, item_size, item_color_number_id, country_id from wo_pre_cost_trim_co_cons_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0");
		foreach($trimConsSql as $trow)
		{
			foreach($cSizeArr[$trow[csf('color_number_id')]][$trow[csf('size_number_id')]] as $poid=>$podata)
			{
				foreach($podata as $color_size_table_id)
				{
					if($color_size_table_id!="")
					{
						$trimcon_tbl_id=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1) ;
						$sql_insert_trimcons_avg="insert into wo_pre_cost_trim_co_cons_dtls (id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, item_color_number_id, size_number_id, rate, amount, gmts_pcs, color_size_table_id, inserted_by, insert_date, status_active, is_deleted)
			select $trimcon_tbl_id, '".$hidd_job_id."', ".$trims_cost_id_maping[$trow[csf('wo_pre_cost_trim_cost_dtls_id')]].", '".$main_job_no."', '".$poid."', item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, item_color_number_id, size_number_id, rate, amount, gmts_pcs, '".$color_size_table_id."',".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1, 0 from wo_pre_cost_trim_co_cons_dtls where job_no='$popup_job_no' and id=".$trow[csf('id')]."";
						//echo $sql_insert_trimcons_avg.'<br>';

						$rIDtCons=execute_query($sql_insert_trimcons_avg,0);
						//oci_commit($con);
					}
				}
			}
		}
	}
	//die;
	//wo_pre_cost_embe_cost_dtls
	if($cons_variable==1) $embConsRateAmt="cons_dzn_gmts, rate, amount,"; else if($cons_variable==2) $embConsRateAmt="0 as cons_dzn_gmts, 0 as rate, 0 as amount,";
	$sql_se_set_6=sql_select("select id,emb_name from wo_pre_cost_embe_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_6 as $row_se_set)
	{
		$id6=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 );
		$vari_budget_on=$variArr[$row_se_set[csf('emb_name')]];

		$sql_insert_66="insert into wo_pre_cost_embe_cost_dtls (id, job_id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, supplier_id, country, body_part_id, inserted_by, insert_date, status_active, is_deleted)
		select $id6, '".$hidd_job_id."', '".$main_job_no."', emb_name, emb_type, $embConsRateAmt charge_lib_id, $vari_budget_on, supplier_id, country, body_part_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from wo_pre_cost_embe_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID6=execute_query($sql_insert_66,1);
		$emb_cost_id_maping[$row_se_set[csf('id')]]=$id6;
		//echo $sql_insert_66;
	}

	if($cons_variable==1)
	{
		//echo "10**";
		$embConsSql=sql_select("select id, pre_cost_emb_cost_dtls_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id");
		foreach($embConsSql as $erow)
		{
			foreach($cSizeArr[$erow[csf('color_number_id')]][$erow[csf('size_number_id')]] as $poid=>$podata)
			{
				foreach($podata as $color_size_table_id)
				{
					if($color_size_table_id!="")
					{
						$embcon_tbl_id=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1) ;
						$sql_insert_embcons_avg="insert into wo_pre_cos_emb_co_avg_con_dtls (id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, gmts_pcs, color_size_table_id, rate_lib_id, country_id, inserted_by, insert_date, status_active, is_deleted)
			select $embcon_tbl_id, '".$hidd_job_id."', '".$emb_cost_id_maping[$erow[csf('pre_cost_emb_cost_dtls_id')]]."', '".$main_job_no."', '".$poid."', item_number_id, color_number_id, size_number_id, requirment, rate, amount, gmts_pcs, '".$color_size_table_id."', rate_lib_id, country_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1, 0 from wo_pre_cos_emb_co_avg_con_dtls where job_no='$popup_job_no' and id=".$erow[csf('id')]."";
						//echo $sql_insert_embcons_avg.'<br>';

						$rIDeCons=execute_query($sql_insert_embcons_avg,0);
						//oci_commit($con);
					}
				}
			}
		}
	}
	//die;

	//wo_pre_cost_comarci_cost_dtls
	$sql_se_set_7=sql_select("select id from wo_pre_cost_comarci_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_7 as $row_se_set)
	{
		$id7=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 );
		//$sql_insert_77="insert into wo_pre_cost_comarci_cost_dtls (id,job_no,item_id,rate,amount,inserted_by,insert_date,status_active,is_deleted) select $id7,'".$main_job_no."',item_id,rate,amount,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active,is_deleted from wo_pre_cost_comarci_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." ";

		$sql_insert_77="insert into wo_pre_cost_comarci_cost_dtls (id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted) select $id7, '".$hidd_job_id."', '".$main_job_no."', item_id, rate, amount, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from  wo_pre_cost_comarci_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID7=execute_query($sql_insert_77,1);
		//echo $sql_insert_77;
	}
	//wo_pre_cost_commiss_cost_dtls
	$sql_se_set_8=sql_select("select id from wo_pre_cost_commiss_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_8 as $row_se_set)
	{
		$id8=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 );
		//$sql_insert_88="insert into wo_pre_cost_commiss_cost_dtls (id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount,inserted_by,insert_date,status_active,is_deleted) select $id8,'".$main_job_no."',particulars_id,commission_base_id,commision_rate,commission_amount,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active,is_deleted from wo_pre_cost_commiss_cost_dtls where job_no = '$popup_job_no'  and id=".$row_se_set[csf('id')]." ";
		 $sql_insert_88="insert into wo_pre_cost_commiss_cost_dtls (id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted)
		select $id8, '".$hidd_job_id."', '".$main_job_no."', particulars_id, commission_base_id, commision_rate, commission_amount, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from wo_pre_cost_commiss_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID8=execute_query($sql_insert_88,1);
		//echo $sql_insert_88;
	}
	//echo "10**".$rID2.'--'.$rID3.'--'.$rID4.'--'.$rID5.'--'.$rID6.'--'.$rID7.'--'.$rID8; die;
	//1--1--1--1--1----

	if($db_type==0)
	{
		if( $rID2 || $rID3 || $rID4 || $rID5 || $rID6 || $rID7 || $rID8 ){
			mysql_query("COMMIT");
			echo "0**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo "10**".$rID1;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if( $rID2 || $rID3 || $rID4 || $rID5 || $rID6 || $rID7 || $rID8 )
		{
			oci_commit($con);
			echo "0**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
		}
		else
		{
			oci_rollback($con);
			echo "10**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
		}
	}
	disconnect($con);
	die;

}
// END partial pre cost copy SAVE action here...............................

if($action=="check_data_mismass")
{
	$user_library=return_library_array( "select id, user_name from user_passwd", "id", "user_name");

	$isorder_change=return_field_value("isorder_change","wo_pre_cost_mst","job_no='".$data."' and is_deleted=0 and status_active=1");
	if($isorder_change==1)
	{
		$sql_check=sql_select("select Max(a.update_date) as cst_update_date, Max(a.updated_by) as cst_updated_by,   Max(b.update_date) as fct_update_date, Max(b.updated_by) as fct_updated_by,Max(b.is_apply_last_update) as is_apply_last_update from wo_po_color_size_breakdown a, wo_pre_cost_fabric_cost_dtls b where a.job_no_mst=b.job_no and a.job_no_mst='$data' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no_mst");

		$chk_msg='';
		foreach($sql_check as $check_row)
		{
			if($check_row[csf("is_apply_last_update")]==2)
			{
				$check_input=1;$fabric_msg=" Fabric, Yarn, ";$chk_msg=1;
				$cst_update_date=date('d-m-Y',strtotime($check_row[csf("cst_update_date")]));
				$cst_update_time = date('g:i:s A',strtotime($check_row[csf("cst_update_date")]));
				$fct_update_date=date('d-m-Y',strtotime($check_row[csf("fct_update_date")]));
				$fct_update_time = date('g:i:s A',strtotime($check_row[csf("fct_update_date")]));

				$pre_cost_up="";
				if($check_row[csf("fct_update_date")] !="" && $check_row[csf("fct_update_date")] !="0000-00-00" && $check_row[csf("fct_update_date")] !="0")
				{
					$pre_cost_up="PreCost is updated by ".ucfirst($user_library[$check_row[csf("fct_updated_by")]])." at ".$fct_update_time.", on ".$fct_update_date;
				}

				$sms="".ucfirst($user_library[$check_row[csf("cst_updated_by")]])." has changed Color Size Break Down at ".$cst_update_time.", on ".$cst_update_date.",".$pre_cost_up." So You have to update Pre-cost:";

				echo "document.getElementById('check_sms').innerHTML = '".$sms."';\n";
				echo "document.getElementById('check_input').value = '".$check_input."';\n";
			}
			else
			{
				$sms="";$fabric_msg="";
				$check_input=0;
				echo "document.getElementById('check_input').value = '".$check_input."';\n";
				echo "document.getElementById('check_sms').innerHTML = '".$sms."';\n";
			}
		}
		//Fabric ,Trims,Emblishment,Wash Synchronize check//If color size breakdown updated found
		$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_trim_cost_dtls b where  b.job_no='$data' and b.is_deleted=0 and b.status_active=1");

		$trim_msg="";
		foreach($sql_trim as $row)
		{
			if($row[csf("is_apply_last_update")]==2)
			{
				$trim_msg=" Trims,";
				$chk_msg=1;
			}
		}
		$sql_conv=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fab_conv_cost_dtls b where  b.job_no='$data' and b.is_deleted=0 and b.status_active=1");

		$conv_msg="";
		foreach($sql_conv as $row)
		{
			if($row[csf("is_apply_last_update")]==2)
			{
				$conv_msg=" Conversion,";
				$chk_msg=1;
			}
		}

		$sql_embl=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update,emb_name  from wo_pre_cost_embe_cost_dtls b where  b.job_no='$data' and b.is_deleted=0 and b.status_active=1 and cons_dzn_gmts>0 group by emb_name");

		$emb_msg="";
		foreach($sql_embl as $row)
		{
			if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]==3) //Wash
			{
				$wash_msg=" Wash,";
				$chk_msg=1;
			}
			else if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]!=3)
			{
				$emb_msg=" Emblishment,";
				$chk_msg=1;
			}
		}
		if($chk_msg==1)
		{
			$check_msg="Color size breakdown is updated. please Synchronize following heads: ";
			$check_msg.=$fabric_msg.$conv_msg.$trim_msg.$emb_msg.$wash_msg;
			echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
		}
		else
		{
			$check_msg="";
			echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
		}
	}
	exit();
}

if($action=="open_set_list_view")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
	function js_set_value_set()
	{
		var rowCount = $('#tbl_set_details tr').length-1;
		var set_breck_down="";
		var smv_breck_down="";
		var item_id=""
		for(var i=1; i<=rowCount; i++)
		{
			if (form_validation('cboitem_'+i+'*txtsetitemratio_'+i,'Gmts Items*Set Ratio')==false)
			{
				return;
			}
			if(smv_breck_down=="")
			{
				smv_breck_down+=$('#cboitem_'+i).val()+'_'+$('#smv_'+i).val()+'_'+$('#smvset_'+i).val();
			}
			else
			{
				smv_breck_down+="__"+$('#cboitem_'+i).val()+'_'+$('#smv_'+i).val()+'_'+$('#smvset_'+i).val();
			}
		}
		var job_no=document.getElementById('job_no').value;
		var setRatio=document.getElementById('tot_set_qnty').value;
		var setSmv=document.getElementById('tot_smv_qnty').value;
		var booking=return_global_ajax_value(job_no+"**"+setRatio+"**"+setSmv+"**"+smv_breck_down, 'update_smv', '', 'pre_cost_entry_controller_v2');
		document.getElementById('set_breck_down').value=smv_breck_down;
		parent.emailwindow.hide();
	}

	function calculate_set_smv(i)
	{
		var txtsetitemratio=document.getElementById('txtsetitemratio_'+i).value;
		var smv=document.getElementById('smv_'+i).value;
		var set_smv=txtsetitemratio*smv;
		document.getElementById('smvset_'+i).value=set_smv;
		set_sum_value_set( 'tot_set_qnty', 'txtsetitemratio_' );
		set_sum_value_set( 'tot_smv_qnty', 'smvset_' );
	}

	function set_sum_value_set(des_fil_id,field_id)
	{
		var rowCount = $('#tbl_set_details tr').length-1;
		var ddd={ dec_type:1, comma:0, currency:1}
		if(des_fil_id=="tot_set_qnty") math_operation( des_fil_id, field_id, '+', rowCount );
		if(des_fil_id=="tot_smv_qnty") math_operation( des_fil_id, field_id, '+', rowCount,ddd );
	}
	</script>
	</head>
	<body>
       <div id="set_details"  align="center">
        <fieldset>
            <form id="setdetails_1" autocomplete="off">
            <input type="hidden" id="set_breck_down" />
            <input type="hidden" id="item_id" />
            <input type="hidden" id="job_no" value="<? echo $txt_job_no; ?>" />
            <table width="400" cellspacing="0" class="rpt_table" border="0" id="tbl_set_details" rules="all">
                <thead>
                    <tr>
                        <th width="230">Item</th><th width="40">Set Ratio</th><th width="40">SMV/ Pcs</th><th width=""></th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $tot_set_qnty=0; $tot_smv_qnty=0;
                    $data_array=explode("__",$set_breck_down);

                    $data_array=sql_select("Select gmts_item_id, set_item_ratio, smv_pcs, smv_set, smv_pcs_precost, smv_set_precost from wo_po_details_mas_set_details where job_no='$txt_job_no'");

                    if ( count($data_array)>0)
                    {
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							//$data=explode('_',$row);
							$smv_pcs_precost=0; $smv_set_precost=0;
							$tot_set_qnty=$tot_set_qnty+$row[csf("set_item_ratio")];
							if($row[csf("smv_set_precost")]>0 || $row[csf("smv_pcs_precost")]>0)
							{
								$smv_pcs_precost=$row[csf("smv_pcs_precost")];
								$smv_set_precost=$row[csf("smv_set_precost")];
								$tot_smv_qnty=$tot_smv_qnty+$row[csf("smv_set_precost")];
							}
							else
							{
								$smv_pcs_precost=$row[csf("smv_pcs")];
								$smv_set_precost=$row[csf("smv_set")];
								$tot_smv_qnty=$tot_smv_qnty+$row[csf("smv_set")];
							}
							?>
							<tr id="settr_1" align="center">
                                <td><? echo create_drop_down( "cboitem_".$i, 230, $garments_item, "",1,"-- Select Item --", $row[csf("gmts_item_id")], "",1,'' ); ?></td>
                                <td><input type="text" id="txtsetitemratio_<? echo $i;?>"   name="txtsetitemratio_<? echo $i;?>" style="width:80px"  class="text_boxes_numeric"   value="<? echo $row[csf("set_item_ratio")]; ?>"  readonly/></td>
                                <td>
                                    <input type="text" id="smv_<? echo $i;?>" name="smv_<? echo $i;?>" style="width:30px" class="text_boxes_numeric" onChange="calculate_set_smv(<? echo $i;?>)"  value="<? echo $smv_pcs_precost; ?>" disabled />
                                    <input type="hidden" id="smvset_<? echo $i;?>"   name="smvset_<? echo $i;?>" style="width:30px"  class="text_boxes_numeric"  value="<? echo $smv_set_precost; ?>" />
                                </td>
							</tr>
							<?
						}
                    }
                    else
                    {
						?>
						<tr id="settr_1" align="center">
							<td><? echo create_drop_down( "cboitem_1", 230, $garments_item, "",1,"--Select--", 0, '',1,'' ); ?></td>
							<td><input type="text" id="txtsetitemratio_1" name="txtsetitemratio_1" style="width:80px" class="text_boxes_numeric"  readonly /></td>
							<td>
                                <input type="text" id="smv_1" name="smv_1" style="width:30px" class="text_boxes_numeric" onChange="calculate_set_smv(1)"/>
                                <input type="hidden" id="smvset_1" name="smvset_1" style="width:30px" class="text_boxes_numeric"   value=""  />
							</td>
							<td>&nbsp;</td>
						</tr>
						<?
                    }
                    ?>
                </tbody>
            </table>
            <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="230">Total</th>
                        <th width="40"><input type="text" id="tot_set_qnty" name="tot_set_qnty"  class="text_boxes_numeric" style="width:80px"  value="<? echo $tot_set_qnty; ?>" readonly  /></th>
                        <th width="40"><input type="text" id="tot_smv_qnty" name="tot_smv_qnty" class="text_boxes_numeric" style="width:30px"  value="<? if($tot_smv_qnty !=''){ echo $tot_smv_qnty;} else{ echo 1;} ?>" readonly /></th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="400" cellspacing="0" class="" border="0">
                <tr><td align="center" height="15" width="100%">&nbsp;</td></tr>
                <tr>
                    <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value_set()"/></td>
                </tr>
            </table>
            </form>
        </fieldset>
        </div>
	 </body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=='update_smv')
{
	$data=explode("**",$data);
	$setRatio=$data[1];
	$setSmv=$data[2];

	$data_array=explode("__",$data[3]);
	if ( count($data_array)>0)
	{
		$i=0;
		foreach( $data_array as $row )
		{
			$i++;
			$data_smv=explode('_',$row);
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$rID_de1=execute_query( "update wo_po_details_mas_set_details set smv_pcs_precost='$data_smv[1]',smv_set_precost='$data_smv[2]',smv_pcs='$data_smv[1]',smv_set='$data_smv[2]'  where  job_no ='".$data[0]."' and gmts_item_id=".$data_smv[0]."",0);
			if($db_type==0)
			{
				if($rID_de1==1){
					mysql_query("COMMIT");
					//echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					mysql_query("ROLLBACK");
					//echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID_de1==1){
					oci_commit($con);
					//echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					oci_rollback($con);
					//echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			disconnect($con);
		}
	}

	$job_no="'".$data[0]."'";

	$sql_d=sql_select('Select gmts_item_id AS "gmts_item_id",set_item_ratio AS "set_item_ratio",smv_pcs AS "smv_pcs",smv_set AS "smv_set",complexity AS "complexity",embelishment AS "embelishment", cutsmv_pcs AS "cutsmv_pcs", cutsmv_set AS "cutsmv_set", finsmv_pcs AS "finsmv_pcs", finsmv_set AS "finsmv_set",printseq AS "printseq",embro AS "embro",embroseq AS "embroseq",wash AS "wash",washseq AS "washseq",spworks AS "spworks" ,spworksseq AS "spworksseq",gmtsdying AS "gmtsdying",gmtsdyingseq AS "gmtsdyingseq",ws_id as "ws_id" from wo_po_details_mas_set_details where job_no='.$job_no.' order by id');
	foreach($sql_d as $sql_r){
		if($sql_r['gmts_item_id']=="") $sql_r['gmts_item_id']=0;
		if($sql_r['set_item_ratio']=="") $sql_r['set_item_ratio']=0;
		if($sql_r['smv_pcs']=="") $sql_r['smv_set']=0;
		if($sql_r['complexity']=="") $sql_r['complexity']=0;
		if($sql_r['embelishment']=="") $sql_r['embelishment']=0;
		if($sql_r['cutsmv_pcs']==""){
			$sql_r['cutsmv_pcs']=0;
			$sql_r['cutsmv_set']=0;
		}
		if($sql_r['finsmv_pcs']==""){
			$sql_r['finsmv_pcs']=0;
			$sql_r['finsmv_set']=0;
		}
		if($sql_r['printseq']=="") $sql_r['printseq']=0;
		if($sql_r['embro']=="") $sql_r['embro']=0;
		if($sql_r['embroseq']=="") $sql_r['embroseq']=0;

		if($sql_r['wash']=="") $sql_r['wash']=0;
		if($sql_r['washseq']=="") $sql_r['washseq']=0;

		if($sql_r['spworks']=="") $sql_r['spworks']=0;
		if($sql_r['spworksseq']=="") $sql_r['spworksseq']=0;

		if($sql_r['gmtsdying']=="") $sql_r['gmtsdying']=0;
		if($sql_r['gmtsdyingseq']=="") $sql_r['gmtsdyingseq']=0;
		if($sql_r['ws_id']=="") $sql_r['ws_id']=0;

		$sql_r=removenumeric($sql_r);
		$smv_arr[]=implode("_",$sql_r);
	}
	$smv_srt=rtrim(implode("__",$smv_arr),"__");
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID3=execute_query("update wo_po_details_master set set_break_down='$smv_srt', total_set_qnty='$setRatio', set_smv='$setSmv' where  job_no =".$job_no."",1);
	if($db_type==0)
	{
		if($rID3==1){
			mysql_query("COMMIT");
		}
		else{
			mysql_query("ROLLBACK");
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID3==1){
			oci_commit($con);
		}
		else{
			oci_rollback($con);
		}
	}
	disconnect($con);
}

if($action=='is_used_costing_per')
{
	$data=explode("**", $data);
	$sql_data=sql_select("select count(a.id) as id, a.costing_per from  wo_pre_cost_mst a, wo_pre_cost_fabric_cost_dtls b, wo_pre_cost_dtls c where a.job_no=b.job_no and a.job_no=c.job_no and a.job_no='$data[0]' and a.is_deleted=0 and  a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no,a.costing_per");
	$id=0;
	$costing_per=0;
	foreach($sql_data as $row)
	{
		$id=$row[csf('id')];
		$costing_per=$row[csf('costing_per')];
	}
	if(($data[1]==$costing_per) || ($data[2]!=1))
	{
		echo "0_".trim($costing_per);
	}
	else
	{
		echo trim($id)."_".trim($costing_per);
	}
	//echo trim($id)."_".trim($costing_per);
	die;
}

if($action=='is_booking_found')
{
	$sql_data=sql_select("select count(a.id) as id,a.booking_no from  wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and a.booking_no=b.booking_no  and a.job_no='$data' and a.is_deleted=0 and  a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.booking_no");
	$id=0;
	$booking_no=array();
	foreach($sql_data as $row)
	{
		$id=$row[csf('id')];
		$booking_no[]=$row[csf('booking_no')];
	}
	echo trim($id)."_".implode(",",$booking_no);
	die;
}

if($action=='delete_costing')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID_de1=execute_query( "update wo_pre_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update wo_pre_cost_fabric_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'  and status_active=1 and is_deleted=0",0);

	$rID_de1=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'  and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'  and status_active=1 and is_deleted=0",0);

	$rID_de1=execute_query( "update wo_pre_cost_trim_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'  and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update wo_pre_cost_embe_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'  and status_active=1 and is_deleted=0",0);

	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if($action=='active_costing')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID_de1=execute_query( "update wo_pre_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update wo_pre_cost_fabric_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);

	$rID_de1=execute_query( "update wo_pre_cost_trim_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update wo_pre_cost_embe_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}

		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if($action=='delete_costing_permanently')
{
	$con = connect();
	if($db_type==0) mysql_query("BEGIN");

	$flag=1;

	$rID=execute_query( "update wo_pre_cost_fabric_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1  where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID==1 && $flag==1) $flag=1; else $flag=0;

	$rID0=execute_query( "update wo_pre_cos_fab_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID0==1 && $flag==1) $flag=1; else $flag=0;

	$rID1=execute_query( "update wo_pre_cos_fab_co_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID1==1 && $flag==1) $flag=1; else $flag=0;

	$rID2=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID2==1 && $flag==1) $flag=1; else $flag=0;

	$rID3=execute_query( "update wo_pre_cost_fab_yarnbreakdown set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID3==1 && $flag==1) $flag=1; else $flag=0;

	$rID4=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID4==1 && $flag==1) $flag=1; else $flag=0;

	$rID5=execute_query( "update wo_pre_cost_trim_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID5==1 && $flag==1) $flag=1; else $flag=0;

	$rID6=execute_query( "update wo_pre_cost_trim_co_cons_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID6==1 && $flag==1) $flag=1; else $flag=0;

	$rID7=execute_query( "update wo_pre_cost_embe_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID7==1 && $flag==1) $flag=1; else $flag=0;

	$rID8=execute_query( "update wo_pre_cos_emb_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID8==1 && $flag==1) $flag=1; else $flag=0;

	$rID9=execute_query( "update wo_pre_cost_comarci_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID9==1 && $flag==1) $flag=1; else $flag=0;

	$rID10=execute_query( "update wo_pre_cost_commiss_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID10==1 && $flag==1) $flag=1; else $flag=0;

	$rID11=execute_query( "update wo_pre_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID11==1 && $flag==1) $flag=1; else $flag=0;

	$rID12=execute_query( "update wo_pre_cost_sum_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
	if($rID12==1 && $flag==1) $flag=1; else $flag=0;
	//echo "10**".$rID.'-'.$rID1.'-'.$rID2.'-'.$rID3.'-'.$rID4.'-'.$rID5.'-'.$rID6.'-'.$rID7.'-'.$rID8.'-'.$rID9.'-'.$rID10.'-'.$rID11.'-'.$rID12; die;

	if($db_type==0)
	{
		if($flag==1)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if($action=='check_is_master_part_saved')
{
	$job_no=return_field_value("job_no", "wo_pre_cost_mst","job_no='$data' and status_active =1 and is_deleted=0");
	echo $job_no;
}

if ($action=="save_update_delete")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$date= date('Y-m-d');

	/*$copy_quotation=return_field_value("copy_quotation", "variable_order_tracking", "company_name=$cbo_company_name  and variable_list=20  and status_active=1 and is_deleted=0");*/
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	if(str_replace("'","",$cbo_ready_to_approved)==1)// Pls Dont change any info--if need pls contract with kausar
	{
		$style_smv_source=return_field_value("publish_shipment_date", "variable_order_tracking", "company_name=$cbo_company_name and variable_list=47 and status_active=1 and is_deleted=0");
		if($style_smv_source==7 || $style_smv_source==8  || $style_smv_source==3)
		{
			if(str_replace("'","",$txt_quotation_id)=="" || str_replace("'","",$txt_quotation_id)==0)
			{
				echo "quickcostingtag**".str_replace("'","",$txt_job_no);
				disconnect($con);die;
			}
		}
		if(str_replace("'","",$txt_cost_control_source)==1)
		{
			if($style_smv_source==7 || $style_smv_source==8 || $style_smv_source==3)
			{
				$is_approved=0;
				$approved_sql=sql_select("select approved from qc_confirm_mst where cost_sheet_id=$txt_quotation_id  and is_deleted=0 and status_active=1");
				$is_approved=$approved_sql[0][csf('approved')];
				if($is_approved!=1){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
		if($operation==1){
			$isorder_change=return_field_value("isorder_change","wo_pre_cost_mst","job_no=".$txt_job_no." and is_deleted=0 and status_active=1");
			if($isorder_change==1)
			{
				$sql_check=sql_select("SELECT a.job_no_mst, Max(b.is_apply_last_update) as is_apply_last_update from wo_po_color_size_breakdown a, wo_pre_cost_fabric_cost_dtls b where a.job_no_mst=b.job_no and a.job_no_mst=$txt_job_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no_mst");

				$chk_msg='';
				foreach($sql_check as $check_row)
				{
					if($check_row[csf("is_apply_last_update")]==2)
					{
						$chk_msg=1;
					}
				}
				//Fabric ,Trims,Emblishment,Wash Synchronize check//If color size breakdown updated found
				$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_trim_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");

				$trim_msg="";
				foreach($sql_trim as $row)
				{
					if($row[csf("is_apply_last_update")]==2)
					{
						$chk_msg=1;
					}
				}
				$sql_conv=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fab_conv_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");

				$conv_msg="";
				foreach($sql_conv as $row)
				{
					if($row[csf("is_apply_last_update")]==2)
					{
						$conv_msg=" Conversion,";
						$chk_msg=1;
					}
				}

				$sql_embl=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update,emb_name  from wo_pre_cost_embe_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1 and cons_dzn_gmts>0 group by emb_name");

				$emb_msg="";
				foreach($sql_embl as $row)
				{
					if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]==3) //Wash
					{
						$wash_msg=" Wash,";
						$chk_msg=1;
					}
					else if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]!=3)
					{
						$emb_msg=" Emblishment,";
						$chk_msg=1;
					}
				}
				if($chk_msg==1)
				{
					echo "synchronize**0"; disconnect($con);die;
				}
			}
		}
	}

	if ($operation==0)  // Insert Here
	{
		if (is_duplicate_field( "job_no", "wo_pre_cost_mst", "job_no=$txt_job_no and is_deleted=0 and status_active=1" ) == 1)
		{
			echo "11**0"; disconnect($con);die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$id=return_next_id( "id", "wo_pre_cost_mst", 1 );
			$comp_id=return_next_id( "id", "precost_component_app_mst", 1 );
			$field_array="id, garments_nature, job_id, job_no, costing_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, copy_quatation, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, sew_efficiency_source, remarks, ready_to_approved, budget_minute, entry_from,refusing_cause, inserted_by, insert_date, status_active, is_deleted";
			$data_array="(".$id.",".$garments_nature.",".$hidd_job_id.",".$txt_job_no.",".$txt_costing_date.",".$cbo_inco_term.",".$txt_incoterm_place.",".$txt_machine_line.",".$txt_prod_line_hr.",".$cbo_costing_per.",".$copy_quatation_id.",".$cm_cost_predefined_method_id.",".$txt_exchange_rate.",".$txt_sew_smv.",".$txt_cut_smv.",".$txt_sew_efficiency_per.",".$txt_cut_efficiency_per.",".$txt_efficiency_wastage.",".$txt_sew_efficiency_source.",".$txt_remarks.",".$cbo_ready_to_approved.",".$txt_budget_minute.",'158',".$txt_refusing.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."','1','0')";

			if($is_component_app==1)
			{
			$field_array_compo="id,job_id,entry_form,cost_component_id,ready_to_approved";
			$k=1;
			foreach($cost_components as $comp_key=>$val) //As per Bearsh Vi
			{
				if ($k!=1) $data_array_comp .=",";
			 $data_array_comp .="(".$comp_id.",".$hidd_job_id.",11,".$comp_key.",".$cbo_ready_to_approved.")";
			 //echo $data_array2;
			 $comp_id=$comp_id+1;
			 $k++;
			}
			//  echo "10**Insert into component_wise_precosting_approval_mst ($field_array_compo) values $data_array_comp"; die;
			$rID=sql_insert("precost_component_app_mst",$field_array_compo,$data_array_comp,1);
			}

			$rID=sql_insert("wo_pre_cost_mst",$field_array,$data_array,1);
			//$rID3=execute_query( "update  wo_po_details_master set set_smv=$txt_sew_smv  where  job_no =".$txt_job_no."",1);

			if($db_type==0)
			{
				if($rID==1){
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
				}
				else{
					mysql_query("ROLLBACK");
					echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID==1){
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
				}
				else{
					oci_rollback($con);
					echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
				}
			}
			disconnect($con);
			die;
		}
	}
	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approved=0; $ready_to_approve=0;
		$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$txt_job_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
			$approved=$row[csf('approved')];
			$ready_to_approve=$row[csf('ready_to_approved')];
		}

		$insDate="15-May-2020";

		$isBomInsDate=return_field_value("job_no", "wo_pre_cost_mst", "job_no=$txt_job_no and insert_date>'$insDate' and status_active=1 and is_deleted=0");
		/*echo "10**".$isBomInsDate;
		echo "select job_no from wo_pre_cost_mst where job_no='$jobNo' and insert_date<'$insDate' and status_active=1 and is_deleted=0";
		die;*/

		$imageArray=sql_select( "select id, image_location, master_tble_id, details_tble_id, form_name, file_type, real_file_name from common_photo_library where master_tble_id=$pre_cost_id and form_name='pre_cost_v2' and file_type=2" );

		if($_SESSION['logic_erp']['mandatory_field'][158][5] != '' && count($imageArray) == 0 && str_replace("'","",$cbo_ready_to_approved)==1 && str_replace("'","",$txt_fabric_pre_cost)>0 && $isBomInsDate!="")
		{
			echo "file**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}


		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		if($approved==3){
			echo "papproved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		if($ready_to_approve==1){
			echo "readyapproved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		$sql_v=sql_select("select variable_list, cost_control_source, budget_exceeds_quot from variable_order_tracking where company_name=$cbo_company_name and variable_list in (37,53) and status_active=1 and is_deleted=0");
		$cost_control_source=0; $budget_exceeds_quot=0;
		foreach($sql_v as $row){
			if($row[csf('variable_list')]==37) $budget_exceeds_quot=$row[csf('budget_exceeds_quot')];
			if($row[csf('variable_list')]==53) $cost_control_source=$row[csf('cost_control_source')];
		}

		if($budget_exceeds_quot!=1 && $cost_control_source==2)
		{
			$copy_quatation=0;
			$quotation_id=0;
			$ready_to_approved=str_replace("'","",$cbo_ready_to_approved);
			$sql=sql_select("select a.copy_quatation,b.quotation_id from wo_pre_cost_mst a, wo_po_details_master b where a.job_no=b.job_no and  a.job_no=$txt_job_no");
			foreach($sql as $row){
				$copy_quatation=$row[csf('copy_quatation')];
				$quotation_id=$row[csf('quotation_id')];
			}
			if($copy_quatation==1 && $ready_to_approved==1)
			{
				$sql_fab=sql_select("select job_no ,sum(amount) as avg_cons from wo_pre_cost_fabric_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
				$fabQtyPre=0;
				foreach($sql_fab as $row_fab){
					$fabQtyPre=$row_fab[csf('avg_cons')]*1;
				}
				$sql_fab=sql_select("select quotation_id, sum(amount) as avg_cons from wo_pri_quo_fabric_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
				$fabQtyPri=0;
				foreach($sql_fab as $row_fab){
					$fabQtyPri=$row_fab[csf('avg_cons')]*1;
				}
				$sql_fab_conversion=sql_select("select quotation_id, sum(amount) as avg_cons from wo_pri_quo_fab_conv_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
				foreach($sql_fab_conversion as $row_fab){
					$fabQtyPri += $row_fab[csf('avg_cons')]*1;
				}
				//if($fabQtyPri >0 && $fabQtyPre <=0)
				if($fabQtyPri>0)
				{
					if($fabQtyPri<$fabQtyPre){
						echo "FabApp**".str_replace("'","",$txt_job_no).'**'.$fabQtyPri.'**'.$fabQtyPre;
						disconnect($con);die;
					}
				}

				$sql_yarn=sql_select("select job_no,sum(amount) as cons_qnty from wo_pre_cost_fab_yarn_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
				$yarQtyPre=0;
				foreach($sql_yarn as $row_yarn){
					$yarQtyPre=$row_yarn[csf('cons_qnty')]*1;
				}

				$sql_yar=sql_select("select quotation_id,sum(amount) as cons_qnty from wo_pri_quo_fab_yarn_cost_dtls where quotation_id=$quotation_id  and status_active=1 and is_deleted=0 group by quotation_id");
				$yarQtyPri=0;

				foreach($sql_yar as $row_yarn){
					$yarQtyPri=$row_yarn[csf('cons_qnty')]*1;
				}
				if($yarQtyPri>0)
				{
					//if( $yarQtyPri >0 && $yarQtyPre <=0)
					if( $yarQtyPri<$yarQtyPre){
						echo "YarApp**".str_replace("'","",$txt_job_no).'**'.$yarQtyPri.'**'.$yarQtyPre;
						disconnect($con);die;
					}
				}


				$sql_con=sql_select("select job_no, sum(amount) as req_qnty from wo_pre_cost_fab_conv_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
				$conQtyPre=0;
				foreach($sql_con as $row_con){
					$conQtyPre=$row_con[csf('req_qnty')]*1;
				}

				$sql_con=sql_select("select quotation_id, sum(amount) as req_qnty from wo_pri_quo_fab_conv_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
				$conQtyPri=0;
				foreach($sql_con as $row_con){
					$conQtyPri=$row_con[csf('req_qnty')]*1;
				}
				//if( $conQtyPri >0 && $conQtyPre <=0)
				if($conQtyPri>0)
				{
					if( $conQtyPri<$conQtyPre){
						echo "ConApp**".str_replace("'","",$txt_job_no).'**'.$conQtyPri."**".$conQtyPre;
						disconnect($con);die;
					}
				}

				$sql_tri=sql_select("select job_no,sum(amount) as cons_dzn_gmts from wo_pre_cost_trim_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
				$triQtyPre=0;
				foreach($sql_tri as $row_tri){
					$triQtyPre=$row_tri[csf('cons_dzn_gmts')]*1;
				}

				$sql_tri=sql_select("select quotation_id,sum(amount) as cons_dzn_gmts from wo_pri_quo_trim_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
				$triQtyPri=0;
				foreach($sql_tri as $row_tri){
					$triQtyPri=$row_tri[csf('cons_dzn_gmts')]*1;
				}
				//if($triQtyPri >0 && $triQtyPre <=0)
				if($triQtyPri>0)
				{
					if($triQtyPri<$triQtyPre){
						echo "TriApp**".str_replace("'","",$txt_job_no).'**'.$triQtyPri."**".$triQtyPre;
						disconnect($con);die;
					}
				}

				$sql_emb=sql_select("select job_no,sum(amount) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no=$txt_job_no and emb_name!=3 and status_active=1 and is_deleted=0 group by job_no");
				$embQtyPre=0;
				foreach($sql_emb as $row_emb){
					$embQtyPre=$row_emb[csf('cons_dzn_gmts')]*1;
				}

				$sql_emb=sql_select("select quotation_id,sum(amount) as cons_dzn_gmts from wo_pri_quo_embe_cost_dtls where quotation_id=$quotation_id and emb_name!=3 and status_active=1 and is_deleted=0 group by quotation_id");
				$embQtyPri=0;
				foreach($sql_emb as $row_emb){
					$embQtyPri=$row_emb[csf('cons_dzn_gmts')]*1;
				}
				//if( $embQtyPri >0 && $embQtyPre <=0)
				if($embQtyPri>0)
				{
					if( $embQtyPri<$embQtyPre){
						echo "EmbApp**".str_replace("'","",$txt_job_no).'**'.$embQtyPri."**".$embQtyPre;
						disconnect($con);die;
					}
				}


				$sql_was=sql_select("select job_no,sum(amount) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no=$txt_job_no and emb_name =3 and status_active=1 and is_deleted=0 group by job_no");
				$wasQtyPre=0;
				foreach($sql_was as $row_was){
					$wasQtyPre=$row_was[csf('cons_dzn_gmts')]*1;
				}

				$sql_was=sql_select("select quotation_id,sum(amount) as cons_dzn_gmts from wo_pri_quo_embe_cost_dtls where quotation_id=$quotation_id and emb_name =3 and status_active=1 and is_deleted=0 group by quotation_id");
				$wasQtyPri=0;
				foreach($sql_was as $row_was){
					$wasQtyPri=$row_was[csf('cons_dzn_gmts')]*1;
				}
				//if($wasQtyPri >0 && $wasQtyPre <=0)
				if($wasQtyPri>0)
				{
					if($wasQtyPri<$wasQtyPre){
						echo "WasApp**".str_replace("'","",$txt_job_no).'**'.$wasQtyPri."**".$wasQtyPre;
						disconnect($con);die;
					}
				}

				$sql_comn=sql_select("select job_no,sum(commission_amount) as commission_amount from wo_pre_cost_commiss_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
				$comnQtyPre=0;
				foreach($sql_comn as $row_comn){
					$comnQtyPre=$row_comn[csf('commission_amount')]*1;
				}

				$sql_comn=sql_select("select quotation_id,sum(commission_amount) as commission_amount from wo_pri_quo_commiss_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
				$comnQtyPri=0;
				foreach($sql_comn as $row_comn){
					$comnQtyPri=$row_comn[csf('commission_amount')]*1;
				}
				//if( $comnQtyPri >0 && $comnQtyPre <=0)
				if($comnQtyPri>0)
				{
					if( $comnQtyPri<$comnQtyPre){
						echo "ComnApp**".str_replace("'","",$txt_job_no).'**'.$comnQtyPri."**".$comnQtyPre;
						disconnect($con);die;
					}
				}

				$sql_comm=sql_select("select job_no,sum(amount) as amount from wo_pre_cost_comarci_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
				$commQtyPre=0;
				foreach($sql_comm as $row_comm){
					$commQtyPre=$row_comm[csf('amount')]*1;
				}

				$sql_comm=sql_select("select quotation_id,sum(amount) as amount from wo_pri_quo_comarcial_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
				$commQtyPri=0;
				foreach($sql_comm as $row_comm){
					$commQtyPri=$row_comm[csf('amount')]*1;
				}

				//if( $commQtyPri >0 && $commQtyPre <=0)
				if($commQtyPri>0)
				{
					if( $commQtyPri<$commQtyPre){
						echo "CommApp**".str_replace("'","",$txt_job_no).'**'.$commQtyPri."**".$commQtyPre;
						disconnect($con);die;
					}
				}

				$lab_test=0; $inspection=0; $cm_cost=0; $freight=0; $currier_pre_cost=0; $certificate_pre_cost=0; $common_oh=0; $depr_amor_pre_cost=0; $interest_cost=0; $incometax_cost=0;

				//$deffdlc_cost=0;

				$sql_oth=sql_select("select job_no, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, common_oh, depr_amor_pre_cost, deffdlc_cost, interest_cost, incometax_cost from wo_pre_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0");
				foreach($sql_oth as $oth_row){
					$lab_test=$oth_row[csf('lab_test')]*1;
					$inspection=$oth_row[csf('inspection')]*1;
					$cm_cost=$oth_row[csf('cm_cost')]*1;
					$freight=$oth_row[csf('freight')]*1;
					$currier_pre_cost=$oth_row[csf('currier_pre_cost')]*1;
					$certificate_pre_cost=$oth_row[csf('certificate_pre_cost')]*1;
					$common_oh=$oth_row[csf('common_oh')]*1;
					$depr_amor_pre_cost=$oth_row[csf('depr_amor_pre_cost')]*1;
					$interest_cost=$oth_row[csf('interest_cost')]*1;
					$incometax_cost=$oth_row[csf('incometax_cost')]*1;

					//$deffdlc_cost=$oth_row[csf('deffdlc_cost')];
				}

				$lab_test_pri=0; $inspection_pri=0; $cm_cost_pri=0; $freight_pri=0; $currier_pre_cost_pri=0; $certificate_pre_cost_pri=0; $common_oh_pri=0; $depr_amor_pre_cost_pri=0; $interest_cost_pri=0; $incometax_cost_pri=0;

				//$deffdlc_cost_pri=0;
				$sql_oth=sql_select("select quotation_id, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, common_oh, depr_amor_pre_cost, interest_pre_cost, income_tax_pre_cost from wo_price_quotation_costing_mst where quotation_id = $quotation_id and status_active=1 and is_deleted=0");
				foreach($sql_oth as $oth_row){
					$lab_test_pri=$oth_row[csf('lab_test')]*1;
					$inspection_pri=$oth_row[csf('inspection')]*1;
					$cm_cost_pri=$oth_row[csf('cm_cost')]*1;
					$freight_pri=$oth_row[csf('freight')]*1;
					$currier_pre_cost_pri=$oth_row[csf('currier_pre_cost')]*1;
					$certificate_pre_cost_pri=$oth_row[csf('certificate_pre_cost')]*1;
					$common_oh_pri=$oth_row[csf('common_oh')]*1;
					$depr_amor_pre_cost_pri=$oth_row[csf('depr_amor_pre_cost')]*1;
					$interest_cost_pri=$oth_row[csf('interest_pre_cost')]*1;
					$incometax_cost_pri=$oth_row[csf('income_tax_pre_cost')]*1;
					//$deffdlc_cost_pri=$oth_row[csf('deffdlc_cost')];
				}

				//if( $lab_test_pri >0 && $lab_test <=0)
				if($lab_test_pri>0)
				{
					if( $lab_test_pri<$lab_test){
						echo "LabApp**".str_replace("'","",$txt_job_no).'**'.$lab_test_pri."**".$lab_test;
						disconnect($con);die;
					}
				}

				//if( $inspection_pri >0 &&  $inspection <=0)
				if($inspection_pri>0)
				{
					if( $inspection_pri<$inspection){
						echo "InspApp**".str_replace("'","",$txt_job_no).'**'.$inspection_pri."**".$inspection;
						disconnect($con);die;
					}
				}

				//if( $cm_cost_pri >0 && $cm_cost <=0)
				if($cm_cost_pri>0)
				{
					if( $cm_cost_pri<$cm_cost){
						echo "CmApp**".str_replace("'","",$txt_job_no).'**'.$cm_cost_pri."**".$cm_cost;
						disconnect($con);die;
					}
				}

				//if( $freight_pri >0 && $freight <=0)
				if($freight_pri>0)
				{
					if( $freight_pri<$freight){
						echo "FreApp**".str_replace("'","",$txt_job_no).'**'.$freight_pri."**".$freight;
						die;
					}
				}

				//if( $currier_pre_cost_pri >0 && $currier_pre_cost <=0)
				if($currier_pre_cost_pri>0)
				{
					if( $currier_pre_cost_pri<$currier_pre_cost){
						echo "CurrApp**".str_replace("'","",$txt_job_no).'**'.$currier_pre_cost_pri."**".$currier_pre_cost;
						disconnect($con);die;
					}
				}

				//if( $certificate_pre_cost_pri >0 && $certificate_pre_cost <=0)
				if($certificate_pre_cost_pri>0)
				{
					if( $certificate_pre_cost_pri<$certificate_pre_cost){
						echo "CertApp**".str_replace("'","",$txt_job_no).'**'.$certificate_pre_cost_pri."**".$certificate_pre_cost;
						disconnect($con);die;
					}
				}
				//if( $common_oh_pri >0 && $common_oh <=0)
				if($common_oh_pri>0)
				{
					if( $common_oh_pri<$common_oh){
						echo "CoohApp**".str_replace("'","",$txt_job_no).'**'.$common_oh_pri."**".$common_oh;
						die;
					}
				}
				//if( $depr_amor_pre_cost_pri >0 && $depr_amor_pre_cost <=0)
				if($depr_amor_pre_cost_pri>0)
				{
					if( $depr_amor_pre_cost_pri<$depr_amor_pre_cost){
						echo "DeprApp**".str_replace("'","",$txt_job_no).'**'.$depr_amor_pre_cost_pri."**".$depr_amor_pre_cost;
						disconnect($con);die;
					}
				}
				//if( $interest_cost_pri >0 && $interest_cost <=0)
				if($interest_cost_pri>0)
				{
					if( $interest_cost_pri<$interest_cost){
						echo "InterApp**".str_replace("'","",$txt_job_no).'**'.$interest_cost_pri."**".$interest_cost;
						disconnect($con);die;
					}
				}
				//if( $incometax_cost_pri >0 && $incometax_cost <=0)
				if($incometax_cost_pri>0)
				{
					if( $incometax_cost_pri<$incometax_cost){
						echo "IncomApp**".str_replace("'","",$txt_job_no).'**'.$incometax_cost_pri."**".$incometax_cost;
						disconnect($con);die;
					}
				}
			}
		}

		$field_array="costing_date*incoterm*incoterm_place*machine_line*prod_line_hr*costing_per*copy_quatation*cm_cost_predefined_method_id*exchange_rate*sew_smv*cut_smv*sew_effi_percent*cut_effi_percent*efficiency_wastage_percent*sew_efficiency_source*remarks*ready_to_approved*budget_minute*refusing_cause*updated_by*update_date*isorder_change";
		$data_array="".$txt_costing_date."*".$cbo_inco_term."*".$txt_incoterm_place."*".$txt_machine_line."*".$txt_prod_line_hr."*".$cbo_costing_per."*".$copy_quatation_id."*".$cm_cost_predefined_method_id."*".$txt_exchange_rate."*".$txt_sew_smv."*".$txt_cut_smv."*".$txt_sew_efficiency_per."*".$txt_cut_efficiency_per."*".$txt_efficiency_wastage."*".$txt_sew_efficiency_source."*".$txt_remarks."*".$cbo_ready_to_approved."*".$txt_budget_minute."*".$txt_refusing."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'";

		$flag=1;
		if($is_component_app==1)
		{
			$component_data=sql_select("SELECT id from precost_component_app_mst where job_id =$hidd_job_id");
			if(count($component_data)>0){
				$k=1;
				foreach($cost_components as $comp_key=>$val) //As per Bearsh Vi
				{
					$rID=execute_query( "update precost_component_app_mst set ready_to_approved=".$cbo_ready_to_approved." where job_id =$hidd_job_id and cost_component_id ='$comp_key'",1);
					if($rID==1 && $flag==1) $flag=1; else $flag=0;
					$k++;
				}
			}
			else{
				$comp_id=return_next_id( "id", "precost_component_app_mst", 1 );
				$field_array_compo="id,job_id,entry_form,cost_component_id,ready_to_approved";
				$k=1;
				foreach($cost_components as $comp_key=>$val) //As per Bearsh Vi
				{
					if ($k!=1) $data_array_comp .=",";
					$data_array_comp .="(".$comp_id.",".$hidd_job_id.",11,".$comp_key.",".$cbo_ready_to_approved.")";
					$comp_id=$comp_id+1;
					$k++;
				}
				$rID1=sql_insert("precost_component_app_mst",$field_array_compo,$data_array_comp,1);
				if($rID1==1 && $flag==1) $flag=1; else $flag=0;
			}
		}

		$rID2=sql_update("wo_pre_cost_mst",$field_array,$data_array,"job_no*status_active*is_deleted","".$txt_job_no."*1*0",1);
		if($rID2==1 && $flag==1) $flag=1; else $flag=0;

		//$rID3=execute_query( "update wo_po_details_master set set_smv=$txt_sew_smv  where  job_no =".$txt_job_no."",1);
		//echo "10**".$txt_job_no; die;

		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)   // Update Here
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		$approved=0; $ready_to_approve=0;
		$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$txt_job_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
			$approved=$row[csf('approved')];
			$ready_to_approve=$row[csf('ready_to_approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		if($approved==3){
			echo "papproved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}

		if($ready_to_approve==1){
			echo "readyapproved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'*'1'";
		$flag=1;

		$rIDm=sql_delete("wo_pre_cost_mst",$field_array,$data_array,"job_no","".$txt_job_no."",1);
		if($rIDm==1 && $flag==1) $flag=1; else $flag=0;

		$flag=1;

		$data=str_replace("'","",$txt_job_no);

		$rID=execute_query( "update wo_pre_cost_fabric_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1  where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID==1 && $flag==1) $flag=1; else $flag=0;

		$rID0=execute_query( "update wo_pre_cos_fab_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID0==1 && $flag==1) $flag=1; else $flag=0;

		$rID1=execute_query( "update wo_pre_cos_fab_co_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID1==1 && $flag==1) $flag=1; else $flag=0;

		$rID2=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID2==1 && $flag==1) $flag=1; else $flag=0;

		$rID3=execute_query( "update wo_pre_cost_fab_yarnbreakdown set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID3==1 && $flag==1) $flag=1; else $flag=0;

		$rID4=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID4==1 && $flag==1) $flag=1; else $flag=0;

		$rID5=execute_query( "update wo_pre_cost_trim_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID5==1 && $flag==1) $flag=1; else $flag=0;

		$rID6=execute_query( "update wo_pre_cost_trim_co_cons_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID6==1 && $flag==1) $flag=1; else $flag=0;

		$rID7=execute_query( "update wo_pre_cost_embe_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID7==1 && $flag==1) $flag=1; else $flag=0;

		$rID8=execute_query( "update wo_pre_cos_emb_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID8==1 && $flag==1) $flag=1; else $flag=0;

		$rID9=execute_query( "update wo_pre_cost_comarci_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID9==1 && $flag==1) $flag=1; else $flag=0;

		$rID10=execute_query( "update wo_pre_cost_commiss_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID10==1 && $flag==1) $flag=1; else $flag=0;

		$rID11=execute_query( "update wo_pre_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID11==1 && $flag==1) $flag=1; else $flag=0;

		$rID12=execute_query( "update wo_pre_cost_sum_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID12==1 && $flag==1) $flag=1; else $flag=0;

		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "2**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1){
				oci_commit($con);
				echo "2**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==3)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//echo "1**select a.copy_quatation,b.quotation_id from wo_pre_cost_mst a, wo_po_details_master b where a.job_no=b.job_no and  a.job_no=$txt_job_no"; die;

		/*$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$txt_job_no");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			die;
		}*/

		$field_array="approved*approved_by*approved_date";
		if(trim(str_replace("'","",$cbo_approved_status))==2)
		{
			$data_array="'1'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
		}
		else
		{
			$data_array="'2'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
		}
		$rID=sql_update("wo_pre_cost_mst",$field_array,$data_array,"job_no",$txt_job_no,1);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "3**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "3**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		disconnect($con);
		die;
	}
}

//*************************************************Master Form End ***********************************************
//*************************************************Dtls Form Start ***********************************************
if ($action=="save_update_delete_quotation_entry_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);

	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	//============ Negative Margin Allow In Budget ============================
	$vari_nameArray=sql_select( "select STYLE_FROM_LIBRARY from  variable_order_tracking where company_name=$cbo_company_name and variable_list=86" );
	// echo "10**=select STYLE_FROM_LIBRARY from  variable_order_tracking where company_name='$cbo_company_name' and variable_list=86";die;
	$negative_margin_vari=1;
	foreach($vari_nameArray as $row){
		$negative_margin_vari=$row['STYLE_FROM_LIBRARY'];
	}
	$margin_dzn_pre_cost_chk=str_replace("'","",$txt_margin_dzn_pre_cost);

	if($operation==1 && count($vari_nameArray)>0)
	{
		if($negative_margin_vari==2 && $margin_dzn_pre_cost_chk<0){
			echo "negative**Negative margin not allow in budget";
			disconnect($con);die;
		}
	}

	$cm_for_shipment_sche = str_replace("'","", $txt_margin_dzn_pre_cost) +str_replace("'","", $txt_cm_pre_cost);
	$date= date('Y-m-d');
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");

		$confirm_id="";$del_confirm_id="";
		$del_count=0;
		$job_no_up=str_replace("'","",$update_id);
		$confirm_sql=sql_select("select id,status_active,is_deleted from wo_pre_cost_dtls where  job_no like '%$job_no_up%' order by id asc");//job_no=$update_id or
		foreach($confirm_sql as $row){
			if($row[csf('status_active')]==1 && $row[csf('is_deleted')]==0)
			{
				$confirm_id.=$row[csf('id')].',';
			}
			else
			{
				$del_confirm_id=$row[csf('id')];
				$del_count++;
			}
		}
		$confirm_ids=chop($confirm_id,',');
		$del_confirm_ids=chop($del_confirm_id,',');

		$id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
		$field_array="id, job_id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, calculative_cmcost, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, operatingex_per, common_oh, common_oh_percent, depramortexper, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interestexper, interest_cost, interest_percent, incometexexper, incometax_cost, incometax_percent, design_cost, design_percent, incentives_pre_cost, incentives_pre_rate, incentives_pre_cost_per, studio_cost, studio_percent, inserted_by, insert_date, status_active, is_deleted";
		//incentives_po_per,

		$data_array="(".$id.",".$hidd_job_id.", ".$update_id.", ".$cbo_costing_per.", ".$cbo_order_uom.", ".$txt_fabric_pre_cost.", ".$txt_fabric_po_price.", ".$txt_trim_pre_cost.", ".$txt_trim_po_price.", ".$txt_embel_pre_cost.", ".$txt_embel_po_price.", ".$txt_wash_pre_cost.", ".$txt_wash_po_price.", ".$txt_comml_pre_cost.", ".$txt_comml_po_price.", ".$txt_commission_pre_cost.", ".$txt_commission_po_price.", ".$txt_lab_test_pre_cost.", ".$txt_lab_test_po_price.", ".$txt_inspection_pre_cost.", ".$txt_inspection_po_price.", ".$txt_cm_pre_cost.", ".$txtcmcost.", ".$txt_cm_pre_cost.", ".$txt_freight_pre_cost.", ".$txt_freight_po_price.", ".$txt_currier_pre_cost.", ".$txt_currier_po_price.", ".$txt_certificate_pre_cost.", ".$txt_certificate_po_price.", ".$txtoptexpper.", ".$txt_common_oh_pre_cost.", ".$txt_common_oh_po_price.", ".$txtdepramortper.", ".$txt_depr_amor_pre_cost.", ".$txt_depr_amor_po_price.", ".$txt_total_pre_cost.", ".$txt_total_po_price.", ".$txt_final_price_dzn_pre_cost.", ".$txt_final_price_dzn_po_price.", ".$txt_margin_dzn_pre_cost.", ".$txt_margin_dzn_po_price.", ".$txt_total_pre_cost_psc_set.", ".$txt_total_pre_cost_psc_set_po_price.", ".$txt_final_price_pcs_pre_cost.", ".$txt_final_price_pcs_po_price.", ".$txt_margin_pcs_pre_cost.", ".$txt_margin_pcs_po_price.", ".$cm_for_shipment_sche.", ".$txt_deffdlc_pre_cost.", ".$txt_deffdlc_po_price.", ".$txtinterestper.",".$txt_interest_pre_cost.", ".$txt_interest_po_price.", ".$txtincometexper.", ".$txt_incometax_pre_cost.", ".$txt_incometax_po_price.", ".$txt_design_pre_cost.", ".$txt_design_po_price.", ".$txt_incentives_pre_cost.", ".$txt_incentives_pre_rate.", ".$txt_incentives_pre_cost_per.",  ".$txt_studio_pre_cost.", ".$txt_studio_po_price.", ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0)";
		$flag=1;
		$job_del=str_replace("'","",$update_id);
		$job_del_cond=$del_count.''.$job_del;
		//".$txt_incentives_pre_cost_per.",

		if($del_confirm_id!="")
		{
			//echo "10**update wo_pre_cost_dtls set job_no='$job_del_cond' where id in($del_confirm_ids)";die;
		$del_rID=execute_query("update wo_pre_cost_dtls set job_no='$job_del_cond',updated_by='".$_SESSION['logic_erp']['user_id']."', update_date='".$pc_date_time."' where id in($del_confirm_ids)",1);
		if($del_rID==1 && $flag==1) $flag=1; else $flag=0;
		}
		//echo "10**INSERT INTO wo_pre_cost_dtls ($field_array) values $data_array"; die;
		//INCENTIVES_PO_PER
		$rID=sql_insert("wo_pre_cost_dtls",$field_array,$data_array,1,1);
		if($rID==1 && $flag==1) $flag=1; else $flag=0;

		if($confirm_ids!=0)
		{
			if($confirm_id!="")
			{
				$rIDmst_de1=execute_query( "delete from wo_pre_cost_dtls where id in ($confirm_ids)",0);
				if($rIDmst_de1==1 && $flag==1) $flag=1; else $flag=0;
			}
		}
		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "0**".$rID."**".$id;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".$id;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1){
				oci_commit($con);
				echo "0**".$rID."**".$id;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".$id;
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		if(str_replace("'",'',$update_id_dtls)=="" && 1==2)
		{
			$id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
			$field_array="id, job_id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, calculative_cmcost, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, operatingex_per, common_oh, common_oh_percent, depramortexper, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interestexper, interest_cost, interest_percent, incometexexper, incometax_cost, incometax_percent, design_cost, design_percent, incentives_pre_cost, incentives_pre_rate, incentives_pre_cost_per, studio_cost, studio_percent, inserted_by, insert_date, status_active, is_deleted";
			//incentives_po_per,

			$data_array="(".$id.",".$hidd_job_id.", ".$update_id.", ".$cbo_costing_per.", ".$cbo_order_uom.", ".$txt_fabric_pre_cost.", ".$txt_fabric_po_price.", ".$txt_trim_pre_cost.", ".$txt_trim_po_price.", ".$txt_embel_pre_cost.", ".$txt_embel_po_price.", ".$txt_wash_pre_cost.", ".$txt_wash_po_price.", ".$txt_comml_pre_cost.", ".$txt_comml_po_price.", ".$txt_commission_pre_cost.", ".$txt_commission_po_price.", ".$txt_lab_test_pre_cost.", ".$txt_lab_test_po_price.", ".$txt_inspection_pre_cost.", ".$txt_inspection_po_price.", ".$txt_cm_pre_cost.", ".$txtcmcost.", ".$txt_cm_pre_cost.", ".$txt_freight_pre_cost.", ".$txt_freight_po_price.", ".$txt_currier_pre_cost.", ".$txt_currier_po_price.", ".$txt_certificate_pre_cost.", ".$txt_certificate_po_price.", ".$txtoptexpper.", ".$txt_common_oh_pre_cost.", ".$txt_common_oh_po_price.", ".$txtdepramortper.", ".$txt_depr_amor_pre_cost.", ".$txt_depr_amor_po_price.", ".$txt_total_pre_cost.", ".$txt_total_po_price.", ".$txt_final_price_dzn_pre_cost.", ".$txt_final_price_dzn_po_price.", ".$txt_margin_dzn_pre_cost.", ".$txt_margin_dzn_po_price.", ".$txt_total_pre_cost_psc_set.", ".$txt_total_pre_cost_psc_set_po_price.", ".$txt_final_price_pcs_pre_cost.", ".$txt_final_price_pcs_po_price.", ".$txt_margin_pcs_pre_cost.", ".$txt_margin_pcs_po_price.", ".$cm_for_shipment_sche.", ".$txt_deffdlc_pre_cost.", ".$txt_deffdlc_po_price.", ".$txtinterestper.",".$txt_interest_pre_cost.", ".$txt_interest_po_price.", ".$txtincometexper.", ".$txt_incometax_pre_cost.", ".$txt_incometax_po_price.", ".$txt_design_pre_cost.", ".$txt_design_po_price.", ".$txt_incentives_pre_cost.", ".$txt_incentives_pre_rate.", ".$txt_incentives_pre_cost_per.",  ".$txt_studio_pre_cost.", ".$txt_studio_po_price.", ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0)";
			//$rID=sql_insert("wo_pre_cost_dtls",$field_array,$data_array,1);
		}
		if(str_replace("'",'',$update_id_dtls)!="")
		{
			$field_array="costing_per_id*order_uom_id*fabric_cost*fabric_cost_percent*trims_cost*trims_cost_percent*embel_cost*embel_cost_percent*wash_cost* 	wash_cost_percent*comm_cost*comm_cost_percent*commission*commission_percent*lab_test*lab_test_percent*inspection*inspection_percent*cm_cost*cm_cost_percent*calculative_cmcost*freight*freight_percent*currier_pre_cost*currier_percent*certificate_pre_cost*certificate_percent*operatingex_per*common_oh*common_oh_percent*depramortexper*depr_amor_pre_cost*depr_amor_po_price*total_cost*total_cost_percent*price_dzn*price_dzn_percent*margin_dzn*margin_dzn_percent*cost_pcs_set*cost_pcs_set_percent*price_pcs_or_set*price_pcs_or_set_percent*margin_pcs_set*margin_pcs_set_percent*cm_for_sipment_sche*deffdlc_cost*deffdlc_percent*interestexper*interest_cost*interest_percent*incometexexper*incometax_cost*incometax_percent*design_cost*design_percent*incentives_pre_cost*incentives_pre_rate*incentives_pre_cost_per*studio_cost*studio_percent*updated_by*update_date";
			$txtincometexper=str_replace("'","",$txtincometexper);
			$txtinterestper=str_replace("'","",$txtinterestper);
			$txtdepramortper=str_replace("'","",$txtdepramortper);
			$txtoptexpper=str_replace("'","",$txtoptexpper);
			//echo "10**".$txtinterestper; die;
			$data_array="".$cbo_costing_per."*".$cbo_order_uom."*".$txt_fabric_pre_cost."*".$txt_fabric_po_price."*".$txt_trim_pre_cost."*".$txt_trim_po_price."*".$txt_embel_pre_cost."*".$txt_embel_po_price."*".$txt_wash_pre_cost."*".$txt_wash_po_price."*".$txt_comml_pre_cost."*".$txt_comml_po_price."*".$txt_commission_pre_cost."*".$txt_commission_po_price."*".$txt_lab_test_pre_cost."*".$txt_lab_test_po_price."*".$txt_inspection_pre_cost."*".$txt_inspection_po_price."*".$txt_cm_pre_cost."*".$txt_cm_po_price."*".$txtcmcost."*".$txt_freight_pre_cost."*".$txt_freight_po_price."*".$txt_currier_pre_cost."*".$txt_currier_po_price."*".$txt_certificate_pre_cost."*".$txt_certificate_po_price."*'".$txtoptexpper."'*".$txt_common_oh_pre_cost."*".$txt_common_oh_po_price."*'".$txtdepramortper."'*".$txt_depr_amor_pre_cost."*".$txt_depr_amor_po_price."*".$txt_total_pre_cost."*".$txt_total_po_price."*".$txt_final_price_dzn_pre_cost."*".$txt_final_price_dzn_po_price."*".$txt_margin_dzn_pre_cost."*".$txt_margin_dzn_po_price."*".$txt_total_pre_cost_psc_set."*".$txt_total_pre_cost_psc_set_po_price."*".$txt_final_price_pcs_pre_cost."*".$txt_final_price_pcs_po_price."*".$txt_margin_pcs_pre_cost."*".$txt_margin_pcs_po_price."*".$cm_for_shipment_sche."*".$txt_deffdlc_pre_cost."*".$txt_deffdlc_po_price."*'".$txtinterestper."'*".$txt_interest_pre_cost."*".$txt_interest_po_price."*'".$txtincometexper."'*".$txt_incometax_pre_cost."*".$txt_incometax_po_price."*".$txt_design_pre_cost."*".$txt_design_po_price."*".$txt_incentives_pre_cost."*".$txt_incentives_pre_rate."*".$txt_incentives_pre_cost_per."*".$txt_studio_pre_cost."*".$txt_studio_po_price."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";
			//echo "10**A=".$data_array;	die;
		    $rID=sql_update("wo_pre_cost_dtls",$field_array,$data_array,"id*status_active*is_deleted","".$update_id_dtls."*1*0",1);
			//$rID=sql_update("wo_pre_cost_dtls",$field_array,$data_array,"job_no*status_active*is_deleted","".$txt_job_no."*1*0",1);
			//'2'*'1'*'1.255456'*'10.46'*''*'0.00'*''*'0.00'*''*'0.00'*'0'*'0.00'*''*'0.00'*''*'0.00'*''*'0.00'*'13.986'*'116.55'*'13.986'*''*'0.00'*''*'0.00'*''*'0.00'**'1.200000'*'10.00'**'0.000000'*'0.00'*'29.521456'*'246.01'*'12'*'100.00'*'-17.521456'*'-146.01'*'29.521456'*'246.01'*'12'*'100.00'*'-17.521456'*'-146.01'*-3.535456*'0'*'0.00'**'11.880000'*'99.00'**'1.200000'*'10.00'*''*'0.00'*''*''*'0.00'*''*'0.00'*165*'21-Sep-2023 09:10:37 AM'
		}

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==2)//Update Here============================================================================================================================
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$flag=1;
		$data=str_replace("'","",$update_id);

		$rID=execute_query( "update wo_pre_cost_fabric_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1  where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID==1 && $flag==1) $flag=1; else $flag=0;

		$rID0=execute_query( "update wo_pre_cos_fab_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID==1 && $flag==1) $flag=1; else $flag=0;

		$rID1=execute_query( "update wo_pre_cos_fab_co_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID1==1 && $flag==1) $flag=1; else $flag=0;

		$rID2=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID2==1 && $flag==1) $flag=1; else $flag=0;

		$rID3=execute_query( "update wo_pre_cost_fab_yarnbreakdown set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID3==1 && $flag==1) $flag=1; else $flag=0;

		$rID4=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID4==1 && $flag==1) $flag=1; else $flag=0;

		$rID5=execute_query( "update wo_pre_cost_trim_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID5==1 && $flag==1) $flag=1; else $flag=0;

		$rID6=execute_query( "update wo_pre_cost_trim_co_cons_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID6==1 && $flag==1) $flag=1; else $flag=0;

		$rID7=execute_query( "update wo_pre_cost_embe_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID7==1 && $flag==1) $flag=1; else $flag=0;

		$rID8=execute_query( "update wo_pre_cos_emb_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID8==1 && $flag==1) $flag=1; else $flag=0;

		$rID9=execute_query( "update wo_pre_cost_comarci_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID9==1 && $flag==1) $flag=1; else $flag=0;

		$rID10=execute_query( "update wo_pre_cost_commiss_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID10==1 && $flag==1) $flag=1; else $flag=0;

		$rID11=execute_query( "update wo_pre_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID11==1 && $flag==1) $flag=1; else $flag=0;

		$rID12=execute_query( "update wo_pre_cost_sum_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",1);
		if($rID12==1 && $flag==1) $flag=1; else $flag=0;
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "2**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "2**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		//if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==3)//Update Here============================================================================================================================
	{
		echo "1**".$rID."**".str_replace("'","",$update_id_dtls)."**".str_replace("'","",$operation);
		disconnect($con);
		die;
	}
}
//*************************************************Dtls Form End ***********************************************
//*************************************************Fabric Cost, Yarn Cost, Coversion Cost Start ***********************************************
if($action=="booking_no_with_approved_status")
{
	$data=explode("_",$data);
	//echo $data[0];
	//echo $data[1];
	if($data[1]=="")
	{
		$sql="select booking_no, is_approved from wo_booking_mst where job_no='$data[0]' and booking_type=1 and is_short=2 and is_deleted=0 and status_active=1";
	}
	else
	{
		$sql="select a.booking_no,a.is_approved from wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and  a.job_no='$data[0]' and a.booking_type=1 and a.is_short=2 and b.po_break_down_id=$data[1] and a.is_deleted=0 and a.status_active=1 group by a.booking_no,a.is_approved";
	}
	$approved_booking="";
	$un_approved_booking="";
	$sql_booking=sql_select($sql);
	foreach($sql_booking as $row)
	{
		if($row[csf('is_approved')]==1 || $row[csf('is_approved')]==3)
		{
		  $approved_booking.=$row[csf('booking_no')].", ";
		}
		else
		{
		  $un_approved_booking.=$row[csf('booking_no')].", ";
		}
	}
	echo rtrim($approved_booking ,", ")."_".rtrim($un_approved_booking , ", ");disconnect($con);
	exit();
}

if ($action=="show_fabric_cost_listview")
{
	$data=explode("**",$data); $component_approved=0; $approved_message=""; $permission=$data[7];

	$jobid=return_field_value("job_id", "wo_pre_cost_mst","job_no='$data[0]' and status_active =1 and is_deleted=0");

	$sql=sql_select("select approved as approved from precost_component_app_mst where cost_component_id=1 and job_id='$jobid'");
	if (count($sql)<1)
	{
		$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$data[0]'");
	}
	foreach($sql as $row){
		if($row[csf('approved')]==1) {
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00;'> Approved.</p></marquee> ";
		}
		else if($row[csf('approved')]==3) {
			$component_approved=3; $approved_message="<marquee width='500'><p style='color:#f00;'> Partially Approved.</p></marquee> ";
		}
	}

	$mandatory_sql=sql_select("select variable_list, embellishment_id, embellishment_budget_id, style_from_library, default_fabric_source, color_from_library, conversion_from_chart, rate_type from variable_order_tracking where status_active=1 and variable_list in (21,23,49,75,80) and company_name=$data[3]");
	$var_dia_width_type=2; $de_fab_source=1; $color_from_library=2; $conversion_from_chart=2; $fabricBudgetOn=2; $aop_conversion_from_chart=2;
	foreach($mandatory_sql as $row){
		if($row[csf('variable_list')]==80) $var_dia_width_type=$row[csf('style_from_library')];
		if($row[csf('variable_list')]==49) $de_fab_source=$row[csf('default_fabric_source')];
		if($row[csf('variable_list')]==23) $color_from_library=$row[csf('color_from_library')];
		if($row[csf('variable_list')]==75 && $row[csf('embellishment_id')]==2) $fabricBudgetOn=$row[csf('embellishment_budget_id')];//
		if($row[csf('variable_list')]==21 && $row[csf('rate_type')]==3 && $row[csf('conversion_from_chart')]==1) $conversion_from_chart=$row[csf('conversion_from_chart')];
		if($row[csf('variable_list')]==21 && $row[csf('rate_type')]==25 && $row[csf('conversion_from_chart')]==1) $aop_conversion_from_chart=$row[csf('conversion_from_chart')];

		//  Issue Id=11140 For Lariz As per Nasir
	}
	//echo $aop_conversion_from_chart.'D';

	unset($mandatory_sql);
	if($var_dia_width_type==1) $dia_type='blue'; else $dia_type='black';
	?>
   <h3 align="left" class="accordion_h" onClick="show_hide_content('fabric_cost', '')"> +Fabric Cost <?=$approved_message; ?></h3>
   <div id="content_fabric_cost" style="display:none;">
    <fieldset>
        <form id="fabriccost_3" autocomplete="off">
        <input type="hidden" id="tr_ortder" name="tr_ortder" value="" width="500" />

        <table width="1610" cellspacing="0" class="rpt_table" border="0" id="tbl_fabric_cost" rules="all">
            <thead>
                <tr>
                	<th width="30">Seq</th>
                    <th width="80" style="color:#2A3FFF">Gmts Item</th>
                    <th width="80" style="color:#2A3FFF">Body Part</th>
                    <th width="60" style="color:#2A3FFF">Body Part Type</th>
                    <th width="80" style="color:#2A3FFF">Fab Nature</th>
                    <th width="70" style="color:#2A3FFF">Color Type</th>
                    <th width="140" style="color:#2A3FFF">Fabric Description</th>
                    <th width="70" style="color:#2A3FFF">Fabric Source</th>
                    <th width="70" style="color:#2A3FFF">Source</th>
                    <th width="80">Nominated Supp </th>
                    <th width="60" style="color:<?=$dia_type;?>" id="">Width /Dia Type</th>
                    <th width="40" style="color:#2A3FFF" id="gsmweight_caption">GSM/ Weight</th>
                    <th width="100">Sensitive</th>
                    <th width="75" id="gsmweight_caption">Color</th>
                    <th width="70">Cons. Basis</th>
                    <th width="50" style="color:#2A3FFF">Uom</th>
                    <th width="65" style="color:#2A3FFF">Avg. Grey Cons</th>
                    <th width="40">Rate</th>
                    <th width="60">Amount</th>
                    <th width="50">Total R.Qty</th>
                    <th width="70">Total R.Amt</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
            <tbody>
            <?
			$contrat_cond="";
			$sql_bo_app2=sql_select("select b.pre_cost_fabric_cost_dtls_id,a.booking_no from wo_booking_mst a, wo_booking_dtls b where a.id=b.booking_mst_id  and b.job_no='$data[0]' and a.is_deleted=0 and a.status_active=1 and a.entry_form in (108, 88) group by b.pre_cost_fabric_cost_dtls_id,a.booking_no");
			if(count($sql_bo_app2)>0){ $contrat_cond="readonly"; }else{ $contrat_cond=""; }

			$suppSql="select a.id, a.supplier_name, b.party_type from lib_supplier a, lib_supplier_party_type b, lib_supplier_tag_company c where a.id=b.supplier_id and b.supplier_id = c.supplier_id and c.tag_company=$data[3] and b.party_type in(1,2,9) and a.is_deleted=0 and a.status_active=1 group by a.id, a.supplier_name,b.party_type order by a.supplier_name ASC";
			$suppSqlres=sql_select($suppSql);
			$supplier_library_fabric=array(); $supplier_library_yarn=array();
			foreach($suppSqlres as $srow)
			{
				if($srow[csf("party_type")]==2)//Yarn Supplier
				{
					$supplier_library_yarn[$srow[csf("id")]]=$srow[csf("supplier_name")];
				}
				else//Fabric Supplier
				{
					$supplier_library_fabric[$srow[csf("id")]]=$srow[csf("supplier_name")];
				}
			}
			unset($suppSqlres);

            $color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

            $sql_fld_lvl_acss="select field_name, defalt_value, is_disable from field_level_access where user_id=".$_SESSION['logic_erp']['user_id']." and company_id=$data[3] and page_id=158";
            $sql_fld_lvl_acss_data=sql_select($sql_fld_lvl_acss);
            $fld_lvl_acss_arr=array();
            foreach($sql_fld_lvl_acss_data as $fld_lvl_acss_row)
            {
                $fld_lvl_acss_arr[$fld_lvl_acss_row[csf("field_name")]]['defalt_value']=$fld_lvl_acss_row[csf("defalt_value")];
                $fld_lvl_acss_arr[$fld_lvl_acss_row[csf("field_name")]]['is_disable']=$fld_lvl_acss_row[csf("is_disable")];
            }
            unset($sql_fld_lvl_acss_data);
            $arr_bo_app=array();

            $save_update=1;
            $gmts_item_id=return_field_value("gmts_item_id", "wo_po_details_master", "job_no='$data[0]'");
            $approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
            if($approved==3){
                $approved=1;
            }
            $body_part_type_arr=return_library_array("select id, body_part_type from lib_body_part","id","body_part_type");

            $data_array=sql_select("select id, job_no, seq, nominated_supp, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id as lib_yarn_count_deter_id, construction, composition, fabric_description, source_id, gsm_weight, color_size_sensitive, color, consumption_basis, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, status_active, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, process_loss_method, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, budget_on from wo_pre_cost_fabric_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 order by seq asc");

            $is_booking_arr=array(); $is_convData=0;
            if (count($data_array)>0)
            {
				$is_convData=1;
                $data_arr=sql_select("select a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and b.job_no ='$data[0]' and b.booking_type='1' and a.is_deleted=0 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 group by a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id");
                foreach ($data_arr as $row)
                {
                    if($row[csf('entry_form')]==108 || $row[csf('is_short')]==1 || $row[csf('is_approved')]==1)
                    {
                        $is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
                    }
                }
                //print_r($is_booking_arr);
                unset($data_arr);
            }

            if (count($data_array)<1 && $data[2]==1 && $data[5]==2 )//Price Quotation
            {
                $data_array=sql_select("select id as pri_id, seq, quotation_id, 1 as color_size_sensitive, nominated_supp, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id as lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, fab_cons_in_quotat_varia, avg_cons, fabric_source, 0 as rate, 0 as amount, avg_finish_cons, avg_process_loss, yarn_breack_down, width_dia_type, status_active, body_part_type as body_part_type from wo_pri_quo_fabric_cost_dtls where quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by seq asc");
                $save_update=0;
            }
			if (count($data_array) < 1 && $data[2]==1)//Quick Costing or Short Quotation -V6
			{
				if($data[5]==1 || $data[5]==8)
				{
				$data_array=sql_select("select id as pri_id, 0 as nominated_supp, item_id as item_number_id, body_part_id, 0 as fab_nature_id, color_type_id as color_type_id, fab_id as lib_yarn_count_deter_id, '' as construction, '' as composition, description as fabric_description, fabwidth as gsm_weight, 0 as fab_cons_in_quotat_varia, tot_cons as avg_cons, 0 as fabric_source,0 as rate, 0 as amount, uom, 0 as avg_finish_cons, 0 as avg_process_loss, '' as yarn_breack_down, 0 as width_dia_type, status_active, '' as body_part_type, 0 as gsm_weight_type from qc_cons_rate_dtls where mst_id='$data[1]' and type=1 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
				$fabeicID="";
				foreach( $data_array as $frow)
				{
					if($fabeicID=="") $fabeicID=$frow[csf('lib_yarn_count_deter_id')]; else $fabeicID.=','.$frow[csf('lib_yarn_count_deter_id')];
				}
				$composition_arr=array();
				if($fabeicID!="")
				{
					$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");

					$sql="select a.fab_nature_id, a.construction, a.type, a.design, a.gsm_weight, a.weight_type, a.color_range_id, a.stich_length, a.process_loss, b.copmposition_id, b.percent, b.count_id, b.type_id, a.id, b.id as bid from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id in ($fabeicID) order by a.id,b.id";
					//echo $sql;
					$sqlRes=sql_select($sql); $fabricDataArr=$yarn_description=array();
					if (count($sqlRes)>0)
					{
						foreach( $sqlRes as $row )
						{
							$compo_per="";
							if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
							if(array_key_exists($row[csf('id')],$composition_arr))
							{
								$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
							}
							else
							{
								$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
							}

							if($yarn_description[$row[csf('id')]]!="")
							{
								$yarn_description[$row[csf('id')]]=$yarn_description[$row[csf('id')]]."__".$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
							}
							else
							{
								$yarn_description[$row[csf('id')]]=$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
							}

							$fabricDataArr[$row[csf('id')]]['construction']=$row[csf('construction')];
							$fabricDataArr[$row[csf('id')]]['fab_nature_id']=$row[csf('fab_nature_id')];
							$fabricDataArr[$row[csf('id')]]['gsm_weight']=$row[csf('gsm_weight')];
							$fabricDataArr[$row[csf('id')]]['process_loss']=$row[csf('process_loss')];
							$fabricDataArr[$row[csf('id')]]['weight_type']=$row[csf('weight_type')];
							$fabricDataArr[$row[csf('id')]]['type']=$row[csf('type')];
							$fabricDataArr[$row[csf('id')]]['design']=$row[csf('design')];
							

							if(array_key_exists($row[csf('id')],$fab_description))
							{
								$fab_description[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per."%";
							}
							else
							{
								$fab_description[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per."%";
							}
							
							if($composition[$row[csf('copmposition_id')]])
							{
								$fabricDataArr[$row[csf('id')]]['compo']=$composition[$row[csf('copmposition_id')]];
							}
						}
						unset($sqlRes);
					}
				}
				$save_update=0;
				}
			}
			//echo $data[2].'='.$data[5];
			if (count($data_array) < 1 && $data[2]==1 && $data[5]==5 )//Short Quotation V2
			{
				$composition_arr=array(); $fabricDataArr=array();
				$data_array=sql_select("select b.id as pri_id, a.item_id as item_number_id, a.body_part_id, 0 as fab_nature_id, b.color_type_id, b.yarn_lib_id as lib_yarn_count_deter_id, b.composition, b.fab_des as fabric_description, b.gsm as gsm_weight, 1 as color_size_sensitive, 0 as fab_cons_in_quotat_varia, 0 as avg_cons, b.nominated_supp_multi as nominated_supp, 1 as fabric_source, b.rate, b.value as amount, b.tot_cons as avg_finish_cons, b.exper as avg_process_loss, b.yarn_break_down as yarn_breack_down, b.diatype as width_dia_type, b.status_active, 0 as body_part_type, 0 as gsm_weight_type, 2 as budget_on, b.uom from qc_cons_rate_dtls a, qc_fab_yarn_conv b where a.mst_id='$data[1]' and a.id=b.cons_rate_dtls_id and b.type=1 and b.tot_cons>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");// b.cons as avg_cons,

				//echo "select a.id as quotation_id, a.item_id as item_number_id, a.body_part_id, 0 as fab_nature_id, b.color_type_id, b.yarn_lib_id as lib_yarn_count_deter_id, b.composition, b.fab_des as fabric_description, b.gsm as gsm_weight, 1 as color_size_sensitive, 0 as fab_cons_in_quotat_varia, b.cons as avg_cons, b.nominated_supp_multi as nominated_supp, 0 as fabric_source, b.rate, b.value as amount, b.tot_cons as avg_finish_cons, b.exper as avg_process_loss, b.yarn_break_down, b.diatype as width_dia_type, b.status_active, 0 as body_part_type, 0 as gsm_weight_type, 2 as budget_on, b.uom from qc_cons_rate_dtls a, qc_fab_yarn_conv b where a.mst_id='$data[1]' and a.id=b.cons_rate_dtls_id and b.type=1 and b.tot_cons>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";

				$fabeicID=""; //$yarnBreakDataArr=array();
				foreach( $data_array as $frow)
				{
					if($fabeicID=="") $fabeicID=$frow[csf('lib_yarn_count_deter_id')]; else $fabeicID.=','.$frow[csf('lib_yarn_count_deter_id')];

					//$doubleHashRemove=implode("__",explode("##",$frow[csf('yarn_break_down')]));
					//$singleUnderScoreRemove=implode("_",explode(",",$doubleHashRemove));

					//$yarnBreakDataArr[$frow[csf('pri_id')]]=$singleUnderScoreRemove;
				}
				//print_r($yarnBreakDataArr);

				if($fabeicID!="")
				{
					$lib_yarn_count=return_library_array( "select yarn_count, id from lib_yarn_count", "id", "yarn_count");

					$sql="select a.fab_nature_id, a.construction, a.type, a.design, a.gsm_weight, a.weight_type, a.color_range_id, a.stich_length, a.process_loss, b.copmposition_id, b.percent, b.count_id, b.type_id, a.id, b.id as bid from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.is_deleted=0 and a.id in ($fabeicID) order by a.id,b.id";
					//echo $sql;
					$sqlRes=sql_select($sql); $fabricDataArr=array();$composition_arr=array();$fab_description=array();
					if (count($sqlRes)>0)
					{
						foreach( $sqlRes as $row )
						{
							$compo_per="";
							if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
							if(array_key_exists($row[csf('id')],$composition_arr))
							{
								$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per.",";
							}
							else
							{
								$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per.",";
							}

							$fabricDataArr[$row[csf('id')]]['construction']=$row[csf('construction')];
							if($composition[$row[csf('copmposition_id')]])
							{
							$fabricDataArr[$row[csf('id')]]['compo']=$composition[$row[csf('copmposition_id')]];
							}
							$fabricDataArr[$row[csf('id')]]['fab_nature_id']=$row[csf('fab_nature_id')];
							$fabricDataArr[$row[csf('id')]]['weight_type']=$row[csf('weight_type')];
							$fabricDataArr[$row[csf('id')]]['type']=$row[csf('type')];

						}
						//print_r($fab_description);
						unset($sqlRes);
					}
				}
				$save_update=0;
			}
			$fab_description=array();
            if (count($data_array)>0)
            {
                $i=0; $applyLastUpdateArr=array();
                foreach( $data_array as $row )
                {
                    $i++;
					$seq='';
                    if($row[csf("seq")]=="" || $row[csf("seq")]==0) $seq=$i; else $seq=$row[csf("seq")];
					if($row[csf("id")]!="") $fab_id_wise_item[$row[csf("id")]]['seq']=$seq;
					else $fab_id_wise_item[$row[csf("pri_id")]]['seq']=$seq;

                    if($db_type==0)
                    {
                        $cons_breack_down=$row[csf('cons_breack_down')];
                        $msmnt_break_down=$row[csf('msmnt_break_down')];
                    }
                    else if($db_type==2)
                    {
                        if($row[csf('cons_breack_down')] !="") $cons_breack_down=$row[csf('cons_breack_down')]->load();
                        if($row[csf('msmnt_break_down')] !="") $msmnt_break_down=$row[csf('msmnt_break_down')]->load();
                    }
					if($is_convData==1)
					{
						if($row[csf("fabric_source")]==1 || $row[csf("fabric_source")]==2)
						{
							$fab_description[$row[csf("id")]]=$body_part[$row[csf("body_part_id")]].', '.$color_type[$row[csf("color_type_id")]].', '.$row[csf("fabric_description")].', '.$size_color_sensitive[$row[csf('color_size_sensitive')]];
							$yarn_count_id_arr[$row[csf("id")]] = $row[csf("lib_yarn_count_deter_id")];
							$fabric_cost_data_arr[$row[csf("id")]]['avg_cons'] = $row[csf("avg_cons")];
						}
					}

                    $dis=0; $txt_dis="";
                    if($approved!=1)
                    {
                        $disabled=0; $btn_disabled=0;
                        if($is_booking_arr[$row[csf('id')]]!="")
                        {
                            $disabled=1; $btn_disabled=1; $txt_dis="disabled";
                        }
                    }
                    else if( $component_approved!=1)
                    {
                        $disabled=0; $btn_disabled=0;
                        if($is_booking_arr[$row[csf('id')]]!="") {
                            $disabled=1; $btn_disabled=1; $txt_dis="disabled";
                        }
                    }

                    if($approved==1 || $component_approved==1)
                    {
                        $disabled=1; $btn_disabled=1; $txt_disabled="disabled";
                    }

                    //echo $disabled;
					//echo $save_update."=".$data[2]."=".$data[5]."<br>";
					if($save_update==0 && $data[2]==1)
					{
						if($data[5]==5 || $data[5]==8) $row[csf("yarn_breack_down")]=$yarn_description[$row[csf("lib_yarn_count_deter_id")]];
					}

                    $uom=12;
                    if($row[csf("fab_nature_id")]==3)
                    {
                        if($save_update==0)
                        {
                            if($row[csf('uom')]==0) $uom=27; else $uom=$row[csf('uom')];
                        }
                        else
                        {
                            if($row[csf('uom')]==0) $uom=27; else $uom=$row[csf('uom')];
                        }
                    }
                    else
                    {
                        if($save_update==0)
                        {
                            if($row[csf('uom')]==0) $uom=12; else $uom=$row[csf('uom')];
                        }
                        else
                        {
                            if($row[csf('uom')]==0) $uom=12; else $uom=$row[csf('uom')];
                        }
                    }
					$is_apply_last_update=$row[csf("is_apply_last_update")];
					$is_last_app_msg=""; $is_last_app_msg_id=0; $changedmsgcolor="";
					$applyLastUpdateArr[$row[csf("id")]]=$row[csf("is_apply_last_update")];
					if($is_apply_last_update==2)
					{
						$is_last_app_msg="Color Size Changed.";
						$is_last_app_msg_id="1";
						$changedmsgcolor="red";
					}

					$deter_id=$row[csf("lib_yarn_count_deter_id")];
					if($data[2]==1)//Short Quotation V2
					{
						if($data[5]==5 || $data[5]==8)
						{
							if($row[csf("construction")]!="") $row[csf("construction")]=$row[csf("construction")];else $row[csf("construction")]=$fabricDataArr[$deter_id]['construction'];
							if($row[csf("composition")]!="") $row[csf("composition")]=$row[csf("composition")];else $row[csf("composition")]=$fabricDataArr[$deter_id]['compo'];
						}
					}
                    if($row[csf("body_part_type")]=="" || $row[csf("body_part_type")]==0) $row[csf("body_part_type")]=$body_part_type_arr[$row[csf("body_part_id")]];
					if($row[csf("budget_on")]=="" || $row[csf("budget_on")]==0) $budget_on=$fabricBudgetOn;else $budget_on=$row[csf("budget_on")];
                       ?>
                        <tr id="fabriccosttbltr_<?=$i; ?>" align="center">
                        	<td><input type="text" id="seq_<?=$i; ?>" name="seq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$seq; ?>" /></td>
                            <td><?=create_drop_down( "cbogmtsitem_".$i, 80, $garments_item,"", 1, "--Select Item--", $row[csf("item_number_id")], "",$disabled,$gmts_item_id ); ?></td>
                            <td>
                                <input type="text" id="txtbodyparttext_<?=$i; ?>" name="txtbodyparttext_<?=$i; ?>" class="text_boxes" style="width:70px" onDblClick="open_body_part_popup(<?=$i; ?>);" value="<?=$body_part[$row[csf("body_part_id")]]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> title="<?= $body_part[$row[csf("body_part_id")]]; ?>" readonly/>
                                <input type="hidden" id="txtbodypart_<?=$i; ?>" name="txtbodypart_<? echo $i; ?>" class="text_boxes" style="width:90px" value="<? echo $row[csf("body_part_id")]; ?>" readonly/>
                            </td>
                            <td><?=create_drop_down( "txtbodyparttype_".$i, 60, $body_part_type, "", 1, "-Display-", $row[csf("body_part_type")], "",1,"" );  ?></td>
                            <td><?=create_drop_down( "cbofabricnature_".$i, 80, $item_category,"", 0, "", $row[csf("fab_nature_id")], "change_caption( this.value, 'gsmweight_caption'); ",$disabled,"2,3" ); ?> </td>
                            <td><?=create_drop_down( "cbocolortype_".$i, 70, $color_type,"", 1, "-- Select --", $row[csf("color_type_id")], "",$disabled,"" ); ?></td>
                            <td title="<?=$is_last_app_msg; ?>">
                            	<input type="hidden" id="libyarncountdeterminationid_<?=$i; ?>" name="libyarncountdeterminationid_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("lib_yarn_count_deter_id")]; ?>" readonly />
                                <input type="hidden" id="oldlibyarncountdeterminationid_<?=$i; ?>" name="oldlibyarncountdeterminationid_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("lib_yarn_count_deter_id")]; ?>" readonly />
                                <input type="hidden" id="construction_<?=$i; ?>" name="construction_<? echo $i; ?>" class="text_boxes" style="width:10px" value="<? echo $row[csf("construction")]; ?>" readonly/>
                                <input type="hidden" id="composition_<?=$i; ?>" name="composition_<? echo $i; ?>" class="text_boxes" style="width:10px" value="<? echo $row[csf("composition")]; ?>" readonly  />
                              <input type="hidden" id="lastappidchk_<? echo $i; ?>" name="lastappidchk_<? echo $i; ?>" class="text_boxes" style="width:10px" value="<?=$is_apply_last_update; ?>" readonly  />
                              <input type="text" id="fabricdescription_<?=$i; ?>" name="fabricdescription_<?=$i; ?>" class="text_boxes" style="width:127px; background-color:<?=$changedmsgcolor; ?>" onDblClick="open_fabric_decription_popup(<?=$i; ?>);" value="<?=$row[csf("fabric_description")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> title="<? echo $is_last_app_msg.' '.$row[csf("fabric_description")]; ?>"  last_app_id=<? echo $is_apply_last_update;?> readonly/>
                            </td>
                            <td><? 
								asort($fabric_source); echo create_drop_down( "cbofabricsource_".$i, 70, $fabric_source, "", 0, "", $row[csf("fabric_source")], "enable_disable( this.value,'txtrate_*txtamount_', $i );fnc_source_for(this.value, $i)","","1,2,3,4" ); ?></td>

                       		<td>
							   <? 
							asort($commission_particulars); echo create_drop_down( "cbosourceid_".$i, 70, $commission_particulars, "", 1, "-Select-", $row[csf("source_id")], "",1,"" );
							 ?></td>

                            <td><?=create_drop_down( "cbonominasupplier_".$i,80, $supplier_library_fabric, "", 1, '-Select-', $row[csf("nominated_supp")],"fnc_load_supplier_source(this.value,$i)",$disabled,"" );?>
                            </td>
                            <td><? asort($fabric_typee); echo create_drop_down( "cbowidthdiatype_".$i, 60, $fabric_typee,"", 1, "-- Select --", $row[csf("width_dia_type")], "",$disabled,"" ); ?></td>
                            <td><input type="text" id="txtgsmweight_<? echo $i; ?>" name="txtgsmweight_<? echo $i; ?>" class="text_boxes_numeric" style="width:32px" onBlur="sum_yarn_required()" value="<? echo $row[csf("gsm_weight")];  ?>"  <? if($disabled==0){echo "";}else{echo "disabled";}?> avglvalue="<?  echo $row[csf("gsm_weight_yarn")]; ?>" title="<?  echo $row[csf("gsm_weight_yarn")]; ?>"/>
                                <input type="hidden" id="avgtxtgsmweight_<? echo $i; ?>" name="avgtxtgsmweight_<? echo $i; ?>" class="text_boxes_numeric" style="width:30px"  value="<? echo $row[csf("gsm_weight_yarn")]; ?>"  readonly />
                            </td>
                            <td><? echo create_drop_down( "cbocolorsizesensitive_".$i, 100, $size_color_sensitive,"", 1, "--Select--", $row[csf("color_size_sensitive")], "control_color_field($i)",$disabled,"" ); ?></td>
                            <td><input type="text" id="txtcolor_<? echo $i; ?>" name="txtcolor_<? echo $i; ?>" class="text_boxes" style="width:65px" onClick="open_color_popup(<? echo $i; ?>)" value="<? echo $color_library[$row[csf("color")]]; ?>" <?
							 if($row[csf("color_size_sensitive")]==3 && count($sql_bo_app2)>0) {echo $contrat_cond;} else {echo "disabled";} ?> /></td>
                            <td><?=create_drop_down( "consumptionbasis_".$i, 70, $consumtion_basis,'', 0, '', $row[csf('consumption_basis')], "",$disabled,"" ); ?></td>
                            <td><?=create_drop_down( "uom_".$i, 50, $unit_of_measurement,'', 1, '-select-', $uom, "",$disabled,"1,12,23,27" ); ?></td>
                            <td><input type="text" id="txtconsumption_<?=$i; ?>" name="txtconsumption_<?=$i; ?>" onBlur="math_operation( 'txtamount_<?=$i; ?>', 'txtconsumption_<?=$i; ?>*txtrate_<?=$i; ?>', '*','',{dec_type:1,comma:0, currency:document.getElementById('cbo_currercy').value} ); sum_yarn_required(); set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost' )" onDblClick="set_session_large_post_data('requires/pre_cost_entry_controller_v2.php?action=consumption_popup', 'Consumption Entry Form','txtbodypart_<?=$i; ?>', 'cbofabricnature_<?=$i; ?>', 'txtgsmweight_<?=$i; ?>','<?=$i; ?>','updateid_<?=$i; ?>');" class="text_boxes_numeric" style="width:55px" value="<?=$row[csf("avg_cons")]; ?>" avglvalue="<?=$row[csf("avg_cons_yarn")]; ?>" title="<?=$row[csf("avg_cons_yarn")]; ?>"  readonly/>
                                <input type="hidden" id="avgtxtconsumption_<?=$i; ?>" name="avgtxtconsumption_<?=$i; ?>" class="text_boxes_numeric" style="width:50px" value="<? echo $row[csf("avg_cons_yarn")]; ?>" readonly/>
                            </td>
                            <td><input type="text" id="txtrate_<? echo $i; ?>" name="txtrate_<? echo $i; ?>" onBlur="math_operation( 'txtamount_<? echo $i; ?>', 'txtconsumption_<? echo $i; ?>*txtrate_<? echo $i; ?>', '*','',{dec_type:1,comma:0,currency:document.getElementById('cbo_currercy').value} );set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost' )" class="text_boxes_numeric" style="width:40px" value="<? echo $row[csf("rate")]; ?>" <? if($row[csf("fabric_source")]==2){echo "";}else{echo "disabled";}?> readonly/>
                            </td>
                            <td><input type="text" id="txtamount_<?=$i; ?>" onBlur="set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost');" name="txtamount_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="<?=$row[csf("amount")]; ?>" <? if($row[csf("fabric_source")]==2 && $disabled==0){echo "";}else{echo "disabled";}?> readonly />
                            </td>
                            <td><input type="text" id="totalqty_<?=$i; ?>" name="totalqty_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'fabric');" readonly  /></td>
                            <td>
                            	<input type="text" id="totalamount_<?=$i; ?>" name="totalamount_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="" readonly />
                            	<input type="hidden" id="budgeton_<?=$i; ?>" name="budgeton_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$budget_on; ?>" />
                            </td>
                            <td>
                                <input type="hidden" id="cbostatus_<?=$i; ?>" name="cbostatus_<?=$i; ?>" style="width:90px" value="<?=$row[csf("status_active")]; ?>" readonly />
                                <input type="button" id="increase_<?=$i; ?>" style="width:25px" class="formbutton" value="+" onClick="add_break_down_tr(<?=$i; ?>,this );" <? if($approved==1 || $component_approved==1) {echo "disabled";} else {echo "";}?> />
                                <input type="button" id="decrease_<?=$i; ?>" style="width:25px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_fabric_cost',this );" <? if($disabled==0){echo "";}else{echo "disabled";} ?> />
                                 <input type="hidden" id="hiddencolorsizesensitive_<?=$i; ?>" name="hiddencolorsizesensitive_<?=$i; ?>" style="width:90px" value="<?=$row[csf("color_size_sensitive")]; ?>" readonly/>

                                <input type="hidden" id="txtfinishconsumption_<?=$i; ?>" name="txtfinishconsumption_<?=$i; ?>" style="width:60px" value="<?=$row[csf("avg_finish_cons")]; ?>" readonly/>
                                <input type="hidden" id="txtavgprocessloss_<?=$i; ?>"  name="txtavgprocessloss_<?=$i; ?>" style="width:60px" value="<?=$row[csf("avg_process_loss")]; ?>" readonly/>
                                <input type="hidden" id="consbreckdown_<?=$i; ?>" name="consbreckdown_<?=$i; ?>" style="width:90px" value="<?=$cons_breack_down; ?>" readonly />
                                <input type="hidden" id="msmntbreackdown_<?=$i; ?>" name="msmntbreackdown_<?=$i; ?>" style="width:90px" value="<?=$msmnt_break_down; ?>" readonly/>
                                <input type="hidden" id="markerbreackdown_<?=$i; ?>" name="markerbreackdown_<?=$i; ?>" style="width:90px" value="<?=$row[csf("marker_break_down")]; ?>" readonly/>
                                <input type="hidden" id="colorbreackdown_<?=$i; ?>" name="colorbreackdown_<?=$i; ?>" style="width:90px" value="<?=$row[csf("color_break_down")]; ?>" readonly/>
                                <input type="hidden" id="yarnbreackdown_<?=$i; ?>" name="yarnbreackdown_<?=$i; ?>" style="width:90px" value="<?=$row[csf("yarn_breack_down")]; ?>" readonly/>
                                <input type="hidden" id="processlossmethod_<?=$i; ?>" name="processlossmethod_<?=$i; ?>" value="<?=$row[csf("process_loss_method")]; ?>" readonly/>
                                <input type="hidden" id="updateid_<?=$i; ?>" name="updateid_<?=$i; ?>" style="width:20px" value="<?=$row[csf("id")]; ?>"  readonly/>
                                <!-- Price quatation fabric cost Id-->
                                <input type="hidden" id="prifabcostdtlsid_<?=$i; ?>" name="prifabcostdtlsid_<?=$i; ?>" style="width:20px" value="<?=$row[csf("pri_id")]; ?>"  readonly/>
                                <input type="hidden" id="isclickedconsinput_<?=$i; ?>" name="isclickedconsinput_<?=$i; ?>" style="width:20px" value="<?=$row[csf("is_apply_last_update")]; ?>" readonly/>
                                <input type="hidden" id="plancutqty_<?=$i; ?>" name="plancutqty_<?=$i; ?>" style="width:20px" value="<?=$row[csf("plan_cut_qty")]; ?>" readonly/>
                                <input type="hidden" id="jobplancutqty_<?=$i; ?>" name="jobplancutqty_<?=$i; ?>" style="width:20px" value="<?=$row[csf("job_plan_cut_qty")]; ?>" readonly/>
                                <input type="hidden" id="precostapproved_<?=$i; ?>" name="precostapproved_<?=$i; ?>" style="width:20px" value="<?=$approved; ?>" readonly/>
                                <input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" style="width:20px" value="0" readonly/>
                            <!-- Price quatation fabric cost Id end-->
                            </td>
                        </tr>
                    <?
                    }
                }
                else
                {
                    $selected_item=0;
                    $gmts_item_id_arr=explode(",",$gmts_item_id);
                    if(count($gmts_item_id_arr)==1)
                    {
                        $selected_item=	$gmts_item_id;
                    }
                    $uom_fld_accs=$fld_lvl_acss_arr['cbo_fabric_costing_uom']['defalt_value'];
                    $fab_nature_fld_accs=$fld_lvl_acss_arr['cbo_fabric_costing_fab_nature']['defalt_value'];
                    $fab_source_fld_accs=$fld_lvl_acss_arr['cbo_fabric_costing_fab_source']['defalt_value'];
					//echo $fab_source_fld_accs.'==ggggggggggg';
                    ?>
                    <tr id="fabriccosttbltr_1" align="center">
                    	<td><input type="text" id="seq_1" name="seq_1" class="text_boxes_numeric" style="width:18px" value="1" /></td>
                        <td><?=create_drop_down( "cbogmtsitem_1", 80, $garments_item,"", 1, "-- Select Item --", $selected_item, "" ,"",$gmts_item_id); ?></td>
                        <td><input type="text" id="txtbodyparttext_1" name="txtbodyparttext_1" class="text_boxes" style="width:70px" onDblClick="open_body_part_popup(1)" value="<? echo $body_part[$row[csf("body_part_id")]]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> title="<? echo $body_part[$row[csf("body_part_id")]]; ?>" placeholder="DblClick" readonly/>

                            <input type="hidden" id="txtbodypart_1" name="txtbodypart_1" class="text_boxes" style="width:90px" value="<?=$row[csf("body_part_id")]; ?>" title="<?=$row[csf("body_part_id")]; ?>" readonly/>
                        </td>
                        <td><?=create_drop_down( "txtbodyparttype_1", 60, $body_part_type, "", 1, "-Display-", "", "",1,"" );  ?></td>
                        <td><?=create_drop_down( "cbofabricnature_1", 80, $item_category,"", 0, "", $fab_nature_fld_accs, "change_caption( this.value, 'gsmweight_caption');","","2,3" ); ?></td>
                        <td><?=create_drop_down( "cbocolortype_1", 70, $color_type,"", 1, "-- Select --", $selected, "","","" ); ?></td>
                        <td>
                            <input type="hidden" id="libyarncountdeterminationid_1" name="libyarncountdeterminationid_1" class="text_boxes" style="width:10px"  />
                            <input type="hidden" id="oldlibyarncountdeterminationid_1" name="oldlibyarncountdeterminationid_1" class="text_boxes" style="width:10px"  />
                            <input type="hidden" id="construction_1" name="construction_1" class="text_boxes" style="width:10px"  />
                            <input type="hidden" id="composition_1" name="composition_1" class="text_boxes" style="width:10px"  />
                            <input type="hidden" id="lastappidchk_1" name="lastappidchk_1" class="text_boxes" style="width:10px" readonly  />
                            <input type="text" id="fabricdescription_1" placeholder="Double Click To Search"  name="fabricdescription_1"  class="text_boxes" style="width:140px" onDblClick="open_fabric_decription_popup(1)"   last_app_id='' readonly />
                        </td>
                        <td><?=create_drop_down( "cbofabricsource_1", 80, $fabric_source, "", 0, "", $fab_source_fld_accs, "enable_disable( this.value,'txtrate_*txtamount_', 1 );fnc_source_for(this.value, 1)","","1,2,3,4" ); ?></td>
                        <td>
						<? asort($commission_particulars); echo create_drop_down( "cbosourceid_1", 70, $commission_particulars, "", 1, "-Select-", "", "",$disabled,"" ); ?></td>
                        <td><? asort($supplier_library_fabric); echo create_drop_down( "cbonominasupplier_1",80, $supplier_library_fabric, "", 1, '-Select-', $row[csf("nominated_supp")],"fnc_load_supplier_source(this.value,1)",$disabled,"" );?>
                            </td>
                        <td><?=create_drop_down( "cbowidthdiatype_1", 60, $fabric_typee,"", 1, "-- Select --", $selected, "","","" ); ?></td>
                        <td>
                            <input type="text" id="txtgsmweight_1" name="txtgsmweight_1" class="text_boxes_numeric" style="width:32px" onBlur="sum_yarn_required()">
                            <input type="hidden" id="avgtxtgsmweight_1" name="avgtxtgsmweight_1" class="text_boxes_numeric" style="width:30px" onBlur="sum_yarn_required()">
                        </td>
                        <td><?=create_drop_down( "cbocolorsizesensitive_1", 100, $size_color_sensitive,"", 1, "-- Select --", 1, "control_color_field(1)","","" ); ?> </td>
                        <td><input type="text" id="txtcolor_1" name="txtcolor_1" class="text_boxes" style="width:65px" onClick="open_color_popup(1);" disabled value="" /></td>
                        <td><?=create_drop_down( "consumptionbasis_1", 70, $consumtion_basis,'', 0, '', '', "","","" ); ?></td>
                        <td><?=create_drop_down( "uom_1", 50, $unit_of_measurement,'', 1, '-Select-','12', "",'',"1,12,23,27" ); ?></td>
                        <td>
                            <input type="text" id="txtconsumption_1" name="txtconsumption_1" onBlur="math_operation( 'txtamount_1', 'txtconsumption_1*txtrate_1', '*','',{dec_type:1,comma:0,currency:document.getElementById('cbo_currercy').value} );sum_yarn_required();set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost' )"  onDblClick="set_session_large_post_data('requires/pre_cost_entry_controller_v2.php?action=consumption_popup', 'Consumption Entry Form','txtbodypart_1','cbofabricnature_1','txtgsmweight_1','1','updateid_1')"    class="text_boxes_numeric" style="width:55px" readonly  />
                            <input type="hidden" id="avgtxtconsumption_1" name="avgtxtconsumption_1" class="text_boxes_numeric" style="width:50px"  readonly/>
                        </td>
                        <td><input type="text" id="txtrate_1" onBlur="math_operation( 'txtamount_1', 'txtconsumption_1*txtrate_1', '*','',{dec_type:1,comma:0, currency:document.getElementById('cbo_currercy').value}); set_sum_value( 'txtamount_sum', 'txtamount_' ,'tbl_fabric_cost');" name="txtrate_1" class="text_boxes_numeric" style="width:40px" readonly> </td>
                        <td><input type="text" id="txtamount_1" onBlur="set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost');" readonly  name="txtamount_1" class="text_boxes_numeric" style="width:60px"></td>
                        <td><input type="text" id="totalqty_1"  name="totalqty_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="Click to Load" onClick="loadTotal(1,'fabric');" readonly /></td>
                        <td>
                            <input type="text" id="totalamount_1"  name="totalamount_1" class="text_boxes_numeric" style="width:60px" value="" readonly />
                            <input type="hidden" id="budgeton_1" name="budgeton_1" value="<?=$fabricBudgetOn; ?>"  />
                        </td>
                        <td>
                            <input type="hidden" id="hiddencolorsizesensitive_1" name="hiddencolorsizesensitive_1" style="width:90px" value="" readonly/>
                            <input type="hidden" id="cbostatus_1" name="cbostatus_1"   class="text_boxes" style="width:90px" value="1" readonly />
                            <input type="button" id="increase_1" style="width:25px" class="formbutton" value="+" onClick="add_break_down_tr(1,this)" />
                            <input type="button" id="decrease_1" style="width:25px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_fabric_cost',this);" />
                            <input type="hidden" id="txtfinishconsumption_1"  name="txtfinishconsumption_1" class="text_boxes_numeric" style="width:60px" readonly/>
                            <input type="hidden" id="txtavgprocessloss_1"  name="txtavgprocessloss_1" class="text_boxes_numeric" style="width:60px"  readonly/>
                            <input type="hidden" id="consbreckdown_1" name="consbreckdown_1" value=""  class="text_boxes" style="width:90px" />
                            <input type="hidden" id="msmntbreackdown_1" name="msmntbreackdown_1" value="" class="text_boxes" style="width:90px" />
                            <input type="hidden" id="markerbreackdown_1" name="markerbreackdown_1" value="" class="text_boxes" style="width:90px" />
                            <input type="hidden" id="colorbreackdown_1" name="colorbreackdown_1" value="" class="text_boxes" style="width:90px" />
                            <input type="hidden" id="yarnbreackdown_1" name="yarnbreackdown_1" value="" class="text_boxes" style="width:90px" />
                            <input type="hidden" id="processlossmethod_1" name="processlossmethod_1"/>
                            <input type="hidden" id="updateid_1" name="updateid_1" value="" class="text_boxes" style="width:20px" />
                            <input type="hidden" id="prifabcostdtlsid_1" name="prifabcostdtlsid_1"  class="text_boxes" style="width:20px"  />
                            <input type="hidden" id="isclickedconsinput_1" name="isclickedconsinput_1"  class="text_boxes" style="width:20px" value="1"  />
                            <input type="hidden" id="plancutqty_1" name="plancutqty_1"  class="text_boxes" style="width:20px"/>
                            <input type="hidden" id="jobplancutqty_1" name="jobplancutqty_1"  class="text_boxes" style="width:20px"/>
                            <input type="hidden" id="precostapproved_1" name="precostapproved_1"  class="text_boxes" style="width:20px" value="0" readonly/>
                            <input type="hidden" id="isconspopupupdate_1" name="isconspopupupdate_1"  class="text_boxes" style="width:20px" value="0" readonly/>
                        </td>
                    </tr>
                <? } ?>

            </tbody>
        </table>
        <br/>

        <table width="1530" cellspacing="0" class="rpt_table" border="0" rules="all" style="display:none">
            <tfoot>
            <?
            $yarn_needed=0;
            $data_array1=sql_select("select fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg, fab_woven_fin_req_yds, fab_knit_fin_req_kg, fab_amount, avg, pro_woven_grey_fab_req_yds, pro_knit_grey_fab_req_kg, pro_woven_fin_fab_req_yds, pro_knit_fin_fab_req_kg, pur_woven_grey_fab_req_yds, pur_knit_grey_fab_req_kg, pur_woven_fin_fab_req_yds, pur_knit_fin_fab_req_kg, woven_amount, knit_amount from wo_pre_cost_sum_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0");

            list($sum_data_array )=$data_array1;
            /*foreach ($data_array as $row)
            {*/
                $avg_value="";
                if($sum_data_array[csf("avg")]=="")$avg_value="Make AVG"; else $avg_value=$sum_data_array[csf("avg")];
            ?>
                    <tr>
                        <th width="250">
                        <input type="button" id="avg" style="width:70px; display:none" class="formbutton" value="<?=$avg_value; ?>" /> &nbsp; Yarn Required(Kg)
                        <input type="text" id="tot_yarn_needed" name="tot_yarn_needed" class="text_boxes_numeric" style="width:50px;" value="<? echo $sum_data_array[csf("fab_yarn_req_kg")];$yarn_needed= $sum_data_array[csf("fab_yarn_req_kg")];?>" readonly/>
                        </th>
                        <th width="850">
                            Woven Grey Fab Req.(Yds)<input type="text" id="txtwoven_sum" name="txtwoven_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_woven_req_yds")] ?>" readonly />
                            Knit Grey Fab Req.(Kg)<input type="text" id="txtknit_sum"  name="txtknit_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_knit_req_kg")] ?>" readonly>
                            Woven Fin. Fab Req.(Yds)<input type="text" id="txtwoven_fin_sum" name="txtwoven_fin_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_woven_fin_req_yds")] ?>" readonly />
                            Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum"  name="txtknit_fin_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_knit_fin_req_kg")] ?>"  readonly>
                        </th>
                        <th width="80">&nbsp;</th>
                        <th width="60">&nbsp;</th>
                        <th width="70"><input type="text" id="txtamount_sum" name="txtamount_sum" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("fab_amount")] ?>"  readonly></th>
                        <th width="70">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th colspan="2">
                            Pro. Woven Grey Fab Req.(Yds)
                            <input type="text" id="txtwoven_sum_production" name="txtwoven_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_woven_grey_fab_req_yds")] ?>" readonly />
                            Pro. Knit Grey Fab Req.(Kg) <input type="text" id="txtknit_sum_production" name="txtknit_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_knit_grey_fab_req_kg")] ?>"  readonly>
                            Pro. Woven Fin. Fab Req.(Yds)
                            <input type="text" id="txtwoven_fin_sum_production" name="txtwoven_fin_sum_production" class="text_boxes_numeric" style="width:60px" value="<?  echo $sum_data_array[csf("pro_woven_fin_fab_req_yds")] ?>" readonly />
                            Pro. Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum_production" name="txtknit_fin_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_knit_fin_fab_req_kg")] ?>" readonly>
                        </th>
                        <th width="80">&nbsp;</th>
                        <th width="60">&nbsp;</th>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th colspan="2">
                            Pur. Woven Grey Fab Req.(Yds)
                            <input type="text" id="txtwoven_sum_purchase" name="txtwoven_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_woven_grey_fab_req_yds")] ?>" readonly />
                            Pur. Knit Grey Fab Req.(Kg) <input type="text" id="txtknit_sum_purchase"  name="txtknit_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_knit_grey_fab_req_kg")] ?>"  readonly>
                            Pur. Woven Fin. Fab Req.(Yds)
                            <input type="text" id="txtwoven_fin_sum_purchase" name="txtwoven_fin_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<?  echo $sum_data_array[csf("pur_woven_fin_fab_req_yds")] ?>" readonly />
                            Pur. Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum_purchase"  name="txtknit_fin_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_knit_fin_fab_req_kg")] ?>"  readonly>
                        </th>
                        <th width="80">Woven  Amt</th>
                        <th width="60"><input type="text" id="txtwoven_amount_sum_purchase" name="txtwoven_amount_sum_purchase" class="text_boxes_numeric" style="width:55px" value="<? echo $sum_data_array[csf("woven_amount")] ?>"  readonly></th>
                        <th width="60">Kint  Amt</th>
                        <th width="70"><input type="text" id="txtkint_amount_sum_purchase" name="txtkint_amount_sum_purchase" class="text_boxes_numeric" style="width:55px" value="<? echo $sum_data_array[csf("knit_amount")] ?>"  readonly></th>
                        <th>&nbsp;</th>
                    </tr>
                    <? //}?>
                </tfoot>
            </table>
            <table width="1490" cellspacing="0" class="" border="0">
                <tr>
                    <td align="right" width="50%" class="button_container">
                    <? $is_seq_load=0;
					if($data[6]==0)//Bom Of Fabric ISD-21-29440
					{
                        if ( count($data_array)>0)
                        {
                            echo load_submit_buttons( $permission, "fnc_fabric_cost_dtls", $save_update,0,"reset_form('fabriccost_3','','', 'cbofabricnature_,3,$i')",3) ;
							$is_seq_load=1;
                        }
                        else
                        {
                            echo load_submit_buttons( $permission, "fnc_fabric_cost_dtls", 0,0,"reset_form('fabriccost_3','','',0)",3) ;
                        }
					} 
                    ?>
                    </td>
                    <td align="left" width="50%" class="button_container" valign="top">
                    <?
					$stripeChange=0;
					//echo $data[0]; die;
					if($save_update==1)
					{
						$condition= new condition();
						if(str_replace("'","",$data[0]) !=''){
							$condition->job_no("='$data[0]'");
						}
						$condition->init();
						$gmtsitemRatioArr=$condition->getGmtsitemRatioArr();
						$cost_per_qty_arr=$condition->getCostingPerArr();
						//print_r($cost_per_qty_arr);
						$fabric= new fabric($condition);
						$fabric_costing_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();
	
						$sql_data=sql_select("SELECT a.job_no, b.id, c.item_number_id, c.color_number_id, c.order_quantity, c.plan_cut_qnty, d.id as pre_cost_dtls_id from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e where 1=1 and a.id=b.job_id and b.id=c.po_break_down_id and a.job_no='$data[0]' and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id=d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and e.cons!=0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
						$stripeplan_cutarr=array();
						foreach($sql_data as $row){
							$stripeplan_cutarr[$row[csf('pre_cost_dtls_id')]][$row[csf('color_number_id')]]['plan']+=$row[csf('plan_cut_qnty')];
							$stripeplan_cutarr[$row[csf('pre_cost_dtls_id')]][$row[csf('color_number_id')]]['ratio']=$gmtsitemRatioArr[$data[0]][$row[csf('item_number_id')]];
						}
						unset($sql_data);
	
						$costingperReqQty=array();
	
						foreach($fabric_costing_arr['knit']['grey'] as $fabricrowid=>$fabcolordata)
						{
							foreach($fabcolordata as $fabriccolorid=>$colordata)
							{
								$planqty=$colorreq=$gmtsitemRatio=0;
								$planqty=$stripeplan_cutarr[$fabricrowid][$fabriccolorid]['plan'];
								$colorreq=array_sum($colordata);
								$gmtsitemRatio=$stripeplan_cutarr[$fabricrowid][$fabriccolorid]['ratio'];
								//echo $colorreq.'-'.$planqty.'-'.$cost_per_qty_arr[$data[0]].'-'.$gmtsitemRatio.'<br>';
								$costingperReqQty[$fabricrowid][$fabriccolorid]=number_format(($colorreq/$planqty)*$cost_per_qty_arr[$data[0]]*$gmtsitemRatio,6);
							}
						}
	
						$sql_data=sql_select("SELECT pre_cost_fabric_cost_dtls_id, color_number_id, sum(fabreq) as fabreq from wo_pre_stripe_color where job_no='$data[0]' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id, color_number_id");
						$stripeChange=0; $stripeChangearr=array();
						foreach($sql_data as $row){
							if($row[csf('fabreq')]=="") $row[csf('fabreq')]=0;
	
							if($row[csf('fabreq')]!=0)
							{
								//echo $costingperReqQty[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('color_number_id')]].'='.$row[csf('fabreq')].'<br>';
								if(number_format($costingperReqQty[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('color_number_id')]],6)!=number_format($row[csf('fabreq')],6))
								{
									$stripeChange=1;
									$stripeChangearr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=1;
								}
							}
						}
					}
					//die;
					$stripebtncolor="";
					if($stripeChange==1) $stripebtncolor="background:#FF0000";


					if($data[6]==0)//Bom Of Fabric ISD-21-29440
					{
                        if ( count($data_array)>0)//
                        {
                            ?>
                            <input type="button" style="width:100px;<?=$stripebtncolor; ?>" class="formbutton" name="stripe_color" id="stripe_color" value="Stripe Color" onClick="open_stripe_color_popup();"/> &nbsp;
                            <input type="button" class="formbutton" style="width:80px;" name="add_img" id="add_img" value="Color Img" onClick="open_fabric_color_image_popup();"/>
							<input type="button" class="formbutton" style="width:80px;" name="fabric_price" id="fabric_price" value="..." onClick="open_fabric_price_popup();"/>
                            <?
                        }
					}
                    ?>
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    </div>

       <h3 style="width:1150px;" align="left" id="accordion_h_yarn" class="accordion_h" onClick="show_hide_content('yarn_cost', '');">+Yarn Cost <?=$approved_message; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Total Yarn Needed:&nbsp;<span id="tot_yarn_needed_span"><?=$yarn_needed; ?></span></h3>
       <div id="content_yarn_cost" style="display:none;">
    	<fieldset style="width:1150px;">
        	<form id="yarnccost_4" autocomplete="off">
            	<table width="1150" cellspacing="0" class="rpt_table" border="0" id="tbl_yarn_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="30">F.Seq</th>
                        	<th width="60">Count</th>
                            <th width="100" class="must_entry_caption">Comp 1</th>
                            <th width="50" class="must_entry_caption">%</th>
                            <th width="80">Color</th>
                            <th width="110">Type</th>
                            <th width="80">Yarn Finish</th>
                        	<th width="80">Yarn Spinning System</th>
                        	<th width="80">Certification</th>
                            <th width="75" class="must_entry_caption">Cons Qty.</th>
                            <th width="120">Supplier</th>
                            <th width="50">Rate</th>
                            <th width="80">Amount</th>
                            <th width="70">Total R.Qty</th>
                    		<th>Total R.Amt</th>
                            <th style="display:none">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$lib_yarn_count=return_library_array( "select id, yarn_count from lib_yarn_count where is_deleted=0 and status_active=1 order by yarn_count", "id", "yarn_count");
					if($color_from_library==1)
					{
						$readonly="readonly='readonly'"; $plachoder="placeholder='Click'"; $onClick="onClick='color_select_popup($data[4],this.id)'";
					}
					else
					{
						$readonly=""; $plachoder=""; $onClick="";
					}

					/*$sqlPurReq=sql_select("select a.requ_no, b.count_id, b.composition_id, b.com_percent, b.yarn_type_id from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$data[0]' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
					$purReqArr=array();

					foreach($sqlPurReq as $prow)
					{
						$purReqArr[$prow[csf('count_id')]][$prow[csf('composition_id')]][$prow[csf('com_percent')]][$prow[csf('yarn_type_id')]]=$prow[csf('requ_no')];
					}*/
					//print_r($purReqArr);

					$save_update=1;
                    $data_array=sql_select("select id, fabric_cost_dtls_id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id, cons_ratio, cons_qnty, avg_cons_qnty,supplier_id, rate, amount, status_active, yarn_finish, yarn_spinning_system, certification from wo_pre_cost_fab_yarn_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 order by id");
					if(count($data_array)<1 && $data[2]==1  && $data[5]==2)
					{
						$data_array=sql_select("select id as pri_id, fabric_cost_dtls_id as prifabdtlsid, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, supplier_id, rate, amount, status_active, yarn_finish, yarn_spinning_system from wo_pri_quo_fab_yarn_cost_dtls where quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by id");
						$save_update=0;
					}
					if (count($data_array) < 1 && $data[2]==1)
					{
						if($data[5]==5 || $data[5]==8)//Short Quotation V2 Or Short Quotation -V6
						{
						$data_array=sql_select("select id as pri_id, cons_rate_dtls_id as prifabdtlsid, count as count_id, composition as copm_one_id, percent as percent_one, 0 as copm_two_id, 0 as percent_two, '' as color, yarn_type as type_id, 0 as cons_ratio, cons as cons_qnty, tot_cons as avg_cons_qnty, nominated_supp_multi as supplier_id, rate, value as amount, status_active, 0 as yarn_finish, 0 as yarn_spinning_system, 0 as certification from qc_fab_yarn_conv where qc_no='$data[1]' and type=2 and cons>0 and status_active=1 and is_deleted=0 order by id");
						$save_update=0;
						}
					}

					if(count($data_array)>0)
					{
						$i=0;
						$tot_cons=0;
						foreach( $data_array as $row )
						{
							$i++;
							$tot_cons=$tot_cons+$row[csf("cons_qnty")];
							$disabled=0; $btn_disabled=0; $txt_dis="";

							if($approved==1) $disabled=1; else $disabled=0;
							if($component_approved==1)
							{
								$disabled=1; $btn_disabled=1; $txt_dis="disabled";
								//echo "A";
							}
							if($approved!=1)
							{
								$disabled=0; $btn_disabled=0;
								if($is_booking_arr[$row[csf('fabric_cost_dtls_id')]]!="")
								{
									$disabled=1; $btn_disabled=1; $txt_dis="disabled";
									//echo "B";
								}
							}
							else if( $component_approved!=1)
							{
								$disabled=0; $btn_disabled=0;
								if($is_booking_arr[$row[csf('fabric_cost_dtls_id')]]!="") {
									$disabled=1; $btn_disabled=1; $txt_dis="disabled";
									//echo "C";
								}
							}
							/*if ($purReqArr[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('percent_one')]][$row[csf('type_id')]]!="" && $row[csf("rate")]>0)
							{
								$disabled=1; $btn_disabled=1; $txt_dis="disabled";
								//echo "D";
							}*/

							$is_apply_last_update=$applyLastUpdateArr[$row[csf("fabric_cost_dtls_id")]]; $changedmsgcolor=""; $is_last_app_msg="";$is_last_app_msg_id=0;
							if($is_apply_last_update==2)
							{
								$is_last_app_msg="Color Size Changed.";
								$is_last_app_msg_id="1";
								$changedmsgcolor="Red";
							}
							if($row[csf("rate")]=="" || $row[csf("rate")]==0) $yarnchangeFound="Red"; else $yarnchangeFound="";

							$isDisBomOfFab=0; $cboDis=0; $cboDis2=0;
							if($data[6]==1)//Bom Of Fabric ISD-21-29440
							{
								$uid=$_SESSION['logic_erp']['user_id'];
								$sqlUserDept=sql_select("select b.department_name from user_passwd a, lib_department b where a.department_id=b.id and a.id='$uid' and a.valid = 1");
								$userDepartment=$sqlUserDept[0][csf('department_name')];
								//$userDepartment="Merchandising";
								$user_level=$_SESSION['logic_erp']["user_level"];
							}
							if($data[6]==1 && $user_level==2)//Bom Of Fabric and admin user ISD-21-29440
							{
								$isDisBomOfFab=1;
								$cboDis=0;
								$cboDis2=0;
							}
							else if($data[6]==1 && $user_level!=2 && strtolower(trim($userDepartment))==strtolower("Knitting"))//Bom Of Fabric and Knitting Dept. user ISD-21-29440
							{
								$isDisBomOfFab=1;
								$cboDis=0;
								$cboDis2=1;
							}
							else if($data[6]==1 && $user_level!=2 && strtolower(trim($userDepartment))==strtolower("Merchandising"))//Bom Of Fabric and Merchandising Dept. user ISD-21-29440
							{
								$isDisBomOfFab=1;
								$cboDis=1;
								$cboDis2=0;
							}
							else if ($disabled!=0)
							{
								$isDisBomOfFab=1;
								$cboDis=$disabled;
								$cboDis2=$disabled;
							}
							//echo $isDisBomOfFab.'-'.$txt_dis.'<br>';
							//$cboDis=$disabled;
							if($is_seq_load==1) $yarnFabSeqNo=$fab_id_wise_item[$row[csf("fabric_cost_dtls_id")]]['seq'];
							else $yarnFabSeqNo=$fab_id_wise_item[$row[csf("prifabdtlsid")]]['seq'];
							//echo $isDisBomOfFab.'='.$txt_dis.'='.$component_approved.'<br>';
							?>
                            <tr id="yarncost_<?=$i; ?>" align="center">
                            	<td><input type="text" id="txtyarnseq_<?=$i; ?>" name="txtyarnseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$row[csf("fabric_cost_dtls_id")]]['seq']; ?>" <?=$txt_dis; ?> /></td>
                                <td><?=create_drop_down( "cbocount_".$i, 60, $lib_yarn_count, "",1,"-- Select Item --", $row[csf("count_id")], "",$cboDis,"" ); ?> </td>
                                <td title="<?=$composition[$row[csf("copm_one_id")]] ?>"><?=create_drop_down( "cbocompone_".$i, 100, $composition,"", 1, "-- Select --", $row[csf("copm_one_id")], "control_composition($i,this.id,'percent_one')",$cboDis2,"","",$ommitComposition ); ?>
								<input type="hidden" id="componeid_<?=$i; ?>" value="<?= $row[csf("copm_one_id")] ?>">
								</td>
                                <td><input type="text" id="percentone_<?=$i; ?>"  name="percentone_<?=$i; ?>" class="text_boxes_numeric" style="width:38px; background-color:<?=$changedmsgcolor; ?>" onChange="control_composition(<?=$i; ?>,this.id,'percent_one');" value="<?=$row[csf("percent_one")]; ?>" <? if($isDisBomOfFab==0){echo "";}else{echo "disabled ";} ?> <?= $txt_dis?>  readonly/></td>
                                <td><input type="text" id="color_<?=$i; ?>" name="color_<?=$i; ?>" class="text_boxes" style="width:68px" <?=$onClick; echo $readonly; echo $plachoder; ?> value="<?=$color_library[$row[csf("color")]]; ?>" <? if($isDisBomOfFab==0){echo "";}else{echo "disabled";} ?> <?= $txt_dis?> /></td>
                                <td><?=create_drop_down( "cbotype_".$i, 110, $yarn_type,"", 1, "-- Select --", $row[csf("type_id")], "",$cboDis2,"","","",$ommitYarnType ); ?></td>
                                <td><?=create_drop_down( "cboyarnfinish_".$i, 80, $yarn_finish_arr,"", 1, "-- Select --", $row[csf("yarn_finish")], "",$isDisBomOfFab,"","","" ); ?></td>
                                <td><?=create_drop_down( "cboyarnsnippingsystem_".$i, 80, $yarn_spinning_system_arr,"", 1, "-- Select --", $row[csf("yarn_spinning_system")], "",$isDisBomOfFab,"","","" ); ?></td>
                                <td><?=create_drop_down( "cbocertification_".$i, 80, $certification_arr,"", 1, "-- Select --", $row[csf("certification")], '',$isDisBomOfFab,'','','' ); ?></td>
                                <td>
                                    <input type="text" id="consqnty_<?=$i; ?>" name="consqnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:63px" onChange=" calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount');"  value="<?=number_format($row[csf("cons_qnty")],6,'.',''); ?>" <? if($isDisBomOfFab==0){echo "";}else{echo "disabled";} ?> readonly />
                                    <input type="hidden" id="avgconsqnty_<?=$i; ?>" name="consqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" onChange=" calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount');" value="<?=$row[csf("avg_cons_qnty")]; ?>" <? if($isDisBomOfFab==0){echo "";}else{echo "disabled";} ?> />
                                </td>
                                <td><?=create_drop_down( "supplier_".$i, 120, $supplier_library_yarn, "",1," -- Select --", $row[csf("supplier_id")], "set_yarn_rate($i)",$isDisBomOfFab,'' ); ?></td>
                                <td>
                                    <input type="text" id="txtrateyarn_<?=$i; ?>" name="txtrateyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:38px; background-color:<?=$yarnchangeFound; ?>" onChange="calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount');" value="<?=$row[csf("rate")]; ?>" <? if($isDisBomOfFab==0){echo "";}else{echo "disabled";} ?> <?=$txt_dis; ?> />
                                </td>
                                <td><input type="text" id="txtamountyarn_<?=$i; ?>" name="txtamountyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="<?=number_format($row[csf("amount")],6,'.',''); ?>" readonly/></td>
                                <td><input type="text" id="totalyqty_<?=$i; ?>" name="totalyqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Yarn');" readonly poqty="" planqty="" /></td>
                            	<td>
                                	<input type="text" id="totalyamount_<?=$i; ?>" name="totalyamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly />
                                    <input type="hidden" id="updateidyarncost_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>"  />
                                </td>
                                <td style="display:none"><?=create_drop_down( "cbostatusyarn_".$i, 80, $row_status, "", 0, "", $row[csf("status_active")], "",$isDisBomOfFab,"" ); ?></td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						$data_array_p=sql_select("select id, count_id, copm_one_id, percent_one, type_id, cons_ratio, cons_qnty, avg_cons_qnty, supplier_id from wo_pre_cost_fab_yarnbreakdown where job_no='$data[0]' and status_active=1 and is_deleted=0  order by id");
						if ( count($data_array)>0)
					    {
							$i=0;
							$tot_cons=0;
							foreach( $data_array_p as $row_p )
							{
								$i++;
								$tot_cons=$tot_cons+$row_p[csf("cons_qnty")];
								?>
								<tr id="yarncost_<?=$i; ?>" align="center">
                                	<td><input type="text" id="txtyarnseq_<?=$i; ?>" name="txtyarnseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$row[csf("fabric_cost_dtls_id")]]['seq']; ?>" /></td>
                                   <td><?=create_drop_down( "cbocount_".$i, 60, $lib_yarn_count, "",1,"--Select Item--", $row_p[csf("count_id")], '','',''); ?></td>
                                   <td title="<?=$composition[$row_p[csf("copm_one_id")]]; ?>"><?=create_drop_down( "cbocompone_".$i,100, $composition,"", 1, "-- Select --", $row_p[csf("copm_one_id")], "control_composition($i,this.id,'comp_one')",'','','','',$ommitComposition ); ?>
								   <input type="hidden" id="componeid_<?=$i; ?>" value="<?= $row_p[csf("copm_one_id")]?>">
								</td>
                                   <td><input type="text" id="percentone_<?=$i; ?>" name="percentone_<?=$i; ?>" class="text_boxes" style="width:38px" onChange="control_composition(<?=$i; ?>,this.id,'percent_one');" value="<?=$row_p[csf("percent_one")]; ?>" readonly/></td>
                                   <td><input type="text" id="color_<?=$i; ?>" name="color_<?=$i; ?>" class="text_boxes" style="width:68px" <?=$onClick; echo $readonly; echo $plachoder; ?> value="<?=$row_p[csf("color")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> /></td>
                                   <td><?=create_drop_down( "cbotype_".$i, 110, $yarn_type,"", 1, "-- Select --", $row_p[csf("type_id")], '','','','','',$ommitYarnType ); ?></td>
                                   <td><?=create_drop_down( "cboyarnfinish_".$i, 80, $yarn_finish_arr,"", 1, "-- Select --", $row_p[csf("type_id")], '','','','','' ); ?></td>
                                   <td><?=create_drop_down( "cboyarnsnippingsystem_".$i, 80, $yarn_spinning_system_arr,"", 1, "-- Select --", $row_p[csf("type_id")], '','','','','' ); ?></td>
                                   <td><?=create_drop_down( "cbocertification_".$i, 80, $certification_arr,"", 1, "-- Select --", $row_p[csf("security")], '','','','','' ); ?></td>
                                   <td>
                                        <input type="text" id="consqnty_<?=$i; ?>" name="consqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:63px" onChange=" calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount')"  value="<?=number_format($row_p[csf("cons_qnty")],6,'.',''); ?>" readonly/>
                                        <input type="hidden" id="avgconsqnty_<?=$i; ?>" name="consqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" onChange=" calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount');" value="<?=$row[csf("avg_cons_qnty")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                   </td>
                                   <td><?=create_drop_down( "supplier_".$i, 120, $supplier_library_yarn, "",1," -- Select --", $row_p[csf("supplier_id")], "set_yarn_rate($i)",'','' ); ?></td>
                                    <td><input type="text" id="txtrateyarn_<?=$i; ?>" name="txtrateyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:38px" onChange="calculate_yarn_consumption_ratio(<? echo $i; ?>,'calculate_amount')" value="" /></td>
                                    <td><input type="text" id="txtamountyarn_<?=$i; ?>" name="txtamountyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value=""  readonly/></td>
                                    <td><input type="text" id="totalyqty_<?=$i; ?>" name="totalyqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Yarn');" readonly poqty="" planqty="" /></td>
                            		<td>
                                    	<input type="text" id="totalyamount_<?=$i; ?>" name="totalyamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly />
                                        <input type="hidden" id="updateidyarncost_<?=$i; ?>" name="updateidyarncost_<?=$i; ?>" class="text_boxes" style="width:20px" value=""  />
                                        </td>
                                    <td style="display:none"><?=create_drop_down( "cbostatusyarn_".$i, 80, $row_status,"", 0, "0", '', '','','' );  ?></td>
                                </tr>
								<?
							}
						}
						else
						{
							?>
							<tr id="yarncost_1" align="center">
                            	<td><input type="text" id="txtyarnseq_1" name="txtyarnseq_1" class="text_boxes_numeric" style="width:18px" value="1" /></td>
                                <td><?=create_drop_down( "cbocount_1", 60, "select id,yarn_count from  lib_yarn_count where is_deleted=0 and status_active=1 order by yarn_count", "id,yarn_count",1," -- Select Item --", $row_p[csf("count_id")], '','','' ); ?></td>
                                <td><?=create_drop_down( "cbocompone_1",100, $composition,"", 1, "-- Select --", $row_p[csf("copm_one_id")], "control_composition(1,this.id,'comp_one')",'','','','',$ommitComposition ); ?>
								<input type="hidden" id="componeid_1" value="0">
							</td>
                                <td><input type="text" id="percentone_1" name="percentone_1" class="text_boxes" style="width:38px" onChange="control_composition( 1, this.id, 'percent_one');" value="100" readonly /></td>
                                <td><input type="text" id="color_1" name="color_1" class="text_boxes" style="width:68px" <?=$onClick; echo $readonly; echo $plachoder; ?> value="<? //echo $row_p[csf("color")]; ?>" /></td>
                                <td><?=create_drop_down( "cbotype_1", 110, $yarn_type,"", 1, "-- Select --", $row_p[csf("type_id")], '','','','','',$ommitYarnType ); ?></td>
                                <td><?=create_drop_down( "cboyarnfinish_1", 80, $yarn_finish_arr,"", 1, "-- Select --", $row_p[csf("yarn_finish")], '','','','','' ); ?></td>
                                <td><?=create_drop_down( "cboyarnsnippingsystem_1", 80, $yarn_spinning_system_arr,"", 1, "-- Select --", $row_p[csf("yarn_spinning_system")], '','','','','' ); ?></td>
                                <td><?=create_drop_down( "cbocertification_1", 80, $certification_arr,"", 1, "-- Select --", $row_p[csf("security")], '','','','','' ); ?></td>
                                <td><input type="text" id="consqnty_1" name="consqnty_1" class="text_boxes_numeric" style="width:63px" onChange=" calculate_yarn_consumption_ratio(1,'calculate_amount')"  value="<? echo number_format($row_p[csf("cons_qnty")],6,'.',''); ?>" readonly/>
                                	<input type="hidden" id="avgconsqnty_1" name="avgconsqnty_1" class="text_boxes_numeric" style="width:60px" onChange=" calculate_yarn_consumption_ratio(1,'calculate_amount')" />
                                </td>
                                <td><?=create_drop_down( "supplier_1", 120, $supplier_library_yarn, "",1," -- Select --", $row_p[csf("supplier_id")], "set_yarn_rate(1)",'','' ); ?></td>
                                <td><input type="text" id="txtrateyarn_1"  name="txtrateyarn_1" class="text_boxes_numeric" style="width:38px" onChange="calculate_yarn_consumption_ratio(1,'calculate_amount')" value="" /></td>
                                <td><input type="text" id="txtamountyarn_1" name="txtamountyarn_1" class="text_boxes_numeric" style="width:68px" value="" readonly/></td>
                                <td>
                                	<input type="text" id="totalyqty_1" name="totalyqty_1" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(1,'Yarn');" readonly poqty="" planqty="" />
                                	<input type="hidden" id="updateidyarncost_1" name="updateidyarncost_1" class="text_boxes" style="width:20px" value=""  />
                                </td>
                            	<td><input type="text" id="totalyamount_1" name="totalyamount_1" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>
                                <td style="display:none"><?=create_drop_down( "cbostatusyarn_1", 80, $row_status,"", 0, "0", '', '','','' );  ?></td>
                            </tr>
                        <?
						}
					}
					?>
                	</tbody>
                </table>
                <table width="1150" cellspacing="0" class="rpt_table" border="0" rules="all">
                    <tfoot>
                        <tr>
                        	<th width="30">&nbsp;</th>
                        	<th width="60">&nbsp;</th>
                            <th width="100">&nbsp;</th>
                            <th width="50">&nbsp;</th>
                            <th width="80">&nbsp;</th>
                            <th width="110">&nbsp;</th>
                            <th width="80">&nbsp;</th>
                        	<th width="80">&nbsp;</th>
                        	<th width="80">SUM :</th>
                            <th width="75">
                            	<input type="text" id="txtconsumptionyarn_sum" name="txtconsumptionyarn_sum" class="text_boxes_numeric" style="width:63px" value="<?=number_format($tot_cons,6,'.',''); ?>" readonly>
                            	<input type="hidden" id="txtavgconsumptionyarn_sum" name="txtavgconsumptionyarn_sum" class="text_boxes_numeric" style="width:60px" value="<?=$tot_cons; ?>" readonly>
                            </th>
                            <th width="120">&nbsp;</th>
                            <th width="50">&nbsp;</th>
                            <th width="80"><input type="text" id="txtamountyarn_sum" name="txtamountyarn_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                            <td width="70"><input type="text" id="totalyarnqty" name="totalyarnqty" class="text_boxes_numeric" style="width:58px" value="" readonly  /></td>
                            <td><input type="text" id="totalyarnamount" name="totalyarnamount" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>
                            <th style="display:none">&nbsp;</th>
                        </tr>
                    </tfoot>
                </table>
                <table width="1150" cellspacing="0" class="" border="0">
                    <tr>
                        <td align="center" width="100%" class="button_container">
                        <?
                        if (count($data_array)>0)
                        {
                        	echo load_submit_buttons( $permission, "fnc_fabric_yarn_cost_dtls", $save_update,0,"reset_form('yarnccost_4','','',0)",4) ;

                        }
                        else
                        {
                        	echo load_submit_buttons( $permission, "fnc_fabric_yarn_cost_dtls", $save_update,0,"reset_form('yarnccost_4','','',0)",4) ;
                        }
                        ?>
						 <input class="formbutton" type="button" onDblClick="openmypage_po();" value="Comment" style="width:80px;">
						 <input class="formbutton" type="button" onClick="fnSendMail('../../','hidd_job_id',1,1,0,0)" value="Confirm" style="width:80px;">
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        </div>

       <h3 style="width:945px;" align="left" class="accordion_h" onClick="show_hide_content('conversion_cost', '')">+Conversion Cost <?=$approved_message; ?></h3>
       <div id="content_conversion_cost" style="display:none;" align="left">
    	<fieldset style="width:945px;">
        	<form id="conversionccost_5" autocomplete="off">
            	<table width="945" cellspacing="0" class="rpt_table" border="0" id="tbl_conversion_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="30">F.Seq</th>
                        	<th width="235">Fabric Description</th>
                            <th width="110">Process</th>
                            <th width="50">Process Loss</th>
                            <th width="50">Req. Qty</th>
                            <th width="50">Avg. Req. Qty <font style="font-size:9px; font-weight:100">[Less Process Loss]</font></th>
                            <th width="50">Charge/ Unit</th>
                            <th width="70">Amount</th>
                            <th width="70">Total R.Qty</th>
                    		<th width="70">Total R.Amt</th>
                            <th width="60">Status</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					if($conversion_from_chart==1) $readonly="readonly"; $readonly="";

					$fabric_determination_id = implode(",", $yarn_count_id_arr);
					$process_loss_arr = sql_select("SELECT process_id as PROCESS_ID, process_loss as PROCESS_LOSS, rate as RATE, mst_id as MST_ID from conversion_process_loss where mst_id in ($fabric_determination_id) and status_active=1 and is_deleted=0 and rate <>0");
					$process_loss_data_arr =array();
					foreach ($process_loss_arr as $row) {
						$process_loss_data_arr[$row['MST_ID']][$row['PROCESS_ID']]['PROCESS_ID'] = $row['PROCESS_ID'];
						$process_loss_data_arr[$row['MST_ID']][$row['PROCESS_ID']]['PROCESS_LOSS'] = $row['PROCESS_LOSS'];
						$process_loss_data_arr[$row['MST_ID']][$row['PROCESS_ID']]['RATE'] = $row['RATE'];
					}

				$data_array_color_strip=sql_select("select  b.id,b.convchargelibraryid,b.conv_cost_dtls_id,b.fabric_cost_dtls_id,b.gmts_color_id,b.fabric_color_id,b.cons,b.unit_charge,c.stripe_color from wo_pre_cost_fab_conv_cost_dtls a, wo_pre_cos_conv_color_dtls b ,wo_pre_stripe_color c where
			 a.id=b.conv_cost_dtls_id and a.fabric_description=b.fabric_cost_dtls_id and a.fabric_description=c.pre_cost_fabric_cost_dtls_id
			and b.fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id  and b.gmts_color_id=c.color_number_id and b.fabric_color_id=c.stripe_color
			  and b.job_no='$data[0]'  and a.status_active=1 and b.status_active=1 and c.status_active=1  order by b.id");

			  foreach ($data_array_color_strip as $row)
			  {
				  $color_chk_dtlsArr[$row[csf('conv_cost_dtls_id')]][$row[csf('gmts_color_id')]].=$row[csf('stripe_color')].',';
			  }
			  unset($data_array_color_strip);
			$data_array_color_dtls=sql_select("select a.cons_process, b.convchargelibraryid, b.conv_cost_dtls_id, b.fabric_cost_dtls_id, b.gmts_color_id, b.fabric_color_id, b.cons, b.unit_charge from wo_pre_cost_fab_conv_cost_dtls a, wo_pre_cos_conv_color_dtls b  where a.id=b.conv_cost_dtls_id and a.fabric_description=b.fabric_cost_dtls_id  and b.job_no='$data[0]'  and a.status_active=1 and b.status_active=1  order by b.id");

		foreach ($data_array_color_dtls as $row) {
			$strip_color=rtrim($color_chk_dtlsArr[$row[csf('conv_cost_dtls_id')]][$row[csf('gmts_color_id')]],',');
			$strip_colorArr=array_unique(explode(",",$strip_color));
			if($row[csf('cons_process')]==30)
			{
				if(($row[csf('conv_cost_dtls_id')]*1)>0 && in_array($row[csf('fabric_color_id')],$strip_colorArr))
				{
					if($row[csf('gmts_color_id')]=="") $row[csf('gmts_color_id')]=0;
					if($row[csf('unit_charge')]=="") $row[csf('unit_charge')]=0;
					if($row[csf('convchargelibraryid')]=="") $row[csf('convchargelibraryid')]=0;
					if($row[csf('fabric_color_id')]=="") $row[csf('fabric_color_id')]=0;
					if($row[csf('cons')]=="") $row[csf('cons')]=0;
					if(array_key_exists($row[csf('conv_cost_dtls_id')],$color_dtlsArr))
					{
						$color_dtlsArr[$row[csf('conv_cost_dtls_id')]].="__".$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
					}
					else
					{
						$color_dtlsArr[$row[csf('conv_cost_dtls_id')]]=$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
					}
				}
			}
			else
			{
				if($row[csf('gmts_color_id')]=="") $row[csf('gmts_color_id')]=0;
				if($row[csf('unit_charge')]=="") $row[csf('unit_charge')]=0;
				if($row[csf('convchargelibraryid')]=="") $row[csf('convchargelibraryid')]=0;
				if($row[csf('fabric_color_id')]=="") $row[csf('fabric_color_id')]=0;
				if($row[csf('cons')]=="") $row[csf('cons')]=0;
				if(array_key_exists($row[csf('conv_cost_dtls_id')],$color_dtlsArr))
				{
					$color_dtlsArr[$row[csf('conv_cost_dtls_id')]].="__".$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
				}
				else
				{
					$color_dtlsArr[$row[csf('conv_cost_dtls_id')]]=$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
				}
			}
		}
	 	unset($data_array_color_dtls);
		//print_r($color_dtlsArr);

		$save_update=1;
		$data_array=sql_select("select id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, is_apply_last_update, charge_unit, amount, color_break_down,color_break_down_aop, charge_lib_id, status_active from wo_pre_cost_fab_conv_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 order by fabric_description ,id asc");

		if(count($data_array)>1){
			foreach ($data_array as $row) {
				$saved_conversion[$row[csf('fabric_description')]]=$row[csf('fabric_description')];
			}
		}
		$not_yet_saved_yarn=array();
		if(count($saved_conversion)!= count($yarn_count_id_arr))
		{
			$not_yet_saved_yarn=array_diff_key($yarn_count_id_arr,$saved_conversion);
		}
		/*echo '<pre>';
		print_r($not_yet_saved_yarn); die;*/
		if(count($data_array)<1 && $data[2]==1 && $data[5]==2)
		{
			$data_array=sql_select("select id as pri_id, quotation_id, cost_head, cons_type,process_loss, req_qnty, charge_unit, amount, status_active from  wo_pri_quo_fab_conv_cost_dtls where quotation_id='$data[1]' and status_active=1 and is_deleted=0 ");

			$save_update=0;
		}
		if (count($data_array) < 1 && $data[2]==1 )
		{
			if( $data[5]==5 || $data[5]==8)//Short Quotation V2 Or Short Quotation -V6
			{
			$data_array=sql_select("select id as pri_id, '' as job_no, '' as fabric_description, process as cons_process, exper as process_loss, cons as req_qnty, 0 as avg_req_qnty, 0 as is_apply_last_update, rate as charge_unit, value as amount, '' as color_break_down, yarn_lib_id as charge_lib_id, status_active from qc_fab_yarn_conv where qc_no='$data[1]' and type=3 and cons>0 and status_active=1 and is_deleted=0 order by id");
			$save_update=0;
			}
		}

		if ( count($data_array)>0)
		{
			$i=0;
			foreach( $data_array as $row )
			{
				$selected_fab_description="";
				if($row[csf("fabric_description")]!="") $selected_fab_description=$row[csf("fabric_description")];
				else $selected_fab_description=$row[csf("cost_head")];
				$selected_process="";
				if($row[csf("cons_process")]!="") $selected_process=$row[csf("cons_process")]; else $selected_process=$row[csf("cons_type")];
				$i++;

				if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

				if($component_approved==1) $btn_disabled=1; else  $btn_disabled=0;
				$fabis_apply_last_update=$applyLastUpdateArr[$row[csf("fabric_description")]];

				$is_apply_last_update=$row[csf("is_apply_last_update")];
				$is_last_app_msg=""; $changedmsgcolor="";
				if($is_apply_last_update==2 || $fabis_apply_last_update==2)
				{
					$is_last_app_msg="Color Size Changed.";
					$changedmsgcolor="Red";
				}
				if($stripeChangearr[$row[csf("fabric_description")]]==1)
				{
					$is_last_app_msg="Stripe Changed.";
					$changedmsgcolor="Red";
				}
				if($color_dtlsArr[$row[csf('id')]]>0)
				{
					$row[csf("color_break_down")]='';
					$row[csf("color_break_down")]=$color_dtlsArr[$row[csf('id')]];
				}
				//echo $aop_conversion_from_chart.'=AAAA';

				// echo $row[csf("color_break_down")].',';
				 
				?>
				<tr id="conversion_<?=$i; ?>" align="center">
                	<td><input type="text" id="covseq_<?=$i; ?>" name="covseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$selected_fab_description]['seq']; ?>" readonly/></td>
					<td id="convfabtd_<?=$i; ?>" title="<?=$fab_description[$selected_fab_description]; ?>"><?=create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- Select--", $selected_fab_description, "set_conversion_qnty(".$i.",this.value,1); add_yarn_conversion_cost(".$i.")",$disabled,"" ); ?></td>
					<td><?  echo create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", $selected_process, "set_conversion_charge_unit(".$i.",".$conversion_from_chart.")",$disabled,"" ); ?></td>
					<td title="<?=$is_last_app_msg; ?>"><input type="text" id="txtprocessloss_<?=$i; ?>" name="txtprocessloss_<?=$i; ?>" class="text_boxes_numeric" style="width:40px; background-color:<?=$changedmsgcolor; ?>" value="<?=$row[csf("process_loss")]; ?>" <? if($disabled==0){ echo "";} else{ echo "disabled";} ?> onChange="set_conversion_qnty(<?=$i; ?>,this.value,2);" />
					 <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px" value="<?=$row[csf("is_apply_last_update")]; ?>" /><input type="hidden" id="applastidchk_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("is_apply_last_update")]; ?>" readonly  />
					</td>
				   <td><input type="text" id="txtreqqnty_<?=$i; ?>" name="txtreqqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( <?=$i;?> );"  value="<?=$row[csf("req_qnty")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/></td>
					<td><input type="text" id="txtavgreqqnty_<?=$i; ?>"  name="txtavgreqqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?=$i;?> );"  value="<?=$row[csf("avg_req_qnty")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?>  readonly/></td>
				   <td><input type="text" id="txtchargeunit_<?=$i; ?>" name="txtchargeunit_<?=$i; ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( <?=$i;?> );" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>);" value="<?=$row[csf("charge_unit")];?>"  <? if($disabled==0){echo "";}else{echo "disabled";}?> <?=$readonly; ?> /> <!--onClick="set_conversion_charge_unit(<?//=$i;?>,<?//=$conversion_from_chart;?>)"--></td>
					<td><input type="text" id="txtamountconversion_<?=$i; ?>" name="txtamountconversion_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="<?=$row[csf("amount")]; ?>" readonly/></td>
					<td><input type="text" id="totalcqty_<?=$i; ?>" name="totalcqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Conv');" readonly poqty="" planqty="" /></td>
					<td><input type="text" id="totalcamount_<?=$i; ?>" name="totalcamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>
					<td><?=create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?></td>
					<td>
						  <input type="button" id="increaseconversion_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<?=$i; ?>,<?=$conversion_from_chart; ?>,this);" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
						<input type="button" id="decreaseconversion_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_conversion_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
						<input type="hidden" id="updateidcoversion_<?=$i; ?>" name="updateidcoversion_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>" />
						<input type="hidden" id="colorbreakdown_<?=$i; ?>" name="colorbreakdown_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("color_break_down")]; ?>" />
						<input type="hidden" id="colorbreakdownaop_<?= $i ?>" name="colorbreakdownaop_<?= $i ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("color_break_down_aop")]; ?>"  />
                        <input type="hidden" id="coversionchargelibraryid_<?=$i; ?>" name="coversionchargelibraryid_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("charge_lib_id")]; ?>"   readonly />
					 </td>
				</tr>
				<?
			}
			$i=$i+1;
			if(count($not_yet_saved_yarn)>0 && count($data_array)==0){
				foreach ($not_yet_saved_yarn as $fab_id => $yarn_id) {
					if(count($process_loss_data_arr[$yarn_id])>0){
						foreach ($process_loss_data_arr[$yarn_id] as $process_id=>$process_data) {
							if($process_id !=30){
								$avg_cons = $fabric_cost_data_arr[$fab_id]['avg_cons'];
								$processloss = $process_data['PROCESS_LOSS'];
								$avg_cons_yarn=$avg_cons-($avg_cons*$processloss)/100;
								if($avg_cons_yarn == ''){
									$avg_cons_yarn = $avg_cons;
								}
							}
							?>
							<tr id="conversion_<?=$i ?>" align="center" style="background-color:#FF0000">
                            	<td><input type="text" id="covseq_<?=$i; ?>" name="covseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$fab_id]['seq']; ?>" readonly/></td>
								<td id="convfabtd_<?=$i; ?>" title="<?=$fab_description[$fab_id]; ?>"><?=create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- All Fabrics--", $fab_id, "set_conversion_qnty($i,this.value,1);","","" ); ?></td>
								<td><?=create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", $process_id, "set_conversion_charge_unit( ".$i.",".$conversion_from_chart." );","","" ); ?></td>
								<td><input type="text" id="txtprocessloss_<?=$i; ?>" name="txtprocessloss_<?= $i ?>" class="text_boxes_numeric" style="width:40px; background: grey none repeat scroll 0% 0%;"  value="<?= $process_data['PROCESS_LOSS'] ?>" onChange="set_conversion_qnty(<?= $i ?>,this.value,2);" title="Process Loss Found In Library" />
							   <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px"  />
							   <input type="hidden" id="applastidchk_<?=$i; ?>"  class="text_boxes" style="width:10px"  readonly  />
								</td>
								<td><input type="text" id="txtreqqnty_<?=$i ?>" name="txtreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" value="<?=$avg_cons ?>" readonly /></td>
								<td><input type="text" id="txtavgreqqnty_<?=$i ?>" name="txtavgreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" value="<?= $avg_cons_yarn ?>" readonly/></td>
								<td><input type="text" id="txtchargeunit_<?=$i; ?>" name="txtchargeunit_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>);" <? echo $readonly; ?> value="" /><!--onClick="set_conversion_charge_unit(<?//= $i ?>,<?//=$conversion_from_chart;?>);"--></td>
								<td><input type="text" id="txtamountconversion_<?=$i; ?>"  name="txtamountconversion_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="" readonly /></td>
								<td><input type="text" id="totalcqty_<?=$i; ?>" name="totalcqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Conv');" readonly poqty="" planqty="" /></td>
								<td><input type="text" id="totalcamount_<?=$i; ?>" name="totalcamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>
								<td><?=create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", '', '','','' );  ?></td>
								<td>
									<input type="button" id="increaseconversion_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<?=$i; ?>,<?=$conversion_from_chart;?>,this);" />
									<input type="button" id="decreaseconversion_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_conversion_cost',this);" />
									<input type="hidden" id="updateidcoversion_<?=$i; ?>" name="updateidcoversion_<?=$i; ?>" class="text_boxes" style="width:20px" value=""  />
									<input type="hidden" id="colorbreakdown_<?=$i; ?>" name="colorbreakdown_<?=$i; ?>" class="text_boxes" style="width:20px" value=""  />
									<input type="hidden" id="colorbreakdownaop_<?= $i ?>" name="colorbreakdownaop_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
                                    <input type="hidden" id="coversionchargelibraryid_<?=$i; ?>" name="coversionchargelibraryid_<?=$i; ?>" class="text_boxes" style="width:20px" value="" readonly  />                             </td>
							</tr>
							<? $i++;
						}
					}
					else{ ?>
						<tr id="conversion_<?= $i ?>" align="center">
                        	<td><input type="text" id="covseq_<?=$i; ?>" name="covseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$fab_id]['seq']; ?>" readonly/></td>
							<td id="convfabtd_<?=$i; ?>" title="<?=$fab_description[$fab_id]; ?>"><?=create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- All Fabrics--", $fab_id, "set_conversion_qnty($i,this.value,1);","","" ); ?></td>
							<td><?=create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", "", "set_conversion_charge_unit( ".$i.",".$conversion_from_chart." );","","" ); ?></td>
							<td><input type="text" id="txtprocessloss_<?= $i ?>" name="txtprocessloss_<?= $i ?>" class="text_boxes_numeric" style="width:40px;"  value="" onChange="set_conversion_qnty(<?= $i ?>,this.value,2);" title="Process Loss Not Found In Library" />
							<input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px"  />
							<input type="hidden" id="applastidchk_<?=$i; ?>" class="text_boxes" style="width:10px"  readonly  />
							</td>
							<td><input type="text" id="txtreqqnty_<?=$i; ?>"  name="txtreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?=$i; ?>);" value="" readonly /></td>
							<td><input type="text" id="txtavgreqqnty_<?=$i; ?>"  name="txtavgreqqnty_<?=$i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?=$i; ?>);" value="" readonly/></td>
							<td><input type="text" id="txtchargeunit_<?=$i; ?>"  name="txtchargeunit_<?=$i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?=$i; ?>);" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>);" <?=$readonly; ?> value="" /><!--onClick="set_conversion_charge_unit(<?//= $i ?>,<?//=$conversion_from_chart;?>);"--></td>
							<td><input type="text" id="txtamountconversion_<?= $i ?>"  name="txtamountconversion_<?= $i ?>" class="text_boxes_numeric" style="width:60px" value="" readonly /></td>
							<td><input type="text" id="totalcqty_<?=$i; ?>" name="totalcqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Conv');" readonly poqty="" planqty="" /></td>
							<td><input type="text" id="totalcamount_<?=$i; ?>" name="totalcamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>

							<td><?=create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", '', '','','' );  ?></td>
							<td>
								<input type="button" id="increaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<?=$i; ?>,<?=$conversion_from_chart;?>,this);" />
								<input type="button" id="decreaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_conversion_cost',this);" />
								<input type="hidden" id="updateidcoversion_<?= $i ?>" name="updateidcoversion_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
								<input type="hidden" id="colorbreakdown_<?= $i ?>" name="colorbreakdown_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
								<input type="hidden" id="colorbreakdownaop_<?= $i ?>" name="colorbreakdownaop_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="coversionchargelibraryid_<?= $i ?>" name="coversionchargelibraryid_<?= $i ?>"  class="text_boxes" style="width:20px" value="" readonly  />                             </td>
						</tr>
						<? $i++;
					}
				}
			}
		}
		else
		{
			$save_update=0;
			$i=1;
			if(count($yarn_count_id_arr)>0){
				foreach ($yarn_count_id_arr as $fab_id => $yarn_id) {
					if(count($process_loss_data_arr[$yarn_id])>0){
						foreach ($process_loss_data_arr[$yarn_id] as $process_id=>$process_data) {
							if($process_id !=30){
								$avg_cons = $fabric_cost_data_arr[$fab_id]['avg_cons'];
								$processloss = $process_data['PROCESS_LOSS'];
								$avg_cons_yarn=$avg_cons-($avg_cons*$processloss)/100;
								if($avg_cons_yarn == ''){
									$avg_cons_yarn = $avg_cons;
								}
							}
							?>
							<tr id="conversion_<?=$i ?>" align="center">
                            	<td><input type="text" id="covseq_<?=$i; ?>" name="covseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$fab_id]['seq']; ?>" readonly/></td>
								<td id="convfabtd_<?=$i; ?>" title="<?=$fab_description[$fab_id]; ?>"><?=create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- All Fabrics--", $fab_id, "set_conversion_qnty($i,this.value,1);","","" ); ?></td>
								<td><?=create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", $process_id, "set_conversion_charge_unit( ".$i.",".$conversion_from_chart." );","","" ); ?></td>
								<td><input type="text" id="txtprocessloss_<?= $i ?>" name="txtprocessloss_<?= $i ?>" class="text_boxes_numeric" style="width:40px; background: grey none repeat scroll 0% 0%;"  value="<?= $process_data['PROCESS_LOSS'] ?>" onChange="set_conversion_qnty(<?= $i ?>,this.value,2);" title="Process Loss Found In Library"  />
							   <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px"  />
							   <input type="hidden" id="applastidchk_<? echo $i; ?>" class="text_boxes" style="width:10px"  readonly  />
								</td>
								<td><input type="text" id="txtreqqnty_<?= $i; ?>"  name="txtreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i; ?>);" value="<?=$avg_cons; ?>" readonly /></td>
								<td><input type="text" id="txtavgreqqnty_<?= $i; ?>"  name="txtavgreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" value="<?= $avg_cons_yarn ?>" readonly/></td>
								<td><input type="text" id="txtchargeunit_<?= $i; ?>"  name="txtchargeunit_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>);" <? echo $readonly; ?> value="" /> <!--onClick="set_conversion_charge_unit(<?//= $i ?>,<?//=$conversion_from_chart;?>);"--></td>
								<td><input type="text" id="txtamountconversion_<?= $i ?>"  name="txtamountconversion_<?= $i ?>" class="text_boxes_numeric" style="width:60px" value="" readonly /></td>
								<td><input type="text" id="totalcqty_<?=$i; ?>" name="totalcqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Conv');" readonly poqty="" planqty="" /></td>
								<td><input type="text" id="totalcamount_<?=$i; ?>" name="totalcamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>
								<td><?=create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", '', '','','' );  ?></td>
								<td>
									<input type="button" id="increaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<?=$i; ?>,<?=$conversion_from_chart;?>,this);" />
									<input type="button" id="decreaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_conversion_cost',this);" />
									<input type="hidden" id="updateidcoversion_<?= $i ?>" name="updateidcoversion_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
									<input type="hidden" id="colorbreakdown_<?= $i ?>" name="colorbreakdown_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
									<input type="hidden" id="colorbreakdownaop_<?= $i ?>" name="colorbreakdownaop_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
                                    <input type="hidden" id="coversionchargelibraryid_<?= $i ?>" name="coversionchargelibraryid_<?= $i ?>"  class="text_boxes" style="width:20px" value="" readonly  />                             </td>
							</tr>
							<? $i++;
						}
					}
					else{ ?>
						<tr id="conversion_<?= $i ?>" align="center">
                        	<td><input type="text" id="covseq_<?=$i; ?>" name="covseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$fab_id]['seq']; ?>" readonly/></td>
							<td id="convfabtd_<?=$i; ?>" title="<?=$fab_description[$fab_id]; ?>"><?=create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- All Fabrics--", $fab_id, "set_conversion_qnty($i,this.value,1);","","" ); ?></td>
							<td><?=create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", "", "set_conversion_charge_unit( ".$i.",".$conversion_from_chart." );","","" ); ?></td>
							<td><input type="text" id="txtprocessloss_<?= $i ?>" name="txtprocessloss_<?= $i ?>" class="text_boxes_numeric" style="width:40px;"  value="" onChange="set_conversion_qnty(<?= $i ?>,this.value,2);" title="Process Loss Not Found In Library" />
							<input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px"  />
							<input type="hidden" id="applastidchk_<?=$i; ?>" class="text_boxes" style="width:10px"  readonly  />
							</td>
							<td><input type="text" id="txtreqqnty_<?=$i; ?>"  name="txtreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" value="" readonly /></td>
							<td><input type="text" id="txtavgreqqnty_<?=$i; ?>"  name="txtavgreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" value="" readonly/></td>
							<td><input type="text" id="txtchargeunit_<?=$i; ?>"  name="txtchargeunit_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>);" <?=$readonly; ?> value="" /><!--onClick="set_conversion_charge_unit(<?//= $i ?>,<?//=$conversion_from_chart;?>);"--></td>
							<td><input type="text" id="txtamountconversion_<?= $i ?>"  name="txtamountconversion_<?= $i ?>" class="text_boxes_numeric" style="width:60px" value="" readonly /></td>
							<td><input type="text" id="totalcqty_<?=$i; ?>" name="totalcqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Conv');" readonly poqty="" planqty="" /></td>
							<td><input type="text" id="totalcamount_<?=$i; ?>" name="totalcamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>

							<td><?=create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", '', '','','' );  ?></td>
							<td>
								<input type="button" id="increaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<?=$i; ?>,<?=$conversion_from_chart;?>,this);" />
								<input type="button" id="decreaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_conversion_cost',this);" />
								<input type="hidden" id="updateidcoversion_<?= $i ?>" name="updateidcoversion_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
								<input type="hidden" id="colorbreakdown_<?= $i ?>" name="colorbreakdown_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="colorbreakdownaop_<?= $i ?>" name="colorbreakdownaop_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
								<input type="hidden" id="coversionchargelibraryid_<?= $i ?>" name="coversionchargelibraryid_<?= $i ?>"  class="text_boxes" style="width:20px" value="" readonly  />           </td>
						</tr>
						<? $i++;
					}
				}
			}
			else {
				?>
				<tr id="conversion_<?= $i ?>" align="center">
                	<td><input type="text" id="covseq_<?=$i; ?>" name="covseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$fab_id]['seq']; ?>" readonly/></td>
					<td id="convfabtd_<?=$i; ?>" title="<?=$fab_description[$fab_id]; ?>"><?=create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- All Fabrics--", $fab_id, "set_conversion_qnty($i,this.value,1);","","" ); ?></td>
					<td><?=create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", "", "set_conversion_charge_unit( ".$i.",".$conversion_from_chart." );","","" ); ?></td>
					<td><input type="text" id="txtprocessloss_<?= $i ?>" name="txtprocessloss_<?= $i ?>" class="text_boxes_numeric" style="width:40px;"  value="" onChange="set_conversion_qnty(<?= $i ?>,this.value,2);" title="Process Loss Not Found In Library" /></td>
					<td><input type="text" id="txtreqqnty_<?= $i ?>"  name="txtreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" value="" readonly /></td>
					<td><input type="text" id="txtavgreqqnty_<?= $i ?>"  name="txtavgreqqnty_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" value="" readonly/></td>
					<td><input type="text" id="txtchargeunit_<?= $i ?>"  name="txtchargeunit_<?= $i ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost(<?= $i ?>);" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>);" <? echo $readonly; ?> value="" /><!--onClick="set_conversion_charge_unit(<?//= $i ?>,<?//=$conversion_from_chart;?>);"--></td>
					<td><input type="text" id="txtamountconversion_<?= $i ?>"  name="txtamountconversion_<?= $i ?>" class="text_boxes_numeric" style="width:60px" value="" readonly /></td>
					<td><input type="text" id="totalcqty_<?=$i; ?>" name="totalcqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'Conv');" readonly poqty="" planqty="" /></td>
					<td><input type="text" id="totalcamount_<?=$i; ?>" name="totalcamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>

					<td><?=create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", '', '','','' );  ?></td>
					<td>
						<input type="button" id="increaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<?=$i; ?>,<?=$conversion_from_chart;?>,this);" />
						<input type="button" id="decreaseconversion_<?= $i ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_conversion_cost',this);" />
						<input type="hidden" id="updateidcoversion_<?= $i ?>" name="updateidcoversion_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
						<input type="hidden" id="colorbreakdown_<?= $i ?>" name="colorbreakdown_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
                        <input type="hidden" id="colorbreakdownaop_<?= $i ?>" name="colorbreakdownaop_<?= $i ?>"  class="text_boxes" style="width:20px" value=""  />
						<input type="hidden" id="coversionchargelibraryid_<?= $i ?>" name="coversionchargelibraryid_<?= $i ?>"  class="text_boxes" style="width:20px" value="" readonly  /></td>
				</tr>
				<?
			}
		} ?>
	</tbody>
</table>
<table width="945" cellspacing="0" class="rpt_table" border="0" rules="all">
	<tfoot>
		<tr>
			<th width="429">Sum:</th>
			<th width="50"><input type="text" id="txtconreqnty_sum" name="txtconreqnty_sum" class="text_boxes_numeric" style="width:40px" readonly /></th>
			<th width="50"><input type="text" id="txtavgconreqnty_sum" name="txtavgconreqnty_sum" class="text_boxes_numeric" style="width:40px" readonly /></th>
			<th width="50"><input type="text" id="txtconchargeunit_sum" name="txtconchargeunit_sum" class="text_boxes_numeric" style="width:40px" readonly /></th>
			<th width="70"><input type="text" id="txtconamount_sum" name="txtconamount_sum" class="text_boxes_numeric" style="width:60px" readonly /></th>
			<th width="70"><input type="text" id="txtconareqqty_sum" name="txtconareqqty_sum" class="text_boxes_numeric" style="width:59px" readonly /></th>
			<th width="70"><input type="text" id="txtconareqamt_sum" name="txtconareqamt_sum" class="text_boxes_numeric" style="width:59px" readonly /></th>
			<th width="60" style=" border:none"></th>
			<th style=" border:none"></th>
		</tr>
	</tfoot>
</table>
            <table width="945" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
					if($data[6]==0)//Bom Of Fabric
					{
						if ( count($data_array)>0)
						{
							echo load_submit_buttons( $permission, "fnc_fabric_conversion_cost_dtls", $save_update,0,"reset_form('conversionccost_5','','',0)",5) ;
						}
						else
						{
							echo load_submit_buttons( $permission, "fnc_fabric_conversion_cost_dtls", $save_update,0,"reset_form('conversionccost_5','','',0)",5) ;
						}
					}
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
    </div>
	<?
	exit();
}

if($action=="body_part_popup")
{
	echo load_html_head_contents("Item Group Select","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
	function js_set_value(id, name,type)
	{
		document.getElementById('gid').value=id;
		document.getElementById('gname').value=name;
		document.getElementById('gtype').value=type;
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="gname" name="gname"/>
        <input type="hidden" id="gtype" name="gtype"/>
        <?
        $sql_tgroup=sql_select( "select body_part_full_name,body_part_short_name,body_part_type,id from lib_body_part where  is_deleted=0  and  status_active=1 order by body_part_full_name ASC");
        ?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th><th width="300">Item Group</th><th>Type</th>
            </thead>
        </table>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>
            <?
            $i=1;
            foreach($sql_tgroup as $row_tgroup)
			{
				if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr onClick="js_set_value(<? echo $row_tgroup[csf('id')]; ?>, '<? echo $row_tgroup[csf('body_part_full_name')]; ?>', '<? echo $row_tgroup[csf('body_part_type')]; ?>')" bgcolor="<? echo $bgcolor; ?>">
					<td width="40"><? echo $i; ?></td><td width="300"><? echo $row_tgroup[csf('body_part_full_name')]; ?></td><td width=""><? echo $body_part_type[$row_tgroup[csf('body_part_type')]]; ?></td>
				</tr>
				<?
				$i++;
            }
            ?>
            </tbody>
        </table>
        </div>
	</body>
	<script>
	setFilterGrid('item_table',-1)
	</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}

if($action=="fabric_description_popup")
{
	echo load_html_head_contents("Fabric Description Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);

	$fabricSource=0;
	?>
	<script>
		var fabricSource='<?=$fabricSource; ?>';
		function js_set_value(data)
		{
			var data=data.split('_');
			var fabric_yarn_description=return_global_ajax_value(data[0], 'fabric_yarn_description', '', 'pre_cost_entry_controller_v2');
			var fabric_yarn_description_arr=fabric_yarn_description.split("**");
			var fabric_description=trim(data[2])+' '+trim(fabric_yarn_description_arr[0]);
			document.getElementById('fab_des_id').value=data[0];
			document.getElementById('fab_nature_id').value=data[1];
			document.getElementById('construction').value=trim(data[2]);
			document.getElementById('fab_gsm').value=trim(data[3]);
			document.getElementById('process_loss').value=trim(data[4]);
			document.getElementById('fab_desctiption').value=trim(fabric_description);
			document.getElementById('composition').value=trim(fabric_yarn_description_arr[0]);
			var yarn =fabric_yarn_description_arr[1].split("_");
			if(yarn[1]*1==0 || yarn[1]==""){
				alert("Composition not set in yarn count determination");
				return;
			}
			document.getElementById('yarn_desctiption').value=trim(fabric_yarn_description_arr[1]);
			parent.emailwindow.hide();
		}
		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}
			</script>
    </head>
    <body>
    <div align="center">
        <form name="styleRef_form" id="styleRef_form">
		<fieldset>
            <table cellspacing="0" cellpadding="0" border="1" rules="all" align="center" class="rpt_table" id="tbl_list">
                <thead>
                    <tr>
                    	<th colspan="4" align="center"><? echo create_drop_down( "cbo_string_search_type", 100, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
                    </tr>
                    <tr>
                        <th>Construction</th>
                        <th>GSM/Weight</th>
                        <th>RD/Ref. No</th>
                        <th><input type="reset" name="button" class="formbutton" value="Reset" style="width:100px;" onClick="reset_form('styleRef_form','search_div','','','','');"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td align="center"><input type="text" style="width:130px" class="text_boxes" name="txt_construction" id="txt_construction" /></td>
                        <td align="center">	<input type="text" style="width:130px" class="text_boxes" name="txt_gsm_weight" id="txt_gsm_weight" /></td>
                         <td align="center"><input type="text" style="width:100px" class="text_boxes" name="txt_rd_ref" id="txt_rd_ref" /></td>
                        <td align="center">
                        	<input type="button" name="button" class="formbutton" value="Show" onClick="show_list_view ('<?=$fabric_nature; ?>'+'**'+'<?=$libyarncountdeterminationid; ?>'+'**'+document.getElementById('txt_construction').value+'**'+document.getElementById('txt_gsm_weight').value+'**'+document.getElementById('cbo_string_search_type').value+'**'+'<?=$fabricSource; ?>'+'**'+'<?=$txtbodypart; ?>'+'**'+'<?=$cbocolortype; ?>'+'**'+'<?=$txt_job_no; ?>'+'**'+document.getElementById('txt_rd_ref').value, 'fabric_description_popup_search_list_view', 'search_div', 'pre_cost_entry_controller_v2', 'setFilterGrid(\'list_view\',-1)'); toggle('tr_'+'<?=$libyarncountdeterminationid; ?>', '#FFFFCC');" style="width:100px;" />
                        </td>
                    </tr>
            	</tbody>
           	</table>
            <div style="margin-top:10px" id="search_div"></div>
		</fieldset>
	</form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="fabric_description_popup_search_list_view")
{
	//echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	list($fabric_nature,$libyarncountdeterminationid,$construction,$gsm_weight,$string_search_type,$fabricSource,$txtbodypart,$cbocolortype,$txt_job_no,$txt_rd_ref)=explode('**',$data);
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
	$search_con='';
	if($string_search_type==1)
	{
		if($construction!='') {$search_con .= " and a.construction='".trim($construction)."'";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight='".trim($gsm_weight)."'";}
		if($txt_rd_ref!='') {$search_con .= " and a.rd_no='".trim($txt_rd_ref)."'";}
	}
	else if($string_search_type==2)
	{
		if($construction!='') {$search_con .= " and a.construction like ('".trim($construction)."%')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('".trim($gsm_weight)."%')";}
		if($txt_rd_ref!='') {$search_con .= " and a.rd_no like ('".trim($txt_rd_ref)."%')";}
	}
	else if($string_search_type==3)
	{
		if($construction!='') {$search_con .= " and a.construction like ('%".trim($construction)."')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('%".trim($gsm_weight)."')";}
		if($txt_rd_ref!='') {$search_con .= " and a.rd_no like ('%".trim($txt_rd_ref)."')";}
	}
	else if($string_search_type==4 || $string_search_type==0)
	{
		if($construction!='') {$search_con .= " and a.construction like ('%".trim($construction)."%')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('%".trim($gsm_weight)."%')";}
		if($txt_rd_ref!='') {$search_con .= " and a.rd_no like ('%".trim($txt_rd_ref)."%')";}
	}

	$fabric_composition = return_library_array("select id, fabric_composition_name from  lib_fabric_composition where status_active=1 and is_deleted=0 order by fabric_composition_name", "id", "fabric_composition_name");
?>
</head>
<body>

    <div align="center">
        <form>
            <input type="hidden" id="fab_des_id" name="fab_des_id" />
            <input type="hidden" id="fab_nature_id" name="fab_des_id" />
            <input type="hidden" id="construction" name="construction" />
            <input type="hidden" id="composition" name="composition" />
            <input type="hidden" id="fab_gsm" name="fab_gsm" />
            <input type="hidden" id="process_loss" name="process_loss" />
            <input type="hidden" id="fab_desctiption" name="fab_desctiption" />
            <input type="hidden" id="yarn_desctiption" name="yarn_desctiption" />
        </form>
	<?
	$composition_arr=array();
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
	$lib_group_short=return_library_array( "select id,group_short_name from lib_group where id=1 and status_active=1", "id", "group_short_name");
	$group_short_name=$lib_group_short[1];
	//$arr=array (0=>$item_category, 3=>$color_range,6=>$composition,8=>$lib_yarn_count,9=>$yarn_type);
	if($fabricSource==0)
	{
		$sql="select a.id, a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, b.copmposition_id, b.percent, b.count_id, b.type_id, b.id as bid from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and (a.entry_form=184 or a.entry_form is null) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  order by b.id";
		$data_array=sql_select($sql);
		$sysCodeArr=array();
		if (count($data_array)>0)
		{
			foreach( $data_array as $row )
			{
				if(array_key_exists($row[csf('id')],$composition_arr))
				{
					$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ".$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
				}
				else
				{
					$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ".$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
				}
				$sys_code=$group_short_name.'-'.$row[csf('id')];
				$sysCodeArr[$row[csf('id')]]=$sys_code;
			}
		}
		?>
		<table class="rpt_table" width="1020" cellspacing="0" cellpadding="0" border="0" rules="all">
			<thead>
				<tr>
					<th width="30">SL No</th>
					<th style="word-wrap: break-word;word-break: break-all;" width="50">Sys No</th>
                    <th width="70">RD/Ref. No</th>
					<th width="40">Seq. No</th>
					<th width="90">Fab Nature</th>
					<th width="100">Construction</th>
					<th width="50">GSM/ Weight</th>
					<th width="80">Color Range</th>
					<th width="90">Stich Length</th>
					<th width="50">Process Loss</th>
					<th width="80">Fabric Composition</th>
					<th>Composition</th>
				</tr>
		   </thead>
	   </table>
	   <div id="" style="max-height:300px; width:1020px; overflow-y:scroll">
	   <table id="list_view" class="rpt_table" width="1000" height="" cellspacing="0" cellpadding="0" border="1" rules="all">
			<tbody>
		<?
		$sql_data=sql_select("SELECT a.fab_nature_id, a.construction,a.rd_no, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, a.id, a.sequence_no, a.fabric_composition_id  from  lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and  a.fab_nature_id= '$fabric_nature' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and (a.entry_form=184 or a.entry_form is null) $search_con group by a.id,a.rd_no, a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, a.sequence_no, a.fabric_composition_id order by a.id");

		$i=1;
		foreach($sql_data as $row)
		{
			if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
			?>
			<tr id="tr_<?=$row[csf('id')]; ?>" bgcolor="<?=$bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="js_set_value('<?=$row[csf('id')]."_".$row[csf('fab_nature_id')]."_".$row[csf('construction')]."_".$row[csf('gsm_weight')]."_".$row[csf('process_loss')] ?>')">
				<td width="30"><?=$i; ?></td>
				<td style="word-wrap: break-word;word-break: break-all;" width="50" align="left"><?=$sysCodeArr[$row[csf('id')]]; ?></td>
				<td width="70" style="word-break:break-all"><?=$row[csf('rd_no')]; ?></td>
                <td width="40" style="word-break:break-all"><?=$row[csf('sequence_no')]; ?></td>
				<td width="90" style="word-break:break-all"><?=$item_category[$row[csf('fab_nature_id')]]; ?></td>
				<td width="100" style="word-break:break-all"><?=$row[csf('construction')]; ?></td>
				<td width="50" align="center" style="word-break:break-all"><?=$row[csf('gsm_weight')]; ?></td>
				<td width="80" style="word-break:break-all"><?=$color_range[$row[csf('color_range_id')]]; ?></td>
				<td width="90" style="word-break:break-all"><?=$row[csf('stich_length')]; ?></td>
				<td width="50" align="right"><?=$row[csf('process_loss')]; ?></td>
				<td width="80" style="word-break:break-all"><?=$fabric_composition[$row[csf('fabric_composition_id')]]; ?></td>
				<td style="word-break:break-all" title="<?= $row[csf('id')] ?>"><?=$composition_arr[$row[csf('id')]]; ?></td>
			</tr>
			<?
			$i++;
		}
		?>
			</tbody>
		</table>
	</div>
	</div>
    <? } else if($fabricSource==1){
    	$sql="select a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, b.copmposition_id, b.percent, b.count_id, b.type_id, a.id, b.id as bid from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by b.id";
		$data_array=sql_select($sql);
		$sysCodeArr=array();
		if (count($data_array)>0)
		{
			foreach( $data_array as $row )
			{
				if(array_key_exists($row[csf('id')],$composition_arr))
				{
					$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ".$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
				}
				else
				{
					$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ".$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
				}
				$sys_code=$group_short_name.'-'.$row[csf('id')];
				$sysCodeArr[$row[csf('id')]]=$sys_code;
			}
		}
		?>
		<table class="rpt_table" width="950" cellspacing="0" cellpadding="0" border="0" rules="all">
			<thead>
				<tr>
					<th width="30">SL No</th>
                    <th width="120">Fab. Name</th>
					<th width="70">Fab. Source</th>
                    <th width="80">Body Part</th>
                    <th width="70">Body Part Type</th>
                    <th width="70">Color Type</th>
					<th width="60">Count Range</th>
                    <th width="70">Color Range</th>
					<th width="70">No. Of Color</th>
					<th width="80">Coverage %</th>
					<th width="60">AOP Type</th>
					<th width="70">AOP Process Upto</th>
					<th>Rate[$]</th>
				</tr>
		   </thead>
	   </table>
	   <div style="max-height:300px; width:948px; overflow-y:scroll">
	   <table id="list_view" class="rpt_table" width="930" cellspacing="0" cellpadding="0" border="1" rules="all">
			<tbody>
			<?

			//$sql_poid="select id from wo_po_break_down a, lab_labdip_request b where a.id=b.po_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 ";

            $sql_data=sql_select("select a.id, a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, a.fabric_composition_id, b.fabric_source, b.body_part_id, b.body_part_type, b.color_type, b.count_range_from, b.count_range_to, b.color_range, b.no_of_color, b.coverage_range_from, b.coverage_range_to, b.aop_type, b.aop_process_upto, b.rate_usd from lib_yarn_count_determina_mst a, process_finish_fabric_rate_chat b where a.id=b.fabric_description and a.fab_nature_id='$fabric_nature' and b.body_part_id='$txtbodypart' and b.color_type='$cbocolortype' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $search_con order by a.id");

            $i=1;
            foreach($sql_data as $row)
            {
                if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                $fab_desc=$row[csf('construction')].','.$composition_arr[$row[csf('id')]];
                $countRange=$row[csf('count_range_from')].'-'.$row[csf('count_range_to')];
                $covPer=$row[csf('coverage_range_from')].'-'.$row[csf('coverage_range_to')];
                ?>
                <tr id="tr_<?=$row[csf('id')]; ?>" bgcolor="<?=$bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="js_set_value('<?=$row[csf('id')]."_".$row[csf('fab_nature_id')]."_".$row[csf('construction')]."_".$row[csf('gsm_weight')]."_".$row[csf('process_loss')]."_".$fab_desc; ?>');">
                    <td width="30"><?=$i; ?></td>
                    <td width="120" style="word-break:break-all"><?=$fab_desc; ?></td>
                    <td width="70"><?=$fabric_source[$row[csf('fabric_source')]]; ?></td>
                    <td width="80"><?=$body_part[$row[csf('body_part_id')]]; ?></td>
                    <td width="70"><?=$body_part_type[$row[csf('body_part_type')]]; ?></td>

                    <td width="70"><?=$color_type[$row[csf('color_type')]]; ?></td>
                    <td width="60"><?=$countRange; ?></td>
                    <td width="70"><?=$color_range[$row[csf('color_range')]]; ?></td>

                    <td width="70"><?=$no_color_arr[$row[csf('no_of_color')]]; ?></td>
                    <td width="80"><?=$covPer; ?></td>
                    <td width="60"><?=$conversion_cost_head_array[$row[csf('aop_type')]]; ?></td>

                    <td width="70"><?=$aop_process_arr[$row[csf('aop_process_upto')]]; ?></td>
                    <td align="right"><?=$row[csf('rate_usd')]; ?></td>
                </tr>
                <?
                $i++;
            }
            ?>
			</tbody>
		</table>
	</div>
	</div>
    <? } ?>
</body>
</html>
<?
exit();
}

if($action =="fabric_yarn_description")
{
	$fab_description=""; $yarn_description="";
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");

	$sql="select a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss,b.copmposition_id,b.percent,b.count_id,b.type_id,a.id from  lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=$data and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.id,b.id";

	$data_array=sql_select($sql);
	if (count($data_array)>0)
	{
		foreach( $data_array as $row )
		{
			if($fab_description!="")
			{
				$fab_description=$fab_description." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
			}
			else
			{
				$fab_description=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
			}

			if($yarn_description!="")
			{
				$yarn_description=$yarn_description."__".$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
			}
			else
			{
				$yarn_description=$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
			}
		}
	}
	echo $fab_description."**".$yarn_description;
}

if($action=="fabric_add_image_popup")
{
	echo load_html_head_contents("Add Image Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>
	<script>
		function fnc_image_upload(i)
		{

				var img_ref_id = $("#img_ref_id_"+i).val();
				//	alert(img_ref_id);
					file_uploader ( '../../../', img_ref_id,'', 'fabric_color_img', 0,1);
		}
		   function window_close(){
		   parent.emailwindow.hide();
		   }
	</script>
    </head>
    <body>
    <div align="center">
    <form name="styleRef_form" id="styleRef_form">
		<fieldset>
             <table class="rpt_table" width="650" cellspacing="0" cellpadding="0" border="0" rules="all">
			   <caption><strong> Add Image Against Fabric Color </strong> </caption>
                <thead>
                    <tr>
                        <th width="30">SL No</th>
                        <th width="200">Body Part</th>
                        <th width="100">Gmts Color</th>
                        <th width="100">Fabric Color</th>
                        <th>Add Image</th>
                    </tr>
               </thead>
           </table>
   		   <div id="" style="max-height:300px; width:650px; overflow-y:scroll">
           <table id="list_view" class="rpt_table" width="630" height="" cellspacing="0" cellpadding="0" border="1" rules="all">
                <tbody>
            <?
            //and a.color_size_sensitive=3
             $contrast_color_data="select a.job_no,a.id,a.body_part_id,b.contrast_color_id,b.gmts_color_id from  wo_pre_cost_fabric_cost_dtls a,  wo_pre_cos_fab_co_color_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no and  a.job_no= '$txt_job_no' and  a.is_deleted=0  and a.color_size_sensitive=3  group by a.job_no,a.id,a.body_part_id,b.contrast_color_id,b.gmts_color_id order by b.contrast_color_id";
            $result_contrast_data=sql_select($contrast_color_data);
            $contrast_color_img_arr=array();
            foreach($result_contrast_data as $row)
            {
                if($row[csf('contrast_color_id')]>0)
                {
                $contrast_color_img_arr[$row[csf('id')]][$row[csf('gmts_color_id')]]['contr_color']=$row[csf('contrast_color_id')];
                $contrast_color_img_arr[$row[csf('id')]][$row[csf('gmts_color_id')]]['body_part_id']=$row[csf('body_part_id')];
                $contrast_color_img_arr[$row[csf('id')]][$row[csf('gmts_color_id')]]['job_no']=$row[csf('job_no')];
                }
            }

        $sql_data="select a.job_no,a.id,a.body_part_id,b.color_number_id from  wo_pre_cost_fabric_cost_dtls a,  wo_pre_cos_fab_co_avg_con_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no and  a.job_no= '$txt_job_no' and a.color_size_sensitive=1 and  a.is_deleted=0  group by a.job_no,a.id,a.body_part_id,b.color_number_id order by b.color_number_id";
            $result_data=sql_select($sql_data);
            foreach($result_data as $row)
            {
                $fabric_color_img_arr[$row[csf('id')]][$row[csf('color_number_id')]]['gmt_color']=$row[csf('color_number_id')];
                $fabric_color_img_arr[$row[csf('id')]][$row[csf('color_number_id')]]['body_part_id']=$row[csf('body_part_id')];
                $fabric_color_img_arr[$row[csf('id')]][$row[csf('color_number_id')]]['job_no']=$row[csf('job_no')];
            }
            $i=1;
            $color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
            foreach($fabric_color_img_arr as $fab_id=>$fab_data)
            {
                foreach($fab_data as $color_id=>$val)
                {
                $img_ref=$fab_id.'_'.$color_id;
                if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                ?>
                <tr id="tr_<? echo $row[csf('id')] ?>" bgcolor="<? echo $bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="">
                    <td width="30" style="background:#FFFFCC">
                    <input type="hidden" name="img_ref_id_<? echo $i; ?>" id="img_ref_id_<? echo $i; ?>" class="text_boxes" value="<? echo $img_ref; ?>" style="width:20px" />
                    <? echo $i; ?></td>
                    <td width="200" align="left"><? echo $body_part[$val[('body_part_id')]]; ?></td>
                    <td width="100" align="left"><? echo $color_library[$color_id]; ?></td>
                    <td width="100" align="left"><? echo $color_library[$color_id]; ?></td>
                    <td align="center"><p><input type="button" class="image_uploader" id="uploader" style="width:60px" value="ADD" onClick="fnc_image_upload(<? echo $i;?>);"></p></td>
                </tr>
                <?
                $i++;
                }
            }
            foreach($contrast_color_img_arr as $fab_id=>$fab_data)
            {
                foreach($fab_data as $color_id=>$val)
                {

                if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                $img_ref=$fab_id.'_'.$val[('contr_color')];
                ?>
                <tr id="tr_<? echo $row[csf('id')] ?>" bgcolor="<? echo $bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="">
                    <td width="30" style="background:#CCFFFF">
                    <input type="hidden" name="img_ref_id_<? echo $i; ?>" id="img_ref_id_<? echo $i; ?>" class="text_boxes" value="<? echo $img_ref; ?>" style="width:20px" />
                    <? echo $i; ?></td>
                    <td width="200" align="left"><? echo $body_part[$val[('body_part_id')]]; ?></td>
                    <td width="100" align="left"><? echo $color_library[$color_id]; ?></td>
                    <td width="100" align="left"><? echo $color_library[$val[('contr_color')]]; ?></td>
                    <td align="center"><p><input type="button" class="image_uploader" id="uploader" style="width:60px" value="ADD" onClick="fnc_image_upload(<? echo $i;?>);"></p></td>
                </tr>
                <?
                $i++;
                }
            }
            ?>
                </tbody>

            </table>
	<br/>
	<table border="0" cellpadding="0" cellspacing="0" rules="all" width="600">
		<tr>
		<td colspan="5" align="center">
		<input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="window_close();" style="width:80px"/>
		</td>
		</tr>
	</table>
</div>
		</fieldset>
	</form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="rate_amount")
{
	$result="";
	$data_array=sql_select("select rate,amount from  wo_pre_cost_fabric_cost_dtls where id='$data' and status_active=1 and is_deleted=0");
	foreach( $data_array as $row )
	{
	  $result=$row["rate"]."_".$row["amount"];
	}
	echo $result;
	exit();
}

if ($action=="consumption_popup")
{
	echo load_html_head_contents("Fabric Consumption Entry","../../../", 1, 1, $unicode,'','');
    extract($_REQUEST);
	//$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn'];
	//$msmnt_breack_downn= $_SESSION['logic_erp']['msmnt_breack_downn'];
	//$marker_breack_down= $_SESSION['logic_erp']['marker_breack_down'];
	$exPriQutFabId_costControlSource=explode("_",$priQutFabId_costControlSource);
	$pri_fab_cost_dtls_id=$exPriQutFabId_costControlSource[0];
	$costControlSource=$exPriQutFabId_costControlSource[1];
?>
<script>
	var budgeton='<?=$budgeton; ?>';
	/*var str_gmtssizes=[<?//=substr(return_library_autocomplete("select size_name from lib_size where status_active=1 and is_deleted=0","size_name"),0,-1); ?>];
	var str_diawidth=[<?//=substr(return_library_autocomplete("select color_name from lib_color where status_active=1 and is_deleted=0","color_name"),0,-1); ?>];*/

	function copy_value(value,field_id,i)
	{
		var copy_val=document.getElementById('copy_val').checked;
		//alert(copy_val);
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		var process_loss_method_id=document.getElementById('process_loss_method_id').value;
		//alert(hid_fab_cons_in_quotation_variable);
		var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
		var itemsizes=document.getElementById('itemsizes_'+i).value;
		var pocolorid=document.getElementById('pocolorid_'+i).value;
		var ponoid=document.getElementById('ponoid_'+i).value;
		var rowCount = $('#tbl_consmption_cost tr').length-1;
		// var copy_basis=document.getElementById('copy_basis').value;
		var copy_basis=$('input[name="copy_basis"]:checked').val();
		//alert(copy_val+"==>"+hid_fab_cons_in_quotation_variable);
		var totFinQty=totGreyQty=0;
		if(hid_fab_cons_in_quotation_variable==1)
		{
			for(var g=1; g<=rowCount; g++) //ISD-23-11737
			{
				var isDisabled = document.getElementById(field_id+g).disabled;
				if(isDisabled==false && copy_val==true)  // as per Saeed and Breash  \copy_val==true\  add
				{
					if(field_id=='itemsizes_') //ISD-23-11737
					{
						if( gmtssizesid==document.getElementById('gmtssizesid_'+g).value)
						{
							document.getElementById(field_id+g).value=value;
							//calculate_requirement(g);
						}
					}
				}
			}
			for(var j=i; j<=rowCount; j++)
			{
				var isDisabled = document.getElementById(field_id+j).disabled;//document.getElementById(field_id+j).attr='disabled';//$(field_id+j).attr('disabled');//$(field_id+j).is(':disabled');//$(field_id+j).prop('disabled');
				//if(j==40) {alert(isDisabled); return; }
				if(isDisabled==false)
				{
					if(copy_val==true)
					{
						/*if(field_id=='itemsizes_') //ISD-23-11737
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value)
							{
								document.getElementById(field_id+j).value=value;
								//calculate_requirement(j);
							}
						}*/
					}
					if(field_id=='diawidth_' || field_id=='cons_' || field_id=='processloss_' || field_id=='remarks_') //ISD-23-11737 //field_id=='itemsizes_'
					{
						if(copy_val==true) { document.getElementById(field_id+j).value=value; }
						else
						{
							if(copy_basis==1)
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==2)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==3)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==4)
							{
								if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
							}else if(copy_basis==5)
							{

								if( ponoid==document.getElementById('ponoid_'+j).value && pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
							}else if(copy_basis==6)
							{

								if( ponoid==document.getElementById('ponoid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
						}
						//if(field_id!='remarks_') calculate_requirement(j);
					}

					if(field_id=='rate_')
					{
						if(copy_basis==1)
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==2)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==3)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==4)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==5)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value && pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==6)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_val==true && (document.getElementById('requirement_'+j).value*1) >0)
						{
							document.getElementById(field_id+j).value=value;
							//claculate_amount(j);
						}
					}

					if(field_id!='remarks_')  //ISD-23-11737 //field_id=='itemsizes_'
					{

						//calculate_requirement(j);
						var cons=(document.getElementById('cons_'+j).value)*1;
						var processloss=(document.getElementById('processloss_'+j).value)*1;
						var WastageQty='';
						if(process_loss_method_id==1)
						{
							WastageQty=cons+cons*(processloss/100);
						}
						else if(process_loss_method_id==2)
						{
							var devided_val = 1-(processloss/100);
							var WastageQty=parseFloat(cons/devided_val);
						}
						else WastageQty=0;
						//totFinQty+=cons;
						//totGreyQty+=WastageQty;

					//	WastageQty= number_format_common( WastageQty, 6, 0) ;
						document.getElementById('processloss_'+j).value=processloss;
						document.getElementById('requirement_'+j).value=number_format_common(WastageQty,6); ;
						//set_sum_value( 'requirement_sum', 'requirement_' );
						//claculate_amount(i);
						//claculate_avg();
					}

					var rate=document.getElementById('rate_'+j).value;
					var requirement=document.getElementById('requirement_'+j).value;
					var plan_cut_qty=document.getElementById('pcsgmts_'+j).value*1;
					var pcs=document.getElementById('pcs_'+j).value*1;

					var rowtotReq=(requirement/pcs)*plan_cut_qty;
					var amount= requirement*rate;
					var rowtotAmt=rowtotReq*rate;
					document.getElementById('amount_'+j).value=number_format_common(amount,6,0);
					document.getElementById('totqty_'+j).value=number_format_common(rowtotReq,6,0);
					document.getElementById('totamount_'+j).value=number_format_common(rowtotAmt,6,0);

					//set_sum_value( 'totReq_sum', 'totqty_');
					//set_sum_value( 'totAmount_sum', 'totamount_');
					//claculate_avg();
				}
			}
			set_sum_value( 'cons_sum', 'cons_');
			set_sum_value( 'processloss_sum', 'processloss_');
			set_sum_value( 'requirement_sum', 'requirement_');
			set_sum_value( 'pcs_sum', 'pcs_');
			set_sum_value( 'rate_sum', 'rate_');
			set_sum_value( 'amount_sum', 'amount_');
			set_sum_value( 'totReq_sum', 'totqty_');
			set_sum_value( 'totAmount_sum', 'totamount_');
			claculate_avg();
		}


		if(hid_fab_cons_in_quotation_variable==2)
		{
			for(var j=i; j<=rowCount; j++)
			{
				var isDisabled = document.getElementById(field_id+j).disabled;
				if(isDisabled==false)
				{
					if(document.getElementById('approved_'+j).value==0)
					{
						if(copy_val==true)
						{
							if(field_id=='itemsizes_')
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value)
								{
									document.getElementById(field_id+j).value=value;
									calculate_measurement_top(j);
								}
							}
						}

						if(field_id=='diawidth_' || field_id=='processloss_' || field_id=='remarks_' || field_id=='bodylength_' || field_id=='bodysewingmargin_' || field_id=='bodyhemmargin_' || field_id=='sleevelength_' || field_id=='sleevesewingmargin_' || field_id=='sleevehemmargin_' || field_id=='chestlenght_' || field_id=='chestsewingmargin_' || field_id=='frontriselength_' || field_id=='frontrisesewingmargin_' || field_id=='westbandlength_' || field_id=='westbandsewingmargin_' || field_id=='inseamlength_' || field_id=='inseamsewingmargin_' || field_id=='inseamhemmargin_' || field_id=='halfthailength_' || field_id=='halfthaisewingmargin_')
						{
							if(copy_basis==1)
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==2)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==3)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==4)
							{
								if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_val==true) document.getElementById(field_id+j).value=value;

							if(field_id!='remarks_') calculate_requirement(j);
							if(field_id=='bodylength_' || field_id=='bodysewingmargin_' || field_id=='bodyhemmargin_' || field_id=='sleevelength_' || field_id=='sleevesewingmargin_' || field_id=='sleevehemmargin_' || field_id=='chestlenght_' || field_id=='chestsewingmargin_' || field_id=='frontriselength_' || field_id=='frontrisesewingmargin_' || field_id=='westbandlength_' || field_id=='westbandsewingmargin_' || field_id=='inseamlength_' || field_id=='inseamsewingmargin_' || field_id=='inseamhemmargin_' || field_id=='halfthailength_' || field_id=='halfthaisewingmargin_') calculate_measurement_top(j);
						}
					}
				}
			}
		}
		if(hid_fab_cons_in_quotation_variable==3)
		{
			//if(i==0) { copy_basis=0; copy_val=true; }
			for(var j=i; j<=rowCount; j++)
			{
				var isDisabled = document.getElementById(field_id+j).disabled;
				if(isDisabled==false)
				{
					if(document.getElementById('approved_'+j).value==0)
					{
						if(copy_val==true)
						{
							if(field_id=='itemsizes_')
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;

								calculate_requirement(j);
							}

							if(field_id=='diawidth_' || field_id=='cons_' || field_id=='processloss_' || field_id=='remarks_' || field_id=='rate_')
							{
								if(copy_basis==1)
								{
									if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
								}
								else if(copy_basis==2)
								{
									if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
								}
								else if(copy_basis==3)
								{
									if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
								}
								else if(copy_basis==4)
								{
									if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
								}
								else if(copy_val==true) document.getElementById(field_id+j).value=value;

								if(field_id!='remarks_') calculate_requirement(j);
							}
						}//if(document.getElementById('approved_'+j).value==0)
					}
				}
			}
		}
	}

	function check_width_is_null_or_not(i)
	{
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		if(cbofabricnature_id==3)
		{
			 if(document.getElementById('diawidth_'+i).value=='' || document.getElementById('diawidth_'+i).value==0)
			 {
				 alert("Fill up Width")
				 document.getElementById('diawidth_'+i).focus();
			 }
		}
	}

	function set_sum_value(des_fil_id,field_id)
	{
		if(des_fil_id=='cons_sum' || des_fil_id=='processloss_sum' || des_fil_id=='requirement_sum' || des_fil_id=='amount_sum' || des_fil_id=='rate_sum' || des_fil_id=='totReq_sum' || des_fil_id=='totAmount_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		else if(des_fil_id=='pcs_sum')
		{
			var ddd={dec_type:6,comma:0};
		}
		var rowCount =$('#txttotrow').val()*1;//var rowCount = $('#tbl_consmption_cost tr').length-1;
		//console.log(rowCount);
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		claculate_avg();
	}

	function js_set_value()
	{
		var body_part_id=document.getElementById('body_part_id').value;
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		var cbofabricsource_id=document.getElementById('cbofabricsource_id').value;
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		var rowCount = $('#tbl_consmption_cost tr').length-1;
		var cons_breck_down=""; var msmnt_breack_down=""; var marker_breack_down="";
		if(hid_fab_cons_in_quotation_variable==3)
		{
			if(form_validation('txt_marker_cm*txt_marker_length_cm*txt_gmt_pcs*txt_marker_gsm*txt_fabcons*txt_marker_net_fab_cons','Marker Dia[CM]*Marker Length [CM]*Gmts. Size Ratio [Pcs]*Marker Gsm*Fab Cons*Marker Net Fabric')==false)
			{
				return;
			}
			else
			{
				var txt_marker_cm=$('#txt_marker_cm').val()*1;
				var txt_diaallw_cm=$('#txt_diaallw_cm').val()*1;
				var txt_marker_length_cm=$('#txt_marker_length_cm').val()*1;
				var txt_lengthallw_cm=$('#txt_lengthallw_cm').val()*1;
				var txt_gmt_pcs=$('#txt_gmt_pcs').val()*1;
				var txt_marker_gsm=$('#txt_marker_gsm').val()*1;
				var txt_fabcons=$('#txt_fabcons').val()*1;
				var txt_cutprocess_loss=$('#txt_cutprocess_loss').val()*1;
				var txt_marker_net_fab_cons=$('#txt_marker_net_fab_cons').val()*1;
				marker_breack_down+=txt_marker_cm+'_'+txt_diaallw_cm+'_'+txt_marker_length_cm+'_'+txt_lengthallw_cm+'_'+txt_gmt_pcs+'_'+txt_marker_gsm+'_'+txt_fabcons+'_'+txt_cutprocess_loss+'_'+txt_marker_net_fab_cons;
			}
		}
		//console.log(rowCount);



		for(var i=1; i<=rowCount; i++)
		{

			var ponoid=$('#ponoid_'+i).val() ;
				if(ponoid=='') ponoid=0;
			var pocolorid=$('#pocolorid_'+i).val();
				if(pocolorid=='') pocolorid=0;
			var gmtssizesid=$('#gmtssizesid_'+i).val();
				if(gmtssizesid=='') gmtssizesid=0;
			var diawidth=$('#diawidth_'+i).val();
			//console.log(diawidth); return;
				if(diawidth=='') diawidth=0; else diawidth=trim(diawidth);
			var itemsizes=$('#itemsizes_'+i).val();
				if(itemsizes=='') itemsizes=0;
			var cons=$('#cons_'+i).val();
				if(cons=='')  cons=0;
			var processloss=$('#processloss_'+i).val();
				if(processloss=='') processloss=0;
			var requirement=$('#requirement_'+i).val();
				if(requirement=='') requirement=0;
			var pcs=$('#pcs_'+i).val();
				if(pcs=='') pcs=0;
			var colorsizetableid=$('#colorsizetableid_'+i).val();
				if(colorsizetableid=='') colorsizetableid=0;

			var rate=$('#rate_'+i).val()
				if(rate=='') rate=0;
			var amount=$('#amount_'+i).val();
				if(amount=='') amount=0;
			var remarks=$('#remarks_'+i).val();
				if(remarks=='') remarks='no remarks';



			if(cbofabricnature_id==3)
			{
				/*if(processloss=='' || processloss==0)
				{
					alert("Fill up  Process Loss")
					return;
				}
				if(cons=='' || cons==0)
				{
					alert("Fill up  Cons")
					return;
				}
				if(diawidth=='' || diawidth==0)
				{
					alert("Fill up Width")
					return;
				}*/
			}

			//=======================================================

			if(cbofabricnature_id==2  && cons!='' && processloss=='')
			{
				alert("Fill up  Process Loss")
				return;
			}
			if(cbofabricnature_id==2  && cons=='' && (processloss*1)!='')
			{
				alert("Fill up Cons")
				return;
			}
			//========================================================
			if(cbofabricnature_id==2  && cons!=0 && (processloss*1) < 0 )
			{
				alert("Fill up  Process Loss")
				return;
			}
			if(cbofabricnature_id==2  && cons==0 && (processloss*1)!=0)
			{
				alert("Fill up Cons")
				return;
			}

			//======================================================
			if(cbofabricsource_id==2 && (cons*1) > 0 && rate==0){
				alert("Fill up Rate")
				return;
			}

			if(body_part_id==1 && hid_fab_cons_in_quotation_variable==2 && cons!='' && processloss!='' && form_validation('bodylength_'+i+'*bodysewingmargin_'+i+'*bodyhemmargin_'+i+'*sleevelength_'+i+'*sleevesewingmargin_'+i+'*sleevehemmargin_'+i+'*chestlenght_'+i+'*chestsewingmargin_'+i,'Body Length*Body Sewing Margin*Body Hem Margin*Sleeve Length*Sleeve Sewing Margin*Sleeve Hem Margin*Chest Length*Chest Sewing Margin')==false)
			{
				return;
			}
			if(body_part_id==20 && hid_fab_cons_in_quotation_variable==2  && cons!='' && processloss!='' && form_validation('frontriselength_'+i+'*frontrisesewingmargin_'+i+'*westbandlength_'+i+'*westbandsewingmargin_'+i+'*inseamlength_'+i+'*inseamsewingmargin_'+i+'*inseamhemmargin_'+i+'*halfthailength_'+i+'*halfthaisewingmargin_'+i,'Front Rise Length*Front Rise Sewing Margin*West Band Length*West Band Sewing Margin*Inseam Length*Inseam Sewing Margin*Inseam Hem Margin*Half Thai Length* Half Thai Sewing Margin')==false )
			{
				return;
			}

			if(cons_breck_down=="")
			{
				cons_breck_down+=ponoid+'_'+pocolorid+'_'+gmtssizesid+'_'+diawidth+'_'+itemsizes+'_'+cons+'_'+processloss+'_'+requirement+'_'+pcs+'_'+colorsizetableid+'_'+rate+'_'+amount+'_'+remarks;
			}
			else
			{
				cons_breck_down+="__"+ponoid+'_'+pocolorid+'_'+gmtssizesid+'_'+diawidth+'_'+itemsizes+'_'+cons+'_'+processloss+'_'+requirement+'_'+pcs+'_'+colorsizetableid+'_'+rate+'_'+amount+'_'+remarks;
			}

			if(hid_fab_cons_in_quotation_variable==2)
			{
				if(body_part_id==1)
				{
					var bodylength=$('#bodylength_'+i).val();
					if(bodylength=='') bodylength=0;
					var bodysewingmargin=$('#bodysewingmargin_'+i).val();
					if(bodysewingmargin=='') bodysewingmargin=0;
					var bodyhemmargin=$('#bodyhemmargin_'+i).val();
					if(bodyhemmargin=='') bodyhemmargin=0;
					var sleevelength=$('#sleevelength_'+i).val();
					if(sleevelength=='') sleevelength=0;
					var sleevesewingmargin=$('#sleevesewingmargin_'+i).val();
					if(sleevesewingmargin=='') sleevesewingmargin=0;
					var sleevehemmargin=$('#sleevehemmargin_'+i).val();
					if(sleevehemmargin=='') sleevehemmargin=0;
					var chestlenght=$('#chestlenght_'+i).val();
					if(chestlenght=='') chestlenght=0;
					var chestsewingmargin= $('#chestsewingmargin_'+i).val();
					if(chestsewingmargin=='') chestsewingmargin=0;
					var totalcons=$('#totalcons_'+i).val();
					if(totalcons=='') totalcons=0;
				}

				if(body_part_id==20)
				{
					var frontriselength= $('#frontriselength_'+i).val();
					if(frontriselength=='') frontriselength=0;
					var frontrisesewingmargin=$('#frontrisesewingmargin_'+i).val();
					if(frontrisesewingmargin=='') frontrisesewingmargin=0;
					var westbandlength=$('#westbandlength_'+i).val();
					if(westbandlength=='') westbandlength=0;
					var westbandsewingmargin=$('#westbandsewingmargin_'+i).val();
					if(westbandsewingmargin=='') westbandsewingmargin=0;
					var inseamlength=$('#inseamlength_'+i).val();
					if(inseamlength=='') inseamlength=0;
					var inseamsewingmargin=$('#inseamsewingmargin_'+i).val();
					if(inseamsewingmargin=='') inseamsewingmargin=0;
					var inseamhemmargin=$('#inseamhemmargin_'+i).val();
					if(inseamhemmargin=='') inseamhemmargin=0;
					var halfthailength=$('#halfthailength_'+i).val();
					if(halfthailength=='') halfthailength=0;
					var halfthaisewingmargin=$('#halfthaisewingmargin_'+i).val();
					if(halfthaisewingmargin=='') halfthaisewingmargin=0;
					var totalcons=$('#totalcons_'+i).val();
					if(totalcons=='')totalcons=0;
				}

				if(msmnt_breack_down=="")
				{
					if(body_part_id==1)
					{
					msmnt_breack_down+=bodylength+'_'+bodysewingmargin+'_'+bodyhemmargin+'_'+sleevelength+'_'+sleevesewingmargin+'_'+sleevehemmargin+'_'+chestlenght+'_'+chestsewingmargin+'_'+totalcons;
					}
					if(body_part_id==20)
					{
					msmnt_breack_down+=frontriselength+'_'+frontrisesewingmargin+'_'+westbandlength+'_'+westbandsewingmargin+'_'+inseamlength+'_'+inseamsewingmargin+'_'+inseamhemmargin+'_'+halfthailength+'_'+halfthaisewingmargin+'_'+totalcons;
					}
				}
				else
				{
					if(body_part_id==1)
					{
					msmnt_breack_down+="__"+bodylength+'_'+bodysewingmargin+'_'+bodyhemmargin+'_'+sleevelength+'_'+sleevesewingmargin+'_'+sleevehemmargin+'_'+chestlenght+'_'+chestsewingmargin+'_'+totalcons;
					}
					if(body_part_id==20)
					{
					msmnt_breack_down+="__"+frontriselength+'_'+frontrisesewingmargin+'_'+westbandlength+'_'+westbandsewingmargin+'_'+inseamlength+'_'+inseamsewingmargin+'_'+inseamhemmargin+'_'+halfthailength+'_'+halfthaisewingmargin+'_'+totalcons;
					}
				}
			}
		}
		document.getElementById('cons_breck_down').value=cons_breck_down;
		document.getElementById('msmnt_breack_down').value=msmnt_breack_down;
		document.getElementById('marker_breack_down').value=marker_breack_down;

		claculate_avg();
		parent.emailwindow.hide();
	}

	function calculate_measurement_top(i)
	{
		var body_part_id=document.getElementById('body_part_id').value;
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		var cbo_costing_per_id=document.getElementById('cbo_costing_per_id').value;
		var dzn_mult=0;
		if (cbo_costing_per_id==1) dzn_mult=1*12;
		else if (cbo_costing_per_id==2) dzn_mult=1*1;
		else if (cbo_costing_per_id==3) dzn_mult=2*12;
		else if (cbo_costing_per_id==4) dzn_mult=3*12;
		else if (cbo_costing_per_id==5) dzn_mult=4*12;
		else dzn_mult=0;

	  //------------------------------------Knit------------------------------------
		if(cbofabricnature_id==2)//Knit
		{
			var txt_required_gsm_top=(document.getElementById('txt_gsm').value)*1;
			if (body_part_id==1)//main fabric top
			{
				var txt_body_length_measurement_top=0; var txt_body_length_sewing_top=0; var txt_body_length_hem_top=0; var txt_sleeve_length_measurement_top=0; var txt_sleeve_length_sewing_top=0; var txt_sleeve_length_hem_top=0; var txt_chest_measurement_top=0; var txt_chest_sew_top=0;

				txt_body_length_measurement_top=(document.getElementById('bodylength_'+i).value)*1;
				txt_body_length_sewing_top=(document.getElementById('bodysewingmargin_'+i).value)*1;
				txt_body_length_hem_top=(document.getElementById('bodyhemmargin_'+i).value)*1;
				txt_sleeve_length_measurement_top=(document.getElementById('sleevelength_'+i).value)*1;
				txt_sleeve_length_sewing_top=(document.getElementById('sleevesewingmargin_'+i).value)*1;
				txt_sleeve_length_hem_top=(document.getElementById('sleevehemmargin_'+i).value)*1;
				txt_chest_measurement_top=(document.getElementById('chestlenght_'+i).value)*1;
				txt_chest_sew_top=(document.getElementById('chestsewingmargin_'+i).value)*1;

				var dbl_total=(((txt_body_length_measurement_top +txt_sleeve_length_measurement_top+txt_body_length_sewing_top + txt_sleeve_length_sewing_top+txt_body_length_hem_top+txt_sleeve_length_hem_top) * (txt_chest_measurement_top + txt_chest_sew_top)) * 2) * 12 * txt_required_gsm_top / 10000000;

			}
			if (body_part_id==20)//main fabric bottom
			{
				var txt_front_rise_measurement_bottom=0; var txt_front_rise_sewing_bottom=0; var txt_west_band_measurement_bottom=0; var txt_west_band_sewing_bottom=0; var txt_in_seam_measurement_bottom=0; var txt_in_seam_sew_bottom=0; var txt_in_seam_hem_bottom=0; var txt_half_thai_measurement_bottom=0; var txt_half_thai_sew_bottom=0;

				var txt_front_rise_measurement_bottom=(document.getElementById('frontriselength_'+i).value)*1;
				var txt_front_rise_sewing_bottom=(document.getElementById('frontrisesewingmargin_'+i).value)*1;
				var txt_west_band_measurement_bottom=(document.getElementById('westbandlength_'+i).value)*1;
				var txt_west_band_sewing_bottom=(document.getElementById('westbandsewingmargin_'+i).value)*1;
				var txt_in_seam_measurement_bottom=(document.getElementById('inseamlength_'+i).value)*1;
				var txt_in_seam_sew_bottom=(document.getElementById('inseamsewingmargin_'+i).value)*1;
				var txt_in_seam_hem_bottom=document.getElementById('inseamhemmargin_'+i).value;
				var txt_half_thai_measurement_bottom=(document.getElementById('halfthailength_'+i).value)*1;
				var txt_half_thai_sew_bottom=(document.getElementById('halfthaisewingmargin_'+i).value)*1;

				var dbl_total=(((txt_front_rise_measurement_bottom +txt_west_band_measurement_bottom +txt_in_seam_measurement_bottom+txt_front_rise_sewing_bottom + txt_west_band_sewing_bottom+txt_in_seam_sew_bottom+txt_in_seam_hem_bottom) * (txt_half_thai_measurement_bottom+txt_half_thai_sew_bottom)) * 4) * 12  * txt_required_gsm_top/ 10000000;
			}
		}
	 //------------------------------------End Knit------------------------------------
	 //----------------------------------- Woven---------------------------------------
		if(cbofabricnature_id==3)//woven
		{
			var txt_required_weight_top=document.getElementById('diawidth_'+i).value;
			if (body_part_id==1)//main fabric top
			{
				var txt_body_length_measurement_top=0; var txt_body_length_sewing_top=0; var txt_body_length_hem_top=0; var txt_sleeve_length_measurement_top=0; var txt_sleeve_length_sewing_top=0; var txt_sleeve_length_hem_top=0; var txt_chest_measurement_top=0; var txt_chest_sew_top=0;

				txt_body_length_measurement_top=document.getElementById('bodylength_'+i).value;
				txt_body_length_sewing_top=document.getElementById('bodysewingmargin_'+i).value;
				txt_body_length_hem_top=document.getElementById('bodyhemmargin_'+i).value;
				txt_sleeve_length_measurement_top=document.getElementById('sleevelength_'+i).value;
				txt_sleeve_length_sewing_top=document.getElementById('sleevesewingmargin_'+i).value;
				txt_sleeve_length_hem_top=document.getElementById('sleevehemmargin_'+i).value;
				txt_chest_measurement_top=document.getElementById('chestlenght_'+i).value;
				txt_chest_sew_top=document.getElementById('chestsewingmargin_'+i).value;

				var dbl_total=(((txt_body_length_measurement_top*1)+(txt_body_length_sewing_top*1)+(txt_body_length_hem_top*1)+(txt_sleeve_length_measurement_top*1)+(txt_sleeve_length_sewing_top*1)+(txt_sleeve_length_hem_top*1))*((txt_chest_measurement_top*1)+(txt_chest_sew_top*1))*2*(dzn_mult*1))/((txt_required_weight_top*1)*36);

			}
			if (body_part_id==20)//main fabric bottom
			{
				var txt_front_rise_measurement_bottom=0; var txt_front_rise_sewing_bottom=0; var txt_west_band_measurement_bottom=0; var txt_west_band_sewing_bottom=0; var txt_in_seam_measurement_bottom=0; var txt_in_seam_sew_bottom=0; var txt_in_seam_hem_bottom=0; var txt_half_thai_measurement_bottom=0; var txt_half_thai_sew_bottom=0;

				var txt_front_rise_measurement_bottom=document.getElementById('frontriselength_'+i).value;
				var txt_front_rise_sewing_bottom=document.getElementById('frontrisesewingmargin_'+i).value;
				var txt_west_band_measurement_bottom=document.getElementById('westbandlength_'+i).value;
				var txt_west_band_sewing_bottom=document.getElementById('westbandsewingmargin_'+i).value;
				var txt_in_seam_measurement_bottom=document.getElementById('inseamlength_'+i).value;
				var txt_in_seam_sew_bottom=document.getElementById('inseamsewingmargin_'+i).value;
				var txt_in_seam_hem_bottom=document.getElementById('inseamhemmargin_'+i).value;
				var txt_half_thai_measurement_bottom=document.getElementById('halfthailength_'+i).value;
				var txt_half_thai_sew_bottom=document.getElementById('halfthaisewingmargin_'+i).value;

				var dbl_total=(((txt_front_rise_measurement_bottom*1)+(txt_front_rise_sewing_bottom*1)+(txt_west_band_measurement_bottom*1)+(txt_west_band_sewing_bottom*1)+(txt_in_seam_measurement_bottom*1)+(txt_in_seam_sew_bottom*1)+(txt_in_seam_hem_bottom*1))*((txt_half_thai_measurement_bottom*1)+(txt_half_thai_sew_bottom*1))*4*(dzn_mult*1))/((txt_required_weight_top*1)*36);
			}
		}
		//----------------------------------- End Woven---------------------------------------
		dbl_total= number_format_common( dbl_total, 5, 0) ;
		document.getElementById('totalcons_'+i).value=dbl_total;
		document.getElementById('cons_'+i).value=dbl_total;
		set_sum_value( 'cons_sum', 'cons_'  );
		set_sum_value( 'requirement_sum', 'requirement_' );
		calculate_requirement(i);
		claculate_avg();
	}

	function calculate_requirement(i)
	{
		var process_loss_method_id=document.getElementById('process_loss_method_id').value;
		var cons=(document.getElementById('cons_'+i).value)*1;
		var processloss=(document.getElementById('processloss_'+i).value)*1;
		var WastageQty='';
		if(process_loss_method_id==1)
		{
			WastageQty=cons+cons*(processloss/100);
		}
		else if(process_loss_method_id==2)
		{
			var devided_val = 1-(processloss/100);
			var WastageQty=parseFloat(cons/devided_val);
		}
		else
		{
			WastageQty=0;
		}
		WastageQty= number_format_common( WastageQty, 5, 0) ;
		document.getElementById('processloss_'+i).value=processloss;
		document.getElementById('requirement_'+i).value= WastageQty;
		set_sum_value( 'requirement_sum', 'requirement_' );
		claculate_amount(i);
		claculate_avg();
	}

	function claculate_avg()
	{
		var tot_plancut_qty=document.getElementById('tot_plancut_qty').value*1
		var item_ratio=document.getElementById('item_ratio').value*1
		var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0; var significant_row=0;
		var rowCount =$('#txttotrow').val()*1;// $('#tbl_consmption_cost tr').length-1;
		//console.log('joy=='+rowCount)
		for(var j=1; j<=rowCount; j++)
		{
			if(document.getElementById('cons_'+j).value =='' || document.getElementById('cons_'+j).value ==0){
				continue;
			}
			else{
				plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
			}
		}

		for(var i=1; i<=rowCount; i++)
		{
			if(document.getElementById('cons_'+i).value =='' || document.getElementById('cons_'+i).value ==0){
				continue;
			}
			else{
				significant_row=significant_row+1;
				var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
				//var plan_cut_percent=(pcsgmts/plancutqty)*100;
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;

				var cons=document.getElementById('cons_'+i).value*1
				var avg_cons_percent=(cons*plan_cut_percent)/100;
				avg_cons+=avg_cons_percent;

				var requirement=document.getElementById('requirement_'+i).value*1
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;

				var amount=document.getElementById('amount_'+i).value*1
				var calculated_amount_percent=(amount*plan_cut_percent)/100;
				calculated_amount+=calculated_amount_percent;
			}
		}
		var calculated_procloss=(document.getElementById('processloss_sum').value*1)/significant_row;
		var calculated_pcs=(document.getElementById('pcs_sum').value*1)/significant_row;
		//document.getElementById('calculated_cons').value=number_format_common(calculated_cons*item_ratio, 5, 0);
		document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 5, 0);
		document.getElementById('avg_cons').value=number_format_common(avg_cons, 5, 0);
		document.getElementById('calculated_procloss').value=number_format_common(calculated_procloss, 5, 0);
		document.getElementById('calculated_pcs').value=calculated_pcs;
		document.getElementById('calculated_plancutqty').value=plancutqty;
		//document.getElementById('calculated_plancutqty').value=tot_plancut_qty/item_ratio;
		//document.getElementById('calculated_amount').value=number_format_common(calculated_amount*item_ratio, 5, 0);
		document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 5, 0);
		document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
	}

	function calculate_marker_length()
	{
		var cbo_costing_per_id=document.getElementById('cbo_costing_per_id').value;
		var dzn_mult=0;
		if (cbo_costing_per_id==1) dzn_mult=1*12;
		else if (cbo_costing_per_id==2) dzn_mult=1*1;
		else if (cbo_costing_per_id==3) dzn_mult=2*12;
		else if (cbo_costing_per_id==4) dzn_mult=3*12;
		else if (cbo_costing_per_id==5) dzn_mult=4*12;
		else dzn_mult=0;

		var txt_marker_cm= (document.getElementById('txt_marker_cm').value)*1;
		var txt_diaallw_cm= (document.getElementById('txt_diaallw_cm').value)*1;
		var txt_marker_length_cm= (document.getElementById('txt_marker_length_cm').value)*1;
		var txt_lengthallw_cm= (document.getElementById('txt_lengthallw_cm').value)*1;
		var txt_gmt_pcs= (document.getElementById('txt_gmt_pcs').value)*1;
		var txt_marker_gsm= (document.getElementById('txt_marker_gsm').value)*1;

		var netfabcons=((((txt_marker_cm+txt_diaallw_cm)*(txt_marker_length_cm+txt_lengthallw_cm)*txt_marker_gsm)/10000000) /txt_gmt_pcs)*dzn_mult;

		document.getElementById('txt_fabcons').value=number_format_common( netfabcons, 5, 0) ;

		var txt_fabcons= (document.getElementById('txt_fabcons').value)*1;
		var txt_cutprocess_loss= (document.getElementById('txt_cutprocess_loss').value)*1;

		var totFabcons=txt_fabcons+(txt_fabcons*(txt_cutprocess_loss/100));

		//var netfabcons=((txt_marker_cm*txt_marker_length_cm*txt_marker_gsm)/10000000)/txt_gmt_pcs*dzn_mult;
		var totFabcons_per= number_format_common( totFabcons, 5, 0) ;
		document.getElementById('txt_marker_net_fab_cons').value=totFabcons_per;
		copy_value( number_format_common(totFabcons_per,5,0),'cons_',1);
	}

	function claculate_amount(i)
	{
		var rate=document.getElementById('rate_'+i).value;
		var requirement=document.getElementById('requirement_'+i).value;
		var plan_cut_qty=document.getElementById('pcsgmts_'+i).value*1;
		var pcs=document.getElementById('pcs_'+i).value*1;

		var rowtotReq=(requirement/pcs)*plan_cut_qty;
		var amount= requirement*rate;
		var rowtotAmt=rowtotReq*rate;
		document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
		document.getElementById('totqty_'+i).value=number_format_common(rowtotReq,5,0);
		document.getElementById('totamount_'+i).value=number_format_common(rowtotAmt,5,0);
		set_sum_value( 'amount_sum', 'amount_' );
		set_sum_value( 'totReq_sum', 'totqty_');
		set_sum_value( 'totAmount_sum', 'totamount_');
		claculate_avg();
	}

	function fnc_all_copy(type) // issue id =ISD-22-13480
	{
		var copy_basis=$('input[name="copy_basis"]:checked').val();
		if(type==10) //issue id =29123,Yr-23
		{
			$('input[id=copy_basis1]').attr('checked',false);
			document.getElementById('copy_val').checked=false;
		}
		else
		{
			if(copy_basis==1 || copy_basis==2 || copy_basis==3 || copy_basis==4 || copy_basis==5 || copy_basis==6 )
			{
				document.getElementById('copy_val').checked=false;
			}
			else { 
				document.getElementById('copy_val').checked=true;
			}
		}	
	}
</script>
<style>
	.text_boxes_without_title{
		height: 18px;
		font-size: 13px;
		line-height: 16px;
		padding: 0 5px;
		text-align:left;
		border: 1px solid #676767;
		border-radius: 3px;
		border-radius: .5em;
	}
</style>
</head>
<body>
	<div><?=load_freeze_divs ("../../../",""); ?></div>
    <script>freeze_window(0);</script>
	<div align="left" style="width:98%;">
		<fieldset>
        <legend><?=$body_part_id.'.'.$body_part[$body_part_id].' Costing '.$costing_per[$cbo_costing_per]; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?=create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>
                <input type="radio" name="copy_basis" id="copy_basis1" value="1" onClick="fnc_all_copy(1);">Size Wise
                <input type="radio" name="copy_basis" id="copy_basis1" value="2" onClick="fnc_all_copy(2);">Color Wise
                <input type="radio" name="copy_basis" id="copy_basis1" value="3" onClick="fnc_all_copy(3);">Color & Size Wise
                <input type="radio" name="copy_basis" id="copy_basis1" value="4" onClick="fnc_all_copy(4);">Po Wise
                <input type="radio" name="copy_basis" id="copy_basis1" value="5" onClick="fnc_all_copy(5);">PO with Color
                <input type="radio" name="copy_basis" id="copy_basis1" value="6" onClick="fnc_all_copy(6);">PO with Size
                <input type="reset" value="Reset" onClick="fnc_all_copy(10);">
        </legend>
        <form id="consumptionform_1" autocomplete="off">
            <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<?=$cbo_company_id; ?>"/>
            <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<?=$cbo_costing_per; ?>"/>
            <input type="hidden" id="hid_fab_cons_in_quotation_variable" name="hid_fab_cons_in_quotation_variable" value="<?=$hid_fab_cons_in_quotation_variable; ?>" />
            <input type="hidden" id="body_part_id" name="body_part_id" value="<?=$body_part_id; ?>"/>
            <input type="hidden" id="cbofabricnature_id" name="cbofabricnature_id" value="<?=$cbofabricnature_id; ?>"/>
            <input type="hidden" id="cbofabricsource_id" name="cbofabricsource_id" value="<?=$cbofabricsource; ?>"/>
            <input type="hidden" id="cons_breck_down" name="cons_breck_down" value="<?=$cons_breck_downn;?>"/>
            <input type="hidden" id="msmnt_breack_down" name="msmnt_breack_down" value="<?=$msmnt_breack_downn;?>"/>
            <input type="hidden" id="marker_breack_down" name="marker_breack_down" value="<?=$marker_breack_down;?>"/>
            <input type="hidden" id="txt_gsm" name="txt_gsm" value="<?=$txtgsmweight; ?>"/>
			<?
			$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
			$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
			//$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$txt_job_no'");
			$component_approved=0;
			$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$txt_job_no'");
			foreach($sql as $row){
				if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
			}
			/*$fab_budget_on=return_field_value("embellishment_budget_id", "variable_order_tracking", "company_name=$cbo_company_id  and variable_list=75 and embellishment_id=2 and status_active=1 and is_deleted=0");
			if($fab_budget_on==0 || $fab_budget_on=='') $fab_budget_on=2;*/

			$arr_bo_app_po=array();
			$sql_bo_app_po=sql_select("select a.is_approved,b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id from wo_booking_mst a, wo_booking_dtls b where  a.booking_no=b.booking_no and  b.job_no='$txt_job_no' and a.booking_type=1 and a.is_short=2 and a.is_approved in(1,3)  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by b.pre_cost_fabric_cost_dtls_id,a.is_approved,b.po_break_down_id");
			foreach($sql_bo_app_po as $row_bo_app_po)
			{
				$is_approved=$row_bo_app_po[csf('is_approved')];
				if($is_approved==3) $is_approved=1; else $is_approved=$is_approved;
			    $arr_bo_app_po[$row_bo_app_po[csf('po_break_down_id')]][$row_bo_app_po[csf('pre_cost_fabric_cost_dtls_id')]]= $is_approved;
			}

			$pcs_value=0;
			$set_item_ratio=return_field_value("set_item_ratio", "wo_po_details_mas_set_details", "job_no='$txt_job_no'  and gmts_item_id='$cbogmtsitem'");
			if($set_item_ratio==0 || $set_item_ratio=="") $set_item_ratio=1;

			if($cbo_costing_per==1) $pcs_value=1*12*$set_item_ratio;
			else if($cbo_costing_per==2) $pcs_value=1*1*$set_item_ratio;
			else if($cbo_costing_per==3) $pcs_value=2*12*$set_item_ratio;
			else if($cbo_costing_per==4) $pcs_value=3*12*$set_item_ratio;
			else if($cbo_costing_per==5) $pcs_value=4*12*$set_item_ratio;

			if($body_part_id==3) $pcs_value=$pcs_value*2;
				/*if($fab_budget_on==1) //Order Qty //Issue ID-28057 Remove this issue
				{
					$select_poQty_cond="b.order_quantity as plan_cut_qnty";
					$select_poQty_cond2="sum(c.order_quantity) as plan_cut_qnty";
				}
				else
				{
					$select_poQty_cond="b.plan_cut_qnty as plan_cut_qnty";
					$select_poQty_cond2="sum(c.plan_cut_qnty) as plan_cut_qnty";
				}*/

			$tot_plancut_qty=0; $job_plancut_qty=0;
			$data_array_tot_po_qty=sql_select("select b.item_number_id, b.color_order as color_order, b.size_order as size_order, b.order_quantity, b.plan_cut_qnty as plan_cut_qnty from  wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and b.job_no_mst='$txt_job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
			foreach($data_array_tot_po_qty as $data_array_tot_po_qty_row )
			{
				if($budgeton==1)
				{
					if($data_array_tot_po_qty_row[csf('item_number_id')]==$cbogmtsitem) $tot_plancut_qty+=$data_array_tot_po_qty_row[csf('order_quantity')];
					$job_plancut_qty+=$data_array_tot_po_qty_row[csf('order_quantity')];
				}
				else
				{
					if($data_array_tot_po_qty_row[csf('item_number_id')]==$cbogmtsitem) $tot_plancut_qty+=$data_array_tot_po_qty_row[csf('plan_cut_qnty')];
					$job_plancut_qty+=$data_array_tot_po_qty_row[csf('plan_cut_qnty')];
				}
			}
			unset($data_array_tot_po_qty);

			$process_loss_method=return_field_value("process_loss_method", "variable_order_tracking", "company_name=$cbo_company_id  and variable_list=18 and item_category_id=$cbofabricnature_id and status_active=1 and is_deleted=0");

			//echo $fab_budget_on.'d';
			 ?>
           <input type="hidden" id="process_loss_method_id" name="process_loss_method_id" value="<?=$process_loss_method; ?>"/>
           <input type="hidden" id="tot_plancut_qty" name="tot_plancut_qty" value="<?=$tot_plancut_qty; ?>"/>
           <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<?=$job_plancut_qty; ?>"/>
           <input type="hidden" id="item_ratio" name="item_ratio" value="<?=$set_item_ratio; ?>"/>
           <?
			if($hid_fab_cons_in_quotation_variable==3)
			{
				?>
				<table width="720" cellspacing="0" class="rpt_table" border="0" id="tbl_marker_cost" rules="all">
                    <thead>
                        <tr>
                        	<th width="80">Marker Dia [CM]</th>
                            <th width="80">Dia Alw. [CM]</th>
                            <th width="80">Marker Length [CM]</th>
                            <th width="80">Length Alw. [CM]</th>
                            <th width="80">Gmts. Size Ratio [Pcs]</th>
                            <th width="80">GSM</th>
                            <th width="80">Fab Cons</th>
                            <th width="80">Cutting Process %</th>
                            <th>Net Fab Cons</th>
                        </tr>
                    </thead>
                    <tbody>
						<? $marker_breack_down_arr=explode("_",$marker_breack_down);
						if($marker_breack_down_arr[1]=="") $marker_breack_down_arr[1]=3;
						if($marker_breack_down_arr[3]=="") $marker_breack_down_arr[3]=4;
						?>
                        <tr>
                            <td><input type="text" id="txt_marker_cm" name="txt_marker_cm" class="text_boxes_numeric" style="width:70px" onChange="calculate_marker_length(); copy_value(this.value,'diawidth_',0);" value="<?=$marker_breack_down_arr[0]; ?>"> </td>
                            <td><input type="text" id="txt_diaallw_cm" name="txt_diaallw_cm" class="text_boxes_numeric" style="width:70px" onChange="calculate_marker_length();" value="<?=$marker_breack_down_arr[1]; ?>"> </td>
                            <td><input type="text" id="txt_marker_length_cm" name="txt_marker_length_cm" class="text_boxes_numeric" style="width:70px" onChange="calculate_marker_length();" value="<?=$marker_breack_down_arr[2]; ?>"></td>
                            <td><input type="text" id="txt_lengthallw_cm" name="txt_lengthallw_cm" class="text_boxes_numeric" style="width:70px" onChange="calculate_marker_length();" value="<?=$marker_breack_down_arr[3]; ?>"></td>
                            <td><input type="text" id="txt_gmt_pcs" name="txt_gmt_pcs" class="text_boxes_numeric" style="width:70px" onChange="calculate_marker_length();" value="<?=$marker_breack_down_arr[4]; ?>"></td>
                            <td><input type="text" id="txt_marker_gsm" name="txt_marker_gsm" class="text_boxes_numeric" readonly style="width:70px" value="<?=$txtgsmweight; ?>"></td>
                            <td><input type="text" id="txt_fabcons" name="txt_fabcons" class="text_boxes_numeric" readonly style="width:70px" value="<?=$marker_breack_down_arr[6]; ?>"></td>
                            <td><input type="text" id="txt_cutprocess_loss" name="txt_cutprocess_loss" class="text_boxes_numeric" style="width:70px" onChange="calculate_marker_length();" value="<?=$marker_breack_down_arr[7]; ?>"></td>
                            <td><input type="text" id="txt_marker_net_fab_cons" name="txt_marker_net_fab_cons" class="text_boxes_numeric" style="width:70px" value="<?=$marker_breack_down_arr[8]; ?>" readonly></td>
                        </tr>
                    </tbody>
				</table>
                <br/>
				<?
			}
		   	?>
            <table width="1140" cellspacing="0" class="rpt_table" border="0" rules="all">
                <thead>
                    <tr>
                        <th width="30">SL</th>
                        <th width="120">PO NO</th>
                        <th width="90">Color</th>
                        <th width="60">Gmts Size</th>
                        <th width="70"><? if($cbofabricnature_id==2){echo "Dia"; }else{ echo "Width";}?></th>
                        <th width="60">Item Size /Cut Dia</th>
                        <th width="70">Finish Cons <?="[". $unit_of_measurement[$uom]."]"; ?></th>
                        <th width="60">Process Loss %</th>
                        <th width="70">Grey Cons <?="[". $unit_of_measurement[$uom]."]"; ?></th>
                        <th width="60">Rate</th>
                        <th width="80">Amount</th>
                        <th width="50">Pcs</th>
                        <th width="80">Total Qty</th>
                        <th width="80">Total Amount</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
             </table>
            <div style="max-height:300px; overflow-y:scroll; width:1160px" align="left" id="scroll_body">
                <table width="1140" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
					<tbody>
                    <?
					$data_array=explode("__",$cons_breck_downn);
					if($data_array[0]=="")
					{
						$data_array=array();
					}
					//echo $pri_fab_cost_dtls_id.'-';
					if($costControlSource==2 && $pri_fab_cost_dtls_id !="")
					{
						$sql_price_quatation=sql_select("select gmts_sizes, dia_width, cons, process_loss_percent, requirment, rate, amount from  wo_pri_quo_fab_co_avg_con_dtls where wo_pri_quo_fab_co_dtls_id=$pri_fab_cost_dtls_id");

						foreach($sql_price_quatation as $row)
						{
							$price_quatation_dia[$row[csf('gmts_sizes')]]=$row[csf('dia_width')];
							$price_quatation_cons[$row[csf('gmts_sizes')]]=$row[csf('cons')];
							$price_quatation_cons_process_loss[$row[csf('gmts_sizes')]]=$row[csf('process_loss_percent')];
							$price_quatation_requirment[$row[csf('gmts_sizes')]]=$row[csf('requirment')];
							$price_quatation_rate[$row[csf('gmts_sizes')]]=$row[csf('rate')];
							$price_quatation_amount[$row[csf('gmts_sizes')]]=$row[csf('amount')];
						}
						unset($sql_price_quatation);
					}
					else if($costControlSource==5 && $pri_fab_cost_dtls_id!="")
					{
						$sql_short_quatation=sql_select("select dia, cons, exper, tot_cons, rate, value from qc_fab_yarn_conv where type = 1 and id=$pri_fab_cost_dtls_id order by id desc");

						foreach($sql_short_quatation as $row)
						{
							$short_quatation_dia=$row[csf('dia')];
							$short_quatation_requirment=$row[csf('tot_cons')];
						}
						unset($sql_short_quatation);
					}

					//Oracle
					//echo $pre_cost_fabric_cost_dtls_id.'XXXXXXx';sum(c.plan_cut_qnty) as plan_cut_qnty
					$dataSql="select b.id, b.po_number, b.po_quantity, b.shipment_date, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, c.color_number_id, c.size_number_id, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number, b.po_quantity, b.shipment_date, c.color_number_id, c.size_number_id order by b.id, color_order, size_order";
					//echo $dataSql;
					$data_array=sql_select($dataSql);
					//=======================================

					if($pre_cost_fabric_cost_dtls_id != "")
					{
						$is_booking_arr=array();
						$data_arr=sql_select("select a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and b.job_no ='$txt_job_no' and b.pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id and b.booking_type='1' and a.is_deleted=0 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 group by a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id");
						//$is_booking=count($data_arr);
						foreach($data_arr as $row)
						{
							if($row[csf('entry_form')]==108 || $row[csf('is_short')]==1 || $row[csf('is_approved')]==1)
							{
								$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
							}
						}
						unset($data_arr);
						//print_r($is_booking_arr);

						$row_arr_data="";
						$sqlCosFab="select  id, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks from wo_pre_cos_fab_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id order by id";
						//echo $sqlCosFab;
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select($sqlCosFab);


						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $wo_pre_avg_data_row)
						{
							$data_array_cons[$wo_pre_avg_data_row[csf('color_size_table_id')]]=$wo_pre_avg_data_row[csf('po_break_down_id')]."_".$wo_pre_avg_data_row[csf('color_number_id')]."_".$wo_pre_avg_data_row[csf('gmts_sizes')]."_".trim($wo_pre_avg_data_row[csf('dia_width')])."_".trim($wo_pre_avg_data_row[csf('item_size')])."_".$wo_pre_avg_data_row[csf('cons')]."_".$wo_pre_avg_data_row[csf('process_loss_percent')]."_".$wo_pre_avg_data_row[csf('requirment')]."_".$wo_pre_avg_data_row[csf('pcs')]."_".$wo_pre_avg_data_row[csf('color_size_table_id')]."_".$wo_pre_avg_data_row[csf('rate')]."_".$wo_pre_avg_data_row[csf('amount')]."_".$wo_pre_avg_data_row[csf('remarks')];
						}
					}
					//echo $row_arr_data;
					//print_r( $data_array_cons);
					if($pre_cost_fabric_cost_dtls_id == "")
					{
						$data_array_cons=explode("__",$cons_breck_downn);
					}
						//=======================================
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							if($pre_cost_fabric_cost_dtls_id != "") $data=explode('_',$data_array_cons[$row[csf('color_size_table_id')]]);
							else $data=explode('_',$data_array_cons[$i]);

							$cons_up=0; $is_booking=0;
							$is_booking=$is_booking_arr[$row[csf('id')]];
							if($precostapproved==1 || $arr_bo_app_po[$row[csf('id')]][$pre_cost_fabric_cost_dtls_id]==1 || $component_approved==1 || $is_booking!="" || $is_booking!=0)
							{
								$disabled=1; if($is_booking!="" || $is_booking!=0) $cons_up=1;
							}
							else $disabled=0;

							$planPoQty=0;

							if($budgeton==1) $planPoQty=$row[csf('order_quantity')]; else $planPoQty=$row[csf('plan_cut_qnty')];

							$i++;

							if($costControlSource==5 && $data[3]=="") $data[3]=$short_quatation_dia;
							if($costControlSource==5 && $data[5]=="") $data[5]=$short_quatation_requirment;
							if($costControlSource==5 && $data[7]=="") $data[7]=$short_quatation_requirment;

							$RowtotReq=0; $RowtotAmt=0;
							$RowtotReq=fn_number_format(($data[7]/$pcs_value)*$planPoQty,4,".","");

							$totReq+=$RowtotReq;
							$RowtotAmt=fn_number_format($RowtotReq*$data[10],4,".","");
							$totAmt+=$RowtotAmt;
							?>
							 <tr id="break_<?=$i; ?>" align="center">
								<td width="30" align="center"><?=$i; ?></td>
								<td width="120" style="word-break:break-all"><?=$row[csf('po_number')]; ?>
									<input type="hidden" id="pono_<?=$i;?>" name="pono_<?=$i;?>" class="text_boxes" style="width:105px" value="<?=$row[csf('po_number')]; ?>" readonly />
									<input type="hidden" id="ponoid_<?=$i;?>" name="ponoid_<?=$i;?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly />
								</td>
								<td width="90" style="word-break:break-all"><?=$color_library[$row[csf('color_number_id')]]; ?>
									<input type="hidden" id="pocolor_<?=$i;?>" name="pocolor_<?=$i;?>" class="text_boxes" style="width:78px" value="<?=$color_library[$row[csf('color_number_id')]]; ?>" readonly />
									<input type="hidden" id="pocolorid_<?=$i;?>" name="pocolorid_<?=$i;?>" class="text_boxes" style="width:75px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
								</td>
								<td width="60" style="word-break:break-all"><?=$size_library[$row[csf('size_number_id')]]; ?>
									<input type="hidden" id="gmtssizes_<?=$i;?>" name="gmtssizes_<?=$i;?>" class="text_boxes" style="width:48px" value="<?=$size_library[$row[csf('size_number_id')]]; ?>" readonly>
									<input type="hidden" id="gmtssizesid_<?=$i;?>" name="gmtssizesid_<?=$i;?>" class="text_boxes" style="width:45px" value="<?=$row[csf('size_number_id')]; ?>" readonly />
								</td>
								<td width="70">
									<input type="text" id="diawidth_<?=$i;?>" value="<? if($data[3]==""){echo $price_quatation_dia[$row[csf('size_number_id')]];}else{ echo $data[3];} ?>" name="diawidth_<?=$i;?>" class="<? if($cbofabricnature_id==2){echo "text_boxes"; }else{ echo "text_boxes_numeric";}?>" style="width:58px" onChange="<? if($hid_fab_cons_in_quotation_variable==2){ echo "calculate_measurement_top( $i)";} ?>;copy_value(this.value,'diawidth_',<?=$i;?>)"<? if($disabled==1){ echo "disabled";} else{ echo "";} ?> />
								</td>
								<td width="60">
									<input type="text" title="<?=$data[4]; ?>" id="itemsizes_<?=$i;?>"  name="itemsizes_<?=$i;?>" class="text_boxes_without_title" style="width:48px" onChange="copy_value(this.value,'itemsizes_',<?=$i;?>);" value="<?=$data[4]; ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> >
								</td>
								<td width="70">
									<input type="text" id="cons_<?=$i;?>" onChange="copy_value(this.value,'cons_',<?=$i;?>)" name="cons_<?=$i;?>" class="text_boxes_numeric" style="width:58px" <? if(($hid_fab_cons_in_quotation_variable==2 || $hid_fab_cons_in_quotation_variable==3) && ($body_part_id==1 || $body_part_id==20)){ echo "readonly";} else{ echo "";} ?> value="<? if ($data[5]==""){echo $price_quatation_cons[$row[csf('size_number_id')]];} else {echo $data[5];} ?>" <? if($cons_up==1) { echo "disabled ";} else{ echo "";} if($disabled==1){ echo "disabled";} else{ echo "";}  ?> />
								</td>
								<td width="60">
									<input type="text" id="processloss_<?=$i;?>" name="processloss_<?=$i;?>" class="text_boxes_numeric" style="width:48px" onChange="copy_value(this.value,'processloss_',<?=$i;?>) " value="<? if ($data[6]==""){echo $price_quatation_cons_process_loss[$row[csf('size_number_id')]];} else{echo $data[6];} ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> />
								</td>
								<td width="70">
									<input type="text" id="requirement_<?=$i;?>" name="requirement_<?=$i;?>" class="text_boxes_numeric" style="width:58px" value="<? if ($data[7]==""){ echo number_format($price_quatation_requirment[$row[csf('size_number_id')]], 6,'.','') ;} else { echo number_format($data[7], 6,'.','') ; } ?>" readonly />
								</td>
								<td width="60">
									<input type="text" id="rate_<?=$i;?>" name="rate_<?=$i;?>" onChange="copy_value(this.value,'rate_',<?=$i;?>);" class="text_boxes_numeric" style="width:48px" value="<? if($data[10]==""){echo $price_quatation_rate[$row[csf('size_number_id')]];}else { echo $data[10];}  ?>" <? if($cons_up==1) { echo "disabled";} else{ echo "";} ?> />
								</td>
								<td width="80">
									<input type="text" id="amount_<?=$i;?>" name="amount_<?=$i;?>"   class="text_boxes_numeric" style="width:68px"  value="<? if($data[11]==""){echo $price_quatation_amount[$row[csf('size_number_id')]];}else { echo $data[11];} ?>" readonly />
								</td>
								<td width="50">
									<input type="text" id="pcs_<?=$i;?>" name="pcs_<?=$i;?>" class="text_boxes_numeric" style="width:38px" value="<?=$pcs_value; ?>" readonly>
									<input type="hidden" id="pcsgmts_<?=$i;?>" name="pcsgmts_<?=$i;?>" class="text_boxes_numeric" style="width:35px" value="<?=$planPoQty; ?>">
								</td>
								<td width="80">
									<input type="text" id="totqty_<?=$i;?>" name="totqty_<?=$i;?>" class="text_boxes_numeric" style="width:68px" value="<?=$RowtotReq; ?>" readonly  />
								</td>
								<td width="80">
									<input type="text" id="totamount_<?=$i;?>" name="totamount_<?=$i;?>" class="text_boxes_numeric" style="width:68px" value="<?=$RowtotAmt; ?>" readonly />
								</td>
								<td>
									<input type="text" id="remarks_<?=$i;?>" name="remarks_<?=$i;?>" onChange="copy_value(this.value,'remarks_',<?=$i;?>);" class="text_boxes" style="width:102px" value="<?=$data[12]; ?>" >
                                    <input type="hidden" id="colorsizetableid_<?=$i;?>" name="colorsizetableid_<?=$i;?>" class="text_boxes" style="width:30px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
									<input type="hidden" id="decreaserow_<?=$i;?>" style="width:30px; display:none" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<?=$i;?>,'tbl_consmption_cost');" disabled/>
									<input type="hidden" id="approved_<?=$i;?>" name="approved_<?=$i;?>" class="text_boxes_numeric" style="width:30px"  value="<?=$disabled; ?>">
								</td>
							</tr>
							<?
                            $tot_RowtotReq+=$RowtotReq;
						}
					}
					?>

            	</table>
            </div>
            <table width="1140" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
						<th width="30"><input type="hidden" id="txttotrow" name="txttotrow" style="width:28px" value="<?=$i; ?>" readonly></th>
                        <th width="120">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="60">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th width="60">SUM:</th>
                        <th width="70"><input type="text" id="cons_sum" name="cons_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                        <th width="60"><input type="text" id="processloss_sum" name="processloss_sum" class="text_boxes_numeric" style="width:48px" readonly></th>
                        <th width="70"><input type="text" id="requirement_sum" name="requirement_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                        <th width="60"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:48px" readonly></th>
                        <th width="80"><input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                        <th width="50">
                            <input type="text" id="pcs_sum"    name="pcs_sum" class="text_boxes_numeric" style="width:38px" readonly>
                            <input type="hidden" id="plancutqty_sum"    name="plancutqty_sum" class="text_boxes_numeric" style="width:10px" readonly>
                        </th>
                        <th width="80"><input type="text" id="totReq_sum" name="totReq_sum" class="text_boxes_numeric" style="width:68px" value="<?=$tot_RowtotReq;?>" readonly></th>
                        <th width="80"><input type="text" id="totAmount_sum" name="totAmount_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
						<th width="30">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="60">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th width="60">AVG:</th>
                        <th width="70"  title="Fin cons*Plan cut percent(Size wise Qty/Tot plan cut qty)/100"><input type="text" id="avg_cons" name="avg_cons" class="text_boxes_numeric" style="width:58px" value="<? //=$calculated_conss;?>" readonly></th>
                        <th width="60"><input type="text" id="calculated_procloss"  name="calculated_procloss" class="text_boxes_numeric" style="width:48px" readonly></th>
                        <th width="70" title="Cons*Plan cut percent(Size wise Qty/Tot plan cut qty)/100"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:58px" value="<?=$calculated_conss;?>" readonly></th>
                        <th width="60"><input type="text" id="calculated_rate"   name="calculated_rate" class="text_boxes_numeric" style="width:48px" readonly></th>
                        <th width="80"><input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:68px" readonly></th>
                        <th width="50">
                            <input type="text" id="calculated_pcs"    name="calculated_pcs" class="text_boxes_numeric" style="width:38px" readonly>
                            <input type="hidden" id="calculated_plancutqty"    name="calculated_plancutqty" class="text_boxes_numeric" style="width:30px" readonly>
                        </th>
                        <th width="80"><input type="text" id="AtotReq_sum" name="AtotReq_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                        <th width="80"><input type="text" id="AtotAmount_sum" name="AtotAmount_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
			<script>

				$(document).ready(function(e) {
					var tableFilters =
					{
						col_4: "none",col_5: "none",col_6: "none",col_7: "none",col_8: "none",col_9: "none",col_10: "none",col_11: "none",col_12: "none",col_13: "none",col_14: "none",col_15: "none",
							col_operation: {
						}
					}
					setFilterGrid('tbl_consmption_cost',-1,tableFilters);
					claculate_avg();
				});
				set_sum_value( 'cons_sum', 'cons_');
				set_sum_value( 'processloss_sum', 'processloss_');
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'pcs_sum', 'pcs_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
				//set_sum_value( 'totReq_sum', 'totqty_');
				set_sum_value( 'totAmount_sum', 'totamount_');
            </script>
            </form>
        </fieldset>
   	</div>
	<?
    if ($hid_fab_cons_in_quotation_variable==2)
    {
        if ($body_part_id==1)
        {
			?>
			<div align="center" style="width:100%;" >
			<fieldset>
                <form id="fabriccost_3" autocomplete="off">
                    <table width="810" cellspacing="0" class="rpt_table" border="0" id="tbl_msmnt_cost" rules="all">
                        <thead>
                            <tr>
                                <th colspan="3">Body</th><th colspan="3">Sleeve</th><th colspan="2">1/2 Chest</th><th>Total</th>
                            </tr>
                            <tr>
                                <th width="80">Length</th><th width="80">Sewing Margin</th><th width="80">Hem Margin</th><th width="80"> Length</th><th width="80">Sewing Margin</th><th width="80">Hem Margin</th><th width="80">Length</th><th width="80">Sewing Margin</th><th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                        <?
                        $data_array_msn=explode('__',$msmnt_breack_downn);
                        if($cbo_approved_status!=1) $cbo_approved_status=$component_approved;

						//Oracle
						$data_array=sql_select("select b.id, b.po_number, b.po_quantity, b.shipment_date, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number, b.po_quantity, b.shipment_date, c.color_number_id, c.size_number_id order by b.id");

                        if (count($data_array)>0)
                        {
                            $i=0;
                            foreach( $data_array as $row )
                            {
                                $data=explode('_',$data_array_msn[$i]);
                                $i++;
                                ?>
                                    <tr id="break_<? echo $i;?>" align="center">
                                        <td>
                                        <input type="text" id="bodylength_<? echo $i;?>"  name="bodylength_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'bodylength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[0]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="bodysewingmargin_<? echo $i;?>"    name="bodysewingmargin_<? echo $i;?>"  class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'bodysewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[1]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                        </td>
                                        <td>
                                        <input type="text" id="bodyhemmargin_<? echo $i;?>" name="bodyhemmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'bodyhemmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value=" <? echo $data[2]; ?> "  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                        </td>
                                        <td>
                                        <input type="text" id="sleevelength_<? echo $i;?>"  name="sleevelength_<? echo $i;?>" class="text_boxes_numeric" style="width:65px"  onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'sleevelength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[3]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                        </td>
                                        <td>
                                        <input type="text" id="sleevesewingmargin_<? echo $i;?>"  name="sleevesewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'sleevesewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[4]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="sleevehemmargin_<? echo $i;?>"  name="sleevehemmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'sleevehemmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[5]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="chestlenght_<? echo $i;?>"  name="chestlenght_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'chestlenght_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[6]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="chestsewingmargin_<? echo $i;?>"  name="chestsewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'chestsewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[7]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td><input type="text" id="totalcons_<? echo $i;?>"  name="totalcons_<? echo $i;?>" class="text_boxes_numeric" style="width:150px" readonly value="<? echo $data[8]; ?>" /></td>
                                    </tr>
                                <?
                            }
                        }
                        ?>
                    	</tbody>
                    </table>
                </form>
            </fieldset>
           </div>
        	<?
        }
        if($body_part_id==20)
        {
        	?>
            <div align="center" style="width:100%;" >
    		<fieldset>
                <form id="fabriccost_3" autocomplete="off">
                    <table width="810" cellspacing="0" class="rpt_table" border="0" id="tbl_msmnt_cost" rules="all">
                        <thead>
                            <tr>
                                <th  colspan="2">Front Rise</th><th colspan="2">West Band</th><th colspan="3">In Seam</th><th colspan="2"> Half Thai</th><th >Total</th>
                            </tr>
                            <tr>
                                <th width="70">Length</th><th  width="70">Sewing Margin</th><th  width="70">Length</th><th width="70"> Sewing Margin</th><th width="70">Length</th><th width="70">Sewing Margin</th><th width="70">Hem Margin</th><th width="70">Length</th> <th width="70">Sewing Margin</th><th width="">Total</th>

                            </tr>
                        </thead>
                        <tbody>
                        <?
                        if($cbo_approved_status!=1) $cbo_approved_status=$component_approved;
                        $data_array_msn=explode('__',$msmnt_breack_downn);
                    	//Oracle
                        $data_array=sql_select("select b.id, b.po_number,b.po_quantity,b.shipment_date,c.color_number_id,c.size_number_id,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id   and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem'   and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,b.po_quantity,b.shipment_date,c.color_number_id,c.size_number_id  order by b.id");
                        if (count($data_array)>0)
                        {
                            $i=0;
                            foreach( $data_array as $row )
                            {
                                $data=explode('_',$data_array_msn[$i]);
                                $i++;
                                ?>
                                    <tr id="break_<? echo $i;?>" align="center">
                                        <td>
                                        <input type="text" id="frontriselength_<? echo $i;?>"  name="frontriselength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'frontriselength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[0]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="frontrisesewingmargin_<? echo $i;?>"    name="frontrisesewingmargin_<? echo $i;?>"  class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'frontrisesewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[1]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="westbandlength_<? echo $i;?>" name="westbandlength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'westbandlength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[2]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="westbandsewingmargin_<? echo $i;?>"  name="westbandsewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px"  onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'westbandsewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[3]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/ >
                                        </td>
                                        <td>
                                        <input type="text" id="inseamlength_<? echo $i;?>"  name="inseamlength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'inseamlength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[4]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="inseamsewingmargin_<? echo $i;?>"  name="inseamsewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'inseamsewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[5]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                        </td>
                                        <td>
                                        <input type="text" id="inseamhemmargin_<? echo $i;?>"  name="inseamhemmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'inseamhemmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[6]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                        </td>
                                        <td>
                                        <input type="text" id="halfthailength_<? echo $i;?>"  name="halfthailength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'halfthailength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[7]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                        </td>
                                        <td>
                                        <input type="text" id="halfthaisewingmargin_<? echo $i;?>"  name="halfthaisewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px"   onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'halfthaisewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[8]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                        </td>
                                        <td><input type="text" id="totalcons_<? echo $i;?>"  name="totalcons_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" readonly value="<? echo $data[9]; ?>"></td>
                                    </tr>
                                <?
                            }
                        }
                        ?>
                    	</tbody>
                    </table>
                    </form>
                </fieldset>
           </div>
           <?
        }
    }
	?>
    <div align="center" style="width:100%;" >
        <table width="810" cellspacing="0" class="" border="0" rules="all">
             <tr>
                <td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value();"/> </td>
            </tr>
        </table>
    </div>
    </body>
    <script>release_freezing(); $('.form_caption').hide(); </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="open_color_list_view")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	?>
	<script>
	function js_set_value_color()
	{
		var rowCount = $('#tbl_color_details tr').length-1;
		var color_breck_down="";
		for(var i=1; i<=rowCount; i++)
		{
			var contrstcolor=$('#concolor_'+i).val();
			contrstcolor=contrstcolor.replaceAll('"','');
			var concolor = contrstcolor.toUpperCase();
			if(concolor=='') concolor=$('#gmtscolor_'+i).val();
			if(color_breck_down=="") color_breck_down=$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+concolor;
			else color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+concolor;
		}
		document.getElementById('color_breck_down').value=color_breck_down;
		parent.emailwindow.hide();
	}
	function color_select_popup(buyer_name,texbox_id)
	{
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', 'pre_cost_entry_controller_v2.php?action=color_popup&buyer_name='+buyer_name, 'Color Select Pop Up', 'width=250px,height=450px,center=1,resize=1,scrolling=0','../../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var color_name=this.contentDoc.getElementById("color_name");
			if (color_name.value!="")
			{
				$('#'+texbox_id).val(color_name.value);
			}
		}
	}
	</script>
	</head>
	<body>
    <div id="color_details"  align="center">
        <fieldset>
            <form id="contrastcolor_1" autocomplete="off">
                <input type="hidden" id="color_breck_down" />
                <input type="hidden" id="item_id" />
                <table width="350" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
                    <thead>
                        <tr>
                        	<th width="200">Gmts Color</th><th>Contrast Color</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    $arr_bo_app=array();
                    $sql_bo_app=sql_select("select a.is_approved,b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and a.booking_no=b.booking_no and  a.job_no='$txt_job_no' and a.booking_type=1 and a.is_short=2 and a.is_approved=1  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by b.pre_cost_fabric_cost_dtls_id,a.is_approved");
                    foreach($sql_bo_app as $row_bo_app)
                    {
                    	$is_approved=$row_bo_app[csf('is_approved')];
						if($is_approved==3) $is_approved=1; else $is_approved=$is_approved;
                    	$arr_bo_app[$row_bo_app[csf('pre_cost_fabric_cost_dtls_id')]]	=$is_approved;
                    }

					$contrat_cond="";



                    if($precostapproved==1 || $arr_bo_app[$pre_cost_fabric_cost_dtls_id]) $disabled=1; else $disabled=0;


                    $color_from_library=return_field_value("color_from_library", "variable_order_tracking", "company_name=$cbo_company_id  and variable_list=23  and status_active=1 and is_deleted=0");
                    if($color_from_library==1)
                    {
                    	$readonly="readonly='readonly'"; $plachoder="placeholder='Click'"; $onClick="onClick='color_select_popup($cbo_buyer_name,this.id)'";
                    }
                    else
                    {
                    	$readonly=""; $plachoder=""; $onClick="";
                    }
					$color_breck_down=str_replace("'","",$color_breck_down);
                    $data_array_color=explode("__",$color_breck_down);
					//echo $precostapproved.'='.$arr_bo_app[$pre_cost_fabric_cost_dtls_id].'='.$disabled.'='.$contrat_cond.',';
                    $sql_bo_app2=sql_select("select b.gmts_color_id,b.pre_cost_fabric_cost_dtls_id,a.booking_no from wo_booking_mst a, wo_booking_dtls b where  a.id=b.booking_mst_id  and b.job_no='$txt_job_no' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and a.entry_form in (108, 88) and b.pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id ");
					foreach( $sql_bo_app2 as $row ) //7358 AS per Saeed
					{
						$gmts_colorChkArr[$row[csf('gmts_color_id')]]=$row[csf('gmts_color_id')];
					}

                    //Oracle
                    $data_array=sql_select("select a.color_number_id from  wo_po_color_size_breakdown a, wo_po_break_down b where a.job_no_mst=b.job_no_mst and a.po_break_down_id=b.id and a.job_no_mst='$txt_job_no' and a.item_number_id='$cbogmtsitem' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.color_number_id, a.color_order order by a.color_order ASC");

                    if ( count($data_array)>0)
                    {
						$i=0;
						foreach( $data_array as $row )
						{
							$data=explode('_',$data_array_color[$i]);
							// print_r($data);
							//$po_id=$row[csf('po_id')];
							//$color_number_id=$row[csf('color_number_id')];
							$gmts_color_found=$gmts_colorChkArr[$row[csf('color_number_id')]];

							//$sql_bo_app2=sql_select("select b.pre_cost_fabric_cost_dtls_id,a.booking_no from wo_booking_mst a, wo_booking_dtls b where  a.id=b.booking_mst_id  and b.job_no='$txt_job_no' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and a.entry_form in (118, 108, 88) and b.pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id and b.po_break_down_id=$color_number_id and b.gmts_color_id= group by b.pre_cost_fabric_cost_dtls_id,a.booking_no");

							/*if(count($sql_bo_app2)>0){
								$contrat_cond="readonly";
							}*/
							$contrat_cond="";
							if($gmts_color_found>0)
							{
							$contrat_cond="readonly";
							}

							//print_r($data);
							$i++;
							?>
							<tr id="color_<? echo $i;?>" align="center">
                                <td>
                                    <input type="hidden" id="gmtscolorid_<? echo $i;?>" name="gmtscolorid_<? echo $i;?>" style="width:50px" class="text_boxes" value="<? echo $row[csf('color_number_id')]; ?>" readonly/>
                                    <input type="text" id="gmtscolor_<? echo $i;?>" name="gmtscolor_<? echo $i;?>" style="width:150px" class="text_boxes" value="<? echo $color_library[$row[csf('color_number_id')]]; ?>" readonly/>
                                </td>
                                <td>
                                 <input type="text" id="concolor_<? echo $i;?>" name="concolor_<? echo $i;?>" style="width:130px" class="text_boxes" value="<? echo $data[2]; ?>" <? echo $readonly." ".$onClick." ".$plachoder?>  <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> <?=$contrat_cond;?>/>
                                </td>
							</tr>
							<?
						}
                    }
                    ?>
                    </tbody>
                </table>
                <table width="350" cellspacing="0" class="" border="0">
                    <tr>
                    	<td align="center" height="15" width="100%"></td>
                    </tr>
                    <tr>
                        <td align="center" width="100%" class="button_container">
                        	<input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
    </div>
	 </body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="color_popup")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
	function js_set_value(data)
	{
		document.getElementById('color_name').value=data;
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
        <div align="center">
        <form>
        	<table cellspacing="0" width="210" cellpadding="0" border="1" rules="all" class="rpt_table" align="center">
                <thead>
                    <tr>
                        <th align="center"><?=create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
                    </tr>
                </thead>
            </table>
            <input type="hidden" id="color_name" name="color_name" />
            <?
            if($buyer_name=="" || $buyer_name==0)
            {
            	$sql="select color_name,id FROM lib_color where status_active=1 and is_deleted=0";
            }
            else
            {
            	$sql="select a.color_name, a.id FROM lib_color a, lib_color_tag_buyer c where a.id=c.color_id and c.buyer_id=$buyer_name and a.status_active=1 and a.is_deleted=0";
            }
            echo  create_list_view("list_view", "Color Name", "160","210","420",0, $sql , "js_set_value", "color_name", "", 1, "0", $arr , "color_name", "requires/sample_booking_non_order_controller",'setFilterGrid("list_view",-1);','0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2') ;
            ?>
        </form>
        </div>
	</body>
	</html>
	<?
	exit();
}

if($action=="get_yarn_rate")
{
	$data=explode("_",$data);
	if($db_type==0)
	{
		$effective_date=change_date_format($data[5],'yyyy-mm-dd','-');
		$sql="select  rate from lib_yarn_rate where supplier_id=$data[4] and yarn_count=$data[0] and composition=$data[1] and  percent=$data[2] and yarn_type=$data[3] and effective_date='$effective_date' and status_active=1 and is_deleted=0  order by id desc limit 1";

	}
	if($db_type==2)
	{
		$effective_date=change_date_format($data[5],'yyyy-mm-dd','-',1);
		 $sql="select  rate from lib_yarn_rate where supplier_id=$data[4] and yarn_count=$data[0] and composition=$data[1] and  percent=$data[2] and yarn_type=$data[3] and effective_date='$effective_date' and status_active=1 and is_deleted=0 and rownum <=1 order by id desc";

	}
	$sql_data=sql_select($sql);
	//print_r($sql_data);
    echo trim($sql_data[0][csf('rate')]);
	exit();
}

if($action=="conversion_chart_popup")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
	function js_set_value(id,rate)
	{
		document.getElementById('charge_id').value=id;
		document.getElementById('charge_value').value=rate;
		parent.emailwindow.hide();
	}
	function toggle( x, origColor )
	{
		var newColor = 'yellow';
		document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
	}
	</script>
	</head>
	<body>
        <div align="center">
        <form>
        <input type="hidden" id="charge_id" name="charge_id" />
        <input type="hidden" id="charge_value" name="charge_value" />
        <?
        if($cbotypeconversion==1)
        {
             $company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
             $arr=array (0=>$company_arr,1=>$body_part,5=>$unit_of_measurement,7=>$row_status);
             ?>
             <table width="1363" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
                 <thead>
                     <th width="50">SL</th>
                     <th width="150">Company Name</th>
                     <th width="120">Body Part</th>
                     <th width="100">Fabric Genetic</th>
					 <th width="120">Construction</th>
					 <th width="120">Composition</th>
					 <th width="100">Spandex Category</th>
					 <th width="100">Dyeing Type</th>
                     <th width="60">GSM</th>
                     <th width="150">Yarn Description</th>
                     <th width="70">UOM</th>
                     <th width="100">In-House Rate</th>
                     <th>Status</th>
                 </thead>
             </table>
             <div style=" width:1380; overflow:scroll-y; max-height:300px">
                 <table width="1363" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
                 <?
				 
                 if($israte_popup==2) $comp_cond=" and comapny_id=$cbo_company_name"; else $comp_cond="";
                 $sql_data=sql_select("select id,comapny_id,body_part,const_comp,spandex_category,dyeing_type,fabric_genetic,composition,gsm,yarn_description,dia_range, gsm_range, efficiency_range,in_house_rate,uom_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id=2 $comp_cond");
                 $i=1;
                 foreach($sql_data as $row)
                 {
                     if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					 ?>
					 <tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")];  ?>">
                         <td width="50"><? echo $i; ?></td>
                         <td width="150"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
                         <td width="120"><? echo $body_part[$row[csf("body_part")]]; ?></td>
						 <td width="100"><? echo $fabric_genetic_nameArr[$row[csf("fabric_genetic")]]; ?></td>
                         <td width="120"><? echo $row[csf("const_comp")]; ?></td>
						 <td width="120"><? echo $row[csf("composition")]; ?></td>
						 <td width="100"><? echo $row[csf("spandex_category")]; ?></td>
						 <td width="100"><? echo $row[csf("dyeing_type")]; ?></td>
                         <td width="60"><? echo $row[csf("gsm")]; ?></td>
                         <td width="150"><? echo $row[csf("yarn_description")]; ?></td>
                         <td width="70"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
                         <td width="100"><? echo $row[csf("in_house_rate")]; ?></td>
                         <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
					 </tr>
					 <?
					 $i++;
                 }
                 ?>
                 <script>
					 setFilterGrid("list_view",-1)
					 toggle( "tr_"+"<? echo $coversionchargelibraryid ?>", '#FFFFCC');
                 </script>
                 </table>
             </div>
             <?
        }
        else
        {
            $company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
            $color_library_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
            $arr=array (0=>$company_arr,2=>$process_type,3=>$conversion_cost_head_array,4=>$color_library_arr,5=>$fabric_typee,7=>$unit_of_measurement,8=>$production_process,9=>$row_status);
            ?>
            <table width="1070" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
                <thead>
                    <th width="50">SL</th>
                    <th width="100">Company Name</th>
					<th width="120">Const. Compo.</th>
                    <th width="70">Process Type</th>
                    <th width="70">Process Name</th>
                    <th width="70">Color</th>
                    <th width="80">Width/Dia type</th>
					<th width="80">Dia Range</th>
					<th width="80">GSM Range</th>
					<th width="80">Efficiency Range</th>
                    <th width="60">In House Rate</th>
                    <th width="80">UOM</th>
                    <th width="60">Rate type</th>
                    <th>Status</th>
                </thead>
            </table>
            <div style=" width:1097; overflow:scroll-y; max-height:300px">
                <table width="1070" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
                <?
                if($israte_popup==2) $comp_cond=" and comapny_id=$cbo_company_name"; else $comp_cond="";
                $sql_data=sql_select("select id,comapny_id,const_comp,spandex_category,dyeing_type,fabric_genetic,composition,process_type_id,process_id,color_id,width_dia_id,dia_range, gsm_range, efficiency_range,in_house_rate,uom_id,rate_type_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id in (3,4,7,8) and process_id=$cbotypeconversion $comp_cond");
                $i=1;
                foreach($sql_data as $row)
                {
					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")];  ?>">
                        <td width="50"><? echo $i; ?></td>
                        <td style="word-break:break-all" width="100"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
                        <td style="word-break:break-all" width="120"><? echo $row[csf("const_comp")]; ?></td>
                        <td style="word-break:break-all" width="70"><? echo $process_type[$row[csf("process_type_id")]]; ?></td>
                        <td style="word-break:break-all" width="70"><? echo $conversion_cost_head_array[$row[csf("process_id")]]; ?></td>
                        <td style="word-break:break-all" width="70"><? echo $color_library_arr[$row[csf("color_id")]]; ?></td>
                        <td style="word-break:break-all" width="80"><? echo $fabric_typee[$row[csf("width_dia_id")]]; ?></td>
						<td style="word-break:break-all" width="80"><? echo $row[csf("dia_range")]; ?></td>
						 <td style="word-break:break-all" width="80"><? echo $row[csf("gsm_range")]; ?></td>
						 <td style="word-break:break-all" width="80"><? echo $row[csf("efficiency_range")]; ?></td>
                        <td style="word-break:break-all" width="60"><? echo $row[csf("in_house_rate")]; ?></td>
                        <td style="word-break:break-all" width="80"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
                        <td style="word-break:break-all" width="60"><? echo $production_process[$row[csf("rate_type_id")]]; ?></td>
                        <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
					</tr>
					<?
					$i++;
                }
                ?>
                <script>
					setFilterGrid("list_view",-1)
					toggle( "tr_"+"<? echo $coversionchargelibraryid ?>", '#FFFFCC');
                </script>
                </table>
            </div>
            <?
        }
        ?>
        </form>
        </div>
	</body>
	</html>
	<?
	exit();
}

if ($action=="set_conversion_charge")
{
	//extract($_REQUEST);
	$rate=return_field_value("rate", "lib_cost_component", "cost_component_name=$data");
	echo $rate; die;
}

if ($action=="set_conversion_qnty")
{
	$data=explode("_",$data);
	$fabdataarr=sql_select("select a.set_item_ratio,b.lib_yarn_count_deter_id, seq from wo_pre_cost_fabric_cost_dtls b, wo_po_details_mas_set_details a where a.job_id=b.job_id  and a.gmts_item_id=b.item_number_id and b.id=$data[0] and b.status_active=1 and b.is_deleted=0");

	$lib_yarn_count_deter_id= $fabdataarr[0][csf('lib_yarn_count_deter_id')];
	$GmtsitemRatio= $fabdataarr[0][csf('set_item_ratio')];
	$fabseq= $fabdataarr[0][csf('seq')];
	$processloss=return_field_value("process_loss", "conversion_process_loss", "mst_id=$lib_yarn_count_deter_id and process_id=$data[1]");
	$processloss_from_library=1;
	if(!$processloss){
		$processloss=$data[2];
		$processloss_from_library=0;
	}
	if($data[3]) $processloss=$data[2];// update mode
	$plan_cut_qnty=$order_qnty=0;
	if($data[1]==30){

		$plan_cut_qntyarray=array();
		$sql_data=sql_select("select d.costing_per,a.job_no, c.color_number_id, c.plan_cut_qnty, c.order_quantity, d.color_size_sensitive, d.color_type_id, d.item_number_id, f.contrast_color_id AS fabric_color from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$data[0]' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0");//and e.cons !=0
		$color_size_sensitive=0; $color_type_id=0;
		foreach($sql_data as $row){
			$plan_cut_qnty+=$row[csf('plan_cut_qnty')];
			$order_qnty+=$row[csf('order_quantity')];
			//$plan_cut_qntyarray[$row[csf('color_number_id')]]+=$row[csf('plan_cut_qnty')];
			//$GmtsitemRatio=$GmtsitemRatioArr[$row[csf('job_no')]][$row[csf('item_number_id')]];
			$color_size_sensitive=$row[csf('color_size_sensitive')];
			$color_type_id=$row[csf('color_type_id')];
			$costingPer=$row[csf('costing_per')];
		}

		$costingPerQty=12;
		if($costingPer==1) $costingPerQty=12;
		else if($costingPer==2) $costingPerQty=1;
		else if($costingPer==3) $costingPerQty=24;
		else if($costingPer==4) $costingPerQty=36;
		else if($costingPer==5) $costingPerQty=48;
		else $costingPerQty=12;

		$sql=sql_select("select sum(fabreq) as fabreq, sum(fabreqtotkg) as fabreqtotkg from wo_pre_stripe_color where pre_cost_fabric_cost_dtls_id=$data[0] and yarn_dyed=1 and job_id>0 and status_active=1");
		$avg_cons= $sql[0][csf('fabreq')];
		$totalreqqty= $sql[0][csf('fabreqtotkg')];
		//$avg_cons=$avg_cons-($avg_cons*$processloss)/100;//comments by kausar
		//$avg_cons=$avg_cons;//-($avg_cons*$processloss)/100;//Aziz for NZ
		//echo $totalreqqty.'='.$plan_cut_qnty.'='.$costing_per.'='.$GmtsitemRatio.', ';
		$avg_cons=($totalreqqty/$plan_cut_qnty)*$costingPerQty*$GmtsitemRatio;//-($avg_cons*$processloss)/100;
		$avg_cons_yarn=$avg_cons-($avg_cons*$processloss)/100;
	}
	else{
		$avg_cons=return_field_value("avg_cons", "wo_pre_cost_fabric_cost_dtls", "id=$data[0] and status_active=1 and is_deleted=0");
		//$avg_cons=$avg_cons-($avg_cons*$processloss)/100; //comments by kausar
		$avg_cons=$avg_cons;
		$avg_cons_yarn=$avg_cons;
	    $avg_cons_yarn=$avg_cons_yarn-($avg_cons_yarn*$processloss)/100;
		if($avg_cons_yarn==''){
			$avg_cons_yarn=$avg_cons;
		}
	}
	echo trim($avg_cons)."_".trim($avg_cons_yarn)."_".trim($processloss)."_".trim($processloss_from_library)."_".$fabseq."_".$order_qnty."_".$plan_cut_qnty;
	die;
}

if($action=="conversion_color_popup")
{
	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
    var costype=<? echo $cbotypeconversion ?>;
	//alert(costype);
    var israte_popup=2;
	function copy_charge(value,i){
		var checkbox = document.getElementById("copy_rate");
		var fabric_color=document.getElementById('fabriccolorid_'+i).value;
		var rowCount = $('#color_rate_list tr').length;
		if (checkbox.checked == true){
			for(var j=i; j<=rowCount; j++)
			{
				if( fabric_color==document.getElementById('fabriccolorid_'+j).value) document.getElementById('unitcharge_'+j).value=value;
			}
			claculate_avg();
		}
	}

    function set_conversion_charge_unit(i,conversion_from_chart)
	{
		//alert(israte_popup+'='+conversion_from_chart+'='+costype);
		if(israte_popup==2)
		{
			if(conversion_from_chart==1)
			{
				document.getElementById('unitcharge_'+i).readOnly=true
				set_conversion_charge_unit_pop_up(i);
			}
			else
			{
				document.getElementById('unitcharge_'+i).readOnly=false
			}
		}
		else
		{
			if(costype==31)
			{
				if(conversion_from_chart==1)
				{
					document.getElementById('unitcharge_'+i).readOnly=true
					set_conversion_charge_unit_pop_up(i);
				}
				else
				{
					document.getElementById('unitcharge_'+i).readOnly=false
				}
			}
		}
    }

    function set_conversion_charge_unit_pop_up(i)
	{
		var cbo_company_name=document.getElementById('cbo_company_name').value;
		var cbotypeconversion=document.getElementById('cbotypeconversion').value
		//alert(cbotypeconversion);
		var txt_exchange_rate=document.getElementById('txt_exchange_rate').value
		var coversionchargelibraryid=document.getElementById('coversionchargelibraryid_'+i).value
		if(cbo_company_name==0){
			alert("Select Company");
			return;
		}
		if(cbotypeconversion==0){
			alert("Select Process");
			return;
		}
		if(txt_exchange_rate==0 || txt_exchange_rate==""){
			alert("Select Exchange Rate");
			return;
		}
		else{
			//alert(cbotypeconversion);
			var page_link='pre_cost_entry_controller_v2.php?action=conversion_chart_popup&cbo_company_name='+cbo_company_name+'&cbotypeconversion='+cbotypeconversion+'&coversionchargelibraryid='+coversionchargelibraryid;
			emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1460px,height=450px,center=1,resize=1,scrolling=0','../')
			emailwindow.onclose=function()
			{
				var charge_id=this.contentDoc.getElementById("charge_id");
				var charge_value=this.contentDoc.getElementById("charge_value");
				document.getElementById('coversionchargelibraryid_'+i).value=charge_id.value;
				document.getElementById('unitcharge_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
				calculate_amount(i);
				claculate_avg();
			}
		}
    }

    function js_set_value_color()
	{
		var rowCount = $('#tbl_color_details tr').length-3;
		var color_breck_down=""; var coversionchargelibraryid_baeck_down="";
		for(var i=1; i<=rowCount; i++)
		{
			var unitcharge = $('#unitcharge_'+i).val();
			if(trim(unitcharge) =='') unitcharge=0;
			var coversionchargelibraryid= $('#coversionchargelibraryid_'+i).val();
			if(coversionchargelibraryid=='') coversionchargelibraryid=0;

			if(color_breck_down==""){
				color_breck_down=$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
			}
			else{
				color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
			}

			if(coversionchargelibraryid_baeck_down=="") coversionchargelibraryid_baeck_down=$('#coversionchargelibraryid_'+i).val()
			else coversionchargelibraryid_baeck_down+="_"+$('#coversionchargelibraryid_'+i).val();
		}
		document.getElementById('color_breck_down').value=color_breck_down;
		document.getElementById('chargelibid_breck_down').value=coversionchargelibraryid_baeck_down;
		parent.emailwindow.hide();
    }

    function claculate_avg()
	{
		var totalunitcharge=0; var total_value=0; var total_amount=0; var totalreqqty=0;
		var rowCount = $('#tbl_color_details tr').length-3;
		for(var i=1; i<=rowCount; i++)
		{
			if(document.getElementById('unitcharge_'+i).value =='' || document.getElementById('unitcharge_'+i).value ==0){
			continue;
			}
			else{
				//significant_row=significant_row+1;
				var reqqty =document.getElementById('reqqty_'+i).value*1;
				//alert(reqqty);
				totalreqqty+=reqqty;
				var unitcharge=document.getElementById('unitcharge_'+i).value*1;
				totalunitcharge+=unitcharge;
				var value=unitcharge*reqqty;
				total_value+=value;
				var cons =document.getElementById('cons_'+i).value*1;
				var amount=unitcharge*cons;
				total_amount+=amount;
			}
		}
		var orderQty=document.getElementById('orderQty').value*1
		var itemRatio=document.getElementById('itemRatio').value*1
		var avg_total_value=total_value/totalreqqty;
	//	alert(totalreqqty+'='+orderQty+'='+costPer+'='+itemRatio);
		var avg_total_cons=(totalreqqty/orderQty)*costPer*itemRatio
		var avg_total_amount=(total_value/orderQty)*costPer*itemRatio
		document.getElementById('total_value').value=totalunitcharge
		document.getElementById('total_amount').value=total_amount
		document.getElementById('avg_total_value').value=number_format_common(avg_total_value, 5, 0);
		document.getElementById('avg_total_cons').value=number_format_common(avg_total_cons, 5, 0);
		document.getElementById('avg_total_amount').value=number_format_common(avg_total_amount, 5, 0);
    }

    function calculate_amount(i)
	{
		var cons=document.getElementById('cons_'+i).value*1
		var unitcharge=document.getElementById('unitcharge_'+i).value*1
		var amount= cons*unitcharge;
		document.getElementById('amount_'+i).value=number_format_common(amount, 5, 0);
    }
    </script>
    </head>
    <body>
    <?
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$condition= new condition();
	if(str_replace("'","",$job_no) !=''){
		$condition->job_no("='$job_no'");
	}
	$condition->init();
	$GmtsitemRatioArr=$condition->getGmtsitemRatioArr();
	$CostingPerArr=$condition->getCostingPerArr();
	$CostPerQty= $CostingPerArr[str_replace("'","",$job_no)];

	$fabric= new fabric($condition);
	$fabric_costing_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();

	//print_r($fabric_costing_arr);
	$data_array_update=array();
    $data_array=explode("__",$colorbreakdown);
	if($data_array[0]=="") $data_array=array();

	if ( count($data_array)>0)
	{
		$i=0; $total_value=0;
		foreach( $data_array as $row )
		{
			$i++;
			$data=explode('_',$row);
			$data_array_update[$data[0]][$data[3]][unitcharge]=$data[1];
			$data_array_update[$data[0]][$data[3]][coversionchargelibraryid]=$data[2];
		}
	}
	/*echo '<pre>';
	print_r($data_array_update);*/
	//echo $conversion_from_chart.'DDDDDDDD';
	if($cbotypeconversion==31 || $cbotypeconversion==1) { if($conversion_from_chart==1) $charge_readonly="readonly"; else $charge_readonly=""; } else $charge_readonly="";

	if($cbocosthead!=0)
	{
		$GmtsitemRatio=0;
		$plan_cut_qntyarray=array();
		$sql_data=sql_select("select a.job_no, c.color_number_id, c.plan_cut_qnty, d.color_size_sensitive, d.color_type_id, d.item_number_id, f.contrast_color_id AS fabric_color from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0");//and e.cons !=0
		$color_size_sensitive=0; $color_type_id=0;
		foreach($sql_data as $row){
			$plan_cut_qnty+=$row[csf('plan_cut_qnty')];
			$plan_cut_qntyarray[$row[csf('color_number_id')]]+=$row[csf('plan_cut_qnty')];
			$GmtsitemRatio=$GmtsitemRatioArr[$row[csf('job_no')]][$row[csf('item_number_id')]];
			$color_size_sensitive=$row[csf('color_size_sensitive')];
			$color_type_id=$row[csf('color_type_id')];
		}

		$tdColor="Color";
		//$color_size_sensitive=return_field_value("color_size_sensitive", "wo_pre_cost_fabric_cost_dtls", "id=$cbocosthead");
		//$color_type_id=return_field_value("color_type_id", "wo_pre_cost_fabric_cost_dtls", "id=$cbocosthead");

		if($color_type_id !=2 && $color_type_id !=3 && $color_type_id !=4 && $color_type_id !=6 && $color_type_id !=31  && $color_type_id !=32 && $color_type_id !=33 && $color_type_id !=34 && $color_type_id !=47 && $color_type_id !=63 && $color_type_id !=71 && $color_type_id !=76)
		{
			$data_array=sql_select("select c.color_number_id, d.color_size_sensitive, f.contrast_color_id AS fabric_color from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1 and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by c.color_number_id, f.contrast_color_id, d.color_size_sensitive ");
			$tdColor="Gmts Color";
		}
		else if($cbotypeconversion==30 && ($color_type_id ==2 || $color_type_id ==3 || $color_type_id ==4 || $color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32 || $color_type_id ==33 || $color_type_id ==34 || $color_type_id ==47 || $color_type_id ==63 || $color_type_id ==71 || $color_type_id ==76))
		{
			$data_array=sql_select("select c.color_number_id, d.color_size_sensitive, f.id, f.stripe_color AS fabric_color, f.fabreq as fabreq, f.fabreqtotkg as req_qty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_stripe_color f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.color_number_id and  f.job_id>0 and f.yarn_dyed=1 and f.status_active=1 where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by c.color_number_id, d.color_size_sensitive, f.id, f.stripe_color, f.fabreq, f.fabreqtotkg order by c.color_number_id");//ISD-23-21773 f.id add
			$tdColor="Stripe Color";
			if(count($data_array) <=0)
			{
				$data_array=sql_select("select c.color_number_id, d.color_size_sensitive, f.contrast_color_id AS fabric_color from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1 and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by c.color_number_id, f.contrast_color_id, d.color_size_sensitive");
				$tdColor="Stripe Color";
			}
		}
		else{
			$data_array=sql_select("select c.color_number_id, d.color_size_sensitive, f.contrast_color_id AS fabric_color from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id where 1=1 and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");
			$tdColor="Gmts Color";
		}
		$rate=return_field_value("rate", "lib_cost_component", "cost_component_name=$cbocosthead");
		$conversion_qnty=$rate;
		?>
        <script>
		var costPer=<?=$CostPerQty; ?>
		</script>
        <form id="contrastcolor_1" autocomplete="off">
            <input type="hidden" id="color_breck_down" />
            <input type="hidden" id="chargelibid_breck_down" />
            <input type="hidden" id="cbo_company_name" value="<?=$cbo_company_name;?>" />
            <input type="hidden" id="cbotypeconversion" value="<?=$cbotypeconversion;?>" />
            <input type="hidden" id="txt_exchange_rate" value="<?=$txt_exchange_rate;?>" />
            <input type="hidden" id="cbo_currercy" value="<?=$cbo_currercy;?>" />
            <input type="hidden" id="orderQty" value="<?=$plan_cut_qnty;?>" />
            <input type="hidden" id="itemRatio" value="<?=$GmtsitemRatio;?>" />
            <table width="300" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
                <thead>
                    <tr>
                        <th width="30">SL</th>
                        <th width="120" title="<?=$tdColor; ?>">Gmts Color</th>
                        <th width="120" title="<?=$tdColor; ?>">Fabric Color</th>
                        <th width="60">Cons</th>
                        <th><input type="checkbox" id="copy_rate" name="copy_rate" value="Copy">&nbsp; Charge/Unit</th>
                        <!--<th>Amount</th>-->
                    </tr>
                </thead>
        	<tbody id="color_rate_list">
		<?
		$i=0; $avg_num=0; $totalCons=0; $total_value=0;
		//print_r($data_array);
		$colorCostingPerWiseReqQtyArr=array();
		foreach($data_array as $row)//ISD-23-21773
		{
			$colorreqqty=0;
			if($color_size_sensitive==1 && $color_type_id !=2 && $color_type_id !=3 && $color_type_id !=4 && $color_type_id !=6 && $color_type_id !=31 && $color_type_id !=32 && $color_type_id !=33 && $color_type_id !=34 && $color_type_id !=47 && $color_type_id !=63 && $color_type_id !=71 && $color_type_id !=76)
			{
				$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			}
			else if($color_size_sensitive==1 && $cbotypeconversion==30 && ($color_type_id ==2 || $color_type_id ==3 || $color_type_id ==4 || $color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32 || $color_type_id ==33 || $color_type_id ==34 || $color_type_id ==47 || $color_type_id ==63 || $color_type_id ==71 || $color_type_id ==76 ))
			{
				$colorreqqty=$row[csf('req_qty')];
				if($row[csf('req_qty')]==""){
					$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
				}
			}
			else if($color_size_sensitive==3) $colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			else $colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);

			//echo $cbocosthead."=".$row[csf('gmts_color_id')]."<br/>";
			$fab_colo=$row[csf('fabric_color')];
			if($row[csf('color_size_sensitive')]==1 && $cbotypeconversion !=30) $fab_colo=$row[csf('color_number_id')];

			if($cbotypeconversion !=30)
			{
				$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
				$DznGreyreq=(array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]])/$plan_cut_qntyarray[$row[csf('color_number_id')]])*$CostPerQty*$GmtsitemRatio;
			}
			if($cbotypeconversion ==30)
			{
				$colorreqqty=$row[csf('req_qty')]; $DznGreyreq=$row[csf('fabreq')];
			}

			$colorCostingPerWiseReqQtyArr[$row[csf('color_number_id')]][$fab_colo]['reqcons']+=$DznGreyreq;
			$colorCostingPerWiseReqQtyArr[$row[csf('color_number_id')]][$fab_colo]['colorreqcons']+=$colorreqqty;
		}
		unset($data_array);
		
		foreach($colorCostingPerWiseReqQtyArr as $gcolor=>$gcolordata)
		{
			foreach($gcolordata as $fcolor=>$fcolordata)
			{
				$i++;
				
				$unitcharge=0;
				if($data_array_update[$gcolor][$fcolor][unitcharge]==""){
					$unitcharge=$conversion_qnty;
				}
				else{
					$unitcharge=$data_array_update[$gcolor][$fcolor][unitcharge];
				}
				$total_value+=$unitcharge;
				if($unitcharge > 0) $avg_num+=1;
				$totalCons+=$fcolordata['reqcons'];
				?>
                <tr>
                    <td><?=$i; ?></td>
                    <td>
                        <input type="hidden" id="gmtscolorid_<?=$i; ?>" name="gmtscolorid_<?=$i; ?>" style="width:50px" value="<?=$gcolor; ?>" readonly/>
                        <input type="hidden" id="reqqty_<?=$i; ?>" name="reqqty_<?=$i; ?>" style="width:50px" value="<?=$fcolordata['colorreqcons']; ?>" readonly/>
                        <input type="text" id="gmtscolor_<?=$i; ?>" name="gmtscolor_<?=$i; ?>" style="width:120px" class="text_boxes" value="<?=$color_library[$gcolor]; ?>" readonly/>
                    </td>
                    <td>
                        <input type="hidden" id="fabriccolorid_<?=$i; ?>" name="fabriccolorid_<?=$i; ?>" style="width:50px" value="<?=$fcolor; ?>" readonly/>
                        <input type="text" id="fabriccolor_<?=$i;?>" name="fabriccolor_<?=$i;?>" style="width:120px" class="text_boxes" value="<?=$color_library[$fcolor]; ?>"   readonly/>
                    </td>
                    <td><input type="text" id="cons_<?=$i;?>" name="cons_<?=$i;?>" value="<?=fn_number_format($fcolordata['reqcons'],8,'.',''); ?>" style="width:150px" class="text_boxes_numeric" /></td>
                    <td>
                        <input type="text" id="unitcharge_<?=$i; ?>" name="unitcharge_<?=$i; ?>" value="<?=trim($unitcharge); ?>" onChange="claculate_avg(); calculate_amount(<?=$i; ?>); copy_charge(this.value,<?=$i; ?>);" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>)" style="width:150px" class="text_boxes_numeric" <?=$charge_readonly; ?>/>
                        <input type="hidden" id="coversionchargelibraryid_<?=$i;?>" name="coversionchargelibraryid_<?=$i;?>" value="<?=$data_array_update[$gcolor][$fab_colo][coversionchargelibraryid]; ?>" readonly/>
                        <input type="hidden" id="amount_<?=$i;?>" name="amount_<?=$i;?>" style="width:150px" class="text_boxes_numeric" readonly/>
                    </td>
                </tr>
            <?
			}
		}
		
		
		foreach( $data_array as $row )//ISD-23-21773 omit
		{
			die;
			$i++;
			$colorreqqty=0;
			if($color_size_sensitive==1 && $color_type_id !=2 && $color_type_id !=3 && $color_type_id !=4 && $color_type_id !=6 && $color_type_id !=31 && $color_type_id !=32 && $color_type_id !=33 && $color_type_id !=34 && $color_type_id !=47 && $color_type_id !=63 && $color_type_id !=71 && $color_type_id !=76)
			{
				$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			}
			else if($color_size_sensitive==1 && $cbotypeconversion==30 && ($color_type_id ==2 || $color_type_id ==3 || $color_type_id ==4 || $color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32 || $color_type_id ==33 || $color_type_id ==34 || $color_type_id ==47 || $color_type_id ==63 || $color_type_id ==71 || $color_type_id ==76 ))
			{
				$colorreqqty=$row[csf('req_qty')];
				if($row[csf('req_qty')]==""){
					$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
				}
			}
			else if($color_size_sensitive==3) $colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			else $colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);

			//echo $cbocosthead."=".$row[csf('gmts_color_id')]."<br/>";
			$fab_colo=$row[csf('fabric_color')];
			if($row[csf('color_size_sensitive')]==1 && $cbotypeconversion !=30) $fab_colo=$row[csf('color_number_id')];

			if($cbotypeconversion !=30)
			{
				$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
				$DznGreyreq=(array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]])/$plan_cut_qntyarray[$row[csf('color_number_id')]])*$CostPerQty*$GmtsitemRatio;
			}
			if($cbotypeconversion ==30)
			{
				$colorreqqty=$row[csf('req_qty')]; $DznGreyreq=$row[csf('fabreq')];
			}

			$unitcharge=0;
			if($data_array_update[$row[csf('color_number_id')]][$fab_colo][unitcharge]==""){
				$unitcharge=$conversion_qnty;
			}
			else{
				$unitcharge=$data_array_update[$row[csf('color_number_id')]][$fab_colo][unitcharge];
			}
			$total_value+=$unitcharge;
			if($unitcharge > 0) $avg_num+=1;
			$totalCons+=$DznGreyreq;
			?>
            <tr>
                <td><?=$i; ?></td>
                <td>
                    <input type="hidden" id="gmtscolorid_<?=$i; ?>" name="gmtscolorid_<?=$i; ?>" style="width:50px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
                    <input type="hidden" id="reqqty_<?=$i; ?>" name="reqqty_<?=$i; ?>" style="width:50px" value="<?=$colorreqqty; ?>" readonly/>
                    <input type="text" id="gmtscolor_<?=$i; ?>" name="gmtscolor_<?=$i; ?>" style="width:120px" class="text_boxes" value="<?=$color_library[$row[csf('color_number_id')]]; ?>" readonly/>
                </td>
                <td>
                    <input type="hidden" id="fabriccolorid_<?=$i; ?>" name="fabriccolorid_<?=$i; ?>" style="width:50px" value="<?=$fab_colo; ?>" readonly/>
                    <input type="text" id="fabriccolor_<?=$i;?>" name="fabriccolor_<?=$i;?>" style="width:120px" class="text_boxes" value="<?=$color_library[$fab_colo]; ?>"   readonly/>
                </td>
                <td><input type="text" id="cons_<?=$i;?>" name="cons_<?=$i;?>" value="<?=fn_number_format($DznGreyreq,4,'.',''); ?>" style="width:150px" class="text_boxes_numeric" readonly/></td>
                <td>
                    <input type="text" id="unitcharge_<?=$i; ?>" name="unitcharge_<?=$i; ?>" value="<?=trim($unitcharge); ?>" onChange="claculate_avg(); calculate_amount(<?=$i; ?>); copy_charge(this.value,<?=$i; ?>);" onClick="set_conversion_charge_unit(<?=$i; ?>,<?=$conversion_from_chart; ?>)" style="width:150px" class="text_boxes_numeric" <?=$charge_readonly; ?>/>
                    <input type="hidden" id="coversionchargelibraryid_<?=$i;?>" name="coversionchargelibraryid_<?=$i;?>" value="<?=$data_array_update[$row[csf('color_number_id')]][$row[csf('color_number_id')]][coversionchargelibraryid]; ?>" readonly/>
                    <input type="hidden" id="amount_<?=$i;?>" name="amount_<?=$i;?>" style="width:150px" class="text_boxes_numeric" readonly/>
                </td>
            </tr>
		<?
        }
	}
	else
	{
		$color_array=array();
		$color_size_sensitive_array=sql_select("select  id,color_size_sensitive  from wo_pre_cost_fabric_cost_dtls where job_no='".$job_no."' and fabric_source=1 and status_active=1 and is_deleted=0");
		foreach( $color_size_sensitive_array as $color_size_sensitive_row )
		{
			if($color_size_sensitive_row[csf('color_size_sensitive')]==1)
			{
				$data_array1=sql_select("select distinct a.color_number_id as color_number_id  from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."' and a.status_active=1 and  a.is_deleted=0 ");
				foreach( $data_array1 as $row1 )
				{
					if (array_key_exists($row1[csf('color_number_id')], $color_array)) continue;
					else $color_array[$row1[csf('color_number_id')]]=$row1[csf('color_number_id')];
				}
			}
			if($color_size_sensitive_row[csf('color_size_sensitive')]==3)
			{
				$data_array2=sql_select("select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."'");
				foreach( $data_array2 as $row2 )
				{
					if (array_key_exists($row2[csf('color_number_id')], $color_array)) continue;
					else $color_array[$row2[csf('color_number_id')]]=$row2[csf('color_number_id')];
				}
			}
			if($color_size_sensitive_row[csf('color_size_sensitive')]==0)
			{
				$data_array3=sql_select("select  color as color_number_id  from wo_pre_cost_fabric_cost_dtls where id='".$color_size_sensitive_row[csf('id')]."' and status_active=1 and is_deleted=0");
				foreach( $data_array3 as $row3 )
				{
					if (array_key_exists($row3[csf('color_number_id')], $color_array)) continue;
					else $color_array[$row3[csf('color_number_id')]]=$row3[csf('color_number_id')];
				}
			}
		}
		$i=0; $avg_num=0; $total_value=0;
		foreach( $color_array as $key=>$value )
		{
			$unitcharge=0;
			if($data_array_update[$value][unitcharge]=="") $unitcharge=$conversion_qnty;
			else $unitcharge=$data_array_update[$value][unitcharge];

			$total_value+=$unitcharge;

			if($unitcharge > 0) $avg_num+=1;
			$i++;
			?>
			<tr>
				<td><? echo $i; ?></td>
				<td><input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $value; ?>"  readonly/>
				<input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$value]; ?>"  readonly/></td>
				<td> <input type="hidden" id="fabriccolorid_<? echo $i;?>"   name="fabriccolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $value; ?>"  readonly/>
				<input type="text" id="fabriccolor_<? echo $i;?>"   name="fabriccolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$value]; ?>"  readonly/></td>
				<td>
					<input type="text" id="cons_<? echo $i;?>"   name="cons_<? echo $i;?>" value="<? //echo $unitcharge; ?>" style="width:150px"  class="text_boxes_numeric"/>
					<input type="hidden" id="amount_<? echo $i;?>"   name="amount_<? echo $i;?>" value="<? //echo $DznGreyreq; ?>" style="width:150px"  class="text_boxes_numeric" readonly/>
				</td>
				<td>
					<input type="text" id="unitcharge_<? echo $i;?>"   name="unitcharge_<? echo $i;?>" style="width:150px" onChange="claculate_avg()" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" value="<? echo trim($unitcharge); ?>"  class="text_boxes_numeric" <? echo $charge_readonly; ?>/>
					<input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value="<? echo $data_array_update[$row[csf('color_number_id')]][$row[csf('color_number_id')]][coversionchargelibraryid]; ?>"  readonly/>
				</td>
			</tr>
			<?
		}
	}
    ?>
    </tbody>
    <tfoot>
    	<tr>
            <th><? echo $avg_num; ?></th>
            <th>Total</th>
            <th>&nbsp;</th>
            <th><input type="text" id="total_cons"   name="total_cons" style="width:150px" value="<? echo $totalCons; ?>" class="text_boxes_numeric"/></th>
            <th>
                <input type="text" id="total_value"   name="total_value" style="width:150px" value="<? echo $total_value; ?>"  class="text_boxes_numeric"/>
                <input type="hidden" id="total_amount"   name="total_amount" style="width:150px" value="<? echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
            </th>
        </tr>
        <tr>
            <th>&nbsp;</th>
            <th>Avg Total</th>
            <th>&nbsp;</th>
            <th><input type="text" id="avg_total_cons"   name="avg_total_cons" style="width:150px" value="<? //echo $total_value; ?>"  class="text_boxes_numeric"/></th>
            <th><input type="text" id="avg_total_value"   name="avg_total_value" style="width:150px" value="<? //echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
            <input type="hidden" id="avg_total_amount"   name="avg_total_amount" style="width:150px" value="<? //echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
            </th>
        </tr>
    </tfoot>
    </table>
    <table width="300" cellspacing="0" class="" border="0">
        <tr>
        	<td align="center" height="15" width="100%">&nbsp;</td>
        </tr>
        <tr>
            <td align="center" width="100%" class="button_container">
            	<input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>
            </td>
        </tr>
    </table>
    </form>
    </body>
    <script> claculate_avg(); </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}
if($action=="conversion_aop_color_popup")
{
	echo load_html_head_contents("Popup AOP Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	// echo $cbotypeconversion.'SSSSSSS';die;
	?>
	<script>
    var costype=<? echo $cbotypeconversion ?>;
	//alert(costype);
    var israte_popup=2;
	function copy_charge(value,i){
		var checkbox = document.getElementById("copy_rate");
		//var fabric_color=document.getElementById('fabriccolorid_'+i).value;
		var rowCount = $('#color_rate_list tr').length;
		if (checkbox.checked == true){
			for(var j=i; j<=rowCount; j++)
			{
				if( fabric_color==document.getElementById('fabriccolorid_'+j).value) document.getElementById('unitcharge_'+j).value=value;
			}
			claculate_avg();
		}
	}
	
	function set_aop_conversion_charge_unit(i,conversion_from_chart)
	{
		// alert(israte_popup+'='+conversion_from_chart);
		 set_conversion_chart_aop_pop_up(i,conversion_from_chart);
		if(israte_popup==2)
		{
			if(conversion_from_chart==1)
			{
				document.getElementById('unitcharge_'+i).readOnly=true
				set_conversion_chart_aop_pop_up(i);
			}
			else
			{
				document.getElementById('unitcharge_'+i).readOnly=false
			}
		}
		else
		{
			if(costype==35)
			{
				if(conversion_from_chart==1)
				{
					document.getElementById('unitcharge_'+i).readOnly=true
					set_conversion_chart_aop_pop_up(i);
				}
				else
				{
					document.getElementById('unitcharge_'+i).readOnly=false
				}
			}
		}
    }
	
    function set_conversion_chart_aop_pop_up(i)
	{
		var cbo_company_name=document.getElementById('cbo_company_name').value;
		var cbotypeconversion=document.getElementById('cbotypeconversion').value
		//alert(cbotypeconversion);
		var txt_exchange_rate=document.getElementById('txt_exchange_rate').value
		var coversionchargelibraryid=document.getElementById('coversionchargelibraryid_'+i).value
		if(cbo_company_name==0){
			alert("Select Company");
			return;
		}
		if(cbotypeconversion==0){
			alert("Select Process");
			return;
		}
		if(txt_exchange_rate==0 || txt_exchange_rate==""){
			alert("Select Exchange Rate");
			return;
		}
		else{
			//alert(cbotypeconversion);
			var page_link='pre_cost_entry_controller_v2.php?action=conversion_chart_popup&cbo_company_name='+cbo_company_name+'&cbotypeconversion='+cbotypeconversion+'&coversionchargelibraryid='+coversionchargelibraryid;
			emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1460px,height=450px,center=1,resize=1,scrolling=0','../')
			emailwindow.onclose=function()
			{
				var charge_id=this.contentDoc.getElementById("charge_id");
				var charge_value=this.contentDoc.getElementById("charge_value");
				document.getElementById('coversionchargelibraryid_'+i).value=charge_id.value;
				document.getElementById('unitcharge_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
				calculate_amount(i);
				claculate_avg();
			}
		}
    }

    function js_set_value_color()
	{
		var rowCount = $('#tbl_color_details tr').length-3;
		var color_breck_down=""; var coversionchargelibraryid_baeck_down="";
		for(var i=1; i<=rowCount; i++)
		{
			if (form_validation('cboaoptype_'+i+'*cboaopcolor_'+i+'*unitcharge_'+i,'Aop Type*AOP Color*Rate')==false)
			{
				return;
			}
			var unitcharge = $('#unitcharge_'+i).val();var amount = $('#amount_'+i).val();if(trim(amount) =='') amount=0;
			if(trim(unitcharge) =='') unitcharge=0;
			var coversionchargelibraryid= $('#coversionchargelibraryid_'+i).val();
			if(coversionchargelibraryid=='') coversionchargelibraryid=0;
			var cboaoptype= $('#cboaoptype_'+i).val();
			if(cboaoptype=='') cboaoptype=0;
			var cboaopcolor= $('#cboaopcolor_'+i).val();
			if(cboaopcolor=='') cboaopcolor=0;
 
			if(color_breck_down==""){ //cbouom_1
				color_breck_down=trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#cons_'+i).val()+'_'+cboaoptype+'_'+cboaopcolor+'_'+amount;
			}
			else{
				color_breck_down+="__"+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#cons_'+i).val()+'_'+cboaoptype+'_'+cboaopcolor+'_'+amount;
			}

		 	if(coversionchargelibraryid_baeck_down=="") coversionchargelibraryid_baeck_down=$('#coversionchargelibraryid_'+i).val()
			 else coversionchargelibraryid_baeck_down+="_"+$('#coversionchargelibraryid_'+i).val();
		}
		document.getElementById('color_breck_down').value=color_breck_down;
		 document.getElementById('chargelibid_breck_down').value=coversionchargelibraryid_baeck_down;
		parent.emailwindow.hide();
    }

    function claculate_avg()
	{
		var totalunitcharge=0; var total_value=0; var total_amount=0; var totalreqqty=0;
		var rowCount = $('#tbl_color_details tr').length-3;
		for(var i=1; i<=rowCount; i++)
		{
			var cons =document.getElementById('cons_'+i).value*1;
			totalreqqty+=cons;
			var unitcharge=document.getElementById('unitcharge_'+i).value;
			  totalunitcharge+=unitcharge;
			var amount=unitcharge*cons;
			var value=unitcharge*cons;
			  total_value+=value;
			  total_amount+=amount;
		}
	 
		var avg_total_value=total_value/totalreqqty;
	//	alert(totalreqqty+'='+orderQty+'='+costPer+'='+itemRatio);
		document.getElementById('total_value').value=unitcharge;
		document.getElementById('total_amount').value=total_amount;
		document.getElementById('avg_total_value').value=number_format_common(unitcharge, 5, 0);
		document.getElementById('avg_total_cons').value=number_format_common(totalreqqty, 5, 0);
		document.getElementById('avg_total_amount').value=number_format_common(total_amount, 5, 0);
    }

    function calculate_amount(i)
	{
		var cons=document.getElementById('cons_'+i).value*1
		var unitcharge=document.getElementById('unitcharge_'+i).value*1
		var amount= cons*unitcharge;
		//alert(amount);
		document.getElementById('amount_'+i).value=number_format_common(amount, 5, 0);
    }
    </script>
    </head>
    <body>
    <?
	//echo $job_no.'DD';
	// $color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	// $condition= new condition();
	// if(str_replace("'","",$job_no) !=''){
	// 	$condition->job_no("='$job_no'");
	// }
	// $condition->init();
	// $GmtsitemRatioArr=$condition->getGmtsitemRatioArr();
	// $CostingPerArr=$condition->getCostingPerArr();
	// $CostPerQty= $CostingPerArr[str_replace("'","",$job_no)];

	// $fabric= new fabric($condition);
	// $fabric_costing_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();

	//print_r($fabric_costing_arr);
	$data_array_update=array();
    $data_array=explode("__",$colorbreakdown);
	if($data_array[0]=="") $data_array=array();

	if ( count($data_array)>0)
	{
		$i=0; $total_value=0;
		foreach( $data_array as $row )
		{
			$i++;//color_breck_down=trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#cons_'+i).val()+'_'+cboaoptype+'_'+cboaopcolor+'_'+amount;
			$data=explode('_',$row);
			$data_array_update[$cbocosthead][unitcharge]=$data[0];
			$data_array_update[$cbocosthead][coversionchargelibraryid]=$data[1];
			$data_array_update[$cbocosthead][aoptype]=$data[3];
			$data_array_update[$cbocosthead][aopcolor]=$data[4];
			$data_array_update[$cbocosthead][amount]=$data[5];
		}
	}
	 
	/*echo '<pre>';
	print_r($data_array_update);*/
	//echo $conversion_from_chart.'DDDDDDDD';
	if($cbotypeconversion==31 || $cbotypeconversion==1) { if($conversion_from_chart==1) $charge_readonly="readonly"; else $charge_readonly=""; } else $charge_readonly="";

	 
		$GmtsitemRatio=0;
		$plan_cut_qntyarray=array();
		$sql_data=sql_select("select a.job_no,d.uom, c.color_number_id, c.plan_cut_qnty,d.avg_cons from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d where 1=1  and d.id='$cbocosthead' and a.id=b.job_id and a.id=c.job_id and a.id=d.job_id  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0");//and e.cons !=0
		 
		$color_size_sensitive=0; $color_type_id=0;
		foreach($sql_data as $row){
			$plan_cut_qnty+=$row[csf('plan_cut_qnty')];
			$plan_cut_qntyarray[$row[csf('color_number_id')]]+=$row[csf('plan_cut_qnty')];
			$GmtsitemRatio=$GmtsitemRatioArr[$row[csf('job_no')]][$row[csf('item_number_id')]];
			$color_size_sensitive=$row[csf('color_size_sensitive')];
			$avg_cons=$row[csf('avg_cons')];
			$fabColorConsArr[$cbocosthead]=$cbocosthead;
			$uom_id=$row[csf('uom')];
		}
		//echo $uom_id.'DDDDD';

		$tdColor="Color";
		 
		?>
        <script>
		//var costPer=<?// echo $CostPerQty; ?>
		</script>
        <form id="contrastcolor_1" autocomplete="off">
            <input type="hidden" id="color_breck_down" />
            <input type="hidden" id="chargelibid_breck_down" />
            <input type="hidden" id="cbo_company_name" value="<? echo $cbo_company_name;?>" />
            <input type="hidden" id="cbotypeconversion" value="<? echo $cbotypeconversion;?>" />
            <input type="hidden" id="txt_exchange_rate" value="<? echo $txt_exchange_rate;?>" />
            <input type="hidden" id="cbo_currercy" value="<? echo $cbo_currercy;?>" />
            <input type="hidden" id="orderQty" value="<? echo $plan_cut_qnty;?>" />
            <input type="hidden" id="itemRatio" value="<? echo $GmtsitemRatio;?>" />
            <table width="300" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
            <caption><? //echo $tdColor; ?> </caption>
                <thead>
                    <tr>
                        <th width="30">Sl</th>
                        <th width="100" title="<? echo $tdColor; ?>">AOP Type</th>
                        
						<th width="100" title="<? echo $tdColor; ?>">AOP Color</th>
                      
                        <th width="80">Fab Cons(Kg)</th>
                        <th><input type="checkbox" id="copy_rate" name="copy_rate" value="Copy">&nbsp; Rate</th>
                        <th width="80">Amount</th>
                         
                    </tr>
                </thead>
        	<tbody id="color_rate_list">
		<?
		$no_color_arr=array(1=>"1 - 3",2=>"1 - 5",3=>"4 - 6",4=>"7 - 12");
		$i=0; $avg_num=0; $totalCons=0; $total_value=0;
		//print_r($data_array);
		foreach( $fabColorConsArr as $fab_key=>$row )
		{
			$i++;
			$colorreqqty=0;
			
			
				$DznGreyreq=$avg_cons;$colorreqqty=$avg_cons;
				$unitcharge=0;
				if($data_array_update[$fab_key][unitcharge]==""){
					$unitcharge=$conversion_qnty;
				}
				else{
					$unitcharge=$data_array_update[$fab_key][unitcharge];
				}
				$total_value+=$unitcharge;
				if($unitcharge > 0) $avg_num+=1;
				$totalCons+=$DznGreyreq;
				//print_type 
				$aoptype=$data_array_update[$fab_key][aoptype];
				if($aoptype=="") $aoptype="";
				$aopcolor=$data_array_update[$fab_key][aopcolor];
				if($aopcolor=="") $aopcolor="";
			//	$uom_id=$data_array_update[$row[csf('color_number_id')]][$fab_colo][uom];
				$amount=$data_array_update[$fab_key][amount];
				if($amount=="") $amount="";
			
			?>
            <tr>
                <td title="<?=$fab_key;?>"><? echo $i; ?></td>
                <td>
                    <?=create_drop_down( "cboaoptype_".$i, 80, $print_type,"", 1, "---Select----", $aoptype, "" ,"",""); ?>
                </td>
                 
				<td>
					<?=create_drop_down( "cboaopcolor_".$i, 80, $no_color_arr,"", 1, "---Select----", $aopcolor, "" ,"",""); ?>
                </td>
               
                <td><input type="text" id="cons_<? echo $i;?>" name="cons_<? echo $i;?>" value="<? echo fn_number_format($DznGreyreq,4,'.',''); ?>" style="width:150px" class="text_boxes_numeric" readonly/>
				<input type="hidden" id="reqqty_<? echo $i;?>" name="reqqty_<? echo $i;?>" style="width:50px" class="text_boxes" value="<? echo $colorreqqty; ?>" readonly/>
				</td>
                <td>
                <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>" name="coversionchargelibraryid_<? echo $i;?>" value="<? echo $data_array_update[$row[csf('color_number_id')]][$row[csf('color_number_id')]][coversionchargelibraryid]; ?>" readonly/>
                 <input type="text" id="unitcharge_<? echo $i;?>" name="unitcharge_<? echo $i;?>" value="<? echo trim($unitcharge); ?>" onChange="claculate_avg(); calculate_amount(<? echo $i; ?>);copy_charge(this.value,<? echo $i; ?>)"  style="width:150px" class="text_boxes_numeric" <? echo $charge_readonly; ?>/>
                </td>
                 <td><input type="text" id="amount_<? echo $i;?>" name="amount_<? echo $i;?>" value="<? echo fn_number_format($amount,4,'.',''); ?>" style="width:150px" class="text_boxes_numeric" readonly/></td>
            </tr>
		<?
        
	 }
	 
    ?>
    </tbody>
    <tfoot>
    	<tr>
            <th><? echo $avg_num; ?></th>
           
            <th>&nbsp;</th>
			 
			<th>Total</th>
            <th><input type="text" id="total_cons"   name="total_cons" style="width:150px" value="<? echo $totalCons; ?>" class="text_boxes_numeric" readonly/></th>
            <th><input type="text" id="total_value"   name="total_value" style="width:150px" value="<? echo $total_value; ?>"  class="text_boxes_numeric" readonly/></th>
            <th>
                
                <input type="text" id="total_amount"   name="total_amount" style="width:150px" value="<? echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
            </th>
        </tr>
        <tr>
            <th>&nbsp;</th>
			 
			<th>&nbsp;</th>
            <th>Avg Total</th>
            
            <th><input type="text" id="avg_total_cons"   name="avg_total_cons" style="width:150px" value="<? echo $totalCons; ?>"  class="text_boxes_numeric" readonly/></th>
            <th><input type="text" id="avg_total_value"   name="avg_total_value" style="width:150px" value="<? echo $total_value; ?>" class="text_boxes_numeric" readonly/></th>
            <th> 
            <input type="text" id="avg_total_amount"   name="avg_total_amount" style="width:150px" value="<? //echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric" readonly/>
            </th>
        </tr>
    </tfoot>
    </table>
    <table width="300" cellspacing="0" class="" border="0">
        <tr>
        	<td align="center" height="15" width="100%">&nbsp;</td>
        </tr>
        <tr>
            <td align="center" width="100%" class="button_container">
            	<input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>
            </td>
        </tr>
    </table>
    </form>
    </body>
    <script> claculate_avg(); </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="delete_row_fabric_cost")
{
	$con = connect();
	if($db_type==0) mysql_query("BEGIN");
	$flag=1;

	$rID=execute_query( "update wo_pre_cost_fabric_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1  where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID==1 && $flag==1) $flag=1; else $flag=0;

	$rID0=execute_query( "update wo_pre_cos_fab_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", status_active=0, is_deleted=1 where pre_cost_fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID0==1 && $flag==1) $flag=1; else $flag=0;

	$rID1=execute_query( "update wo_pre_cos_fab_co_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID1==1 && $flag==1) $flag=1; else $flag=0;

	$rID2=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID2==1 && $flag==1) $flag=1; else $flag=0;

	$rID3=execute_query( "update wo_pre_cost_fab_yarnbreakdown set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID3==1 && $flag==1) $flag=1; else $flag=0;

	$rID4=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where fabric_description ='$data' and status_active=1 and is_deleted=0",1);
	if($rID4==1 && $flag==1) $flag=1; else $flag=0;

	$rID5=execute_query( "update wo_pre_cos_conv_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID5==1 && $flag==1) $flag=1; else $flag=0;

	$rID6=execute_query( "update wo_pre_stripe_color set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID6==1 && $flag==1) $flag=1; else $flag=0;
//	echo $rID.'='.$rID0.'='.$rID1.'='.$rID2.'='.$rID3.'='.$rID4.'='.$rID5.'='.$rID6.'='.$flag;

	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_yarn_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$flag=1;
	$rID2=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID2==1 && $flag==1) $flag=1; else $flag=0;

	$rID3=execute_query( "update wo_pre_cost_fab_yarnbreakdown set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID3==1 && $flag==1) $flag=1; else $flag=0;

	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="conversion_from_chart")
{
	$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data'  and variable_list=21 and status_active=1 and is_deleted=0");
	if($conversion_from_chart=="")
	{
		$conversion_from_chart=2;
	}
	echo trim($conversion_from_chart);
	exit();
}

if($action =="process_loss_from_yarn")
{
	$fabric_determination_id = return_field_value("lib_yarn_count_deter_id", "wo_pre_cost_fabric_cost_dtls", "id='$data' and status_active=1 and is_deleted=0");
	$process_loss_arr = sql_select("SELECT process_id,process_loss,rate from conversion_process_loss where mst_id=$fabric_determination_id and status_active=1 and is_deleted=0 and rate <>0");
	//(process_loss is not null or rate is not null)
	$i=0;
	$process_loss_data='';
	foreach ($process_loss_arr as $row) {
		$process_id=$row[csf('process_id')];
		$process_losss =($row[csf('process_loss')] == '') ? 0 : $row[csf('process_loss')];
		$rate =($row[csf('rate')] == '') ? 0 : $row[csf('rate')];
		if($i!=0) $add_comma='__'; else $add_comma='';
		$process_loss_data .= $add_comma.$process_id.'_'.$process_losss.'_'.$rate;
		$i++;
	}
	echo trim($process_loss_data);
}

if($action=="delete_row_conversion_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$flag=1;
	$rID4=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID4==1 && $flag==1) $flag=1; else $flag=0;

	$rID5=execute_query( "update wo_pre_cos_conv_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where conv_cost_dtls_id='$data' and status_active=1 and is_deleted=0",1);
	if($rID5==1 && $flag==1) $flag=1; else $flag=0;

	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT");  else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="check_trims_booking")
{
	if (is_duplicate_field( "pre_cost_fabric_cost_dtls_id", "wo_booking_dtls", "pre_cost_fabric_cost_dtls_id=$data and booking_type=2 and is_deleted=0 and status_active=1" ) == 1)
	{
		echo "11"; die;
	}
}

if($action=="delete_row_trim_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	if (is_duplicate_field( "pre_cost_fabric_cost_dtls_id", "wo_booking_dtls", "pre_cost_fabric_cost_dtls_id=$data and booking_type=2 and is_deleted=0 and status_active=1" ) == 1)
	{
		echo "11"; die;
	}
	$flag=1;
	$rID5=execute_query( "update wo_pre_cost_trim_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID5==1 && $flag==1) $flag=1; else $flag=0;

	$rID6=execute_query( "update wo_pre_cost_trim_co_cons_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where wo_pre_cost_trim_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID6==1 && $flag==1) $flag=1; else $flag=0;
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_embellishment_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$flag=1;
	$rID7=execute_query( "update wo_pre_cost_embe_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID7==1 && $flag==1) $flag=1; else $flag=0;

	$rID8=execute_query( "update wo_pre_cos_emb_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_emb_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID8==1 && $flag==1) $flag=1; else $flag=0;
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_wash_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$flag=1;
	$rID7=execute_query( "update wo_pre_cost_embe_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID7==1 && $flag==1) $flag=1; else $flag=0;

	$rID8=execute_query( "update wo_pre_cos_emb_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_emb_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID8==1 && $flag==1) $flag=1; else $flag=0;

	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_comarcial_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$flag=1;
	$rID9=execute_query( "update wo_pre_cost_comarci_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID9==1 && $flag==1) $flag=1; else $flag=0;

	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if ($action=="save_update_delet_fabric_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$con = connect();
	//$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	$cost_control_source=str_replace("'","",$txt_cost_control_source);
	$quotation_id=str_replace("'","",$txt_quotation_id)*1;
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if($cost_control_source==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
	if($component_approved==3){
		$component_approved=1;
	}

	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}

	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	// *******Color Lib Check*******//
	//echo "10**".'<br>';
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$stripeColorArr=array();  $new_array_color=array();
	for ($i=1;$i<=$total_row;$i++)
	{
		$txtcolor="txtcolor_".$i;
		$cbocolorsizesensitive="cbocolorsizesensitive_".$i;

		$colorbreackdown="colorbreackdown_".$i;

		if(str_replace("'",'',$$colorbreackdown)!="")
		{
			$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
			for($c=0; $c < count($colorbreckdown_array); $c++)
			{
				$counter++;
				$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
				if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]="";
				if(str_replace("'","",$colorbreckdownarr[2])!="")
				{
					$fab_colorName=str_replace("'","",$colorbreckdownarr[2]);
					if(str_replace("'","",$colorbreckdownarr[2])!="")
					{
						if (!in_array(str_replace("'","",$colorbreckdownarr[2]),$new_array_color, TRUE))
						{
							 $color_id = return_id( str_replace("'","",$colorbreckdownarr[2]), $color_library, "lib_color", "id,color_name","158");
							 $new_array_color[$color_id]=str_replace("'","",$colorbreckdownarr[2]);
							 $stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
						}
						else
						{
							$color_id =  array_search(str_replace("'","",$colorbreckdownarr[2]), $new_array_color);
							$stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
						}
					}
					else $color_id=0;
					$stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
				}
			}
		}
	}
	//disconnect($con);
	//die;
	if($operation==0)
	{
		//$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//echo "10**";
		$yarnString=array(); $yarn_rate_array=array(); $yarn_sup_array=array(); $convDataArr=array(); $isConv=0;
		if($is_copy_quatation==1 && $quotation_id!=0)
		{
			if($cost_control_source==5 || $cost_control_source==8)//5=Short Quotation V2; 8=Short Quotation V6
			{
				//$sql_yarn_rate=sql_select("select fabric_cost_dtls_id, job_no, count_id, copm_one_id,percent_one,type_id,cons_ratio,rate,color,supplier_id from wo_pre_cost_fab_yarn_cost_dtls where  job_no =".$update_id." and status_active=1 and is_deleted=0");
				$sql_yarn_rate=sql_select("select fab_id as prifabdtlsid, type, cons_rate_dtls_id as pribodydtlsid, count as count_id, composition as copm_one_id, percent as percent_one, yarn_type as type_id, cons as cons_qnty, tot_cons as avg_cons_qnty, rate, value as amount, nominated_supp_multi as supplier_id, process from qc_fab_yarn_conv where qc_no='$quotation_id' and type in (2,3) and cons>0 and status_active=1 and is_deleted=0 order by id");
				foreach($sql_yarn_rate as $yrow)
				{
					if($yrow[csf('type')]==2)//Yarn
					{
						if($yrow[csf('count_id')]=="") $yrow[csf('count_id')]=0;
						if($yrow[csf('copm_one_id')]=="") $yrow[csf('copm_one_id')]=0;
						if($yrow[csf('percent_one')]=="") $yrow[csf('percent_one')]=0;
						if($yrow[csf('type_id')]=="") $yrow[csf('type_id')]=0;
						if($yrow[csf('rate')]=="") $yrow[csf('rate')]=0;
						if($yrow[csf('supplier_id')]=="") $yrow[csf('supplier_id')]=0;
						$yarn_rate_array[$yrow[csf('prifabdtlsid')]][$yrow[csf('count_id')]][$yrow[csf('copm_one_id')]][$yrow[csf('percent_one')]][$yrow[csf('type_id')]]=$yrow[csf('rate')];
						$yarn_sup_array[$yrow[csf('prifabdtlsid')]][$yrow[csf('count_id')]][$yrow[csf('copm_one_id')]][$yrow[csf('percent_one')]][$yrow[csf('type_id')]]=$yrow[csf('supplier_id')];
	
						if(isset($yarnString[$yrow[csf('prifabdtlsid')]]))
						{
							$yarnString[$yrow[csf('prifabdtlsid')]].= "__".$yrow[csf('count_id')]."_".$yrow[csf('copm_one_id')]."_100_".$yrow[csf('type_id')]."_".$yrow[csf('percent_one')];
						}
						else
						{
							$yarnString[$yrow[csf('prifabdtlsid')]]= $yrow[csf('count_id')]."_".$yrow[csf('copm_one_id')]."_100_".$yrow[csf('type_id')]."_".$yrow[csf('percent_one')];
						}
					}
					else if($yrow[csf('type')]==3)
					{
						if(array_key_exists($yrow[csf('prifabdtlsid')],$convDataArr))
						{
							$convDataArr[$yrow[csf('prifabdtlsid')]].="##".$yrow[csf('process')].",".$yrow[csf('rate')];
							$isConv=1;
						}
						else
						{
							$convDataArr[$yrow[csf('prifabdtlsid')]]=$yrow[csf('process')].",".$yrow[csf('rate')];
							$isConv=1;
						}
					}
				}
				unset($sql_yarn_rate);
			}
		}

		$rID_in=sql_insert("wo_pre_cost_fabric_cost_dtls",$field_array,$data_array,0,1);
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from wo_pre_cost_sum_dtls where job_no =$update_id and status_active=1 and is_deleted=0";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="") $wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);
	   	// die;

		if ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con); die; }
		$field_array="id, job_id, job_no, seq, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, avg_cons, fabric_source, source_id, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, uom, body_part_type, nominated_supp, quotdtlsid, budget_on";

		$field_array1="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks, body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length, front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, inserted_by, insert_date, status_active, is_deleted";

		$field_array2="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, gmts_color_id, gmts_color, contrast_color_id";

		$field_yarn="id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, type_id, supplier_id, cons_ratio, cons_qnty, avg_cons_qnty, rate, amount, inserted_by, insert_date, status_active, is_deleted";

		$field_conv="id, job_id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, avg_req_qnty, process_loss, inserted_by, insert_date, status_active, is_deleted";

		$id=return_next_id( "id", "wo_pre_cost_fabric_cost_dtls", 1);
		$id1=return_next_id( "id", "wo_pre_cos_fab_co_avg_con_dtls", 1);
		$wo_pre_cos_fab_co_color_dtls_id=return_next_id( "id", "wo_pre_cos_fab_co_color_dtls", 1);
		$wo_pre_cost_fab_yarn_cost_dtls_id=return_next_id( "id", " wo_pre_cost_fab_yarn_cost_dtls", 1);
		$wo_pre_cost_fab_yarnbreakdown_id=return_next_id( "id", "wo_pre_cost_fab_yarnbreakdown", 1);
		$idconv=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1);

		$flag=1; $rID=$rID1=$rID2=$rID3=$rID4=$rID5=$rID6=1;
		for ($i=1;$i<=$total_row;$i++)
		{
			$seq="seq_".$i;
			$cbogmtsitem="cbogmtsitem_".$i;
			$txtbodypart="txtbodypart_".$i;
			$cbofabricnature="cbofabricnature_".$i;
			$cbocolortype="cbocolortype_".$i;
			$libyarncountdeterminationid="libyarncountdeterminationid_".$i;
			$oldlibyarncountdeterminationid="oldlibyarncountdeterminationid_".$i;
			$construction="construction_".$i;
			$composition="composition_".$i;
			$fabricdescription="fabricdescription_".$i;
			$txtgsmweight="txtgsmweight_".$i;
			$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
			$txtcolor="txtcolor_".$i;
			$txtconsumption="txtconsumption_".$i;
			$cbofabricsource="cbofabricsource_".$i;
			$cbosourceid="cbosourceid_".$i;
			$cbonominasupplier="cbonominasupplier_".$i;
			$txtrate="txtrate_".$i;
			$txtamount="txtamount_".$i;
			$txtfinishconsumption="txtfinishconsumption_".$i;
			$txtavgprocessloss="txtavgprocessloss_".$i;
			$consbreckdown="consbreckdown_".$i;
			$msmntbreackdown="msmntbreackdown_".$i;
			$processlossmethod="processlossmethod_".$i;
			$colorbreackdown="colorbreackdown_".$i;
			$yarnbreackdown="yarnbreackdown_".$i;
			$consumptionbasis="consumptionbasis_".$i;
			$markerbreackdown="markerbreackdown_".$i;
            $cbowidthdiatype="cbowidthdiatype_".$i;
			$prifabcostdtlsid="prifabcostdtlsid_".$i;
			$updateid="updateid_".$i;

			$avgtxtconsumption="avgtxtconsumption_".$i;
			$avgtxtgsmweight="avgtxtgsmweight_".$i;
			$plancutqty="plancutqty_".$i;
			$jobplancutqty="jobplancutqty_".$i;
			$uom="uom_".$i;
			$txtbodyparttype="txtbodyparttype_".$i;
			$budgeton="budgeton_".$i;
			$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
			$msmn_tbreackdown=str_replace("'","",$$msmntbreackdown);
			$determinationid=str_replace("'","",$$libyarncountdeterminationid);
			if($determinationid=="" || $determinationid==0)
			{
				$msg="Fabric Description miss match,please check properly.";
				echo "17**".$msg.',Construction='.$$construction.',Composition='.$$composition.'**'.$i;
				check_table_status( $_SESSION['menu_id'],0);
				disconnect($con);die;
			}
			if($msmn_tbreackdown=="") $msmn_tbreackdown=" ";

			$data_array.="INTO wo_pre_cost_fabric_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",".$$seq.",".$$cbogmtsitem.",".$$txtbodypart.",".$$cbofabricnature.",".$$cbocolortype.",".$$libyarncountdeterminationid.",".$$construction.",".$$composition.",".$$fabricdescription.",".$$txtgsmweight.",".$$cbocolorsizesensitive.",".$$txtconsumption.",".$$cbofabricsource.",".$$cbosourceid.",".$$txtrate.",".$$txtamount.",".$$txtfinishconsumption.",".$$txtavgprocessloss.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0,".$cbo_company_name.",".$cbo_costing_per.",".$$consumptionbasis.",".$$processlossmethod.",'".$cons_breckdown."','".$msmn_tbreackdown."',".$$colorbreackdown.",".$$yarnbreackdown.",".$$markerbreackdown.",".$$cbowidthdiatype.",".$$avgtxtconsumption.",".$$avgtxtgsmweight.",".$$plancutqty.",".$$jobplancutqty.",".$$uom.",".$$txtbodyparttype.",".$$cbonominasupplier.",".$$prifabcostdtlsid.",".$$budgeton.")";
		//	msmnt break down===============================================================================================
			$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
			$msmntbreackdown_array=explode('__',str_replace("'",'',$$msmntbreackdown));
			$markerbreackdownarr=explode('_',str_replace("'",'',$$markerbreackdown));
			$counter=0;
			for($c=0;$c < count($consbreckdown_array);$c++)
			{
				$counter++;
				$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
				$msmntbreackdownarr=explode('_',$msmntbreackdown_array[$c]);
				$str_rep=array("+", "&", "*", "(", ")", "=","'","\r", "\n",'"','#');
				$data_array1="";
				$consbreckdownarr[3]=strtoupper($consbreckdownarr[3]);
				$consbreckdownarr[12]=str_replace($str_rep,' ',$consbreckdownarr[12]);
				if(str_replace("'",'',$$txtbodypart)*1==1)
				{
					$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".($consbreckdownarr[10]*1)."','".($consbreckdownarr[11]*1)."','".trim($consbreckdownarr[12])."','".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."',0,0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[8]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
				}
				else if(str_replace("'",'',$$txtbodypart)*1==20)
				{
					$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".($consbreckdownarr[10]*1)."','".($consbreckdownarr[11]*1)."','".trim($consbreckdownarr[12])."',0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."','".$msmntbreackdownarr[8]."','".$msmntbreackdownarr[9]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
				}
				else
				{
					$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".($consbreckdownarr[10]*1)."','".($consbreckdownarr[11]*1)."','".trim($consbreckdownarr[12])."',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
				}

				$id1=$id1+1;

				$rID=execute_query($data_array1);
				if ($rID==1) { $flag=1; }
				else { echo "10**fabcons-".$data_array1; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
			}

			//Msmnt break down end===============================================================================================
			//Yarn break down ===================================================================================================
			if(str_replace("'",'',$$cbofabricsource)==1 && str_replace("'",'',$$yarnbreackdown)!="")
			{
				$yarnbreckdown_array=array();

				if(str_replace("'",'',$$oldlibyarncountdeterminationid)!=str_replace("'",'',$$libyarncountdeterminationid))
				{
					$yarnbreckdown_array=explode('__',str_replace("'",'',$$yarnbreackdown));
				}
				else if($yarnString[str_replace("'","",$$prifabcostdtlsid)]!="" && str_replace("'",'',$$oldlibyarncountdeterminationid)==str_replace("'",'',$$libyarncountdeterminationid))
				{
					$yarnbreckdown_array=explode('__',$yarnString[str_replace("'","",$$prifabcostdtlsid)]);
				}
				else if(str_replace("'",'',$$oldlibyarncountdeterminationid)==str_replace("'",'',$$libyarncountdeterminationid)){
					$yarnbreckdown_array=explode('__',str_replace("'",'',$$yarnbreackdown));
				}
				for($c=0;$c < count($yarnbreckdown_array);$c++)
				{
					$counter++;
					$yarnbreckdownarr=explode('_',$yarnbreckdown_array[$c]);
					if(str_replace("'",'',$$cbofabricnature)==2)
					{
						$cons=def_number_format(((str_replace("'",'',$$txtconsumption)*$yarnbreckdownarr[4])/100),8,"");
						$avg_cons=def_number_format(((str_replace("'",'',$$avgtxtconsumption)*$yarnbreckdownarr[4])/100),8,"");
					}
					if(str_replace("'",'',$$cbofabricnature)==3)
					{
						$cons=def_number_format(((str_replace("'",'',$$txtgsmweight)*$yarnbreckdownarr[4])/100),8,"");
						$avg_cons=def_number_format(((str_replace("'",'',$$avgtxtgsmweight)*$yarnbreckdownarr[4])/100),8,"");
					}

					$rate=$yarn_rate_array[str_replace("'","",$$prifabcostdtlsid)][$yarnbreckdownarr[0]][$yarnbreckdownarr[1]][$yarnbreckdownarr[4]][$yarnbreckdownarr[3]];
					$sup=0;//$yarn_sup_array[str_replace("'","",$$prifabcostdtlsid)][$yarnbreckdownarr[0]][$yarnbreckdownarr[1]][$yarnbreckdownarr[4]][$yarnbreckdownarr[3]];

					$amount=$cons*$rate;
					$data_array3=""; $data_array4="";

					$data_array3="INSERT INTO wo_pre_cost_fab_yarn_cost_dtls (".$field_yarn.") VALUES (".$wo_pre_cost_fab_yarn_cost_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",'".$yarnbreckdownarr[0]."','".$yarnbreckdownarr[1]."','".$yarnbreckdownarr[2]."','".$yarnbreckdownarr[3]."','".$sup."','".$yarnbreckdownarr[4]."','".$cons."','".$avg_cons."','".$rate."','".def_number_format($amount,8,"")."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

					$data_array4="INSERT INTO wo_pre_cost_fab_yarnbreakdown (".$field_yarn.") VALUES (".$wo_pre_cost_fab_yarnbreakdown_id.",".$hidd_job_id.",".$id.",".$update_id.",'".$yarnbreckdownarr[0]."','".$yarnbreckdownarr[1]."','".$yarnbreckdownarr[2]."','".$yarnbreckdownarr[3]."','".$sup."','".$yarnbreckdownarr[4]."','".$cons."','".$avg_cons."','".$rate."','".def_number_format($amount,8,"")."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

					$wo_pre_cost_fab_yarn_cost_dtls_id=$wo_pre_cost_fab_yarn_cost_dtls_id+1;
					$wo_pre_cost_fab_yarnbreakdown_id=$wo_pre_cost_fab_yarnbreakdown_id+1;

					$rID2=execute_query($data_array3);
					if ($rID2==1 && $flag==1) { $flag=1; }
					else { echo "10**yarn-".$data_array3; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }

					$rID3=execute_query($data_array4);
					if ($rID3==1 && $flag==1) { $flag=1; }
					else { echo "10**yarn2-".$data_array4; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}

			if($isConv==1)
			{
				$fabconvstr=explode('##',$convDataArr[str_replace("'","",$$prifabcostdtlsid)]);

				foreach($fabconvstr as $convstr)
				{
					$convbreakdownarr=explode(',',$convstr);
					$convAmount=str_replace("'",'',$$txtconsumption)*$convbreakdownarr[1];
					$data_conv="";

					$data_conv="INSERT INTO wo_pre_cost_fab_conv_cost_dtls (".$field_conv.") VALUES (".$idconv.",".$hidd_job_id.",".$update_id.",".$id.",'".$convbreakdownarr[0]."',".$$txtconsumption.",'".$convbreakdownarr[1]."','".def_number_format($convAmount,8,"")."',".$$txtconsumption.",0,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

					$idconv++;
					$rID4=execute_query($data_conv);
					if ($rID4==1 && $flag==1) { $flag=1; }
					else { echo "10**conv-".$data_conv; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}

			// Yarn break down end ===============================================================================================
			// Color break down ==================================================================================================
			if(str_replace("'",'',$$colorbreackdown)!="")
			{
				$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
				for($c=0;$c < count($colorbreckdown_array);$c++)
				{
					$counter++;
					$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);

					if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]="";

					$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
					if($stripecolor_id=="") $stripecolor_id=0;

					$data_array5="";

					$data_array5="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
					$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;

					$rID5=execute_query($data_array5);
					if ($rID5==1 && $flag==1) { $flag=1; }
					else { echo "10**coColor-".$data_array5; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}
			//color break down end ===============================================================================================
			$id=$id+1;
		}// end master for loop
		//echo "10**";

		$queryfab="INSERT ALL ".$data_array." SELECT * FROM dual";
		$rID1=execute_query($queryfab);
		if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		//check_table_status( $_SESSION['menu_id'],0);die;


		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array5="id, job_id, job_no, fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg, fab_woven_fin_req_yds, fab_knit_fin_req_kg, fab_amount, avg, pro_woven_grey_fab_req_yds, pro_knit_grey_fab_req_kg, pro_woven_fin_fab_req_yds, pro_knit_fin_fab_req_kg, pur_woven_grey_fab_req_yds, pur_knit_grey_fab_req_kg, pur_woven_fin_fab_req_yds, pur_knit_fin_fab_req_kg, woven_amount, knit_amount";
			$data_array5="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$tot_yarn_needed.",".$txtwoven_sum.",".$txtknit_sum.",".$txtwoven_fin_sum.",".$txtknit_fin_sum.",".$txtamount_sum.",".$avg.",".$txtwoven_sum_production.",".$txtknit_sum_production.",".$txtwoven_fin_sum_production.",".$txtknit_fin_sum_production.",".$txtwoven_sum_purchase.",".$txtknit_sum_purchase.",".$txtwoven_fin_sum_purchase.",".$txtknit_fin_sum_purchase.",".$txtwoven_amount_sum_purchase.",".$txtkint_amount_sum_purchase.")";
			$rID6=sql_insert("wo_pre_cost_sum_dtls",$field_array5,$data_array5,1);
			if($rID6==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array5="fab_yarn_req_kg*fab_woven_req_yds*fab_knit_req_kg*fab_woven_fin_req_yds*fab_knit_fin_req_kg*fab_amount*avg*pro_woven_grey_fab_req_yds*pro_knit_grey_fab_req_kg*pro_woven_fin_fab_req_yds*pro_knit_fin_fab_req_kg*pur_woven_grey_fab_req_yds*pur_knit_grey_fab_req_kg*pur_woven_fin_fab_req_yds*pur_knit_fin_fab_req_kg*woven_amount*knit_amount*status_active*is_deleted";
			$data_array5 ="".$tot_yarn_needed."*".$txtwoven_sum."*".$txtknit_sum."*".$txtwoven_fin_sum."*".$txtknit_fin_sum."*".$txtamount_sum."*".$avg."*".$txtwoven_sum_production."*".$txtknit_sum_production."*".$txtwoven_fin_sum_production."*".$txtknit_fin_sum_production."*".$txtwoven_sum_purchase."*".$txtknit_sum_purchase."*".$txtwoven_fin_sum_purchase."*".$txtknit_fin_sum_purchase."*".$txtwoven_amount_sum_purchase."*".$txtkint_amount_sum_purchase."*1*0";
			$rID6=sql_update("wo_pre_cost_sum_dtls",$field_array5,$data_array5,"job_no","".$update_id."",1);
			if($rID6==1 && $flag==1) $flag=1; else $flag=0;
		}
		//=======================sum End =================
		//echo "10**".$rID.'='.$rID1.'='. $rID2.'='. $rID3.'='. $rID4.'='. $rID5.'='. $rID6.'='. $flag; check_table_status( $_SESSION['menu_id'],0); die;

		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}//Insert end
	else if($operation==1)// Update here
	{
		//$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		//$condition= new condition();
		if(str_replace("'","",$update_id) !=''){
			//$condition->job_no("=$update_id");
		}

		//$condition->init();
	//	$fabric= new fabric($condition);
		//$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$is_sequence_validation=return_field_value("season_mandatory", "variable_order_tracking", "company_name=$cbo_company_name and variable_list=63");
		$booking_qty_arr=array();
		//echo "10**";
		if($is_sequence_validation==1)
		{
			$booking_sql="select booking_no, po_break_down_id, pre_cost_fabric_cost_dtls_id, grey_fab_qnty as grey_fab_qnty, precons from wo_booking_dtls where job_no=$update_id and booking_type=1 and is_short=2 and status_active=1 and is_deleted=0 ";
			$booking_sql_res=sql_select($booking_sql);
			$booking_cons_arr=array();
			foreach($booking_sql_res as $row)
			{
				$booking_qty_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]+=$row[csf('grey_fab_qnty')];
				$booking_cons_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('po_break_down_id')]]=$row[csf('precons')];
				$booking_no_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]].=$row[csf('booking_no')].',';
			}
			unset($booking_sql_res);

			$datapo_array=sql_select("select b.id, b.po_quantity, min(c.id) as color_size_table_id, c.item_number_id, c.color_number_id, c.size_number_id, sum(plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and b.job_no_mst=$update_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_quantity, c.item_number_id, c.color_number_id, c.size_number_id");

			$poczQtyArr=array(); $poqtyArr=array();
			foreach($datapo_array as $row)
			{
				$poczQtyArr[$row[csf('color_size_table_id')]]+=$row[csf('plan_cut_qnty')];
				$poqtyArr[$row[csf('id')]]+=$row[csf('plan_cut_qnty')];
			}
			unset($datapo_array);

			$item_ratio_array=return_library_array("select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no =$update_id", "gmts_item_id", "set_item_ratio");

			$costing_perid=str_replace("'","",$cbo_costing_per);

			if($costing_perid==1) $costing_per=12;
			else if($costing_perid==2) $costing_per=1;
			else if($costing_perid==3) $costing_per=24;
			else if($costing_perid==4) $costing_per=36;
			else if($costing_perid==5) $costing_per=48;
			else $costing_per=0;
			$msg="Booking Grey Cons (Kg) is over than Budget."; //echo "10**";
			for ($i=1;$i<=$total_row;$i++)
			{
				$updateid="updateid_".$i;
				$consbreckdown="consbreckdown_".$i;
				$cbogmtsitem="cbogmtsitem_".$i;
				$isconspopupupdate="isconspopupupdate_".$i;
				$gmtsitemid=str_replace("'","",$$cbogmtsitem);

				$pre_cost_fabric_cost_dtls_id=str_replace("'","",$$updateid);

				$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
				if(str_replace("'",'',$$isconspopupupdate)==1)
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
					$counter=0; $powiseCostingPerReqQtyArr=array(); $m=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;

						$req_grey_fab_qty=$poplanqty=$gcons_req=0;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

						$color_size_table_id=$consbreckdownarr[9];
						$po_break_down_id=$consbreckdownarr[0];
						$gcons_req=$consbreckdownarr[7];

						$gcons_req=fn_number_format(str_replace("'","",$gcons_req),4,'.','');
						$poplanqty=$poczQtyArr[$color_size_table_id];

						$req_grey_fab_qty =($poplanqty/$item_ratio_array[$gmtsitemid])*($gcons_req/$costing_per);
						//echo $req_grey_fab_qty.'='.$poplanqty.'='.$item_ratio_array[$gmtsitemid].'='.$gcons_req.'='.$costing_per.'<br>';

						$powiseCostingPerReqQtyArr[$pre_cost_fabric_cost_dtls_id][$po_break_down_id]['greyreqqty']+=$req_grey_fab_qty;
						$m=1;
					}
					if($m==1)
					{
						foreach($powiseCostingPerReqQtyArr[$pre_cost_fabric_cost_dtls_id] as $poid=>$podata)
						{
							$bomgreyreqqty=$booking_cons=$itempoWiseReqQty=0;
							$bomgreyreqqty=$podata['greyreqqty'];
							$booking_cons=def_number_format($booking_cons_arr[$pre_cost_fabric_cost_dtls_id][$poid],4,"");

							$itempoWiseReqQty=def_number_format(($podata['greyreqqty']/($poqtyArr[$poid]/$item_ratio_array[$gmtsitemid]))*$costing_per,4,"");
							//echo $podata['greyreqqty'].'='.$poqtyArr[$poid].'='.$item_ratio_array[$gmtsitemid].'='.$costing_per.'<br>';
							//echo $itempoWiseReqQty.'='.$booking_cons.'='.$is_sequence_validation.'<br>';
							$booking_no="";
							$booking_no=implode(",",array_filter(array_unique(explode(",",$booking_no_arr[$pre_cost_fabric_cost_dtls_id]))));
							if($booking_cons>0  && $is_sequence_validation==1)
							{
								if($itempoWiseReqQty <$booking_cons)
								{
									//echo "6**".$msg.'**'.$pre_cost_fabric_cost_dtls_id;
									echo "6**".$msg.',BookingGCons='.$booking_cons.',BudgetGCons='.$itempoWiseReqQty.',Booking No='.$booking_no.'**'.$i;
									check_table_status( $_SESSION['menu_id'],0);
									disconnect($con);die;
								}
							}
						}
					}
				}
			}
			unset($booking_cons_arr);
		}
		//check_table_status( $_SESSION['menu_id'],0); die;

		if(check_table_status( $_SESSION['menu_id'], 1)==0) { echo "15**1"; disconnect($con); die;}

		$yarnString=array(); $yarn_rate_array=array(); $yarn_color_array=array(); $yarn_sup_array=array();
		$sql_yarn_rate=sql_select("select fabric_cost_dtls_id, job_no, count_id, copm_one_id,percent_one,type_id,cons_ratio,rate,color,supplier_id from wo_pre_cost_fab_yarn_cost_dtls where  job_no =".$update_id." and status_active=1 and is_deleted=0");
		foreach($sql_yarn_rate as $row_yarn_rate)
		{
			if($row_yarn_rate[csf('count_id')]=="") $row_yarn_rate[csf('count_id')]=0;
			if($row_yarn_rate[csf('copm_one_id')]=="") $row_yarn_rate[csf('copm_one_id')]=0;
			if($row_yarn_rate[csf('percent_one')]=="") $row_yarn_rate[csf('percent_one')]=0;
			if($row_yarn_rate[csf('type_id')]=="") $row_yarn_rate[csf('type_id')]=0;
			if($row_yarn_rate[csf('cons_ratio')]=="") $row_yarn_rate[csf('cons_ratio')]=0;
			if($row_yarn_rate[csf('rate')]=="") $row_yarn_rate[csf('rate')]=0;
			if($row_yarn_rate[csf('color')]=="") $row_yarn_rate[csf('color')]=0;
			if($row_yarn_rate[csf('supplier_id')]=="") $row_yarn_rate[csf('supplier_id')]=0;

			$yarn_rate_array[$row_yarn_rate[csf('fabric_cost_dtls_id')]][$row_yarn_rate[csf('job_no')]][$row_yarn_rate[csf('count_id')]][$row_yarn_rate[csf('copm_one_id')]][$row_yarn_rate[csf('type_id')]]=$row_yarn_rate[csf('rate')];
			$yarn_color_array[$row_yarn_rate[csf('fabric_cost_dtls_id')]][$row_yarn_rate[csf('job_no')]][$row_yarn_rate[csf('count_id')]][$row_yarn_rate[csf('copm_one_id')]][$row_yarn_rate[csf('type_id')]]=$row_yarn_rate[csf('color')];
			$yarn_sup_array[$row_yarn_rate[csf('fabric_cost_dtls_id')]][$row_yarn_rate[csf('job_no')]][$row_yarn_rate[csf('count_id')]][$row_yarn_rate[csf('copm_one_id')]][$row_yarn_rate[csf('type_id')]]=$row_yarn_rate[csf('supplier_id')];

			if(isset($yarnString[$row_yarn_rate[csf('fabric_cost_dtls_id')]]))
			{
				$yarnString[$row_yarn_rate[csf('fabric_cost_dtls_id')]].= "__".$row_yarn_rate[csf('count_id')]."_".$row_yarn_rate[csf('copm_one_id')]."_".$row_yarn_rate[csf('percent_one')]."_".$row_yarn_rate[csf('type_id')]."_".$row_yarn_rate[csf('cons_ratio')];
			}
			else
			{
				$yarnString[$row_yarn_rate[csf('fabric_cost_dtls_id')]]= $row_yarn_rate[csf('count_id')]."_".$row_yarn_rate[csf('copm_one_id')]."_".$row_yarn_rate[csf('percent_one')]."_".$row_yarn_rate[csf('type_id')]."_".$row_yarn_rate[csf('cons_ratio')];
			}
		}
		unset($sql_yarn_rate);

		//print_r($yarnString);
		//die;
		//echo 1;

		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="") $wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);

		$id=return_next_id("id", "wo_pre_cost_fabric_cost_dtls", 1);
		$id1=return_next_id("id", "wo_pre_cos_fab_co_avg_con_dtls", 1);
		$wo_pre_cos_fab_co_color_dtls_id=return_next_id("id", "wo_pre_cos_fab_co_color_dtls", 1);
		$wo_pre_cost_fab_yarn_cost_dtls_id=return_next_id("id", " wo_pre_cost_fab_yarn_cost_dtls", 1);
		$wo_pre_cost_fab_yarnbreakdown_id=return_next_id("id", "wo_pre_cost_fab_yarnbreakdown", 1);

		$rIDydel=1; $rIDybdel=1; $rID_up=1; $rID1=1; $rIDConsDe1=1; $rID=1; $rID2=1; $rID3=1; $rIDStColor=1; $rID5=1; $rID_de2=1; $rID_de3=1; $flag=1;
		$rIDydel=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no=".$update_id." and status_active=1 and is_deleted=0",1);
		if($rIDydel==1 && $flag==1) $flag=1; else $flag=0;

		$rIDybdel=execute_query( "update wo_pre_cost_fab_yarnbreakdown set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where job_no=".$update_id." and status_active=1 and is_deleted=0",1);
		if($rIDybdel==1 && $flag==1) $flag=1; else $flag=0;

		$field_array="id, job_id, job_no, seq, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, avg_cons, fabric_source,source_id, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, nominated_supp, budget_on";
		$field_array_up="seq*item_number_id*body_part_id*fab_nature_id*color_type_id*lib_yarn_count_deter_id*construction*composition*fabric_description*gsm_weight*color_size_sensitive* 	avg_cons*fabric_source*source_id*rate*amount*avg_finish_cons*avg_process_loss*updated_by*update_date*status_active*is_deleted*company_id*costing_per*consumption_basis*process_loss_method*cons_breack_down*msmnt_break_down*color_break_down*yarn_breack_down*marker_break_down*width_dia_type*avg_cons_yarn*gsm_weight_yarn*plan_cut_qty*job_plan_cut_qty*is_apply_last_update*uom*body_part_type*nominated_supp";

		$field_array1="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks, body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length,	front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, inserted_by, insert_date, status_active, is_deleted";

		$field_array2="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, gmts_color_id, gmts_color, contrast_color_id";
		$field_yarn="id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, color, type_id, cons_ratio, cons_qnty, avg_cons_qnty, supplier_id, rate, amount, inserted_by, insert_date, status_active, is_deleted";

		for ($i=1;$i<=$total_row;$i++)
		{
			$seq="seq_".$i;
			$cbogmtsitem="cbogmtsitem_".$i;
			$txtbodypart="txtbodypart_".$i;
			$cbofabricnature="cbofabricnature_".$i;
			$cbocolortype="cbocolortype_".$i;
			$libyarncountdeterminationid="libyarncountdeterminationid_".$i;
            $construction="construction_".$i;
			$composition="composition_".$i;
			$fabricdescription="fabricdescription_".$i;
			$txtgsmweight="txtgsmweight_".$i;
			$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
			$txtcolor="txtcolor_".$i;
			$txtconsumption="txtconsumption_".$i;
			$cbofabricsource="cbofabricsource_".$i;
			$cbosourceid="cbosourceid_".$i;
			$cbonominasupplier="cbonominasupplier_".$i;
			$lastappidchk="lastappidchk_".$i;
			$txtrate="txtrate_".$i;
			$txtamount="txtamount_".$i;
			$txtfinishconsumption="txtfinishconsumption_".$i;
			$txtavgprocessloss="txtavgprocessloss_".$i;
			//$cbostatus="cbostatus_".$i;
			$consbreckdown="consbreckdown_".$i;
			$msmntbreackdown="msmntbreackdown_".$i;
			$updateid="updateid_".$i;
			$processlossmethod="processlossmethod_".$i;
			$colorbreackdown="colorbreackdown_".$i;
			$yarnbreackdown="yarnbreackdown_".$i;
			$consumptionbasis="consumptionbasis_".$i;
			$markerbreackdown="markerbreackdown_".$i;
			$cbowidthdiatype="cbowidthdiatype_".$i;
			$avgtxtconsumption="avgtxtconsumption_".$i;
			$avgtxtgsmweight="avgtxtgsmweight_".$i;
			$plancutqty="plancutqty_".$i;
			$jobplancutqty="jobplancutqty_".$i;
			$isclickedconsinput="isclickedconsinput_".$i;
			$oldlibyarncountdeterminationid="oldlibyarncountdeterminationid_".$i;
			$isconspopupupdate="isconspopupupdate_".$i;
			$uom="uom_".$i;
			$txtbodyparttype="txtbodyparttype_".$i;
			$budgeton="budgeton_".$i;

			$determinationid=str_replace("'","",$$libyarncountdeterminationid);
			if($determinationid=="" || $determinationid==0)
			{
				$msg="Fabric description miss match,please check properly.";
				echo "17**".$msg.',Construction='.$$construction.',Composition='.$$composition.'**'.$i;
				check_table_status( $_SESSION['menu_id'],0);
				disconnect($con);die;
			}


			$budget_grey_qty=0; $booking_qty=0;
			$booking_qty=$booking_qty_arr[str_replace("'",'',$$updateid)];

			//echo $$colorbreackdown.'TD';
			$hiddencolorsizesensitive="hiddencolorsizesensitive_".$i;
			$hiddencolorsizesensitiveId=str_replace("'","",$$hiddencolorsizesensitive);
			$cbocolorsizesensitiveId=str_replace("'","",$$cbocolorsizesensitive);

			if($hiddencolorsizesensitiveId!=$cbocolorsizesensitiveId) //Fabric Update when Booking already Loaded
			{
				$fab_mst_update_data=1;
			}
			//$lastappidchk
			$lastappidchk_id=str_replace("'","",$$lastappidchk);
			if($lastappidchk_id==1)//Last Update // Remove check
			{
				$lastappidchk_id=$lastappidchk_id;
			}
			else
			{
				$lastappidchk_id=str_replace("'","",$$isclickedconsinput);
				//$isclickedconsinput=$isclickedconsinput;
			}

			$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
			$msmn_tbreackdown=str_replace("'","",$$msmntbreackdown);
			if($msmn_tbreackdown=="") $msmn_tbreackdown=" ";

			if(str_replace("'",'',$$updateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$updateid);//
				$data_array_up[str_replace("'",'',$$updateid)] =explode("*",("".$$seq."*".$$cbogmtsitem."*".$$txtbodypart."*".$$cbofabricnature."*".$$cbocolortype."*".$$libyarncountdeterminationid."*".$$construction."*".$$composition."*".$$fabricdescription."*".$$txtgsmweight."*".$$cbocolorsizesensitive."*".$$txtconsumption."*".$$cbofabricsource."*".$$cbosourceid."*".$$txtrate."*".$$txtamount."*".$$txtfinishconsumption."*".$$txtavgprocessloss."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0*".$cbo_company_name."*".$cbo_costing_per."*".$$consumptionbasis."*".$$processlossmethod."*'".$cons_breckdown."'*'".$msmn_tbreackdown."'*".$$colorbreackdown."*".$$yarnbreackdown."*".$$markerbreackdown."*".$$cbowidthdiatype."*".$$avgtxtconsumption."*".$$avgtxtgsmweight."*".$$plancutqty."*".$$jobplancutqty."*".$lastappidchk_id."*".$$uom."*".$$txtbodyparttype."*".$$cbonominasupplier.""));

				// msmnt break down ==================================================================================================
				if(str_replace("'",'',$$isconspopupupdate)==1)
				{
					$rIDConsDe1=execute_query( "delete from wo_pre_cos_fab_co_avg_con_dtls where  pre_cost_fabric_cost_dtls_id =".$$updateid."",0);
					if ($rIDConsDe1==1 && $flag==1) { $flag=1; }
					else { echo "10**consAvgDelUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
					$msmntbreackdown_array=explode('__',str_replace("'",'',$$msmntbreackdown));
					$markerbreackdownarr=explode('_',str_replace("'",'',$$markerbreackdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						$msmntbreackdownarr=explode('_',$msmntbreackdown_array[$c]);
						$str_rep=array("+", "&", "*", "(", ")", "=","'","\r", "\n",'"','#');
						$consbreckdownarr[3]=strtoupper($consbreckdownarr[3]);
						$consbreckdownarr[12]=str_replace($str_rep,' ',$consbreckdownarr[12]);
						//if ($add_comma!=0) $data_array1 .=",";
						$data_array1="";
						if(str_replace("'",'',$$txtbodypart)*1==1)
						{
							$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".trim($consbreckdownarr[12])."','".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."',0,0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[8]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						}
						else if(str_replace("'",'',$$txtbodypart)*1==20)
						{
							$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".trim($consbreckdownarr[12])."',0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."','".$msmntbreackdownarr[8]."','".$msmntbreackdownarr[9]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						}
						else
						{
							$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".trim($consbreckdownarr[12])."',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						}
						$id1=$id1+1;

						$rID=execute_query($data_array1);
						if ($rID==1) { $flag=1; }
						else { echo "10**fabconsup-".$data_array1; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				// msmnt break down end ==================================================================================================
				// yarn break down =======================================================================================================
				if(str_replace("'",'',$$cbofabricsource)==1 && str_replace("'",'',$$yarnbreackdown)!="")//&& str_replace("'",'',$$oldlibyarncountdeterminationid)!=str_replace("'",'',$$libyarncountdeterminationid)
				{
					$yarnbreckdown_array=array();
					$counter++;
					if(str_replace("'",'',$$oldlibyarncountdeterminationid)!=str_replace("'",'',$$libyarncountdeterminationid))
					{
						$yarnbreckdown_array=explode('__',str_replace("'",'',$$yarnbreackdown));
					}
					else if(str_replace("'",'',$$oldlibyarncountdeterminationid)==str_replace("'",'',$$libyarncountdeterminationid))
					{
						$yarnbreckdown_array=explode('__',$yarnString[str_replace("'","",$$updateid)]);
					}
					if($yarnString[str_replace("'","",$$updateid)]=="" && str_replace("'",'',$$oldlibyarncountdeterminationid)==str_replace("'",'',$$libyarncountdeterminationid)){
						$yarnbreckdown_array=explode('__',str_replace("'",'',$$yarnbreackdown));
					}
					//$yarnbreckdown_array=explode('__',str_replace("'",'',$$yarnbreackdown));
					for($c=0; $c<count($yarnbreckdown_array); $c++)
					{
						$yarnbreckdownarr=explode('_',$yarnbreckdown_array[$c]);
						if(str_replace("'",'',$$cbofabricnature)==2)
						{
							$cons=def_number_format(((str_replace("'",'',$$txtconsumption)*$yarnbreckdownarr[4])/100),8,"");
							$avg_cons=def_number_format(((str_replace("'",'',$$avgtxtconsumption)*$yarnbreckdownarr[4])/100),8,"");
						}
						if(str_replace("'",'',$$cbofabricnature)==3)
						{
							$cons=def_number_format(((str_replace("'",'',$$txtgsmweight)*$yarnbreckdownarr[4])/100),8,"");
							$avg_cons=def_number_format(((str_replace("'",'',$$avgtxtgsmweight)*$yarnbreckdownarr[4])/100),8,"");
						}

						$data_array3=""; $data_array4="";

						$rate=$yarn_rate_array[str_replace("'","",$$updateid)][str_replace("'","",$update_id)][$yarnbreckdownarr[0]][$yarnbreckdownarr[1]][$yarnbreckdownarr[3]];
						$color=$yarn_color_array[str_replace("'","",$$updateid)][str_replace("'","",$update_id)][$yarnbreckdownarr[0]][$yarnbreckdownarr[1]][$yarnbreckdownarr[3]];
						$sup=$yarn_sup_array[str_replace("'","",$$updateid)][str_replace("'","",$update_id)][$yarnbreckdownarr[0]][$yarnbreckdownarr[1]][$yarnbreckdownarr[3]];
						//$amount=$avg_cons*$rate;
						$amount=$cons*$rate;


						$data_array3="INSERT INTO wo_pre_cost_fab_yarn_cost_dtls (".$field_yarn.") VALUES (".$wo_pre_cost_fab_yarn_cost_dtls_id.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$yarnbreckdownarr[0]."','".$yarnbreckdownarr[1]."','".$yarnbreckdownarr[2]."','".$color."','".$yarnbreckdownarr[3]."','".$yarnbreckdownarr[4]."','".$cons."','".$avg_cons."','".$sup."','".$rate."','".$amount."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

						$data_array4="INSERT INTO wo_pre_cost_fab_yarnbreakdown (".$field_yarn.") VALUES (".$wo_pre_cost_fab_yarnbreakdown_id.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$yarnbreckdownarr[0]."','".$yarnbreckdownarr[1]."','".$yarnbreckdownarr[2]."','".$color."','".$yarnbreckdownarr[3]."','".$yarnbreckdownarr[4]."','".$cons."','".$avg_cons."','".$sup."','".$rate."','".$amount."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

						$wo_pre_cost_fab_yarn_cost_dtls_id=$wo_pre_cost_fab_yarn_cost_dtls_id+1;
						$wo_pre_cost_fab_yarnbreakdown_id=$wo_pre_cost_fab_yarnbreakdown_id+1;

						$rID2=execute_query($data_array3);
						if ($rID2==1 && $flag==1) { $flag=1; }
						else { echo "10**yarn-".$data_array3; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }

						$rID3=execute_query($data_array4);
						if ($rID3==1 && $flag==1) { $flag=1; }
						else { echo "10**yarn2-".$data_array4; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}// end for
				}

				// yarn break down end ==================================================================================================
				// Color break down =====================================================================================================

				if(str_replace("'",'',$$colorbreackdown)!="")
				{
					$rIDStColor=execute_query( "delete from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id =".$$updateid."",0);
					if ($rIDStColor==1 && $flag==1) { $flag=1; }
					else { echo "10**stripeColorDelUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
					for($c=0;$c < count($colorbreckdown_array);$c++)
					{
						$counter++;
						$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
						// color ID
						if( str_replace("'","",$$cbocolorsizesensitive)==3)
						{
							if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]='';

							$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
							if($stripecolor_id=="") $stripecolor_id=0;
							$data_array5="";
							$data_array5="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$$updateid.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
							$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;

							$rID5=execute_query($data_array5);
							if ($rID5==1 && $flag==1) { $flag=1; }
							else { echo "10**coColorup-".$data_array5; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
						}//Sensitivity Contrast color
					}
				}
			}// Color break down end====================================// end if(str_replace("'",'',$$updateid)!="")

			if(str_replace("'",'',$$updateid)=="")
			{
				$data_array.="INTO wo_pre_cost_fabric_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",".$$seq.",".$$cbogmtsitem.",".$$txtbodypart.",".$$cbofabricnature.",".$$cbocolortype.",".$$libyarncountdeterminationid.",".$$construction.",".$$composition.",".$$fabricdescription.",".$$txtgsmweight.",".$$cbocolorsizesensitive.",".$$txtconsumption.",".$$cbofabricsource.",". $$cbosourceid.",".$$txtrate.",".$$txtamount.",".$$txtfinishconsumption.",".$$txtavgprocessloss.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0,".$cbo_company_name.",".$cbo_costing_per.",".$$consumptionbasis.",".$$processlossmethod.",'".$cons_breckdown."','".$msmn_tbreackdown."',".$$colorbreackdown.",".$$yarnbreackdown.",".$$markerbreackdown.",".$$cbowidthdiatype.",".$$avgtxtconsumption.",".$$avgtxtgsmweight.",".$$plancutqty.",".$$jobplancutqty.",".$$isclickedconsinput.",".$$uom.",".$$txtbodyparttype.",".$$cbonominasupplier.",".$$budgeton.")";
	           // $id=$id+1;
// msmnt break down=================================================================================
				$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
				$msmntbreackdown_array=explode('__',str_replace("'",'',$$msmntbreackdown));
				$markerbreackdownarr=explode('_',str_replace("'",'',$$markerbreackdown));
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					$msmntbreackdownarr=explode('_',$msmntbreackdown_array[$c]);

					$str_rep=array("+", "&", "*", "(", ")", "=","'","\r", "\n",'"','#');
					$consbreckdownarr[3]=strtoupper($consbreckdownarr[3]);
					$consbreckdownarr[12]=str_replace($str_rep,' ',$consbreckdownarr[12]);
					$data_array1="";
					if(str_replace("'",'',$$txtbodypart)*1==1)
					{
						$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".trim($consbreckdownarr[12])."','".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."',0,0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[8]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					}
					else if(str_replace("'",'',$$txtbodypart)*1==20)
					{
						$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".trim($consbreckdownarr[12])."',0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."','".$msmntbreackdownarr[8]."','".$msmntbreackdownarr[9]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					}
					else
					{
						$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".trim($consbreckdownarr[12])."',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					}
					$id1=$id1+1;
					$rID=execute_query($data_array1);
					if ($rID==1) { $flag=1; }
					else { echo "10**fabconsins-".$data_array1; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
				// msmnt break down end =================================================================================
				// Yarn break down ==================================================================================================
                if(str_replace("'",'',$$cbofabricsource)==1 && str_replace("'",'',$$yarnbreackdown)!="")
				{
					$yarnbreckdown_array=explode('__',str_replace("'",'',$$yarnbreackdown));
					for($c=0;$c < count($yarnbreckdown_array);$c++)
					{
						$counter++;
						$yarnbreckdownarr=explode('_',$yarnbreckdown_array[$c]);
						if(str_replace("'",'',$$cbofabricnature)==2)
						{
							$cons=def_number_format(((str_replace("'",'',$$txtconsumption)*$yarnbreckdownarr[4])/100),5,"");
							$avg_cons=def_number_format(((str_replace("'",'',$$avgtxtconsumption)*$yarnbreckdownarr[4])/100),5,"");
						}
						if(str_replace("'",'',$$cbofabricnature)==3)
						{
							$cons=def_number_format(((str_replace("'",'',$$txtgsmweight)*$yarnbreckdownarr[4])/100),5,"");
							$avg_cons=def_number_format(((str_replace("'",'',$$avgtxtgsmweight)*$yarnbreckdownarr[4])/100),5,"");
						}

						$data_array3=""; $data_array4="";

						$data_array3="INSERT INTO wo_pre_cost_fab_yarn_cost_dtls (".$field_yarn.") VALUES (".$wo_pre_cost_fab_yarn_cost_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",'".$yarnbreckdownarr[0]."','".$yarnbreckdownarr[1]."','".$yarnbreckdownarr[2]."',0,'".$yarnbreckdownarr[3]."','".$yarnbreckdownarr[4]."','".$cons."','".$avg_cons."',0,0,0,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

						$data_array4="INSERT INTO wo_pre_cost_fab_yarnbreakdown (".$field_yarn.") VALUES (".$wo_pre_cost_fab_yarnbreakdown_id.",".$hidd_job_id.",".$id.",".$update_id.",'".$yarnbreckdownarr[0]."','".$yarnbreckdownarr[1]."','".$yarnbreckdownarr[2]."',0,'".$yarnbreckdownarr[3]."','".$yarnbreckdownarr[4]."','".$cons."','".$avg_cons."',0,0,0,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$wo_pre_cost_fab_yarn_cost_dtls_id=$wo_pre_cost_fab_yarn_cost_dtls_id+1;
						$wo_pre_cost_fab_yarnbreakdown_id=$wo_pre_cost_fab_yarnbreakdown_id+1;

						$rID2=execute_query($data_array3);
						if ($rID2==1 && $flag==1) { $flag=1; }
						else { echo "10**yarn-".$data_array3; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }

						$rID3=execute_query($data_array4);
						if ($rID3==1 && $flag==1) { $flag=1; }
						else { echo "10**yarn2-".$data_array4; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				//echo $data_array3; die;

				// Yarn break down end ===============================================================================================
				// color break down ==================================================================================================
				if(str_replace("'",'',$$colorbreackdown)!="")
				{
					$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
					for($c=0;$c < count($colorbreckdown_array);$c++)
					{
						$counter++;
						$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);

						if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]='';
						$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
						if($stripecolor_id=="") $stripecolor_id=0;

						$data_array5="";

						$data_array5="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
						$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;

						$rID5=execute_query($data_array5);
						if ($rID5==1 && $flag==1) { $flag=1; }
						else { echo "10**coColor-".$data_array5; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				// color break down end ==========================================================
			 	$id=$id+1;
			}//if(str_replace("'",'',$$updateid)=="")
		}// end master for loop

		/*echo bulk_update_sql_statement( "wo_pre_cost_fabric_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr );

		echo "10**=";
		check_table_status( $_SESSION['menu_id'],0);
		die;*/

		$rID_up=execute_query(bulk_update_sql_statement( "wo_pre_cost_fabric_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($rID_up==1 && $flag==1) $flag=1; else $flag=0;

		if ($data_array!="")
		{
			$queryfab="INSERT ALL ".$data_array." SELECT * FROM dual";
			$rID1=execute_query($queryfab);
			if($rID1==1 && $flag==1) $flag=1; else $flag=0;
			//$rID_in=sql_insert("wo_pre_cost_fabric_cost_dtls",$field_array,$data_array,0,1);
		}

		//echo "10**".$rID_up.'-'.$rID1.'-'.$rIDConsDe1.'-'.$rID.'-'.$rID2.'-'.$rID3.'-'.$rIDStColor.'-'.$rID5.'-'.$rIDydel.'-'.$rIDybdel.'-'.$flag;  check_table_status( $_SESSION['menu_id'],0); die;
		//$rIDydel=1; $rIDybdel=1; $rID_up=1; $rID1=1; $rIDConsDe1=1; $rID=1; $rID2=1; $rID3=1; $rIDStColor=1; $rID5=1;

		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array5="id, job_id, job_no, fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg, fab_woven_fin_req_yds, fab_knit_fin_req_kg, fab_amount, avg, pro_woven_grey_fab_req_yds, pro_knit_grey_fab_req_kg, pro_woven_fin_fab_req_yds, pro_knit_fin_fab_req_kg, pur_woven_grey_fab_req_yds, pur_knit_grey_fab_req_kg, pur_woven_fin_fab_req_yds, pur_knit_fin_fab_req_kg, woven_amount, knit_amount";
			$data_array5="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$tot_yarn_needed.",".$txtwoven_sum.",".$txtknit_sum.",".$txtwoven_fin_sum.",".$txtknit_fin_sum.",".$txtamount_sum.",".$avg.",".$txtwoven_sum_production.",".$txtknit_sum_production.",".$txtwoven_fin_sum_production.",".$txtknit_fin_sum_production.",".$txtwoven_sum_purchase.",".$txtknit_sum_purchase.",".$txtwoven_fin_sum_purchase.",".$txtknit_fin_sum_purchase.",".$txtwoven_amount_sum_purchase.",".$txtkint_amount_sum_purchase.")";
			$rID_in5=sql_insert("wo_pre_cost_sum_dtls",$field_array5,$data_array5,1);
			if($rID_in5==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array5="fab_yarn_req_kg*fab_woven_req_yds*fab_knit_req_kg*fab_woven_fin_req_yds*fab_knit_fin_req_kg*fab_amount*avg*pro_woven_grey_fab_req_yds*pro_knit_grey_fab_req_kg*pro_woven_fin_fab_req_yds*pro_knit_fin_fab_req_kg*pur_woven_grey_fab_req_yds*pur_knit_grey_fab_req_kg*pur_woven_fin_fab_req_yds*pur_knit_fin_fab_req_kg*woven_amount*knit_amount*status_active*is_deleted";
			$data_array5 ="".$tot_yarn_needed."*".$txtwoven_sum."*".$txtknit_sum."*".$txtwoven_fin_sum."*".$txtknit_fin_sum."*".$txtamount_sum."*".$avg."*".$txtwoven_sum_production."*".$txtknit_sum_production."*".$txtwoven_fin_sum_production."*".$txtknit_fin_sum_production."*".$txtwoven_sum_purchase."*".$txtknit_sum_purchase."*".$txtwoven_fin_sum_purchase."*".$txtknit_fin_sum_purchase."*".$txtwoven_amount_sum_purchase."*".$txtkint_amount_sum_purchase."*1*0";
			$rID_in5=sql_update("wo_pre_cost_sum_dtls",$field_array5,$data_array5,"job_no","".$update_id."",1);
			if($rID_in5==1 && $flag==1) $flag=1; else $flag=0;
		}
		if($fab_mst_update_data!="")
		{
			$mst_pre_field_array="update_by_fabrice*updated_by*update_date";//wo_pre_cost_mst
			$mst_pre_data_array="".$fab_mst_update_data."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";
			$rID_in6=sql_update("wo_pre_cost_mst",$mst_pre_field_array,$mst_pre_data_array,"job_no","".$update_id."",1);
			if($rID_in6==1 && $flag==1) $flag=1; else $flag=0;
		}
		// echo "10**=".$fab_mst_update_data;
		 	// check_table_status( $_SESSION['menu_id'],0); die;
		if($flag==1)
		{
			$conv_cons_update=fnc_yarn_conv_cons_update(str_replace("'",'',$cbo_company_name),str_replace("'",'',$update_id));

			//echo "10**=".$conv_cons_update;
			//check_table_status( $_SESSION['menu_id'],0); die;
			execute_query( "update wo_booking_mst set is_apply_last_update=2, ready_to_approved=2 where job_no =".$update_id." and booking_type=1 and is_approved not in (1,3) and is_short=2 ",1);

			$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
// Update End ==========================================================================================
}

function fnc_yarn_conv_cons_update($companyid,$jobno)
{
	//echo $companyid.'='.$jobno;
	$sqlpo="select a.id as JOB_ID, a.job_no AS JOB_NO, b.id AS ID, c.item_number_id AS ITEM_NUMBER_ID, c.country_id AS COUNTRY_ID, c.color_number_id AS COLOR_NUMBER_ID, c.size_number_id AS SIZE_NUMBER_ID, c.order_quantity AS ORDER_QUANTITY, c.plan_cut_qnty AS PLAN_CUT_QNTY, c.country_ship_date AS COUNTRY_SHIP_DATE, c.article_number AS ARTICLE_NUMBER, d.costing_per_id AS COSTING_PER from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_dtls d where a.id=b.job_id and b.id=c.po_break_down_id and a.id=d.job_id and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 and a.job_no='$jobno'";
	//echo $sqlpo; die; //and a.job_no='$job_no'
	$sqlpoRes = sql_select($sqlpo);
	//print_r($sqlpoRes);
	$po_arr=array(); $poColorArr=array(); $reqQtyAmtArr=array(); $costingPerArr=array();
	foreach($sqlpoRes as $row)
	{
		$costingPerQty=0;
		if($row['COSTING_PER']==1) $costingPerQty=12;
		elseif($row['COSTING_PER']==2) $costingPerQty=1;
		elseif($row['COSTING_PER']==3) $costingPerQty=24;
		elseif($row['COSTING_PER']==4) $costingPerQty=36;
		elseif($row['COSTING_PER']==5) $costingPerQty=48;
		else $costingPerQty=0;

		$costingPerArr[$row['JOB_ID']]=$costingPerQty;

		$po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty']+=$row['ORDER_QUANTITY'];
		$po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty']+=$row['PLAN_CUT_QNTY'];

		$poColorArr[$row['COLOR_NUMBER_ID']]['poqty']+=$row['ORDER_QUANTITY'];
		$poColorArr[$row['COLOR_NUMBER_ID']]['planqty']+=$row['PLAN_CUT_QNTY'];

	}
	unset($sqlpoRes);

	$gmtsitemRatioSql="select a.job_id AS JOB_ID, a.gmts_item_id AS GMTS_ITEM_ID, a.set_item_ratio AS SET_ITEM_RATIO from wo_po_details_mas_set_details a where 1=1 and a.job_no='$jobno'";
	//echo $gmtsitemRatioSql; die;
	$gmtsitemRatioSqlRes = sql_select($gmtsitemRatioSql);
	$jobItemRatioArr=array();
	foreach($gmtsitemRatioSqlRes as $row)
	{
		$jobItemRatioArr[$row['JOB_ID']][$row['GMTS_ITEM_ID']]=$row['SET_ITEM_RATIO'];
	}
	unset($gmtsitemRatioSqlRes);

	$sqlContrast="select a.pre_cost_fabric_cost_dtls_id as PRECOSTID, a.gmts_color_id as COLOR_NUMBER_ID, a.contrast_color_id AS CONTRAST_COLOR_ID from wo_pre_cos_fab_co_color_dtls a where 1=1 and a.status_active=1 and a.is_deleted=0 and a.job_no='$jobno'";
	//echo $sqlContrast; die;
	$sqlContrastRes = sql_select($sqlContrast);
	$sqlContrastArr=array();
	foreach($sqlContrastRes as $row)
	{
		$sqlContrastArr[$row['PRECOSTID']][$row['COLOR_NUMBER_ID']]=$row['CONTRAST_COLOR_ID'];
	}
	unset($sqlContrastRes);

	//Stripe Details
	$sqlStripe="select a.pre_cost_fabric_cost_dtls_id as PRECOSTID, a.po_break_down_id as POID, a.item_number_id AS ITEM_NUMBER_ID, a.color_number_id as COLOR_NUMBER_ID, a.stripe_color as STRIPE_COLOR, a.size_number_id as SIZE_NUMBER_ID, a.fabreq as FABREQ, a.fabreqtotkg as FABREQKG from wo_pre_stripe_color a where 1=1 and a.status_active=1 and a.is_deleted=0 and a.yarn_dyed=1 and a.job_no='$jobno'";
	//echo $sqlStripe; die;
	$sqlStripeRes = sql_select($sqlStripe);
	$sqlStripeArr=array();
	foreach($sqlStripeRes as $row)
	{
		$sqlStripeArr[$row['PRECOSTID']][$row['COLOR_NUMBER_ID']]['strip'][$row['STRIPE_COLOR']]=$row['STRIPE_COLOR'];
		$sqlStripeArr[$row['PRECOSTID']][$row['COLOR_NUMBER_ID']]['fabreq'][$row['STRIPE_COLOR']]=$row['FABREQ'];
	}
	unset($sqlStripeRes);

	$sqlfab="select a.job_id AS JOB_ID, a.id AS FABID, a.lib_yarn_count_deter_id as DETAID, a.item_number_id AS ITEM_NUMBER_ID, a.fab_nature_id AS FAB_NATURE_ID, a.color_type_id AS COLOR_TYPE_ID, a.fabric_source as FABRIC_SOURCE, a.color_size_sensitive AS COLOR_SIZE_SENSITIVE, a.construction AS CONSTRUCTION, a.composition as COMPOSITION, a.gsm_weight AS GSM_WEIGHT, a.uom AS UOM, a.avg_cons as AVG_CONS, b.po_break_down_id AS POID, b.color_number_id AS COLOR_NUMBER_ID, b.gmts_sizes AS SIZE_NUMBER_ID, b.dia_width as DIA_WIDTH, b.cons AS CONS, b.requirment AS REQUIRMENT, b.rate as RATE, c.id as CONVID, c.cons_process as CONSPROCESS, c.process_loss as PROCESSLOSS, c.req_qnty as REQQTY, c.avg_req_qnty as AVGREQQTY, c.charge_unit as UNITRATE, c.amount as AMOUNT, c.color_break_down as COLOR_BREAK_DOWN, c.charge_lib_id as LIBCHARGEID
	from wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_pre_cost_fab_conv_cost_dtls c
	where 1=1 and a.job_no='$jobno' and a.id=b.pre_cost_fabric_cost_dtls_id and a.id=c.fabric_description and b.cons!=0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0";
	//echo $sqlfab; die;
	$sqlfabRes = sql_select($sqlfab); $flag=1;
	if(count($sqlfabRes)>0)
	{
		$convDataArr=array(); $colorWiseReqArr=array();
		foreach($sqlfabRes as $row)
		{
			$poQty=$planQty=$costingPer=$itemRatio=$finReq=$greyReq=$finAmt=$greyAmt=0;

			$colorTypeId=$row['COLOR_TYPE_ID'];
			$colorSizeSensitive=$row['COLOR_SIZE_SENSITIVE'];
			$fabric_source=$row['FABRIC_SOURCE'];
			$fabcons=$row['AVG_CONS'];
			$colorBreakDown=$row['COLOR_BREAK_DOWN'];

			$poQty=$po_arr[$row['JOB_ID']][$row['POID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty'];
			$planQty=$po_arr[$row['JOB_ID']][$row['POID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty'];
			$costingPer=$costingPerArr[$row['JOB_ID']];
			$itemRatio=$jobItemRatioArr[$row['JOB_ID']][$row['ITEM_NUMBER_ID']];
			$isstripecontrast=0;
			//print_r($sqlStripeArr[$row['FABID']][$row['COLOR_NUMBER_ID']]['strip']);
			if(!empty($sqlStripeArr[$row['FABID']][$row['COLOR_NUMBER_ID']]['strip']))
			{
				foreach($sqlStripeArr[$row['FABID']][$row['COLOR_NUMBER_ID']]['strip'] as $fabcolor)
				{
					$cons=$greyReq=0;
					$cons=$sqlStripeArr[$row['FABID']][$row['COLOR_NUMBER_ID']]['fabreq'][$fabcolor];
					$greyReq=($planQty/$itemRatio)*($cons/$costingPer);
					//echo $planQty.'='.$itemRatio.'='.$cons.'='.$costingPer.'<br>';
					//$greyReq=$greyReq*$row['RATE'];
					$isstripecontrast=1;
					$reqQtyAmtArr[$row['CONVID']][$fabcolor]['grey_qty']+=$greyReq;
				}
			}
			else if ($sqlContrastArr[$row['JOB_ID']][$row['FABID']][$row['COLOR_NUMBER_ID']]!="" && $row['COLOR_SIZE_SENSITIVE']==3)
			{
				$cons=$greyReq=0;
				$fabcolor=$sqlContrastArr[$row['JOB_ID']][$row['FABID']][$row['COLOR_NUMBER_ID']];
				$greyReq=($planQty/$itemRatio)*($row['REQUIRMENT']/$costingPer);
				$isstripecontrast=2;
				$reqQtyAmtArr[$row['CONVID']][$fabcolor]['grey_qty']+=$greyReq;
			}
			else
			{
				$greyReq=0;
				$greyReq=($planQty/$itemRatio)*($row['REQUIRMENT']/$costingPer);
				$isstripecontrast=0;
				$reqQtyAmtArr[$row['CONVID']][$row['COLOR_NUMBER_ID']]['grey_qty']+=$greyReq;
			}

			$avgCons=$fabcons-($fabcons*($row['PROCESSLOSS']/100));
			$convAmount=$avgCons*$row['UNITRATE'];

			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['fabid']=$row['FABID'];
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['rate']=$row['UNITRATE'];
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['cons']=$fabcons;
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['avgcons']=$avgCons;
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['amount']=$convAmount;
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['colordata']=$colorBreakDown;
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['isstripecontrast']=$isstripecontrast;
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['costingper']=$costingPer;
			$convDataArr[$row['CONVID']][$row['CONSPROCESS']]['ratio']=$itemRatio;
		}
		unset($sqlfabRes);
		/*echo "<pre>";
		print_r($reqQtyAmtArr[36594]);
		oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;*/

		$convColor="select id as ID, fabric_cost_dtls_id as FABID, conv_cost_dtls_id as CONVID, job_no as JOBNO, job_id as JOBID, convchargelibraryid as LIBCHARGEID, gmts_color_id as GMTCOLOR, fabric_color_id as FABCOLOR, cons as CONS, unit_charge as UNITRATE from wo_pre_cos_conv_color_dtls where status_active=1 and is_deleted=0 and job_no='$jobno'";

		$convColorRes=sql_select($convColor); $convColorArr=array();
		foreach($convColorRes as $cvrow)
		{
			$convColorArr[$cvrow['CONVID']][$cvrow['GMTCOLOR']][$cvrow['FABCOLOR']][$cvrow['ID']]=$cvrow['CONS'];
		}
		//print_r($convColorArr);

		$convUpdateArr=array(); $convColorRowArr=array(); $m=0;
		foreach($convDataArr as $conid=>$condata)
		{
			foreach($condata as $processid=>$processdata)
			{
				$colorbreakstr="";
				/*if($processdata['colordata']!="")
				{*/
					foreach($convColorArr[$conid] as $gcolor=>$gcolordata)
					{
						foreach($gcolordata as $fcolor=>$fcolordata)
						{
							foreach($fcolordata as $colorrowid=>$colorrowdata)
							{
								if($processdata['isstripecontrast']==1 || $processdata['isstripecontrast']==2) $colorid=$fcolor; else $colorid=$gcolor;

								$colorreq=($reqQtyAmtArr[$conid][$colorid]['grey_qty']/$poColorArr[$gcolor]['planqty'])*$processdata['costingper']*$processdata['ratio'];
								$m=1;
								$convColorRowArr[$conid][$colorrowid]=fn_number_format($colorreq,6,'.','');
							}
						}
					}

					$colorBreakDown=$processdata['colordata'];
					if($colorBreakDown !="")
					{
						$arr_1=explode("__",$colorBreakDown);
						for($ci=0; $ci<count($arr_1); $ci++)
						{
							$arr_2=explode("_",$arr_1[$ci]);

							if($processdata['isstripecontrast']==1 || $processdata['isstripecontrast']==2) $colorid=$arr_2[3]; else $colorid=$arr_2[0];

							$colorreq=($reqQtyAmtArr[$conid][$colorid]['grey_qty']/$poColorArr[$arr_2[0]]['planqty'])*$processdata['costingper']*$processdata['ratio'];
							if($colorreq=="") $colorreq=0;

							// if($conid==36594) echo $colorreq.'='.$reqQtyAmtArr[$conid][$colorid]['grey_qty'].'='.$poColorArr[$arr_2[0]]['planqty'].'='.$processdata['costingper'].'='.$processdata['ratio'].'<br>';

							//if($colorbreakstr=="") $colorbreakstr=$arr_2[0].'_'.$arr_2[1].'_'.$arr_2[2].'_'.$arr_2[3].'_'.fn_number_format($colorreq,4,'.','');
							//else $colorbreakstr.='__'.$arr_2[0].'_'.$arr_2[1].'_'.$arr_2[2].'_'.$arr_2[3].'_'.fn_number_format($colorreq,4,'.','');
							if(fn_number_format($colorreq,6,'.','')>0)
							{
								if($colorbreakstr=="") $colorbreakstr=($arr_2[0]*1).'_'.fn_number_format($arr_2[1],6,'.','').'_'.($arr_2[2]*1).'_'.($arr_2[3]*1).'_'.fn_number_format($colorreq,4,'.','');
								else $colorbreakstr.='__'.($arr_2[0]*1).'_'.fn_number_format($arr_2[1],6,'.','').'_'.($arr_2[2]*1).'_'.($arr_2[3]*1).'_'.fn_number_format($colorreq,4,'.','');
							}
						}
					}
				//}

				$convUpdateArr[$conid]['cons']=fn_number_format($processdata['cons'],4,'.','');
				$convUpdateArr[$conid]['avgcons']=fn_number_format($processdata['avgcons'],4,'.','');
				$convUpdateArr[$conid]['amount']=fn_number_format($processdata['amount'],4,'.','');
				$convUpdateArr[$conid]['colordata']=$colorbreakstr;
			}
		}

		/*echo "<pre>";
		print_r($convColorRowArr[36594]);
		oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con);
		die;*/
		global $pc_date_time;
		$convFieldArrUp="req_qnty*avg_req_qnty*amount*color_break_down*updated_by*update_date";
		$convColorFieldArrUp="cons*updated_by*update_date";
		$convDataArrayUp=array(); $convColorDataArrayUp=array();
		foreach($convUpdateArr as $cvid=>$cvdata)
		{
			$cons_breckdown=substr(str_replace("'","",$cvdata['colordata']),0,3999);
			$convDataArrayUp[$cvid]=explode("*",("'".$cvdata['cons']."'*'".$cvdata['avgcons']."'*'".$cvdata['amount']."'*'".$cons_breckdown."'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'"));
			$tmpconvid[]=$cvid;

			foreach($convColorRowArr[$cvid] as $conv_colorrowid=>$convrowdata)
			{
				//echo $conv_colorrowid.'='.print_r($convrowdata).'<br>';
				$convColorDataArrayUp[$conv_colorrowid]=explode("*",("'".$convrowdata."'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'"));
				$convcoloridarr[]=$conv_colorrowid;
			}
		}
		$flag=1;
		//echo "10**";
		//print_r($convColorDataArrayUp);
		//$con = connect();
		if(count($convDataArrayUp)>0 && $flag==1)
		{
			//echo bulk_update_sql_statement("wo_pre_cost_fab_conv_cost_dtls", "id",$convFieldArrUp,$convDataArrayUp,$tmpconvid );
			$rIDcon=execute_query(bulk_update_sql_statement("wo_pre_cost_fab_conv_cost_dtls", "id",$convFieldArrUp,$convDataArrayUp,$tmpconvid ));
			if($rIDcon==1) $flag=1; //else $flag=0;
			else if($rIDcon==0)
			{
				$flag=0;
				oci_rollback($con);
				echo "10**conv**"; check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
			}
		}

		if($m==1 && $flag==1 && count($convColorDataArrayUp)>0)
		{
			//echo bulk_update_sql_statement("wo_pre_cos_conv_color_dtls", "id",$convColorFieldArrUp,$convColorDataArrayUp,$convcoloridarr );
			$rIDconvColor=execute_query(bulk_update_sql_statement("wo_pre_cos_conv_color_dtls", "id",$convColorFieldArrUp,$convColorDataArrayUp,$convcoloridarr ));
			if($rIDconvColor==1) $flag=1; //else $flag=0;
			else if($rIDconvColor==0)
			{
				$flag=0;
				oci_rollback($con);
				echo "10**convColor**"; check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
			}
		}
		//die;
	}
}

if ($action=="save_update_delet_fabric_yarn_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
	if($component_approved==3){
		$component_approved=1;
	}
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	/*$sqlPurReq=sql_select("select a.requ_no, b.count_id, b.composition_id, b.com_percent, b.yarn_type_id from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no=$update_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	//echo "10**select a.requ_no from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no=$update_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0"; die;
	$purReqArr=array();

	foreach($sqlPurReq as $prow)
	{
		//$purReqArr[$prow[csf('count_id')]][$prow[csf('composition_id')]][$prow[csf('com_percent')]][$prow[csf('yarn_type_id')]]=$prow[csf('requ_no')];
		$purReqArr[$prow[csf('requ_no')]]=$prow[csf('requ_no')];
	}

	if(implode(",",$purReqArr)!="")
	{
		echo "purReq**".implode(",",$purReqArr);
		disconnect($con);die;
	}*/
	for ($i=1; $i<=$total_row; $i++)
	{
		$cbocount="cbocount_".$i;
		$cbocompone="cbocompone_".$i;
		$percentone="percentone_".$i;
		$cbotype="cbotype_".$i;
		$txtrateyarn="txtrateyarn_".$i;

		/*$purReqNo=$purReqArr[str_replace("'","",$$cbocount)][str_replace("'","",$$cbocompone)][str_replace("'","",$$percentone)][str_replace("'","",$$cbotype)];
		if($purReqNo!="" && (str_replace("'","",$$txtrateyarn)*1)>0)
		{
			echo "purReq**".$purReqNo;
			disconnect($con);die;
		}*/
		$color="color_".$i;
		$y_color=$$color;
		if(str_replace("'","",$y_color)=='0') $y_color='';
		if(str_replace("'","",$y_color)!="")
		{
			$fab_colorName=str_replace("'","",$y_color);
			$fab_colorName = trim(str_replace(array("'",'`','"',"(",")"),array("","","","[","]"), strtoupper(strip_tags($fab_colorName))));
			$fab_colorName="'".trim($fab_colorName)."'";
			$FabColorArr[$fab_colorName]=$fab_colorName;
		}
	}

	$color_nameCond="";
	if(count($FabColorArr)>0)
	{
		$color_nameCond="and color_name in(".implode(",",$FabColorArr).")";
	}

	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0 $color_nameCond", "id", "color_name");
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}

		 $id=return_next_id( "id", " wo_pre_cost_fab_yarn_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, count_id, copm_one_id, percent_one, color, type_id, yarn_finish, yarn_spinning_system, certification, cons_qnty, avg_cons_qnty, supplier_id, rate, amount, inserted_by, insert_date, status_active, is_deleted";
		 $new_array_color=array();
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocount="cbocount_".$i;
			 $cbocompone="cbocompone_".$i;
			 $percentone="percentone_".$i;
			 //$cbocomptwo="cbocomptwo_".$i;
			 //$percenttwo="percenttwo_".$i;
			 $cbotype="cbotype_".$i;
			 $cboyarnfinish="cboyarnfinish_".$i;
			 $cboyarnsnippingsystem="cboyarnsnippingsystem_".$i;
			 $cbocertification="cbocertification_".$i;
			 //$consratio="consratio_".$i;
			 $consqnty="consqnty_".$i;
			 $avgconsqnty="avgconsqnty_".$i;
			 $txtrateyarn="txtrateyarn_".$i;
			 $txtamountyarn="txtamountyarn_".$i;
			 //$cbostatusyarn="cbostatusyarn_".$i;
			 $updateidyarncost="updateidyarncost_".$i;
			 $supplier="supplier_".$i;
			 $color="color_".$i;
			 $color=$$color;

			if(str_replace("'","",$color)=='0') $color='';
			 if(str_replace("'","",$color)!="")
			 {
				 if (!in_array(str_replace("'","",$color),$new_array_color, TRUE))
				 {
					  $color_id = return_id( str_replace("'","",$color), $color_library, "lib_color", "id,color_name","158");
					  $new_array_color[$color_id]=str_replace("'","",$color);
				 }
				 else $color_id =  array_search(str_replace("'","",$color), $new_array_color);
			 }
			 else $color_id=0;

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocount.",".$$cbocompone.",".$$percentone.",".$color_id.",".$$cbotype.",'".str_replace("'", "", $$cboyarnfinish)."','".str_replace("'", "", $$cboyarnsnippingsystem)."','".str_replace("'", "", $$cbocertification)."',".$$consqnty.",".$$avgconsqnty.",".$$supplier.",".$$txtrateyarn.",".$$txtamountyarn.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$id=$id+1;

		 }
		$rID=sql_insert(" wo_pre_cost_fab_yarn_cost_dtls",$field_array,$data_array,0);
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="id, job_id, job_no, yarn_cons_qnty, yarn_amount";
			$data_array1="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsumptionyarn_sum.",".$txtamountyarn_sum.")";
			$rID1=sql_insert("wo_pre_cost_sum_dtls",$field_array1,$data_array1,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="yarn_cons_qnty*yarn_amount";
			$data_array1 ="".$txtconsumptionyarn_sum."*".$txtamountyarn_sum."";
			$rID1=sql_update("wo_pre_cost_sum_dtls",$field_array1,$data_array1,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		$field_array_up="job_no*count_id*copm_one_id*percent_one*color*type_id*yarn_finish*yarn_spinning_system*certification*cons_qnty*avg_cons_qnty*supplier_id*rate*amount*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, count_id, copm_one_id, percent_one, color, type_id, yarn_finish, yarn_spinning_system, certification, cons_qnty, avg_cons_qnty, supplier_id, rate, amount, inserted_by, insert_date, status_active, is_deleted";
		$new_array_color=array();
		$add_comma=0;
		$id=return_next_id( "id", " wo_pre_cost_fab_yarn_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocount="cbocount_".$i;
			 $cbocompone="cbocompone_".$i;
			 $percentone="percentone_".$i;
			 //$cbocomptwo="cbocomptwo_".$i;
			 //$percenttwo="percenttwo_".$i;
			 $cbotype="cbotype_".$i;
			 $cboyarnfinish="cboyarnfinish_".$i;
			 $cboyarnsnippingsystem="cboyarnsnippingsystem_".$i;
			 $cbocertification="cbocertification_".$i;

			 $consqnty="consqnty_".$i;
			 $avgconsqnty="avgconsqnty_".$i;
			 $txtrateyarn="txtrateyarn_".$i;
			 $txtamountyarn="txtamountyarn_".$i;
			 $cbostatusyarn="cbostatusyarn_".$i;
			 $updateidyarncost="updateidyarncost_".$i;
			 $supplier="supplier_".$i;
			 $color="color_".$i;
			 $color=$$color;

			if(str_replace("'","",$color)=='0') $color='';
			 if(str_replace("'","",$color)!="")
			 {
				 if (!in_array(str_replace("'","",$color),$new_array_color, TRUE))
				 {
					  $color_id = return_id( str_replace("'","",$color), $color_library, "lib_color", "id,color_name","158");
					  $new_array_color[$color_id]=str_replace("'","",$color);
				 }
				 else $color_id =  array_search(str_replace("'","",$color), $new_array_color);
			 }
			 else $color_id=0;
			if(str_replace("'",'',$$updateidyarncost)!="")
			{
				$id_arr[]=str_replace("'",'',$$updateidyarncost);
				$data_array_up[str_replace("'",'',$$updateidyarncost)] =explode(",",("".$update_id.",".$$cbocount.",".$$cbocompone.",".$$percentone.",'".$color_id."',".$$cbotype.",'".str_replace("'", "", $$cboyarnfinish)."','".str_replace("'", "", $$cboyarnsnippingsystem)."','".str_replace("'", "", $$cbocertification)."',".$$consqnty.",".$$avgconsqnty.",".$$supplier.",".$$txtrateyarn.",".$$txtamountyarn.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0"));
			}
			if(str_replace("'",'',$$updateidyarncost)=="")
			{
				if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocount.",".$$cbocompone.",".$$percentone.",".$color_id.",".$$cbotype.",'".str_replace("'", "", $$cboyarnfinish)."','".str_replace("'", "", $$cboyarnsnippingsystem)."','".str_replace("'", "", $$cbocertification)."',".$$consqnty.",".$$avgconsqnty.",".$$supplier.",".$$txtrateyarn.",".$$txtamountyarn.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			    $id=$id+1;
			    $add_comma++;
			}
		 }
		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_fab_yarn_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 //echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
		 //echo bulk_update_sql_statement( "wo_pre_cost_fab_yarn_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr );
		 if($data_array !="")
		 {
			$rID1=sql_insert("wo_pre_cost_fab_yarn_cost_dtls",$field_array,$data_array,0);
		 }

		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id,j ob_id, job_no, yarn_cons_qnty, yarn_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsumptionyarn_sum.",".$txtamountyarn_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="yarn_cons_qnty*yarn_amount";
			$data_array2 ="".$txtconsumptionyarn_sum."*".$txtamountyarn_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
 		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}

if ($action=="save_update_delet_fabric_conversion_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
	if($component_approved==3){
		$component_approved=1;
	}
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}

		 $id=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, charge_unit, amount, color_break_down,color_break_down_aop, charge_lib_id, inserted_by, insert_date, status_active, is_deleted";

		$field_array_dtls="id, job_id,job_no,fabric_cost_dtls_id,conv_cost_dtls_id,convchargelibraryid,gmts_color_id,fabric_color_id ,cons,unit_charge,inserted_by, insert_date, status_active, is_deleted";

		 $add_comma=0;
		 $id1=return_next_id( "id", "wo_pre_cos_conv_color_dtls", 1);
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocosthead="cbocosthead_".$i;
			 $cbotypeconversion="cbotypeconversion_".$i;
			 $txtprocessloss="txtprocessloss_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtavgreqqnty="txtavgreqqnty_".$i;
			 $txtchargeunit="txtchargeunit_".$i;
			 $txtamountconversion="txtamountconversion_".$i;
			 $cbostatusconversion="cbostatusconversion_".$i;
			 $updateidcoversion="updateidcoversion_".$i;
			 $colorbreakdown="colorbreakdown_".$i;
			 $colorbreakdownaop="colorbreakdownaop_".$i;
			 $coversionchargelibraryid="coversionchargelibraryid_".$i;

			 $cons_breckdown=substr(str_replace("'","",$$colorbreakdown),0,3999);
			 $cons_breckdown_aop=substr(str_replace("'","",$$colorbreakdownaop),0,3999);

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",'".$cons_breckdown."','".$cons_breckdown_aop."',".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0)";

			//	===========Color Wise CONS break down=========================================

			if(str_replace("'",'',$$colorbreakdown) !='')
			{

				$consbreckdown_array=explode('__',str_replace("'",'',$$colorbreakdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

					//$field_array1="id, job_id,job_no,fabric_cost_dtls_id,conv_cost_dtls_id,convchargelibraryid,gmts_color_id,fabric_color_id ,cons,unit_charge,inserted_by, insert_date";
					if ($add_comma!=0) $data_array_dtls .=",";
					$data_array_dtls .="(".$id1.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",'".$id."','".$consbreckdownarr[2]."','".$consbreckdownarr[0]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[1]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

					$id1=$id1+1;
					$add_comma++;
				}
			}

			$id=$id+1;
		 }

		 $rID=sql_insert("wo_pre_cost_fab_conv_cost_dtls",$field_array,$data_array,0);

		 if($data_array_dtls!="")
		 {
		 $rID2=sql_insert("wo_pre_cos_conv_color_dtls",$field_array_dtls,$data_array_dtls,0);
		 }
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="id, job_id, job_no, conv_req_qnty, conv_charge_unit, conv_amount";
			$data_array1="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconreqnty_sum.",".$txtconchargeunit_sum.",".$txtconamount_sum.")";
			$rID1=sql_insert("wo_pre_cost_sum_dtls",$field_array1,$data_array1,1);
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="conv_req_qnty*conv_charge_unit*conv_amount";
			$data_array1 ="".$txtconreqnty_sum."*".$txtconchargeunit_sum."*".$txtconamount_sum."";
			$rID1=sql_update("wo_pre_cost_sum_dtls",$field_array1,$data_array1,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1";disconnect($con); die;}
		$field_array_up ="job_no*fabric_description*cons_process*process_loss*is_apply_last_update*req_qnty*avg_req_qnty*charge_unit*amount*color_break_down*color_break_down_aop*charge_lib_id*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, charge_unit, amount, color_break_down,color_break_down_aop, charge_lib_id, inserted_by, insert_date, status_active, is_deleted";

		$field_array1="id, job_id,job_no,fabric_cost_dtls_id,conv_cost_dtls_id,convchargelibraryid,gmts_color_id,fabric_color_id ,cons,unit_charge,inserted_by, insert_date";

		$add_comma=0;$add_comma2=0;
		$id=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 ) ;
		$id1=return_next_id( "id", "wo_pre_cos_conv_color_dtls", 1);
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocosthead="cbocosthead_".$i;
			 $cbotypeconversion="cbotypeconversion_".$i;
			 $txtprocessloss="txtprocessloss_".$i;
			 $lastappidchk="lastappidchk_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtavgreqqnty="txtavgreqqnty_".$i;
			 $txtchargeunit="txtchargeunit_".$i;
			 $txtamountconversion="txtamountconversion_".$i;
			 $cbostatusconversion="cbostatusconversion_".$i;
			 $updateidcoversion="updateidcoversion_".$i;
			 $colorbreakdown="colorbreakdown_".$i;
			 $colorbreakdownaop="colorbreakdownaop_".$i;
			 $coversionchargelibraryid="coversionchargelibraryid_".$i;
			$updateidcoversionId=str_replace("'",'',$$updateidcoversion);

			$cbotypeconversionId=str_replace("'",'',$$cbotypeconversion);

			//$lastappidchkId=str_replace("'",'',$$lastappidchk);
			$lastappidchkId=1;
			$consbreckdown='';
			if($cbotypeconversionId==30 || $cbotypeconversionId==31)
			{
				if(str_replace("'",'',$$colorbreakdown) !='')
				{
				$consbreckdown= $$colorbreakdown;
				}
				else
				{
					$consbreckdown="'".create_consbreak_down_conv($update_id,str_replace("'",'',$$hidd_job_id),str_replace("'",'',$$cbocosthead),str_replace("'",'',$$cbotypeconversion),str_replace("'",'',$$updateidcoversion))."'";
				}
			}
			$cons_breckdown_aop='';
			if($cbotypeconversionId==35)
			{
			
				if(str_replace("'",'',$$colorbreakdownaop) !='')
				{
					$cons_breckdown_aop=str_replace("'","",$$colorbreakdownaop);
				}
			}
			if(str_replace("'",'',$$updateidcoversion)!="")
			{
				$cons_breckdown=substr(str_replace("'","",$consbreckdown),0,3999);
				$cons_breckdownaop=substr(str_replace("'","",$cons_breckdown_aop),0,3999);
				

				$id_arr[]=str_replace("'",'',$$updateidcoversion);
				$data_array_up[str_replace("'",'',$$updateidcoversion)] =explode(",",("".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$lastappidchkId.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",'".$cons_breckdown."','".$cons_breckdownaop."',".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0"));


				//===========Color Wise CONS break down=========================================

				if(str_replace("'",'',$consbreckdown) !='')
				{
					$rID_de1_dtls=execute_query( "delete from wo_pre_cos_conv_color_dtls where  conv_cost_dtls_id =".$$updateidcoversion." ",0);// and  fabric_cost_dtls_id =".$$cbocosthead."

					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

						if ($add_comma2!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$updateidcoversion.",'".$consbreckdownarr[2]."','".$consbreckdownarr[0]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[1]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";

						$id1=$id1+1;
						$add_comma2++;

					}
				}

			}
			if(str_replace("'",'',$$updateidcoversion)=="")
			{
				$cons_breckdown=substr(str_replace("'","",$consbreckdown),0,3999);
				$cons_breckdownaop=substr(str_replace("'","",$cons_breckdown_aop),0,3999);

				if ($add_comma!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",'".$cons_breckdown."','".$cons_breckdownaop."',".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0)";


				//===========Color Wise CONS break down=========================================

				if(str_replace("'",'',$consbreckdown) !='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

						if ($add_comma2!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",'".$id."','".$consbreckdownarr[2]."','".$consbreckdownarr[0]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[1]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
						$id1=$id1+1;
						$add_comma2++;

					}
				}

				$id=$id+1;
				$add_comma++;
			}
		 }
		// echo "10**=insert into wo_pre_cost_fab_conv_cost_dtls (".$field_array.") values ".$data_array;
		// echo "10**".bulk_update_sql_statement( "wo_pre_cost_fab_conv_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr );
  	  // check_table_status( $_SESSION['menu_id'],0);
  		 // die;

		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_fab_conv_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID1=sql_insert("wo_pre_cost_fab_conv_cost_dtls",$field_array,$data_array,0);
		 }
		 if($data_array1!="")
		 {
			 $rID2=sql_insert("wo_pre_cos_conv_color_dtls",$field_array1,$data_array1,0);
		 }

 		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, conv_req_qnty, conv_charge_unit, conv_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconreqnty_sum.",".$txtconchargeunit_sum.",".$txtconamount_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="conv_req_qnty*conv_charge_unit*conv_amount";
			$data_array2 ="".$txtconreqnty_sum."*".$txtconchargeunit_sum."*".$txtconamount_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}

function create_consbreak_down_conv($job_no,$job_id,$cbocosthead,$cbotypeconversion,$updateidcoversion)
{
	//*wo_pre_cos_conv_color_dtls*
	$data_array=sql_select("select  a.id,b.convchargelibraryid,b.conv_cost_dtls_id,b.fabric_cost_dtls_id,b.gmts_color_id,b.fabric_color_id,b.cons,b.unit_charge from wo_pre_cost_fab_conv_cost_dtls a, wo_pre_cos_conv_color_dtls b  where a.id=b.conv_cost_dtls_id and a.fabric_description=b.fabric_cost_dtls_id  and b.job_no=$job_no and b.conv_cost_dtls_id=$updateidcoversion  and a.status_active=1 and b.status_active=1  order by a.id");

	if ( count($data_array)>0)
	{
		$cons_breck_down="";
		/* if(color_breck_down==""){
				color_breck_down=$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
			}
			else{
				color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
			}*/

		foreach( $data_array as $row )
		{
			if($cons_breck_down=="") //convchargelibraryid
			{
				$cons_breck_down.=$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
			}
			else
			{
				$cons_breck_down.="__".$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
			}
			//echo $cons_breck_down; die;
		}
		return $cons_breck_down;
	}
}

//*************************************************Fabric Cost, Yarn Cost, Coversion Cost End ***********************************************
if ($action=="load_drop_down_supplier_rate")
{
	$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
	$data=explode("_",$data);
	if($data[2]==2){
		$supplier_library_with_rate=array();
		$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.id='".$data[0]."' and b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
		foreach($sql_data_supplier_rate_sql as $sql_data_supplier_rate_row){
			$supplier_library_with_rate[$sql_data_supplier_rate_row[csf('supplier_id')]]=$supplier_library[$sql_data_supplier_rate_row[csf('supplier_id')]]."--Rate--[".$sql_data_supplier_rate_row[csf('rate')]."]";
		}
		//echo create_drop_down( "cbonominasupplier_".$data[1],90, $supplier_library_with_rate, "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$data[1].",'supplier_change')",$disabled,"" );
	}
	else if($data[2]==3){
		$supplier_library_with_rate=array();
		$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b, lib_supplier_tag_buyer c where a.id=b.mst_id and b.supplier_id=c.supplier_id and a.item_category=4 and a.id='".$data[0]."' and c.tag_buyer=$data[3] and b.rate>0 and a.status_active=1 and a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
		foreach($sql_data_supplier_rate_sql as $sql_data_supplier_rate_row){
			$supplier_library_with_rate[$sql_data_supplier_rate_row[csf('supplier_id')]]=$supplier_library[$sql_data_supplier_rate_row[csf('supplier_id')]]."--Rate--[".$sql_data_supplier_rate_row[csf('rate')]."]";
		}
		//echo create_drop_down( "cbonominasupplier_".$data[1],90, $supplier_library_with_rate, "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$data[1].",'supplier_change')",$disabled,"" );
	}
	else{
		//echo create_drop_down( "cbonominasupplier_".$data[1],90, "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1  group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$data[1].",'supplier_change')",$disabled,"" );
	}
	exit();
}

//*************************************************Trim Cost Start ***********************************************
if ($action=="show_trim_cost_listview")
{
	$data=explode("*",$data);
	$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
	$tag_buyer=return_field_value("tag_buyer as tag_buyer", "lib_supplier_tag_buyer", "tag_buyer=$data[1]","tag_buyer");
	$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
	//echo '='.$tag_buyer.'=';
	if(trim($tag_buyer)!='')
	{
		$supplier_library=return_library_array( "select a.supplier_name,a.id from lib_supplier a, lib_supplier_party_type b,lib_supplier_tag_buyer c where a.id=b.supplier_id and a.id=c.supplier_id and b.supplier_id=c.supplier_id and c.tag_buyer=$tag_buyer and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
	}
	else
	{
		$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
	}

	$trim_variable=1;
	$trim_variable_sql=sql_select( "select trim_rate from variable_order_tracking where company_name='$data[4]' and variable_list=35 order by id" );
	foreach($trim_variable_sql as $trim_variable_row)
	{
		$trim_variable=	$trim_variable_row[csf('trim_rate')];
	}

	if( $trim_variable==2) $readonly_rate="readonly"; else if( $trim_variable==3) $readonly_rate="readonly"; else $readonly_rate="";
	$component_approved=0;
	//$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=2 and job_no='$data[0]'");

	$jobid=return_field_value("job_id", "wo_pre_cost_mst","job_no='$data[0]' and status_active =1 and is_deleted=0");

	$sql=sql_select("select approved as approved from precost_component_app_mst where cost_component_id=2 and job_id='$jobid'");
	if (count($sql)<1)
	{
		$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=2 and job_no='$data[0]'");
	}
	foreach($sql as $row){
		if($row[csf('approved')]==1)
		{
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved.</p></marquee>";
		}
		else if($row[csf('approved')]==3)
		{
			$component_approved=3; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Partially Approved.</p></marquee>";
		}
	}

	$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
	if($approved==3) $approved=1;

	if($approved==1 || $component_approved==1)
	{
		$disabled=1; $txt_disabled="disabled";
	}
	else
	{
		$disabled=0; $txt_disabled="";
	}


	//echo $txt_disabled.'='.$component_approved;
	?>
	<h3 align="left" class="accordion_h">+Trim Cost <? echo $approved_message; ?></h3>
       <div id="content_trim_cost"  align="center">
    	<fieldset>
        <input type="hidden" id="trim_rate_variable" value="<? echo $trim_variable; ?>" />
        <form id="trimccost_6" autocomplete="off">
            <table width="1580" cellspacing="0" class="rpt_table" border="0" id="tbl_trim_cost" rules="all">
                <thead>
                    <tr>
                        <th width="35">Seq.</th>
                        <th width="100">Group</th>
                        <th width="90">Country</th>
                        <th width="250">Description</th>
                        <th width="90">Brand/Sup Ref</th>
                        <th width="120">Remarks</th>
                        <th width="80">Source</th>
                        <th width="80">Material Source</th> 
                        <th width="90">Nominated Supp</th>
                        <th width="60">Cons UOM</th>
                        <th width="45">Cons/Unit Gmts</th>
                        <th width="45">Rate</th>
                        <th width="55">Amount</th>
                        <th width="55">Total Qty</th>
                        <th width="55">Total Amount</th>
                        <th width="50">Apvl Req.</th>
                        <th width="50">Image</th>
						<th width="70">Item Print</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
				<?
				$supplier_checked_arr=array();
				$sql_temp=sql_select("select a.trims_group,a.supplyer,ex_per from lib_trim_costing_temp a, lib_trim_costing_temp_dtls b where  a.id=b.lib_trim_costing_temp_id and b.buyer_id in($data[1])  order by a.trims_group");
				foreach($sql_temp as $row)
				{
					if($row[csf('supplyer')]!='0')
					{
					$supplier_checked_arr[$row[csf('trims_group')]]=$row[csf('supplyer')];

					}
					if($row[csf('ex_per')]>0)
					{
						$trim_ex_per_arr[$row[csf('trims_group')]]=$row[csf('ex_per')];
					}
				}
				//print_r($supplier_checked_arr);
				$supplier_lib_with_rate_arr=array();
				$trim_rate_attribute='';
				if($trim_variable==2)
				{
					$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and b.rate>0 and a.status_active=1 and a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
					foreach($sql_data_supplier_rate_sql as $srow)
					{
						$supplier_lib_with_rate_arr[$srow[csf('id')]][$srow[csf('supplier_id')]]=$supplier_library[$srow[csf('supplier_id')]]."--Rate--[".$srow[csf('rate')]."]";
					}
					$trim_rate_attribute = "readonly";
				}
				else if($trim_variable==3)
				{
					$trim_rate_attribute = "readonly";
					$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b, lib_supplier_tag_buyer c where a.id=b.mst_id and b.supplier_id=c.supplier_id and a.item_category=4 and c.tag_buyer=$data[1] and b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
					foreach( $sql_data_supplier_rate_sql as $srow )
					{
						$supplier_lib_with_rate_arr[$srow[csf('id')]][$srow[csf('supplier_id')]]=$supplier_library[$srow[csf('supplier_id')]]."--Rate--[".$srow[csf('rate')]."]";
					}
				}
				//echo $trim_variable.',===';
				unset($sql_data_supplier_rate_sql);

                $total_Amount=0;
                //print_r($totalamountarray_arr);
                $lib_item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");

                $save_update=1;
                $data_array=sql_select("select id, remark, job_no,source_id,is_apply_last_update, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per as excess_per, tot_cons as total_cons, rate, amount, apvl_req, nominated_supp_multi, cons_breack_down, country, calculatorstring, seq, status_active, item_print, material_source from wo_pre_cost_trim_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 order by seq");// quotation_id='$data'

				$isconsrateArr=array();
				$sqlcons=sql_select("select wo_pre_cost_trim_cost_dtls_id, rate from wo_pre_cost_trim_co_cons_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0");
				foreach($sqlcons as $crow)
				{
					if(($crow[csf('rate')]*1)>0)
					{
						$isconsrateArr[$crow[csf('wo_pre_cost_trim_cost_dtls_id')]]=1;
					}
				}
				unset($sqlcons);

				$is_booking_arr=array();
				if (count($data_array)>0)
				{
					$data_arr=sql_select("select trim_group,pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='2' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id,trim_group");
					foreach ($data_arr as $row)
					{
						$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('trim_group')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
					}
					unset($data_arr);
				}
                if(count($data_array)<1 && $data[3]==1 && $data[5]==2)//Price Quotation
                {
                    $data_array=sql_select("select id as qid, seq, quotation_id, trim_group, description, cons_uom, cons_dzn_gmts as cons, excess_per, total_cons as cons_dzn_gmts, rate, amount, apvl_req, nominated_supp as nominated_supp_multi, status_active, 0 as material_source from wo_pri_quo_trim_cost_dtls where quotation_id='$data[2]' and status_active=1 and is_deleted=0 order by seq");// quotation_id='$data'
					$trimID=""; $qcDataArr=array();
					foreach( $data_array as $trow)
					{
						if($trimID=="") $trimID=$trow[csf('trim_group')]; else $trimID.=','.$trow[csf('trim_group')];
						if($trow[csf('cons')]=="") $trow[csf('cons')]=0;
						if($trow[csf('excess_per')]=="") $trow[csf('excess_per')]=0;
						if($trow[csf('cons_dzn_gmts')]=="") $trow[csf('cons_dzn_gmts')]=0;
						if($trow[csf('rate')]=="") $trow[csf('rate')]=0;
						if($trow[csf('amount')]=="") $trow[csf('amount')]=0;
						if($trow[csf('cons_uom')]=="") $trow[csf('cons_uom')]=0;
						$qcDataArr[$trow[csf('qid')]]=$trow[csf('cons')].'__'.$trow[csf('excess_per')].'__'.$trow[csf('cons_dzn_gmts')].'__'.$trow[csf('rate')].'__'.$trow[csf('amount')].'__'.$trow[csf('cons_uom')];
					}
                    $save_update=0;
                }
				if (count($data_array)<1 && $data[3]==1)//Quick Costing
				{
					if($data[5]==1 || $data[5]==5 || $data[5]==8) //Quick Costing=1, Short Quotation V2=5, Short Quotation V6=8,
					$dataQc = sql_select("select id as qid, '' as seq, mst_id as quotation_id, particular_type_id as trim_group, description, uom as cons_uom, consumption as cons_dzn_gmts, rate, value as amount, 0 as apvl_req, 0 as nominated_supp_multi, supp_ref as sup_ref, status_active, ex_percent as excess_per, 0 as ex_cons, tot_cons as total_cons, 0 as material_source from qc_cons_rate_dtls where mst_id='$data[2]' and type=4 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
					$trimID=""; $qcDataArr=array();
					foreach( $dataQc as $trow)
					{
						if($trimID=="") $trimID=$trow[csf('trim_group')]; else $trimID.=','.$trow[csf('trim_group')];
						$qcDataArr[$trow[csf('qid')]]=$trow[csf('cons_dzn_gmts')].'__'.$trow[csf('excess_per')].'__'.$trow[csf('total_cons')].'__'.$trow[csf('rate')].'__'.$trow[csf('amount')].'__'.$trow[csf('cons_uom')];
					}

					$data_array=$dataQc;
					$save_update=0;
				}

				if(count($data_array)>0)
				{
					$i=0;
					foreach( $data_array as $row )
					{
						$i++; $cons_breack_down="";
						if($db_type==0) $cons_breack_down=$row[csf('cons_breack_down')];
						else if($db_type==2)
						{
							//if($row[csf('cons_breack_down')] !="") $cons_breack_down=$row[csf('cons_breack_down')];
						}

						$country_text="";
						$countryarr=explode(",",$row[csf("country")]);
						//print_r($countryarr);
						for($cu=0 ;$cu< count($countryarr); $cu++){
							$country_text.= $country_library[trim($countryarr[$cu])].",";
						}
						$country_text=rtrim($country_text,",");

						$seq=0;
						if($save_update==0)
						{
							if($row[csf("seq")]=="") $seq=$i; else $seq=$row[csf("seq")];
						}
						else
						{
							if($row[csf("seq")]=="") $seq=$i; else $seq=$row[csf("seq")];
						}
						$dis=0; $txt_dis='';
						if($disabled!=1)
						{
							if($is_booking_arr[$row[csf('id')]][$row[csf('trim_group')]]!="")
							{
								$dis=1; $txt_dis="disabled";
							}
							else
							{
								$dis=0; $txt_dis='';
							}
						}
						 $nominated_supp_str="";
						 //echo $trim_variable;
						 $exnominated_supp=explode("_",$row[csf('nominated_supp_multi')]);
						 foreach($exnominated_supp as $key=>$suppdata)
						 {
							if($key==0){
								$suppdataarr=explode(",",$suppdata);
								foreach($suppdataarr as $supp){
									if($trim_variable==1) { if($nominated_supp_str=="") $nominated_supp_str=$supplier_library[$supp]; else $nominated_supp_str.=','.$supplier_library[$supp]; }
									else { if($nominated_supp_str=="") $nominated_supp_str=$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; else $nominated_supp_str.=','.$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; }
								}
							}
							else{
								$comdataarr=explode(",",$suppdata);
								foreach($comdataarr as $comid){
									if($nominated_supp_str=="") $nominated_supp_str=$company_arr[$comid]; else $nominated_supp_str.=','.$company_arr[$comid];
								}
							}

						 }
						 $is_apply_last_update=$row[csf('is_apply_last_update')];
						 //echo $is_apply_last_update;
						 $msg_app=""; $changedcolor="";
						 if($is_apply_last_update==2)
						 {
							 $msg_app="Color Size Changed.";
							 $changedcolor="red";
						 }
						 $rateCellColor="";
						 if($isconsrateArr[$row[csf("id")]]!=1) $rateCellColor="RED";
						 if($row[csf('material_source')]=='' || $row[csf('material_source')]==0) $row[csf('material_source')]=2;
						 
						if($row[csf("excess_per")] != '') $excess_per = $row[csf("excess_per")]; else $excess_per=0;
						if($row[csf("ex_cons")] != '') $ex_cons = $row[csf("ex_cons")]; else $ex_cons=0;
						//if($row[csf("cons_dzn_gmts")] != '') $row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")];
						if($row[csf("total_cons")] == '') $row[csf("total_cons")] = $row[csf("cons_dzn_gmts")]; 
						
						?>
						<tr id="trim_<?=$i; ?>" align="center">
                            <td>
                           		<input type="hidden" id="cbotrimstatus_<?=$i; ?>" name="cbotrimstatus_<?=$i; ?>"  class="text_boxes" style="width:30px" value="1" />                    			<input type="text" id="seq_<?=$i; ?>" name="seq_<?=$i; ?>" class="text_boxes_numeric" style="width:30px" value="<?=$seq; ?>" <?=$txt_disabled; ?> />
                            </td>
                            <td title="<? echo $msg_app;?>" >
                                <input title="<?=$msg_app.' '.$lib_item_group_arr[$row[csf("trim_group")]]; ?>" readonly type="text" id="cbogrouptext_<?=$i; ?>" name="cbogrouptext_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:95px; background-color:<?=$changedcolor; ?>" value="<?=$lib_item_group_arr[$row[csf("trim_group")]]; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="openpopup_itemgroup(<?=$i; ?>);"/>
                                <input type="hidden" id="cbogroup_<?=$i; ?>" name="cbogroup_<?=$i; ?>" class="text_boxes" style="width:110px" value="<?=$row[csf("trim_group")]; ?>" />
                                <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px" value="<?=$row[csf("is_apply_last_update")]; ?>" /><input type="hidden" id="lastappidchk_<? echo $i; ?>" name="lastappidchk_<? echo $i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("is_apply_last_update")]; ?>" readonly  />
                            </td>
                            <td title="<?=$country_text; ?>">
                                <input  type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:80px" value="<?=$country_text; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="open_country_popup('<?=$i.'_1'; ?>');" placeholder="Browse" readonly/>
                                <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?=$row[csf("country")]; ?>" />
                            </td>
                            <td><input type="text" id="txtdescription_<?=$i; ?>" name="txtdescription_<?=$i; ?>" class="text_boxes" style="width:240px" value="<?=$row[csf("description")];  ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="trims_description_popup(<?=$i; ?>);"/></td>
                            <td><input type="text" id="txtsupref_<?=$i; ?>" name="txtsupref_<?=$i; ?>" maxlength="20" class="text_boxes" style="width:80px" value="<?=$row[csf("brand_sup_ref")]; ?>" <?=$txt_disabled; echo $txt_dis;  ?> /></td>
                            <td><input class="text_boxes" type="text" style="width:110px;" name="txtremark_<?=$i; ?>" id="txtremark_<?=$i; ?>" value="<?=$row[csf("remark")]; ?>" maxlength="500" title="Maximum 500 Character" <?=$txt_disabled; echo $txt_dis; ?> /></td>
                            <td><? asort($commission_particulars); echo create_drop_down( "cbosourceid_".$i, 70, $commission_particulars, "", 1, "-Select-", $row[csf("source_id")], "",$disabled,"" ); ?></td>
							<td>
	                        <? 
								asort($fabric_source);
	                            echo create_drop_down( "cbomaterialsource_".$i, 80, $fabric_source, "", 0, "", $row[csf('material_source')], "",$sourceDis,"2,3,4,5" );
	                        ?>
	                       </td>
                            <td id="tdsupplier_<?=$i; ?>">
                            <input readonly type="text" id="txtnominasupplier_<?=$i; ?>" name="txtnominasupplier_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:80px" value="<?=$nominated_supp_str; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="fncopenpopup_trimsupplier(<?=$i; ?>);"/>
                            <input type="hidden" id="cbonominasupplier_<?=$i; ?>" name="cbonominasupplier_<?=$i; ?>" class="text_boxes" style="width:110px" value="<?=$row[csf("nominated_supp_multi")]; ?>" />
                            </td>
                            <td><? echo create_drop_down( "cboconsuom_".$i, 60, $unit_of_measurement,"", 1, "-- Select --", $row[csf("cons_uom")], "",1,"" ); ?></td>
                            <td><input type="text" id="txtconsdzngmts_<?=$i; ?>" name="txtconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:40px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_trim_cost(<?=$i; ?>;)" onDblClick="set_session_large_post_data_trim( 'requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form', '<?=$i; ?>');" readonly/>
                            <input type="hidden" id="txtexper_<?=$i; ?>" name="txtexper_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$qcDataArr[$row[csf('qid')]]; ?>" readonly  />
                            </td>
                            <td>
                            	<input type="text" id="txttrimrate_<?=$i; ?>" name="txttrimrate_<?=$i; ?>" class="text_boxes_numeric" style="width:40px; background-color:<?=$rateCellColor;?>" value="<?=$row[csf("rate")]; ?>" onChange="calculate_trim_cost(<?=$i;?>);" disabled onDblClick="trim_rate_popup(<?=$i; ?>);" />
                                <input type="hidden" name="excessper_<?=$i; ?>" id="excessper_<?=$i; ?>" value="<?=$row[csf("excess_per")]; ?>">
                            	<input type="hidden" name="totalcons_<?=$i; ?>" id="totalcons_<?=$i; ?>" value="<?=$row[csf("total_cons")]; ?>">
                            </td>
                            <td><input type="text" id="txttrimamount_<? echo $i; ?>" name="txttrimamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? echo $row[csf("amount")]; ?>" readonly /></td>
                            <td>
                            <? $total_qty+=$totalqtyarray_arr[$data[0]][$row[csf("id")]]; ?>
                            <input type="text" id="totalqty_<? echo $i; ?>"  name="totalqty_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? //echo fn_number_format($totalqtyarray_arr[$data[0]][$row[csf("id")]],4,".","");  ?>"  readonly placeholder="click to load" onClick="loadTotal(<? echo $i; ?>,'trim');"  />
                            </td>
                            <td>
								<? $total_Amount+=$totalamountarray_arr[$data[0]][$row[csf("id")]]; ?>
                                <input type="text" id="totalamount_<? echo $i; ?>"  name="totalamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? //echo fn_number_format($totalamountarray_arr[$data[0]][$row[csf("id")]],4,".","");  ?>" readonly  />
                            </td>
                            <td><? echo create_drop_down( "cboapbrequired_".$i, 50, $yes_no,"", 0, "0", $row[csf("apvl_req")], '',$disabled,'' ); ?></td>
                            <td><input type="button" class="image_uploader" style="width:50px" id="btnimg_<? echo $i; ?>" value="IMG" onClick="file_uploader ( '../../', '<? echo $row[csf("id")]; ?>','', 'pre_cost_trimsv2', 0 ,1)" />
                            </td>
							<td><?=create_drop_down( "cboitemprint_".$i, 70, $itemPrintArr,"", 1, "-Select-", $row[csf("item_print")], '',$disabled,'' ); ?></td>
                            <td>
                                <input type="button" id="increasetrim_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(<? echo $i; ?> )" <? if($approved==1 || $component_approved==1) {echo "disabled";} else {echo "";}?> <?// echo $txt_disabled; echo $txt_dis; ?> />
                                <input type="button" id="decreasetrim_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_trim_cost',this );" <? echo $txt_disabled; echo $txt_dis; ?> />

                                <input type="hidden" id="updateidtrim_<? echo $i; ?>" name="updateidtrim_<? echo $i; ?>" class="text_boxes" style="width:20px" value="<? echo $row[csf("id")]; ?>"  />
                                <input type="hidden" id="consbreckdown_<? echo $i; ?>" name="consbreckdown_<? echo $i; ?>" class="text_boxes" style="width:20px" value="<? //echo  $cons_breack_down; ?>" />
                                <input type="hidden" id="calculatorstring_<? echo $i; ?>" name="calculatorstring_<? echo $i; ?>" class="text_boxes" style="width:20px" value="<? echo $row[csf("calculatorstring")]; ?>"  />
                            </td>
						</tr>
						<?
					}
				}
				else
				{
					$gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no='$data[0]'");
					foreach($gmts_item_sql as $gmts_item_row){
						$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]]=$gmts_item_row[csf('set_item_ratio')];
					}

					$totitem=count($item_ratio_arr);
					$trim_rate_from_library=return_library_array( "select a.id, max(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 group by a.id", "id", "rate");
					$save_update=0;
					$data_array_not=sql_select("select min(a.id) as id, a.trims_group, a.cons_uom, a.sup_ref, a.cons_dzn_gmts, a.purchase_rate, a.amount, a.apvl_req, a.supplyer ,a.item_description from  lib_trim_costing_temp a, lib_trim_costing_temp_dtls b  where a.id=b.lib_trim_costing_temp_id and b.buyer_id='$data[1]' and a.status_active=1 and  a.is_deleted=0 group by a.id,a.trims_group, a.cons_uom,a.sup_ref, a.cons_dzn_gmts, a.purchase_rate, a.amount, a.apvl_req, a.supplyer,a.item_description order by a.id");
					//not used top query as per Rasel-Norban Requirement
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$rate=$trim_rate_from_library[$row[csf('trims_group')]];
							$amount=$row[csf('cons_dzn_gmts')]*$trim_rate_from_library[$row[csf('trims_group')]];
							if($rate=="" || $rate==0){
								$rate=$row[csf('purchase_rate')];
								$amount=$row[csf('amount')];
							}
							$i++;

							$nominated_supp_str="";
							 $exnominated_supp=explode(",",$supplier_checked_arr[$row[csf('trims_group')]]);
							 foreach($exnominated_supp as $supp)
							 {
								if($trim_variable==1) { if($nominated_supp_str=="") $nominated_supp_str=$supplier_library[$supp]; else $nominated_supp_str.=','.$supplier_library[$supp]; }
								else { if($nominated_supp_str=="") $nominated_supp_str=$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; else $nominated_supp_str.=','.$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; }
							 }
							?>
							<tr id="trim_1" align="center">
                                <td><input type="hidden" id="cbotrimstatus_<? echo $i; ?>" name="cbotrimstatus_<? echo $i; ?>"  class="text_boxes" style="width:30px" value="1"  />                                	<input type="text" id="seq_<? echo $i; ?>" name="seq_<? echo $i; ?>" class="text_boxes_numeric" style="width:30px" value="<? echo $i; ?>"/>
                                </td>
                                <td>
                                    <input type="text"  title= "<? echo  $lib_item_group_arr[$row[csf("trims_group")]]; ?>" readonly id="cbogrouptext_<? echo $i; ?>" placeholder="Browse"  name="cbogroup_<? echo $i; ?>" class="text_boxes" style="width:95px" value="<? echo $lib_item_group_arr[$row[csf("trims_group")]];  ?>" <? echo $txt_disabled; ?> onDblClick="openpopup_itemgroup(<? echo $i; ?>)"/>
                                    <input type="hidden" id="cbogroup_<? echo $i; ?>" name="cbogroup_<? echo $i; ?>" class="text_boxes" style="width:110px" value="<? echo $row[csf("trims_group")];  ?>" <? echo $txt_disabled; ?> />
                                    <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px" value="<?=$row[csf("is_apply_last_update")]; ?>" /><input type="hidden" id="lastappidchk_<? echo $i; ?>" name="lastappidchk_<? echo $i; ?>" class="text_boxes" style="width:10px" readonly  />

                                </td>
                                <td>
                                    <input   type="text" id="countrytext_<? echo $i; ?>"  name="countrytext_<? echo $i; ?>" class="text_boxes" style="width:80px" value="" <? echo $txt_disabled; ?> onDblClick="open_country_popup('<? echo $i.'_1'; ?>')" placeholder="Browse" readonly/>
                                    <input type="hidden" id="country_<? echo $i; ?>"  name="country_<? echo $i; ?>" class="text_boxes" style="width:75px" value="" <? echo $txt_disabled; ?> />
                                </td>
                                <td>
                                    <input type="text" id="txtdescription_<? echo $i; ?>" name="txtdescription_<? echo $i; ?>" class="text_boxes" style="width:240px" value="<? echo $row[csf("item_description")]; ?>" <? echo $txt_disabled; ?> onDblClick="trims_description_popup(<? echo $i; ?>)"/>
                                </td>
                                <td>
                                    <input type="text" id="txtsupref_<? echo $i; ?>"  name="txtsupref_<? echo $i; ?>" maxlength="20" class="text_boxes" style="width:80px" value="<? echo $row[csf("sup_ref")];  ?>" <? echo $txt_disabled; ?> />
                                </td>
                                <td><input class="text_boxes" type="text" style="width:110px;" name="txtremark_<? echo $i; ?>" id="txtremark_<? echo $i; ?>" maxlength="500" title="Maximum 500 Character" <? echo $txt_disabled; ?> /></td>

                                 <td><? asort($commission_particulars); echo create_drop_down( "cbosourceid_".$i, 70, $commission_particulars, "", 1, "-Select-", $row[csf("source_id")], "",$txt_disabled,"" ); ?></td>

                                <td id="tdsupplier_<? echo $i; ?>">
								<td>
	                            <? asort($fabric_source);
	                                echo create_drop_down( "cbomaterialsource_".$i, 80, $fabric_source, "", 0, "", 2, "",$sourceDis,"2,3,4,5" );
	                            ?>
	                            </td>
                                <input readonly type="text" id="txtnominasupplier_<?=$i; ?>" name="txtnominasupplier_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:80px" value="<?=$nominated_supp_str; ?>" <?=$txt_disabled; ?> onDblClick="fncopenpopup_trimsupplier(<?=$i; ?>);"/>
                            <input type="hidden" id="cbonominasupplier_<?=$i; ?>" name="cbonominasupplier_<?=$i; ?>" class="text_boxes" style="width:110px" value="<?=$supplier_checked_arr[$row[csf('trims_group')]]; ?>" />
                                </td>
                                <td><? echo create_drop_down( "cboconsuom_".$i, 60, $unit_of_measurement,"", 1, "-- Select --", $row[csf("cons_uom")], "",1,"" ); ?></td>
                                <td>
                                	<input type="text" id="txtconsdzngmts_<? echo $i; ?>" name="txtconsdzngmts_<? echo $i; ?>" class="text_boxes_numeric" style="width:40px" value="<? echo fn_number_format($row[csf("cons_dzn_gmts")]*$totitem,4);?>" onChange="calculate_trim_cost( <? echo $i;?> )" onDblClick="set_session_large_post_data_trim('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form','<? echo $i; ?>')" readonly/><!--onDblClick="open_calculator(<? //echo $i;?> )"-->
                          <input type="hidden" id="txtexper_<? echo $i; ?>" name="txtexper_<? echo $i; ?>" class="text_boxes" style="width:10px" readonly  />
                                </td>
                                <td>
                                	<input type="text" id="txttrimrate_<? echo $i; ?>" name="txttrimrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:40px" value="<? echo fn_number_format($rate,4);?>" onChange="calculate_trim_cost( <? echo $i;?> )" <? echo $trim_rate_attribute ?> onDblClick="trim_rate_popup(<? echo $i; ?>)"/>
                                    <input type="hidden" name="excessper_<?=$i; ?>" id="excessper_<?=$i; ?>" value="">
                            		<input type="hidden" name="totalcons_<?=$i; ?>" id="totalcons_<?=$i; ?>" value="">
                                
                                </td>
                                <td><input type="text" id="txttrimamount_<? echo $i; ?>" name="txttrimamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? echo fn_number_format($amount*$totitem,4);?>" readonly />
                                </td>
                                <td><input type="text" id="totalqty_<? echo $i; ?>" name="totalqty_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="" readonly placeholder="click to load" onClick="loadTotal(<? echo $i; ?>,'trim');"  /></td>
                                <td><input type="text" id="totalamount_<? echo $i; ?>" name="totalamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="" readonly /></td>
                                <td><? echo create_drop_down( "cboapbrequired_".$i, 50, $yes_no,"", 0, "0", $row[csf("apvl_req")], '','','' ); ?></td>
                                <td>&nbsp;</td>
								<td><?=create_drop_down( "cboitemprint_".$i, 70, $itemPrintArr,"", 1, "-Select-", $row[csf("item_print")], '',$disabled,'' ); ?></td>
                                <td>
                                    <input type="button" id="increasetrim_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(<? echo $i; ?> )" />
                                    <input type="button" id="decreasetrim_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,'tbl_trim_cost',this );" />
                                    <input type="hidden" id="updateidtrim_<? echo $i; ?>" name="updateidtrim_<? echo $i; ?>" class="text_boxes" style="width:20px" value=""  />
                                    <input type="hidden" id="consbreckdown_<? echo $i; ?>" name="consbreckdown_<? echo $i; ?>"  class="text_boxes" style="width:20px" value=""  />
                                    <input type="hidden" id="calculatorstring_<? echo $i; ?>" name="calculatorstring_<? echo $i; ?>" class="text_boxes" style="width:20px" value="" />
                                </td>
							</tr>
							<?
						}
					}
					else
					{
						$save_update=0;
						 $deFabSource=2;
						?>
						<tr id="trim_1" align="center">
                            <td><input type="hidden" id="cbotrimstatus_1" name="cbotrimstatus_1"  class="text_boxes" style="width:60px" value="1"  />                                <input type="text" id="seq_1" name="seq_1"  class="text_boxes_numeric" style="width:30px" value="1"/>
                            </td>
                            <td>
                                <input title= "<? echo  $lib_item_group_arr[$row[csf("trims_group")]]; ?>"  type="text" readonly id="cbogrouptext_1" placeholder="Browse" name="cbogroup_1" class="text_boxes" style="width:95px" value="" onDblClick="openpopup_itemgroup(1)"/>
                                <input type="hidden" id="cbogroup_1"  name="cbogroup_1" class="text_boxes" style="width:110px" value="<? //echo $row[csf("trims_group")];  ?>"  />
                                <input type="hidden" id="txtlastpdateid_1" name="txtlastpdateid_1" class="text_boxes" style="width:50px"  />
                                <input type="hidden" id="lastappidchk_1" name="lastappidchk_1" class="text_boxes" style="width:10px" readonly  />


                            </td>
                            <td>
                            <input type="text" id="countrytext_1"  name="countrytext_1" class="text_boxes" style="width:80px" value="" placeholder="Browse" <? echo $txt_disabled; ?> onDblClick="open_country_popup('1_1')" readonly/>
                            <input type="hidden" id="country_1"  name="country_1" class="text_boxes" style="width:75px" value="" <? echo $txt_disabled; ?> />
                            </td>
                            <td><input type="text" id="txtdescription_1"  name="txtdescription_1" class="text_boxes" style="width:240px" value="" <? echo $txt_disabled; ?> onDblClick="trims_description_popup(1)"/>
                            </td>
                            <td><input type="text" id="txtsupref_1"  name="txtsupref_1" maxlength="20" class="text_boxes" style="width:80px" value="" <? echo $txt_disabled; ?> />
                            </td>

                            <td><input class="text_boxes" type="text" style="width:110px;" name="txtremark_1" id="txtremark_1" maxlength="500" title="Maximum 500 Character" <? echo $txt_disabled; ?> />
                            </td>
                            <td><? asort($commission_particulars); echo create_drop_down( "cbosourceid_1", 70, $commission_particulars, "", 1, "-Select-", "", "",$txt_disabled,"" ); ?></td>
							<td>
	                        <? asort($fabric_source);
	                            echo create_drop_down( "cbomaterialsource_1", 80, $fabric_source, "", 0, "", 2, "",$sourceDis,"2,3,4,5" );
	                        ?>
	                       </td>
                            <td id="tdsupplier_<? echo $i; ?>">
							<input readonly type="text" id="txtnominasupplier_1" name="txtnominasupplier_1" class="text_boxes" placeholder="Browse" style="width:80px" value="" <? echo $txt_disabled; ?> onDblClick="fncopenpopup_trimsupplier(1);"/>
                            <input type="hidden" id="cbonominasupplier_1" name="cbonominasupplier_1" class="text_boxes" style="width:110px" value="" />
							<? //echo create_drop_down( "cbonominasupplier_1",90, $supplier_library, "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$i.",'supplier_change')",$disabled,"" ); ?>
                            </td>
                            <td><? echo create_drop_down( "cboconsuom_1", 60, $unit_of_measurement,"", 1, "-- Select --", '', "",1,"" ); ?></td>
                            <td>
                            	<input type="text" id="txtconsdzngmts_1"  name="txtconsdzngmts_1" class="text_boxes_numeric" style="width:40px" value="<? echo $row[csf("cons_dzn_gmts")];?>" onChange="calculate_trim_cost(1)"  onDblClick="set_session_large_post_data_trim('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form',1);" readonly/> <!--onDblClick="open_calculator(1)"-->
                                <input type="hidden" id="txtexper_1" name="txtexper_1" class="text_boxes" style="width:10px" readonly  />
                            </td>
                            <td>
                            	<input type="text" id="txttrimrate_1"  name="txttrimrate_1" class="text_boxes_numeric" style="width:40px" value="<? echo $row[csf("purchase_rate")];?>" onChange="calculate_trim_cost(1);" readonly onDblClick="trim_rate_popup(1);"/>
                                <input type="hidden" name="excessper_1" id="excessper_1" value="">
                            	<input type="hidden" name="totalcons_1" id="totalcons_1" value="">
                            </td>
                            <td><input type="text" id="txttrimamount_1"  name="txttrimamount_1" class="text_boxes_numeric" style="width:50px" value="<? echo $row[csf("amount")];?>"  readonly /></td>
                            <td><input type="text" id="totalqty_1"  name="totalqty_1" class="text_boxes_numeric" style="width:50px" readonly placeholder="click to load" onClick="loadTotal(<? echo $i; ?>,'trim');" /></td>
                            <td><input type="text" id="totalamount_1"  name="totalamount_1" class="text_boxes_numeric" style="width:50px" readonly /></td>
                            <td><? echo create_drop_down( "cboapbrequired_1", 50, $yes_no,"", 0, "0", $row[csf("apvl_req")], '','','' ); ?></td>
                            <td>&nbsp;</td>
							<td><?=create_drop_down( "cboitemprint_1", 70, $itemPrintArr,"", 1, "-Select-", $row[csf("item_print")], '',$disabled,'' ); ?></td>
                            <td>
                                <input type="button" id="increasetrim_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(1 )" />
                                <input type="button" id="decreasetrim_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_trim_cost',this );" />
                                <input type="hidden" id="updateidtrim_1" name="updateidtrim_1"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="consbreckdown_1" name="consbreckdown_1"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="calculatorstring_1" name="calculatorstring_1"  class="text_boxes" style="width:20px" value=""  />
                            </td>
						</tr>
						<?
					}
				}
			?>
			</tbody>

        </table>
        <table width="1580" cellspacing="0" class="rpt_table" border="0" rules="all" >
        	<tfoot>
                <tr>
					<th width="40">&nbsp;</th>
					<th width="107">&nbsp;</th>
					<th width="92">&nbsp;</th>
					<th width="252">&nbsp;</th>
					<th width="90">&nbsp;</th>
					<th width="122">&nbsp;</th>
					<th width="80">&nbsp;</th>
					<th width="80">&nbsp;</th>
					<th width="90">&nbsp;</th>
					<th width="60">Sum:</th>
                    <th width="45"><input type="text" id="txtconsdzntrim_sum"  name="txtconsdzntrim_sum" class="text_boxes_numeric" style="width:40px" readonly /></th>
                    <th width="45"><input type="text" id="txtratetrim_sum"  name="txtratetrim_sum" class="text_boxes_numeric" style="width:40px"  readonly /></th>
                    <th width="55"><input type="text" id="txttrimamount_sum"  name="txttrimamount_sum" class="text_boxes_numeric" style="width:50px"  readonly /></th>
                    <th width="55"><input type="text" id="totalqty_sum"  name="totalqty_sum" class="text_boxes_numeric" style="width:50px" readonly /></th>
                    <th width="55"><input type="text" id="totalamount_sum"  name="totalamount_sum" class="text_boxes_numeric" style="width:50px" value="<? echo fn_number_format($total_Amount ,4,".","")?>" readonly /></th>
                    <th width="50">&nbsp;</th>
                    <th width="50">&nbsp;</th>
					<th width="70">&nbsp;</th>
                    <th>&nbsp;</th>
                </tr>

            </tfoot>
        </table>
        <table width="1580" cellspacing="0" class="" border="0">
            <tr>
                <td align="center" height="16" width="100%">&nbsp;</td>
            </tr>
            <tr>
                <td align="center" width="100%" class="button_container">
                <?
                if ( count($data_array)>0)
                {
                    echo load_submit_buttons( $permission, "fnc_trim_cost_dtls", $save_update,0,"reset_form('trimccost_6','','',0)",6) ;
                }
                else
                {
                    echo load_submit_buttons( $permission, "fnc_trim_cost_dtls", $save_update,0,"reset_form('trimccost_6','','',0)",6) ;
                }
                ?>
                </td>
            </tr>
        </table>
        </form>
    </fieldset>
    </div>
	<?
    exit();
}

if($action=="openpopup_trimsupplier")
{
	echo load_html_head_contents("Nominated Supplier PopUp","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'supp_table' ).rows.length;
			tbl_row_count = tbl_row_count;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
				//js_set_value( i);
				document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
				if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + i).val());
				}
				else{
					for( var j = 0; j < selected_name.length; j++ ) {
						if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}

				}
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimsuppdata_' + i).val());
					}
					else{
						for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
						}
						selected_name.splice( j,1 );
					}
				}
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		var selected_name = new Array();
		var selected_cname = new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimsuppdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimsuppdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + ',';
			}
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );

			$('#suppdata').val( trimgroupdata );
		}
		function js_set_value_company( str ) {
			if($("#comsearch"+str).css("display") !='none'){
				if(str%2==0  ){
					toggle( document.getElementById( 'comsearch' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'comsearch' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimcsuppdata_' + str).val(), selected_cname ) == -1 ) {
					//alert($('#txttrimcsuppdata_' + str).val());
					selected_cname.push($('#txttrimcsuppdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_cname.length; i++ ) {
						if( selected_cname[i] == $('#txttrimcsuppdata_' + str).val() ) break;
					}
					selected_cname.splice( i,1 );
				}
			}
			var trimgroupcdata='';
			for( var i = 0; i < selected_cname.length; i++ ) {
				trimgroupcdata += selected_cname[i] + ',';
			}
			trimgroupcdata = trimgroupcdata.substr( 0, trimgroupcdata.length - 1 );

			$('#comsuppdata').val( trimgroupcdata );
		}


		function close_supp_data()
		{
			var s=$('#suppdata').val();
			var c=$('#comsuppdata').val();
			//alert(c+'--'+s);
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="suppdata" name="suppdata"/>
        <input type="hidden" id="comsuppdata" name="comsuppdata"/>
        <?
		//echo $cbogroup;
		$tag_buyer=return_field_value("tag_buyer as tag_buyer", "lib_supplier_tag_buyer", "tag_buyer=$buyer","tag_buyer");
		$sql_supp=sql_select("select a.id, a.supplier_name,d.rate,d.supplier_id,d.mst_id from lib_supplier a,lib_item_group_rate d where a.id=d.supplier_id and  d.rate>0 and d.mst_id=$cbogroup and d.rate>0");
		foreach($sql_supp as $row)
		{
			$supplier_chk_arr[$row[csf('id')]]=$row[csf('rate')];
		}
		if($tag_buyer!='')
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from lib_supplier a, lib_supplier_party_type b,lib_supplier_tag_buyer c where a.id=b.supplier_id and a.id=c.supplier_id and b.supplier_id=c.supplier_id and c.tag_buyer=$tag_buyer and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		else
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		$compnay_sql=sql_select(" select id, company_name from lib_company comp where status_active =1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name");
		?>
		<table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th>Company Name</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="comsupp_table">
            <tbody>
				<?
				if($nominasupplier != '')
                {
					$nominatedcomarr=explode("_", $nominasupplier);
                	$nominatedcom_arr = explode(",", $nominatedcomarr[1]);
                }
                $k=1;
                foreach($compnay_sql as $row_data)
				{
					$str="";
					$str=$row_data[csf('id')].'***'.$row_data[csf('company_name')];
					if($k%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr id="comsearch<?=$k;?>" onClick="js_set_value_company(<?=$k; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$k; ?></td>
                        <td title=""><?= $row_data[csf('company_name')]; ?>
                        	<input type="hidden" name="txttrimcsuppdata_<?=$k; ?>" id="txttrimcsuppdata_<?=$k; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
					<script type="text/javascript">
                        <?
                            if(in_array($row_data[csf('id')], $nominatedcom_arr)){
                                echo "var matchcom_data=1;\n";
                                echo "var comsequ=".$k.";\n";
                            }
                            else{
                                echo "var matchcom_data=2;\n";
                            }
                        ?>
                        if(matchcom_data==1)
                        {
							js_set_value_company(comsequ);
                        }
                    </script>
					<?
					$k++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th>Supplier Name</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="supp_table">
            <tbody>
				<?
                $i=1;
				if($nominasupplier != '')
                {
					$nominatedsupparr=explode("_", $nominasupplier);
                	$nominatedsup_arr = explode(",", $nominatedsupparr[0]);
                }
                foreach($supplier_library as $sid=>$sname)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					//echo $supplier_library2[$sid].', ';
					if($supplier_chk_arr[$sid]>0)
					{
					$str="";
					$str=$sid.'***'.$sname;
					?>
					<tr id="search<?=$i;?>" onClick="js_set_value(<?=$i; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$i; ?></td>
                        <td title="ItemRate=<?=$supplier_chk_arr[$sid];?>"><?=$sname; ?>
                        	<input type="hidden" name="txttrimsuppdata_<?=$i; ?>" id="txttrimsuppdata_<?=$i; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
                    <script type="text/javascript">
                        <?
                            if(in_array($sid, $nominatedsup_arr)){
                                echo "var match_data=1;\n";
                                echo "var sequ=".$i.";\n";
                            }
                            else{
                                echo "var match_data=2;\n";
                            }
                        ?>
                        if(match_data==1)
                        {
                           js_set_value(sequ);
                        }
                    </script>
					<?
					$i++;
					}
					if($supplier_chk_arr[$sid]<=0)
					{
					$str="";
					$str=$sid.'***'.$sname;
					?>
					<tr id="search<?=$i;?>" onClick="js_set_value(<?=$i; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$i; ?></td>
                        <td title="Rate=<?=$supplier_chk_arr[$sid];?>"><?=$sname; ?>
                        	<input type="hidden" name="txttrimsuppdata_<?=$i; ?>" id="txttrimsuppdata_<?=$i; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
                    	<script type="text/javascript">
                        <?
                            if(in_array($sid, $nominatedsup_arr)){
                                echo "var match_data=1;\n";
                                echo "var sequ=".$i.";\n";
                            }
                            else{
                                echo "var match_data=2;\n";
                            }
                        ?>
                        if(match_data==1)
                        {
                           js_set_value(sequ);
                        }
                    </script>

					<?
					$i++;
					}

                }

                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="close_supp_data();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('supp_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}

if ($action=="trims_description_popup")
{
	echo load_html_head_contents("Description","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$data=$data;
	?>
    <script>
		$( document ).ready(function() {
			document.getElementById("description").value='<? echo $data; ?>';
		});
    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form>
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="description" id="description" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"></textarea>
                    </td>
                </tr>
            </table>
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center">
                    <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="parent.emailwindow.hide();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script>
		$( "#description" ).focus();
	</script>
    </html>
    <?
	exit();
}

if($action=="load_total_qtyAmount")
{
	$exdata=explode("__",$data);
	$response=array();
	if($yarn_conv_actual_cost_dzn_calculation_change==1)//ISD-23-03433
	{
		if($exdata[1]=="Yarn" || $exdata[1]=="Conv")
		{
			$sqlpo="select a.id as JOB_ID, a.job_no AS JOB_NO, b.id AS ID, c.item_number_id AS ITEM_NUMBER_ID, c.color_number_id AS COLOR_NUMBER_ID, c.size_number_id AS SIZE_NUMBER_ID, c.order_quantity AS ORDER_QUANTITY, c.plan_cut_qnty AS PLAN_CUT_QNTY from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and b.id=c.po_break_down_id and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and a.job_no='$exdata[0]'";
			//echo $sqlpo; die;
			$sqlpoRes = sql_select($sqlpo);
			$po_arr=array(); $poCountryArr=array(); $reqQtyAmtArr=array(); $costingPerArr=array(); $jobid="";
			foreach($sqlpoRes as $row)
			{
				$po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty']+=$row['ORDER_QUANTITY'];
				$po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty']+=$row['PLAN_CUT_QNTY'];
			}
			unset($sqlpoRes);

			$sqlfab="select a.job_id AS JOB_ID, a.id AS ID, a.item_number_id AS ITEM_NUMBER_ID from wo_pre_cost_fabric_cost_dtls a where 1=1 and a.status_active=1 and a.is_deleted=0 and a.job_no='$exdata[0]'";
			$sqlfabRes = sql_select($sqlfab);
			$fabIdWiseGmtsDataArr=array();
			foreach($sqlfabRes as $row)
			{
				$fabIdWiseGmtsDataArr[$row['ID']]['item']=$row['ITEM_NUMBER_ID'];
			}
			unset($sqlfabRes);
			if($exdata[1]=="Yarn")
			{
				$sqlYarn="select a.job_id AS JOB_ID, a.pre_cost_fabric_cost_dtls_id as PRECOSTID, a.po_break_down_id as POID, a.color_number_id as COLOR_NUMBER_ID, a.gmts_sizes as SIZE_NUMBER_ID, a.cons AS CONS, a.requirment AS REQUIRMENT, b.id AS YARN_ID, b.count_id AS COUNT_ID, b.copm_one_id AS COPM_ONE_ID, b.percent_one AS PERCENT_ONE, b.type_id AS TYPE_ID, b.color AS COLOR, b.cons_ratio AS CONS_RATIO, b.cons_qnty AS CONS_QNTY, b.avg_cons_qnty AS AVG_CONS_QNTY, b.rate AS RATE, b.amount AS AMOUNT from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fab_yarn_cost_dtls b where 1=1 and a.job_id=b.job_id and a.pre_cost_fabric_cost_dtls_id=b.fabric_cost_dtls_id and a.cons!=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and a.job_no='$exdata[0]'";
				//echo $sqlYarn;
				$sqlYarnRes = sql_select($sqlYarn);
				foreach($sqlYarnRes as $row)
				{
					$poQty=$planQty=0;

					$gmtsItem=$fabIdWiseGmtsDataArr[$row['PRECOSTID']]['item'];

					$poQty=$po_arr[$row['JOB_ID']][$row['POID']][$gmtsItem][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty'];
					$planQty=$po_arr[$row['JOB_ID']][$row['POID']][$gmtsItem][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty'];

					$response['poqty'][$row['YARN_ID']]+=$poQty;
					$response['planqty'][$row['YARN_ID']]+=$planQty;
				}
				unset($sqlYarnRes);
			}
			else if($exdata[1]=="Conv")
			{
				$sqlConv="select a.job_id AS JOB_ID, a.pre_cost_fabric_cost_dtls_id AS PRECOSTID, a.po_break_down_id as POID, a.color_number_id as COLOR_NUMBER_ID, a.gmts_sizes as SIZE_NUMBER_ID, a.dia_width AS DIA_WIDTH, a.cons AS CONS, a.requirment AS REQUIRMENT, b.id AS CONVERTION_ID, b.cons_process AS CONS_PROCESS, b.req_qnty AS REQ_QNTY, b.process_loss AS PROCESS_LOSS, b.avg_req_qnty AS AVG_REQ_QNTY, b.charge_unit AS CHARGE_UNIT, b.amount as AMOUNT, b.color_break_down AS COLOR_BREAK_DOWN from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fab_conv_cost_dtls b where 1=1 and a.pre_cost_fabric_cost_dtls_id=b.fabric_description and a.cons!=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and a.job_no='$exdata[0]'";
				//echo $sqlConv; die;
				$sqlConvRes = sql_select($sqlConv);
				foreach($sqlConvRes as $row)
				{
					$poQty=$planQty=0;

					$gmtsItem=$fabIdWiseGmtsDataArr[$row['PRECOSTID']]['item'];

					$poQty=$po_arr[$row['JOB_ID']][$row['POID']][$gmtsItem][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty'];
					$planQty=$po_arr[$row['JOB_ID']][$row['POID']][$gmtsItem][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty'];

					$response['poqty'][$row['CONVERTION_ID']]+=$poQty;
					$response['planqty'][$row['CONVERTION_ID']]+=$planQty;
				}
				unset($sqlYarnRes);
			}
		}
	}

	$condition= new condition();
	if(str_replace("'","",$exdata[0]) !=''){
		$condition->job_no("='$exdata[0]'");
		//$condition->approved_no("=11");
		//$condition->po_id_in("33");
	}
	$condition->init();
	if($exdata[1]=="trim")
	{
		$trim= new trims($condition);
		//echo $trim->getQuery();
		$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
		$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
		//$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid_consAndTotcons();
		//$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid_consAndTotcons();
		//print_r($totalqtyarray_arr);
		foreach($totalqtyarray_arr as $job=>$PrecostdtlsidArr){
			foreach($PrecostdtlsidArr as $Precostdtlsid=> $value){
				$response['qty'][$Precostdtlsid]=fn_number_format($value,2,".","");
				$response['amt'][$Precostdtlsid]=fn_number_format($totalamountarray_arr[$job][$Precostdtlsid],2,".","");
			}
		}
	}
	if($exdata[1]=="fabric")
	{
		//$fabric= new fabric($condition,0,2); //0==is sweater and 2==for approval histry
		$fabric= new fabric($condition);
		//echo $fabric->getQuery();die;
		$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		//print_r($fabric_qty_arr);

		//$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
		//$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
		foreach($fabric_qty_arr['knit']['grey'] as $precostdtls_id=>$uomval){
			foreach($uomval as $uom=>$value){
				$response['qty'][$precostdtls_id]=fn_number_format($value,2,".","");
				$response['amt'][$precostdtls_id]=fn_number_format($fabric_amount_arr['knit']['grey'][$precostdtls_id][$uom],2,".","");
			}

		}
		foreach($fabric_qty_arr['woven']['grey'] as $precostdtls_id=>$uomval){
			foreach($uomval as $uom=>$value){
				$response['qty'][$precostdtls_id]=fn_number_format($value,2,".","");
				$response['amt'][$precostdtls_id]=fn_number_format($fabric_amount_arr['woven']['grey'][$precostdtls_id][$uom],2,".","");
			}
		}
	}
	if($exdata[1]=="Yarn")
	{
		$yarn= new yarn($condition);
		//echo $yarn->getQuery();
		$yarn_qty_arr=$yarn->get_By_Precostdtlsid_YarnQtyArray();
		$yarnamount_arr=$yarn->get_By_Precostdtlsid_YarnAmountArray();

		//print_r($yarn_qty_arr);
		foreach($yarn_qty_arr as $Precostdtlsid=> $value){
			$response['qty'][$Precostdtlsid]=fn_number_format($value,2,".","");
			$response['amt'][$Precostdtlsid]=fn_number_format($yarnamount_arr[$Precostdtlsid],2,".","");
		}
	}
	if($exdata[1]=="Conv")
	{
		$conversion= new conversion($condition);
		//echo $conversion->getQuery();
		$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
		$conv_qty_arr=$conversion->getQtyArray_by_conversionid();

		//print_r($conv_amount_arr);
		foreach($conv_qty_arr as $cPrecostdtlsid=> $cuomval){
			foreach($cuomval as $cuom=>$cvalue){
				//echo $uom.'=';
				$response['qty'][$cPrecostdtlsid]=fn_number_format($cvalue,2,".","");
				$response['amt'][$cPrecostdtlsid]=fn_number_format($conv_amount_arr[$cPrecostdtlsid][$cuom],2,".","");
			}
		}
	}
	echo json_encode($response);
}

if ($action=="trims_description")
{
	echo substr(return_library_autocomplete("select description from  wo_pre_cost_trim_cost_dtls where trim_group=$data and status_active=1 and is_deleted=0 group by description", "description" ), 0, -1);
}

if ($action=="set_cons_uom")
{
	//extract($_REQUEST);
	$cons_uom=return_field_value("trim_uom", "lib_item_group", "id=$data");
	echo $cons_uom; die;
}

if ($action=="rate_from_library")
{
	$data=explode("_",$data);

	$rate=0;
	if($data[1]==0 || $data[1]=="")
	{
		$trim_rate_from_library=sql_select( "select a.id, max(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.id=$data[0]  and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 group by a.id");
	}
	else
	{
		$trim_rate_from_library=sql_select( "select a.id, b.rate as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.id=$data[0] and b.supplier_id in ($data[1]) and a.item_category=4 and a.status_active=1 and a.is_deleted=0 ");
	}
	$i=0;
	foreach($trim_rate_from_library as $trim_rate_from_library_row)
	{
	    if($trim_rate_from_library_row[csf('rate')]!="")
		{
			$i++;
	    	$rate+=$trim_rate_from_library_row[csf('rate')];
		}
	}
	if($rate>0) $rate=($rate/$i)*1; else $rate=0;
	echo trim($rate); die;
}

if($action=="openpopup_itemgroup")
{
	echo load_html_head_contents("Item Group Select","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'item_table' ).rows.length;
			tbl_row_count = tbl_row_count-1;
			for( var i = 1; i <= tbl_row_count; i++ ) {
				js_set_value( i );
			}
		}
		/*function check_all_data() {
			var tbl_row_count = document.getElementById( 'item_table' ).rows.length;
			tbl_row_count = tbl_row_count;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
				//js_set_value( i);
				document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
				if( jQuery.inArray( $('#txttrimgroupdata_' + i).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimgroupdata_' + i).val());
				}
				else{
					for( var j = 0; j < selected_name.length; j++ ) {
						if( selected_name[j] == $('#txttrimgroupdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}
				var trimgroupdata='';
				for( var i = 0; i < selected_name.length; i++ ) {
					trimgroupdata += selected_name[i] + ',';
				}
				trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );
				$('#itemdata').val( trimgroupdata );
				}
				
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					if( jQuery.inArray( $('#txttrimgroupdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimgroupdata_' + i).val());
					}
					else{
						for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimgroupdata_' + i).val() ) break;
						}
						selected_name.splice( j,1 );
					}
				}
			}
		}*/

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		var selected_name = new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				//toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimgroupdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimgroupdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimgroupdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + ',';
			}
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );

			$('#itemdata').val( trimgroupdata );
		}

	/*function js_set_value(id, name)
	{
		document.getElementById('gid').value=id;
		document.getElementById('gname').value=name;
		parent.emailwindow.hide();
	}*/
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="itemdata" name="itemdata"/>
        <? $sql_tgroup=sql_select( "select id, item_name, trim_uom, order_uom,trim_type from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name"); ?>
        <table width="470" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th width="190">Item Group</th>
				<th width="50">Order Uom</th>
				<th width="70">Cons Uom</th>
                 <th >Trims Type</th>
            </thead>
        </table>
        <div style="width:470px; overflow-y:scroll; max-height:340px;" >
        <table width="450" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>
				<?
                $i=1;
                foreach($sql_tgroup as $row_tgroup)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$str="";
					$str=$row_tgroup[csf('id')].'***'.$row_tgroup[csf('item_name')].'***'.$row_tgroup[csf('trim_uom')];
					?>
					<tr id="search<? echo $i;?>" onClick="js_set_value(<? echo $i; ?>)" bgcolor="<? echo $bgcolor; ?>">
						<td width="40"><? echo $i; ?></td>
                        <td width="190"><? echo $row_tgroup[csf('item_name')]; ?>
                        	<input type="hidden" name="txttrimgroupdata_<? echo $i; ?>" id="txttrimgroupdata_<? echo $i; ?>" value="<? echo $str; ?>"/>
                        </td>
						<td width="50"><? echo $unit_of_measurement[$row_tgroup[csf('order_uom')]]; ?></td>
						<td width="70"><? echo $unit_of_measurement[$row_tgroup[csf('trim_uom')]]; ?></td>
                        <td width="">
						<p><? echo $trim_type[$row_tgroup[csf('trim_type')]]; ?> </p>
                        </td>
					</tr>
					<?
					$i++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('item_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}

if($action=="save_post_session_trim"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_trim']="";
	$_SESSION['logic_erp']['cons_breck_downn_trim']=$cons_breck_downn_trim;
	echo 1;
	die;
}

if ($action=="consumption_popup_trim")
{
  echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
  extract($_REQUEST);
  $cons_breck_downn_trim= $_SESSION['logic_erp']['cons_breck_downn_trim'];
?>
<script>
	
	function copy_value(value,field_id,i,sizecopy)
	{
		var hidd_sizeid=document.getElementById('hidd_sizeid').value;
		hiddsizeid=hidd_sizeid.split(',');
		size_length=hiddsizeid.length;
		// alert(size_length); 
		var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
		var pocolorid=document.getElementById('pocolorid_'+i).value;
		var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
		var ponoid=document.getElementById('ponoid_'+i).value;
		var pcs= (document.getElementById('pcs').value)*1;

		//var copy_val=document.getElementById('copy_val').checked;
    	//var rowCount = $('#tbl_consmption_cost tr').length-3; comment by issue-21983
		var rowCount = $('#txttotrow').val()*1;//$('#tbl_consmption_cost tr').length;
		var copy_basis=$('input[name="copy_basis"]:checked').val();
		//alert(copy_basis)
		var tot_plancut_qty=pcsgmts=plan_cut_percent=cons=avg_cons_percent=avg_cons=requirement=calculated_cons_percent=calculated_cons=amount=calculated_amount_percent=calculated_amount=0;  var sumtotcons=totReqQty=sumamount=0; var sumcons=totReqAmt=totRate=0;
		var tot_plancut_qty=pcsgmts=plan_cut_percent=cons=avg_cons_percent=requirement=calculated_cons_percent=amount=calculated_amount_percent=0;

		if(copy_basis=="no")  calculate_tot_cons(i);
		for(var j=1; j<=rowCount; j++)
		{
			var isDisabled = document.getElementById(field_id+j).disabled;
			if(isDisabled==false)
			{
				
				if(field_id=='txtitemcolor_' || field_id=='itemsizes_' || field_id=='cons_' || field_id=='exper_' || field_id=='totcons_' || field_id=='rate_' || field_id=='hidRateCalStr_' || field_id=='hidSizeRateCalStr_' || field_id=='amount_' || field_id=='place_')
				{
					if(sizecopy==1)
					{
					if(copy_basis=="no" && size_length>0){
						for(var k=0; k<=hiddsizeid.length; k++)
						{
							var sizeId=hiddsizeid[k];
							if( sizeId==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
					}
					if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
						}
						
					else if((copy_basis==1) && size_length>0){
						for(var k=0; k<=hiddsizeid.length; k++)
						{
							var sizeId=hiddsizeid[k];
							if( sizeId==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
					}
					else if(copy_basis==2 && size_length>0){
						for(var k=0; k<=hiddsizeid.length; k++)
						{
							var sizeId=hiddsizeid[k];
							if(pocolorid==document.getElementById('pocolorid_'+j).value &&  sizeId==document.getElementById('gmtssizesid_'+j).value)  document.getElementById(field_id+j).value=value;
						}
					}
					else if(copy_basis==3 && size_length>0 ){
						for(var k=0; k<=hiddsizeid.length; k++)
						{
							var sizeId=hiddsizeid[k];
							if(cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value &&  sizeId==document.getElementById('gmtssizesid_'+j).value)  document.getElementById(field_id+j).value=value;
						}
					}
					else if(copy_basis==4 && size_length>0 ){
						for(var k=0; k<=hiddsizeid.length; k++)
						{
							var sizeId=hiddsizeid[k];
							if( ponoid==document.getElementById('ponoid_'+j).value && sizeId==document.getElementById('gmtssizesid_'+j).value)  document.getElementById(field_id+j).value=value;
						}
					}
					else if(copy_basis==5 && size_length>0 ){
						 
						for(var k=0; k<=hiddsizeid.length; k++)
						{
							var sizeId=hiddsizeid[k];
							if(pocolorid==document.getElementById('pocolorid_'+j).value &&  sizeId==document.getElementById('gmtssizesid_'+j).value)  document.getElementById(field_id+j).value=value;
						}
					  
					}
					else if(copy_basis==6 && size_length>0 ){
						 
						for(var k=0; k<=hiddsizeid.length; k++)
						{
						 var sizeId=hiddsizeid[k];
						  if( ponoid==document.getElementById('ponoid_'+j).value && pocolorid==document.getElementById('pocolorid_'+j).value &&  sizeId==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
					  }
					  else if(copy_basis==7 && size_length>0 ){
						 
						for(var k=0; k<=hiddsizeid.length; k++)
						{
						 var sizeId=hiddsizeid[k];
						  if( ponoid==document.getElementById('ponoid_'+j).value &&  sizeId==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
					  }
					   else if(copy_basis==8 && size_length>0 ){
						 
						for(var k=0; k<=hiddsizeid.length; k++)
						{
						 var sizeId=hiddsizeid[k];
						  if(ponoid==document.getElementById('ponoid_'+j).value && pocolorid==document.getElementById('pocolorid_'+j).value &&  sizeId==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
					  }
					  //---Copy size end----
					}
					else
					{
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
						}
						if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==5)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==6)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value && pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==7)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==8)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value && pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
					}

					if(field_id=='cons_' || field_id=='exper_' || field_id=='rate_')
					{
						//calculate_tot_cons(j);
						var itemratiogmts= (document.getElementById('itemratiogmts_'+j).value)*1;
						var tot_plancut_qty=document.getElementById('itempcsgmts_'+j).value*1;
						var pcsgmts=document.getElementById('pcsgmts_'+j).value*1;
						var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;

						var cons=document.getElementById('cons_'+j).value*1;
						var exper=document.getElementById('exper_'+j).value*1;
						//alert(exper);

						var avg_cons_percent=(cons*plan_cut_percent)/100;
						avg_cons+=avg_cons_percent;

						var totexper=number_format_common((cons*exper/100),5,0)*1;
						var totcons=number_format_common(totexper+cons,5,0);

						var calculated_cons_percent=(totcons*plan_cut_percent)/100;
						calculated_cons+=calculated_cons_percent;

						document.getElementById('totcons_'+j).value=totcons;
						document.getElementById('totexper_'+j).value=totexper;
						sumcons+=cons*1;
						sumtotcons+=totcons*1;

						var dznGmts=(pcsgmts/itemratiogmts);
						var RowtotReq=dznGmts*(totcons/pcs);
						document.getElementById('totqty_'+j).value=RowtotReq;
					//	alert(RowtotReq*1);
						totReqQty+=RowtotReq*1;
						var rate=document.getElementById('rate_'+j).value*1;
						//if(rate!=0)
						//{
							//calculate_amount(i);
							var RowtotAmt= RowtotReq*rate;
							var amount=number_format_common(totcons*rate,5,0);
							var calculated_amount_percent=(amount*plan_cut_percent)/100;
							calculated_amount+=calculated_amount_percent;

							document.getElementById('amount_'+j).value=amount;
							document.getElementById('totamount_'+j).value=RowtotAmt;
							if(amount*1>0)
							{
							sumamount+=amount*1;
							totReqAmt+=RowtotAmt*1;
							totRate+=rate*1;
							}
							//row_tot(j);
						//}
						/*else
						{
							//row_tot(j);
							document.getElementById('amount_'+j).value=0;
							document.getElementById('totamount_'+j).value=0;
						}*/
					}
				}
			}
		}
		// alert(sumamount);
		console.log(sumtotcons);
		$('#cons_sum').val( number_format_common(sumcons,5,0) );
		$('#totcons_sum').val( number_format_common(sumtotcons,5,0) );
		$('#rate_sum').val( number_format_common(totRate,5,0) );
		$('#amount_sum').val( number_format_common(sumamount,5,0) );


		$('#totReq_sum').val( number_format_common(totReqQty,5,0) );
		$('#totAmount_sum').val( number_format_common(totReqAmt,5,0) );
		$('#AtotReq_sum').val( number_format_common(totReqQty,5,0) );
		$('#AtotAmount_sum').val( number_format_common(totReqAmt,5,0) );
		document.getElementById('avg_cons').value=number_format_common(avg_cons, 5, 0);
		document.getElementById('avg_totcons').value=number_format_common(calculated_cons, 5, 0);
		document.getElementById('avg_amountcons').value=number_format_common(calculated_amount, 5, 0);
		document.getElementById('avg_ratecons').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
	}

	function fn_delete_down_tr(rowNo,table_id)
	{
		if(table_id=='tbl_consmption_cost')
		{
			var numRow = $('table#tbl_consmption_cost tbody tr').length;
			if(numRow==rowNo && rowNo!=1)
			{
				$('#tbl_consmption_cost tbody tr:last').remove();
			}
			set_sum_value( 'cons_sum', 'cons_'  );
			set_sum_value( 'exper_sum', 'exper_'  );
			set_sum_value( 'totcons_sum', 'totcons_'  );
			set_sum_value( 'rate_sum', 'rate_'  );
			set_sum_value( 'amount_sum', 'amount_'  );
			set_sum_value( 'pcs_sum', 'pcs_');
		}
	}

	function set_sum_value(des_fil_id,field_id)
	{
		if(des_fil_id=='cons_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='exper_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='totcons_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='rate_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='amount_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='pcs_sum') var ddd={dec_type:6,comma:0};

		var rowCount = $('#txttotrow').val()*1;//$('#tbl_consmption_cost tr').length;
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		claculate_avg();
	}

	function js_set_value()
	{
		var rowCount = $('#txttotrow').val()*1;//$('#tbl_consmption_cost tr').length;
		var cons_breck_down="";
		for(var i=1; i<=rowCount; i++)
		{
			var ponoid=$('#ponoid_'+i).val(); 						if(ponoid=='') ponoid=0;
			var itemsizes=$('#itemsizes_'+i).val(); 				if(itemsizes=='') itemsizes=0;
			var cons=$('#cons_'+i).val(); 							if(cons=='') cons=0;
			var place=$('#place_'+i).val(); 						if(place=='') place=0;
			var pcs=$('#pcs_'+i).val(); 							if(pcs=='') pcs=0;
			var cbocountry=$('#cbocountry_'+i).val(); 				if(cbocountry=='') cbocountry=0;

			var exper=$('#exper_'+i).val(); 						if(exper=='') exper=0;
			var totcons=$('#totcons_'+i).val(); 					if(totcons=='') totcons=0;
			var totexper=$('#totexper_'+i).val(); 					if(totexper=='') totexper=0;

			var cbogmtsitem=$('#cbogmtsitem_'+i).val(); 			if(cbogmtsitem=='') cbogmtsitem=0;
			var pocolorid=$('#pocolorid_'+i).val(); 				if(pocolorid=='') pocolorid=0;
			var gmtssizesid=$('#gmtssizesid_'+i).val(); 			if(gmtssizesid=='') gmtssizesid=0;

			var rate=$('#rate_'+i).val(); 							if(rate=='') rate=0;
			var amount=$('#amount_'+i).val(); 						if(amount=='') amount=0;
			var colorsizetableid=$('#colorsizetableid_'+i).val();	if(colorsizetableid=='') colorsizetableid=0;
			var pcsgmts = $('#pcsgmts_'+i).val(); 					if(pcsgmts=='') pcsgmts=0;
			var hidSizeRateCalStr=$('#hidSizeRateCalStr_'+i).val();
			if(hidSizeRateCalStr=='') hidSizeRateCalStr=0;
			var hidRateCalStr=$('#hidRateCalStr_'+i).val()
			if(hidRateCalStr=='') hidRateCalStr=0;
			var itemcolor=$('#txtitemcolor_'+i).val(); 				if(itemcolor=='') itemcolor=0;

			if(cons_breck_down=="")
			{
				cons_breck_down+=ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+pcsgmts+'_'+hidRateCalStr+'_'+itemcolor+'_'+hidSizeRateCalStr;
			}
			else
			{
				cons_breck_down+="__"+ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+pcsgmts+'_'+hidRateCalStr+'_'+itemcolor+'_'+hidSizeRateCalStr;
			}
		}
		//alert(cons_breck_down)
		var calculator_string='';
		var calculator_parameter=document.getElementById('calculator_parameter').value
		if(calculator_parameter==1){

			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_for_mtr=document.getElementById('txt_cons_for_mtr').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_for_mtr+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==2){
			var txt_gmts_per_catton=document.getElementById('txt_gmts_per_catton').value
			var txt_cost_for=document.getElementById('txt_cost_for').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			//var txt_sqm_rate=document.getElementById('txt_sqm_rate').value
			//var txt_lw_rate=document.getElementById('txt_lw_rate').value
			//var txt_hw_rate=document.getElementById('txt_hw_rate').value
			calculator_string=txt_gmts_per_catton+"_"+txt_cost_for+"_"+txt_caculated_value;
		}
		if(calculator_parameter==16){
			var txt_gmts_per_catton=document.getElementById('txt_gmts_per_catton').value
			var txt_cost_for=document.getElementById('txt_cost_for').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			var txt_sqm_rate=document.getElementById('txt_sqm_rate').value
			var txt_lw_rate=document.getElementById('txt_lw_rate').value
			var txt_hw_rate=document.getElementById('txt_hw_rate').value
			calculator_string=txt_gmts_per_catton+"_"+txt_cost_for+"_"+txt_caculated_value+"_"+txt_sqm_rate+"_"+txt_lw_rate+"_"+txt_hw_rate;
		}

		if(calculator_parameter==3 || calculator_parameter==13){
			var txt_stiker_per_catton=document.getElementById('txt_stiker_per_catton').value
			var txt_req_carton=document.getElementById('txt_req_carton').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_stiker_per_catton+"_"+txt_req_carton+"_"+txt_caculated_value
		}
		if(calculator_parameter==4){
			var txt_gmts_per_catton=document.getElementById('txt_gmts_per_catton').value
			var txt_cost_for=document.getElementById('txt_cost_for').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_gmts_per_catton+"_"+txt_cost_for+"_"+txt_caculated_value
		}
		if(calculator_parameter==5){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==6){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_pcs_per_carton=document.getElementById('txt_pcs_per_carton').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_pcs_per_carton+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==7){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==8){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value

		}
		if(calculator_parameter==9){
			var qty_per_gmts=(document.getElementById('txt_qty_per_gmts').value)*1;
			var qty_per_grs=document.getElementById('txt_qty_per_grs').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=qty_per_gmts+"_"+qty_per_grs+"_"+txt_caculated_value

		}
		if(calculator_parameter==10){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==11){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==12){ //Embroidery Thread

			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_for_mtr=document.getElementById('txt_cons_for_mtr').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_for_mtr+"_"+txt_cons_length+"_"+txt_caculated_value
		}

		if(calculator_parameter==15){ //Inner Sticker
			 var txt_stiker_per_catton=document.getElementById('txt_stiker_per_catton').value
			var txt_req_carton=document.getElementById('txt_req_carton').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_stiker_per_catton+"_"+txt_req_carton+"_"+txt_caculated_value
		}

		document.getElementById('cons_breck_down').value=cons_breck_down;
		document.getElementById('calculator_string').value=calculator_string;
		claculate_avg();
		parent.emailwindow.hide();
	}

	function claculate_avg()
	{
		//var tot_plancut_qty=document.getElementById('job_qty').value*1
		var item_ratio=document.getElementById('item_ratio').value*1
		var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0;  var significant_row_cal=0; var avg_ex_cons_per=0;
		var rowCount = $('#txttotrow').val()*1;//$('#tbl_consmption_cost tr').length;
		//alert(rowCount);

		for(var i=1; i<=rowCount; i++){
			if(document.getElementById('cons_'+i).value =='' || document.getElementById('cons_'+i).value ==0){
				continue;
			}
			else{
				var tot_plancut_qty=pcsgmts=plan_cut_percent=cons=avg_cons_percent=requirement=calculated_cons_percent=amount=calculated_amount_percent=0;
				var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1
				var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
				//alert(plan_cut_percent+'='+pcsgmts+'='+tot_plancut_qty+'**'+100);
				var ex_cons_per=document.getElementById('exper_'+i).value*1;
				avg_ex_cons_per+=ex_cons_per;
				
				var cons=document.getElementById('cons_'+i).value*1
				var avg_cons_percent=(cons*plan_cut_percent)/100;
				avg_cons+=avg_cons_percent;
			//	alert(avg_cons_percent+'='+cons+'='+plan_cut_percent);
				var requirement=document.getElementById('totcons_'+i).value*1
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;

				var amount=document.getElementById('amount_'+i).value*1
				var calculated_amount_percent=(amount*plan_cut_percent)/100;
				significant_row_cal=significant_row_cal+1;
				calculated_amount+=calculated_amount_percent;
			}
		}
		document.getElementById('avg_cons').value=number_format_common(avg_cons, 5, 0);
		document.getElementById('avg_totcons').value=number_format_common(calculated_cons, 5, 0);
		document.getElementById('avg_amountcons').value=number_format_common(calculated_amount, 5, 0);
		document.getElementById('avg_ratecons').value=number_format_common(calculated_amount/calculated_cons, 3, 0);
		//document.getElementById('avg_ratecons').value=Number(calculated_amount/calculated_cons).toFixed(6);
		
		document.getElementById('exper_sum').value=number_format_common(avg_ex_cons_per, 6, 0);
		var calculated_exper=(document.getElementById('exper_sum').value*1)/significant_row_cal;
		//alert(significant_row_cal);
		
		document.getElementById('avg_exper').value=number_format_common(calculated_exper, 6, 0);
	}

	function clculate_cons_for_mtr()
	{
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		if(txt_costing_per==1) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*12;
		if(txt_costing_per==2) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*1;
		if(txt_costing_per==3) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*2*12;
		if(txt_costing_per==4) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*3*12;
		if(txt_costing_per==5) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*4*12;

		var txt_cons_for_mtr= (document.getElementById('txt_cons_for_mtr').value)*1
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		document.getElementById('txt_caculated_value').value=txt_cons_for_mtr/txt_cons_length;
	}
	function clculate_embroidry_cons_for_mtr()
	{
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		if(txt_costing_per==1) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*12;
		if(txt_costing_per==2) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*1;
		if(txt_costing_per==3) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*2*12;
		if(txt_costing_per==4) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*3*12;
		if(txt_costing_per==5) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*4*12;

		var txt_cons_for_mtr= (document.getElementById('txt_cons_for_mtr').value)*1
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		document.getElementById('txt_caculated_value').value=txt_cons_for_mtr/txt_cons_length;
	}

	function clculate_req_carton() //Carton and Carton Board
	{
		var txt_gmts_per_catton=(document.getElementById('txt_gmts_per_catton').value)*1;
		var txt_cost_for=document.getElementById('txt_cost_for').value;
		var txt_caculated_value=(1/txt_gmts_per_catton)*txt_cost_for;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,5,0);
	}

	function clculate_req_eyelet()
	{
		var qty_per_gmts=(document.getElementById('txt_qty_per_gmts').value)*1;
		var qty_per_grs=document.getElementById('txt_qty_per_grs').value;
		var txt_caculated_value=(12*qty_per_gmts)/qty_per_grs;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,5,0);
	}
	function clculate_req_carton_stiker()
	{
		var txt_stiker_per_catton=(document.getElementById('txt_stiker_per_catton').value)*1;
		var txt_req_carton=document.getElementById('txt_req_carton').value;
		var txt_caculated_value=txt_stiker_per_catton*txt_req_carton;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,5,0);
	}

	function clculate_elastic()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function clculate_gumtap()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_pcs_per_carton=(document.getElementById('txt_pcs_per_carton').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1) var costing_per=12;
		else if(txt_costing_per==2) var costing_per=1;
		else if(txt_costing_per==3) var costing_per=24;
		else if(txt_costing_per==4) var costing_per=36;
		else if(txt_costing_per==5) var costing_per=48;
		else var costing_per=0;

		cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
		cons_dzn=(cons_dzn/txt_cons_length)*costing_per;

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function clculate_tagpin()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function clculate_sequines()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function calculator_value_set(i)
	{
		var txt_caculated_value=document.getElementById('txt_caculated_value').value
		document.getElementById('tr_order').value=i;
		if(txt_caculated_value !='')
		{
			document.getElementById('cons_'+i).value=txt_caculated_value;
			copy_value(txt_caculated_value,'cons_',i);
		}
	}

	function open_country_popup(i)
	{
		var txt_po_id=document.getElementById('ponoid_'+i).value;
		var txt_country=document.getElementById('cbocountry_'+i).value
		var txt_country_name=document.getElementById('tdcountry_'+i).text();
		var page_link='pre_cost_entry_controller_v2.php?action=open_country_popup';
		var title='Country';
		page_link=page_link+'&txt_po_id='+txt_po_id+'&txt_country='+txt_country+'&txt_country_name='+txt_country_name;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=420px,height=350px,center=1,resize=0,scrolling=0','../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var theemail=this.contentDoc.getElementById("txt_selected_id");
			var theemailname=this.contentDoc.getElementById("txt_selected_name");
			document.getElementById('cbocountry_'+i).value=trim(theemail.value);
			//document.getElementById('cbocountryname_'+i).value=trim(theemailname.value);
			$("#tdcountry_"+i).text( trim(theemailname.value));
		}
	}

	function calculate_tot_cons(i)
	{
		var cons=document.getElementById('cons_'+i).value*1;
		var exper=document.getElementById('exper_'+i).value*1;
		var totexper=number_format_common((cons*exper/100),5,0)*1;
		var totcons=number_format_common(totexper+cons,5,0);
		document.getElementById('totcons_'+i).value=totcons;
		document.getElementById('totexper_'+i).value=totexper;
		//copy_value(totcons,'totcons_',i)
		set_sum_value( 'totcons_sum', 'totcons_'  );
		var rate=document.getElementById('rate_'+i).value*1;
		if(rate!=0) calculate_amount(i);
		else row_tot(i);
	}

	function calculate_amount(i)
	{
		var totcons=document.getElementById('totcons_'+i).value*1;
		var rate=document.getElementById('rate_'+i).value*1;
		var amount=number_format_common(totcons*rate,5,0);
		document.getElementById('amount_'+i).value=amount;
		//copy_value(amount,'amount_',i)
		//set_sum_value( 'amount_sum', 'amount_'  );
		row_tot(i);
	}

	function row_tot(i)
	{
		var itemratiogmts= (document.getElementById('itemratiogmts_'+i).value)*1;
		var pcsgmts= (document.getElementById('pcsgmts_'+i).value)*1;
		var pcs= (document.getElementById('pcs').value)*1;
		var totcons= (document.getElementById('totcons_'+i).value)*1;
		var rate= (document.getElementById('rate_'+i).value)*1;
		var dznGmts=(pcsgmts/itemratiogmts);
		var RowtotReq= dznGmts*(totcons/pcs);
		var RowtotAmt= RowtotReq*rate;
		document.getElementById('totqty_'+i).value=RowtotReq;
		document.getElementById('totamount_'+i).value=RowtotAmt;
		set_sum_value( 'totReq_sum', 'totqty_'  );
		set_sum_value( 'totAmount_sum', 'totamount_'  );
		set_sum_value( 'AtotReq_sum', 'totqty_'  );
		set_sum_value( 'AtotAmount_sum', 'totamount_'  );
	}

	function trim_size_check(type)
	{
		if( document.getElementById('trim_size_id').checked==true)
		{
			var trim_size_id = document.getElementById('trim_size_id').value=1;
		}
		else if(document.getElementById('trim_size_id').checked==false)
		{
			var trim_size_id = document.getElementById('trim_size_id').value=2;
		}
		var rowCount = $('#txttotrow').val()*1;//$('#tbl_consmption_cost tr').length;
		//alert(trim_size_id);

		if(trim_size_id==1)
		{
			for(var i=1; i<=rowCount; i++)
			{
				var isDisabled = document.getElementById('itemsizes_'+i).disabled;
				if(isDisabled==false)
				{
					document.getElementById('itemsizes_'+i).value='';
					document.getElementById('hidSizeRateCalStr_'+i).value='';
				}
			}
		}
	}
	//txt_sqm_rate
	function reset_all_ratio_carton() //Issue Id=28913
	{
		var rowCount = $('#txttotrow').val()*1;
		var hidd_sizeid = document.getElementById('hidd_sizeid').value;
		var sqm_rate = document.getElementById('txt_sqm_rate').value*1;
		var hidden_sqm_rate = document.getElementById('hidden_sqm_rate').value*1;
			//alert(hidd_sizeid);
			var  item_size_remove="0";
			if(hidden_sqm_rate!="" && sqm_rate!=hidden_sqm_rate)
			{
				var r=confirm("Press  \"OK\"  want to Remove Item Size and all? \nPress  \"Cancel\"  not to remove Item Size  and all");
				if (r==true) item_size_remove="1"; 
			}
			if(item_size_remove=='0')
			{
				if(hidden_sqm_rate)
				{
					document.getElementById('txt_sqm_rate').value=hidden_sqm_rate;
				}
				
			}
		//alert(item_size_remove);
		for(var i=1; i<=rowCount; i++)
			{
				var isDisabled = document.getElementById('itemsizes_'+i).disabled;
				  if(isDisabled==false && item_size_remove=='1')
				{
					document.getElementById('itemsizes_'+i).value='';
					document.getElementById('hidSizeRateCalStr_'+i).value='';
					document.getElementById('cons_'+i).value='';
					document.getElementById('exper_'+i).value='';
					document.getElementById('totcons_'+i).value='';
					document.getElementById('rate_'+i).value='';
					document.getElementById('amount_'+i).value='';
					document.getElementById('totqty_'+i).value='';
					document.getElementById('totamount_'+i).value='';
				}

			}
	}
	function fnc_ratecal_parameter(inc,item_group,rate_calculator_parameter)
	{
		var str_data=$('#hidRateCalStr_'+inc).val();
		var cbogroup=$('#cbogroup').val();
		var txthidden_job=$('#txthidden_job').val();
		//alert(txthidden_job);
		var cbonominasupplier=$('#cbonominasupplier').val();
		var txtdescription=$('#txtdescription').val();
		var cboconsuom=$('#cboconsuom').val();
		var page_link='pre_cost_entry_controller_v2.php?action=rate_calculator_parameter_popup';
		var title='Rate Cal Parameter';
		page_link=page_link+'&inc='+inc+'&item_group='+item_group+'&rate_calculator_parameter='+rate_calculator_parameter+'&rate_cal_data='+str_data+'&cbogroup='+cbogroup+'&cbonominasupplier='+cbonominasupplier+'&txtdescription='+txtdescription+'&cboconsuom='+cboconsuom+'&txthidden_job='+txthidden_job;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=1100px,height=350px,center=1,resize=0,scrolling=0','../../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var rateValue=this.contentDoc.getElementById("txtfinalrate").value;
			var strData=this.contentDoc.getElementById("hidden_all_data").value;

			document.getElementById('rate_'+inc).value=trim(rateValue);
			document.getElementById('hidRateCalStr_'+inc).value=trim(strData);

			copy_value(strData,'hidRateCalStr_',inc); 
			copy_value(rateValue,'rate_',inc);

			//row_tot(inc);
			//claculate_avg();
		}
	}
	function fnc_size_ratecal_parameter(inc,item_group,size_rate_calculator_parameter)
	{
		var str_data=$('#hidSizeRateCalStr_'+inc).val();
		var cbogroup=$('#cbogroup').val();
		var txthidden_job=$('#txthidden_job').val();
		var ponoid=$('#ponoid_'+inc).val();
		var pocolorid=$('#pocolorid_'+inc).val();
		if (form_validation('txt_sqm_rate','SQM Rate')==false)
			{
				release_freezing();
				return;
			}
		var sqm_rate=$('#txt_sqm_rate').val()*1;
		var lw_rate=$('#txt_lw_rate').val()*1;
		var hw_rate=$('#txt_hw_rate').val()*1;
		var page_link='pre_cost_entry_controller_v2.php?action=size_rate_calculator_parameter_popup';
		var title='Item Size Rate Cal Parameter';
		page_link=page_link+'&inc='+inc+'&item_group='+item_group+'&size_rate_calculator_parameter='+size_rate_calculator_parameter+'&rate_cal_data='+str_data+'&ponoid='+ponoid+'&pocolorid='+pocolorid+'&txthidden_job='+txthidden_job;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=1100px,height=350px,center=1,resize=0,scrolling=0','../../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var strData=this.contentDoc.getElementById("hidden_all_data").value;
			var theemail=this.contentDoc.getElementById("txt_selected_id");
			var theemailname=this.contentDoc.getElementById("txt_selected_name");
			// alert(theemail.value+'='+theemailname.value);
			document.getElementById('hidd_sizeid').value=trim(theemail.value);
			document.getElementById('hidd_sizename').value=trim(theemailname.value);
			var hidd_sizeid=$('#hidd_sizeid').val();

			 var strDataStr=strData.split('X');
			 l_cons=strDataStr[0]*1;
			 w_cons=strDataStr[1]*1;
			 h_cons=strDataStr[2]*1;
			 cm=strDataStr[3];
			
			 var rate_cal=(((l_cons+w_cons+lw_rate)*(h_cons+w_cons+hw_rate))/5000)*sqm_rate;
			 var rateValue=rate_cal;
			  // alert(rateValue+'=='+l_cons+'='+w_cons+'='+lw_rate+'='+h_cons+'='+w_cons+'='+hw_rate+'/'+5000+'*'+sqm_rate);
			var strData_cal=strData+'X'+sqm_rate+'X'+lw_rate+'X'+hw_rate+'X'+hidd_sizeid;
			var avg_rate=number_format_common(rateValue, 5, 0);
			 
			var cons=(document.getElementById('cons_'+inc).value*1);
			var exper=(document.getElementById('exper_'+inc).value*1);
			//alert(cons);
			document.getElementById('rate_'+inc).value=number_format_common(rateValue, 5, 0);
			//alert(document.getElementById('rate_'+inc).value);
			document.getElementById('itemsizes_'+inc).value=trim(strData);
			document.getElementById('hidSizeRateCalStr_'+inc).value=trim(strData_cal);
		
			copy_value(strData,'itemsizes_',inc,1);//ISD-23-28913
			copy_value(strData_cal,'hidSizeRateCalStr_',inc,1);
			copy_value(avg_rate,'rate_',inc,1);
			copy_value(cons,'cons_',inc,1);
			copy_value(exper,'exper_',inc,1);
			
		}
	}


</script>
</head>
<body>
	<div><?=load_freeze_divs ("../../../",""); ?></div>
    <script>freeze_window(0);</script>
	<div align="center" style="width:100%;">
<?
	if($cbo_costing_per==1) $pcs_value=1*12;
	if($cbo_costing_per==2) $pcs_value=1*1;
	if($cbo_costing_per==3) $pcs_value=2*12;
	if($cbo_costing_per==4) $pcs_value=3*12;
	if($cbo_costing_per==5)$pcs_value=4*12;

	$job_order_uom=return_field_value("order_uom","wo_po_details_master","job_no='$txt_job_no'");
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");

	$sqlcal_parameter=sql_select("select cal_parameter, rate_cal_parameter from lib_item_group where id='$cbogroup'");
	$calculator_parameter=trim($sqlcal_parameter[0][csf('cal_parameter')]);
	$rate_calculator_parameter=trim($sqlcal_parameter[0][csf('rate_cal_parameter')]);

	$calculatorstringarr=explode("_",$calculatorstring);
	//echo $calculator_parameter.'='.$rate_calculator_parameter.'='.$calculatorstringarr[2];
?>
 <table class="rpt_table" border="0">
    <tr>
        <td><?
		 
			if($calculator_parameter==1)
			{
				$txt_cons_length=$calculatorstringarr[2];
				if($txt_cons_length=="" || $txt_cons_length==0) $txt_cons_length=4000;
				?>
				<fieldset>
					<legend>Sewing Thread-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1020">
						<tr>
							<td width="100">Cons Per Garment</td>
							<td>
							<input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_cons_for_mtr()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"  value="<? echo $calculatorstringarr[0]  ?>"/> Mtr
							</td>
							<td width="100">Cons <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_cons_for_mtr" name="txt_cons_for_mtr" class="text_boxes_numeric" style="width:100px"  value="<? echo $calculatorstringarr[1]  ?>" readonly/> Mtr</td>
							<td width="100">Cone Length</td>
							<td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_cons_for_mtr()"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<? echo $txt_cons_length  ?>"/> Mtr</td>
							<td width="100">Cons  <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<? echo $calculatorstringarr[3]; ?>" /> Cone
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
						</tr>
					</table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==2)
			{
				?>
				<fieldset>
					<legend>Carton-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1020">
						<tr>
							<td width="120">Gmts Per Carton</td>
							<td><input type="text" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/>
							</td>
							<td>Costting <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_cost_for" name="txt_cost_for" class="text_boxes_numeric" value="<? echo $pcs_value;?>" readonly/></td>
							<td>Required Carton</td>
							<td>
								<input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>" />
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly />
								<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
						</tr>
					</table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==3)
			{
				$data_array=sql_select("select a.cons_dzn_gmts from wo_pre_cost_trim_cost_dtls a,lib_item_group b where a.trim_group=b.id and b.cal_parameter in(2,16) and a.job_no='$txt_job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.cons_dzn_gmts>0");
				$total_row=count($data_array); $req_carton=0;
				/*if($total_row==1)
				{
					list($data)	= $data_array;
					$req_carton=$data[csf('cons_dzn_gmts')];
				}*/
				foreach ($data_array as $row) {
					$req_carton=$row[csf('cons_dzn_gmts')];
					break;
				}
				?>
				<fieldset>
					<legend>Carton Stiker-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1020">
						<tr>
							<td width="120">Stiker Per Carton</td>
							<td><input type="text" id="txt_stiker_per_catton" name="txt_stiker_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker()"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<? echo $calculatorstringarr[0] ?>"/></td>
							<td>Req Car <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_req_carton" name="txt_req_carton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker()" value="<? echo $req_carton;?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> readonly /></td>
							<td>Required Stiker</td>
							<td>
								<input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>" />
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
						</tr>
					</table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==4)
			{
				?>
				<fieldset>
                    <legend>Poly-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Gmts Per Poly</td>
                            <td><input type="text" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/></td>
                            <td>Costting <? echo $costing_per[$cbo_costing_per];?> </td>
                            <td><input type="text" id="txt_cost_for" name="txt_cost_for" class="text_boxes_numeric" value="<? echo $pcs_value;?>" readonly/></td>
                            <td>Required Poly</td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>" />
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==5)
			{
				$RollLength=$calculatorstringarr[1];
				if($RollLength == "" || $RollLength==0) $RollLength=48;
				?>
				<fieldset>
                    <legend>Elastic Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="100">Cons Per Garment</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_elastic()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<? echo $calculatorstringarr[0] ?>" /> Yds
                            </td>
                            <td width="100">Roll Length</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_elastic()" value="<? echo $RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"/> Yds</td>
                            <td width="100">Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<? echo $calculatorstringarr[2] ?>" /> Roll
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==6)
			{
				$RollLength=$calculatorstringarr[2];
				if($RollLength == "" || $RollLength==0)$RollLength=48;
				?>
				<fieldset>
                    <legend>Gum Tap Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="100">Cons Per Carton</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_gumtap()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  style="width:100px" value="<? echo $calculatorstringarr[0] ?>"/> Yds</td>
                            <td width="100">Pcs Per Carton</td>
                            <td><input type="text" id="txt_pcs_per_carton" name="txt_pcs_per_carton" class="text_boxes_numeric" onChange="clculate_gumtap()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<? echo $calculatorstringarr[1] ?>"/> Pcs</td>
                            <td width="100">Roll Length</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_gumtap()" value="<? echo $RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"/> Yds</td>
                            <td width="100">Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<? echo $calculatorstringarr[3] ?>"/> Roll
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==7)
			{
				$QtyPerBox=$calculatorstringarr[1];
				if($QtyPerBox=="" || $QtyPerBox== 0) $QtyPerBox=4800;
				?>
				<fieldset>
                    <legend>Tag Pin Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Cons Per Garments</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_tagpin()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/> Pcs</td>
                            <td>Qty Per Box</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_tagpin()" value="<? echo $QtyPerBox; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Pcs</td>
                            <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>"/> Box
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==8)
			{
				$RollLength=$calculatorstringarr[1];
				if($RollLength== "" || $RollLength==0)$RollLength=10000;
				?>
				<fieldset>
                    <legend>Sequines Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Cons Per Garments</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_sequines()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<? echo $calculatorstringarr[0] ?>" /> Yds</td>
                            <td>Roll Length</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_sequines()" value="<? echo $RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Yds</td>
                            <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>"/> Roll
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==9)
			{
				$qtyPerGrs=$calculatorstringarr[1];
				if($qtyPerGrs== "" || $qtyPerGrs==0)$qtyPerGrs=144;

				?>
				<fieldset>
					<legend>Eyelet Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1020">
						<tr>
							<td width="120">Qty per Garments</td>
							<td><input type="text" id="txt_qty_per_gmts" name="txt_qty_per_gmts" class="text_boxes_numeric" onChange="clculate_req_eyelet()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/> Pcs.
							</td>
							<td>Qty per Grs</td>
							<td><input type="text" id="txt_qty_per_grs" name="txt_qty_per_grs" class="text_boxes_numeric" onChange="clculate_req_eyelet()" value="<? echo $qtyPerGrs;?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> /> Pcs. </td>
							<td>Qty per 1 Dzn Garments</td>
							<td>
								<input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>" /> Grs.
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly />
								<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
						</tr>
					</table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==10)
			{
				$QtyPerBox=$calculatorstringarr[1];
				if($QtyPerBox=="" || $QtyPerBox== 0) $QtyPerBox=1728;
				?>
				<fieldset>
                    <legend>Button GG; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Cons Per Garments</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_tagpin()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/> Pcs</td>
                            <td>Qty Per GG</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_tagpin()" value="<? echo $QtyPerBox; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Pcs</td>
                            <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>"/> GG
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==11)
			{
				$QtyPerBox=$calculatorstringarr[1];
				if($QtyPerBox=="" || $QtyPerBox== 0) $QtyPerBox=144;
				?>
				<fieldset>
                    <legend>Button Gross; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Cons Per Garments</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_tagpin()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/> Pcs</td>
                            <td>Qty Per Gross</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_tagpin()" value="<? echo $QtyPerBox; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Pcs</td>
                            <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>"/> Gross
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==12) //Embroidery Thread
			{
				$txt_cons_length=$calculatorstringarr[2];
				if($txt_cons_length=="" || $txt_cons_length==0) $txt_cons_length=3000;
				?>
				<fieldset>
					<legend>Embroidery Thread-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1020">
						<tr>
							<td width="100">Cons Per Garment</td>
							<td>
							<input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_embroidry_cons_for_mtr()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"  value="<? echo $calculatorstringarr[0]  ?>"/> Mtr
							</td>
							<td width="100">Cons <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_cons_for_mtr" name="txt_cons_for_mtr" class="text_boxes_numeric" style="width:100px"  value="<? echo $calculatorstringarr[1]  ?>" readonly/> Mtr</td>
							<td width="100">Cone Length</td>
							<td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_embroidry_cons_for_mtr()"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<? echo $txt_cons_length  ?>"/> Mtr</td>
							<td width="100">Cons  <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<? echo $calculatorstringarr[3]; ?>" /> Cone
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
						</tr>
					</table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==13) //Carton Board
			{
				 $data_array=sql_select("select a.cons_dzn_gmts from wo_pre_cost_trim_cost_dtls a,lib_item_group b where a.trim_group=b.id and b.cal_parameter=2 and a.job_no='$txt_job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.cons_dzn_gmts>0");
				$total_row=count($data_array); $req_carton=0;
				/*if($total_row==1)
				{
					list($data)	= $data_array;
					$req_carton=$data[csf('cons_dzn_gmts')];
				}*/
				foreach ($data_array as $row) {
					$req_carton=$row[csf('cons_dzn_gmts')];
					break;
				}
				?>
				<fieldset>
					<legend>Carton Board-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1020">
						<tr>
							<td width="120">Board Per Carton</td>
							<td><input type="text" id="txt_stiker_per_catton" name="txt_stiker_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker()"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<? echo $calculatorstringarr[0] ?>"/></td>
							<td>Req Car <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_req_carton" name="txt_req_carton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker()" value="<? echo $req_carton;?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> readonly /></td>
							<td>Required Carton</td>
							<td>
								<input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>" />
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
						</tr>
					</table>
				</fieldset>

				<?
			}
			else if($calculator_parameter==15) //Inner Sticker
			{
				$data_array=sql_select("select a.cons_dzn_gmts from wo_pre_cost_trim_cost_dtls a,lib_item_group b where a.trim_group=b.id and b.cal_parameter=4 and a.job_no='$txt_job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.cons_dzn_gmts>0");
				$total_row=count($data_array); $blister_polyReq=0;
				/*if($total_row==1)
				{
					list($data)	= $data_array;
					$req_carton=$data[csf('cons_dzn_gmts')];
				}*/
				foreach ($data_array as $row) {
					$blister_polyReq=$row[csf('cons_dzn_gmts')];
					break;
				}
				?>
				<fieldset>
					<legend>Inner Stiker-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1020">
						<tr>
							<td width="120"> Inner Per Poly</td>
							<td><input type="text" id="txt_stiker_per_catton" name="txt_stiker_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker()"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<? echo $calculatorstringarr[0] ?>"/></td>
							<td>Costing for <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_req_carton" name="txt_req_carton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker()" value="<? echo $blister_polyReq;?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> readonly /></td>
							<td>Required Sticker</td>
							<td>
								<input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>" />
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
						</tr>
					</table>
				</fieldset>
				<?
			}
			else if($calculator_parameter==16) //Carton Ratio
			{
				 
				?>
				<fieldset>
					<legend>Carton-Comsumption Calculator; <?=$cbogrouptext.' ('.$unit_of_measurement[$cboconsuom].')'; ?></legend>
					<table cellpadding="0" cellspacing="0" align="center" width="1080">
						<tr>
							<td width="120">Gmts Per Carton</td>
							<td><input type="text" style="width:100px" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/>
							</td>
							<td>Costting <? echo $costing_per[$cbo_costing_per];?></td>
							<td><input type="text" id="txt_cost_for" style="width:100px" name="txt_cost_for" class="text_boxes_numeric" value="<? echo $pcs_value;?>" readonly/></td>
							<td>Required Carton</td>
							<td>
								<input type="text" id="txt_caculated_value" name="txt_caculated_value" style="width:100px" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>" />
								<input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly />
								<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
							</td>
							<td><b>SQM Rate</b></td>
							<td><input type="text" id="txt_sqm_rate" name="txt_sqm_rate" style="width:70px" class="text_boxes_numeric" onChange="reset_all_ratio_carton()" value="<? echo $calculatorstringarr[3] ?>" />
							<input type="hidden" id="hidden_sqm_rate" name="hidden_sqm_rate" style="width:70px" class="text_boxes_numeric"  value="<? echo $calculatorstringarr[3] ?>" />
						</td>
						<?
						if($calculatorstringarr[4]) $calculatorstringarr[4]=$calculatorstringarr[4];else $calculatorstringarr[4]=6;
						if($calculatorstringarr[5]) $calculatorstringarr[5]=$calculatorstringarr[5];else $calculatorstringarr[5]=4;
						?>
							<td><b>LW All.</b></td>
							<td><input type="text" id="txt_lw_rate" name="txt_lw_rate" style="width:70px" class="text_boxes_numeric" value="<? echo $calculatorstringarr[4] ?>" /></td>
							<td><b>HW All.</b></td>
							<td><input type="text" id="txt_hw_rate" name="txt_hw_rate" style="width:70px" class="text_boxes_numeric"  value="<? echo $calculatorstringarr[5] ?>" /></td>
							<td colspan="2">&nbsp;  </td>

						</tr>
					</table>
				</fieldset>
				<?
			}
			else
			{
				?>
				<input type="hidden" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value=""/>
				<?
			}?>
        </td>
    </tr>
    <tr>
        <th>
            <!--<b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>-->
            <input type="hidden" id="pcs"  name="pcs"  class="text_boxes_numeric" style="width:75px"  value="<? echo $pcs_value; ?>">
            <input type="hidden" id="tr_order"  name="tr_order"  class="text_boxes_numeric" style="width:75px"  value="" />
            <input type="hidden" id="cons_breck_down"  name="cons_breck_down"  class="text_boxes_numeric" style="width:75px" value="" />
            <input type="hidden" id="item_ratio"  name="item_ratio"  class="text_boxes_numeric" style="width:75px"  value="<? echo $tot_set_qnty; ?>" />
            <input type="hidden" id="calculator_parameter"  name="calculator_parameter"  class="text_boxes_numeric" style="width:75px" value="<? echo $calculator_parameter; ?>" />
            <input type="hidden" id="calculator_string"  name="calculator_string"  class="text_boxes_numeric" style="width:75px"  value="" readonly />
            <form>
            	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?=create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            	<b>Copy</b> :
                <?
                if($calculator_parameter==16)
				{
				?>
                <input type="radio" name="copy_basis" value="no" checked >No Copy
                <input type="radio" name="copy_basis" value="0" > Copy to All
                <?
				}
				else { ?>
					 <input type="radio" name="copy_basis" value="no">No Copy
                     <input type="radio" name="copy_basis" value="0" checked> Copy to All
					<? } 
				?>
                
                <input type="radio" name="copy_basis" value="1">Size Wise
                <input type="radio" name="copy_basis" value="2">Color Wise
                <input type="radio" name="copy_basis" value="3">Gmts Item Wise
                <input type="radio" name="copy_basis" value="4">Po Wise
                <input type="radio" name="copy_basis" value="5">Color & Size Wise
                <input type="radio" name="copy_basis" value="6">PO with Color
                <input type="radio" name="copy_basis" value="7">PO with Size
                <input type="radio" name="copy_basis" value="8">PO and Color with Size
                <input type="reset" value="Reset">

				<input type="hidden" id="hidd_sizeid" name="hidd_sizeid" style="width:70px" class="text_boxes_numeric" />
				<input type="hidden" id="hidd_sizename" name="hidd_sizename" style="width:70px" class="text_boxes_numeric" />
            </form>
        </th>
        <th>&nbsp;</th>
    </tr>
    <tr>
    	<td>
			<table width="1230" cellspacing="0" class="rpt_table" border="1" rules="all">
                <thead>
                    <tr>
                        <th width="30">SL</th>
                        <th width="120">PO NO</th>
                        <th width="120">Gmts.Item</th>
                        <th width="80">Country</th>
                        <th width="100">Gmts Color</th>
                        <th width="80">Gmts Size</th>
                        <th width="70">Item Color</th>
                        <th width="50">Item Size &nbsp; <input type="checkbox" name="trim_size_id" id="trim_size_id" onClick="trim_size_check(1);" value="2" ></th>
                        <th width="50">Cons</th>
                        <th width="50">Ex. %</th>
                        <th width="50">Tot. Cons</th>
                        <th width="50">Rate</th>
                        <th width="50">Amt</th>
                        <th width="80">Tot. Qty</th>
                        <th width="80">Tot. Amt</th>
                        <th width="50">Plac ement</th>
                        <th width="50"><? if ($job_order_uom==1){echo "Pcs";} if($job_order_uom==58){echo "Set";} ?></th>
                        <th><input type="hidden" id="txtdescription" name="txtdescription" value="<?=$txtdescription; ?>"></th>
                    </tr>
                </thead>
		</table>
			<div style="width:1230px; max-height:260px; overflow-y:scroll;" align="left" id="scroll_body">
                <table width="1212" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <tbody>
                <?

                if($cbo_costing_per==1) $pcs_value=1*12;
                else if($cbo_costing_per==2) $pcs_value=1*1;
                else if($cbo_costing_per==3) $pcs_value=2*12;
                else if($cbo_costing_per==4) $pcs_value=3*12;
                else if($cbo_costing_per==5) $pcs_value=4*12;

                $component_approved=0;
                $sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=2 and job_no='$txt_job_no'");
                foreach($sql as $row)
				{
                	if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
                }
				unset($sql);

                $item_ratio_arr=array();
                $gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no='$txt_job_no'");
                foreach($gmts_item_sql as $gmts_item_row)
                {
                	$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]] = $gmts_item_row[csf('set_item_ratio')];
                }
				unset($gmts_item_sql);

				$country=rtrim($country,",");
				if(trim($country)=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";

                $country_array=array(); $itemqty_array=array();
                $data_country=sql_select("SELECT b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, c.country_id, c.plan_cut_qnty, c.order_quantity from wo_po_break_down b, wo_po_color_size_breakdown c where b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond and b.status_active=1 and c.status_active=1 and b.is_deleted=0 and c.is_deleted =0");
                foreach($data_country as $data_country_row)
				{
					$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_id'][$data_country_row[csf('country_id')]]=$data_country_row[csf('country_id')];
					$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_name'][$data_country_row[csf('country_id')]]=$country_library[$data_country_row[csf('country_id')]];

					$itemqty_array[$data_country_row[csf('item_number_id')]]+=$data_country_row[csf('order_quantity')];
                }
                unset($data_country);

                $data_array=sql_select("SELECT b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity from wo_po_break_down b,wo_po_color_size_breakdown c where b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted =0 group by b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");

                // echo $updateidtrim ;
                if($updateidtrim != "")
				{
					$row_arr_data=""; $cons_breck_downnarr=array();
					$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("SELECT id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, item_size, item_color_number_id, country_id, place, cons, excess_per, tot_cons, ex_cons, rate, amount, pcs, gmts_pcs, color_size_table_id, rate_cal_data,itemsizerate_cal_data from wo_pre_cost_trim_co_cons_dtls where job_no='$txt_job_no' and wo_pre_cost_trim_cost_dtls_id=$updateidtrim and status_active=1 and is_deleted=0");

					foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $trims_cons_row)
					{
						if($trims_cons_row[csf('item_color_number_id')]=='') $trims_cons_row[csf('item_color_number_id')]=0;
						$cons_breck_downnarr[$trims_cons_row[csf('color_size_table_id')]]=$trims_cons_row[csf('po_break_down_id')]."_".$trims_cons_row[csf('item_size')]."_".$trims_cons_row[csf('tot_cons')]."_".$trims_cons_row[csf('place')]."_".$trims_cons_row[csf('pcs')]."_".$trims_cons_row[csf('country_id')]."_".$trims_cons_row[csf('excess_per')]."_".$trims_cons_row[csf('cons')]."_".$trims_cons_row[csf('ex_cons')]."_".$trims_cons_row[csf('item_number_id')]."_".$trims_cons_row[csf('color_number_id')]."_".$trims_cons_row[csf('size_number_id')]."_".$trims_cons_row[csf('rate')]."_".$trims_cons_row[csf('amount')]."_".$trims_cons_row[csf('color_size_table_id')]."_".$trims_cons_row[csf('gmts_pcs')]."_".$trims_cons_row[csf('rate_cal_data')]."_".$trims_cons_row[csf('item_color_number_id')]."_".$trims_cons_row[csf('itemsizerate_cal_data')];
						//$row_arr_data.=$row_arr."__";
					}
					unset($wo_pre_cos_fab_co_avg_con_dtls_data);
					//$row_arr_data=rtrim($row_arr_data,"__");
					//$cons_breck_downnarr=explode("__",$row_arr_data);
                }
               // print_r($cons_breck_downn_trim);
                if($updateidtrim == "") $cons_breck_downnarr=explode("__",$cons_breck_downn_trim);

                if($cbo_approved_status!=1) $cbo_approved_status=$component_approved;
                $cons_fld=0; $is_booking_arr=array();
                if($cbo_approved_status!=1)
                {
					$data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$updateidtrim' and booking_type='2' and status_active=1 and is_deleted=0 group by po_break_down_id, pre_cost_fabric_cost_dtls_id");
					//if ( count($data_arr)>0) { $cbo_approved_status=1; }
					foreach($data_arr as $row)
					{
						$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
					}
					unset($data_arr);
                }

                if( count($data_array)>0)
                {
					$i=0;
					foreach( $data_array as $row )
					{
						if($updateidtrim!= "") $data=explode('_',$cons_breck_downnarr[$row[csf('color_size_table_id')]]); else if($updateidtrim == "") $data=explode('_',$cons_breck_downnarr[$i]);
						$i++;
						$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
						$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);

						$po_country_arr=explode(",",$country_string);

						$countrydata=explode(",",$data[5]);
						$arr_d=array_diff($countrydata, $po_country_arr);
						$arr_d2=array_diff($countrydata, $arr_d);
						$country_name="";

						for($countryindex=0; $countryindex < count($arr_d2); $countryindex++){
							$country_name.=	$country_library[$countrydata[$countryindex]].",";
						}
						$country_idstring=implode(",",$arr_d2);

						if(count($arr_d)>0 && count($countrydata)>0 )
						{
							$country_name_pre="";
							for($countryindex=0; $countryindex < count($arr_d);$countryindex++)
							{
								$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
							}
							$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
							if(rtrim($country_name_pre,",")!="") $bgc="#D41F00";
						}
						else{
							$title=""; $bgc="#FFFFFF";
						}
						//echo $txtexper.'D';
						if($txtexper!="")
						{
							$exdata=explode("__",$txtexper);
							if(count($exdata)>1)
							{
								$data[2]=$exdata[0];
								$data[6]=$exdata[1];
								$data[7]=$exdata[2];
							}
							else //From Library Template
							{
								$data[2]=$txtconsdzngmts;
								$data[6]=$exdata[0];
								$data[6]='';
							}
						}

						$data[6]=$data[6]; if($data[6]=='') $data[6]=0;
						$data[7]=$data[7]; if($data[7]=='') $data[7]=$data[2];
						$rate=$data[12]; if($rate=="") $rate=$txttrimrate;
						//if($data[13]=="" && $rate!="") $data[13]=$rate*$data[7];

						if($data[10] != $row[csf('color_number_id')] && $data[10] !=""){
							$title_color="Color have Changed in po entry, you have to update this field, Previous Color was ".$color_library[$data[10]]."";
							$bgc_color="#D41F00";
						}
						else{
							$title_color=""; $bgc_color="#FFFFFF";
						}
						if($data[11] != $row[csf('size_number_id')] && $data[11] !=""){
							$title_size="Size have Changed in po entry, you have to update this field, Previous Size was ".$size_library[$data[11]]."";
							$bgc_size="#D41F00";
						}
						else{
							$title_size=""; $bgc_size="#FFFFFF";
						}
						$item_size=$data[1];
						if($item_size=="") $item_size=$size_library[$row[csf('size_number_id')]];

						/* if($data[2]=="") $data[2]=$txtconsdzngmts;
						if($data[7]=="") $data[7]=$txtconsdzngmts; */

						if($data[13]=="" && $rate!="") $data[13]=$rate*$data[7];
						$pcs=$pcs_value * $item_ratio_arr[$row[csf('item_number_id')]];
						$cons_fld=0;
						if($cbo_approved_status!=1)
						{
							//echo $is_booking_arr[$row[csf('id')]];
							if($is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0) $cons_fld=1;
						}
						if(($data[13]*1)>0) $data[13]=fn_number_format($data[13],4,".","");
						//echo $data[2].'A';
						if($calculator_parameter==16) //Carton Ratio
						{
							$itemsize_calculator_cond=" readonly onDblClick='fnc_size_ratecal_parameter($i,$cbogroup,$calculator_parameter);'"; 
						}
						else $itemsize_calculator_cond="";

						if($rate_calculator_parameter==2 || $rate_calculator_parameter==14) $rate_calculator_cond=" readonly onClick='fnc_ratecal_parameter($i,$cbogroup,$rate_calculator_parameter);'"; else $rate_calculator_cond="";

						if($data[3]=="") $data[3]=0;
						if($data[2]=="") $data[2]=$totalcons;
						if($data[7]=="") $data[7]=$totalcons+($totalcons*$excessper)/100;
						if($data[6]=='' && $txtexper==''){
							$data[6]=$excessper;
						}
						/* if($data[2]=="") $data[2]=$txtconsdzngmts;
						if($data[7]=="") $data[7]=$txtconsdzngmts; */
						//echo $data[6].'f';

						if($data[6]=='' )
						{
							$data[6]=$txtexper; $data[7]=$txtconsdzngmts+($txtconsdzngmts*$txtexper)/100;
						}
						$data[13]=$data[7]*$rate;

						$RowtotReq=($row[csf('order_quantity')]/$item_ratio_arr[$row[csf('item_number_id')]])*($data[7]/$pcs_value);

						$totReq+=$RowtotReq;
						$RowtotAmt=fn_number_format($RowtotReq*$rate,4,".","");
						$totAmt+=$RowtotAmt;
						if($data[18]!="") //For Ratio Cartoon
						{
							$itemSizearr=explode("X",$data[18]);
							$itemSizeArr=explode(",",$itemSizearr[7]);
							$itemSizeName_Arr=array();
							foreach($itemSizeArr as $sizeid)
							{
								$itemSizeName_Arr[$size_library[$sizeid]]=$size_library[$sizeid];
							}
						}
						
						//echo $itemSize.'DD';
						?>
						<tr id="break_<?=$i;?>" align="center">
                            <td width="30" align="center"><?=$i; ?></td>
                            <td width="120" style="word-break:break-all"><?=$row[csf('po_number')]; ?>
                                <input type="hidden" id="ponoid_<?=$i; ?>" name="ponoid_<?=$i ;?>" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly/>
                                <input type="hidden" id="cbogmtsitem_<?=$i;?>" name="cbogmtsitem_<?=$i;?>" style="width:85px" value="<?=$row[csf('item_number_id')]; ?>" readonly/>
                            </td>
                            <td width="120" style="word-break:break-all"><?=$garments_item[$row[csf('item_number_id')]]; ?></td>
                            <td width="80" style="word-break:break-all; background-color:<?=$bgc; ?>" title="<?=$country_string_name."; ".$title; ?>" id="tdcountry_<?=$i; ?>"><?=substr($country_string_name, 0, 17); ?>
                                <input type="hidden" id="cbocountry_<?=$i;?>" name="cbocountry_<?=$i;?>" style="width:65px" value="<?=$country_string; ?>" readonly />
                            </td>
                            <td width="100" style="word-break:break-all; background-color:<?=$bgc_color; ?>" title="<?=$title_color; ?>"><?=$color_library[$row[csf('color_number_id')]]; ?>
                                <input type="hidden" id="pocolorid_<?=$i;?>" name="pocolorid_<?=$i;?>" style="width:85px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
                            </td>
                            <td width="80" style="word-break:break-all; background-color:<?=$bgc_size; ?>" title="<?=$title_size; ?>"><?=$size_library[$row[csf('size_number_id')]]; ?>
                                <input type="hidden" id="gmtssizesid_<?=$i;?>" name="gmtssizesid_<?=$i;?>" style="width:55px" value="<?=$row[csf('size_number_id')]; ?>" readonly />
                            </td>

                            <td width="70"><input type="text" id="txtitemcolor_<?=$i;?>" name="txtitemcolor_<?=$i;?>" class="text_boxes" style="width:58px" onChange="copy_value(this.value,'txtitemcolor_',<?=$i;?>,0);" value="<?=$color_library[$data[17]]; ?>" <? if ($cons_fld==1) { echo "disabled";} else { if($cbo_approved_status==1){echo "disabled";} else { echo "";}} ?> /></td>

                            <td width="50" title="<?=implode(",",$itemSizeName_Arr); ?>"><input type="text" id="itemsizes_<?=$i;?>" name="itemsizes_<?=$i;?>" class="text_boxes" style="width:38px" onChange="copy_value(this.value,'itemsizes_',<?=$i;?>,0)" value="<?=$item_size; ?>" <? if ($cons_fld==1) { echo "disabled";} else { if($cbo_approved_status==1){echo "disabled";} else { echo "";}} echo $itemsize_calculator_cond;?> />
							<input type="hidden" id="hidSizeRateCalStr_<?=$i;?>" name="hidSizeRateCalStr_<?=$i;?>" style="width:30px" value="<?=$data[18]; ?>" />
							
						</td>

                            <td width="50"><input type="text" id="cons_<?=$i;?>" name="cons_<?=$i;?>" onClick="calculator_value_set(<?=$i;?>);" onChange="copy_value(this.value,'cons_',<?=$i;?>,0);" class="text_boxes_numeric" style="width:38px" value="<?=$data[2]; ?>" <? if ($cons_fld==1) { echo "";} if($cbo_approved_status==1){echo "disabled";}  else { echo "";} ?> /></td>
                            <td width="50">
                                <input type="text" id="exper_<?=$i;?>" onChange="copy_value(this.value,'exper_',<?=$i;?>,0); calculate_tot_cons(<?=$i;?>);" name="exper_<?=$i;?>" class="text_boxes_numeric" style="width:38px" value="<?=$data[6]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                <input type="hidden" id="totexper_<?=$i;?>" name="totexper_<?=$i;?>" style="width:30px" value="<?=$data[8]; ?>" />
                            </td>
                            <td width="50"><input type="text" id="totcons_<?=$i;?>" onChange="copy_value(this.value,'totcons_',<?=$i;?>,0);" name="totcons_<?=$i;?>" onClick="calculator_value_set(<?=$i;?>);" class="text_boxes_numeric" style="width:38px" value="<?=$data[7]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> readonly /></td>
                            <td width="50">
                            	<input type="text" id="rate_<?=$i;?>" onChange="copy_value(this.value,'rate_',<?=$i;?>,0); calculate_amount(<?=$i;?>);" name="rate_<?=$i;?>" class="text_boxes_numeric" style="width:38px" value="<?=$rate; ?>" <? if ($cons_fld==1) { echo "disabled ";} if($cbo_approved_status==1) {echo "disabled";} else { echo "";} echo $rate_calculator_cond; ?>  />
                            	<input type="hidden" id="hidRateCalStr_<?=$i;?>" name="hidRateCalStr_<?=$i;?>" style="width:30px" value="<?=$data[16]; ?>" />
                            </td>
                            <td width="50"><input type="text" id="amount_<?=$i;?>" onChange="copy_value(this.value,'amount_',<?=$i;?>,0);" name="amount_<?=$i;?>" class="text_boxes_numeric" style="width:38px" value="<?=$data[13]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  readonly /></td>
                            <td width="80"><input type="text" id="totqty_<?=$i;?>" name="totqty_<?=$i;?>" class="text_boxes_numeric" style="width:67px" value="<?=$RowtotReq; ?>" readonly  /></td>
                            <td width="80"><input type="text" id="totamount_<?=$i;?>" name="totamount_<?=$i;?>" class="text_boxes_numeric" style="width:67px" value="<?=$RowtotAmt; ?>" readonly /></td>
                            <td width="50"><input type="text" id="place_<?=$i;?>" name="place_<?=$i;?>" class="text_boxes" style="width:37px" onChange="copy_value(this.value,'place_',<?=$i;?>,0)" value="<?=$data[3]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> /></td>
                            <td width="50">
                                <input type="text" id="pcs_<?=$i; ?>" name="pcs_<?=$i; ?>" class="text_boxes_numeric" style="width:37px" value="<?=$pcs; ?>" readonly />
                                <input type="hidden" id="pcsgmts_<?=$i; ?>" name="pcsgmts_<?=$i; ?>" disabled style="width:30px" value="<?=$row[csf('order_quantity')]; ?>" readonly>
                                <input type="hidden" id="itempcsgmts_<?=$i;?>" name="itempcsgmts_<?=$i;?>" style="width:30px" value="<?=$itemqty_array[$row[csf('item_number_id')]]; ?>">
                                <input type="hidden" id="itemratiogmts_<?=$i;?>" name="itemratiogmts_<?=$i;?>" style="width:30px" value="<?=$item_ratio_arr[$row[csf('item_number_id')]]; ?>">
                                <?
                                $jobqty+=$row[csf('order_quantity')];
                                ?>
                                <input type="hidden" id="colorsizetableid_<?=$i;?>" name="colorsizetableid_<?=$i;?>" style="width:30px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                            </td>
                            <td id="add_<?=$i;?>"><input type="button" id="decreaserow_<?=$i;?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<?=$i;?>,'tbl_consmption_cost' );" />
                            </td>
						</tr>
						<?
					}
                }
				unset($data_array);
				unset($cons_breck_downnarr);
				unset($country_array);
				unset($itemqty_array);
                ?>
                </tbody>
            </table>
            </div>
            <table width="1230" cellspacing="0" class="rpt_table" border="1"  rules="all">
				<tfoot>
                    <tr>
                        <th width="30"><input type="hidden" id="txttotrow" name="txttotrow" class="text_boxes_numeric" style="width:18px" value="<?=$i; ?>"></th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th width="50">Sum:</th>
                        <th width="50"><input type="text" id="cons_sum" name="cons_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="50"><input type="text" id="exper_sum" name="exper_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="50"><input type="text" id="totcons_sum" name="totcons_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="50"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="50"><input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="80"><input type="text" id="totReq_sum" name="totReq_sum" class="text_boxes_numeric" style="width:68px" value="<?=number_format($totReq,2,'.','');?>" readonly></th>
                        <th width="80"><input type="text" id="totAmount_sum" name="totAmount_sum" class="text_boxes_numeric" style="width:68px" value="<?=$totAmt; ?>" readonly></th>
                        <th width="50">&nbsp;</th>
                        <th width="50">
                        	<input type="text" id="pcs_sum" name="pcs_sum" class="text_boxes_numeric" style="width:38px" readonly>
                        	<input type="hidden" id="job_qty" name="job_qty" class="text_boxes_numeric" style="width:38px" value="<?=$jobqty ?>" readonly></th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th width="50">Avg:</th>
                        <th width="50"><input type="text" id="avg_cons" name="avg_cons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                        <th width="50"><input type="text" id="avg_exper" name="avg_exper" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                        <th width="50"><input type="text" id="avg_totcons" name="avg_totcons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                        <th width="50"><input type="text" id="avg_ratecons" name="avg_ratecons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                        <th width="50"><input type="text" id="avg_amountcons" name="avg_amountcons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                        <th width="80"><input type="text" id="AtotReq_sum" name="AtotReq_sum" class="text_boxes_numeric" style="width:68px" value="<?=$totReq;?>" readonly></th>
                        <th width="80"><input type="text" id="AtotAmount_sum" name="AtotAmount_sum" class="text_boxes_numeric" style="width:68px" value="<?=$totAmt; ?>" readonly></th>
                        <th width="50">&nbsp;</th>
                        <th width="50"><input type="text" id="calculated_pcs" name="calculated_pcs" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
			</table>


			<script>
				$(document).ready(function(e) {
					var tableFilters =
					{
						col_6: "none",col_7: "none",col_8: "none",col_9: "none",col_10: "none",col_11: "none",col_12: "none",col_13: "none",col_14: "none",col_15: "none",col_16: "none",col_17: "none",
							col_operation: {
						}
					}
					setFilterGrid('tbl_consmption_cost',-1,tableFilters);
					claculate_avg();
				});
                set_sum_value( 'cons_sum', 'cons_');
                set_sum_value( 'exper_sum', 'exper_');
                set_sum_value( 'totcons_sum', 'totcons_');
                set_sum_value( 'rate_sum', 'rate_');
                set_sum_value( 'amount_sum', 'amount_');
                set_sum_value( 'pcs_sum', 'pcs_');
            </script>
            <div align="center" style="width:100%;" >
                <fieldset>
                    <table width="1230" cellspacing="0" class="" border="0" rules="all">
                        <tr>
                            <td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value();"/> </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            </td>
        <tr>
    </table>
    </div>
    </body>
    <script>release_freezing(); $('.form_caption').hide(); </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}
if($action=="item_size_parameter_popup")
{
	echo load_html_head_contents("Item Size wise Rate Calculation","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	 // echo $txt_job_no.'D';
	 
	?>
	<script>
		 var selected_id = new Array, selected_name = new Array();
		 /*function check_all_data() {
			$("#tbl_list_search tr").each(function() {
				var valTP=$(this).attr("id");
				$("#"+valTP).click();
			});
		}*/
		function check_all_data() {
			var tbl_row_count = document.getElementById('item_table').rows.length;

			tbl_row_count = tbl_row_count - 1;
			//alert(tbl_row_count);
			for (var i = 1; i <= tbl_row_count; i++) {
				js_set_value(i);
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
		function set_all() {
			//var old_seq = document.getElementById('txt_process_seq').value;
			var old = document.getElementById('txt_country_row_id').value;
			//alert(old);
			if (old != "") {
				old = old.split(",");
				for (var k = 0; k < old.length; k++) {
					js_set_value(old[k]);
				}
			}
		}


		function js_set_value( str ) {

			if($("#search"+str).css("display") !='none')
			{

			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );

			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_individual_name' + str).val() );

			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = '';
			var name='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += trim(selected_id[i]) + ',';
				name += trim(selected_name[i]) + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );

			//alert(id)
			$('#txt_selected_id').val( trim(id) );
			$('#txt_selected_name').val( trim(name) );

			}
		}
	</script>
	</head>
    <body>
    <div align="center" style="width:100%;">
    <form>
		<?
		 
		 $sql_data=sql_select("select size_number_id,size_order  from wo_po_color_size_breakdown   WHERE job_no_mst='$txt_job_no' and  status_active=1 and is_deleted=0 group by size_number_id,size_order order by size_order");

		?>

        <table width="420" cellspacing="0" class="rpt_table" border="0" id="tbl_list_search" rules="all">


            <thead>
            <th width="50"> SL </th>
             <th width="250"> Gmts Size Name </th>
            
            </thead>
           </table>
         <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        	<table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>

			<?
            $couArr=array();
			 $sizeArr_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
			
            $i=1;$country_row_id = ''; //$nIdcouSArr=array(); $nNamecouSArr=array();
            foreach($sql_data as $row)
            {
                $couArr['id'][trim($row[csf('size_number_id')])]=trim($row[csf('size_number_id')]);
                $couArr['name'][trim($row[csf('size_number_id')])]= $sizeArr_library[trim($row[csf('size_number_id')])];
                if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";


					$countrySArr=explode(",",trim($txt_country));
					if (in_array($row[csf('size_number_id')], $countrySArr))
					{
						if ($country_row_id == "") $country_row_id = $i; else $country_row_id .= "," . $i;
					}

                ?>
                <tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" id="search<? echo $i;?>" onClick="js_set_value(<? echo $i;?>)">

                    <td width="50"><? echo $i ?></td>
                    <td width="250">
                    <input type="hidden" name="txt_individual_id<?php $i; ?>" id="txt_individual_id<?php echo $i; ?>" value="<? echo trim($row[csf('size_number_id')]); ?>"/>
                    <input type="hidden" name="txt_individual_name<?php echo $i; ?>" id="txt_individual_name<?php echo $i; ?>" value="<? echo $sizeArr_library[trim($row[csf('size_number_id')])]; ?>"/>
                    <? echo $sizeArr_library[$row[csf('size_number_id')]]; ?>
                    </td>
                    
                </tr>
                <?
                $i++;
            }
			$t=1;
			//$process_row_id = '';
           $nIdcouSArr=array(); $nNamecouSArr=array();
            $couSArr=explode(",",trim($txt_country));
            foreach($couSArr as $key=>$value){
                if (in_array(trim($value), $couArr['id'])) {
                    $nIdcouSArr[]=trim($value);
                    $nNamecouSArr[]=$sizeArr_library[trim($value)];

					//if ($process_row_id == "") $process_row_id = $t; else $process_row_id .= "," . $t;
                }
				$t++;
            }
            ?>
             </tbody>
        </table>
        </div>
        <table width="400" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                        <input type="hidden" name="txt_country_row_id" id="txt_country_row_id" value="<?php echo $country_row_id; ?>"/>

                            <input type="hidden" id="txt_selected_id" name="txt_selected_id" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?>" />
                            <input type="hidden" id="txt_selected_name" name="txt_selected_name" value="<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?> " />
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </form>
    </div>
    <script>setFilterGrid('item_table',-1);</script>
    </body>
   
     <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script>
	set_all();
	</script>

    </html>
    <?
	exit();
}
if($action=="rate_calculator_parameter_popup")
{
	echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		var rate_calculator_parameter = '<? echo $rate_calculator_parameter; ?>';

		function fnc_totRateCal()
		{
			var all_data="";

			if(rate_calculator_parameter==2)
			{
				all_data=$('#txtlength_1').val()+'~~'+$('#txtwidth_1').val()+'~~'+$('#txtheight_1').val()+'~~'+$('#txtrate_1').val()+'~~'+$('#txtcartonrate_1').val()+'~~'+$('#txtlwall_1').val()+'~~'+$('#txthwall_1').val();
				$('#hidden_all_data').val(all_data);
				var finalRate=0;
				var ply7_1_actual_ctn=($('#txtlength_1').val()*1)+($('#txtwidth_1').val()*1)+$('#txtlwall_1').val()*1;
				var ply7_2_actual_ctn=($('#txtwidth_1').val()*1)+($('#txtheight_1').val()*1)+$('#txthwall_1').val()*1;
				var ctn7Rate=((((ply7_1_actual_ctn*1)*(ply7_2_actual_ctn*1))/5000)*($('#txtrate_1').val()*1));
				$('#txtcartonrate_1').val( number_format(ctn7Rate,4) );
				$('#txtfinalrate').val( number_format(ctn7Rate,4) );
			}
			else if(rate_calculator_parameter==14)
			{
				all_data=$('#txtlength_1').val()+'~~'+$('#txtwidth_1').val()+'~~'+$('#txtheight_1').val()+'~~'+$('#txtrate_1').val()+'~~'+$('#txtcartonrate_1').val();
				$('#hidden_all_data').val(all_data);
				var finalRate=0;
				var ply7_2_actual_ctn=($('#txtlength_1').val()*1)*($('#txtwidth_1').val()*1);
				var ctn7Rate=(((ply7_2_actual_ctn*1)/10000)*($('#txtrate_1').val()*1));
				$('#txtcartonrate_1').val( number_format(ctn7Rate,4) );
				$('#txtfinalrate').val( number_format(ctn7Rate,4) );
			}
		}

		function js_set_value()
		{
			fnc_totRateCal();
			document.getElementById('txtfinalrate').value;
			document.getElementById('hidden_all_data').value;
			var description = $('#txtlength_1').val()+'x'+$('#txtwidth_1').val()+'x'+$('#txtheight_1').val();
			var rate_description = $('#hidden_rate_des').val();
			$('#hidden_description').val(rate_description +'@'+description);
			parent.emailwindow.hide();
		}

		function fnc_assign_all_data()
		{
			var all_data=$('#hidden_all_data').val();
			var exData=all_data.split("~~");
			if(rate_calculator_parameter==2)
			{
				$('#txtlength_1').val(exData[0]);
				$('#txtwidth_1').val(exData[1]);
				$('#txtheight_1').val(exData[2]);
				$('#txtrate_1').val(exData[3]);
				$('#txtcartonrate_1').val(exData[4]);
				$('#txtlwall_1').val(exData[5]);
				$('#txthwall_1').val(exData[6]);
				//$('#txtfinalrate').val(exData[10]);
			}
			else if(rate_calculator_parameter==14)
			{
				$('#txtlength_1').val(exData[0]);
				$('#txtwidth_1').val(exData[1]);
				$('#txtheight_1').val(exData[2]);
				$('#txtrate_1').val(exData[3]);
				$('#txtcartonrate_1').val(exData[4]);
			}
		}
		function supp_trim_rate_popup(i)
		{
			var cbogroup=document.getElementById('cbogroup').value;
			var txtdescription=document.getElementById('txtdescription').value;
			var cbonominasupplier=document.getElementById('cbonominasupplier').value;
			var page_link="pre_cost_entry_controller_v2.php?cbogroup="+trim(cbogroup)+"&txtdescription="+trim(txtdescription)+"&cbonominasupplier="+trim(cbonominasupplier)+"&action=supp_trim_rate_popup_page";
			emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Rate', 'width=1000px,top=0px,height=400px,center=1,resize=1,scrolling=0;','../../')
			emailwindow.onclose=function(){
				var txt_selected_supllier=this.contentDoc.getElementById("txt_selected_supllier");
				var txt_selected_rate=this.contentDoc.getElementById("txt_selected_rate");
				var txt_selected_description=this.contentDoc.getElementById("txt_selected_description");
				var txt_uom=this.contentDoc.getElementById("txt_uom");
				document.getElementById('txtrate_'+i).value=txt_selected_rate.value;
				document.getElementById('hidden_rate_des').value=txt_selected_description.value;
				document.getElementById('hidden_carton_supplier').value=txt_selected_supllier.value;
				fnc_totRateCal()
			}
		}

	</script>
	</head>
    <body>
    <div align="center">
    <input type="hidden" name="hidden_all_data" id="hidden_all_data" value=""/>
    <input type="hidden" name="hidden_description" id="hidden_description" value=""/>
    <input type="hidden" name="hidden_rate_des" id="hidden_rate_des" value=""/>
    <input type="hidden" name="hidden_carton_supplier" id="hidden_carton_supplier" value=""/>
    <input type="hidden" name="txtfinalrate" id="txtfinalrate" value=""/>
    <form>
		<? $sql_data=sql_select("select country_id  from wo_po_color_size_breakdown   WHERE job_no_mst='$txthidden_job' and  status_active=1 and is_deleted=0 group by country_id"); ?>

			<?
			$company_name = return_field_value("company_name", "wo_po_details_master", "job_no='$txthidden_job'");
			$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
			$trim_variable=1;
			$trim_variable_sql=sql_select("select trim_rate from  variable_order_tracking where company_name='$company_name' and variable_list=35 order by id");
			foreach($trim_variable_sql as $trim_variable_row)
			{
				$trim_variable=	$trim_variable_row[csf('trim_rate')];
			}
			if($trim_variable==1 || $trim_variable==0)
			{
				$trim_rate_popup="";
			}
			else
			{
				$trim_rate_popup="  onClick='supp_trim_rate_popup(1)' placeholder='Click' readonly";//onClick="supp_trim_rate_popup(1)" readonly
			}

			$item_groupArr=return_library_array( "select id, item_name from lib_item_group", "id", "item_name");

			if($rate_calculator_parameter==2)
			{
				$rate_cal=explode('~~',$rate_cal_data);
				if($rate_cal[5]==''){
					$rate_cal[5]=6;
				}
				if($rate_cal[6]==''){
					$rate_cal[6]=4;
				}
				?>
                <table width="500" cellspacing="0" class="rpt_table" border="1" id="tbl_list_search" rules="all">
                    <thead>
                    	<tr>
                        	<th colspan="6"><? echo $item_groupArr[$item_group]; ?> (Square Mtr)</th>
                        	<th colspan="2">Measurement in CM</th>
                        </tr>
                    	<tr>
                            <th width="130">Details</th>
                            <th width="80">L</th>
                            <th width="80">W</th>
                            <th width="80">H</th>
                            <th width="80">LW All.</th>
                            <th width="80">HW All.</th>
                            <th width="80">Rate ($)</th>
                            <th title="((((L+W+LW All.)+(W+H+HW All.))/5000)*Rate ($))">Carton Rate</th>
                            <input type="hidden" id="cbogroup" name="cbogroup" value="<? echo $cbogroup ?>">
							<input type="hidden" id="cbonominasupplier" name="cbonominasupplier" value="<? echo $supplier ?>">
							<input type="hidden" id="txtdescription" name="txtdescription" value="<? echo $txtdescription ?>">
							<input type="hidden" id="cboconsuom" name="cboconsuom" value="<? echo $cboconsuom ?>">
                        </tr>
                    </thead>
                    <tr>
						<td><?= $txtdescription ?></td>
                        <td><input type="text" name="txtlength_1" id="txtlength_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[0] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtwidth_1" id="txtwidth_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[1] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtheight_1" id="txtheight_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[2] ?>" onBlur="fnc_totRateCal();"/></td>
						<td><input type="text" name="txtlwall_1" id="txtlwall_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[5] ?>" onBlur="fnc_totRateCal();"/></td>
						<td><input type="text" name="txthwall_1" id="txthwall_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[6] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtrate_1" id="txtrate_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[3] ?>"  onBlur="fnc_totRateCal();" <? //echo $trim_rate_popup;?> /></td>
                        <td><input type="text" name="txtcartonrate_1" id="txtcartonrate_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[4] ?>" onBlur="fnc_totRateCal();"/></td>
                    </tr>
                </table>
                <br>
                <table width="500" cellspacing="0" class="" border="0" align="center">
                    <tr>
                        <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value()"/></td>
                    </tr>
                </table>
				<?
			}
			else if ($rate_calculator_parameter==14)
			{
				$rate_cal=explode('~~',$rate_cal_data);
				?>
                <table width="500" cellspacing="0" class="rpt_table" border="1" id="tbl_list_search" rules="all">
                    <thead>
                    	<tr>
                        	<th colspan="4"><? echo $item_groupArr[$item_group]; ?> (Square Mtr)</th>
                        	<th colspan="2">Measurement in CM</th>
                        </tr>
                    	<tr>
                            <th width="130">Details</th>
                            <th width="80">L</th>
                            <th width="80">W</th>
                            <th width="80">Rate ($)</th>
                            <th title="(((L*W)/10000)*Rate ($))">Carton Rate</th>
                            <input type="hidden" id="cbogroup" name="cbogroup" value="<? echo $cbogroup ?>">
							<input type="hidden" id="cbonominasupplier" name="cbonominasupplier" value="<? echo $supplier ?>">
							<input type="hidden" id="txtdescription" name="txtdescription" value="<? echo $txtdescription ?>">
							<input type="hidden" id="cboconsuom" name="cboconsuom" value="<? echo $cboconsuom ?>">
                        </tr>
                    </thead>
                    <tr>
                        <td><?= $txtdescription ?></td>
                        <td><input type="text" name="txtlength_1" id="txtlength_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[0] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtwidth_1" id="txtwidth_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[1] ?>" onBlur="fnc_totRateCal();"/><input type="hidden" name="txtheight_1" id="txtheight_1" value="<? echo $rate_cal[2] ?>"/></td>
                        <td><input type="text" name="txtrate_1" id="txtrate_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[3] ?>"  onBlur="fnc_totRateCal();" /></td>
                        <td><input type="text" name="txtcartonrate_1" id="txtcartonrate_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[4] ?>" onBlur="fnc_totRateCal();"/></td>
                    </tr>
                </table>
                <br>
                <table width="500" cellspacing="0" class="" border="0" align="center">
                    <tr>
                        <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value()"/></td>
                    </tr>
                </table>
				<?
			}

			die;
			?>
        </table>
    </form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}
if($action=="size_rate_calculator_parameter_popup")
{
	echo load_html_head_contents("Item Size wise Rate Calculation","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	  //echo $pocolorid.'D';
	?>
	<script>
		 var selected_id = new Array, selected_name = new Array();
		 /*function check_all_data() {
			$("#tbl_list_search tr").each(function() {
				var valTP=$(this).attr("id");
				$("#"+valTP).click();
			});
		}*/
		function check_all_data() {
			var tbl_row_count = document.getElementById('item_table').rows.length;

			tbl_row_count = tbl_row_count - 1;
			//alert(tbl_row_count);
			for (var i = 1; i <= tbl_row_count; i++) {
				js_set_value(i);
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
		function set_all() {
			//var old_seq = document.getElementById('txt_process_seq').value;
			var old = document.getElementById('txt_country_row_id').value;
			//alert(old);
			if (old != "") {
				old = old.split(",");
				for (var k = 0; k < old.length; k++) {
					js_set_value(old[k]);
				}
			}
		}


		function js_set_value( str ) {

			if($("#search"+str).css("display") !='none')
			{

			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );

			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_individual_name' + str).val() );

			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = '';
			var name='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += trim(selected_id[i]) + ',';
				name += trim(selected_name[i]) + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );

			//alert(id)
			$('#txt_selected_id').val( trim(id) );
			$('#txt_selected_name').val( trim(name) );

			}
		}

		var size_rate_calculator_parameter = '<? echo $size_rate_calculator_parameter; ?>';

		function fnc_totRateCal()
		{
			var all_data="";

			if(size_rate_calculator_parameter==16)
			{
				all_data=$('#txtlength_1').val()+'X'+$('#txtwidth_1').val()+'X'+$('#txtheight_1').val()+'X'+$('#txtcm_1').val();
				//alert(all_data);
				$('#hidden_all_data').val(all_data);
			 
			}
			 
		}

		function js_set_value_itemSize()
		{
			//txtlength_1
			 fnc_totRateCal();
			//document.getElementById('txtfinalrate').value;
			document.getElementById('hidden_all_data').value;
			
			//var description = $('#txtlength_1').val()+'x'+$('#txtwidth_1').val()+'x'+$('#txtheight_1').val();
			//var rate_description = $('#hidden_rate_des').val();
			//$('#hidden_description').val(rate_description +'@'+description);
			parent.emailwindow.hide();
		}
 

	</script>
	</head>
    <body>
    <div  align="center">
    <input type="hidden" name="hidden_all_data" id="hidden_all_data" value=""/>
   
    <form>

			<?
			 $job_id = return_field_value("job_id", "WO_PO_BREAK_DOWN", "id='$ponoid'");
			   $sql_data=sql_select("select size_number_id,size_order  from wo_po_color_size_breakdown   WHERE job_id=$job_id and  status_active=1 and is_deleted=0 group by size_number_id,size_order order by size_order"); 
			   
			   $item_groupArr=return_library_array( "select id, item_name from lib_item_group", "id", "item_name");
	if($size_rate_calculator_parameter==16)
	{
				$rate_cal=explode('X',$rate_cal_data);
				// if($rate_cal[5]==''){
				// 	$rate_cal[5]=6;
				// }
				// if($rate_cal[6]==''){
				// 	$rate_cal[6]=4;
				// }
				$txt_country=$rate_cal[7];
				//echo $size_ids.'D';
				?>
                 <table width="950" cellspacing="0"  border="0" align="left">
                 <tr>
                 <td>
                 <table width="500" cellspacing="0" class="rpt_table" style="margin-left:20px;" border="1" align="left" id="tbl_list_search" rules="all">
                    <thead>
                    	<tr>
                        	<th colspan="5"><? echo $item_groupArr[$item_group]; ?> (Item Size)</th>
                        	 
                        </tr>
                    	<tr>
                            <th width="130">Details</th>
                            <th width="80">L</th>
                            <th width="80">W</th>
                            <th width="80">H</th>
							 <th width="80">CM</th>
                         
                            <input type="hidden" id="cbogroup" name="cbogroup" value="<? echo $cbogroup ?>">
							<input type="hidden" id="cbonominasupplier" name="cbonominasupplier" value="<? echo $supplier ?>">
							<input type="hidden" id="txtdescription" name="txtdescription" value="<? echo $txtdescription ?>">
							<input type="hidden" id="cboconsuom" name="cboconsuom" value="<? echo $cboconsuom ?>">
                        </tr>
                    </thead>
                    <tr>
						<td><?= $txtdescription ?></td>
                        <td><input type="text" name="txtlength_1" id="txtlength_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[0] ?>"  /></td>
                        <td><input type="text" name="txtwidth_1" id="txtwidth_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[1] ?>" /></td>
                        <td><input type="text" name="txtheight_1" id="txtheight_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[2] ?>"  </td>
						<td><input type="hidden" name="txtcm_1" id="txtcm_1" class="text_boxes_numeric" style="width:70px;" value="CM" </td>
                    </tr>
                </table>
          </td>
         <td valign="top">
           
		<table width="300" cellspacing="0" class="rpt_table"  style="margin-left:20px;" border="0"  id="tbl_list_search" rules="all">
		<thead>
		<th width="50"> SL </th>
		<th width=""> Gmts Size Name </th>

		</thead>
		</table>
		<div style="width:320px; max-height:420px;" >
		<table width="300" cellspacing="0" class="rpt_table" style="margin-left:20px;" border="0" rules="all" id="item_table">
		<tbody>

		<?
		$couArr=array();
		$sizeArr_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");

		$i=1;$country_row_id = ''; //$nIdcouSArr=array(); $nNamecouSArr=array();
		foreach($sql_data as $row)
		{
		$couArr['id'][trim($row[csf('size_number_id')])]=trim($row[csf('size_number_id')]);
		$couArr['name'][trim($row[csf('size_number_id')])]= $sizeArr_library[trim($row[csf('size_number_id')])];
		if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";


		$countrySArr=explode(",",trim($txt_country));
		if (in_array($row[csf('size_number_id')], $countrySArr))
		{
		if ($country_row_id == "") $country_row_id = $i; else $country_row_id .= "," . $i;
		}

		?>
		<tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" id="search<? echo $i;?>" onClick="js_set_value(<? echo $i;?>)">

		<td width="50"><? echo $i ?></td>
		<td width="">
		<input type="hidden" name="txt_individual_id<?php $i; ?>" id="txt_individual_id<?php echo $i; ?>" value="<? echo trim($row[csf('size_number_id')]); ?>"/>
		<input type="hidden" name="txt_individual_name<?php echo $i; ?>" id="txt_individual_name<?php echo $i; ?>" value="<? echo $sizeArr_library[trim($row[csf('size_number_id')])]; ?>"/>
		<? echo $sizeArr_library[$row[csf('size_number_id')]]; ?>
		</td>

		</tr>
		<?
		$i++;
		}
		$t=1;
		//$process_row_id = '';
		$nIdcouSArr=array(); $nNamecouSArr=array();
		$couSArr=explode(",",trim($txt_country));
		foreach($couSArr as $key=>$value){
		if (in_array(trim($value), $couArr['id'])) {
		$nIdcouSArr[]=trim($value);
		$nNamecouSArr[]=$sizeArr_library[trim($value)];
		
		}
		$t++;
		}
		?>
		</tbody>
		</table>
		<div style="width:50%; float:left" align="left">
		<input type="hidden" name="txt_country_row_id" id="txt_country_row_id" value="<?php echo $country_row_id; ?>"/>

			<input type="hidden" id="txt_selected_id" name="txt_selected_id" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?>" />
			<input type="hidden" id="txt_selected_name" name="txt_selected_name" value="<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?> " />
			<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
		</div>
        </td>
        </tr>
		<table width="500" cellspacing="0" class="" border="0" align="center">
		<tr>
		<td align="center" width="100%" class="button_container">
			<input type="button" class="formbutton" value="Close" onClick="js_set_value_itemSize()"/></td>
		</tr>
		</table>
		<?
		}

		//die;
		?>
		</table>
    </form>
    </div>
    </body>
	 <script>setFilterGrid('item_table',-1);</script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	 <script>
	set_all();
	</script>
    </html>
    <?
	exit();
}


if($action=="calculator_type")
{
	extract($_REQUEST);
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	?>
	<script>
	function clculate_cons_for_mtr()
	{
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		if(txt_costing_per==1) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*12;
		if(txt_costing_per==2) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*1;
		if(txt_costing_per==3) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*2*12;
		if(txt_costing_per==4) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*3*12;
		if(txt_costing_per==5) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*4*12;
		var txt_cons_for_mtr= (document.getElementById('txt_cons_for_mtr').value)*1
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		document.getElementById('txt_cons_for_cone').value=txt_cons_for_mtr/txt_cons_length;
	}

	function js_set_value_calculator(type)
	{
		if(type=='sewing_thread')
		{
			var clacolator_param_value=document.getElementById('txt_cons_per_gmts').value+'*'+document.getElementById('txt_cons_for_mtr').value+'*'+document.getElementById('txt_cons_length').value+'*'+document.getElementById('txt_cons_for_cone').value+'*'+document.getElementById('txt_costing_per').value;

			document.getElementById('txt_clacolator_param_value').value=clacolator_param_value;
		}
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
	<?
	if($calculator_parameter==1)
	{
		?>
		<fieldset>
            <legend>Sewing Thread</legend>
            <table cellpadding="0" cellspacing="2" align="center" width="300">
                <tr>
                    <td width="120">Cons Per Garment</td>
                    <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_cons_for_mtr()" /> Mtr</td>
                </tr>
                <tr>
                    <td>Cons <? echo $costing_per[$cbo_costing_per]; ?></td>
                    <td><input type="text" id="txt_cons_for_mtr" name="txt_cons_for_mtr" class="text_boxes_numeric" readonly/> Mtr</td>
                </tr>
                <tr>
                    <td>Cone Length</td>
                    <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_cons_for_mtr()" value="4000"/> Mtr</td>
                </tr>
                <tr>
                    <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                    <td><input type="text" id="txt_cons_for_cone" name="txt_cons_for_cone" class="text_boxes_numeric" readonly /> Cone</td>
                </tr>
                <tr>
                    <td colspan="3" align="center">
                        <input type="button" class="formbutton" value="Close" onClick="js_set_value_calculator('sewing_thread')"/>
                        <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly />
                        <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                    </td>
                </tr>
            </table>
		</fieldset>
		<?
	}
	?>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="trim_rate_popup_page")
{
	echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(data)
		{
			var data=data.split('_');
			document.getElementById('txt_selected_supllier').value=data[0];
			document.getElementById('txt_selected_rate').value=data[1];
			document.getElementById('txt_supllierName').value=data[2];
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
	<div align="center">
	<form>
        <input type="hidden" id="txt_selected_supllier" name="txt_selected_supllier" value="" />
        <input type="hidden" id="txt_supllierName" name="txt_supllierName" value=" " />
        <input type="hidden" id="txt_selected_rate" name="txt_selected_rate" value="" />
        <?
        $supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
        $sql_data=sql_select("select a.id, b.supplier_id, b.rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.id='$cbogroup' and    b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
        ?>
        <table class="rpt_table" width="500" cellpadding="0" cellspacing="0" border="1" rules="all">
            <thead>
                <th width="50">SL</th>
                <th width="100">Supplier</th>
                <th width="100">Rate</th>
            </thead>
        </table>
        <table width="500" cellspacing="0" class="rpt_table" border="0" id="tbl_list_search" rules="all">
			<?
            $i=1;
            foreach($sql_data as $row)
            {
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" onClick="js_set_value('<?=$row[csf('supplier_id')]."_".$row[csf('rate')]."_".$supplier_library[$row[csf('supplier_id')]];?>');">
                    <td width="50"><?=$i; ?></td>
                    <td width="100"><?=$supplier_library[$row[csf('supplier_id')]]; ?></td>
                    <td width="100"><?=$row[csf('rate')]; ?></td>
				</tr>
				<?
				$i++;
            }
            ?>
        </table>
	</form>
	</div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="open_country_popup")
{
	//echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	echo load_html_head_contents("Country PopUp","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
		 var selected_id = new Array, selected_name = new Array();
		 /*function check_all_data() {
			$("#tbl_list_search tr").each(function() {
				var valTP=$(this).attr("id");
				$("#"+valTP).click();
			});
		}*/
		function check_all_data() {
			var tbl_row_count = document.getElementById('item_table').rows.length;

			tbl_row_count = tbl_row_count - 1;
			//alert(tbl_row_count);
			for (var i = 1; i <= tbl_row_count; i++) {
				js_set_value(i);
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
		function set_all() {
			//var old_seq = document.getElementById('txt_process_seq').value;
			var old = document.getElementById('txt_country_row_id').value;
			//alert(old);
			if (old != "") {
				old = old.split(",");
				for (var k = 0; k < old.length; k++) {
					js_set_value(old[k]);
				}
			}
		}


		function js_set_value( str ) {

			if($("#search"+str).css("display") !='none')
			{

			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );

			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_individual_name' + str).val() );

			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = '';
			var name='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += trim(selected_id[i]) + ',';
				name += trim(selected_name[i]) + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );

			//alert(id)
			$('#txt_selected_id').val( trim(id) );
			$('#txt_selected_name').val( trim(name) );

			}
		}
	</script>
	</head>
    <body>
    <div align="center" style="width:100%;">
    <form>
		<? $sql_data=sql_select("select country_id  from wo_po_color_size_breakdown   WHERE job_no_mst='$txt_job_no' and  status_active=1 and is_deleted=0 group by country_id");

		?>

        <table width="420" cellspacing="0" class="rpt_table" border="0" id="tbl_list_search" rules="all">


            <thead>
            <th width="20"> SL </th>
             <th width="200"> Name </th>
             <th width="80"> Short </th>
             <th width=""> Region </th>
            </thead>
           </table>
         <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        	<table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>

			<?
            $couArr=array();
			//$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
			$sql_country=sql_select("select id,country_name,short_name,region from lib_country where status_active=1 ");
			//echo "select id,country_name,short_name,region from lib_country where status_active=1 ";
			foreach($sql_country as $row)
            {
				$country_library[$row[csf('id')]]=$row[csf('country_name')];
				$country_short_library[$row[csf('id')]]=$row[csf('short_name')];
				$country_region_library[$row[csf('id')]]=$row[csf('region')];
			}
            $i=1;$country_row_id = ''; //$nIdcouSArr=array(); $nNamecouSArr=array();
            foreach($sql_data as $row)
            {
                $couArr['id'][trim($row[csf('country_id')])]=trim($row[csf('country_id')]);
                $couArr['name'][trim($row[csf('country_id')])]= $country_library[trim($row[csf('country_id')])];
                if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";



					$countrySArr=explode(",",trim($txt_country));
					if (in_array($row[csf('country_id')], $countrySArr))
					{
						if ($country_row_id == "") $country_row_id = $i; else $country_row_id .= "," . $i;
					}





                ?>
                <tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" id="search<? echo $i;?>" onClick="js_set_value(<? echo $i;?>)">

                    <td width="20"><? echo $i ?></td>
                    <td width="200">
                    <input type="hidden" name="txt_individual_id<?php $i; ?>" id="txt_individual_id<?php echo $i; ?>" value="<? echo trim($row[csf('country_id')]); ?>"/>
                    <input type="hidden" name="txt_individual_name<?php echo $i; ?>" id="txt_individual_name<?php echo $i; ?>" value="<? echo $country_library[trim($row[csf('country_id')])]; ?>"/>
                    <? echo $country_library[$row[csf('country_id')]]; ?>
                    </td>
                    <td width="80"><? echo $country_short_library[$row[csf('country_id')]]; ?></td>
                    <td width=""><? echo $country_region_library[$row[csf('country_id')]]; ?></td>
                </tr>
                <?
                $i++;
            }
			$t=1;
			//$process_row_id = '';
           $nIdcouSArr=array(); $nNamecouSArr=array();
            $couSArr=explode(",",trim($txt_country));
            foreach($couSArr as $key=>$value){
                if (in_array(trim($value), $couArr['id'])) {
                    $nIdcouSArr[]=trim($value);
                    $nNamecouSArr[]=$country_library[trim($value)];

					//if ($process_row_id == "") $process_row_id = $t; else $process_row_id .= "," . $t;
                }
				$t++;
            }
            ?>
             </tbody>
        </table>
        </div>
        <table width="400" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                        <input type="hidden" name="txt_country_row_id" id="txt_country_row_id" value="<?php echo $country_row_id; ?>"/>

                            <input type="hidden" id="txt_selected_id" name="txt_selected_id" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?>" />
                            <input type="hidden" id="txt_selected_name" name="txt_selected_name" value="<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?> " />
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </form>
    </div>
    <script>setFilterGrid('item_table',-1);</script>
    </body>
    <script>
		/*var txt_country='<? //if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?> '
		var txt_country_name='<?  //if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?>'

		if(trim(txt_country) !=""){
			selected_id=trim(txt_country).split(",");
			selected_name=txt_country_name.split(",");
		}
		for(var i=0; i<selected_id.length;i++){
		   if(trim(selected_id[i]) !=""){
				toggle( document.getElementById( 'search' + trim(selected_id[i]) ), '#FFFFCC' );
		   }
		}*/
    </script>
     <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script>
	set_all();
	</script>

    </html>
    <?
	exit();
}

if($action=="open_country_popup_not_used")  //Old
{
	echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		 var selected_id = new Array, selected_name = new Array();
		 function check_all_data() {
			$("#item_table tr").each(function() {
				var valTP=$(this).attr("id");
				$("#"+valTP).click();
			});
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( str ) {
			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );

			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_individual_name' + str).val() );

			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = '';
			var name='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += trim(selected_id[i]) + ',';
				name += trim(selected_name[i]) + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );

			//alert(id)
			$('#txt_selected_id').val( trim(id) );
			$('#txt_selected_name').val( trim(name) );
		}
	</script>
	</head>
    <body>
    <div align="center" style="width:100%;">
    <form>
		<? $sql_data=sql_select("select country_id  from wo_po_color_size_breakdown   WHERE job_no_mst='$txt_job_no' and  status_active=1 and is_deleted=0 group by country_id"); ?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" id="tbl_list_search" rules="all">


            <thead>
            <th width="20"> SL </th>
             <th width="200"> Name </th>
             <th width="80"> Short </th>
             <th width=""> Region </th>
            </thead>
           </table>
         <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        	<table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>

			<?
            $couArr=array();
			//$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
			$sql_country=sql_select("select id,country_name,short_name,region from lib_country where status_active=1 ");
			foreach($sql_country as $row)
            {
				$country_library[$row[csf('id')]]=$row[csf('country_name')];
				$country_short_library[$row[csf('id')]]=$row[csf('short_name')];
				$country_region_library[$row[csf('id')]]=$row[csf('region')];
			}
            $i=1;
            foreach($sql_data as $row)
            {
                $couArr['id'][trim($row[csf('country_id')])]=trim($row[csf('country_id')]);
                $couArr['name'][trim($row[csf('country_id')])]= $country_library[trim($row[csf('country_id')])];
                if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                ?>
                <tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" id="search<? echo trim($row[csf('country_id')]);?>" onClick="js_set_value(<? echo trim($row[csf('country_id')]);?>)">
                    <td width="20"><? echo $i ?></td>
                    <td width="200">
                    <input type="hidden" name="txt_individual_id" id="txt_individual_id<?php echo trim($row[csf('country_id')]); ?>" value="<? echo trim($row[csf('country_id')]); ?>"/>
                    <input type="hidden" name="txt_individual_name" id="txt_individual_name<?php echo trim($row[csf('country_id')]); ?>" value="<? echo $country_library[trim($row[csf('country_id')])]; ?>"/>
                    <? echo $country_library[$row[csf('country_id')]]; ?>
                    </td>
                    <td width="80"><? echo $country_short_library[$row[csf('country_id')]]; ?></td>
                    <td width=""><? echo $country_region_library[$row[csf('country_id')]]; ?></td>
                </tr>
                <?
                $i++;
            }
            $nIdcouSArr=array(); $nNamecouSArr=array();
            $couSArr=explode(",",trim($txt_country));
            foreach($couSArr as $key=>$value){
                if (in_array(trim($value), $couArr['id'])) {
                    $nIdcouSArr[]=trim($value);
                    $nNamecouSArr[]=$country_library[trim($value)];
                }
            }
            ?>
             </tbody>
        </table>
        </div>
        <table width="400" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="hidden" id="txt_selected_id" name="txt_selected_id" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?>" />
                            <input type="hidden" id="txt_selected_name" name="txt_selected_name" value="<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?> " />
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </form>
    </div>
    <script>setFilterGrid('item_table',-1);</script>
    </body>
    <script>
		var txt_country='<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?> '
		var txt_country_name='<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?>'

		if(trim(txt_country) !=""){
			selected_id=trim(txt_country).split(",");
			selected_name=txt_country_name.split(",");
		}
		for(var i=0; i<selected_id.length;i++){
		   if(trim(selected_id[i]) !=""){
				toggle( document.getElementById( 'search' + trim(selected_id[i]) ), '#FFFFCC' );
		   }
		}
    </script>
   <!-- <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
    </html>
    <?
	exit();
}

if ($action=="save_update_delet_trim_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$con = connect();
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=2");
	if($component_approved==3){
		$component_approved=1;
	}

	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	$str_rep=array("<?","?>","_", "&", "*", "(", ")", "=","'","\r", "\n",'"','#');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
 	$itemColorArr=array(); $consPopupArr=array();
	for ($i=1;$i<=$total_row;$i++) //For Item Color check
	{
		$txtconsdzngmts="txtconsdzngmts_".$i;
		$txttrimrate="txttrimrate_".$i;
		$txttrimamount="txttrimamount_".$i;
		$country="country_".$i;
		$txtexper="txtexper_".$i;

		$consbreckdown="consbreckdown_".$i;
		if(str_replace("'",'',$$consbreckdown) !='')
		{
			$consbreckdown= $$consbreckdown;
		}
		else
		{
			$consbreckdown="'".create_consbreak_down($update_id,str_replace("'",'',$$txtconsdzngmts),str_replace("'",'',$$txttrimrate),str_replace("'",'',$$txttrimamount),str_replace("'",'',$$country),str_replace("'",'',$$txtexper))."'";

			$consPopupArr[str_replace("'",'',$$txtconsdzngmts)][str_replace("'",'',$$txttrimrate)][str_replace("'",'',$$txttrimamount)]=$consbreckdown;
		}

		$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
		$counter=0;
		for($c=0;$c < count($consbreckdown_array);$c++)
		{
			$counter++;
			$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

			if(str_replace("'","",$consbreckdownarr[17])=='0') $consbreckdownarr[17]='';
			if(str_replace("'","",$consbreckdownarr[17])!="")
			{
				 $item_colorName=str_replace("'","",$consbreckdownarr[17]);
				 $item_colorName="'".trim($item_colorName)."'";
				// $itemColorArr[$item_colorName]=$item_colorName;

				if (!in_array(str_replace("'","",$consbreckdownarr[17]),$new_array_itemcolor, TRUE))
				{
					$itemcolor_id = return_id( str_replace("'","",$consbreckdownarr[17]), $color_library, "lib_color", "id,color_name","158");
					$new_array_itemcolor[$itemcolor_id]=str_replace("'","",$consbreckdownarr[17]);

					$itemColorArr[trim($consbreckdownarr[17])]=$itemcolor_id;
				}
				else $itemcolor_id =  array_search(str_replace("'","",$consbreckdownarr[17]), $new_array_itemcolor);
				$itemColorArr[trim($consbreckdownarr[17])]=$itemcolor_id;

			}
			else
			{
				$itemcolor_id=0;
				$itemColorArr[trim($consbreckdownarr[17])]=$itemcolor_id;
			}
		}
	 }
	 disconnect($con);

	 /*$color_nameCond="";
	 if(count($itemColorArr)>0)
	 {
		$color_nameCond="and color_name in(".implode(",",$itemColorArr).")";
	 }
	 $color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0 $color_nameCond", "id", "color_name");*/
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");

		//if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}

		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}

		$id=return_next_id( "id", "wo_pre_cost_trim_cost_dtls", 1);
		$idsup=return_next_id( "id", "wo_pre_cost_trim_supplier", 1);
		$id1=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1);
		$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);

		$field_array="id, job_id, job_no, remark,source_id, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per, tot_cons, rate, amount, apvl_req, material_source, nominated_supp_multi, cons_breack_down, country, calculatorstring, seq, item_print, inserted_by, insert_date, status_active, is_deleted";

		$field_supp_arr="id, job_id, job_no, trimid, supplier_id, is_company, inserted_by, insert_date, status_active, is_deleted";
		//item_number_id,color_number_id,item_color_number_id,size_number_id,rate,amount,gmts_pcs,color_size_table_id
		$field_array1="id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, size_number_id, rate, amount, color_size_table_id,item_color_number_id, rate_cal_data,itemsizerate_cal_data, inserted_by, insert_date, status_active, is_deleted";

		 $q=1; $flag=1; $rID=$rID1=$rID2=$rID3=$rID4=$rIDSupp=1;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbogroup="cbogroup_".$i;
			 $txtremark="txtremark_".$i;
			 $cbosourceid="cbosourceid_".$i;
			 $txtdescription="txtdescription_".$i;
			 $txtsupref="txtsupref_".$i;
			 $cboconsuom="cboconsuom_".$i;
			 $txtconsdzngmts="txtconsdzngmts_".$i;
			  $excessper="excessper_".$i;
			   $totalcons="totalcons_".$i;
			 $txttrimrate="txttrimrate_".$i;
			 $txttrimamount="txttrimamount_".$i;
			 $cboapbrequired="cboapbrequired_".$i;
			 $cbonominasupplier="cbonominasupplier_".$i;
			 $cbotrimstatus="cbotrimstatus_".$i;
			 $updateidtrim="updateidtrim_".$i;
			 $consbreckdown="consbreckdown_".$i;
			 $country="country_".$i;
			 $calculatorstring="calculatorstring_".$i;
			 $cboitemprint="cboitemprint_".$i;
			 $seq="seq_".$i;
			 $cbomaterialsource="cbomaterialsource_".$i;

			 $txtdescription=str_replace("'",'',$$txtdescription);
			 $txttrimdescription='';
			 $txttrimdescription=str_replace($str_rep,' ',$txtdescription);

			 $txtsupref=str_replace("'",'',$$txtsupref);
			 $txttrimsupref='';
			 $txttrimsupref=str_replace($str_rep,' ',$txtsupref);

			 $txtremark=str_replace("'",'',$$txtremark);
			 $txttrimremark='';
			 $txttrimremark=str_replace($str_rep,' ',$txtremark);
			 if(str_replace("'",'',$$consbreckdown)!='')
			 {
				$consbreckdown= $$consbreckdown;
			 }
			 else
			 {
				$consbreckdown="'".$consPopupArr[str_replace("'",'',$$txtconsdzngmts)][str_replace("'",'',$$txttrimrate)][str_replace("'",'',$$txttrimamount)]."'";
			 }
			 //echo $consbreckdown; die;
			 $cons_breckdown=substr(str_replace("'","",$consbreckdown),0,100);

			$countryId = explode(",", str_replace("'", "", $$country));
			asort($countryId);
			$countryId = implode(",", $countryId);

			$data_array.="INTO wo_pre_cost_trim_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",'".$txttrimremark."',".$$cbosourceid.",".$$cbogroup.",'".$txttrimdescription."','".$txttrimsupref."',".$$cboconsuom.",".$$txtconsdzngmts.",".$$excessper.",".$$totalcons.",".$$txttrimrate.",".$$txttrimamount.",".$$cboapbrequired.",".$$cbomaterialsource.",".$$cbonominasupplier.",'".$cons_breckdown."','".$countryId."',".$$calculatorstring.",".$$seq.",".$$cboitemprint.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbotrimstatus.",0)";

			//Nominated Supp $idsup
			$cbonominasupplier=str_replace("'",'',$$cbonominasupplier);
			if(trim($cbonominasupplier)!="")
			{
				$cbonominasupplierarr=explode("_",$cbonominasupplier);
				foreach($cbonominasupplierarr as $key=>$supplierdata)
				{
					if($supplierdata!="")
					{
					$is_compleate=($key == 0 ? 2 : 1);
					$supplierdataarr=explode(",",$supplierdata);
					foreach($supplierdataarr as $sid){
						if($sid>0)
						{
							/*if ($q!=1) $dataSuppArr .=",";
							$dataSuppArr.="(".$idsup.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
							$idsup++; $q++;*/


							$dataSuppArr ="";
							$dataSuppArr="INSERT INTO wo_pre_cost_trim_supplier (".$field_supp_arr.") VALUES(".$idsup.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
							$idsup++;
							$rIDSupp=execute_query($dataSuppArr);
							if ($rIDSupp==1 && $flag==1) { $flag=1; }
							else { echo "10**trimSuppInsert-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
						}
					}
				  }
				}
			}
			//echo "10**".$dataSuppArr; die;

			//	CONS break down===============================================================================================

			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					$consbreckdownarr[7]=$consbreckdownarr[7];
					if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
					{
						$consbreckdownarr[7]=$consbreckdownarr[2];
					}

					if(str_replace("'","",$consbreckdownarr[17])=='0') $consbreckdownarr[17]='';

					$itemcolor_id=$itemColorArr[trim($consbreckdownarr[17])];
					if($itemcolor_id=="") $itemcolor_id=0;

					$country_id = explode(",", str_replace("'", "", $consbreckdownarr[5]));
					asort($country_id);
					$country_id = implode(",", $country_id);

					$data_array1="INSERT INTO wo_pre_cost_trim_co_cons_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".trim($consbreckdownarr[1])."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$country_id."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."','".$itemcolor_id."','".$consbreckdownarr[16]."','".$consbreckdownarr[18]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

					$id1=$id1+1;
					$rID=execute_query($data_array1);
					if ($rID==1 && $flag==1) { $flag=1; }
					else { echo "10**trimConsInsert-".$data_array1; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}
           //CONS break down end===============================================================================================
		   $id=$id+1;
		 }
		 //$rID=sql_insert("wo_pre_cost_trim_cost_dtls",$field_array,$data_array,0);
		 //$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);

		$querytrim="INSERT ALL ".$data_array." SELECT * FROM dual";
		$rID1=execute_query($querytrim);
		if($rID1==1 && $flag==1) $flag=1; else $flag=0;

		/*if ($dataSuppArr!="")
		{
			$rID2=sql_insert("wo_pre_cost_trim_supplier",$field_supp_arr,$dataSuppArr,1);
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}*/

		 //=======================sum=================

		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array2="id, job_id, job_no, trim_cons, trim_rate, trim_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsdzntrim_sum.",".$txtratetrim_sum.",".$txttrimamount_sum.")";
			$rID3=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
			if($rID3==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="trim_cons*trim_rate*trim_amount";
			$data_array2 ="".$txtconsdzntrim_sum."*".$txtratetrim_sum."*".$txttrimamount_sum."";
			$rID4=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
			if($rID4==1 && $flag==1) $flag=1; else $flag=0;
		}
		//echo "10**".$rID.'='.$rID1.'='.$rID2.'='.$rID3.'='.$rID4.'='.$flag; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
		$tot_com_amount=0;
		if($flag==1) $tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);

		//=======================sum End =================
		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1){
				oci_commit($con);
				check_table_status( $_SESSION['menu_id'],0);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				check_table_status( $_SESSION['menu_id'],0);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");
		$cons_str='';
		$is_sequence_validation=return_field_value("season_mandatory", "variable_order_tracking", "company_name=$cbo_company_name and variable_list=63");

		$booking_cons_arr=array();
		//echo "10**";
		if($is_sequence_validation==1)
		{
			$booking_sql="select booking_no, po_break_down_id, pre_cost_fabric_cost_dtls_id, booking_no, pre_req_amt from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_type=2 and job_no=".$update_id."";
			$booking_sql_res=sql_select($booking_sql);
			foreach($booking_sql_res as $row)
			{
				$booking_cons_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('po_break_down_id')]]=$row[csf('pre_req_amt')];
				$booking_no_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]].=$row[csf('booking_no')].',';
			}
			unset($booking_sql_res);

			$datapo_array=sql_select("select b.id, b.po_quantity, min(c.id) as color_size_table_id, c.item_number_id, c.color_number_id, c.size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and b.job_no_mst=$update_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_quantity, c.item_number_id, c.color_number_id, c.size_number_id");

			$poczQtyArr=array(); $poqtyArr=array();
			foreach($datapo_array as $row)
			{
				$poczQtyArr[$row[csf('color_size_table_id')]]+=$row[csf('order_quantity')];
				$poqtyArr[$row[csf('id')]]=$row[csf('po_quantity')];
			}
			unset($datapo_array);

			$item_ratio_array=return_library_array("select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no =$update_id", "gmts_item_id", "set_item_ratio");

			$costing_perid=str_replace("'","",$cbo_costing_per);

			if($costing_perid==1) $costing_per=12;
			else if($costing_perid==2) $costing_per=1;
			else if($costing_perid==3) $costing_per=24;
			else if($costing_perid==4) $costing_per=36;
			else if($costing_perid==5) $costing_per=48;
			else $costing_per=0;

			$msg="Booking Amount is over than Budget.";
			for ($i=1; $i<=$total_row; $i++)
			{
				$updateidtrim="updateidtrim_".$i;
				$txttrimamount="txttrimamount_".$i;
				$consbreckdown="consbreckdown_".$i;

				$pre_cost_trim_cost_dtls_id=str_replace("'","",$$updateidtrim);
				$pretrimamount=fn_number_format(str_replace("'","",$$txttrimamount),4,'.','');
				$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));

				$counter=0; $powiseCostingPerReqAmtArr=array();
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;

					$req_trim_amt=$poplanqty=$tamt_req=0;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

					$color_size_table_id=$consbreckdownarr[14];
					$po_break_down_id=$consbreckdownarr[0];
					$tamt_req=$consbreckdownarr[7];
					$gmtsitemid=$consbreckdownarr[9];
					$rate=$consbreckdownarr[12];

					$tamt_req=fn_number_format(str_replace("'","",$tamt_req),4,'.','');
					$poplanqty=$poczQtyArr[$color_size_table_id];

					$req_trim_amt =($poplanqty/$item_ratio_array[$gmtsitemid])*($tamt_req/$costing_per)*$rate;
					//echo $req_trim_amt.'='.$poplanqty.'='.$item_ratio_array[$gmtsitemid].'='.$tamt_req.'='.$costing_per.'='.$rate.'<br>';

					$powiseCostingPerReqAmtArr[$pre_cost_trim_cost_dtls_id][$po_break_down_id]['trimreqamt']+=$req_trim_amt;
				}

				foreach($powiseCostingPerReqAmtArr[$pre_cost_trim_cost_dtls_id] as $poid=>$podata)
				{
					$bomgreyreqamt=$booking_cons=$itempoWiseReqAmt=0;
					$bomgreyreqamt=$podata['trimreqamt'];
					$booking_amt=def_number_format($booking_cons_arr[$pre_cost_trim_cost_dtls_id][$poid],4,"");

					$itempoWiseReqAmt=def_number_format(($podata['trimreqamt']/$poqtyArr[$poid])*$costing_per,4,"");
					//if($pre_cost_trim_cost_dtls_id==54917)echo $itempoWiseReqAmt.'='.$booking_amt.'='.$is_sequence_validation.'<br>';
					$booking_no="";
					$booking_no=implode(",",array_filter(array_unique(explode(",",$booking_no_arr[$pre_cost_trim_cost_dtls_id]))));

					if($booking_amt>0  && $is_sequence_validation==1)
					{
						if($itempoWiseReqAmt <$booking_amt)
						{
							echo "6**".$msg.',BookingAmt='.$booking_amt.',BudgetAmt='.$itempoWiseReqAmt.',BudgetAmt='.$booking_no.'**'.$i;
							check_table_status( $_SESSION['menu_id'],0);
							disconnect($con);die;
						}
					}
				}
			}
			unset($booking_cons_arr);
		}
		//check_table_status( $_SESSION['menu_id'],0); die;

		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}

		if(check_table_status( $_SESSION['menu_id'], 1 )==0) { echo "15**1";disconnect($con); die;}

		$field_array_up="job_no*remark*source_id*trim_group*is_apply_last_update*description*brand_sup_ref*cons_uom*cons_dzn_gmts*ex_per*tot_cons*rate*amount*apvl_req*material_source*nominated_supp_multi*cons_breack_down*country*calculatorstring*seq*item_print*updated_by*update_date*status_active*is_deleted";

		$field_array="id, job_id, job_no, remark,source_id, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per, tot_cons, rate, amount, apvl_req, material_source, nominated_supp_multi, cons_breack_down, country, calculatorstring, inserted_by, insert_date, status_active, is_deleted";

		$field_supp_arr="id, job_id, job_no, trimid, supplier_id,is_company, inserted_by, insert_date, status_active, is_deleted";

		$field_array1="id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs,country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, size_number_id, rate, amount, color_size_table_id,item_color_number_id, rate_cal_data,itemsizerate_cal_data, inserted_by, insert_date, status_active, is_deleted";

		$id=return_next_id( "id","wo_pre_cost_trim_cost_dtls", 1);
		$idsup=return_next_id( "id", "wo_pre_cost_trim_supplier", 1);
		$id1=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1);
		$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);

		$q=1; $flag=1; $rID=$rID1=$rID2=$rID3=$rID4=$rIDConsDe1=$rIDSuppDe1=$rIDCons=$rIDSupp=1;
		//echo "10**";
		for($i=1; $i<=$total_row; $i++)
		{
			$cbogroup="cbogroup_".$i;
			$lastappidchk="lastappidchk_".$i;
			$txtremark="txtremark_".$i;
			$cbosourceid="cbosourceid_".$i;
			$txtdescription="txtdescription_".$i;
			$txtsupref="txtsupref_".$i;
			$cboconsuom="cboconsuom_".$i;
			$txtconsdzngmts="txtconsdzngmts_".$i;
			$excessper="excessper_".$i;
			   $totalcons="totalcons_".$i;
			$txttrimrate="txttrimrate_".$i;
			$txttrimamount="txttrimamount_".$i;
			$cboapbrequired="cboapbrequired_".$i;
			$cbonominasupplier="cbonominasupplier_".$i;
			$cbotrimstatus="cbotrimstatus_".$i;
			$updateidtrim="updateidtrim_".$i;
			$consbreckdown="consbreckdown_".$i;
			$country="country_".$i;
			$calculatorstring="calculatorstring_".$i;
			$seq="seq_".$i;
			$cboitemprint="cboitemprint_".$i;
			$cbomaterialsource="cbomaterialsource_".$i;
			

			$txtdescription=str_replace("'",'',$$txtdescription);
			$txttrimdescription='';
			$txttrimdescription=str_replace($str_rep,' ',$txtdescription);

			$txtsupref=str_replace("'",'',$$txtsupref);
			$txttrimsupref='';
			$txttrimsupref=str_replace($str_rep,' ',$txtsupref);

			$txtremark=str_replace("'",'',$$txtremark);
			$txttrimremark='';
			$txttrimremark=str_replace($str_rep,' ',$txtremark);

			$countryId = explode(",", str_replace("'", "", $$country));
			asort($countryId);
			$countryId = implode(",", $countryId);

			if(str_replace("'",'',$$updateidtrim)!="")
			{
				if(str_replace("'",'',$$consbreckdown) !='') $consbreckdown= $$consbreckdown; else $consbreckdown="";
				$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
				$id_arr[]=str_replace("'",'',$$updateidtrim);

				$data_array_up[str_replace("'",'',$$updateidtrim)] =explode("*",("".$update_id."*'".$txttrimremark."'*".$$cbosourceid."*".$$cbogroup."*".$$lastappidchk."*'".$txttrimdescription."'*'".$txttrimsupref."'*".$$cboconsuom."*".$$txtconsdzngmts."*".$$excessper."*".$$totalcons."*".$$txttrimrate."*".$$txttrimamount."*".$$cboapbrequired."*".$$cbomaterialsource."*".$$cbonominasupplier."*'".$cons_breckdown."'*'".$countryId."'*".$$calculatorstring."*".$$seq."*".$$cboitemprint."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cbotrimstatus."*0"));
				$upid=str_replace("'",'',$$updateidtrim);
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$consbreckdown)!='')
				{
					$rIDConsDe1=execute_query("delete from wo_pre_cost_trim_co_cons_dtls where wo_pre_cost_trim_cost_dtls_id =".$$updateidtrim."",0);
					if ($rIDConsDe1==1 && $flag==1) { $flag=1; }
					else { echo "10**consAvgDelUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0; $c<count($consbreckdown_array); $c++)
					{
						$counter++;
						//$field_array1="id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id,item_size, cons, pcs";
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						$consbreckdownarr[7]=$consbreckdownarr[7];
						if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
						{
							$consbreckdownarr[7]=$consbreckdownarr[2];
						}

						if(str_replace("'","",$consbreckdownarr[17])=='0') $consbreckdownarr[17]='';

						$itemcolor_id=$itemColorArr[trim($consbreckdownarr[17])];

						if($itemcolor_id=="") $itemcolor_id=0;

						$country_id = explode(",", str_replace("'", "", $consbreckdownarr[5]));
						asort($country_id);
						$country_id = implode(",", $country_id);
						$data_array1="INSERT INTO wo_pre_cost_trim_co_cons_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateidtrim.",".$update_id.",'".$consbreckdownarr[0]."','".trim($consbreckdownarr[1])."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$country_id."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."','".$itemcolor_id."','".$consbreckdownarr[16]."','".$consbreckdownarr[18]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

						$id1=$id1+1;
						// echo "10**trimUpConsInsert-".$data_array1; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
						$rIDCons=execute_query($data_array1);
						if ($rIDCons==1) { $flag=1; }
						else { echo "10**trimUpConsInsert-".$data_array1; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}//CONS break down end
				//Nominated Supp
				$cbonominasupplierarr=array();
				$cbonominasupplier_data=str_replace("'",'',$$cbonominasupplier);
				if(trim($cbonominasupplier_data)!="")
				{
					$cbonominasupplierarr=explode("_",$cbonominasupplier_data);
					foreach($cbonominasupplierarr as $key=>$supplierdata)
					{
						if($supplierdata!="")
						{
						$rIDSuppDe1=execute_query( "delete from wo_pre_cost_trim_supplier where trimid ='".$upid."'",0);
						if ($rIDSuppDe1==1 && $flag==1) { $flag=1; }
						else { echo "10**suppUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
						$is_compleate=($key == 0 ? 2 : 1);
						$supplierdataarr=explode(",",$supplierdata);
						foreach($supplierdataarr as $sid){
							if($sid>0)
							{
								//if ($q!=1)
								 $dataSuppArr ="";
								$data_SuppArr="INSERT INTO wo_pre_cost_trim_supplier (".$field_supp_arr.") VALUES(".$idsup.",".$hidd_job_id.",".$update_id.",'".$upid."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
								$idsup=$idsup+1;
								$rIDSupp=execute_query($data_SuppArr);
								if ($rIDSupp==1 && $flag==1) { $flag=1; }
								else { echo "10**trimSuppUp-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
								//$idsup++; $q++;
							}
						}
					}
					}
				}
			}
			else if(str_replace("'",'',$$updateidtrim)=="")//Insert
			{
				 if(str_replace("'",'',$$consbreckdown) !='')
				 {
					$consbreckdown= $$consbreckdown;
				 }
				 else
				 {
					 //$consbreckdown="'".create_consbreak_down($update_id,str_replace("'",'',$$txtconsdzngmts),str_replace("'",'',$$txttrimrate),str_replace("'",'',$$txttrimamount),str_replace("'",'',$$country))."'";
					 $consbreckdown="'".$consPopupArr[str_replace("'",'',$$txtconsdzngmts)][str_replace("'",'',$$txttrimrate)][str_replace("'",'',$$txttrimamount)]."'";
				 }
				 $cons_breckdown=substr(str_replace("'","",$consbreckdown),0,100);

				//if ($add_co!=0) $data_array .=",";
				//$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",'".$txttrimremark."',".$$cbosourceid.",".$$cbogroup.",'".$txttrimdescription."','".$txttrimsupref."',".$$cboconsuom.",".$$txtconsdzngmts.",".$$txttrimrate.",".$$txttrimamount.",".$$cboapbrequired.",".$$cbonominasupplier.",'".$cons_breckdown."','".$countryId."',".$$calculatorstring.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbotrimstatus.",0)";

				$data_array.="INTO wo_pre_cost_trim_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",'".$txttrimremark."',".$$cbosourceid.",".$$cbogroup.",'".$txttrimdescription."','".$txttrimsupref."',".$$cboconsuom.",".$$txtconsdzngmts.",".$$excessper.",".$$totalcons.",".$$txttrimrate.",".$$txttrimamount.",".$$cboapbrequired.",".$$cbomaterialsource.",".$$cbonominasupplier.",'".$cons_breckdown."','".$countryId."',".$$calculatorstring.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbotrimstatus.",0)";

				$upid=$id;
			    //CONS break down===============================================================================================
				//echo $consbreckdown;
				if(str_replace("'",'',$consbreckdown)!='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					for($c=0; $c<count($consbreckdown_array); $c++)
					{
						$counter++;

						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
						{
							$consbreckdownarr[7]=$consbreckdownarr[2];
						}

						$country_id = explode(",", str_replace("'", "", $consbreckdownarr[5]));
						asort($country_id);
						$country_id = implode(",", $country_id);

						if(str_replace("'","",$consbreckdownarr[17])=='0') $consbreckdownarr[17]='';

						$itemcolor_id=$itemColorArr[trim($consbreckdownarr[17])];

						if($itemcolor_id=="") $itemcolor_id=0;

						$data_array1="INSERT INTO wo_pre_cost_trim_co_cons_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".trim($consbreckdownarr[1])."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$country_id."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."','".$itemcolor_id."','".$consbreckdownarr[16]."','".$consbreckdownarr[18]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

						$id1=$id1+1;
						$rID=execute_query($data_array1);
						if ($rID==1) { $flag=1; }
						else { echo "10**trimConsInsert-".$data_array1; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				//CONS break down end===============================================================================================

				$cbonominasupplierarr=array();
				$cbonominasupplier_str=str_replace("'",'',$$cbonominasupplier);
				if(trim($cbonominasupplier_str)!="")
				{
					$cbonominasupplierarr=explode("_",$cbonominasupplier_str);
					foreach($cbonominasupplierarr as $key=>$supplierdata)
					{
					 if($supplierdata!="")
					 {
						$is_compleate=($key == 0 ? 2 : 1);
						$supplierdataarr=explode(",",$supplierdata);
						foreach($supplierdataarr as $sid){
							if($sid>0)
							{
								//$dataSuppArr ="";
								$dataSuppArr="INSERT INTO wo_pre_cost_trim_supplier (".$field_supp_arr.") VALUES(".$idsup.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."','".$is_compleate."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
								$idsup++;
								$rIDSupp=execute_query($dataSuppArr);
								if ($rIDSupp==1 && $flag==1) { $flag=1; }
								else { echo "10**trimSuppUp-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
							}
						}
					 }
					}
				}
				$id=$id+1;
				$add_co++;
			}
		}
	//	echo "10**=A=".$rIDSupp.'=A';check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
		$rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_trim_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($rID==1 && $flag==1) $flag=1; else $flag=0;
		if($data_array!="")
		{
			//$rID1=sql_insert("wo_pre_cost_trim_cost_dtls",$field_array,$data_array,0);

			$querytrim="INSERT ALL ".$data_array." SELECT * FROM dual";
			$rID1=execute_query($querytrim);
			if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		}

		/*if ($dataSuppArr!="")
		{
			$rID2=sql_insert("wo_pre_cost_trim_supplier",$field_supp_arr,$dataSuppArr,1);
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}*/
		//echo "10**insert into wo_pre_cost_trim_cost_dtls (".$field_array.") values ".$data_array;

		//$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);

 		 //=======================sum=================

		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array2="id, job_id, job_no, trim_cons, trim_rate, trim_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsdzntrim_sum.",".$txtratetrim_sum.",".$txttrimamount_sum.")";
			$rID3=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
			if($rID3==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array2="trim_cons*trim_rate*trim_amount";
			$data_array2 ="".$txtconsdzntrim_sum."*".$txtratetrim_sum."*".$txttrimamount_sum."";
			$rID4=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
			if($rID4==1 && $flag==1) $flag=1; else $flag=0;
		}
		//echo "10**".$rID.'='.$rID1.'='.$rID2.'='.$rID3.'='.$rID4.'='.$rIDConsDe1.'='.$rIDSuppDe1.'='.$rIDCons.'='.$flag; check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
		$tot_com_amount=0;
		if($flag==1) $tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}

function create_consbreak_down($job_no,$cons_value,$rate,$amount,$country,$exper)
{
	$cbo_costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no=$job_no");
	$size_library_arr=return_library_array( "select id,size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
	$item_ratio_arr=array();

	$gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no=$job_no");
	foreach($gmts_item_sql as $gmts_item_row)
	{
		$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]]=$gmts_item_row[csf('set_item_ratio')];
	}

	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";
	$country_array=array();
	$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1");
	foreach($data_country as $data_country_row){
		$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_id'][$data_country_row[csf('country_id')]]=$data_country_row[csf('country_id')];
		$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_name'][$data_country_row[csf('country_id')]]=$country_library[$data_country_row[csf('country_id')]];
	}

	$data_array=sql_select("select a.gmts_item_id, a.total_set_qnty, b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1 group by a.gmts_item_id, a.total_set_qnty, b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");
	if($exper=="") $exper=0;
	if(count($data_array)>0)
	{
		$cons_breck_down="";
		if($cbo_costing_per==1) $pcs_value=1*12;
		if($cbo_costing_per==2) $pcs_value=1*1;
		if($cbo_costing_per==3) $pcs_value=2*12;
		if($cbo_costing_per==4) $pcs_value=3*12;
		if($cbo_costing_per==5) $pcs_value=4*12;
		$oth=$totcons=$totexper=0;
		foreach( $data_array as $row )
		{
			$totitem=count($item_ratio_arr);
			$cons=def_number_format($cons_value/$totitem,8,"");
			if($exper>0)
			{
				$totexper=$cons*($exper/100);
				$totcons=$cons+$totexper;
			}else
			{
				$totcons=$cons;
				$totexper=0;
			}
			$amount=def_number_format($totcons*$rate,8,"");
			//$rate=def_number_format($amount/$cons_value,5,"");
			$pcs=$pcs_value*$item_ratio_arr[$row[csf('item_number_id')]];
			$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
			if($country_string=="") $country_string=0;
			if($cons_breck_down=="")
			{
				$cons_breck_down.=$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$cons.'_'.$oth.'_'.$pcs.'_'.$country_string.'_'.$oth.'_'.$cons.'_'.$oth.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')];
			}
			else
			{
				$cons_breck_down.="__".$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$cons.'_'.$oth.'_'.$pcs.'_'.$country_string.'_'.$oth.'_'.$cons.'_'.$oth.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')];
			}

			/*if($cons_breck_down=="")
			{
				$cons_breck_down.=$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$cons.'_'.$oth.'_'.$pcs.'_'.$country_string.'_'.$exper.'_'.$totcons.'_'.$totexper.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')];
			}
			else
			{
				$cons_breck_down.="__".$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$cons.'_'.$oth.'_'.$pcs.'_'.$country_string.'_'.$exper.'_'.$totcons.'_'.$totexper.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')];
			}*/
			//echo $cons_breck_down; die;
		}
		return $cons_breck_down;
	}
}

//*************************************************Trim Cost End ***********************************************
//*************************************************Embellishment Cost Start ***********************************************
if ($action=="show_embellishment_cost_listview")
{
	$data=explode("_",$data);
	$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
	$supplier_arr=return_library_array( "select a.id, a.supplier_name from lib_supplier a,lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(23) and a.is_deleted=0 and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id", "supplier_name");

	$header_td="";
	$costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no ='$data[0]'");
	if($costing_per==1) $header_td="Cons/ 1 Dzn Gmts";
	else if($costing_per==2) $header_td="Cons/ 1 Pcs Gmts";
	else if($costing_per==3) $header_td="Cons/ 2 Dzn Gmts";
	else if($costing_per==4) $header_td="Cons/ 3 Dzn Gmts";
	else if($costing_per==5) $header_td="Cons/ 4 Dzn Gmts";

	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[3]' and variable_list=56 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	$component_approved=0;
	//$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=3 and job_no='$data[0]'");
	$jobid=return_field_value("job_id", "wo_pre_cost_mst","job_no='$data[0]' and status_active =1 and is_deleted=0");

	$sql=sql_select("select approved as approved from precost_component_app_mst where cost_component_id=3 and job_id='$jobid'");
	if (count($sql)<1)
	{
		$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=3 and job_no='$data[0]'");
	}

	foreach($sql as $row){
		if($row[csf('approved')]==1 )
		{
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved.</p></marquee>";
		}
		else if($row[csf('approved')]==3)
		{
			$component_approved=3; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Partially Approved.</p></marquee>";
		}
	}

	$body_part_arr = return_library_array("select id,body_part_full_name from  lib_body_part where status_active=1 and is_deleted=0 and is_emplishment=1 order by body_part_full_name", "id", "body_part_full_name");

	asort($body_part_arr);
?>

	<h3 style="width:940px;" align="left" id="accordion_h1" class="accordion_h">+Embellishment Cost <? echo $approved_message; ?></h3>
       <div id="content_embellishment_cost" align="left">
    	<fieldset style="width:940px">
        	<form id="embellishment_7" autocomplete="off">
            	<table width="940" cellspacing="0" class="rpt_table" border="0" id="tbl_embellishment_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="120">Name</th>
                            <th width="100">Type</th>
                            <th width="100">Body Part</th>
                            <th width="90">Country</th>
                            <th width="120">Emb. Supplier</th>
                            <th width="80"><?=$header_td; ?></th>
                            <th width="70">Rate</th>
                            <th width="80">Amount</th>
                            <th width="80">Status</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3){
						$approved=1;
					}
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					$is_booking_arr=array();
					if($disabled!=1)
					{
						$data_arr=sql_select("select pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='6' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id");
						foreach ($data_arr as $row)
						{
							$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
						unset($data_arr);
					}

					$data_array=sql_select("select id, job_no, emb_name, emb_type, body_part_id, country, supplier_id, is_apply_last_update,cons_dzn_gmts, rate, amount, status_active, budget_on from wo_pre_cost_embe_cost_dtls where emb_name!=3 and job_no='$data[0]' and is_deleted=0 order by id"); //and status_active=1 ISD-22-07146
					if(count($data_array)<1 && $data[2]==1 && $data[4]==2)//Price Quotation
					{
						$data_array=sql_select("select id as pri_id, quotation_id, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from  wo_pri_quo_embe_cost_dtls where emb_name!=3 and quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by id");// quotation_id='$data'
						$save_update=0;
					}
					if (count($data_array)<1 && $data[2]==1)//Quick Costing
					{
						if($data[4]==1 || $data[4]==5 || $data[4]==8)//Quick Costing=1, Short Quotation V2=5, Short Quotation V6=8
						$dataQc=sql_select("select id as pri_id, mst_id as quotation_id, particular_type_id as emb_name, fab_id as emb_type, body_part_id, consumption, ex_percent, tot_cons as cons_dzn_gmts, rate, value as amount, status_active from qc_cons_rate_dtls where mst_id='$data[1]' and type=2 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
						$qcDataArr=array();
						foreach($dataQc as $erow)
						{
							$qcDataArr[$erow[csf('pri_id')]]=$erow[csf('cons_dzn_gmts')].'__'.$erow[csf('excess_per')].'__'.$erow[csf('consumption')].'__'.$erow[csf('rate')].'__'.$erow[csf('amount')];
						}
						if (count($data_array) < 1)//Quick Costing
						{
							$data_array=$dataQc;
							$save_update=0;
						}
					}
					if ( count($data_array)>0)
					{
						$i=0;
						$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,6=>$blank_array,99=>$emblishment_other_type_arr);

						foreach( $data_array as $row )
						{
							$i++;
							$country_text="";
							$countryarr=explode(",",$row[csf("country")]);
							//print_r($countryarr);
							for($cu=0 ;$cu< count($countryarr); $cu++){
								//echo "mmmm";
								$country_text.= $country_library[trim($countryarr[$cu])].",";
							}
							$country_text=rtrim($country_text,",");
							if($disabled!=1)
							{
								$booking_id='';
								$booking_id=$is_booking_arr[$row[csf('id')]];
								 $txt_dis=""; $dis=0;
								if($booking_id!="") { $dis=1; $txt_dis="disabled"; }
							}
							else $dis=$disabled;
							if($row[csf("supplier_id")]=="") $row[csf("supplier_id")]=0;

							$is_apply_last_update=$row[csf("is_apply_last_update")];

							 $msg_app=""; $changedmsgcolor="";
							 if($is_apply_last_update==2)
							 {
								 $msg_app="Color Size changed.";
								 $changedmsgcolor="red";
							 }

							 if($row[csf("status_active")]!=1) $statustd="red"; else $statustd="";
							?>
                            <tr id="embellishment_<?=$i; ?>" align="center">
                                <td title="<?=$msg_app; ?>" id="cboembnametd_<?=$i; ?>"><?=create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1," --Select Item--", $row[csf("emb_name")], "cbotype_loder(".$i.")",$dis,'1,2,4,5,6,99' ); ?></td>
                                <td id="embtypetd_<? echo $i;?>"><?=create_drop_down( "cboembtype_".$i, 100, $type_array[$row[csf("emb_name")]],"", 1, "--Select--", $row[csf("emb_type")], "check_duplicate(".$i.")",$dis,"" ); ?></td>
                                <td><?=create_drop_down( "cboembbodypart_".$i, 100, $body_part_arr,"", 1, "--Select--", $row[csf("body_part_id")], "check_duplicate(".$i.")",$dis,"" ); ?></td>
                                <td>
                                    <input  type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px; background-color:<?=$changedmsgcolor; ?>" value="<?=$country_text; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> onDblClick="open_country_popup('<?=$i.'_2'; ?>');" placeholder="Browse" readonly/>
                                    <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?=$row[csf("country")]; ?>" />
                                    <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?= $row[csf("is_apply_last_update")]; ?>" /> <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?=$row[csf("is_apply_last_update")]; ?>" />

                            	</td>
                                <td id="embsuppliertd_<?=$i; ?>">
								<input type="text" name="txtembsupplier_<?=$i; ?>" id="txtembsupplier_<?=$i;?>" class="text_boxes supplier_name" onFocus="auto_completesupplier( $('#cbo_company_name').val(), <?=$i; ?>)" onBlur="check_duplicate(<?=$i; ?>);" style="width:108px;" placeholder="Write" value="<?=$supplier_arr[$row[csf("supplier_id")]]; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> />
                                <input type="hidden" class="hidsupplier_<?=$i; ?>" id="hidembsupplier_<?=$i; ?>" name="hidembsupplier_<?=$i; ?>" value="<?=$supplier_arr[$row[csf("supplier_id")]]; ?>" />
                                <input type="hidden" name="cboembsupplierid_<? echo $i;?>" id="cboembsupplierid_<? echo $i;?>" class="text_boxes" style="width:40px;" value="<? echo $row[csf("supplier_id")]; ?>" />
                                </td>
                                <td id="txtembconsdzngmtstd_<?=$i; ?>">
                                	<input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_emb_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_emb( 'requires/pre_cost_entry_controller_v2.php?action=consumption_popup_emb', 'Consumption Entry Form',<?=$i; ?>);" readonly/>
                                </td>
                                <td id="txtembratetd_<?=$i;?>">
                                	<input type="text" id="txtembrate_<?=$i; ?>" name="txtembrate_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<?=$row[csf("rate")]; ?>" onChange="calculate_emb_cost(<?=$i; ?>);" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td id="txtembamounttd_<?=$i; ?>">
                                	<input type="text" id="txtembamount_<?=$i; ?>" name="txtembamount_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="<?=$row[csf("amount")]; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td bgcolor="<?=$statustd; ?>" id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 80, $row_status,"", 0, "0", $row[csf("status_active")], "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_embellishment_cost' );",$dis,'' );  ?></td>

                                <td id="buttontd_<?=$i; ?>">
                                    <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_embellishment_cost(<?=$i; ?>);"  <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_embellishment_cost',this );" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                    <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=  $row[csf("id")]; ?>"  />
                                    <input type="hidden" id="consbreckdownemb_<?=$i; ?>" name="consbreckdownemb_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<? //echo  $row[csf("id")]; ?>"  />
                                    <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<? if($row[csf("budget_on")]){echo  $row[csf("budget_on")];} else{echo $variArr[$row[csf("emb_name")]]; }?>"  />
                                </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,6=>$blank_array,99=>$emblishment_other_type_arr);
						$i=0;
						foreach( $emblishment_name_array as $row => $value )
						{
							$i++;
							if($i==3) continue;
							else
							{
								if($i>3) $i=$i-1;
								//echo $i;
								?>
								<tr id="embellishment_<? echo $i;?>" align="center">
                                    <td id="cboembnametd_<? echo $i;?>"><? echo create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",0,"", $row, "cbotype_loder(".$i.")",'','1,2,4,5,6,99' ); ?></td>
                                    <td id="embtypetd_<? echo $i;?>"><? echo create_drop_down( "cboembtype_".$i, 100, $type_array[$row],"", 1, "-- Select --", "", "check_duplicate(".$i.")","","" ); ?></td>
                                    <td><?=create_drop_down( "cboembbodypart_".$i, 100, $body_part_arr,"", 1, "--Select--", '', "check_duplicate(".$i.")",'',"" ); ?></td>
                                     <td>
                                        <input type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="" onDblClick="open_country_popup('<?=$i.'_2'; ?>');" placeholder="Browse" readonly/>
                                        <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="" />
                                        <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:75px" />
                                        <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:75px"  />
                                    </td>
                                    <td id="embsuppliertd_<?=$i;?>">
										<input type="text" name="txtembsupplier_<? echo $i;?>" id="txtembsupplier_<? echo $i;?>" class="text_boxes supplier_name" onFocus="auto_completesupplier( $('#cbo_company_name').val(), <? echo $i; ?>)" onBlur="check_duplicate(<? echo $i; ?>)" style="width:108px;" placeholder="Write" value="" />
                                        <input type="hidden" class="hidsupplier_<? echo $i;?>" id="hidembsupplier_<? echo $i;?>" name="hidembsupplier_<? echo $i;?>" value="" />
                                        <input type="hidden" name="cboembsupplierid_<? echo $i;?>" id="cboembsupplierid_<? echo $i;?>" class="text_boxes" style="width:40px;" value="0" />
									</td>
                                    <td id="txtembconsdzngmtstd_<?=$i; ?>">
                                    	<input type="text" id="txtembconsdzngmts_<?=$i; ?>"  name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="" onChange="calculate_emb_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_emb('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_emb', 'Consumption Entry Form',<? echo $i;?>)" readonly/>
                                    </td>
                                    <td id="txtembratetd_<?=$i; ?>">
                                    	<input type="text" id="txtembrate_<?=$i; ?>" name="txtembrate_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" onChange="calculate_emb_cost( <? echo $i;?> )" readonly/>
                                    </td>
                                    <td id="txtembamounttd_<?=$i; ?>"><input type="text" id="txtembamount_<?=$i; ?>" name="txtembamount_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="" readonly />
                                    </td>
                                    <td id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 80, $row_status,"", 0, "0", '', "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_embellishment_cost' );",'','' );  ?></td>
                                    <td id="buttontd_<?=$i;?>">
                                        <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_embellishment_cost(<?=$i; ?>);" />
                                        <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_embellishment_cost',this);" />
                                        <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value=""  />                                    	<input type="hidden" id="consbreckdownemb_<?=$i; ?>" name="consbreckdownemb_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<? //=$row[csf("id")]; ?>" />
                                        <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$variArr[$row]; ?>"  />
                                    </td>
								</tr>
								<?
								if($i==3 || $i==4 || $i==5) $i++;
							}
						}
					}
					?>
                </tbody>
            </table>
            <table width="940" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                	<tr>
                        <th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="70">Sum:</th>
                        <th width="80"><input type="text" id="txtamountemb_sum"  name="txtamountemb_sum" class="text_boxes_numeric" style="width:68px" readonly /></th>
                        <th width="80">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>

            <table width="940" cellspacing="0" class="" border="0">
                <tr>
                	<td align="center" width="100%">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                    	echo load_submit_buttons( $permission, "fnc_embellishment_cost_dtls", $save_update,0,"reset_form('embellishment_7','','',0)",7) ;
                    }
                    else
                    {
                    	echo load_submit_buttons( $permission, "fnc_embellishment_cost_dtls", $save_update,0,"reset_form('embellishment_7','','',0)",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
        </form>
        </fieldset>
    </div>
	<?
	exit();
}

if ($action=="load_drop_down_embtype")
{
	$data=explode('_',$data);

	$emb_typearr="";
	if($data[0]==1) $emb_typearr=$emblishment_print_type;
	else if($data[0]==2) $emb_typearr=$emblishment_embroy_type;
	else if($data[0]==3) $emb_typearr=$emblishment_wash_type;
	else if($data[0]==4) $emb_typearr=$emblishment_spwork_type;
	else if($data[0]==5) $emb_typearr=$emblishment_gmts_type;
	else if($data[0]==99) $emb_typearr=$emblishment_other_type_arr;
	else $emb_typearr=$blank_array;

	echo create_drop_down( "cboembtype_".$data[1], 97,$emb_typearr,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );
	exit();
}

if($action=="load_drop_down_embtype_budgeton"){
	$data=explode('_',$data);
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[2]' and variable_list=56 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	//$cboembtype="";
	$budget_on=2;
	echo "document.getElementById('empbudgeton_".$data[1]."').value = '".$variArr[$data[0]]."';\n";
	exit();
}

if($action=="save_post_session_emb"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_emb']="";
	$_SESSION['logic_erp']['cons_breck_downn_emb']=$cons_breck_downn_emb;
	echo 1;
	die;
}

if($action=="consumption_popup_emb")
{
    echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
    extract($_REQUEST);
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn_emb'];
	$itemqty_array=array();
	$job_plancut_qty=0;

	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";

	$data_array_tot_job_qty=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order,sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no'  $country_cond  and a.garments_nature='$garments_nature' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
	foreach($data_array_tot_job_qty as $data_array_tot_job_qty_row ){
		if($empbudgeton==1){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('order_quantity')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('order_quantity')];
		}
		else if($empbudgeton==2){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}else{
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		    $job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}

		$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
	}
       $item_idarr=explode(",",$item_id);
       $total_item=count($item_idarr);
	?>
	<script>
		function copy_value(value,field_id,i)
		{
			//var copy_val=document.getElementById('copy_val').checked;
			var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
			var pocolorid=document.getElementById('pocolorid_'+i).value;
			var ponoid=document.getElementById('ponoid_'+i).value;
			var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var copy_basis=$('input[name="copy_basis"]:checked').val()
			for(var j=i; j<=rowCount; j++){
				var isDisabled = document.getElementById(field_id+j).disabled;
				if(isDisabled==false)
				{
					if(document.getElementById('approved_'+j).value==0){
						if(field_id=='rate_')
						{
							if(copy_basis==0){
								document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==1){
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
								}
							}
							else if(copy_basis==2){
								if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
								}
							}
							else if(copy_basis==3){
								if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
								}
							}
							else if(copy_basis==4){
								if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
								}
							}
							//claculate_amount(j);
						}
						if(field_id=='requirement_'){
							if(copy_basis==0) document.getElementById(field_id+j).value=value;
							else if(copy_basis==1){
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==2){
								if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==3){
								if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==4){
								if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							//claculate_amount(j);
						}
					}//if(var approved=document.getElementById('approved_'+j).value==0)
				}
				var rate=document.getElementById('rate_'+j).value;
				var requirement=document.getElementById('requirement_'+j).value;
				var amount= requirement*rate;
				document.getElementById('amount_'+j).value=number_format_common(amount,5,0);
			}
			set_sum_value('amount_sum', 'amount_');
			claculate_avg();
		}

		function fn_delete_down_tr(rowNo,table_id)
		{
			if(table_id=='tbl_consmption_cost')
			{
				var numRow = $('table#tbl_consmption_cost tbody tr').length;
				if(numRow==rowNo && rowNo!=1)
				{
					$('#tbl_consmption_cost tbody tr:last').remove();
					$('#tbl_msmnt_cost tbody tr:last').remove();
				}
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
			}
		}

		function set_sum_value(des_fil_id,field_id){
			if(des_fil_id=='requirement_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='amount_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='rate_sum') var ddd={dec_type:5,comma:0};
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			math_operation( des_fil_id, field_id, '+', rowCount,ddd );
			claculate_avg();
		}

		function js_set_value(){
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var cons_breck_down="";
			for(var i=1; i<=rowCount; i++){
				var ponoid=$('#ponoid_'+i).val()
				if(ponoid==''){ ponoid=0; }
				var cbogmtsitem=$('#cbogmtsitem_'+i).val()
				if(cbogmtsitem==''){ cbogmtsitem=0; }

				var pocolorid=$('#pocolorid_'+i).val()
				if(pocolorid==''){ pocolorid=0; }
				var gmtssizesid=$('#gmtssizesid_'+i).val()
				if(gmtssizesid==''){ gmtssizesid=0; }
				var requirement=$('#requirement_'+i).val()
				if(requirement==''){ requirement=0; }
				var colorsizetableid=$('#colorsizetableid_'+i).val()
				if(colorsizetableid==''){ colorsizetableid=0; }
				var rate=$('#rate_'+i).val()
				if(rate==''){ rate=0; }
				var amount=$('#amount_'+i).val()
				if(amount==''){ amount=0; }
				var countyid=$('#cbocountry_'+i).val()
				if(countyid==''){ countyid=0; }

				if(cons_breck_down==""){
					cons_breck_down+=ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+countyid;
				}
				else{
					cons_breck_down+="__"+ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+countyid;
				}
			}
			document.getElementById('cons_breck_down').value=cons_breck_down;
			claculate_avg();
			parent.emailwindow.hide();
		}

		function claculate_avg(){
			//var tot_plancut_qty=document.getElementById('job_plancut_qty').value*1
			var item_ratio=document.getElementById('item_ratio').value*1
			var total_item=document.getElementById('total_item').value*1
			var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0;
			var rowCount = $('#tbl_consmption_cost tr').length-1;

			for(var i=1; i<=rowCount; i++){
				if(document.getElementById('requirement_'+i).value =='' || document.getElementById('requirement_'+i).value ==0){
					continue;
				}
				else{
					var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1
					var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
					var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
					var requirement=document.getElementById('requirement_'+i).value*1
					var calculated_cons_percent=(requirement*plan_cut_percent)/100;
					calculated_cons+=calculated_cons_percent;
					var amount=document.getElementById('amount_'+i).value*1
					var calculated_amount_percent=(amount*plan_cut_percent)/100;
					calculated_amount+=calculated_amount_percent;
				}
			}
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons,5, 0);
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount,5, 0);
			document.getElementById('calculated_rate').value=number_format_common((calculated_amount/calculated_cons), 5, 0);
		}

		function claculate_amount(i){
			var rate=document.getElementById('rate_'+i).value;
			var requirement=document.getElementById('requirement_'+i).value;
			var amount= requirement*rate;
			document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
			set_sum_value( 'amount_sum', 'amount_' );
			claculate_avg();
		}
    </script>
	</head>
	<body>
    <div><?=load_freeze_divs ("../../../",""); ?></div>
    <script>freeze_window(0);</script>
    <div align="center" style="width:99%;" >
    	<fieldset>
            <legend><?=$body_part_id.'.'.$body_part[$body_part_id].' Costing '.$costing_per[$cbo_costing_per]; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?=create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            	<!--<b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>  -->
                <input type="radio" name="copy_basis" value="0" checked>Copy To All
                <input type="radio" name="copy_basis" value="1">Copy Size Wise
                <input type="radio" name="copy_basis" value="2">Copy Color Wise
                <input type="radio" name="copy_basis" value="3">Copy Item Wise
                <input type="radio" name="copy_basis" value="4">Copy Po Wise
                <input type="reset" value="Reset">
            </legend>
        	<form id="consumptionform_1" autocomplete="off">
                <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<?=$cbo_company_id; ?>"/>
                <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<?=$cbo_costing_per; ?>"/>
                <input type="hidden" id="cons_breck_down" name="cons_breck_down"  width="500" value="<?=$cons_breck_downn;?>"/>
                <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<?=$job_plancut_qty; ?>"/>
                <input type="hidden" id="item_ratio" name="item_ratio" value="<?=$tot_set_qnty; ?>"/>
                <input type="hidden" id="total_item" name="item_ratio" value="<?=$total_item; ?>"/>
            </form>
            <table width="930" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="30">SL</th>
                        <th width="130">PO NO</th>
                        <th width="110">Country</th>
                        <th width="130">Gmts.Item</th>
                        <th width="100">Gmts Color</th>
                        <th width="100">Gmts Size</th>
                        <th width="65">Cons</th>
                        <th width="60">Rate</th>
                        <th width="90">Amount</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
					$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
					$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
					$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
                    $component_approved=0;
                    $sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=3 and job_no='$txt_job_no'");
                    foreach($sql as $row){
						if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
					}
					$data_array=explode("__",$cons_breck_downn);
					if($data_array[0]==""){
						$data_array=array();
                    }

					$country_array=array();
					$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
					foreach($data_country as $cou_row){
						 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_id'][$cou_row[csf('country_id')]]=$cou_row[csf('country_id')];
						 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_name'][$cou_row[csf('country_id')]]=$country_library[$cou_row[csf('country_id')]];
					}
					//print_r ($country_array);
                    $data_array=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order,sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' $country_cond and a.garments_nature='$garments_nature' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
                    //=======================================
					if($db_type==0) $booking_qty="IFNULL(wo_qnty,0)"; else if ($db_type==2) $booking_qty="nvl(wo_qnty,0)";
					$is_booking_arr=array();
                    if($embupdateid != ""){
						$is_booking_arr=array();
						/*if($cbo_approved_status!=1)
						{*/
							$data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$embupdateid' and booking_type='6' and status_active=1 and is_deleted=0 and $booking_qty>0 group by po_break_down_id, pre_cost_fabric_cost_dtls_id");
							foreach($data_arr as $row)
							{
								$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
							}
							unset($data_arr);
						//}

						$row_arr_data="";
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_emb_cost_dtls_id=$embupdateid order by id");
						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $emb_con_row){
							if($emb_con_row[csf('country_id')]=="") $emb_con_row[csf('country_id')]=0;
							$data_array_cons[$emb_con_row[csf('color_size_table_id')]]=$emb_con_row[csf('po_break_down_id')]."_".$emb_con_row[csf('item_number_id')]."_".$emb_con_row[csf('color_number_id')]."_".$emb_con_row[csf('size_number_id')]."_".$emb_con_row[csf('requirment')]."_".$emb_con_row[csf('rate')]."_".$emb_con_row[csf('amount')]."_".$emb_con_row[csf('color_size_table_id')]."_".$emb_con_row[csf('country_id')];
							//$row_arr_data.=$row_arr."__";
							$poWiseConsArr[$emb_con_row[csf('po_break_down_id')]][$emb_con_row[csf('item_number_id')]]=$emb_con_row[csf('requirment')]."_".$emb_con_row[csf('rate')]."_".$emb_con_row[csf('amount')];
						}
						//$row_arr_data=rtrim($row_arr_data,"__");
						//$data_array_cons=explode("__",$row_arr_data);
                    }
					else
					{
						$data_array_cons=explode("__",$row_arr_data);
					}

                    if($embupdateid == "") $data_array_cons=explode("__",$cons_breck_downn);

                    if($precostapproved==1 || $component_approved==1) $disabled=1; else $disabled=0;
					/*$cons_up=0;
					if(count($data_arr)>0 &&  $disabled!=1)
					{
						$disabled=1; $cons_up=1;
					}*/
                    //=======================================
                    if ( count($data_array)>0){
						$i=0;
						$pcsgmts=0;
						foreach( $data_array as $row )
						{
							if($embupdateid != "") $data=explode('_',$data_array_cons[$row[csf('color_size_table_id')]]);
							else $data=explode('_',$data_array_cons[$i]);
							$i++;
							if($empbudgeton==1) $pcsgmts=$row[csf('order_quantity')];
							else if($empbudgeton==2) $pcsgmts=$row[csf('plan_cut_qnty')];
							else $pcsgmts=$row[csf('plan_cut_qnty')];

							$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
							$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);

							$po_country_arr=explode(",",$country_string);

							$countrydata=explode(",",$data[8]);
							$arr_d=array_diff($countrydata, $po_country_arr);
							$arr_d2=array_diff($countrydata, $arr_d);
							$country_name="";

							for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
								$country_name.=	$country_library[$countrydata[$countryindex]].",";
							}
							$country_idstring=implode(",",$arr_d2);

							if(count($arr_d)>0 && count($countrydata)>0 )
							{
								$country_name_pre="";
								for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
									$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
								}
								$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
								if(rtrim($country_name_pre,",")!=""){
									$bgc="#D41F00";
								}
							}
							else{
								$title=""; $bgc="#FFFFFF";
							}
							$cons_fld=0;
							if($disabled!=1)
							{
								//echo $is_booking_arr[$row[csf('id')]];
								if($is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0 || $data[4]=="") $cons_fld=1;
							}
							$powiseConsdtls="";
							if($data[4]=="")//if update mode cons null and new color or size add
							{
								//$powiseConsdtls=explode("_",$poWiseConsArr[$row[csf('id')]][$row[csf('item_number_id')]]);

								/*$data[4]=$powiseConsdtls[0];
								$data[5]=$powiseConsdtls[1];
								$data[6]=$powiseConsdtls[2];*/
							}
							?>
							<tr id="break_<?=$i; ?>" align="center">
                                <td><?=$i; ?></td>
                                <td>
                                    <input type="text" id="pono_<?=$i; ?>" name="pono_<?=$i; ?>" class="text_boxes" style="width:117px" value="<?=$row[csf('po_number')]; ?>" readonly />
                                    <input type="hidden" id="ponoid_<?=$i; ?>" name="ponoid_<?=$i; ?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="hidden" id="cbocountry_<?=$i; ?>" name="cbocountry_<?=$i; ?>" style="width:75px" value="<?=$country_string; ?>" readonly />
                                    <input type="text" id="cbocountryname_<?=$i; ?>" name="cbocountryname_<?=$i; ?>" onClick="open_country_popup('<?=$i.'_2'; ?>')" class="text_boxes" style="width:97px; background-color:<?=$bgc; ?>" value="<?=$country_string_name; ?>" readonly title="<?=$title; ?>" disabled />
                                </td>
                                <td><?=create_drop_down( "cbogmtsitem_".$i, 130, $garments_item,"", 0, "",$row[csf('item_number_id')], "",1); ?></td>
                                <td>
                                    <input type="text" id="pocolor_<?=$i;?>" name="pocolor_<?=$i; ?>" class="text_boxes" style="width:87px" value="<?=$color_library[$row[csf('color_number_id')]]; ?>" readonly />
                                    <input type="hidden" id="pocolorid_<?=$i;?>" name="pocolorid_<?=$i; ?>" class="text_boxes" style="width:45px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
                                </td>
                                <td>
                                    <input type="text" id="gmtssizes_<?=$i; ?>"  name="gmtssizes_<?=$i; ?>" class="text_boxes" style="width:87px" value="<?=$size_library[$row[csf('size_number_id')]]; ?>" readonly>
                                    <input type="hidden" id="gmtssizesid_<?=$i; ?>"  name="gmtssizesid_<?=$i; ?>" class="text_boxes" style="width:55px" value="<?=$row[csf('size_number_id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="text" id="requirement_<?=$i; ?>" onChange="claculate_amount(<?=$i; ?>);copy_value(this.value,'requirement_',<?=$i; ?>); set_sum_value( 'requirement_sum', 'requirement_' )" name="requirement_<?=$i; ?>" class="text_boxes_numeric" style="width:52px" value="<? if ($data[4]==""){ echo $price_quatation_requirment[$row[csf('size_number_id')]];} else { echo $data[4]; } ?>" <? if($cons_up==0) { if($disabled==1){ echo "disabled";} else{ echo "";} }?> />
                                </td>
                                <td>
                                    <input type="text" id="rate_<?=$i; ?>" name="rate_<?=$i; ?>" onChange="claculate_amount(<?=$i; ?>); copy_value(this.value,'rate_',<?=$i; ?>);" onBlur="set_sum_value( 'rate_sum', 'rate_' );" class="text_boxes_numeric" style="width:47px" value="<?=$data[5]; ?>" <? if($data[5]!="") { if($cons_fld==1 || $disabled==1) echo "disabled "; else{ echo "";} }?>/>
                                </td>
                                <td>
                                    <input type="text" id="amount_<?=$i; ?>" name="amount_<?=$i; ?>" class="text_boxes_numeric" style="width:77px" value="<?=$data[6]; ?>" readonly />
                                </td>
                                <td id="add_<?=$i; ?>">
                                    <input type="hidden" id="pcsgmts_<?=$i; ?>" name="pcsgmts_<?=$i; ?>" onBlur="set_sum_value('pcs_sum', 'pcs_');" class="text_boxes_numeric" style="width:45px" value="<?=$pcsgmts; ?>">
                                    <input type="hidden" id="itempcsgmts_<?=$i ;?>" name="itempcsgmts_<?=$i; ?>" onBlur="set_sum_value( 'pcs_sum', 'pcs_');" class="text_boxes_numeric" style="width:25px" value="<?=$itemqty_array[$row[csf('item_number_id')]]; ?>">
                                    <input type="hidden" id="colorsizetableid_<?=$i; ?>" name="colorsizetableid_<?=$i; ?>" class="text_boxes" style="width:35px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                                    <input type="button" id="decreaserow_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<?=$i; ?>,'tbl_consmption_cost');" disabled/>
                                    <input type="hidden" id="approved_<?=$i; ?>" name="approved_<?=$i; ?>"  class="text_boxes_numeric" style="width:25px" value="<?=$disabled; ?>">
                                </td>
							</tr>
							<?
						}
                    }
                    ?>
                </tbody>
            </table>
            <table width="930" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="605">SUM : </th>
                        <th width="65"><input type="text" id="requirement_sum" name="requirement_sum" class="text_boxes_numeric" style="width:52px" readonly></th>
                        <th width="60"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="90">
                            <input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:77px" readonly>
                            <input type="hidden" id="plancutqty_sum" name="plancutqty_sum" class="text_boxes_numeric" style="width:55px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="605">AVG : </th>
                        <th width="65"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:52px" value="<?=$calculated_conss;?>" readonly></th>
                        <th width="60"><input type="text" id="calculated_rate" name="calculated_rate" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="90">
                            <input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:77px" readonly>
                            <input type="hidden" id="calculated_plancutqty" name="calculated_plancutqty" class="text_boxes_numeric" style="width:55px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
			<script>
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
            </script>
        </form>
        </fieldset>
    </div>
    <div align="center" style="width:100%;" >
        <fieldset>
            <table width="910" cellspacing="0" class="" border="0" rules="all">
                 <tr>
                    <td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value()"/> </td>
                </tr>
            </table>
        </fieldset>
    </div>
    </body>
    <script>release_freezing(); $('.form_caption').hide(); </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

function create_consbreak_down_emb($job_no,$cons_value,$rate,$amount,$country="")
{
	$cbo_costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no=$job_no");
	$size_library_arr=return_library_array( "select id,size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name"  );

	$item_ratio_arr=array();
	$gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no=$job_no");
	foreach($gmts_item_sql as $gmts_item_row){
		$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]]=$gmts_item_row[csf('set_item_ratio')];
	}
	$country_cond ="";

	$data_array=sql_select("select a.gmts_item_id, a.total_set_qnty, b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond and a.status_active=1 and b.status_active=1 and c.status_active=1 group by a.gmts_item_id,a.total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id, c.item_number_id, color_order, size_order");

	if ( count($data_array)>0)
	{
		$cons_breck_down="";
		if($cbo_costing_per==1) $pcs_value=1*12;
		if($cbo_costing_per==2) $pcs_value=1*1;
		if($cbo_costing_per==3) $pcs_value=2*12;
		if($cbo_costing_per==4) $pcs_value=3*12;
		if($cbo_costing_per==5) $pcs_value=4*12;
		$oth=0;
		foreach( $data_array as $row )
		{
			$totitem=count($item_ratio_arr);
			$cons=def_number_format($cons_value/$totitem,5,"");
			$amount=def_number_format($cons*$rate,5,"");
			$pcs=$pcs_value*$item_ratio_arr[$row[csf('item_number_id')]];

			if($cons_breck_down=="")
			{
				$cons_breck_down.=$row[csf('id')].'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$cons.'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_0_0';
			}
			else
			{
				$cons_breck_down.="__".$row[csf('id')].'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$cons.'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_0_0';
			}
		}
		return $cons_breck_down;
	}
}

if ($action=="save_update_delet_embellishment_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=3");
	if($component_approved==3){
		$component_approved=1;
	}

	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}
		$add_comma=0;
		$fail1=0;
		$id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;

		$id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;

		$field_array="id, job_id, job_no, emb_name, emb_type, body_part_id, country, supplier_id, cons_dzn_gmts, rate, amount, budget_on, inserted_by, insert_date, status_active, is_deleted";
		$field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id";
		for ($i=1;$i<=$total_row;$i++)
		{
			$cboembname="cboembname_".$i;
			$cboembtype="cboembtype_".$i;
			$cboembbodypart="cboembbodypart_".$i;
			$countryid="country_".$i;
			$cboembsupplierid="cboembsupplierid_".$i;
			$txtembconsdzngmts="txtembconsdzngmts_".$i;
			$txtembrate="txtembrate_".$i;
			$txtembamount="txtembamount_".$i;
			$cboembstatus="cboembstatus_".$i;
			$embupdateid="embupdateid_".$i;
			$consbreckdownemb="consbreckdownemb_".$i;
			$empbudgeton="empbudgeton_".$i;

			if(str_replace("'","",$$cboembsupplierid)=="") $cboembsupplierid=0; else $cboembsupplierid=str_replace("'","",$$cboembsupplierid);


			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$cboembbodypart.",".$$countryid.",'".$cboembsupplierid."',".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
			//	CONS break down===============================================================================================

			if(str_replace("'",'',$$consbreckdownemb) !='')
			{
				$consbreckdown= $$consbreckdownemb;
			}
			else
			{
				$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
			}

			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0; $data_array1=""; $add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0; $data_array1=""; $add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
			//CONS break down end===============================================================================================
			$id=$id+1;
		}
		$rID=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");


		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1";disconnect($con); die;}
		$field_array_up="job_no*emb_name*emb_type*body_part_id*country*is_apply_last_update*supplier_id*cons_dzn_gmts*rate*amount*budget_on*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, emb_name, emb_type, body_part_id, country, supplier_id, cons_dzn_gmts, rate, amount, budget_on, inserted_by, insert_date, status_active, is_deleted";
		$field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id";

		$add_co=0; $add_comma=0; $fail1=0;
		$id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1) ;
		$id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1) ;

		for ($i=1;$i<=$total_row;$i++)
		{
			$cboembname="cboembname_".$i;
			$cboembtype="cboembtype_".$i;
			$cboembbodypart="cboembbodypart_".$i;
			$countryid="country_".$i;
			$lastappidchk="lastappidchk_".$i;
			$cboembsupplierid="cboembsupplierid_".$i;
			$txtembconsdzngmts="txtembconsdzngmts_".$i;
			$txtembrate="txtembrate_".$i;
			$txtembamount="txtembamount_".$i;
			$cboembstatus="cboembstatus_".$i;
			$embupdateid="embupdateid_".$i;
			$consbreckdownemb="consbreckdownemb_".$i;
			$empbudgeton="empbudgeton_".$i;

			if(str_replace("'","",$$cboembsupplierid)=="") $cboembsupplierid=0; else $cboembsupplierid=str_replace("'","",$$cboembsupplierid);

			if(str_replace("'",'',$$embupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$embupdateid);
				//$data_array_up[str_replace("'",'',$$embupdateid)] =explode(",",("".$update_id.",".$$cboembname.",".$$cboembtype.",".$$countryid.",".$$cboembsupplierid.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0"));

				$data_array_up[str_replace("'",'',$$embupdateid)] =explode("*",("".$update_id."*".$$cboembname."*".$$cboembtype."*".$$cboembbodypart."*".$$countryid."*".$$lastappidchk."*'".$cboembsupplierid."'*".$$txtembconsdzngmts."*".$$txtembrate."*".$$txtembamount."*".$$empbudgeton."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cboembstatus."*0"));

				//$data_array_up[str_replace("'",'',$$updateidtrim)] =explode("*",("".$update_id."*".$$txtremark."*".$$cbogroup."*'".$txttrimdescription."'*".$$txtsupref."*".$$cboconsuom."*".$$txtconsdzngmts."*".$$txttrimrate."*".$$txttrimamount."*".$$cboapbrequired."*".$$cbonominasupplier."*'".$cons_breckdown."'*".$$country."*".$$calculatorstring."*".$$seq."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cbotrimstatus."*0"));
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownemb) !='')
				{
					$consbreckdown= $$consbreckdownemb;
				}
				else
				{
					//$consbreckdown="'".create_consbreak_down_emb( $update_id,str_replace("'",'', $$txtembconsdzngmts), str_replace( "'",'',$$txtembrate), str_replace("'",'',$$txtembamount))."'";
					$consbreckdown="";
				}
				if(str_replace("'",'',$consbreckdown) !='')
				{
					//echo "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."";
					$rID_de1=execute_query( "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."",0);
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".str_replace("'",'',$$embupdateid).",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}

					if ($data_array1!="" && $counter!=100)
					{
						//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				//CONS break down end===============================================================================================
			}
			if(str_replace("'",'',$$embupdateid)=="")
			{
				if ($add_co!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$cboembbodypart.",".$$countryid.",'".$cboembsupplierid."',".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownemb) !='')
				{
					$consbreckdown= $$consbreckdownemb;
				}
				else
				{
					$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
				}
				if(str_replace("'",'',$consbreckdown) !='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					//$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
						//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}
					if ($data_array1!="" && $counter!=100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				//CONS break down end===============================================================================================
				$id=$id+1;
				$add_co++;
			}
		}
		//echo "10**".bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ); die;
		$rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($data_array !="")
		{
			$rID1=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		}

		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
        check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Embellishment Cost End ***********************************************
//*************************************************Wash Cost Start ***********************************************

if ($action=="show_wash_cost_listview")
{
	$data=explode("_",$data);
	//$data=explode("_",$data);
	$header_td="";
	$costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no ='$data[0]'");
	if($costing_per==1) $header_td="Cons/ 1 Dzn Gmts";
	else if($costing_per==2) $header_td="Cons/ 1 Pcs Gmts";
	else if($costing_per==3) $header_td="Cons/ 2 Dzn Gmts";
	else if($costing_per==4) $header_td="Cons/ 3 Dzn Gmts";
	else if($costing_per==5) $header_td="Cons/ 4 Dzn Gmts";
	$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");

	$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data[3]'  and variable_list=21 and status_active=1 and is_deleted=0");
	if($conversion_from_chart=="")
	{
		$conversion_from_chart=2;
	}
	$component_approved=0;
	//$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=4 and job_no='$data[0]'");
	$jobid=return_field_value("job_id", "wo_pre_cost_mst","job_no='$data[0]' and status_active =1 and is_deleted=0");

	$sql=sql_select("select approved as approved from precost_component_app_mst where cost_component_id=4 and job_id='$jobid'");
	if (count($sql)<1)
	{
		$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=4 and job_no='$data[0]'");
	}
	foreach($sql as $row){
		if($row[csf('approved')]==1 )
		{
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved.</p></marquee>";
		}
		else if($row[csf('approved')]==3)
		{
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Partially Approved.</p></marquee>";
		}
	}
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id, embellishment_budget_id from variable_order_tracking where company_name='$data[3]' and variable_list=56 and embellishment_id=3 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		//echo $vari_row[csf('embellishment_id')].'DDFF';
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	?>
    <h3 style="width:800px;" align="left" class="accordion_h" >+Wash Cost <?=$approved_message; ?></h3>
	<div id="content_embellishment_cost">
        <fieldset style="width:800px">
            <form id="wash_7" autocomplete="off">
            <table width="800" cellspacing="0" class="rpt_table" border="0" id="tbl_wash_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="120">Name</th>
                        <th width="100">Type</th>
                        <th width="90">Country</th>
                        <th width="90"><?=$header_td; ?></th>
                        <th width="90">Rate</th>
                        <th width="100">Amount</th>
                        <th width="90">Status</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $save_update=1;
                    $approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3) $approved=1;

                    if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;
                    $data_array=sql_select("select id, job_no, emb_name, emb_type, country, cons_dzn_gmts, rate, amount, is_apply_last_update, status_active, budget_on from wo_pre_cost_embe_cost_dtls where emb_name=3 and job_no='$data[0]' and is_deleted=0 order by id");//and status_active=1 ISD-22-07146

					$is_booking_arr=array();
					if($disabled!=1)
					{
						$data_arr=sql_select("select pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='6' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id");
						foreach ($data_arr as $row)
						{
							$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
						unset($data_arr);
					}

                    if(count($data_array)<1 && $data[2]==1 && $data[4]==2)//Price Quotation
                    {
						$data_array=sql_select("select id as pri_id, quotation_id, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from wo_pri_quo_embe_cost_dtls where emb_name=3 and quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by id");// quotation_id='$data'
						$save_update=0;
                    }
					if (count($data_array)<1 && $data[2]==1)//Quick Costing
					{
						if($data[4]==1 || $data[4]==5 || $data[4]==8)//Quick Costing=1, Short Quotation V2=5, Short Quotation V6=8
						$dataQc=sql_select("select id as pri_id, mst_id as quotation_id, 3 as emb_name, particular_type_id as emb_type, consumption, ex_percent, tot_cons as cons_dzn_gmts, rate, value as amount, status_active from qc_cons_rate_dtls where mst_id='$data[1]' and type=3 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
						$qcDataArr=array();
						foreach($dataQc as $erow)
						{
							$qcDataArr[$erow[csf('pri_id')]]=$erow[csf('cons_dzn_gmts')].'__'.$erow[csf('ex_percent')].'__'.$erow[csf('consumption')].'__'.$erow[csf('rate')].'__'.$erow[csf('amount')];
						}
						if (count($data_array) < 1)//Quick Costing
						{
							$data_array=$dataQc;
							$save_update=0;
						}
					}
                    if( count($data_array)>0)
                    {
						$i=0;
						//$type_array=array(1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$blank_array);
						foreach( $data_array as $row )
						{
							$i++;
							$country_text="";
							$countryarr=explode(",",$row[csf("country")]);
							//print_r($countryarr);
							for($cu=0 ;$cu< count($countryarr); $cu++){
								$country_text.= $country_library[trim($countryarr[$cu])].",";
							}
							$country_text=rtrim($country_text,",");

							if($disabled!=1)
							{
								$booking_id=''; $txt_dis=""; $dis=0;
								$booking_id=$is_booking_arr[$row[csf('id')]];
								if($booking_id!="") { $dis=1; $txt_dis="disabled"; }
							}
							else $dis=$disabled;
							$is_apply_last_update=$row[csf("is_apply_last_update")];
							$is_last_app_msg=""; $changedmsgcolor="";
							if($is_apply_last_update==2)
							{
								$is_last_app_msg="Color Size Changed.";
								$changedmsgcolor="red";
							}
							if($row[csf("status_active")]!=1) $statustd="red"; else $statustd="";
							?>
							<tr id="embellishment_<?=$i; ?>" align="center">
                                <td title="<?=$is_last_app_msg; ?>" id="cboembnametd_<?=$i; ?>"><?=create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1," -- Select Item --", $row[csf("emb_name")], "",1,''); ?></td>
                                <td id="embtypetd_<?=$i; ?>"><?=create_drop_down( "cboembtype_".$i, 100, $emblishment_wash_type,"", 1, "-- Select --", $row[csf("emb_type")], "check_duplicate_wash(".$i.")",$dis,"" ); ?></td>
                                <td>
                                    <input type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px; background-color:<?=$changedmsgcolor; ?>" value="<?=$country_text; ?>" <? if($dis==0){echo "";}else{echo "disabled";} ?> onDblClick="open_country_popup('<?=$i.'_2'; ?>')" placeholder="Browse" readonly/>
                                    <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:70px" value="<?=$row[csf("country")]; ?>" />
                                    <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:70px" value="<?= $row[csf("is_apply_last_update")]; ?>" />
                                     <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:70px" value="<?=$row[csf("is_apply_last_update")]; ?>" />
                            	</td>
                                <td id="txtembconsdzngmtstd_<?=$i; ?>">
                                <input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_wash_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_wash( 'requires/pre_cost_entry_controller_v2.php?action=consumption_popup_wash', 'Consumption Entry Form', <?=$i; ?>);" placeholder="Browse" readonly/></td>
                                <td id="txtembratetd_<?=$i; ?>"><input type="text" id="txtembrate_<?=$i; ?>" name="txtembrate_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="<?=$row[csf("rate")]; ?>" onChange="calculate_wash_cost(<?=$i;?>);" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/></td>
                                <td id="txtembamounttd_<?=$i; ?>"><input type="text" id="txtembamount_<?=$i; ?>" name="txtembamount_<?=$i; ?>" class="text_boxes_numeric" style="width:88px" value="<?=$row[csf("amount")]; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td bgcolor="<?=$statustd; ?>" id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 90, $row_status,"", 0, "0", $row[csf("status_active")], "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_wash_cost');",$dis,'' );  ?></td>

                                <td id="buttontd_<?=$i; ?>">
                                <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_wash_cost(<?=$i; ?>,<?=$conversion_from_chart; ?>);"  <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_wash_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>"  />
                                <input type="hidden" id="embratelibid_<?=$i; ?>" name="embratelibid_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("charge_lib_id")]; ?>"  />
                                <input type="hidden" id="consbreckdownwash_<?=$i; ?>" name="consbreckdownwash_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<? //echo  $row[csf("id")]; ?>"  />
                                <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<? if($row[csf("budget_on")]){echo  $row[csf("budget_on")];}else{ echo $variArr[3]; } ?>"  />
                                </td>
                            </tr>
                            <?
						}
                    }
                    else
                    {
						$save_update=0; $i=0;
						$i++;
						?>
						<tr id="embellishment_<?=$i; ?>" align="center">
                            <td id="cboembnametd_<?=$i; ?>"><?=create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1,"--Select--", 3, "",1,''); ?></td>
                            <td id="embtypetd_<?=$i; ?>"><?=create_drop_down( "cboembtype_".$i, 100, $emblishment_wash_type,"", 1, "-- Select --", "", "check_duplicate_wash(".$i.")","","" ); ?></td>
                            <td>
                                <input  type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="" onDblClick="open_country_popup('<?=$i.'_1'; ?>')" placeholder="Browse" readonly/>
                                <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:55px" value="" />
                                <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:55px"  />
                                <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:55px"  />
                            </td>
                            <td id="txtembconsdzngmtstd_<?=$i; ?>">
                            	<input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="" onChange="calculate_wash_cost(<?=$i; ?>)" onDblClick="set_session_large_post_data_wash( 'requires/pre_cost_entry_controller_v2.php?action=consumption_popup_wash', 'Consumption Entry Form',<?=$i; ?>);" placeholder="Browse" readonly />
                            </td>
                            <td id="txtembratetd_<?=$i; ?>">
                            	<input type="text" id="txtembrate_<?=$i; ?>" name="txtembrate_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="" onChange="calculate_wash_cost(<?=$i; ?>);" readonly />
                            </td>
                            <td id="txtembamounttd_<?=$i; ?>"><input type="text" id="txtembamount_<?=$i; ?>"  name="txtembamount_<?=$i; ?>" class="text_boxes_numeric" style="width:88px" value="" readonly /></td>
                            <td id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 90, $row_status,"", 0, "0", '', "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_wash_cost');",'','' );  ?></td>
                            <td id="buttontd_<?=$i;?>">
                                <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_wash_cost(<?=$i; ?>,<?=$conversion_from_chart; ?>);" />
                                <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_wash_cost',this);" />
                                <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="embratelibid_<?=$i; ?>" name="embratelibid_<?=$i; ?>"  class="text_boxes" style="width:20px"  readonly/>
                                <input type="hidden" id="consbreckdownwash_<?=$i; ?>" name="consbreckdownwash_<?=$i; ?>" class="text_boxes" style="width:20px" value="" />
                                <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$variArr[3];?>"  />
                            </td>
						</tr>
						<?
                    }
                    ?>
                </tbody>
            </table>
            <table width="800" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                    	<th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="90">Sum :</th>
                        <th width="100"><input type="text" id="txtamountemb_sum" name="txtamountemb_sum" class="text_boxes_numeric" style="width:88px" readonly /></th>
                        <th width="90">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="800" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                        echo load_submit_buttons( $permission, "fnc_wash_cost_dtls", $save_update,0,"reset_form('wash_7','','',0)",7) ;
                    }
                    else
                    {
                        echo load_submit_buttons( $permission, "fnc_wash_cost_dtls", $save_update,0,"reset_form('wash_7','','',0)",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
	</div>
	<?
	exit();
}

if($action=="wash_chart_popup")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(id,rate)
		{
			//var data=data.split("_");
			document.getElementById('charge_id').value=id;
			document.getElementById('charge_value').value=rate;
			parent.emailwindow.hide();
		}

		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}
	</script>
	</head>
	<body>
        <div align="center">
        	<form>
                <input type="hidden" id="charge_id" name="charge_id" />
                <input type="hidden" id="charge_value" name="charge_value" />
                <?
					$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
					$color_library_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
					$arr=array (0=>$company_arr,2=>$process_type,3=>$conversion_cost_head_array,4=>$color_library_arr,5=>$fabric_typee,7=>$unit_of_measurement,8=>$production_process,9=>$row_status);
                ?>
                <table width="900" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
                    <thead>
                        <th width="50">SL</th>
                        <th width="100">Company Name</th>
                        <th width="150">Const. Compo.</th>
                        <th width="70">Process Type</th>
                        <th width="70">Process Name</th>
                        <th width="70">Color</th>
                        <th width="80">Width/Dia type</th>
                        <th width="60">In House Rate</th>
                        <th width="80">UOM</th>
                        <th width="60">Rate type</th>
                        <th>Status</th>
                    </thead>
                </table>
                <div style=" width:917; overflow:scroll-y; max-height:300px">
                    <table width="900" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
						<?
                        $sql_data=sql_select("select id, comapny_id, const_comp, process_type_id, process_id, color_id, width_dia_id, dia_range, gsm_range, efficiency_range,in_house_rate, uom_id, rate_type_id, status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id =7 and comapny_id=$cbo_company_name");

                        $i=1;
                        foreach($sql_data as $row)
                        {
							if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							?>
							<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")]; ?>">
                                <td width="50"><? echo $i; ?></td>
                                <td width="100"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
                                <td width="150"><? echo $row[csf("const_comp")]; ?></td>
                                <td width="70"><? echo $process_type[$row[csf("process_type_id")]]; ?></td>
                                <td width="70"><? echo $conversion_cost_head_array[$row[csf("process_id")]]; ?></td>
                                <td width="70"><? echo $color_library_arr[$row[csf("color_id")]]; ?></td>
                                <td width="80"><? echo $fabric_typee[$row[csf("width_dia_id")]]; ?></td>
                                <td width="60"><? echo $row[csf("in_house_rate")]; ?></td>
                                <td width="80"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
                                <td width="60"><? echo $production_process[$row[csf("rate_type_id")]]; ?></td>
                                <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
							</tr>
							<?
							$i++;
                        }
                        ?>
                        <script>
							setFilterGrid("list_view",-1)
							toggle( "tr_"+"<? echo $ratelibid ?>", '#FFFFCC');
                        </script>
                    </table>
                </div>
            </form>
        </div>
	</body>
	</html>
	<?
	exit();
}

if($action=="save_post_session_wash"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_wash']="";
	$_SESSION['logic_erp']['cons_breck_downn_wash']=$cons_breck_downn_wash;
	echo 1;
	die;
}

if($action=="consumption_popup_wash")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn_wash'];
	$itemqty_array=array();
	$job_plancut_qty=0;
	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";

	$data_array_tot_job_qty=sql_select("select b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' and a.garments_nature='$garments_nature' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $country_cond group by b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");
	foreach($data_array_tot_job_qty as $data_array_tot_job_qty_row )
	{
		//$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		//$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		//$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
		if($empbudgeton==1){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('order_quantity')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('order_quantity')];
		}
		else if($empbudgeton==2){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}else{
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}
		$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
	}
	$item_idarr=explode(",",$item_id);
	$total_item=count($item_idarr);
	if($israte_popup==2)
	{
		$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name=$cbo_company_id and variable_list=21 and status_active=1 and is_deleted=0");
	}
	else $conversion_from_chart=2;

	$conversion_from_chart=2;//ISD-22-23819

	$country_array=array();
	$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
	foreach($data_country as $cou_row){
		 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_id'][$cou_row[csf('country_id')]]=$cou_row[csf('country_id')];
		 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_name'][$cou_row[csf('country_id')]]=$country_library[$cou_row[csf('country_id')]];
	}
	?>
	<script>
		var conversion_from_chart = '<? echo $conversion_from_chart*1; ?>';
		function copy_value(value,field_id,i)
		{
			//var copy_val=document.getElementById('copy_val').checked;
			var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
			var pocolorid=document.getElementById('pocolorid_'+i).value;
			var ponoid=document.getElementById('ponoid_'+i).value;
			var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
			var librateid=document.getElementById('ratelibid_'+i).value;
			//alert(librateid);
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var copy_basis=$('input[name="copy_basis"]:checked').val()
			for(var j=i; j<=rowCount; j++)
			{
				var isDisabled = document.getElementById(field_id+j).disabled;
				if(isDisabled==false)
				{
					if(document.getElementById('approved_'+j).value==0){
						if(field_id=='rate_'){
							if(copy_basis==0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
							}
							else if(copy_basis==1){
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
									document.getElementById('ratelibid_'+j).value=librateid;
								}
							}
							else if(copy_basis==2){
								if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
									document.getElementById('ratelibid_'+j).value=librateid;
								}
							}
							else if(copy_basis==3){
								if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
									document.getElementById('ratelibid_'+j).value=librateid;
								}
							}
							else if(copy_basis==4){
								if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
									document.getElementById(field_id+j).value=value;
									document.getElementById('ratelibid_'+j).value=librateid;
								}
							}
							//claculate_amount(j);
						}

						if(field_id=='requirement_'){
							if(copy_basis==0) document.getElementById(field_id+j).value=value;
							else if(copy_basis==1){
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==2){
								if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==3){
								if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==4){
								if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							//claculate_amount(j);
						}
					}//if(var approved=document.getElementById('approved_'+j).value==0)

					var rate=document.getElementById('rate_'+j).value;
					var requirement=document.getElementById('requirement_'+j).value;
					var amount= requirement*rate;
					document.getElementById('amount_'+j).value=number_format_common(amount,5,0);
				}
			}
			set_sum_value( 'amount_sum', 'amount_');
			claculate_avg();
		}

		function fn_delete_down_tr(rowNo,table_id)
		{
			if(table_id=='tbl_consmption_cost')
			{
				var numRow = $('table#tbl_consmption_cost tbody tr').length;
				if(numRow==rowNo && rowNo!=1)
				{
					$('#tbl_consmption_cost tbody tr:last').remove();
					$('#tbl_msmnt_cost tbody tr:last').remove();
				}
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
			}
		}

		function set_sum_value(des_fil_id,field_id)
		{
			if(des_fil_id=='requirement_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='amount_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='rate_sum') var ddd={dec_type:5,comma:0};

			var rowCount = $('#tbl_consmption_cost tr').length-1;
			math_operation( des_fil_id, field_id, '+', rowCount,ddd );
			claculate_avg();
		}

		function js_set_value()
		{
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var cons_breck_down="";
			for(var i=1; i<=rowCount; i++)
			{
				var ponoid=$('#ponoid_'+i).val(); if(ponoid=='') ponoid=0;
				var cbogmtsitem=$('#cbogmtsitem_'+i).val(); if(cbogmtsitem=='') cbogmtsitem=0;
				var pocolorid=$('#pocolorid_'+i).val(); if(pocolorid=='') pocolorid=0;
				var gmtssizesid=$('#gmtssizesid_'+i).val(); if(gmtssizesid=='') gmtssizesid=0;
				var requirement=$('#requirement_'+i).val(); if(requirement=='') requirement=0;
				var colorsizetableid=$('#colorsizetableid_'+i).val(); if(colorsizetableid=='') colorsizetableid=0;
				var rate=$('#rate_'+i).val(); if(rate=='') rate=0;
				var amount=$('#amount_'+i).val(); if(amount=='') amount=0;
				var ratelibid=$('#ratelibid_'+i).val(); if(ratelibid=='') ratelibid=0;
				var cbocountry=$('#cbocountry_'+i).val(); if(cbocountry=='') cbocountry=0;

				if(cons_breck_down=="")
				{
					cons_breck_down+=ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+ratelibid+'_'+cbocountry;
				}
				else
				{
					cons_breck_down+="__"+ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+ratelibid+'_'+cbocountry;
				}
			}
			document.getElementById('cons_breck_down').value=cons_breck_down;
			claculate_avg();
			parent.emailwindow.hide();
		}

		function claculate_avg()
		{
			//var tot_plancut_qty=document.getElementById('job_plancut_qty').value*1;// don't open if need pls check ISD-21-28983
			var item_ratio=document.getElementById('item_ratio').value*1;
			var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0;
			var rowCount = $('#tbl_consmption_cost tr').length-1;

			/*for(var j=1; j<=rowCount; j++){
			if(document.getElementById('requirement_'+j).value =='' || document.getElementById('requirement_'+j).value ==0){
			continue;
			}
			else{
			//plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
			}
			}*/

			for(var i=1; i<=rowCount; i++)
			{
				if(document.getElementById('requirement_'+i).value =='' || document.getElementById('requirement_'+i).value ==0){
					continue;
				}
				else{
					var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1;
					var pcsgmts=document.getElementById('pcsgmts_'+i).value*1;
					var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
					var requirement=document.getElementById('requirement_'+i).value*1;
					var calculated_cons_percent=(requirement*plan_cut_percent)/100;
					calculated_cons+=calculated_cons_percent;
					var amount=document.getElementById('amount_'+i).value*1;
					var calculated_amount_percent=(amount*plan_cut_percent)/100;
					calculated_amount+=calculated_amount_percent;
				}
			}
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 5, 0);
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 5, 0);
			document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
		}

		function claculate_amount(i)
		{
			var rate=document.getElementById('rate_'+i).value;
			var requirement=document.getElementById('requirement_'+i).value;
			var amount= requirement*rate;
			document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
			set_sum_value( 'amount_sum', 'amount_' );
			claculate_avg();
		}

		function fnc_conversion_from_chart()
		{
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			for(var i=1; i<=rowCount; i++)
			{
				if(conversion_from_chart==1)
				{
					$('#rate_'+i).removeAttr("onDblClick").attr("onDblClick","set_wash_charge_unit_pop_up("+i+")");
					$('#rate_'+i).attr("placeholder","Browse");
					$('#rate_'+i).attr('readonly','readonly');
				}
				else
				{
					$('#rate_'+i).removeAttr("onDblClick");
					$('#rate_'+i).attr("placeholder","Write");
					$('#rate_'+i).removeAttr('readonly','readonly');
				}
			}
		}

		function set_wash_charge_unit_pop_up(i)
		{
			var cbo_company_name=document.getElementById('cbo_company_id').value;
			//var cbotypeconversion=document.getElementById('cbotypeconversion_'+i).value
			var txt_exchange_rate=document.getElementById('txt_exchange_rate').value;
			var ratelibid=document.getElementById('ratelibid_'+i).value;

			if(txt_exchange_rate==0 || txt_exchange_rate=="")
			{
				alert("Select Exchange Rate");
				return;
			}
			else
			{
				var page_link='pre_cost_entry_controller_v2.php?action=wash_chart_popup&cbo_company_name='+cbo_company_name+'&ratelibid='+ratelibid;
				emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1060px,height=450px,center=1,resize=1,scrolling=0','')
				emailwindow.onclose=function()
				{
					var charge_id=this.contentDoc.getElementById("charge_id");
					var charge_value=this.contentDoc.getElementById("charge_value");

					document.getElementById('ratelibid_'+i).value=charge_id.value;
					document.getElementById('rate_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
					claculate_amount( i );
					var rate=$('#rate_'+i).val();
					copy_value(rate,'rate_',i);
				}
			}
		}
	</script>
	</head>
	<body>
    	<div><?=load_freeze_divs ("../../../",""); ?></div>
    	<script>freeze_window(0);</script>
        <div align="center" style="width:99%;" >
        <fieldset>
        <legend><?=$body_part_id.'.'.$body_part[$body_part_id].'   Costing '.$costing_per[$cbo_costing_per]; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?=create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        	<!-- <b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>  -->
            <input type="radio" name="copy_basis" value="0" checked>Copy To All
            <input type="radio" name="copy_basis" value="1">Copy Size Wise
            <input type="radio" name="copy_basis" value="2">Copy Color Wise
            <input type="radio" name="copy_basis" value="3">Copy Item Wise
            <input type="radio" name="copy_basis" value="4">Copy Po Wise
            <input type="reset" value="Reset">
        </legend>
            <form id="consumptionform_1" autocomplete="off">
                <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<?=$cbo_company_id; ?>"/>
                <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<?=$cbo_costing_per; ?>"/>
                <input type="hidden" id="cons_breck_down" name="cons_breck_down"  width="500"  value="<?=$cons_breck_downn;?>"/>
                <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<?=$job_plancut_qty; ?>"/>
                <input type="hidden" id="item_ratio" name="item_ratio" value="<?=$tot_set_qnty; ?>"/>
                <input type="hidden" id="txt_exchange_rate" name="txt_exchange_rate" value="<?=$txt_exchange_rate; ?>"/>
                <input type="hidden" id="cbo_currercy" name="cbo_currercy" value="<?=$cbo_currercy; ?>"/>
            </form>
            <table width="845" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="20">SL</th>
                        <th width="120">PO NO</th>
                        <th width="120">Country</th>
                        <th width="120">Gmts.Item</th>
                        <th width="80">Gmts Color</th>
                        <th width="80">Gmts Size</th>
                        <th width="65">Cons</th>
                        <th width="50">Rate</th>
                        <th width="90">Amount</th>
                    	<th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
					$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
					$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
					$component_approved=0;
					$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=4 and job_no='$txt_job_no'");
					foreach($sql as $row){
						if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
					}
                    $data_array=explode("__",$cons_breck_downn);
                    if($data_array[0]==""){
                    	$data_array=array();
                    }
                    $data_array=sql_select("select b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' and a.garments_nature='$garments_nature' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $country_cond group by b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");
                    //=======================================
                    if($embupdateid != "")
					{
						$is_booking_arr=array();
						$data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$embupdateid' and booking_type='6' and status_active=1 and is_deleted=0 group by po_break_down_id, pre_cost_fabric_cost_dtls_id");
						foreach($data_arr as $row)
						{
							$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
						unset($data_arr);

						$row_arr_data="";
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_emb_cost_dtls_id=$embupdateid order by id");
						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $wrow)
						{
							$row_arr=$wrow[csf('po_break_down_id')]."_".$wrow[csf('item_number_id')]."_".$wrow[csf('color_number_id')]."_".$wrow[csf('size_number_id')]."_".$wrow[csf('requirment')]."_".$wrow[csf('rate')]."_".$wrow[csf('amount')]."_".$wrow[csf('color_size_table_id')]."_".$wrow[csf('rate_lib_id')]."_".$wrow[csf('country_id')];
							$row_arr_data.=$row_arr."__";
						}
						$row_arr_data=rtrim($row_arr_data,"__");
						$data_array_cons=explode("__",$row_arr_data);
                    }

                    if($embupdateid == ""){
						$data_array_cons=explode("__",$cons_breck_downn);
						//print_r($data_array_cons);
                    }

                    if($precostapproved==1 || $component_approved==1) $disabled=1; else $disabled=0;
                    //=======================================
                    if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$data=explode('_',$data_array_cons[$i]);
							$i++;
							if($empbudgeton==1) $pcsgmts=$row[csf('order_quantity')]; else if($empbudgeton==2) $pcsgmts=$row[csf('plan_cut_qnty')]; else $pcsgmts=$row[csf('plan_cut_qnty')];
							$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
							$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);

							$po_country_arr=explode(",",$country_string);

							$countrydata=explode(",",$data[9]);
							$arr_d=array_diff($countrydata, $po_country_arr);
							$arr_d2=array_diff($countrydata, $arr_d);
							$country_name="";

							for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
								$country_name.=	$country_library[$countrydata[$countryindex]].",";
							}
							$country_idstring=implode(",",$arr_d2);

							if(count($arr_d)>0 && count($countrydata)>0 )
							{
								$country_name_pre="";
								for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
									$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
								}
								$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
								if(rtrim($country_name_pre,",")!=""){
									$bgc="#D41F00";
								}
							}
							else{
								$title=""; $bgc="#FFFFFF";
							}

							$cons_fld=0;
							if($disabled!=1)
							{
								//echo $is_booking_arr[$row[csf('id')]];
								if(!empty($is_booking_arr[$row[csf('id')]])) $cons_fld=1;
							}
							if($data[4]=="") $cons_fld=0;

							?>
							<tr id="break_<?=$i; ?>" align="center">
                                <td><?=$i; ?></td>
                                <td>
                                    <input type="text" id="pono_<?=$i; ?>" name="pono_<?=$i; ?>" class="text_boxes" style="width:108px" value="<?=$row[csf('po_number')]; ?>" readonly />
                                    <input type="hidden" id="ponoid_<?=$i; ?>" name="ponoid_<?=$i;?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="hidden" id="cbocountry_<?=$i; ?>" name="cbocountry_<?=$i; ?>" style="width:75px" value="<?=$country_string; ?>" readonly />
                                    <input type="text" id="cbocountryname_<?=$i; ?>" name="cbocountryname_<?=$i; ?>" onClick="open_country_popup('<?=$i.'_2'; ?>')" class="text_boxes" style="width:108px; background-color:<?=$bgc; ?>" value="<?=$country_string_name; ?>" readonly title="<?=$title; ?>" disabled />
                                </td>
                                <td><?=create_drop_down( "cbogmtsitem_".$i, 120, $garments_item,"", 0, "",$row[csf('item_number_id')], "",""); ?></td>
                                <td>
                                    <input type="text" id="pocolor_<?=$i; ?>" name="pocolor_<?=$i; ?>" class="text_boxes" style="width:68px" value="<?=$color_library[$row[csf('color_number_id')]]; ?>" readonly />
                                    <input type="hidden" id="pocolorid_<?=$i; ?>" name="pocolorid_<?=$i; ?>" class="text_boxes" style="width:55px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
                                </td>
                                <td>
                                    <input type="text" id="gmtssizes_<?=$i; ?>" name="gmtssizes_<?=$i; ?>" class="text_boxes" style="width:68px" value="<?=$size_library[$row[csf('size_number_id')]]; ?>" readonly>
                                    <input type="hidden" id="gmtssizesid_<?=$i; ?>" name="gmtssizesid_<?=$i; ?>" class="text_boxes" style="width:55px" value="<?=$row[csf('size_number_id')]; ?>" readonly />
                                </td>
                                <td><input type="text" id="requirement_<?=$i; ?>" name="requirement_<?=$i; ?>" onChange="claculate_amount(<?=$i; ?>);copy_value(this.value,'requirement_',<?=$i; ?>); set_sum_value( 'requirement_sum', 'requirement_');" class="text_boxes_numeric" style="width:53px" value="<? if ($data[4]==""){ echo $price_quatation_requirment[$row[csf('size_number_id')]];} else { echo $data[4]; } ?>" <? if($disabled==1 || $cons_fld==1){ echo "disabled";} else{ echo "";} ?> /></td>
                                <td>
                                	<input type="text" id="rate_<?=$i; ?>" name="rate_<?=$i; ?>" onChange="claculate_amount(<?=$i; ?>); copy_value(this.value,'rate_',<?=$i; ?>);" onBlur="set_sum_value( 'rate_sum', 'rate_');" class="text_boxes_numeric" style="width:38px" value="<?=$data[5]; ?>" <? if($cons_fld==1 || $disabled==1){ echo "disabled";} else{ echo "";} ?>/>
                                    <input type="hidden" id="ratelibid_<?=$i; ?>" name="ratelibid_<?=$i; ?>" value="<?=$row[csf('rate_lib_id')]; ?>"/>
                                </td>
                                <td><input type="text" id="amount_<?=$i; ?>" name="amount_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="<?=$data[6]; ?>" readonly /></td>
                                <td id="add_<?=$i; ?>">
                                    <input type="hidden" id="pcsgmts_<?=$i; ?>" name="pcsgmts_<?=$i; ?>" onBlur="set_sum_value( 'pcs_sum', 'pcs_')" class="text_boxes_numeric" style="width:35px" value="<?=$pcsgmts; ?>">
                                    <input type="hidden" id="itempcsgmts_<?=$i; ?>" name="itempcsgmts_<?=$i; ?>" onBlur="set_sum_value( 'pcs_sum', 'pcs_');" class="text_boxes_numeric" style="width:35px" value="<?=$itemqty_array[$row[csf('item_number_id')]]; ?>">
                                    <input type="hidden" id="colorsizetableid_<?=$i; ?>" name="colorsizetableid_<?=$i; ?>" class="text_boxes" style="width:35px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                                    <input type="button" id="decreaserow_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<?=$i; ?>,'tbl_consmption_cost');" disabled/>
                                    <input type="hidden" id="approved_<?=$i; ?>" name="approved_<?=$i; ?>" class="text_boxes_numeric" style="width:75px" value="<?=$disabled; ?>">
                                </td>
							</tr>
							<?
						}
                    }
                    ?>
                </tbody>
            </table>
            <table width="845" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="20">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="80">SUM : </th>
                        <th width="65"><input type="text" id="requirement_sum"  name="requirement_sum" class="text_boxes_numeric" style="width:53px" readonly></th>
                        <th width="50"><input type="text" id="rate_sum"    name="rate_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="90">
                            <input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:78px" readonly>
                            <input type="hidden" id="plancutqty_sum" name="plancutqty_sum" class="text_boxes_numeric" style="width:78px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="20">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="80">AVG : </th>
                        <th width="65"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:53px" value="<? echo $calculated_conss;?>" readonly></th>
                        <th width="50"><input type="text" id="calculated_rate"   name="calculated_rate" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="90">
                            <input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:78px" readonly>
                            <input type="hidden" id="calculated_plancutqty"    name="calculated_plancutqty" class="text_boxes_numeric" style="width:65px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <script>
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
				fnc_conversion_from_chart();
            </script>
        </form>
        </fieldset>
        </div>
        <div align="center" style="width:100%;" >
            <table width="845" cellspacing="0" class="" border="0" rules="all">
                <tr>
                	<td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value();"/></td>
                </tr>
            </table>
        </div>
	</body>
    <script>release_freezing(); $('.form_caption').hide(); </script>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action=="save_update_delet_wash_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=4");
	if($component_approved==3) $component_approved=1;

	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	if($operation==0)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}

		 $add_comma=0; $fail1=0;
		 $id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, emb_name, emb_type, country, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, inserted_by, insert_date, status_active, is_deleted";
		 $field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id";

		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboembname="cboembname_".$i;
			 $cboembtype="cboembtype_".$i;
			 $country="country_".$i;
			 $txtembconsdzngmts="txtembconsdzngmts_".$i;
			 $txtembrate="txtembrate_".$i;
			 $txtembamount="txtembamount_".$i;
			 $cboembstatus="cboembstatus_".$i;
			 $embupdateid="embupdateid_".$i;
			 $embratelibid="embratelibid_".$i;
			 $consbreckdownwash="consbreckdownwash_".$i;
			 $empbudgeton="empbudgeton_".$i;

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$country.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$embratelibid.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
			//	CONS break down===============================================================================================
			if(str_replace("'",'',$$consbreckdownwash) !='')
			 {
				$consbreckdown= $$consbreckdownwash;
			 }
			 else
			 {
				 $consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
				 // $consbreckdown="";
			 }
			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
			$id=$id+1;
		}
		$rID=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="job_no*emb_name*emb_type*country*is_apply_last_update*cons_dzn_gmts*rate*amount*charge_lib_id*budget_on*updated_by*update_date*status_active*is_deleted";
		 $field_array="id, job_id, job_no, emb_name, emb_type, country, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, inserted_by, insert_date, status_active, is_deleted";
		 $field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id";

		 $add_co=0; $add_comma=0; $fail1=0;
		 $id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;

		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboembname="cboembname_".$i;
			 $cboembtype="cboembtype_".$i;
			 $lastappidchk="lastappidchk_".$i;
			 $country="country_".$i;
			 $txtembconsdzngmts="txtembconsdzngmts_".$i;
			 $txtembrate="txtembrate_".$i;
			 $txtembamount="txtembamount_".$i;
			 $cboembstatus="cboembstatus_".$i;
			 $embupdateid="embupdateid_".$i;
			 $embratelibid="embratelibid_".$i;
			 $consbreckdownwash="consbreckdownwash_".$i;
			 $empbudgeton="empbudgeton_".$i;
			if(str_replace("'",'',$$embupdateid)!="")
			{
                $id_arr[]=str_replace("'",'',$$embupdateid);
				$data_array_up[str_replace("'",'',$$embupdateid)] =explode("*",("".$update_id."*".$$cboembname."*".$$cboembtype."*".$$country."*".$$lastappidchk."*".$$txtembconsdzngmts."*".$$txtembrate."*".$$txtembamount."*".$$embratelibid."*".$$empbudgeton."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cboembstatus."*0"));
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownwash) !='')
				 {
					$consbreckdown= $$consbreckdownwash;
				 }
				 else
				 {
					 //$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
					  $consbreckdown="";
				 }

			if(str_replace("'",'',$consbreckdown) !='')
			{
				//echo "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."";
				$rID_de1=execute_query( "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."",0);
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".str_replace("'",'',$$embupdateid).",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}

				if ($data_array1!="" && $counter!=100)
				{
					//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
			}
			if(str_replace("'",'',$$embupdateid)=="")
			{

				if ($add_co!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$country.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$embratelibid.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownwash) !='')
				 {
					$consbreckdown= $$consbreckdownwash;
				 }
				 else
				 {
					 $consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
					  //$consbreckdown="";
				 }
			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				//$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
				$id=$id+1;
				$add_co++;
			}
		 }
		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID1=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		 }
       // bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr );
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
        check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//**************************************************************************Wash Cost End**********************************************
//*************************************************Commision Cost Start ***********************************************
if ($action=="show_commission_cost_listview")
{
	$data=explode("_",$data);
	$component_approved=0;
	//$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=5 and job_no='$data[0]'");
	$jobid=return_field_value("job_id", "wo_pre_cost_mst","job_no='$data[0]' and status_active =1 and is_deleted=0");

	$sql=sql_select("select approved as approved from precost_component_app_mst where cost_component_id=5 and job_id='$jobid'");
	if (count($sql)<1)
	{
		$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=5 and job_no='$data[0]'");
	}
	foreach($sql as $row){
		if($row[csf('approved')]==1)
		{
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved.</p></marquee>";
		}
		else if($row[csf('approved')]==3)
		{
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Partially Approved.</p></marquee>";
		}
	}
	?>
	<h3 style="width:580px;" align="left" class="accordion_h">+Commission Cost <? echo $approved_message; ?></h3>
       <div id="content_commission_cost" align="left">
    	<fieldset style="width:580px;">
        	<form id="commission_8" autocomplete="off">
            	<table width="580" cellspacing="0" class="rpt_table" border="0" id="tbl_commission_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="150">Particulars</th> <th width="100">Commn. Base</th> <th width="90">Commn Rate</th> <th width="110">Amount</th> <th width="">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3){
						$approved=1;
					}
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					$data_array=sql_select("select id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls where job_no='$data[0]' order by id");// quotation_id='$data'
					if(count($data_array)<1 && $data[2]==1 && $data[3]==2)
					{
						$data_array=sql_select("select id as pri_id, quotation_id, particulars_id, commission_base_id, commision_rate,commission_amount,status_active from  wo_pri_quo_commiss_cost_dtls where quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by id");// quotation_id='$data'
						$save_update=0;
					}
					if(count($data_array)<1 && $data[2]==1){
						if($data[3]==1 || $data[3]==5 || $data[3]==8) //Quick Costing=1, Short Quotation V2=5, Short Quotation V6=8,
						{
							$data_array=sql_select("select 1 as particulars_id, b.cost_sheet_id as quotation_id, 1 as commission_base_id, sum(a.commision_per) as commision_rate, sum(b.comm_amount) as commission_amount, 1 as status_active from  qc_tot_cost_summary a, qc_confirm_dtls b where a.mst_id=b.cost_sheet_id and b.cost_sheet_id='$data[1]' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.cost_sheet_id");
							//echo "select  4 as particulars_id, b.cost_sheet_id as quotation_id, 1 as commission_base_id, sum(a.commision_per) as rate, sum(b.comm_amount) as amount from  qc_tot_cost_summary a, qc_confirm_dtls b where a.mst_id=b.cost_sheet_id and b.cost_sheet_id='$data[1]' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.cost_sheet_id";
							$save_update=0;
						}
					}
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            <tr id="commissiontr_<?=$i; ?>" align="center">
                                <td><? echo create_drop_down( "cboparticulars_".$i, 150, $commission_particulars, "",1," -- Select Item --", $row[csf("particulars_id")], "",$disabled,'' ); ?></td>
                                <td><?  echo create_drop_down( "cbocommissionbase_".$i, 100, $commission_base_array,"", 1, "-- Select --", $row[csf("commission_base_id")], "calculate_commission_cost(".$i.")",$disabled,"" ); ?></td>
                               <td><input type="text" id="txtcommissionrate_<? echo $i; ?>"  name="txtcommissionrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:90px" value="<? echo $row[csf("commision_rate")];  ?>" onChange="calculate_commission_cost( <? echo $i;?> )" <? if($disabled==0){echo "";}else{echo "disabled";}?> /></td>
                                <td><input type="text" id="txtcommissionamount_<? echo $i; ?>"  name="txtcommissionamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:110px" value="<? echo $row[csf("commission_amount")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly /></td>
                                <td><? echo create_drop_down( "cbocommissionstatus_".$i, 95, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?>
                                    <input type="hidden" id="commissionupdateid_<? echo $i; ?>" name="commissionupdateid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("id")]; ?>"  />
                                </td>
                            </tr>
                            <?
							if($save_update==0 && count($data_array)==1)
							{
								?>
                                <tr id="commissiontr_2" align="center">
                                    <td><? echo create_drop_down( "cboparticulars_2", 150, $commission_particulars, "",0,"", 2, '','','' ); ?></td>
                                    <td><?  echo create_drop_down( "cbocommissionbase_2", 100, $commission_base_array,"", 1, "-- Select --", "", "calculate_commission_cost(2)","","" ); ?></td>
                                    <td><input type="text" id="txtcommissionrate_2"  name="txtcommissionrate_2" class="text_boxes_numeric" style="width:90px" value="" onChange="calculate_commission_cost(2)"/></td>
                                    <td><input type="text" id="txtcommissionamount_2"  name="txtcommissionamount_2" class="text_boxes_numeric" style="width:110px" value="" /></td>
                                    <td>
                                        <? echo create_drop_down( "cbocommissionstatus_2", 95, $row_status,"", 0, "0", '', '','','' );  ?>
                                        <input type="hidden" id="commissionupdateid_2" name="commissionupdateid_2"  class="text_boxes" style="width:20px" value=""  />
                                    </td>
                                </tr>
                                <?
							}
						}
					}
					else
					{
						$save_update=0;
						?>
                        <tr id="commissiontr_1" align="center">
                            <td><? echo create_drop_down( "cboparticulars_1", 150, $commission_particulars, "",0,"", 1, '','','' ); ?></td>
                            <td><?  echo create_drop_down( "cbocommissionbase_1", 100, $commission_base_array,"", 1, "-- Select --", "", "calculate_commission_cost(1)","","" ); ?></td>
                            <td><input type="text" id="txtcommissionrate_1" name="txtcommissionrate_1" class="text_boxes_numeric" style="width:90px" value="" onChange="calculate_commission_cost(1);"/></td>
                            <td><input type="text" id="txtcommissionamount_1" name="txtcommissionamount_1" class="text_boxes_numeric" style="width:110px" value="" readonly /></td>
                            <td>
								<? echo create_drop_down( "cbocommissionstatus_1", 95, $row_status,"", 0, "0", '', '','','' );  ?>
                                <input type="hidden" id="commissionupdateid_1" name="commissionupdateid_1"  class="text_boxes" style="width:20px" value=""  />
                            </td>
                        </tr>
                        <tr id="commissiontr_2" align="center">
                            <td><? echo create_drop_down( "cboparticulars_2", 150, $commission_particulars, "",0,"",2, '','','' ); ?></td>
                            <td><?  echo create_drop_down( "cbocommissionbase_2", 100, $commission_base_array,"", 1, "-- Select --", "", "calculate_commission_cost(2)","","" ); ?></td>
                            <td><input type="text" id="txtcommissionrate_2"  name="txtcommissionrate_2" class="text_boxes_numeric" style="width:90px" value="" onChange="calculate_commission_cost(2)"/></td>
                            <td><input type="text" id="txtcommissionamount_2"  name="txtcommissionamount_2" class="text_boxes_numeric" style="width:110px" value="" /></td>
                            <td>
								<? echo create_drop_down( "cbocommissionstatus_2", 95, $row_status,"", 0, "0", '', '','','' );  ?>
                                <input type="hidden" id="commissionupdateid_2" name="commissionupdateid_2"  class="text_boxes" style="width:20px" value=""  />
                            </td>
                        </tr>
                        <?
					}
					?>
                </tbody>
                </table>
                <table width="580" cellspacing="0" class="rpt_table" border="0" rules="all">
                	<tfoot>
                    	<tr>
                            <th width="150" style="border:none"></th>
                            <th  width="100" align="right" style="border:none">SUM</th>
                            <th width="90">
                            <input type="text" id="txtratecommission_sum"  name="txtratecommission_sum" class="text_boxes_numeric" style="width:90px"  readonly />
                            </th>
                            <th width="110">
                            <input type="text" id="txtamountcommission_sum"  name="txtamountcommission_sum" class="text_boxes_numeric" style="width:110px"  readonly />
                            </th>
                            <th></th>

                        </tr>
                    </tfoot>
                </table>
                <table width="580" cellspacing="0" class="" border="0">
                	<tr>

                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">

						<?
						if ( count($data_array)>0)
					    {
							echo load_submit_buttons( $permission, "fnc_commission_cost_dtls", $save_update,0,"reset_form('commission_8','','',0)",7) ;
					    }
						else
						{
							echo load_submit_buttons( $permission, "fnc_commission_cost_dtls", $save_update,0,"reset_form('commission_8','','',0)",7) ;
						}
						?>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
     </div>
	<?
	exit();
}

if ($action=="save_update_delet_commission_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=5");
	if($component_approved==3) $component_approved=1;

	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	if($operation==0)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		 $id=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted ";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboparticulars="cboparticulars_".$i;
			 $cbocommissionbase="cbocommissionbase_".$i;
			 $txtcommissionrate="txtcommissionrate_".$i;
			 $txtcommissionamount="txtcommissionamount_".$i;
			 $cbocommissionstatus="cbocommissionstatus_".$i;
			 $commissionupdateid="commissionupdateid_".$i;
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0)";
			$id=$id+1;
		 }
		 $rID=sql_insert("wo_pre_cost_commiss_cost_dtls",$field_array,$data_array,0);
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, commis_rate, commis_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecommission_sum.",".$txtamountcommission_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="commis_rate*commis_amount";
			$data_array2 ="".$txtratecommission_sum."*".$txtamountcommission_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="particulars_id*commission_base_id*commision_rate*commission_amount*updated_by*update_date*status_active*is_deleted ";
		 $field_array="id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted ";
		 $add_comma=0;
		 $id=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {

			 $cboparticulars="cboparticulars_".$i;
			 $cbocommissionbase="cbocommissionbase_".$i;
			 $txtcommissionrate="txtcommissionrate_".$i;
			 $txtcommissionamount="txtcommissionamount_".$i;
			 $cbocommissionstatus="cbocommissionstatus_".$i;
			 $commissionupdateid="commissionupdateid_".$i;
			if(str_replace("'",'',$$commissionupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$commissionupdateid);
			    $data_array_up[str_replace("'",'',$$commissionupdateid)]=explode(",",("".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0"));
			}
			if(str_replace("'",'',$$commissionupdateid)=="")
			{
			    if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0)";
			    $id=$id+1;
				$add_comma++;
			}
		 }
         $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_commiss_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID=sql_insert("wo_pre_cost_commiss_cost_dtls",$field_array,$data_array,0);
		 }
 		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, commis_rate, commis_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecommission_sum.",".$txtamountcommission_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="commis_rate*commis_amount";
			$data_array2 ="".$txtratecommission_sum."*".$txtamountcommission_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);

		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Commision Cost End ***********************************************
//*************************************************Comarcial Cost Start ***********************************************

if ($action=="curreir_cost_method")
{
	$data=explode("_",$data);
	$job_no=$data[0];
	$company_id=$data[1];
	$fabric_pre_cost=$data[2];
	$price_dzn=$data[3];
	$commission_pre_cost=$data[4];

	$sql_job=sql_select("select BUYER_NAME, BRAND_ID from WO_PO_DETAILS_MASTER where job_no='$job_no'");

	$buyerid=$sql_job[0]["BUYER_NAME"];
	$brandid=$sql_job[0]["BRAND_ID"];

	$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable, copy_quotation as based_on from variable_order_tracking where company_name=".$company_id."  and variable_list=57 and tna_integrated='$buyerid' and profit_calculative='$brandid' and status_active=1 and is_deleted=0");
	if(count($currier_result)<1)
	{
		$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable, copy_quotation as based_on from variable_order_tracking where company_name=".$company_id."  and variable_list=57 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0");
	}
	if(count($currier_result)<1)
	{
		$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$company_id."  and variable_list=57 and status_active=1 and is_deleted=0");
	}
	//$currier_result=sql_select($sql_currier_data);
	$editable=2; $based_on=1;
	foreach($currier_result as $row)
	{
		$currier_cost_percent=0; $currier_cost_method=1;
		if($row[csf("based_on")]==2) $fixamount=$row[csf("commercial_cost_percent")]; 
		else 
		{
			$fixamount=0;
			$currier_cost_method=$row[csf("commercial_cost_method")];
			if($currier_cost_method=="" || $currier_cost_method==0) $currier_cost_percent=1; else $currier_cost_percent=$currier_cost_percent;
			$currier_cost_percent=$row[csf("commercial_cost_percent")];
			if($currier_cost_percent=="" || $currier_cost_percent==0) $currier_cost_percent=0; else  $currier_cost_percent=$currier_cost_percent;
		}

		$editable=$row[csf("editable")];
		$based_on=$row[csf("based_on")];
		if($editable=='' || $editable==0 )
		{
		   $editable=2;
		}
	}

   $fob_value=$price_dzn-$commission_pre_cost;
   $amount=0;
	if($currier_cost_method==1)
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=def_number_format($row[csf("amount")],5,"");
		}
	}
	if($currier_cost_method==2) $amount=def_number_format($price_dzn,5,"");
	if($currier_cost_method==3) $amount=def_number_format($fob_value,5,"");//On Net Selling
	$currier_amount=def_number_format(($amount*($currier_cost_percent/100)),5,"");
	echo $currier_cost_method.'**'.$currier_amount.'**'.$editable.'**'.$based_on.'**'.$fixamount;

} //Currier Cost Method end

if ($action=="show_comarcial_cost_listview")
{
	$data=explode("_",$data);
	$sql_job=sql_select("select BUYER_NAME, BRAND_ID from WO_PO_DETAILS_MASTER where job_no='$data[0]'");

	$buyerid=$sql_job[0]["BUYER_NAME"];
	$brandid=$sql_job[0]["BRAND_ID"];

	$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]." and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='$brandid' and status_active=1 and is_deleted=0");
	if(count($commercial_cost_methodSql)<1)
	{
		$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]." and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0");
		//echo "select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0";
	}
	if(count($commercial_cost_methodSql)<1)
	{
		$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]." and variable_list=27 and tna_integrated='0' and profit_calculative='0' and status_active=1 and is_deleted=0");
	}

	$commercial_cost_method=1; $commercial_cost_percent=0; $editable=0;
	foreach( $commercial_cost_methodSql as $row )
	{
		if($row[csf("commercial_cost_method")]>0) $commercial_cost_method=$row[csf("commercial_cost_method")];
		if($row[csf("commercial_cost_percent")]>0) $commercial_cost_percent=$row[csf("commercial_cost_percent")];
		if($row[csf("editable")]>0) $editable=$row[csf("editable")];
	}

	$price_dzn=$data[4];
	$fob_value=$data[4]-$data[5];
	$amount=0;
	if($commercial_cost_method==1)
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=def_number_format($row[csf("amount")],5,"");
		}
	}
	else if($commercial_cost_method==2) $amount=def_number_format($price_dzn,5,"");
	else if($commercial_cost_method==3) $amount=def_number_format($fob_value,5,"");
	else if($commercial_cost_method==5 || $commercial_cost_method==6 || $commercial_cost_method==7)//Fabric Purchase + Trims Cost + Embellishment Cost + Garments Wash + Lab Test + Inspection + CM Cost + Freight + Courier Cost + Certificate Cost + Design Cost + Studio Cost + Operating Expenses
	{
		$amount=0;
		$sql_fab="select amount as amount from wo_pre_cost_fabric_cost_dtls where job_no='$data[0]' and fabric_source in (1,2) and status_active=1 and is_deleted=0";
		$data_fab=sql_select($sql_fab);
		$fab_amount=0;
		foreach($data_fab as $row )
		{
			$fab_amount+=$row[csf("amount")];
		}
		unset($data_fab);
		$sql_yarn="select amount as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0";
		$data_yarn=sql_select($sql_yarn);
		$yarn_amount=0;
		foreach($data_yarn as $row )
		{
			$yarn_amount+=$row[csf("amount")];
		}
		unset($data_yarn);
		//$data_array=sql_select("select trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_pre_cost, studio_pre_cost, common_oh from wo_price_quotation_costing_mst where quotation_id=$quotation_id and status_active=1 and is_deleted=0");
		$data_array=sql_select("select fabric_cost, trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh,incentives_pre_cost from wo_pre_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0");
		$ft_amount=0;
		foreach( $data_array as $row )
		{
			if($commercial_cost_method==5)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==6)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==7)
			{
				$ft_amount=$row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")]+$row[csf("incentives_pre_cost")];
			}
		}
		unset($data_array);
		if($commercial_cost_method!=7)$amount=$ft_amount+$yarn_amount+$fab_amount;
		else $amount=$ft_amount;
	}
	$com_amount=def_number_format(($amount*($commercial_cost_percent/100)),5,"");
	//echo $commercial_cost_method.'=='.$com_amount;

	$component_approved=0;
	//$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=6 and job_no='$data[0]'");
	$jobid=return_field_value("job_id", "wo_pre_cost_mst","job_no='$data[0]' and status_active =1 and is_deleted=0");

	$sql=sql_select("select approved as approved from precost_component_app_mst where cost_component_id=6 and job_id='$jobid'");
	if (count($sql)<1)
	{
		$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=6 and job_no='$data[0]'");
	}
	foreach($sql as $row){
		if($row[csf('approved')]==1)
		{
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved.</p></marquee>";
		}
		else if($row[csf('approved')]==3)
		{
			$component_approved=3; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Partially Approved.</p></marquee>";
		}
	}
	?>
	<h3 style="width:550px;" align="left" class="accordion_h" >+Commercial Cost <?=$approved_message; ?></h3>
       <div id="content_comarcial_cost"  align="left">
    	<fieldset style="width:550px;">
        	<form id="comarcial_9" autocomplete="off">
            <input type="hidden" id="txt_commercial_cost_method" value="<?=$commercial_cost_method;?>"/>
            	<table width="540" cellspacing="0" class="rpt_table" border="0" id="tbl_comarcial_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="150">Item</th><th width="90"> Rate In %</th><th width="110">Amount</th><th width="95">Status</th><th width=""></th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3) $approved=1;
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					if($editable==1) $readonly=0; else $readonly=1	;

					$data_array=sql_select("select id, job_no, item_id , rate, amount, status_active from wo_pre_cost_comarci_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 order by id");
					if(count($data_array)<1 && $data[2]==1 && $data[6]==2)
					{
						$data_array=sql_select("select id as pri_id, quotation_id, item_id, rate, amount, status_active from  wo_pri_quo_comarcial_cost_dtls where quotation_id='$data[1]'  and status_active=1 and is_deleted=0 order by id");
						$save_update=0;
					}
					if(count($data_array)<1 && $copy_quotation==1 && ($commercial_cost_percent*1)==0){
						if($cost_control_source==1 || $cost_control_source==5 || $cost_control_source==8) //Quick Costing=1, Short Quotation V2=5, Short Quotation V6=8,
						{
							$data_array=sql_select("select  b.cost_sheet_id as quotation_id, 4 as item_id, sum(a.commercial_per) as rate, sum(b.commercial_cost) as amount from  qc_tot_cost_summary a, qc_confirm_dtls b where a.mst_id=b.cost_sheet_id and b.cost_sheet_id='$data[1]' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.cost_sheet_id");
							$save_update=0;
						}
					}
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            <tr id="comarcialtr_<?=$i; ?>" align="center">
                               <td><?=create_drop_down( "cboitem_".$i, 150, $camarcial_items, "",1," -- Select Item --", $row[csf("item_id")], "",$disabled,'' ); ?></td>
                               <td><input type="text" id="txtcomarcialrate_<?=$i; ?>" name="txtcomarcialrate_<?=$i; ?>" class="text_boxes_numeric" style="width:90px" value="<?=$row[csf("rate")]; ?>" onChange="calculate_comarcial_cost(<?=$i; ?>,'cal_amount');" <? if($disabled==0){echo "";}else{echo "disabled";}?> <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>
                                <td><input type="text" id="txtcomarcialamount_<?=$i; ?>" name="txtcomarcialamount_<?=$i; ?>" class="text_boxes_numeric" style="width:110px" value="<?=$row[csf("amount")]; ?>" onChange="calculate_comarcial_cost(<?=$i; ?>,'cal_rate')" <? if($disabled==0){echo "";}else{echo "disabled";}?>  <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>

                                <td><? echo create_drop_down( "cbocomarcialstatus_".$i, 95, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?></td>
                                <td>
                                    <input type="button" id="increasecomarcial_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_comarcial_cost(<?=$i; ?> )" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                    <input type="button" id="decreasecomarcial_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_comarcial_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="hidden" id="comarcialupdateid_<? echo $i; ?>" name="comarcialupdateid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("id")]; ?>"  />
                                 </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						?>
						<tr id="comarcialtr_1" align="center">
                           <td><? echo create_drop_down( "cboitem_1", 150, $camarcial_items, "",0,"", 4, '','','' ); ?></td>
                           <td><input type="text" id="txtcomarcialrate_1"  name="txtcomarcialrate_1" class="text_boxes_numeric" style="width:90px"  onChange="calculate_comarcial_cost(1,'cal_amount')" value="<? echo $commercial_cost_percent; ?>" <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>
                            <td><input type="text" id="txtcomarcialamount_1"  name="txtcomarcialamount_1" class="text_boxes_numeric" style="width:110px"   onChange="calculate_comarcial_cost(1,'cal_rate')"  value="<? echo $com_amount; ?>" <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>
                            <td width="95"><? echo create_drop_down( "cbocomarcialstatus_1", 95, $row_status,"", 0, "0", '', '','','' );  ?></td>
                            <td>
                                <input type="button" id="increasecomarcial_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_comarcial_cost(1)" />
                                <input type="button" id="decreasecomarcial_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1 ,'tbl_comarcial_cost',this);" />
                                <input type="hidden" id="comarcialupdateid_1" name="comarcialupdateid_1"  class="text_boxes" style="width:20px" value=""  />                            </td>
                        </tr>
                    	<?
					}
					?>
                </tbody>
                </table>
                <table width="540" cellspacing="0" class="rpt_table" border="0" rules="all">
                	<tfoot>
                    	<tr>
                            <th width="150">Sum</th>
                            <th width="90"><input type="text" id="txtratecomarcial_sum" name="txtratecomarcial_sum" class="text_boxes_numeric" style="width:90px" readonly /></th>
                            <th width="110"><input type="text" id="txtamountcomarcial_sum" name="txtamountcomarcial_sum" class="text_boxes_numeric" style="width:110px" readonly /></th>
                            <th width="95" style="border:none"></th>
                            <th style="border:none"></th>
                        </tr>
                    </tfoot>
                </table>
                <table width="540" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="center" width="100%" class="button_container">

						<?
						if ( count($data_array)>0)
					    {
							echo load_submit_buttons( $permission, "fnc_comarcial_cost_dtls", $save_update,0,"reset_form('comarcial_9','','',0)",9) ;
					    }
						else
						{
							echo load_submit_buttons( $permission, "fnc_comarcial_cost_dtls", $save_update,0,"reset_form('comarcial_9','','',0)",9) ;
						}
						?>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        </div>
	<?
	exit();
}
if($action=="sum_incentives_cost_value")
{
	$data=explode("_",$data);
	$job_no=$data[0];
	$commercial_cost_method=$data[1];


		$amount=0;
		$sql_fab="select amount as amount from wo_pre_cost_fabric_cost_dtls where job_no='$job_no' and fabric_source in (1,2) and status_active=1 and is_deleted=0";
		$data_fab=sql_select($sql_fab);
		$fab_amount=0;
		foreach($data_fab as $row )
		{
			$fab_amount+=$row[csf("amount")];
		}
		unset($data_fab);
		$sql_yarn="select amount as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
		$data_yarn=sql_select($sql_yarn);
		$yarn_amount=0;
		foreach($data_yarn as $row )
		{
			$yarn_amount+=$row[csf("amount")];
		}
		unset($data_yarn);
		//$data_array=sql_select("select trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_pre_cost, studio_pre_cost, common_oh from wo_price_quotation_costing_mst where quotation_id=$quotation_id and status_active=1 and is_deleted=0");
	$sql_conv="select amount as amount from wo_pre_cost_fab_conv_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
	$data_conv=sql_select($sql_conv);
	$conv_amount=0;
	foreach($data_conv as $row )
	{
		$conv_amount+=$row[csf("amount")];
	}
	unset($data_conv);
		  $amount=$conv_amount+$yarn_amount+$fab_amount;


	echo $amount;
	die;
}
if($action=="sum_comarcial_cost_value")
{
	$data=explode("_",$data);
	$job_no=$data[0];
	$commercial_cost_method=$data[1];
	$amount=0;
	if($commercial_cost_method==1)//Yarn+Trims+Fabric Purchase
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no ='$job_no' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=$row[csf("amount")];
		}
	}
	else if($commercial_cost_method==5 || $commercial_cost_method==6 || $commercial_cost_method==7)//Fabric Purchase + Trims Cost + Embellishment Cost + Garments Wash + Lab Test + Inspection + CM Cost + Freight + Courier Cost + Certificate Cost + Design Cost + Studio Cost + Operating Expenses
	{
		$amount=0;
		$sql_fab="select amount as amount from wo_pre_cost_fabric_cost_dtls where job_no='$job_no' and fabric_source in (1,2) and status_active=1 and is_deleted=0";
		$data_fab=sql_select($sql_fab);
		$fab_amount=0;
		foreach($data_fab as $row )
		{
			$fab_amount+=$row[csf("amount")];
		}
		unset($data_fab);
		$sql_yarn="select amount as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
		$data_yarn=sql_select($sql_yarn);
		$yarn_amount=0;
		foreach($data_yarn as $row )
		{
			$yarn_amount+=$row[csf("amount")];
		}
		unset($data_yarn);
		//$data_array=sql_select("select trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_pre_cost, studio_pre_cost, common_oh from wo_price_quotation_costing_mst where quotation_id=$quotation_id and status_active=1 and is_deleted=0");
		$data_array=sql_select("select fabric_cost, trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh,incentives_pre_cost from wo_pre_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		$ft_amount=0;
		foreach( $data_array as $row )
		{
			if($commercial_cost_method==5)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==6)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==7)
			{
				$ft_amount=$row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")]+$row[csf("incentives_pre_cost")];
			}
		}
		unset($data_array);
		if($commercial_cost_method!=7) $amount=$ft_amount+$yarn_amount+$fab_amount;
		else $amount=$ft_amount;
	}
	echo $amount;
	die;
}

if ($action=="save_update_delet_comarcial_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		if(str_replace("'","",$txt_cost_control_source)==2)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}

			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
	}

	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=6");
	if($component_approved==3) $component_approved=1;

	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}

	if($operation==0)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		 $id=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted ";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboitem="cboitem_".$i;
			 $txtcomarcialrate="txtcomarcialrate_".$i;
			 $txtcomarcialamount="txtcomarcialamount_".$i;
			 $cbocomarcialstatus="cbocomarcialstatus_".$i;
			 $comarcialupdateid="comarcialupdateid_".$i;
			 if ($i!=1) $data_array .=",";
			 $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0)";
			 $id=$id+1;
		 }
		 $rID=sql_insert("wo_pre_cost_comarci_cost_dtls",$field_array,$data_array,0);
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, comar_rate, comar_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecomarcial_sum.",".$txtamountcomarcial_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="comar_rate*comar_amount";
			$data_array2 ="".$txtratecomarcial_sum."*".$txtamountcomarcial_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="item_id*rate*amount*updated_by*update_date*status_active*is_deleted ";
		 $field_array="id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted ";
		 $add_comma=0;
		 $id=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboitem="cboitem_".$i;
			 $txtcomarcialrate="txtcomarcialrate_".$i;
			 $txtcomarcialamount="txtcomarcialamount_".$i;
			 $cbocomarcialstatus="cbocomarcialstatus_".$i;
			 $comarcialupdateid="comarcialupdateid_".$i;
			if(str_replace("'",'',$$comarcialupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$comarcialupdateid);
			    $data_array_up[str_replace("'",'',$$comarcialupdateid)] =explode(",",("".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0"));
			}
			if(str_replace("'",'',$$comarcialupdateid)=="")
			{
			    if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0)";
			    $id=$id+1;
			    $add_comma++;
			}
		 }
         $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_comarci_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID=sql_insert("wo_pre_cost_comarci_cost_dtls",$field_array,$data_array,0);
		 }
 		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, comar_rate, comar_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecomarcial_sum.",".$txtamountcomarcial_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="comar_rate*comar_amount";
			$data_array2 ="".$txtratecomarcial_sum."*".$txtamountcomarcial_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Comarcial Cost End ***********************************************
// report generate here
// report start

if($action=="preCostRpt")
{
	if(isset($_GET['action']))
	{
		
		$version=str_replace("'","",$_GET['version']);
	}
	else{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	  }

	  //print_r($version);
	if($txt_po_breack_down_id==""){ $po_id_cond='';$po_id_cond2='';} else{ $po_id_cond=" and b.id=".$txt_po_breack_down_id."";$po_id_cond2=" and id=".$txt_po_breack_down_id."";}
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($db_type==0){
	   $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
	}
	if($db_type==2){
		$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1)	;
	}
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	if($db_type==0){
		$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1");
	}
	if($db_type==2){
		 $sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");
	}

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1 and b.status_active=1 and b.is_deleted=0","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 and b.status_active=1 and b.is_deleted=0","gsm_weight");

	//echo $gsm_weight_top.'='.$gsm_weight_bottom;
	// $gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	// $gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $po_id_cond  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
	$po_qty+=$sql_po_row[csf('order_quantity')];
	$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
	$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
	}
	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;


	    $condition= new condition();

	   if($version > 1){
					$condition->approved_no("=$version");
					$condition->approval_from("=15");
					$version_no ="  Version No: $version ";
		}
         
	if($db_type==0)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name  $txt_costing_date order by a.job_no";
	}
	if($db_type==2)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_no $company_name $cbo_buyer_name  order by a.job_no";
	}

	$data_array=sql_select($sql);


	?>
    <!--<div style="width:850px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>-->
	<?
	ob_start();
	$uom="";
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;

		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no $po_id_cond2 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_ref.=$val[csf('grouping')].",";
			$job_in_file.=$val[csf('file_no')].",";

		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);

		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref)
		{
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}



		?>
            	<table style="width:850px" ><tr><td colspan="6" align="center">
                   <? $path=($path)?$path:'../../';
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='".str_replace("'","",$cbo_company_name)."'","image_location");
					?>
                    <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                    <b style="float:right"><?=$version_no; ?></b>
                </td></tr></table>


                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}

						?>
                        <td width="100"><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td colspan="3"><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Job Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
                        <td>Plun Cut Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>

                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?> USD</b></td>
                    </tr>
                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                    <tr>
                    <td>Knit Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_fin_req_kg")] ?> (Kg)</b></td>
                        <td>Woven Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_fin_req_yds")]; ?>(Yds)</b></td>
                    	<td>GSM </td>
                        <td><b><? //echo $gsm_weight_top.",".$gsm_weight_bottom

						$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
						$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
						if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';
						if($gsm_weight_bottom!='' && $gsm_weights_top!='') $gsm_weightBottom=" ,".$gsm_weight_bottom;
						else if($gsm_weight_bottom!='' && $gsm_weights_top=='') $gsm_weightBottom=$gsm_weight_bottom;
						else $gsm_weightBottom='';
						echo $gsm_weightTop .$gsm_weightBottom;
						 ?></b></td>

                    </tr>
                     <tr>
                     <td>SMV</td>
                    <td><b><? echo $row[csf("sew_smv")] ?> </b></td>
                     <td>CPM</td>
                    <td><b><? echo $cpm; ?> </b></td>
                    <td>Budget Minute</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                    </tr>

                    <tr>
                    <td>Efficiency</td>
                    <td colspan="1"><b><? echo $row[csf("sew_effi_percent")] ?> </b></td>
                    <td>Internal Ref</td>
                    <td colspan="1"><b><? echo ltrim($ref_cond,", "); ?> </b></td>
                    <td>File No</td>
                    <td colspan="1"><b><? echo $file_cond; ?></b></td>
                    </tr>
                    <tr>
                    <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                    </tr>
                </table>
            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12; $costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1; $costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24; $costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36; $costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48; $costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
	}//end first foearch


	//start	all summary report here -------------------------------------------
	 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
	from wo_pre_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			$fabric_cost=$row[csf("fabric_cost")];
			$trims_cost=$row[csf("trims_cost")];
			$embel_cost=$row[csf("embel_cost")];
			$comm_cost=$row[csf("comm_cost")];
			$commission=$row[csf("commission")];
			$lab_test=$row[csf("lab_test")];
			$inspection=$row[csf("inspection")];
			$cm_cost=$row[csf("cm_cost")];
			$freight=$row[csf("freight")];
			$currier_pre_cost=$row[csf("currier_pre_cost")];
			$certificate_pre_cost=$row[csf("certificate_pre_cost")];
			$common_oh=$row[csf("common_oh")];
				$sl=$sl+1;
  				$others_cost_value=$row[csf("total_cost")]-$row[csf("cm_cost")]-$row[csf("freight")]-$row[csf("comm_cost")]-$row[csf("commission")];
				if($zero_value==1)
				{

		?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);$price_dzn=$row[csf("price_dzn")];//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right" rowspan="13">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("currier_pre_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("currier_percent")],2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("certificate_pre_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("certificate_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-15)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>

            <?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)

				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<? echo $sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
        </table>
    </div>
    <?
	//End all summary report here -------------------------------------------



	$sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active   from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";

		$data_array=sql_select($sql);
		$knit_fab="";$woven_fab="";
		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;
        $i=3;$j=2;
		foreach( $data_array as $row )
        {
			$uom=$unit_of_measurement[$row[csf("uom")]];
            if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				}
				else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
				}
				$percent_to_order_value=$amount/$price_dzn*100;
				//echo $amount.'='.$price_dzn;
				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					 <td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
					  <td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';
					if($row[csf("uom")]==12){
						$knit_subtotal_avg_cons += $row[csf("avg_cons")];
						$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
						if($row[csf("fabric_source")] !=2){
						$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
						}
						else{
							$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
						}
					}
					if($row[csf("uom")]==27){
						$knit_subtotal_avg_cons_yds += $row[csf("avg_cons")];
						$knit_subtotal_avg_cons_yarn_yds += $row[csf("avg_cons_yarn")];
						if($row[csf("fabric_source")] !=2){
						$knit_subtotal_amount_yds += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
						}
						else{
							$knit_subtotal_amount_yds += $row[csf("avg_cons")]*$row[csf("rate")];
						}
					}
			}

			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				$percent_to_order_value=$amount/$price_dzn*100;
				$j++;
                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
					 <td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';

				$woven_subtotal_avg_cons += $row[csf("avg_cons")];
				$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
				$woven_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/'.$costing_for.'</td>
							<td width="100">Avg. Fab. Cons/'.$costing_for.'</td>
							<td width="100">UOM</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab= '<tr><td colspan="8">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Kg)</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Yds)</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yds,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn_yds,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_yds,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_yds/$price_dzn*100,2).'%</td>
					</tr>';
					/*$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg_amount,4).'</td>
					</tr>';*/
					if($zero_value==1)
					{
  		               echo $knit_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $knit_fab;
						}
						else
						{
							echo "";
						}

					}

		//woven fabrics table here
		$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
   					$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total</td>
						<td align="right"></td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format(($woven_subtotal_amount+$knit_subtotal_amount),4).'</td>
						<td align="right">'.fn_number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
					</tr></table></div>';
        // echo $woven_fab;
		 if($zero_value==1)
					{
  		               echo $woven_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $woven_fab;
						}
						else
						{
							echo "";
						}

					}
  		$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );

		$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two,color,type_id, min(cons_ratio) as cons_ratio , sum(cons_qnty) as cons_qnty,sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
		$data_array=sql_select($sql);
		if($zero_value==1)
		{
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qty</td>
                    <td width="100">Avg.Yarn Qty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                   <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;  $total_avg_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	  $grand_total_amount +=$total_amount;
	  }
	  else
	  {
		  if($fabric_cost>0)
		  {
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                     <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	      $grand_total_amount +=$total_amount;
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql = "select a.id,a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0
			where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Avg. Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo  fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                    <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($fabric_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Avg. Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                     <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------
   	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
			from wo_pre_cost_trim_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($trims_cost>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	// End Trims Cost Part report here -------------------------------------------



	// start	Embellishment Details part report here -------------------------------------------
    $sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($embel_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($comm_cost>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($commission>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
				if($row[csf("lab_test")]>0)
				{
  			?>


                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("inspection")]>0)
				{
				?>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("cm_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("freight")]>0)
				{
				?>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                 <?
				}
				if($row[csf("common_oh")]>0)
				{
				?>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
				}
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Other Components  Part report here -------------------------------------------



  	//start	CM on Net Order Value part report here -------------------------------------------
    $sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><? echo fn_number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($otherCost,4); ?></td>
                    <td align="center"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Value</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,4); ?></td>
                    <td align="center"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_job_qnty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>

                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_job_qnty*$avg_unit_price; echo fn_number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_job_qnty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

           </table>
      </div>

       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>


      <div style="clear:both"></div>
      </div>
    <!--End CM on Net Order Value Part report here -->
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>
    <br/>
 	<?
     //echo signature_table(109, $cbo_company_name, "860px");
	 $cbo_company_name=str_replace("'","",$cbo_company_name);

	 $path=($path!='')?$path:"../../";
	 //$inserted_by=return_field_value("inserted_by", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
	 $job_info=sql_select("SELECT id, inserted_by from wo_pre_cost_mst where status_active=1 and is_deleted=0 and job_no='".str_replace("'","",$txt_job_no)."'");
	 foreach ($job_info as $row) {
		 $inserted_by=$row[csf('inserted_by')];
		 $job_id=$row[csf('id')];
	 }

	$signature_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='user_signature'",'master_tble_id','image_location');
	 $appSql="select approved_by from approval_history where entry_form=15 and mst_id = $job_id";
	 $appSqlRes=sql_select($appSql);
	 foreach($appSqlRes as $row){
		 $userSignatureArr[$row[csf('approved_by')]]=$path.$signature_arr[$row[csf('approved_by')]];
	 }
	 $userSignatureArr[$inserted_by]=$path.$signature_arr[$inserted_by];
	 //echo signature_table(109, $cbo_company_name, "1200px",$cbo_template_id,50,$inserted_by,$userSignatureArr);
	 //$report_id, $company, $width, $template_id="", $padding_top = 70,$prepared_by='',$userSignatureArr=array(),$break_tr=7
	 $width="1200px";
	 $report_id=109;
	 $padding_top = 50;
	 $$prepared_by=$inserted_by;
	if ($cbo_template_id != '') {
		$template_id = " and template_id=$cbo_template_id ";
	}
	$sql = sql_select("select USER_ID,designation,name,activities,prepared_by from variable_settings_signature where report_id=$report_id and company_id=$cbo_company_name   and status_active=1 $template_id order by sequence_no ");
	$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	if($sql[0][csf("prepared_by")]==1){
		list($prepared_by,$activities)=explode('**',$prepared_by);
		$sql_2[100] = array ( USER_ID=>$prepared_by,DESIGNATION => 'Prepared By' ,NAME => ($user_lib_name[$prepared_by])?$user_lib_name[$prepared_by]:$prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
		$sql=$sql_2+$sql;
	}
	$count = count($sql);
	$td_width = floor($width / $count);
	$standard_width = $count * 150;
	if ($standard_width > $width) {
		$td_width = 150;
	}
	$no_coloumn_per_tr = floor($width / $td_width);
	$i = 1;
	if ($count == 0) {$message = "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
	echo '<table cellspacing="5" id="signatureTblId" width="' . $width . '" style="padding-top:' . $padding_top . 'px;"><tr><td width="100%" height="' . $padding_top . '" colspan="' . $count . '">' . $message . '</td></tr>';
	$flag=0;
	foreach ($sql as $row) {
		$flag++;
		$sigHtml='';
		if($userSignatureArr[$row['USER_ID']]){$sigHtml='<img src="'.$userSignatureArr[$row['USER_ID']].'" height="60" width="180">';}
		else{$sigHtml='<div height="40"></div>';}
		if($flag==1){echo "<tr>";}
		echo '<td width="' . $td_width . '" align="center" valign="top">
		<p style="min-height:40px;">'.$sigHtml.'</p>
		<strong>' . $row[csf("activities")] . '</strong><br>
		<strong style="text-decoration:overline">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
		if($flag==$break_tr || $count==$i){echo "</tr>";$flag=0;}
		$i++;
	}
	echo '</table>';


	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send)=explode('**',$mail_data);
	if($is_mail_send==1){

		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');

		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody);
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}


		$sql = "SELECT a.BRAND_IDS,a.BUYER_IDS,c.email_address as MAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id  and a.mail_item=b.MAIL_ITEM_MST and a.mail_item=89 and b.mail_user_setup_id=c.id and a.company_id =".$cbo_company_name."  and   A.IS_DELETED=0 and A.STATUS_ACTIVE=1  and b.IS_DELETED=0 and b.STATUS_ACTIVE=1  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		$mail_sql=sql_select($sql);
		$receverMailArr=array();
		foreach($mail_sql as $row)
		{
			$mailToArr[]=$row[MAIL];
		}

		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.entry_form=15 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";

		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){

			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows[USER_EMAIL]!='' && $bi==$buyer_name_id){$mailToArr[]=$rows[USER_EMAIL];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows[USER_EMAIL]){$mailToArr[]=$rows[USER_EMAIL];}
				if($rows[BYPASS]==2){break;}
			}

		}


		$to=implode(',',array_unique($mailToArr));
		//echo $to;die;


   /*		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
   */
		$subject="Pre Cost Entry Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );

	}

	//------------------------------------End;


}//end master if condition-------------------------------------------------------

if($action=="preCostRpt2")//
{
	if(isset($_GET['action']))
	{
		$version=str_replace("'","",$_GET['version']);
	}
	
	else{
		$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));}

	//print_r($version);

	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	$costing_date=str_replace("'","",$txt_costing_date);

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";

	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$selected_po_breack_down_id = str_replace("'",'',$txt_po_breack_down_id);
		$txt_po_breack_down_id_cond=" and b.id in(".$selected_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$selected_po_breack_down_id.")";
	}

	$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=".$cbo_company_name."  and variable_list=22 and status_active=1 and is_deleted=0");
	if($cm_cost_method_based_on=="") $cm_cost_method_based_on=1;
	/*
	$sql_data=sql_select("select yarn_iss_with_serv_app from variable_order_tracking where company_name=".$cbo_company_name." and variable_list=67 and status_active=1 and is_deleted=0");
	foreach($sql_data as $sql_row)
	{
		$location_cpm_cost=$sql_row[csf('yarn_iss_with_serv_app')];
	}*/
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$location_cpm_cost=0;
	$cm_min_variable=return_field_value("yarn_iss_with_serv_app as cost_per_minute","variable_order_tracking","company_name =".$cbo_company_name." and variable_list=67 and is_deleted=0 and status_active=1","cost_per_minute");
	if($cm_min_variable=="" || $cm_min_variable==0) $location_cpm_cost=0; else $location_cpm_cost=$cm_min_variable;

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand",'id','brand_name');

	//$gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	//$gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1 and b.status_active=1 and b.is_deleted=0","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 and b.status_active=1 and b.is_deleted=0","gsm_weight");


	 $po_qty=0; $po_plun_cut_qty=0; $total_set_qnty=0;$total_fob_value=0;$job_in_orders=''; $pulich_ship_date=''; $job_in_file=''; $job_in_ref='';
	 $sql_po="select a.job_no,a.location_name, a.total_set_qnty, b.id, b.po_number, b.grouping, b.file_no, b.pub_shipment_date, c.order_total,c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and a.job_no =".$txt_job_no." $txt_po_breack_down_id_cond and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";

	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$location_name_id=$sql_po_row[csf('location_name')];

		$job_in_orders .=$sql_po_row[csf('po_number')].",";
		$pulich_ship_date = $sql_po_row[csf('pub_shipment_date')];
		$job_in_file .= $sql_po_row[csf('file_no')].",";
		$job_in_ref .= $sql_po_row[csf('grouping')].",";
		$total_fob_value+=$sql_po_row[csf('order_total')];
		$po_id_arr[$sql_po_row[csf('id')]]=$sql_po_row[csf('id')];
	}
	$job_in_orders=implode(", ",array_unique(explode(",",substr(trim($job_in_orders),0,-1))));
	$po_id_str= implode( ",",$po_id_arr);
	//echo $location_name_id.'DDD';

	$sales_contract_sql=sql_select("SELECT a.contract_no,b.wo_po_break_down_id from com_sales_contract a join com_sales_contract_order_info b on a.id=b.com_sales_contract_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.contract_no, b.wo_po_break_down_id");
	$sales_contract_arr=array();
	if(count($sales_contract_sql)>0)
	{
		foreach ($sales_contract_sql as $key => $row) {
			$sales_contract_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('contract_no')];
		}
	}

	$export_lc_sql=sql_select("SELECT a.export_lc_no,b.wo_po_break_down_id from com_export_lc a join com_export_lc_order_info b on a.id=b.com_export_lc_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.export_lc_no,b.wo_po_break_down_id");
	$export_lc_arr=array();
	if(count($export_lc_sql)>0)
	{
		foreach ($export_lc_sql as $key => $row) {
			$export_lc_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('export_lc_no')];
		}
	}
	$sc_lc_no="";
	if(count($sales_contract_arr)>0)
	{
		$sc_lc_no=implode(",", $sales_contract_arr);
	}
	if(count($export_lc_arr)>0)
	{
		$sc_lc_no=implode(",", $export_lc_arr);
	}


	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row)
	{
		$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	$cm_cost_based_on_date="";
	if($cm_cost_method_based_on==1){
			if($db_type==0) $cm_cost_based_on_date=change_date_format($costing_date, "yyyy-mm-dd", "-");
			if($db_type==2) $cm_cost_based_on_date=change_date_format($costing_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==2){
		$min_shipment_sql=sql_select("select job_no_mst, min(shipment_date) as min_shipment_date from wo_po_break_down where job_no_mst=".$txt_job_no." $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_shipment_date="";
		foreach($min_shipment_sql as $row){
			$min_shipment_date=$row[csf('min_shipment_date')];
		}

		if($db_type==0) $cm_cost_based_on_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $cm_cost_based_on_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==3){
		$max_shipment_sql=sql_select("select job_no_mst, max(shipment_date) as max_shipment_date from wo_po_break_down where job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 $txt_po_breack_down_id_cond1 group by job_no_mst");
		$max_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_shipment_date=$row[csf('max_shipment_date')];
		}

		if($db_type==0) $cm_cost_based_on_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $cm_cost_based_on_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==4){

		$max_shipment_sql=sql_select("select job_no_mst, min(pub_shipment_date) as min_pub_shipment_date from wo_po_break_down where job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 $txt_po_breack_down_id_cond1 group by job_no_mst");
		$min_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$min_pub_shipment_date=$row[csf('min_pub_shipment_date')];
		}

		if($db_type==0) $cm_cost_based_on_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $cm_cost_based_on_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==5){
		$max_shipment_sql=sql_select("select job_no_mst, max(pub_shipment_date) as max_pub_shipment_date from wo_po_break_down where job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 $txt_po_breack_down_id_cond1 group by job_no_mst");
		$max_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_pub_shipment_date=$row[csf('max_pub_shipment_date')];
		}

		if($db_type==0) $cm_cost_based_on_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $cm_cost_based_on_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	$financial_para=array();

	if($location_cpm_cost!=1)
	{
		$sql_std_para=sql_select("select interest_expense, income_tax, cost_per_minute, applying_period_date, applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and is_deleted=0 order by id");

		foreach($sql_std_para as $row )
		{
			$applying_period_date=change_date_format($row[csf('applying_period_date')],'','',1);
			$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
			$diff=datediff('d',$applying_period_date,$applying_period_to_date);
			for($j=0;$j<$diff;$j++)
			{
				//$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
				$date_all=add_date(str_replace("'","",$applying_period_date),$j);
				$newdate =change_date_format($date_all,'','',1);
				$financial_para[$newdate][interest_expense]=$row[csf('interest_expense')];
				$financial_para[$newdate][income_tax]=$row[csf('income_tax')];
				$financial_para[$newdate][cost_per_minute]=$row[csf('cost_per_minute')];
			}
		}
	}
	else
	{
		$sql_std_para=sql_select( "select a.id, b.id as dtls_id, b.location_id, b.applying_period_date, b.applying_period_to_date, b.monthly_cm_expense, b.no_factory_machine, b.working_hour, b.cost_per_minute from lib_standard_cm_entry a, lib_standard_cm_entry_dtls b where a.id=b.mst_id and b.location_id=$location_name_id and a.company_id=$cbo_company_name" );
		foreach($sql_std_para as $row)
		{
			$applying_period_date=change_date_format($row[csf('applying_period_date')],'','',1);
			$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
			$diff=datediff('d',$applying_period_date,$applying_period_to_date);
			for($j=0;$j<$diff;$j++)
			{
				$date_all=add_date(str_replace("'","",$applying_period_date),$j);
				$newdate =change_date_format($date_all,'','',1);
				$financial_para[$newdate][interest_expense]=$row[csf('interest_expense')];
				$financial_para[$newdate][income_tax]=$row[csf('income_tax')];
				$financial_para[$newdate][cost_per_minute]=$row[csf('cost_per_minute')];
			}
		}
	}

	$sql="select id from electronic_approval_setup where company_id=$cbo_company_name and page_id in(1717,442,1023) and is_deleted=0";
	 // echo $sql;die;
	$res_result_arr = sql_select($sql);
	$approval_arr=array();
	foreach($res_result_arr as $row){

		$approval_arr[$row["ID"]]["ID"]=$row["ID"];

	}

	$fab_knit_req_kg_avg=0; $fab_woven_req_yds_avg=0;
 	$sql_mst = "SELECT b.inserted_by,a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, a.style_description, b.costing_per, b.budget_minute, b.costing_date, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, b.exchange_rate, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg, d.margin_pcs_set, d.margin_pcs_bom, d.cost_pcs_set,a.brand_id from wo_po_details_master a , wo_pre_cost_mst b , wo_pre_cost_dtls d , wo_pre_cost_sum_dtls c  where  a.id=b.job_id and  a.id=d.job_id  and a.id=c.job_id and c.status_active=1 and c.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and d.job_no=$txt_job_no $job_no $company_name $cbo_buyer_name  order by a.job_no"; // Dont Change margin_pcs_bom, If need Pls Contract with ISD-23-00149
	//echo $sql_mst; die;
	$data_array=sql_select($sql_mst);
	$po_plan_quantity=0;
	$result_sql =sql_select("select po_number,grouping,file_no,plan_cut,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 $txt_po_breack_down_id_cond1 order by pub_shipment_date DESC");

		foreach ($result_sql as $val){

			$po_plan_quantity+=$val[csf('plan_cut')];
		}
		unset($result_sql);

	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0; $order_job_qnty=0; $avg_unit_price=0;
		$buyer_name=$row[csf("buyer_name")];
		$brand_id=$row[csf("brand_id")];
		$style_ref_no=$row[csf("style_ref_no")];
		$style_desc=$row[csf("style_description")];
		$uom_id=$row[csf("order_uom")];$approved=$row[csf("approved")];$budget_minute=$row[csf("budget_minute")];$costing_per_id=$row[csf("costing_per")];
		$job_quantity=$row[csf("job_quantity")];
		$quotation_id= $row[csf("quotation_id")];
		$margin_pcs_bom=$row[csf("margin_pcs_bom")]; // Dont Change margin_pcs_bom, If need Pls Contract with ISD-23-00149
		$cost_pcs_set=$row[csf("cost_pcs_set")];
		$avg_unit_price=$row[csf("avg_unit_price")];
		$fab_yarn_req_kg=$row[csf("fab_yarn_req_kg")];
		//echo $buyer_name.'DDDDD';

		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
		$costing_date=$row[csf("costing_date")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$avg_unit_price;
		$exchange_rate=$row[csf("exchange_rate")];
		$inserted_by=$row[csf("inserted_by")];


		//$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_in_ref=rtrim($job_in_ref,", ");
		$job_in_file=rtrim($job_in_file,", ");
		$job_ref=array_unique(explode(",",$job_in_ref));
		$job_file=array_unique(explode(",",$job_in_file));

		foreach ($job_ref as $ref){
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file){
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		$condition= new condition();
		if($version > 1){
			$condition->approved_no("=$version");
			$condition->approval_from("=15");
			$version_no ="  Revised No: $version ";
      }

		if(str_replace("'","",$txt_job_no) !=''){
			$condition->job_no("=$txt_job_no");
		}
		if(str_replace("'",'',$txt_po_breack_down_id) !=""){
			$condition->po_id("in($selected_po_breack_down_id)");
		}

		$condition->init();
		$fabric= new fabric($condition);

		$yarn= new yarn($condition);
		$conversion= new conversion($condition);
		$trim= new trims($condition);
		$emblishment= new emblishment($condition);
		$wash= new wash($condition);
		$other= new other($condition);
		$other_cost=$other->getAmountArray_by_job();
		//echo $other->getQuery();die;
		//$trims_cost_arr=$trim->getQtyArray_by_orderAndItemidTypeid();
		// print_r($other_cost);
		$commercial= new commercial($condition);
		$commision= new commision($condition);


		//Fabric =====================
		$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_arr_fabric=sql_select($sql_fabric);
		$summary_data=array();
		foreach($data_arr_fabric as $fab_row)
		{
			$summary_data['fabric_cost'][$fab_row[csf("id")]]=$fab_row[csf("amount")];
			$summary_data['fabric_cost_job']+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$summary_data['fabric_cost_job']+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		unset($data_arr_fabric);

		//Fabric End======================




		//Yarn===========================
		$totYarn=0;
		$YarnData=array();
		$yarn_data_array=$yarn->get_By_Precostdtlsid_YarnQtyAmountArray();
		$sql_yarn="select f.id as yarn_id, f.cons_ratio, f.cons_qnty, f.avg_cons_qnty, f.rate, f.amount, count_id, copm_one_id, percent_one, color, type_id from wo_pre_cost_fab_yarn_cost_dtls f where f.job_no =".$txt_job_no." and f.is_deleted=0 and f.status_active=1  order by f.id";
		$data_arr_yarn=sql_select($sql_yarn);
		foreach($data_arr_yarn as $yarn_row)
		{
			$yarnrate=$yarn_row[csf("rate")];
			$summary_data['yarn_cost'][$yarn_row[csf("yarn_id")]]=$yarn_row[csf("amount")];
			$summary_data['yarn_cost_job']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
			$index="'".$yarn_row[csf("count_id")]."_".$yarn_row[csf("copm_one_id")]."_".$yarn_row[csf("percent_one")]."_".$yarn_row[csf("type_id")]."_".$yarn_row[csf("color")]."_".$yarnrate."'";
			$YarnData[$index]['qty']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
			$YarnData[$index]['amount']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
			$YarnData[$index]['dznqty']+=$yarn_row[csf("cons_qnty")];
			$YarnData[$index]['dznamount']+=$yarn_row[csf("amount")];
			$totYarn+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
		}
		unset($data_arr_yarn);
		//Yarn End============================



		//start	Trims Cost part report here -------------------------------------------
		$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
		from wo_pre_cost_trim_cost_dtls
		where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array_trim=sql_select($sql_trim);
		$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
		$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
		//$trim_type_qty_arr=$trim->getQtyArray_by_orderAndTrimsTypeid();
		//print_r($trim_type_qty_arr);
		$totTrim=0;
		$TrimData=array();
		foreach( $data_array_trim as $row_trim )
		{
			$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
			$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
			$summary_data['trims_cost_job']+=$trim_amount;
			$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
			$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
			$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
			$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
			$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
			$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
			$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
			$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
			$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
			$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
			$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
			$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
			$totTrim+=$row_trim[csf('cons_dzn_gmts')];
		}
		//End	Trims Cost part report here -------------------------------------------
		$sql_fab = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, uom, avg_cons, avg_cons_yarn, fabric_source, gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."  and status_active=1 and is_deleted=0";
	$data_array_pre_fab=sql_select($sql_fab);


	$knit_grey_avg_cons=0;


	foreach( $data_array_pre_fab as $row )
	{
		$fab_nature_id=$row[csf("fab_nature_id")];

		$uom=$unit_of_measurement[$row[csf("uom")]];
		if($fab_nature_id==2)
		{
			$knit_grey_avg_consArr[$uom]+=$row[csf("avg_cons")];
			$knit_fin_avg_consArr[$uom]+=$row[csf("avg_finish_cons")];
		}
		else if($fab_nature_id==3)
		{
			$wvn_grey_avg_consArr[$uom]+=$row[csf("avg_cons")];
			$wvn_fin_avg_consArr[$uom]+=$row[csf("avg_finish_cons")];
		}
	}
	//echo implode(",",$knit_fin_avg_consArr);
	$knit_uom_grey_cons='';
	foreach($knit_grey_avg_consArr as $uomId=>$val)
	{

		$knit_uom_grey_cons.=number_format($val,2)."($uomId)".',';
	}
	$knit_uom_wise_grey_cons=chop($knit_uom_grey_cons,",");
	$knit_uom_fin_cons='';
	foreach($knit_fin_avg_consArr as $uomId=>$fin)
	{

		$knit_uom_fin_cons.=number_format($fin,2)."($uomId)".',';
	}

	$knit_uom_wise_fin_cons=chop($knit_uom_fin_cons,",");
	//echo $knit_uom_wise_fin_cons.'F';
	// Knit End========
	$wvn_knit_uom_grey_cons='';
	foreach($wvn_grey_avg_consArr as $uomId=>$val)
	{
		$wvn_knit_uom_grey_cons.=number_format($val,2).' ('.$uomId.')'.',';
	}
	$wvn_uom_wise_grey_cons=chop($wvn_knit_uom_grey_cons,",");

	 $wvn_uom_fin_cons='';
	foreach($wvn_fin_avg_consArr as $uomId=>$fin)
	{

		$wvn_uom_fin_cons.=number_format($fin,2).' ('.$uomId.')'.',';
	}
	$wvn_uom_wise_fin_cons=chop($wvn_uom_fin_cons,",");
	$cost_pcs_set=0;
	$cost_pcs_set=$avg_unit_price-$margin_pcs_bom;
	if($path=='')
		{
			$path="../../";
		}
		else
		{
			$path="../../../";
		}

		?>
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='".str_replace("'","",$cbo_company_name)."'","image_location");
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Pre- Costing</b>
            <b style="float:right"><?=$version_no; ?></b>
        </td></tr></table>
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
            <tr>
                <td width="140">Job Number</td>
                <td width="130"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="140">Buyer</td>
                <td width="180" style="word-break:break-all"><b><? echo $buyer_arr[$buyer_name]; ?></b></td>
				<td colspan="2" align="center"><b>Material Cost</b></td>
            </tr>
            <tr>
				<td>Brand Name</td>
                <td style="word-break:break-all"><b><? echo $brand_arr[$brand_id]; ?></b></td>

                <td>Style Ref. No </td>
                <td style="word-break:break-all"><b><? echo $style_ref_no; ?></b></td>
			    <td width="120"><b>Fabric Purchase</b></td>
			    <td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[fabric_cost_job],4); ?></b></td>
            </tr>
            <tr>
            	<td>Job Qty</td>
                <td><b><?   echo $job_quantity." ". $unit_of_measurement[$uom_id]; ?></b></td>
                <td>Plan Cut Qty</td>
                <td><b><? echo $po_plan_quantity." ". $unit_of_measurement[$uom_id];?></b></td>
				<td><b>Yarn</b></td>
				<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[yarn_cost_job],4); ?></b></td>
            </tr>
            <tr>
            	<td>Order Numbers</td>
                <td colspan="3" style="word-break:break-all"><b><? echo $job_in_orders; ?></b></td>
				<td><b>Accessories</b></td>
				<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[trims_cost_job],4)?></b></td>
            </tr>
            <tr>
            	<td>Quotation ID</td>
                <td><b><? echo  $quotation_id; ?> </b></td>
				<td>Garments Item</td>
                <?
                    $grmnt_items = "";
                    if($garments_item[$row[csf("gmts_item_id")]]=="")
                    {
                        $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
                        foreach($grmts_sql as $key=>$val){
                            $grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
                        }
                        $grmnt_items = substr_replace($grmnt_items,"",-1,1);
                    }else{
                        $grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
                    }
                ?>
                <td style="word-break:break-all"><b><? echo $grmnt_items; ?></b></td>

				<td><b>Total</b></td>
				<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[fabric_cost_job]+$summary_data[yarn_cost_job]+$summary_data[trims_cost_job],4); ?></b></td>
            </tr>
            <tr>
            	<td>Knit Fab. Cons</td>
                <td><b><? echo $knit_uom_wise_grey_cons;//$row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> </b></td>
                <td>Woven Fab. Cons</td>
                <td><b><? echo $wvn_uom_wise_grey_cons;//$row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> </b></td>
				<? if($avg_unit_price>0){ ?>
                <td style="background-color: green;">Price Per <?= $unit_of_measurement[$uom_id]; ?></td>
				<td style="background-color: green;" align="right"><? echo number_format($avg_unit_price,4); ?></td>
				<? }else{ ?>
				<td style="background-color: red;">Price Per <?= $unit_of_measurement[$uom_id]; ?></td>
				<td style="background-color: red;" align="right"><? echo number_format($avg_unit_price,4); ?></td><? }?>
            <tr>
            	<td>Knit Fin Fab. Cons</td>
                <td><b><? echo $knit_uom_wise_fin_cons; ?> </b></td>
                <td>Woven Fin Fab. Cons</td>
                <td><b><? echo $wvn_uom_wise_fin_cons; ?> </b></td>
				<? if($cost_pcs_set>0){ ?>
                <td style="background-color: green;">Costing Per <?= $unit_of_measurement[$uom_id]; ?></td>
				<td style="background-color: green;" align="right" title="Price Per<?= $unit_of_measurement[$uom_id]; ?>-Margin Per <?= $unit_of_measurement[$uom_id]; ?> "><? echo number_format($cost_pcs_set,4); ?></td>
				 <? }else{ ?>
				<td style="background-color: red;">Costing Per <?= $unit_of_measurement[$uom_id]; ?></td>
				<td style="background-color: red;" align="right" title="Price Per<?= $unit_of_measurement[$uom_id]; ?>-Margin Per <?= $unit_of_measurement[$uom_id]; ?> ">
				<? echo number_format($cost_pcs_set,4); ?></td><? }?>
            </tr>
            <tr>
            	<td>Avg Yarn Req</td>
                <td><b><? echo number_format($fab_yarn_req_kg,2); ?> (Kg)</b></td>
            	<td style="word-break:break-all">Shipment Date </td>
                <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
				<? if($margin_pcs_bom>0){ ?>
                <td style="background-color: green;"> Margin Per <?= $unit_of_measurement[$uom_id]; ?></td>
				<td style="background-color: green;" align="right" title="Price Per<?= $unit_of_measurement[$uom_id]; ?>-Margin Per <?= $unit_of_measurement[$uom_id]; ?> ">
				<? echo number_format($margin_pcs_bom,4); ?></td>
				 <? }else{ ?>
					<td style="background-color: red;"> Margin Per <?= $unit_of_measurement[$uom_id]; ?></td>
				<td style="background-color: red;" align="right" title="Price Per<?= $unit_of_measurement[$uom_id]; ?>-Margin Per <?= $unit_of_measurement[$uom_id]; ?> ">
				<? echo number_format($margin_pcs_bom,4); ?></td><? }?>
            </tr>
            <tr>
            	<td>GSM</td>
                <td style="word-break:break-all"><b><?
                $gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
                $gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
                if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';
                if($gsm_weight_bottom!='' && $gsm_weights_top!='') $gsm_weightBottom=" ,".$gsm_weight_bottom;
                else if($gsm_weight_bottom!='' && $gsm_weights_top=='') $gsm_weightBottom=$gsm_weight_bottom;
                else $gsm_weightBottom='';
                echo $gsm_weightTop .$gsm_weightBottom;
                ?></b></td>

                <td>Budget Minute</td>
                <td><b><? echo $budget_minute; ?> </b></td>
                <td align="center" colspan="2" rowspan="2" valign="middle" id="app_sms" style="font-size:20px; word-break:break-all"><font color="#FF0000">
                <? //if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This job is approved ";} else {echo "";}
	                if($approved==1) $ap_msg="This Job Is Approved";
					else if($approved==3) $ap_msg="This Job Partially Approved";
					else $ap_msg="";
					echo $ap_msg;
                 ?> </font> </td>
            </tr>
            <tr>
				<td>Internal Ref</td>
                <td style="word-break:break-all"><b><? echo ltrim($ref_cond,", "); ?></b></td>

             	<td>Sc/Lc No</td>
                <td style="word-break:break-all"><b><? echo $sc_lc_no; ?></b></td>
            </tr>
			<tr>
				<td>Style Desc</td>
                <td><? echo $style_desc; ?></td>
				<td>File No</td>
                <td style="word-break:break-all"><b><? echo $file_cond; ?></b></td>
            </tr>
        </table>
    	<?
		if($costing_per_id==1){
			$order_price_per_dzn=12;
			$costing_for=" DZN";
		}
		else if($costing_per_id==2){
			$order_price_per_dzn=1;
			$costing_for=" PCS";
		}
		else if($costing_per_id==3){
			$order_price_per_dzn=24;
			$costing_for=" 2 DZN";
		}
		else if($costing_per_id==4){
			$order_price_per_dzn=36;
			$costing_for=" 3 DZN";
		}
		else if($costing_per_id==5){
			$order_price_per_dzn=48;
			$costing_for=" 4 DZN";
		}
		$order_job_qnty=$job_quantity;
		$avg_unit_price=$avg_unit_price;
	}//end first foearch

	//start	all summary report here -------------------------------------------


	$sql_new = "select job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, design_cost, design_percent, studio_cost, studio_percent, interest_cost, incometax_cost from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array_new=sql_select($sql_new);
	foreach( $data_array_new as $row_new )
	{
		$summary_data['price_dzn']=$row_new[csf("price_dzn")];
		$summary_data['price_dzn_job']=$total_fob_value;//($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
		$summary_data['commission']=$row_new[csf("commission")];
		$summary_data['trims_cost']=$row_new[csf("trims_cost")];
		$summary_data['emb_cost']=$row_new[csf("embel_cost")];
		$summary_data['lab_test']=$row_new[csf("lab_test")];
		$summary_data['lab_test_job']=$other_cost[$row_new[csf("job_no")]]['lab_test'];
		$summary_data['inspection']=$row_new[csf("inspection")];
		$summary_data['inspection_job']=$other_cost[$row_new[csf("job_no")]]['inspection'];
		$summary_data['freight']=$row_new[csf("freight")];
		$summary_data['freight_job']=$other_cost[$row_new[csf("job_no")]]['freight'];
		$summary_data['design']=$row_new[csf("design_cost")];
		$summary_data['design_job']=$other_cost[$row_new[csf("job_no")]]['design_cost'];
		$summary_data['studio_job']=$other_cost[$row_new[csf("job_no")]]['studio_cost'];
		$summary_data['studio']=$row_new[csf("studio_cost")];
		$summary_data['currier_pre_cost']=$row_new[csf("currier_pre_cost")];
		$summary_data['currier_pre_cost_job']=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];
		$summary_data['certificate_pre_cost']=$row_new[csf("certificate_pre_cost")];
		$summary_data['certificate_pre_cost_job']=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
		$summary_data['wash_cost']=$row_new[csf("wash_cost")];
		$summary_data['OtherDirectExpenses']=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("design_cost")]+$row_new[csf("studio_cost")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];
		$summary_data['OtherDirectExpenses_job']=$summary_data['lab_test_job']+$summary_data['inspection_job']+$summary_data['design_job']+$summary_data['studio_job']+$summary_data['freight_job']+$summary_data['currier_pre_cost_job']+$summary_data['certificate_pre_cost_job'];

		$summary_data['cm_cost']=$row_new[csf("cm_cost")];
		$summary_data['cm_cost_job']=$other_cost[$row_new[csf("job_no")]]['cm_cost'];
		$summary_data['comm_cost']=$row_new[csf("comm_cost")];
		$summary_data['common_oh']=$row_new[csf("common_oh")];
		$summary_data['common_oh_job']=$other_cost[$row_new[csf("job_no")]]['common_oh'];
		$summary_data['depr_amor_pre_cost']=$row_new[csf("depr_amor_pre_cost")];
		$summary_data['depr_amor_pre_cost_job']=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
		$summary_data['interest_cost']=$row_new[csf("interest_cost")];
		$summary_data['interest_cost_job']=$other_cost[$row_new[csf("job_no")]]['interest_cost'];
		$summary_data['incometax_cost']=$row_new[csf("incometax_cost")];
		$summary_data['incometax_cost_job']=$other_cost[$row_new[csf("job_no")]]['incometax_cost'];
	}

	// Conversion
	$totConv=0;
	$ConvData=array();
	$conv_data=array();
	$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
	$conv_qty_arr=$conversion->getQtyArray_by_conversionid();
	$sql_conv = "select a.id as con_id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.uom  from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no."  and a.id>0 and a.is_deleted =0 and a.status_active=1 ";
	$data_arr_conv=sql_select($sql_conv);
	foreach($data_arr_conv as $conv_row)
	{
		$convamount=array_sum($conv_amount_arr[$conv_row[csf('con_id')]]);
		$convQty=array_sum($conv_qty_arr[$conv_row[csf('con_id')]]);
		$conv_data['cons_process'][$conv_row[csf('con_id')]]=$conv_row[csf('cons_process')];
		$conv_data['amount'][$conv_row[csf('con_id')]]=$conv_row[csf('amount')];
		$conv_data['amount_job'][$conv_row[csf('con_id')]]+=$convamount;
		$summary_data['conver_cost_job']+=$convamount;

		$index=$conv_row[csf('con_id')];
		$ConvData[$index]['item_descrition']=$body_part[$conv_row[csf("body_part_id")]].", ".$color_type[$conv_row[csf("color_type_id")]].", ".$conv_row[csf("fabric_description")];
		$ConvData[$index]['cons_process']=$conv_row[csf("cons_process")];
		$ConvData[$index]['req_qnty']=$conv_row[csf("req_qnty")];
		$ConvData[$index]['uom']=$conv_row[csf("uom")];
		$ConvData[$index]['charge_unit']=$conv_row[csf("charge_unit")];
		$ConvData[$index]['amount']=$conv_row[csf("amount")];
		$ConvData[$index]['tot_req_qnty']=$convQty;
		$ConvData[$index]['tot_amount']=$convamount;
		$totConv+=$conv_row[csf("req_qnty")];
	}
	//Conversion End

	//Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5) and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row )
	{
		$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
		$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data['emb_cost_job']+=$embamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
		$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
		$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data['wash_cost_job']+=$washamount;
		$summary_data['OtherDirectExpenses_job']+=$washamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	unset($data_array);
	//End Wash cost Cost part report here -------------------------------------------
	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from wo_pre_cost_commiss_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
		$commisionamount=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[commission_job]+=$commisionamount;
		$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
		$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
		$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
		$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
		$CommiData[$row[csf("id")]]['tot_commission_amount']=$commisionamount;
		$totCommi+=$row[csf("commission_amount")];
	}
	unset($data_array);
	//End Commision cost Cost part report here -------------------------------------------
	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
		$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data['comm_cost_job']+=$commarcialamount;
		$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
		$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
		$totCommar+=$row[csf("amount")];
	}
	//End Commarcial cost Cost part report here -------------------------------------------
	?>
    <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;" rules="all">
            <tr style="font-weight:bold">
            	<td align="center" width="850" colspan="5">Order Profitability </td>
            </tr>
            <tr style="font-weight:bold">
                <td align="center" width="80">Line Items</td>
                <td width="400">Particulars</td>
                <td width="120">Amount (USD)/<? echo $costing_for; ?></td>
                <td width="120">Total Value</td>
                <td>%</td>
            </tr>
            <tr>
                <td align="center">1</td>
                <td style="font-weight:bold">Gross FOB Value</td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn_job],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">2</td>
                <td style=" padding-left:15px">Less: commission</td>
                <td align="right"><? echo fn_number_format($summary_data[commission],4); ?></td>
                <td align="right"><? echo fn_number_format($summary_data[commission_job],4); ?></td>
                <td align="right"><? echo fn_number_format(($summary_data[commission_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">3</td>
                <?
                $NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
                $NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];
                ?>
                <td style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">4</td>
                <td style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8+9) </b></td>
                <?
                $Less_Cost_Material_Services=array_sum($summary_data[yarn_cost])+array_sum($summary_data[fabric_cost])+array_sum($conv_data[amount])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[design]+$summary_data[studio]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];

               $Less_Cost_Material_Services_job=$summary_data[yarn_cost_job]+$summary_data[fabric_cost_job]+$summary_data[conver_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];
			    //$Less_Cost_Material_Services_job=array_sum($summary_data[yarn_cost])+array_sum($summary_data[fabric_cost])+array_sum($conv_data[amount])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[OtherDirectExpenses_dzn];
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($Less_Cost_Material_Services,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($Less_Cost_Material_Services_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center" rowspan="2">5</td>
                <td style=" padding-left:100px;font-weight:bold">Fabric Purchase Cost</td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format(array_sum($summary_data[fabric_cost]),4); ?></td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[fabric_cost_job],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[fabric_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td style=" padding-left:100px;font-weight:bold">Yarn Cost</td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format(array_sum($summary_data[yarn_cost]),4); ?></td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[yarn_cost_job],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[yarn_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center" valign="top">6</td>
                <td width="400" style=" padding-left:100px">
                    <table>
                        <tr>
                        	<td style="font-weight:bold">Conversion Cost</td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
						<? foreach($conv_data['cons_process'] as $key => $value){ ?>
                            <tr>
                                <td align="left"><? echo $conversion_cost_head_array[$conv_data['cons_process'][$key]]; ?></td>
                            </tr>
                        <? }?>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format(array_sum($conv_data['amount']),4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
						<? foreach($conv_data['cons_process'] as $key => $value){ ?>
                            <tr>
                                <td align="right"><? echo fn_number_format($conv_data['amount'][$key],4);?></td>
                            </tr>
                        <? } ?>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data['conver_cost_job'],4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <? foreach($conv_data['cons_process'] as $key => $value){ ?>
                            <tr>
                                <td align="right"><? echo fn_number_format($conv_data['amount_job'][$key],4);?></td>
                            </tr>
                        <? }?>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data['conver_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
						<? foreach($conv_data['cons_process'] as $key => $value){ ?>
                            <tr>
                            	<td align="right"><? echo fn_number_format(($conv_data['amount_job'][$key]/$summary_data['price_dzn_job'])*100,4);?></td>
                            </tr>
                        <? }?>
                    </table>
                </td>
            </tr>
            <tr>
                <td align="center">7</td>
                <td style="padding-left:100px;font-weight:bold" ><b>Trim Cost </b></td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data['trims_cost'],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data['trims_cost_job'],4)?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data['trims_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">8</td>
                <td style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data['emb_cost'],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data['emb_cost_job'],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data['emb_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
                <td align="center" valign="top">9</td>
                <td style="padding-left:100px">
                    <table>
                        <tr>
                        	<td style="font-weight:bold">Other Direct Expenses</td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td>Lab Test</td>
                        </tr>
                        <tr>
                        	<td>Inspection</td>
                        </tr>
                        <tr>
                        	<td>Design Cost</td>
                        </tr>
                        <tr>
                        	<td>Studio Cost</td>
                        </tr>
                        <tr>
                        	<td>Freight Cost</td>
                        </tr>
                        <tr>
                        	<td>Courier Cost</td>
                        </tr>
                        <tr>
                        	<td>Certificate Cost</td>
                        </tr>
                        <tr>
                        	<td>Garments Wash Cost</td>
                        </tr>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[OtherDirectExpenses],4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['lab_test'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['inspection'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['design'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['studio'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['freight'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['currier_pre_cost'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['certificate_pre_cost'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['wash_cost'],4);?></td>
                        </tr>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data['OtherDirectExpenses_job'],4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['lab_test_job'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['inspection_job'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['design_job'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['studio_job'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['freight_job'],4);?></td>
                        </tr>
                        <tr>
                       		<td align="right"><? echo fn_number_format($summary_data['currier_pre_cost_job'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['certificate_pre_cost_job'],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data['wash_cost_job'],4);?></td>
                        </tr>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data['OtherDirectExpenses_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data['lab_test_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data['inspection_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data['design_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                        <tr>
                       		<td align="right"><? echo fn_number_format(($summary_data['studio_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data['freight_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data['currier_pre_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data['certificate_pre_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right" title="<?=$summary_data['wash_cost'].'='.$summary_data['price_dzn']; ?>"><? echo fn_number_format(($summary_data['wash_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td align="center">10</td>
                <td style="font-weight:bold">Contributions/Value Additions (3-4)</td>
                <?
                $Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
                $Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($Contribution_Margin,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($Contribution_Margin_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Contribution_Margin_job/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">11</td>
				<? if($summary_data['cm_cost']>0){ ?> <td style="padding-left:15px;background-color: green;">Less: CM Cost</td><? }else{ ?> <td style="padding-left:15px;background-color: red;">Less: CM Cost</td><? }?>
                <? if($summary_data['cm_cost']>0){ ?> <td align="right" style="background-color: green;"><? echo number_format($summary_data['cm_cost'],4); ?></td><? }else{ ?> <td align="right" style="background-color: red;"><? echo number_format($summary_data['cm_cost'],4); ?></td><? }?>
                <? if($summary_data['cm_cost_job']>0){ ?> <td align="right" style="background-color: green;"><? echo number_format($summary_data['cm_cost_job'],4); ?></td><? }else{ ?> <td align="right" style="background-color: red;"><? echo number_format($summary_data['cm_cost_job'],4); ?></td><? }?>
				<? $summary_percent=$summary_data['cm_cost_job']/$summary_data['price_dzn_job']*100;?>
				<? if($summary_percent>0){ ?> <td align="right" style="background-color: green;"><? echo number_format( $summary_percent,4); ?></td><? }else{ ?> <td align="right" style="background-color: red;"><? echo number_format($summary_percent,4); ?></td><? }?>
            </tr>
            <tr>
                <td align="center">12</td>
                <td style="font-weight:bold">Gross Profit (10-11)</td>
                <?
                $Gross_Profit=$Contribution_Margin-$summary_data['cm_cost'];
                $Gross_Profit_job=$Contribution_Margin_job-$summary_data['cm_cost_job'];
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($Gross_Profit,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($Gross_Profit_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Gross_Profit_job/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">13</td>
                <td style=" padding-left:15px">Less: Commercial Cost</td>
                <td align="right"> <? echo fn_number_format( $summary_data['comm_cost'],4); ?></td>
                <td align="right"><? echo fn_number_format( $summary_data['comm_cost_job'],4); ?></td>
                <td align="right"><? echo fn_number_format(($summary_data['comm_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">14</td>
                <td style=" padding-left:15px">Less: Operating Expensees</td>
                <td align="right"><? echo fn_number_format( $summary_data['common_oh'],4); ?> </td>
                <td align="right"><? echo fn_number_format( $summary_data['common_oh_job'],4); ?> </td>
                <td align="right"><? echo fn_number_format(($summary_data['common_oh_job']/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr >
                <td align="center">15</td>
                <td style="font-weight:bold">Operating Profit/ Loss (12-(13+14))</td>
                <?
                $OperatingProfitLoss=$Gross_Profit-($summary_data['comm_cost']+$summary_data['common_oh']);
                $OperatingProfitLoss_job=$Gross_Profit_job-($summary_data['comm_cost_job']+$summary_data['common_oh_job']);
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($OperatingProfitLoss,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($OperatingProfitLoss_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($OperatingProfitLoss_job/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">16</td>
                <td style=" padding-left:15px">Less: Depreciation & Amortization </td>

                <td align="right"> <? echo fn_number_format( $summary_data['depr_amor_pre_cost'],4); ?></td>
                <td align="right"><? echo fn_number_format( $summary_data['depr_amor_pre_cost_job'],4); ?></td>
                <td align="right"><? echo fn_number_format(($summary_data['depr_amor_pre_cost_job']/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
				<?
                $pre_costing_date=change_date_format($costing_date,'','',1);
				if($financial_para[$pre_costing_date]['interest_expense']>0){
					$interest_expense=$NetFOBValue*$financial_para[$pre_costing_date]['interest_expense']/100;
					$interest_expense_job=$NetFOBValue_job*$financial_para[$pre_costing_date]['interest_expense']/100;
				}
				else{
					$interest_expense=$summary_data['interest_cost'];
					$interest_expense_job=$summary_data['interest_cost_job'];
				}
				if($financial_para[$pre_costing_date]['income_tax']>0){
					$income_tax=$NetFOBValue*$financial_para[$pre_costing_date]['income_tax']/100;
                	$income_tax_job=$NetFOBValue_job*$financial_para[$pre_costing_date]['income_tax']/100;
				}
				else{
					$income_tax=$summary_data['incometax_cost'];
                	$income_tax_job=$summary_data['incometax_cost_job'];
				}
                ?>
                <td align="center">17</td>
                <td style=" padding-left:15px">Less: Interest </td>

                <td align="right"> <? echo fn_number_format( $interest_expense,4); ?></td>
                <td align="right"><? echo fn_number_format( $interest_expense_job,4); ?></td>
                <td align="right"><? echo fn_number_format(($interest_expense_job/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">18</td>
                <td style=" padding-left:15px">Less: Income Tax</td>

                <td align="right"> <? echo fn_number_format( $income_tax,4); ?></td>
                <td align="right"><? echo fn_number_format( $income_tax_job,4); ?></td>
                <td align="right"><? echo fn_number_format(($income_tax_job/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
            <tr>
				<?
                $Netprofit=$OperatingProfitLoss-($summary_data['depr_amor_pre_cost']+$interest_expense+$income_tax);
                $Netprofit_job=$OperatingProfitLoss_job-($summary_data['depr_amor_pre_cost_job']+$interest_expense_job+$income_tax_job);
                ?>
                <td align="center">19</td>
                <td style="font-weight:bold">Net Profit/Loss (15-(16+17+18))</td>

                <td align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit,4); ?> </td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Netprofit_job/$summary_data['price_dzn_job'])*100,4);?></td>
            </tr>
        </table>
    </div>
    <?
	//End all summary report here -------------------------------------------
	//2	All Fabric Cost part here-------------------------------------------
	$sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, uom, avg_cons, avg_cons_yarn, fabric_source, gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."  and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);

	$knit_fab=""; $woven_fab="";
	$knit_subtotal_avg_cons=0; $knit_subtotal_amount=0; $woven_subtotal_avg_cons=0; $woven_subtotal_amount=0;
	$grand_total_amount=0;

	$i=1; $j=1;
	foreach( $data_array as $row )
	{
		$uom=$unit_of_measurement[$row[csf("uom")]];
		$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];

		if($row[csf("fab_nature_id")]==2){//knit fabrics
			$i++;
			$totalConsKnit=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$totalAmountKnit=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$amount=$row[csf("avg_cons")]*$row[csf("rate")];

			$knit_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
				<td align="right">'.fn_number_format($totalConsKnit,4).'</td>
				<td align="left">'.$uom.'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,4).'</td>
				<td align="right">'.fn_number_format($totalAmountKnit,4).'</td>
			</tr>';
			if($row[csf("uom")]==1){
				$DznConsKnitSubTotalPcs += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalPcs += $totalConsKnit;
				$DznAmountKnitSubTotalPcs+=$amount;
				$TotalAmountKnitSubTotalPcs+=$totalAmountKnit;
			 }
			 if($row[csf("uom")]==12){
				$DznConsKnitSubTotalKg += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalKg += $totalConsKnit;
				$DznAmountKnitSubTotalKg+=$amount;
				$TotalAmountKnitSubTotalKg+=$totalAmountKnit;
			 }
			 if($row[csf("uom")]==23){
				$DznConsKnitSubTotalMtr += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalMtr += $totalConsKnit;
				$DznAmountKnitSubTotalMtr+=$amount;
				$TotalAmountKnitSubTotalMtr+=$totalAmountKnit;
			 }
			 if($row[csf("uom")]==27){
				$DznConsKnitSubTotalYds += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalYds += $totalConsKnit;
				$DznAmountKnitSubTotalYds+=$amount;
				$TotalAmountKnitSubTotalYds+=$totalAmountKnit;
			 }
			 $GrandtotalDznAmount+=$amount;
			 $GrandtotalAmount+=$totalAmountKnit;

			 $GrandTotalFabricDznAmount+=$amount;
			 $GrandTotalFabricAmount+=$totalAmountKnit;
		}

		if($row[csf("fab_nature_id")]==3){//woven fabrics
			$j++;
			$totalConsWoven=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$totalAmountWoven=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			$woven_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
				<td align="right">'.fn_number_format($totalConsWoven,4).'</td>
				<td align="left">'.$uom.'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,4).'</td>
				<td align="right">'.fn_number_format($totalAmountWoven,4).'</td>
			</tr>';

			if($row[csf("uom")]==1){
				$DznConsWovenSubTotalPcs += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalPcs += $totalConsWoven;
				$DznAmountWovenSubTotalPcs+=$amount;
				$TotalAmountWovenSubTotalPcs+=$totalAmountWoven;
			 }
			 if($row[csf("uom")]==12){
				$DznConsWovenSubTotalKg += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalKg += $totalConsWoven;
				$DznAmountWovenSubTotalKg+=$amount;
				$TotalAmountWovenSubTotalKg+=$totalAmountWoven;
			 }
			 if($row[csf("uom")]==23){
				$DznConsWovenSubTotalMtr += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalMtr += $totalConsWoven;
				$DznAmountWovenSubTotalMtr+=$amount;
				$TotalAmountWovenSubTotalMtr+=$totalAmountWoven;
			 }
			 if($row[csf("uom")]==27){
				$DznConsWovenSubTotalYds += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalYds += $totalConsWoven;
				$DznAmountWovenSubTotalYds+=$amount;
				$TotalAmountWovenSubTotalYds+=$totalAmountWoven;
			 }
			 $GrandtotalDznAmount+=$amount;
			 $GrandtotalAmount+=$totalAmountWoven;

			 $GrandTotalFabricDznAmount+=$amount;
			 $GrandTotalFabricAmount+=$totalAmountWoven;
		}
	}

	if($DznConsKnitSubTotalPcs>0) $i++;
	if($DznConsKnitSubTotalKg>0) $i++;
	if($DznConsKnitSubTotalMtr>0) $i++;
	if($DznConsKnitSubTotalYds>0) $i++;
	if($DznConsWovenSubTotalPcs>0) $j++;
	if($DznConsWovenSubTotalKg>0) $j++;
	if($DznConsWovenSubTotalMtr>0) $j++;
	if($DznConsWovenSubTotalYds>0) $j++;

	$knit_fab= '<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>All Fabric Cost  </b></label>
					<tr style="font-weight:bold"  align="center">
						<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
						<td width="350">Description</td>
						<td width="100">Source</td>
						<td width="100">Fab. Cons/'.$costing_for.'</td>
						<td width="100">Total Cons</td>
						<td width="100">UOM</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)/'.$costing_for.'</td>
						<td width="100">Tot.Amount (USD)</td>
					</tr>'.$knit_fab;
	if($DznConsWovenSubTotalPcs>0 || $DznConsWovenSubTotalKg>0 || $DznConsWovenSubTotalMtr>0 || $DznConsWovenSubTotalYds>0){
		$woven_fab= '<tr><td colspan="9">&nbsp;</td></tr><tr>
					<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
	}

	//knit fabrics table here
	if($DznConsKnitSubTotalPcs>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Pcs)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalPcs,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalPcs,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalPcs,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalPcs,4).'</td>
					</tr>';
	}
	if($DznConsKnitSubTotalKg>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Kg)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalKg,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalKg,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalKg,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalKg,4).'</td>
					</tr>';
	}
	if($DznConsKnitSubTotalMtr>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Mtr)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalMtr,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalMtr,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalMtr,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalMtr,4).'</td>
					</tr>';
	}
	if($DznConsKnitSubTotalYds>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Yds)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalYds,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalYds,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalYds,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalYds,4).'</td>
					</tr>';
	}

	if($zero_value==1) echo $knit_fab;
	else
	{
		if($row[csf("avg_cons")]>0) echo $knit_fab; else echo "";
	}

	//woven fabrics table here
	if($DznConsWovenSubTotalPcs>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Pcs)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalPcs,4).'</td>
					<td align="right">'.fn_number_format($TotalConsWovenSubTotalPcs,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalPcs,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalPcs,4).'</td>
				</tr>';
	}
	if($DznConsWovenSubTotalKg>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Kg)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalKg,4).'</td>
					<td align="right">'.fn_number_format($TotalConsWovenSubTotalKg,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalKg,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalKg,4).'</td>
				</tr>';
	}
	if($DznConsWovenSubTotalMtr>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Mtr)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalMtr,4).'</td>
					<td align="right">'.fn_number_format($TotalConsWovenSubTotalMtr,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalMtr,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalMtr,4).'</td>
				</tr>';
	}
	if($DznConsWovenSubTotalYds>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Yds)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalYds,4).'</td>
					<td align="right">'.fn_number_format($TotalConsWovenSubTotalYds,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalYds,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalYds,4).'</td>
				</tr>';
	}

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="4" align="left">Total</td>
					<td align="right"></td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format(($GrandtotalDznAmount),4).'</td>
					<td align="right">'.fn_number_format(($GrandtotalAmount),4).'</td>
				</tr></table></div>';
	if($zero_value==1) echo $woven_fab;
	else{
			if($row[csf("avg_cons")]>0) echo $woven_fab; else echo "";
	}
	//end 	All Fabric Cost part report-------------------------------------------

	//Start	Yarn Cost part report here -------------------------------------------
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<tr style="font-weight:bold">
					<td width="70" rowspan="<? echo count($YarnData)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
					<td width="350">Yarn Desc</td>
					<td width="100">Yarn Qty</td>
					<td width="100">Total Qty</td>
					<td width="100">Rate (USD)</td>
					<td width="100">Amount (USD)</td>
					<td width="100">Tot.Amount (USD)</td>
				</tr>
			<?
			$TotalDznQty = 0; $TotalQty = 0; $TotalDznAmount = 0; $TotalAmount = 0;
			foreach( $YarnData as $index=>$row )
			{
				$des=explode("_",str_replace("'","",$index));
				$item_descrition = $lib_yarn_count[$des[0]]." ".$composition[$des[1]]." ".$des[2]."% ".$color_library[$des[4]]." ".$yarn_type[$des[3]];
				?>
				<tr>
					<td align="left"><? echo $item_descrition; ?></td>
					<td align="right"><? echo fn_number_format($row["dznqty"],4); ?></td>
					<td align="right"><? echo fn_number_format($row["qty"],4); ?></td>
					<td align="right"><? echo fn_number_format($des[5],4); ?></td>
					<td align="right"><? echo fn_number_format($row["dznamount"],4); ?></td>
					<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
				</tr>
				<?
				 $TotalDznQty += $row["dznqty"];
				 $TotalQty += $row["qty"];
				 $TotalDznAmount += $row["dznamount"];
				 $TotalAmount += $row["amount"];

				 $GrandTotalFabricDznAmount+=$row["dznamount"];
				 $GrandTotalFabricAmount+=$row["amount"];
			}
		  ?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td align="left">Total</td>
					<td align="right"><? echo fn_number_format($TotalDznQty,4); ?></td>
					<td align="right"><? echo fn_number_format($TotalQty,4); ?></td>
					<td></td>
					<td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
					<td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
				</tr>
			</table>
	  </div>
	  <?
  }
	else
	{
	  if($totYarn>0)
	  {
		  ?>
		   <div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<tr style="font-weight:bold">
					<td width="70" rowspan="<? echo count($YarnData)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
					<td width="350">Yarn Desc</td>
					<td width="100">Yarn Qty</td>
					<td width="100">Avg.Yarn Qty</td>
					<td width="100">Rate (USD)</td>
					<td width="100">Amount (USD)</td>
					<td width="100">Tot.Amount (USD)</td>
				</tr>
			<?
			$TotalDznQty = 0; $TotalQty = 0; $TotalDznAmount = 0; $TotalAmount = 0;
			foreach( $YarnData as $index=>$row )
			{
				$des=explode("_",str_replace("'","",$index));
				$item_descrition = $lib_yarn_count[$des[0]]." ".$composition[$des[1]]." ".$des[2]."% ".$color_library[$des[4]]." ".$yarn_type[$des[3]];
				?>
				<tr>
					<td align="left"><? echo $item_descrition; ?></td>
					<td align="right"><? echo fn_number_format($row["dznqty"],4); ?></td>
					<td align="right"><? echo fn_number_format($row["qty"],4); ?></td>
					<td align="right"><? echo fn_number_format($des[5],4); ?></td>
					<td align="right"><? echo fn_number_format($row["dznamount"],4); ?></td>
					<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
				</tr>
				<?
				 $TotalDznQty += $row["dznqty"];
				 $TotalQty += $row["qty"];
				 $TotalDznAmount += $row["dznamount"];
				 $TotalAmount += $row["amount"];

				 $GrandTotalFabricDznAmount+=$row["dznamount"];
				 $GrandTotalFabricAmount+=$row["amount"];
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td align="left">Total</td>
					<td align="right"><? echo fn_number_format($TotalDznQty,4); ?></td>
					 <td align="right"><? echo fn_number_format($TotalQty,4); ?></td>
					<td></td>
					<td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
					<td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
				</tr>
			</table>
		</div>
		<?
	  }
	  else echo "";
	}
	//End Yarn Cost part report here -------------------------------------------

  	//start	Conversion Cost to Fabric report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Total Cons</td>
                    <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Total Amount (USD)</td>
                </tr>
				<?
                $TotalDznAmount =0; $TotalAmount =0;
                foreach( $ConvData as $index=>$row )
                {
                    ?>
                    <tr>
                        <td align="left"><? echo $row['item_descrition']; ?></td>
                        <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
                        <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                    </tr>
                    <?
                     $TotalDznAmount += $row["amount"];
                     $TotalAmount += $row["tot_amount"];

                     $GrandTotalFabricDznAmount+=$row["amount"];
                     $GrandTotalFabricAmount+=$row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td  align="left" colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totConv>0)
		{
			?>
			 <div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                    <tr style="font-weight:bold">
                        <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                        <td width="350">Particulars</td>
                        <td width="100">Process</td>
                        <td width="100">Cons/<? echo $costing_for; ?></td>
                        <td width="100">Total Cons</td>
                         <td width="100">Uom</td>
                        <td width="100">Rate (USD)</td>
                        <td width="100">Amount (USD)</td>
                         <td width="100">Total Amount (USD)</td>
                    </tr>
					<?
				    $TotalDznAmount =0; $TotalAmount =0;
					foreach( $ConvData as $index=>$row)
					{
						?>
						<tr>
							<td align="left"><? echo $row['item_descrition']; ?></td>
							<td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
							<td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
						<?
						 $TotalDznAmount += $row["amount"];
						 $TotalAmount += $row["tot_amount"];

						 $GrandTotalFabricDznAmount+=$row["amount"];
						 $GrandTotalFabricAmount+=$row["tot_amount"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total</td>
                        <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                        <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                    </tr>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total Fabric Cost</td>
                        <td align="right"><? echo fn_number_format($GrandTotalFabricDznAmount,4); ?></td>
                        <td align="right"><? echo fn_number_format($GrandTotalFabricAmount,4); ?></td>
                    </tr>
                </table>
			  </div>
			  <?
		}
		else echo "";
	}
	//End Conversion Cost to Fabric report here -------------------------------------------
  	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group where status_active=1", "id", "item_name"  );
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
				<?
                $TotalDznAmount=0; $TotalAmount=0;
                foreach( $TrimData as $index=>$row )
                {
                    ?>
                        <tr>
                            <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                            <td align="left"><? echo $row["description"]; ?></td>
                            <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                            <td align="left"><? echo $row["remark"]; ?></td>
                            <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                            <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                        </tr>
                    <?
                     $TotalDznAmount += $row["amount"];
                     $TotalAmount += $row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totTrim>0)
		{
			?>
			<div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                    <tr style="font-weight:bold">
                        <td width="150">Item Group</td>
                        <td width="150">Description</td>
                        <td width="150">Brand/Supp Ref</td>
                        <td width="150">Remarks</td>
                        <td width="100">UOM</td>
                        <td width="100">Cons/<? echo $costing_for; ?></td>
                        <td width="100">Tot. Cons</td>
                        <td width="100">Rate (USD)</td>
                        <td width="100">Amount (USD)</td>
                        <td width="100">Tot. Amount</td>
                    </tr>
					<?
					$TotalDznAmount=0; $TotalAmount=0;
					foreach( $TrimData as $index=>$row)
					{
						?>
							<tr>
								<td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
								<td align="left"><? echo $row["description"]; ?></td>
								<td align="left"><? echo $row["brand_sup_ref"]; ?></td>
								<td align="left"><? echo $row["remark"]; ?></td>
								<td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
								<td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
							</tr>
						<?
						 $TotalDznAmount += $row["amount"];
						 $TotalAmount += $row["tot_amount"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="8" align="left">Total</td>
                        <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                        <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                    </tr>
                </table>
            </div>
            <?
		}
		else echo "";
	}
	//End Trims Cost Part report here -------------------------------------------
	//start	Embellishment Details part report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="
			1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
				<?
                $TotalDznAmount=0; $TotalAmount =0;
                foreach( $EmbData as $index=>$row )
                {
                    $em_type ="";
                    //$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
                    if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
                    else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
                    else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
                    else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
                    else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
					?>
						<tr>
							<td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
							<td align="left"><? echo $em_type; ?></td>
							<td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
					<?
                     $TotalDznAmount += $row["amount"];
                     $TotalAmount += $row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totEmb>0)
		{
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Embellishment Details</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Type</td>
						<td width="150">Cons/<? echo $costing_for; ?></td>
						<td width="150">Tot.Cons/<? echo $costing_for; ?></td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					 </tr>
					<?
                    $TotalDznAmount=0; $TotalAmount =0;
                    foreach( $EmbData as $index=>$row  )
                    {
                        $em_type ="";
                        //$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
                        if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
                        else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
                        else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
                        else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
                        else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
                        ?>
                            <tr>
                                <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                                <td align="left"><? echo $em_type; ?></td>
                                <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                            </tr>
                        <?
                         $TotalDznAmount += $row["amount"];
                         $TotalAmount += $row["tot_amount"];
                    }
                    ?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="5" align="left">Total</td>
						<td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
			</div>
			<?
		}
		else echo "";
	}
	//End Embellishment Details Part report here -------------------------------------------

  	//start	Commercial Cost part report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
				<?
                $TotalDznAount=0; $TotalAount =0;
                foreach( $CommarData as $index=>$row )
                {
					?>
						<tr>
							<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
					<?
                     $TotalDznAount += $row["amount"];
                     $TotalAount += $row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totCommar>0)
		{
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commercial Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot.Amount</td>
					 </tr>
					<?
                    $TotalDznAount=0; $TotalAount =0;
                    foreach( $CommarData as $index=>$row  )
                    {
						?>
							<tr>
								<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
								<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
							</tr>
						<?
                         $TotalDznAount += $row["amount"];
                         $TotalAount += $row["tot_amount"];
                    }
                    ?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Total</td>
						<td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
					</tr>
				</table>
            </div>
            <?
		}
		else echo "";
	}
	//End Commercial Cost Part report here -------------------------------------------
  	//start	Commission Cost part report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
				<?
                $TotalDznAount = 0; $TotalAount = 0;
                foreach( $CommiData as $index=>$row )
                {
					?>
						<tr>
							<td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
							<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
						</tr>
					<?
                     $TotalDznAount += $row["commission_amount"];
                     $TotalAount += $row["tot_commission_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAount = 0; $TotalAount = 0;
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commission Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Commission Basis</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					 </tr>
				<?
				$total_amount=0;
				foreach( $CommiData as $index=>$row )
				{
					?>
						<tr>
						   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
							<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
						</tr>
					<?
					 $TotalDznAount += $row["commission_amount"];
					 $TotalAount += $row["tot_commission_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3" align="left">Total</td>
						<td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
					</tr>
				</table>
            </div>
            <?
		}
		else echo "";
	}
	//End Commission Cost Part report here -------------------------------------------
	?>
    <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:300px;" rules="all">
        <label><b>CM Details</b></label>
        <tr>
            <td width="150">CPM [TK]</td>
            <td width="150"><? echo fn_number_format($financial_para[$cm_cost_based_on_date][cost_per_minute],4); ?></td>
        </tr>
        <tr>
            <td width="150">CPM [USD]</td>
            <td width="150"><? echo fn_number_format($financial_para[$cm_cost_based_on_date][cost_per_minute]/$exchange_rate,4); ?></td>
        </tr>
        <tr>
            <td>SMV</td>
             <td title="Sew and Cut Smv"><?
			 if($sew_smv>0 && $cut_smv>0) echo fn_number_format($sew_smv,4).','.fn_number_format($cut_smv,4);
			 else if($sew_smv>0 && $cut_smv==0) echo   fn_number_format($sew_smv,4);
			 else if($sew_smv==0 && $cut_smv>0) echo   fn_number_format($cut_smv,4);
			 else echo ""; ?></td>
        </tr>
        <tr>
            <td>EFF %</td>
            <td title="Sew and Cut Smv %">
			<?  if($sew_effi_percent>0 && $cut_effi_percent>0) echo fn_number_format($sew_effi_percent,4).','.fn_number_format($cut_effi_percent,4);
			 else if($sew_effi_percent>0 && $cut_effi_percent==0) echo   fn_number_format($sew_effi_percent,4);
			 else if($sew_effi_percent==0 && $cut_effi_percent>0) echo   fn_number_format($cut_effi_percent,4);
			 else echo ""; ?>
            </td>
        </tr>
    </table>

	<? if($show_yarn==1){
		$yarn_purchase=sql_select("SELECT a.requ_no,a.id from inv_purchase_requisition_mst a join inv_purchase_requisition_dtls b on a.id=b.mst_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no=".$txt_job_no." and a.entry_form=70 group by a.requ_no,a.id order by a.id");
		$yarn_purchase_arr=array();
		foreach($yarn_purchase as $row){
			$yarn_purchase_arr[$row[csf('requ_no')]]=$row[csf('requ_no')];
		}

		$booking_data=sql_select("SELECT a.booking_no,a.id from wo_booking_mst a join wo_booking_dtls b on a.booking_no=b.booking_no where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_type=1 and a.is_short=2 and a.job_no=".$txt_job_no." group by a.booking_no,a.id order by a.id");
		$booking_dtls_arr=array();
		foreach($booking_data as $row){
			$booking_dtls_arr[$row[csf('booking_no')]]=$row[csf('booking_no')];
		}
		unset($booking_data);
		?>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:500px; margin-top:10px" rules="all">
        <tr>
            <td width="200">Yarn Purchase Requisition NO.</td>
            <td width="300"><?= implode(", ", $yarn_purchase_arr) ?></td>
        </tr>
        <tr>
            <td>Fabric Booking NO.</td>
            <td><?= implode(", ", $booking_dtls_arr) ?></td>
        </tr>
    </table>
	<? } ?>
	<br/>
	<?
    // image show here  -------------------------------------------
    $sqlData = "select id, master_tble_id, image_location from common_photo_library where master_tble_id=".$txt_job_no."";
    $data_array_img=sql_select($sqlData);
    ?>
    <div style=" margin-left:10px;" >
		<? foreach($data_array_img AS $inf){ ?>
        	<img  src='../../<? echo $inf[csf("image_location")]; ?>' border="1" height='97' width='89' />
        <?  } ?>
    </div>
    <br/>

    <?
	if($quotation_id!=0 && $quotation_id!="")
	{
		$cost_control_source=return_field_value("cost_control_source","variable_order_tracking","company_name=$cbo_company_name and variable_list=53","cost_control_source");
		if($cost_control_source==1)
		{
			$lib_temp_arr=return_library_array("select id, item_name from lib_qc_template","id","item_name");
			?>
			<table width="850" cellspacing="0" border="1" rules="all" class="rpt_table">
				<thead style="font-size:11px">
					<tr>
						<th colspan="17" align="center">Budget as Per Quick Costing: </th>
					</tr>
					<tr>
						<th width="60">Item</th>
						<th width="45">Fab. Cons. Kg</th>
						<th width="45">Fab. Cons. Mtr</th>
						<th width="45">Fab. Cons. Yds</th>
						<th width="50">Fab. Amount</th>
						<th width="50">Special Opera.</th>
						<th width="50">Access.</th>
						<th width="45">Frieght Cost</th>
						<th width="45">Lab - Test</th>
						<th width="45">Misce.</th>
						<th width="45">Other Cost</th>
						<th width="45">Commis.</th>
						<th width="50">FOB ($/DZN)</th>
						<th width="45" title="((CPM*100)/Efficiency)">CPPM</th>
						<th width="45">SMV</th>
						<th width="45">CM</th>
						<th>RMG Qty(Pcs)</th>
					</tr>
				</thead>
			<?
			$sql_confirm_dtls=sql_select("select id, mst_id, cost_sheet_id, item_id, fab_cons_kg, fab_cons_mtr, fab_cons_yds, fab_amount, sp_oparation_amount, acc_amount, fright_amount, lab_amount, misce_amount, other_amount, comm_amount, fob_amount, cppm_amount, smv_amount, cm_amount, rmg_ratio from qc_confirm_dtls where cost_sheet_id='$quotation_id'");
			$i=1;
			foreach($sql_confirm_dtls as $row_dtls)
			{
				?>
				<tr style="font-size:11px">
					<td width="60"><? echo $lib_temp_arr[$row_dtls[csf("item_id")]]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fab_cons_kg")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fab_cons_mtr")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fab_cons_yds")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("fab_amount")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("sp_oparation_amount")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("acc_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fright_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("lab_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("misce_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("other_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("comm_amount")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("fob_amount")]; ?></td>
					<td width="45"  align="right"><? echo $row_dtls[csf("cppm_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("smv_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("cm_amount")]; ?></td>
					<td align="right"><? echo $row_dtls[csf("rmg_ratio")]; ?></td>
				</tr>
				<?
			}
			?>
			</table>
			<?
		}
	}
	$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	$user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");

 
	$approve_data_array=sql_select("select b.approved_by, b.APPROVED_DATE as approved_date,APPROVED,COMMENTS from  APPROVAL_MST b where b.mst_id=$mst_id and b.entry_form in (15,77) order by  b.id ");
	$app_status_arr = array(0 => 'Unapproved',1 => 'Full Approved',2 => 'Denay',3 => 'Partial Approved');
	if(count($approve_data_array)>0)
	{
		?>
		<table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
                <tr style="border:1px solid black;">
                	<th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                    <th width="3%" style="border:1px solid black;">Sl</th>
                    <th width="25%" style="border:1px solid black;">Name</th>
                    <th width="25%" style="border:1px solid black;">Designation</th>
                    <th width="25%" style="border:1px solid black;">Approval Date</th>
                    <th width="22%" style="border:1px solid black;">Approval Status</th>
                </tr>
            </thead>
            <tbody>
            <?
            $i=1;

			foreach($approve_data_array as $row)
			{
				?>
				<tr style="border:1px solid black;">
				<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="25%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="25%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="25%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>
				<td width="22%"><?= $app_status_arr[$row['APPROVED']];?>
				</tr>
				<?
				$i++;
            }
            ?>
            </tbody>
		</table>
		<?
	}
	?>
    <br/>
	<?

	$approve_his_data_array=sql_select("select b.approved_by, b.approved_date as approved_date,APPROVED,COMMENTS from  approval_history b where b.mst_id=$mst_id and b.entry_form in (15,77) order by  b.id ");


	if(count($approve_his_data_array)>0)
	{
		?>
		<table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
                <tr style="border:1px solid black;">
                	<th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                    <th width="3%" style="border:1px solid black;">Sl</th>
                    <th width="30%" style="border:1px solid black;">Name</th>
                    <th width="20%" style="border:1px solid black;">Designation</th>
                    <th width="5%" style="border:1px solid black;">Approval Status</th>
                    <th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                    <th width="22%" style="border:1px solid black;"> Date</th>
                </tr>
            </thead>
            <tbody>
				<?
                $i=1;
				//$appStatusArr = [0=>"Unapproved",1=>"approved",2=>"Deny",3=>"Partial Approved"];
                foreach($approve_his_data_array as $row)
				{

					?>
					<tr style="border:1px solid black;">
                        <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                        <td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                        <td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                        <td width="5%" style="border:1px solid black; text-align:center"><?= $app_status_arr[$row['APPROVED']];?></td>
                        <td width="20%" style="border:1px solid black;"><?= $row['COMMENTS'];?></td>
                        <td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
					</tr>
					<?
				$i++;	
                }
                ?>
            </tbody>
		</table>

		<?
	}
	?>
		<br>
	    <table width="780" align="center">
                <tr>
                <div style="text-align:center;font-size:xx-large; font-style:italic; margin-top:20px; color:#FF0000;">
						<?
						if(count($approval_arr)>0)
						{
							if($approved == 2 || $approved == 0){echo "Draft";}else{}
						}
						?>
                </div>
                </tr>
        </table>
	<?
    // echo signature_table(109, $cbo_company_name, "860px",'','',$inserted_by);
	 $cbo_company_name=str_replace("'","",$cbo_company_name);

	 $path=($path!='')?$path:"../../";
	 $job_info=sql_select("SELECT id, inserted_by from wo_pre_cost_mst where status_active=1 and is_deleted=0 and job_no='".str_replace("'","",$txt_job_no)."'");
	 foreach ($job_info as $row) {
		 $inserted_by=$row[csf('inserted_by')];
		 $job_id=$row[csf('id')];
	 }

	$signature_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='user_signature'",'master_tble_id','image_location');
	//print_r($signature_arr);
	 $appSql="select approved_by from approval_history where entry_form=15 and mst_id = $job_id";
	 $appSqlRes=sql_select($appSql);
	 foreach($appSqlRes as $row){
		 $userSignatureArr[$row[csf('approved_by')]]=$path.$signature_arr[$row[csf('approved_by')]];
	 }
	 $userSignatureArr[$inserted_by]=$path.$signature_arr[$inserted_by];
	 $width="860px";
	 $report_id=109;
	 $padding_top = 50;
	 $prepared_by=$inserted_by;
	if ($cbo_template_id != '') {
		$template_id = " and template_id=$cbo_template_id ";
	}
	$sql = sql_select("select USER_ID,designation,name,activities,prepared_by from variable_settings_signature where report_id=$report_id and company_id=$cbo_company_name   and status_active=1 $template_id order by sequence_no ");
	$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	if($sql[0][csf("prepared_by")]==1){
		list($prepared_by,$activities)=explode('**',$prepared_by);
		$sql_2[100] = array ( USER_ID=>$prepared_by,DESIGNATION => 'Prepared By' ,NAME => ($user_lib_name[$prepared_by])?$user_lib_name[$prepared_by]:$prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
		$sql=$sql_2+$sql;
	}
	$count = count($sql);
	$td_width = floor($width / $count);
	$standard_width = $count * 250;
	if ($standard_width > $width) {
		$td_width = 250;
	}
	$no_coloumn_per_tr = floor($width / $td_width);
	$i = 1;
	if ($count == 0) {$message = "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
	echo '<table cellspacing="5" id="signatureTblId" width="' . $width . '" style="padding-top:' . $padding_top . 'px;"><tr><td width="100%" height="' . $padding_top . '" colspan="' . $count . '">' . $message . '</td></tr>';
	$flag=0;
	foreach ($sql as $row) {
		$flag++;
		$sigHtml='';
		if($userSignatureArr[$row['USER_ID']]){$sigHtml='<img src="'.$userSignatureArr[$row['USER_ID']].'" height="60" width="180">';}
		else{$sigHtml='<div height="40"></div>';}
		if($flag==1){echo "<tr>";}
		echo '<td width="' . $td_width . '" align="center" valign="top">
		<p style="min-height:40px;">'.$sigHtml.'</p>
		<strong>' . $row[csf("activities")] . '</strong><br>
		<strong style="text-decoration:overline;">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
		if($flag==$break_tr || $count==$i){echo "</tr>";$flag=0;}
		$i++;
	}
	echo '</table>';


	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send)=explode('**',$mail_data);
	if($is_mail_send==1){

		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');

		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody);
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}


		$sql = "SELECT a.BRAND_IDS,a.BUYER_IDS,c.email_address as MAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id  and a.mail_item=b.MAIL_ITEM_MST and a.mail_item=89 and b.mail_user_setup_id=c.id and a.company_id =".$cbo_company_name."  and   A.IS_DELETED=0 and A.STATUS_ACTIVE=1  and b.IS_DELETED=0 and b.STATUS_ACTIVE=1  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		$mail_sql=sql_select($sql);
		$receverMailArr=array();
		foreach($mail_sql as $row)
		{
			$mailToArr[]=$row[MAIL];
		}

		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.entry_form=15 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";

		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){

			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows[USER_EMAIL]!='' && $bi==$buyer_name_id){$mailToArr[]=$rows[USER_EMAIL];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows[USER_EMAIL]){$mailToArr[]=$rows[USER_EMAIL];}
				if($rows[BYPASS]==2){break;}
			}

		}


		$to=implode(',',array_unique($mailToArr));
		//echo $to;die;


 /*		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
 */
		$subject="Pre Cost Entry Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );

	}

	//------------------------------------End;


	exit();
}



if($action=="preCostRpt3")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($db_type==0)
	{
		$costing_date=change_date_format(str_replace("'","",$txt_costing_date), "yyyy-mm-dd", "-");
		$limit_cond="LIMIT 1";
		$group_gsm="group_concat( distinct b.gsm_weight)";
	}
	else if($db_type==2)
	{
		$costing_date=change_date_format(str_replace("'","",$txt_costing_date), "yyyy-mm-dd", "-",1);
		$limit_cond="";
		$group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight)";
	}

	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	$cpm_based_sql=sql_select( "select cm_cost_method_based_on from variable_order_tracking where variable_list=22 and company_name=$cbo_company_name");
	$cpm_based_on=0;
	foreach($cpm_based_sql as $row)
	{
		$cpm_based_on=$row[csf('cm_cost_method_based_on')];
	}
	unset($cpm_based_sql);
	//echo $cpm_based_on;

	$cpmdate=sql_select("select min(pub_shipment_date) as min_pub_shipment_date, max(pub_shipment_date) as max_pub_shipment_date, min(shipment_date) as min_shipment_date, max(shipment_date) as max_shipment_date from  wo_po_break_down where job_no_mst=".$txt_job_no." and is_deleted=0 and status_active=1");
	$min_pub_shipment_date="";
	$max_pub_shipment_date="";
	$min_shipment_date="";
	$max_shipment_date="";
	foreach($cpmdate as $row){
		$min_pub_shipment_date=$row[csf('min_pub_shipment_date')];
		$max_pub_shipment_date=$row[csf('max_pub_shipment_date')];
		$min_shipment_date=$row[csf('min_shipment_date')];
		$max_shipment_date=$row[csf('max_shipment_date')];
	}
	unset($cpmdate);

	$cpm_date_cond="";
	if($cpm_based_on==2) $cpm_date_cond=$min_shipment_date;
	else if($cpm_based_on==3) $cpm_date_cond=$max_shipment_date;
	else if($cpm_based_on==4) $cpm_date_cond=$min_pub_shipment_date;
	else if($cpm_based_on==5) $cpm_date_cond=$max_pub_shipment_date;
	else $cpm_date_cond=$costing_date;

	//echo "select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$cpm_date_cond' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0 $limit_cond"; die;

	$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$cpm_date_cond' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0 $limit_cond");

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}
	unset($sqlcpm);

	$po_qty=0; $po_plun_cut_qty=0;
	$sql_po="select a.job_no, a.buyer_name, a.gmts_item_id, a.style_ref_no, a.total_set_qnty, a.set_smv, a.company_name, a.order_uom, a.job_quantity, a.avg_unit_price, b.id, b.po_number, b.pub_shipment_date, c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty

	from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c

	where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and a.job_no =".$txt_job_no." and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po); $job_data_arr=array(); $po_data_arr=array(); $uom=0;
	foreach($sql_po_data as $jrow)
	{
		$job_data_arr[$jrow[csf('job_no')]]['jdata']=$jrow[csf('buyer_name')].'___'.$jrow[csf('gmts_item_id')].'___'.$jrow[csf('style_ref_no')].'___'.$jrow[csf('total_set_qnty')].'___'.$jrow[csf('set_smv')].'___'.$jrow[csf('company_name')].'___'.$jrow[csf('order_uom')].'___'.$jrow[csf('job_quantity')].'___'.$jrow[csf('avg_unit_price')];

		$po_data_arr[$jrow[csf('job_no')]][$jrow[csf('id')]]['pdata']=$jrow[csf('po_number')].'___'.$jrow[csf('pub_shipment_date')];

		$po_qty+=$jrow[csf('order_quantity')];
		$po_plun_cut_qty+=$jrow[csf('plan_cut_qnty')];
		$uom=$jrow[csf('order_uom')];
	}
	unset($sql_po_data);

	$mst_sql = "select a.job_no, a.costing_date, a.costing_per, a.budget_minute, a.approved, a.sew_smv, a.sew_effi_percent, a.exchange_rate, a.inserted_by, a.incoterm, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_pre_cost_mst a left join wo_pre_cost_sum_dtls c on a.job_no=c.job_no where a.status_active=1 and a.job_no=".$txt_job_no."";

	$mst_sql_res=sql_select($mst_sql); $pre_mst_arr=array();
	foreach($mst_sql_res as $mrow)
	{
		$pre_mst_arr[$mrow[csf('job_no')]]['mdata']=$mrow[csf('costing_date')].'___'.$mrow[csf('costing_per')].'___'.$mrow[csf('budget_minute')].'___'.$mrow[csf('approved')].'___'.$mrow[csf('sew_effi_percent')].'___'.$mrow[csf('inserted_by')].'___'.$mrow[csf('sew_smv')].'___'.$mrow[csf('exchange_rate')].'___'.$mrow[csf('incoterm')];
		$pre_mst_arr[$mrow[csf('job_no')]]['knit_req_kg']+=$mrow[csf('fab_knit_req_kg')];
		$pre_mst_arr[$mrow[csf('job_no')]]['fin_req_kg']+=$mrow[csf('fab_knit_fin_req_kg')];
		$pre_mst_arr[$mrow[csf('job_no')]]['woven_req_yds']+=$mrow[csf('fab_woven_req_yds')];
		$pre_mst_arr[$mrow[csf('job_no')]]['woven_fin_req_yds']+=$mrow[csf('fab_woven_fin_req_yds')];
		$pre_mst_arr[$mrow[csf('job_no')]]['yarn_req_kg']+=$mrow[csf('fab_yarn_req_kg')];
	}
	unset($mst_sql_res);

	$job_no=str_replace("'","",$txt_job_no);

	$exjob_data=explode("___",$job_data_arr[$job_no]['jdata']);

	$buyer_id=$exjob_data[0];
	$gmts_item_id=$exjob_data[1];
	$style_ref_no=$exjob_data[2];
	$total_set_qnty=$exjob_data[3];
	$set_smv=$exjob_data[4];
	$company_name=$exjob_data[5];
	$order_uom=$exjob_data[6];
	$job_qty=$exjob_data[7];
	$avg_unit_price=$exjob_data[8];

	$po_id=''; $po_no=""; $pubship_date='';

	foreach($po_data_arr[$job_no] as $pid=>$podata)
	{
		$ex_po=0;
		//echo $podata['pdata'].'==';
		$ex_po=explode("___",$podata['pdata']);
		if($po_id=="") $po_id=$pid; else $po_id.=', '.$pid;
		if($po_no=="") $po_no=$ex_po[0]; else $po_no.=', '.$ex_po[0];
		if($pubship_date=="") $pubship_date=change_date_format($ex_po[1]); else $pubship_date.=', '.change_date_format($ex_po[1]);
	}

	$exmst_data=explode("___",$pre_mst_arr[$job_no]['mdata']);

	$costing_date=$exmst_data[0];
	$costing_per=$exmst_data[1];
	$budget_minute=$exmst_data[2];
	$approved=$exmst_data[3];
	$sew_effi_percent=$exmst_data[4];
	$inserted_by=$exmst_data[5];
	$pre_sew_smv=$exmst_data[6];
	$exchange_rate=$exmst_data[7];
	$incoterm=$exmst_data[8];

	$gsm_sql="select $group_gsm AS gsm_weight from lib_body_part a, wo_pre_cost_fabric_cost_dtls b where a.id=b.body_part_id and b.job_no='$job_no' and a.body_part_type in (1,20) and b.status_active=1 and b.is_deleted=0";
	$gsm_sql_res=sql_select($gsm_sql); $gsm_weight='';
	foreach($gsm_sql_res as $grow)
	{
		if($gsm_weight=="") $gsm_weight=$grow[csf('gsm_weight')]; else $gsm_weight.=','.$grow[csf('gsm_weight')];
	}
	unset($gsm_sql_res);

	$imge_arr=return_library_array( "select master_tble_id, image_location from common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$company_name'",'master_tble_id','image_location');
    $image_location=return_field_value("image_location","common_photo_library","master_tble_id='$job_no'");
	ob_start();//part 0;
	if($presentation_type==2) $path="../../../"; else $path="../../";

	?>
    <div style="width:850px;">
        <table width="100%" border="0">
            <tr>
                <td rowspan="3" width="25%">
					<? if ($img_path) { ?> <img  src='<? echo $img_path.$imge_arr[$company_name]; ?>' height='80' />
                    <? } else { ?> <img  src='<? echo $path.$imge_arr[$company_name]; ?>' height='80' />
                    <? } ?>
                </td>
                <td align="center"><b style="font-size:20px;"><? echo $comp[$company_name]; ?></b></td>
                <td rowspan="3" width="25%" align="right">
					<? if ($img_path) { ?> <img  src='<? echo $img_path.$image_location; ?>' height='80' />
                    <? } else { ?> <img  src='<? echo $path.$image_location; ?>' height='80' />
                    <? } ?>
                </td>
            </tr>
            <tr><td align="center"><b style="font-size:14px;">PRE-COSTING SHEET</b></td></tr>
            <tr>
                <td align="center">
                	<? if( $approved==1 || $approved==3){echo "<div style='font-size:18px; color:#F00; background:#CCC;'>THIS COST SHEET IS APPROVED </div>"; } else {echo "&nbsp;";} ?>
                </td>
            </tr>
        </table>
    </div>
    <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
        <tr>
            <td width="130">Job No.</td><td width="140"><b><? echo $job_no; ?></b></td>
            <td width="130">Buyer</td><td width="140"><b><? echo $buyer_arr[$buyer_id];?></b></td>
            <td width="130">Garments Item</td>
				<?
					$grmnt_items = "";
					$ex_gmt_id=explode(",",$gmts_item_id);
					foreach($ex_gmt_id as $gmt_id)
					{
						if($grmnt_items=="") $grmnt_items=$garments_item[$gmt_id]; else $grmnt_items.=', '.$garments_item[$gmt_id];
					}
                ?>
            <td><b><? echo $grmnt_items; ?></b></td>
        </tr>
        <tr>
            <td>Style Ref. No</td><td><b><? echo $style_ref_no; ?></b></td>
            <td>Costing Date</td><td><? echo change_date_format($costing_date);?></td>
            <td>Job Qty</td><td><b><? echo fn_number_format($job_qty)." ". $unit_of_measurement[$order_uom]; ?></b></td>
        </tr>
        <tr>
            <td>Order No.</td><td colspan="3"><? echo $po_no; ?></td>
            <td>Plan Cut Qty [Cut % <? echo fn_number_format((($po_plun_cut_qty/$total_set_qnty-$job_qty)/$job_qty)*100,2);?>]</td>
            <td><b><? echo fn_number_format($po_plun_cut_qty/$total_set_qnty)." ". $unit_of_measurement[$order_uom]; ?></b></td>
        </tr>
        <tr>
            <td>Knit Fabric Cons</td>
            <td><b><? echo $pre_mst_arr[$job_no]['knit_req_kg']; $fab_knit_req_kg_avg+=$pre_mst_arr[$job_no]['knit_req_kg']; ?> (Kg)</b></td>
            <td>Woven Fabric Cons</td>
            <td><b><? echo $pre_mst_arr[$job_no]['woven_req_yds']; $fab_woven_req_yds_avg+=$pre_mst_arr[$job_no]['woven_req_yds']; ?> (Yds)</b></td>
            <td>Price Per Unit</td><td><b><? echo fn_number_format($avg_unit_price,2); ?> USD</b></td>
        </tr>
        <tr>
            <td>Avg Yarn Req</td><td><b><? echo $pre_mst_arr[$job_no]['yarn_req_kg']; ?> (Kg)</b></td>
            <td>Woven Fin Fabric Cons</td><td><b><? echo $pre_mst_arr[$job_no]['woven_fin_req_yds']; ?>(Yds)</b></td>
            <td>Order Value</td><td><b><? $order_value=$job_qty*$avg_unit_price; echo fn_number_format($order_value,2); ?></b></td>
        </tr>
        <tr>
            <td>Knit Fin Fabric Cons</td><td><b><? echo $pre_mst_arr[$job_no]['fin_req_kg']; ?> (Kg)</b></td>
            <td>Costing Per</td><td><b><? echo $costing_per[$costing_per]; ?></b></td>
            <td>Incoterm</td><td><b><? echo $incoterm[$incoterm]; ?></b></td>
        </tr>
        <tr>
            <td>GSM</td><td><b><? echo $gsm_weight; ?></b></td>
            <td>SMV</td><td><b><? echo fn_number_format($pre_sew_smv,2); ?> </b></td>
            <td>Efficiency %</td><td><b><? echo $sew_effi_percent; ?> </b></td>
        </tr>
        <tr>
            <td>Exchange Rate</td><td><b><? echo $exchange_rate; ?></b></td>
            <td>Budget SAH</td><td><b><? echo fn_number_format(($pre_sew_smv*$job_qty)/60,2); ?></b></td>
            <td>Shipment Date</td><td><b><? echo $pubship_date;?></b></td>
        </tr>
    </table>
    <?
	if($costing_per==1) { $order_price_per_dzn=12; $costing_for=" DZN"; }
	else if($costing_per==2) { $order_price_per_dzn=1; $costing_for=" PCS"; }
	else if($costing_per==3) { $order_price_per_dzn=24;$costing_for=" 2 DZN"; }
	else if($costing_per==4) { $order_price_per_dzn=36;$costing_for=" 3 DZN"; }
	else if($costing_per==5) { $order_price_per_dzn=48;$costing_for=" 4 DZN"; }

	$dtlssql = "select fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, interest_cost, interest_percent, incometax_cost, incometax_percent, deffdlc_cost, deffdlc_percent, margin_pcs_bom, margin_bom_per from wo_pre_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
	$dtlssql_res=sql_select($dtlssql);

	$fabric_cost=$trims_cost=$embel_cost=$wash_cost=$comm_cost=$commission=$lab_test=$inspection=$cm_cost=$freight=$currier_pre_cost=$certificate_pre_cost=$common_oh=$total_cost=$price_dzn=$margin_dzn=$price_pcs_or_set=$margin_pcs_set=$cm_for_sipment_sche=$interest_cost=$incometax_cost=$deffdlc_cost=0;

	$fabric_cost_percent=$trims_cost_percent=$embel_cost_percent=$embel_cost_percent=$wash_cost_percent=$comm_cost_percent=$commission_percent=$lab_test_percent=$inspection_percent=$cm_cost_percent=$freight_percent=$currier_percent=$certificate_percent=$common_oh_percent=$total_cost_percent=$price_dzn_percent=$margin_dzn_percent=$price_pcs_or_set=$price_pcs_or_set_percent=$margin_pcs_set_percent=$interest_percent=$incometax_percent=$deffdlc_percent=$margin_pcs_bom=$margin_bom_per=0;

	$gross_cost=$dtlssql_res[0][csf('price_dzn')];
	$gross_cost_percent=$dtlssql_res[0][csf('price_dzn_percent')];
	$fabric_cost=$dtlssql_res[0][csf('fabric_cost')];
	$fabric_cost_percent=$dtlssql_res[0][csf('fabric_cost_percent')];
	$trims_cost=$dtlssql_res[0][csf('trims_cost')];
	$trims_cost_percent=$dtlssql_res[0][csf('trims_cost_percent')];
	$embel_cost=$dtlssql_res[0][csf('embel_cost')];
	$embel_cost_percent=$dtlssql_res[0][csf('embel_cost_percent')];
	$wash_cost=$dtlssql_res[0][csf('wash_cost')];
	$wash_cost_percent=$dtlssql_res[0][csf('wash_cost_percent')];
	$comm_cost=$dtlssql_res[0][csf('comm_cost')];
	$comm_cost_percent=$dtlssql_res[0][csf('comm_cost_percent')];
	$commission=$dtlssql_res[0][csf('commission')];
	$commission_percent=$dtlssql_res[0][csf('commission_percent')];
	$lab_test=$dtlssql_res[0][csf('lab_test')];
	$lab_test_percent=$dtlssql_res[0][csf('lab_test_percent')];
	$inspection=$dtlssql_res[0][csf('inspection')];
	$inspection_percent=$dtlssql_res[0][csf('inspection_percent')];
	$cm_cost=$dtlssql_res[0][csf('cm_cost')];
	$cm_cost_percent=$dtlssql_res[0][csf('cm_cost_percent')];
	$freight=$dtlssql_res[0][csf('freight')];
	$freight_percent=$dtlssql_res[0][csf('freight_percent')];
	$currier_pre_cost=$dtlssql_res[0][csf('currier_pre_cost')];
	$currier_percent=$dtlssql_res[0][csf('currier_percent')];
	$certificate_pre_cost=$dtlssql_res[0][csf('certificate_pre_cost')];
	$certificate_percent=$dtlssql_res[0][csf('certificate_percent')];
	$common_oh=$dtlssql_res[0][csf('common_oh')];
	$common_oh_percent=$dtlssql_res[0][csf('common_oh_percent')];

	$total_cost=$dtlssql_res[0][csf('total_cost')];
	$total_cost_percent=$dtlssql_res[0][csf('total_cost_percent')];
	$price_dzn=$dtlssql_res[0][csf('price_dzn')];
	$price_dzn_percent=$dtlssql_res[0][csf('price_dzn_percent')];
	$margin_dzn=$dtlssql_res[0][csf('margin_dzn')];
	$margin_dzn_percent=$dtlssql_res[0][csf('margin_dzn_percent')];
	$price_pcs_or_set=$dtlssql_res[0][csf('price_pcs_or_set')];
	$price_pcs_or_set_percent=$dtlssql_res[0][csf('price_pcs_or_set_percent')];
	$margin_pcs_set=$dtlssql_res[0][csf('margin_pcs_set')];
	$margin_pcs_set_percent=$dtlssql_res[0][csf('margin_pcs_set_percent')];
	$cm_for_sipment_sche=$dtlssql_res[0][csf('cm_for_sipment_sche')];
	$interest_cost=$dtlssql_res[0][csf('interest_cost')];
	$interest_percent=$dtlssql_res[0][csf('interest_percent')];
	$incometax_cost=$dtlssql_res[0][csf('incometax_cost')];
	$incometax_percent=$dtlssql_res[0][csf('incometax_percent')];
	$deffdlc_cost=$dtlssql_res[0][csf('deffdlc_cost')];
	$deffdlc_percent=$dtlssql_res[0][csf('deffdlc_percent')];

	$margin_pcs_bom=$dtlssql_res[0][csf('margin_pcs_bom')];
	$margin_bom_per=$dtlssql_res[0][csf('margin_bom_per')];
	unset($dtlssql_res);
	$others_cost_value=0; $costOfFabriTrimsEmbWash=0;
	$others_cost_value=$total_cost-$cm_cost-$freight-$comm_cost-$commission;
	$costOfFabriTrimsEmbWash=($fabric_cost+$trims_cost+$embel_cost+$wash_cost);

	//echo $margin_pcs_bom.'='.$margin_bom_per;
	$sl=1;
	?>
    <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px; text-align:center;" rules="all">
            <tr style="font-weight:bold">

                <td width="80">SL</td>
                <td width="300">Particulars</td>
                <td width="100">Cost</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <? if($zero_value==1) { ?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left">Gross FOB Value/ DZN</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $grfobv_dzn=fn_number_format($avg_unit_price*12,2) ; ?></td>
                    <td align="right">100%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commision/ DZN</td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format(($commission/$grfobv_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? $net_fob_value=$grfobv_dzn-$commission; echo fn_number_format($net_fob_value,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($fabric_cost,4); ?></td>
                    <td align="right" rowspan="13">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($fabric_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($trims_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($embel_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($wash_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($wash_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($comm_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($comm_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                    <td align="right"><? echo fn_number_format($lab_test_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                    <td align="right"><? echo fn_number_format($inspection_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                    <td align="right"><? echo fn_number_format($freight_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($currier_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($certificate_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Deffd.Lc.Cost (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Finance Charge (<? echo fn_number_format($interest_percent,2); ?>% )</td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Material & Service Cost (4:16)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><?
                        $total_material_cost=$fabric_cost+$trims_cost+$embel_cost+$wash_cost+$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost;

                        $total_material_cost_percent=$fabric_cost_percent+$trims_cost_percent+$embel_cost_percent+$wash_cost_percent+$comm_cost_percent+$lab_test_percent+$inspection_percent+$freight_percent+$currier_percent+$certificate_percent+$interest_percent+$incometax_percent+$deffdlc_percent;

                        echo fn_number_format($total_material_cost,2); ?></b></td>
                    <td align="right"><b><? echo fn_number_format($total_material_cost_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/Dzn (3-17)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $cm_value_contribution_margine=$net_fob_value-$total_material_cost; echo fn_number_format($cm_value_contribution_margine,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><?  echo ++$sl; ?></td>
                    <td align="left">Factory Overhead (FOH)/Dzn</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $foh=$cm_cost; echo fn_number_format($foh,2); ?></td>
                    <td align="right"><? echo fn_number_format($cm_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (18-19)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh; echo fn_number_format($margin_dozon,3); ?></td>
                    <td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_pcs=$margin_dozon/12; echo fn_number_format($margin_pcs,3); ?></td>
                    <td align="right"><? echo fn_number_format($margin_pcs/($grfobv_dzn/12)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">BOM Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($margin_pcs_bom,4); ?></td>
                    <td align="right"><? echo fn_number_format($margin_bom_per,2); ?>%</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_pcs=fn_number_format(($cm_value_contribution_margine/12)/$pre_sew_smv,3); echo $margin_pcs; ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM (Cost Per Minute)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin %</td>
                    <td>&nbsp;</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($cm_value_contribution_margine/$net_fob_value*100,2); ?>%</td>
                </tr>
            <? } else { ?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left">Gross FOB Value/ DZN</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $grfobv_dzn=fn_number_format($avg_unit_price*12,4); ?></td>
                    <td align="right">100.00%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commision/ DZN</td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format(($commission/$grfobv_dzn)*100,2);?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $net_fob_value=$grfobv_dzn-$commission; ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <?
                if($fabric_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">All Fabric Cost</td>
                        <td align="right"><? echo fn_number_format($fabric_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($fabric_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($trims_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Trims Cost</td>
                        <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($trims_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($embel_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Embellishment Cost</td>
                        <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($embel_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($wash_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Gmts Wash</td>
                        <td align="right"><? echo fn_number_format($wash_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($wash_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($comm_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Commercial Cost</td>
                        <td align="right"><? echo fn_number_format($comm_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($comm_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($commission!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Commission Cost</td>
                        <td align="right"><? echo fn_number_format($commission,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($commission_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($lab_test!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Lab Test</td>
                        <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($lab_test_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($inspection!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Inspection Cost</td>
                        <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($inspection_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($freight!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Gmts Freight Cost</td>
                        <td align="right"><? echo fn_number_format($freight,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($freight_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($currier_pre_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Currier Cost</td>
                        <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($currier_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($certificate_pre_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Certificate Cost</td>
                        <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($certificate_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($deffdlc_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Deffd.Lc.Cost (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($incometax_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Tax (<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
					</tr>
					<?
                }
                ?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo fn_number_format($interest_percent,2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Material & Service Cost (4:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><?
						$total_material_cost=($fabric_cost+$trims_cost+$embel_cost+$wash_cost+$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost);
						echo fn_number_format($total_material_cost,2); ?></b></td>
                    <td align="center"><b><?
						$total_material_cost_percent=$fabric_cost_percent+$trims_cost_percent+$embel_cost_percent+$wash_cost_percent+$comm_cost_percent+$lab_test_percent+$inspection_percent+$freight_percent+$currier_percent+$certificate_percent+$interest_percent+$incometax_percent+$deffdlc_percent;
						echo fn_number_format($total_material_cost_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/Dzn</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $cm_value_contribution_margine=$price_dzn-$total_material_cost; echo fn_number_format($cm_value_contribution_margine,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <?
                if($cm_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Factory Overhead (FOH)/Dzn</td>
                        <td>&nbsp;</td>
                        <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                        <td align="center"><? echo fn_number_format($cm_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                ?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (16-17)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh;echo  fn_number_format($margin_dozon,2);?></td>
                    <td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($margin_pcs_set,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">BOM Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($margin_pcs_bom,4); ?></td>
                    <td align="right"><? echo fn_number_format($margin_bom_per,2); ?>%</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo $margin_pcs=fn_number_format(($cm_value_contribution_margine/12)/$sew_smv,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM (Cost Per Minute)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin %</td>
                    <td>&nbsp;</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($cm_value_contribution_margine/$net_fob_value*100,2); ?>%</td>
                </tr>
                <?
				}
				?>
            </table>
    </div>
	<?
    $sql_fab = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, avg_cons_yarn, fabric_source, gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";

    $sql_fab_res=sql_select($sql_fab);

	$i=2;$j=2;
	foreach( $sql_fab_res as $row )
	{
		if($row[csf("fab_nature_id")]==2)//knit fabrics
		{
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
			if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
			else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			}
			$percent_to_order_value=$amount/$price_dzn*100;
			$i++;
			$knit_fab .= '<tr>
					<td align="left">'.$item_descrition.'</td>
					<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
					<td align="right">'.fn_number_format($amount,2).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
				</tr>';

			$knit_subtotal_avg_cons += $row[csf("avg_cons")];
			$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
			if($row[csf("fabric_source")] !=2){
				$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
			else{
				$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
			}
		}

		if($row[csf("fab_nature_id")]==3)//woven fabrics
		{
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
			$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			$percent_to_order_value=$amount/$price_dzn*100;
			$j++;
			$woven_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,2).'</td>
				<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
			</tr>';

			$woven_subtotal_avg_cons += $row[csf("avg_cons")];
			$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
			$woven_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
		}
	}
	unset($sql_fab_res);
	$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Avg. Fab. Cons/Dzn</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
	$woven_fab= '<tr><td colspan="7">&nbsp;</td></tr><tr>
					<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
	//knit fabrics table here
	$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
	$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn,4).'</td>
					<td></td>
					<td align="right">'.fn_number_format($knit_subtotal_amount,2).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
				</tr>';
				if($zero_value==1) echo $knit_fab;
				else
				{
					if($row[csf("avg_cons")]>0) echo $knit_fab; else echo "";
				}

	//woven fabrics table here
	$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons_yarn,4).'</td>
					<td></td>
					<td align="right">'.fn_number_format($woven_subtotal_amount,2).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
				</tr>';

	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
		<td colspan="4" align="left">Total</td>
		<td align="right"></td>
		<td></td>
		<td align="right">'.fn_number_format(($woven_subtotal_amount+$knit_subtotal_amount),2).'</td>
		<td align="right">'.fn_number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
	</tr></table></div>';

	if($zero_value==1) echo $woven_fab;
	else
	{
		if($row[csf("avg_cons")]>0) echo $woven_fab; else echo "";
	}
	$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;

	$lib_yarn_count=return_library_array( "select yarn_count, id from lib_yarn_count", "id", "yarn_count"  );

	$sql_yarn = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
	$sql_yarn_res=sql_select($sql_yarn);

	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($sql_yarn_res)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_qnty=0; $total_avg_qnty=0; $total_amount=0;
                foreach( $sql_yarn_res as $row )
                {
					if($row[csf("percent_one")]==100)
						$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
					else
						$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

					?>
					<tr>
                        <td align="left"><? echo $item_descrition; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_qnty += $row[csf("cons_qnty")];
					$total_avg_qnty += $row[csf("avg_cons_qnty")];
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
		</div>
		<?
		$grand_total_amount +=$total_amount;
	}
	else
	{
		if($fabric_cost>0)
		{
			?>
			<div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                    <tr style="font-weight:bold">
                        <td width="70" rowspan="<? echo count($sql_yarn_res)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                        <td width="350">Yarn Desc</td>
                        <td width="100">Yarn Qnty</td>
                        <td width="100">Avg.Yarn Qnty</td>
                        <td width="100">Rate (USD)</td>
                        <td width="100">Amount (USD)</td>
                        <td>% to Ord. Value</td>
                    </tr>
                    <?
                    $total_qnty=0;$total_amount=0;
                    foreach( $sql_yarn_res as $row )
                    {
						if($row[csf("percent_one")]==100)
							$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
						else
							$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

						?>
						<tr>
                            <td align="left"><? echo $item_descrition; ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
						</tr>
						<?
						$total_qnty += $row[csf("cons_qnty")];
						$total_avg_qnty += $row[csf("avg_cons_qnty")];
						$total_amount += $row[csf("amount")];
                    }
                    ?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td>Total</td>
                        <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                        <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                        <td></td>
                        <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                        <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                    </tr>
                </table>
			</div>
			<?
			$grand_total_amount +=$total_amount;
		}
		else
		{
			echo "";
		}
	}
	unset($sql_yarn_res);
	//End Yarn Cost part report here -------------------------------------------
	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql_conv = "select a.id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty, a.avg_req_qnty, a.charge_unit, a.amount, a.status_active, b.body_part_id, b.fab_nature_id, b.color_type_id, b.fabric_description from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no='$job_no' and b.status_active=1 and b.is_deleted=0 ";
	$sql_conv_res=sql_select($sql_conv);
	$conData=array();
	$totPro=array();
	foreach($sql_conv_res as $rows){
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fabric_description_id']=$rows[csf('fabric_description_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['job_no']=$rows[csf('job_no')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['cons_process']=$rows[csf('cons_process')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['req_qnty']=$rows[csf('req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['avg_req_qnty']=$rows[csf('avg_req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['charge_unit']=$rows[csf('charge_unit')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['amount']=$rows[csf('amount')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['status_active']=$rows[csf('status_active')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['body_part_id']=$rows[csf('body_part_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fab_nature_id']=$rows[csf('fab_nature_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['color_type_id']=$rows[csf('color_type_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fabric_description']=$rows[csf('fabric_description')];
		$totPro[$rows[csf('cons_process')]]=$rows[csf('cons_process')];
	}
	//unset($sql_conv_res);
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <tr style="font-weight:bold">
                <td width="80" rowspan="<? echo count($sql_conv_res)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                <td width="350">Particulars</td>
                <td width="100">Process</td>
                <td width="100">Cons/Dzn</td>
                <td width="100">Avg. Cons/Dzn</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            $total_req_qnty=0;
            $total_avg_req_qnty=0;
            $total_charge_unit=0;
            foreach( $conData as $processId=>$idArr )
            {
				$sub_total_amount=0;
				$sub_total_req_qnty=0;
				$sub_total_avg_req_qnty=0;
				$sub_total_charge_unit=0;
				foreach( $idArr as $id=>$row )
				{
					if($row['fabric_description_id']!=0)
					{
						$item_descrition = $body_part[$row["body_part_id"]].", ".$color_type[$row["color_type_id"]].", ".$row["fabric_description"];
					}
					else
					{
						$item_descrition = "All Fabrics";
					}
					?>
					<tr>
                        <td align="left"><? echo $item_descrition; ?></td>
                        <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["avg_req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["amount"],2); ?></td>
                        <td align="right"><? echo fn_number_format($row["amount"]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$sub_total_amount+= $row["amount"];
					$sub_total_req_qnty+= $row["req_qnty"];
					$sub_total_avg_req_qnty+= $row["avg_req_qnty"];
					$sub_total_charge_unit+= $row["charge_unit"];

					$total_amount += $row["amount"];
					$total_req_qnty+= $row["req_qnty"];
					$total_avg_req_qnty+= $row["avg_req_qnty"];
					$total_charge_unit+= $row["charge_unit"];
				}
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Sub Total</td>
                    <td align="right"><? echo  fn_number_format( $sub_total_req_qnty,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo  fn_number_format($sub_total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_amount,2); ?></td>
                    <td align="right"><? echo  fn_number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
				</tr>
				<?
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2">Conversion Total Cost</td>
                <td align="right"><? //echo fn_number_format($total_req_qnty,4);?></td>
                <td align="right"><? //echo fn_number_format($total_avg_req_qnty,4); ?></td>
                <td align="right"><? //echo fn_number_format($total_charge_unit,4);?></td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td align="left" colspan="5">Total Fabric Cost</td>
                <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),2); ?></td>
                <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
            </tr>
        </table>
        </div>
        <?
	}
	else
	{
		if($fabric_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($sql_conv_res)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Avg. Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                $total_req_qnty=0;
                $total_avg_req_qnty=0;
                $total_charge_unit=0;
                foreach( $conData as $processId=>$idArr )
                {
					$sub_total_amount=0;
					$sub_total_req_qnty=0;
					$sub_total_avg_req_qnty=0;
					$sub_total_charge_unit=0;
					foreach( $idArr as $id=>$row )
					{
						if($row["fabric_description_id"] !=0)
						{
							$item_descrition = $body_part[$row["body_part_id"]].", ".$color_type[$row["color_type_id"]].", ".$row["fabric_description"];
						}
						else
						{
							$item_descrition = "All Fabrics";
						}
						?>
						<tr>
                            <td align="left"><? echo $item_descrition; ?></td>
                            <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                            <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["avg_req_qnty"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["amount"],2); ?></td>
                            <td align="right"><? echo fn_number_format($row["amount"]/$price_dzn*100,2); ?>%</td>
						</tr>
						<?
						$sub_total_amount+= $row["amount"];
						$sub_total_req_qnty+= $row["req_qnty"];
						$sub_total_avg_req_qnty+= $row["avg_req_qnty"];
						$sub_total_charge_unit+= $row["charge_unit"];

						$total_amount += $row["amount"];
						$total_req_qnty+= $row["req_qnty"];
						$total_avg_req_qnty+= $row["avg_req_qnty"];
						$total_charge_unit+= $row["charge_unit"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="2">Sub Total</td>
                        <td align="right"><? echo  fn_number_format( $sub_total_req_qnty,4);?></td>
                        <td align="right"><? echo fn_number_format($sub_total_avg_req_qnty,4); ?></td>
                        <td align="right"><? //echo  fn_number_format($sub_total_charge_unit,4);?></td>
                        <td align="right"><? echo fn_number_format($sub_total_amount,2); ?></td>
                        <td align="right"><? echo  fn_number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
                    </tr>
                    <?
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? //echo fn_number_format($total_req_qnty,4);?></td>
                    <td align="right"><? //echo fn_number_format($total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo fn_number_format($total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                    <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),2); ?></td>
                    <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_conv_res);
	//End Conversion Cost to Fabric report here -------------------------------------------
	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name");
   	$sql_trim = "select id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, status_active from wo_pre_cost_trim_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ";
	$sql_trim_res=sql_select($sql_trim);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_trim_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                        <td align="left"><? echo $row[csf("description")]; ?></td>
                        <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                        <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
		</div>
		<?
	}
	else
	{
		if($trims_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_trim_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                        <td align="left"><? echo $row[csf("description")]; ?></td>
                        <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                        <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                    </tr>
                    <?
                    $total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_trim_res);
	//End Trims Cost Part report here -------------------------------------------
	//start	Embellishment Details part report here -------------------------------------------
    $sql_emb = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 and emb_name !=3";
	$sql_emb_res=sql_select($sql_emb);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Embellishment Details</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="150">Type</td>
                <td width="150">Cons/Dzn</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_emb_res as $row )
            {
				$em_type ='';
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				?>
				<tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("amount")];
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="4">Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($embel_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_emb_res as $row )
                {
					$em_type ="";
					//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
					if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
					?>
					<tr>
                        <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                        <td align="left"><? echo $em_type; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_emb_res);
	//End Embellishment Details Part report here -------------------------------------------
	//start	Commercial Cost part report here -------------------------------------------
   	$sql_commarcial = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ";
	$sql_commarcial_res=sql_select($sql_commarcial);
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
        <label><b>Commercial Cost</b></label>
            <tr style="font-weight:bold">
                <td width="250">Particulars</td>
                <td width="100">Rate In %</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_commarcial_res as $row )
            {
				?>
				<tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo fn_number_format($ccp,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("amount")];
				$tot_ccp+=$ccp;
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2">Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($tot_ccp,2); ?></td>
            </tr>
        </table>
        </div>
        <?
	}
	else
	{
		if($comm_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_commarcial_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo fn_number_format($ccp,2);?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
					$tot_ccp+=$ccp;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($tot_ccp,2); ?></td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_commarcial_res);
	//End Commercial Cost Part report here -------------------------------------------
	//start	Commission Cost part report here -------------------------------------------
   	$sql_commission = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
	$sql_commission_res=sql_select($sql_commission);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Commission Cost</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="150">Commission Basis</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_commission_res as $row )
            {
				?>
				<tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],2); ?></td>
                    <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo fn_number_format($cca,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("commission_amount")];
				$total_cca += $cca;
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="3">Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_cca,2); ?></td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($commission>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_commission_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                        <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>

                        <td align="right"><? echo fn_number_format($row[csf("commission_amount")],2); ?></td>
                        <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo fn_number_format($cca,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("commission_amount")];
					$total_cca += $cca;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_cca,2); ?></td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
		   echo "";
		}
	}
	unset($sql_commission_res);
	//End Commission Cost Part report here -------------------------------------------
	//start	Other Components part report here -------------------------------------------

	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Others Components</b></label>
            <tr style="font-weight:bold">
                <td width="250">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">% to Ord. Value</td>
            </tr>
            <tr>
                <td align="left"s>Gmts Wash</td>
                <td align="right"><? echo fn_number_format($wash_cost,2); ?></td>
                <td align="right"><? $ogw=($wash_cost/$grfobv_dzn)*100; echo fn_number_format($ogw,2); ?>%</td>
            </tr>
            <tr>
                <td align="left"s>Lab Test </td>
                <td align="right"><? echo fn_number_format($lab_test,2); ?></td>
                <td align="right"><? $olt=($lab_test/$grfobv_dzn)*100; echo fn_number_format($olt,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Inspection Cost</td>
                <td align="right"><? echo fn_number_format($inspection,2); ?></td>
                <td align="right"><? $oic=($inspection/$grfobv_dzn)*100; echo fn_number_format($oic,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Factory Overhead (FOH)/Dzn</td>
                <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                <td align="right"><? $ofoh=($cm_cost/$grfobv_dzn)*100; echo fn_number_format($ofoh,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Gmts Freight Cost</td>
                <td align="right"><? echo fn_number_format($freight,2); ?></td>
                <td align="right"><? $ogfc=($freight/$grfobv_dzn)*100; echo fn_number_format($ogfc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Currier Cost</td>
                <td align="right"><? echo fn_number_format($currier_pre_cost,2); ?></td>
                <td align="right"><? $ocrc=($currier_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocrc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Certificate Cost</td>
                <td align="right"><? echo fn_number_format($certificate_pre_cost,2); ?></td>
                <td align="right"><? $ocfc=($certificate_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocfc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Deffd.Lc.Cost Charge (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                <td align="right"><? echo fn_number_format($deffdlc_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Finance Charge (<? echo fn_number_format($interest_percent,2); ?>%)</td>
                <td align="right"><? echo fn_number_format($interest_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>

            </tr>
            <tr>
                <td align="left">Tax(<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                <td align="right"><? echo fn_number_format($incometax_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
            </tr>
				<?
                	$total_amount += $wash_cost+$lab_test+$inspection+($cm_cost)+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$interest_cost+$incometax_cost;
                	$total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$deffdlc_percent+$interest_percent+$incometax_percent;
                ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_parcent,2);?>%</td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                if($wash_cost>0)
                {
					?>
					<tr>
                        <td align="left"s>Gmts Wash</td>
                        <td align="right"><? echo fn_number_format($wash_cost,2); ?></td>
                        <td align="right"><? $ogw=($wash_cost/$grfobv_dzn)*100; echo fn_number_format($ogw,2); ?>%</td>
					</tr>
					<?
                }
                if($lab_test>0)
                {
                ?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($lab_test,2); ?></td>
                    <td align="right"><? $olt=($lab_test/$grfobv_dzn)*100; echo fn_number_format($olt,2); ?>%</td>
                </tr>
                <?
                }
                if($inspection>0)
                {
					?>
					<tr>
                        <td align="left">Inspection Cost</td>
                        <td align="right"><? echo fn_number_format($inspection,2); ?></td>
                        <td align="right"><? $oic=($inspection/$grfobv_dzn)*100; echo fn_number_format($oic,2); ?>%</td>
					</tr>
					<?
                }
                if($cm_cost>0)
                {
					?>
					<tr>
                        <td align="left">Factory Overhead (FOH)/Dzn</td>
                        <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                        <td align="right"><? $ofoh=($cm_cost/$grfobv_dzn)*100; echo fn_number_format($ofoh,2); ?>%</td>
					</tr>
					<?
                }
                if($freight>0)
                {
					?>
					<tr>
                        <td align="left">Gmts Freight Cost</td>
                        <td align="right"><? echo fn_number_format($freight,2); ?></td>
                        <td align="right"><? $ogfc=($freight/$grfobv_dzn)*100; echo fn_number_format($ogfc,2); ?>%</td>
					</tr>
					<?
                }
                if($currier_pre_cost>0)
                {
					?>
					<tr>
                        <td align="left">Currier Cost</td>
                        <td align="right"><? echo fn_number_format($currier_pre_cost,2); ?></td>
                        <td align="right"><? $ocrc=($currier_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocrc,2); ?>%</td>
					</tr>
					<?
                }
                if($certificate_pre_cost>0)
                {
					?>
					<tr>
                        <td align="left">Certificate Cost</td>
                        <td align="right"><? echo fn_number_format($certificate_pre_cost,2); ?></td>
                        <td align="right"><? $ocfc=($certificate_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocfc,2); ?>%</td>
					</tr>
					<?
                }
                if($common_oh>0)
                {
					?>
					<?
                }
                if($deffdlc_cost>0)
                {
					?>
					<tr>
                        <td align="left">Deffd.Lc.Cost Charge (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($deffdlc_cost,2); ?></td>
                        <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($interest_cost>0)
                {
					?>
					<tr>
                        <td align="left">Finance Charge (<? echo fn_number_format($interest_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($interest_cost,2); ?></td>
                        <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($incometax_cost>0)
                {
					?>
					<tr>
                        <td align="left">Tax(<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($incometax_cost,2); ?></td>
                        <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
					</tr>
					<?
                }
                $total_amount += $wash_cost+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$interest_cost+$incometax_cost;
                $total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$deffdlc_percent+$interest_percent+$incometax_percent;

                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_parcent,2);?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	//End Other Components  Part report here -------------------------------------------
	//start	CM on Net Order Value part report here -------------------------------------------
	$order_net_value = 0;
	?>
    <div style="margin-top:15px">
    <div style="float:left">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
        <label><b>CM on Net Order Value -zzz</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">%</td>
            </tr>
            <tr>
                <td align="left">Order Value </td>
                <td align="right"><? echo fn_number_format($order_value,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Commission </td>
                <td align="right"><? $less_commission = $commission/$order_price_per_dzn*$job_qty; echo fn_number_format($less_commission,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Commercial Cost </td>
                <td align="right"><? $less_commercial = $comm_cost/$order_price_per_dzn*$job_qty; echo fn_number_format($less_commercial,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Freight</td>
                <td align="right"><? $less_freight = $freight/$order_price_per_dzn*$job_qty; echo fn_number_format($less_freight,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Net Order Value</td>
                <td align="right"><? $order_net_value=$order_value-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,2); ?></td>
                <td align="right"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">Other Cost</td>
                <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$job_qty; echo fn_number_format($otherCost,2); ?></td>
                <td align="right"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">CM(Contribution Margin)</td>
                <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,2); ?></td>
                <td align="right"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">CM /<? echo $costing_for; ?></td>
                <td align="right"><? $cmPerDzn=$cmValue/$job_qty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                <td align="center"></td>
            </tr>
            <tr>
                <td align="left">FOH/<? echo $costing_for; ?></td>
                <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                <td align="center">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Margin /<? echo $costing_for; ?></td>
                <td align="right"><? echo fn_number_format($cmPerDzn-$cm_cost,2); ?></td>
                <td align="center">&nbsp;</td>
            </tr>
        </table>
  </div>
  <div style="margin-left:5px;float:left;">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
        <label><b>Cost Summary for order quantity</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">%</td>
            </tr>
            <tr>
                <td align="left">Total Order Value </td>
                <td align="right"><? $total_order_val = $job_qty*$avg_unit_price; echo fn_number_format($total_order_val,2); ?></td>
                <td align="right"><? echo fn_number_format($total_order_val/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Total Cost </td>
                <td align="right"><?  $total_cost = $total_cost/$order_price_per_dzn*$job_qty; echo fn_number_format($total_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Margin </td>
                <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,2); ?></td>
                <td align="right"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Margin /<? echo $costing_for; ?> </td>
                <td align="right"><? echo fn_number_format($margin_val/$job_qty*$order_price_per_dzn,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
       </table>
    </div>
        <div style="clear:both"></div>
    </div>
    <?
    echo "<br /><b>Note: Other Cost = Fabric Cost + Trims Cost + Embellishment Cost + Gmts Wash + Lab Test + Inspection + Currier Cost + <br />Certificate Cost + Finance Charge+ Deffd.Lc.Cost+Tax</b>";

    $user_sql = "select a.id, a.user_full_name, b.custom_designation from user_passwd a, lib_designation b where a.valid=1 and b.id=a.designation";

    $user_data_array=sql_select($user_sql);
    foreach($user_data_array as $row){
        $user_arr[$row[csf(id)]]=$row[csf(user_full_name)].'<br><span style="font-size:10px;">('.$row[csf(custom_designation)].')</span>';
    }
    unset($user_data_array);

	$sql="select bypass, buyer_id, sequence_no, user_id FROM electronic_approval_setup where company_id='$company_name' and FIND_IN_SET(buyer_id, $buyer_id)>0 and page_id=869 and is_deleted=0 order by sequence_no asc";
	$data_array=sql_select($sql);
	foreach($data_array as $row){
		$electronic_data[$row[csf(sequence_no)]] = $row[csf(user_id)];
		$user_wise_sequence[$row[csf(user_id)]] = $row[csf(sequence_no)];
	}
	unset($data_array);
	$startSequence = min($user_wise_sequence);
	$endSequence = max($user_wise_sequence);

	$sql="select min(b.current_approval_status) as cstatus, b.approved_by, b.mst_id FROM co_com_pre_costing_approval b where b.job_no='$job_no' and b.approved_by not in (".$electronic_data[$endSequence].") group by b.mst_id,b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$check_app_data[$row[csf(approved_by)]] = $row[csf(approved_by)];}
		$mst_id = $row[csf(mst_id)];//for Higher Auth Check;
		$higher_auth_id = $row[csf(approved_by)];//for Higher Auth Check;
	}
	unset($data_array);


	$sql="select min(b.current_approval_status) as cstatus, b.approved_by FROM co_com_pre_costing_approval b where b.job_no='$job_no' and b.approved_by in (".$electronic_data[$endSequence].") group by b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$last_app_data = $row[csf(approved_by)];}
	}
	unset($data_array);

   //---------------------------------------------Higher Auth Check;
	$app_history_data=return_library_array( "select sequence_no, approved_by from approval_history where mst_id=$mst_id and entry_form=15",'sequence_no','approved_by');

	if(count($check_app_data)==1 && (!in_array($higher_auth_id,$app_history_data))){
		$last_app_data=$app_history_data[$endSequence];
		$check_app_data=array();
		foreach($app_history_data as $sec=>$user){
			if($sec!=$endSequence){$check_app_data[$user] =$user;}
		}
		$align='center';
	}
	else
	{
		$higher_auth_id	=0;
		$align='right';
	}
	//--------------------------------------------------------
	?>
    <br /><br />
	<table class="rpt_table" border="0" cellpadding="1" cellspacing="1" style="text-align:center;" rules="all" width="850">
		<tr>
        	<td style="border:none; line-height:13px;" align="left"><? echo $user_arr[$prepared_app_data]; ?></td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td style="border:none; line-height:13px;" align="center">'.$user_arr[$check_user].'</td>';
			}
			?>
            <td style="border:none; line-height:13px;" align="<? echo $align;?>"><? echo $user_arr[$last_app_data]; ?></td>
       		<?
			if($higher_auth_id!=0){
				echo '<td style="border:none; line-height:13px;" align="right">'.$user_arr[$higher_auth_id].'</td>';
			}
			?>

        </tr>
		<tr style="alignment-baseline:baseline;">
        	<td width="" style="text-decoration:overline; border:none" align="left">Prepared By</td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td width="" style="text-decoration:overline; border:none" align="center">Checked By</td>';
			}
			?>
            <td width="" style="text-decoration:overline; border:none" align="<? echo $align;?>">Approved By</td>
       		<?
			if($higher_auth_id!=0){
				echo '<td width="" style="text-decoration:overline; border:none" align="right">Unapproved/Approved</td>';
			}
			?>
        </tr>
    </table>
 	<?
	exit();
}

if($action=="preCostRpt4")//issue id 8793 for jk by Kausar
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";


	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	//$gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	//$gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");


	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no."   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
	$po_qty+=$sql_po_row[csf('order_quantity')];
	$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
	$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
	}

	//echo $po_qty;

	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
	$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	$costing_per_arr=return_library_array( "select job_no,costing_per from wo_pre_cost_mst where job_no =".$txt_job_no."", "job_no", "costing_per");// where job_no ='FAL-14-01157'
	$financial_para=array();
	$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute,applying_period_date, applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
	/*foreach($sql_std_para as $sql_std_row){
		$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
		$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
		$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];

	} */
	//echo "select interest_expense,income_tax,cost_per_minute,applying_period_date, applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id";
	foreach($sql_std_para as $row )
	{
		$applying_period_date=change_date_format($row[csf('applying_period_date')],'','',1);
		$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
		$diff=datediff('d',$applying_period_date,$applying_period_to_date);
		for($j=0;$j<$diff;$j++)
		{
			//$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
			$date_all=add_date(str_replace("'","",$applying_period_date),$j);
			$newdate =change_date_format($date_all,'','',1);
			$financial_para[$newdate][interest_expense]=$row[csf('interest_expense')];
			$financial_para[$newdate][income_tax]=$row[csf('income_tax')];
			$financial_para[$newdate][cost_per_minute]=$row[csf('cost_per_minute')];
		}
	}
	//print_r($financial_para);

	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;
	if($db_type==0){
	$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute,b.costing_date, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date order by a.job_no";
	}
	if($db_type==2){
    $sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute,b.costing_date, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	}
	$data_array=sql_select($sql);
	?>
    <!--    <div style="width:850px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>
  -->	<?
	$uom="";
	$sew_smv=0;
	$cut_smv=0;
	$sew_effi_percent=0;
	$cut_effi_percent=0;
	foreach ($data_array as $row){
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$pre_costing_date=change_date_format($row[csf('costing_date')],'','',1);
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val){
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_file .= $val[csf('file_no')].",";
			$job_in_ref .= $val[csf('grouping')].",";
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref){
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file){
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		?>
            	<table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
					$path=($path)?$path:'../../';
					?>
                    <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                </td></tr></table>

                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}

						?>
                        <td width="100"><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td colspan=""><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Job Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                         <td>Plan Cut Qty</td>
                       <td><b><? echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]];?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="5"><? echo $job_in_orders; ?></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>

                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?> USD</b></td>
                    </tr>
                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]];?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                    <tr>
                    <td>Knit Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_fin_req_kg")] ?> (Kg)</b></td>
                        <td>Woven Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_fin_req_yds")]; ?>(Yds)</b></td>
                    	<td>GSM</td>
                        <td><b><? //echo $gsm_weight_top.", ".$gsm_weight_bottom

						$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
						$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
						if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';
						if($gsm_weight_bottom!='' && $gsm_weights_top!='') $gsm_weightBottom=" ,".$gsm_weight_bottom;
						else if($gsm_weight_bottom!='' && $gsm_weights_top=='') $gsm_weightBottom=$gsm_weight_bottom;
						else $gsm_weightBottom='';
						echo $gsm_weightTop .$gsm_weightBottom;
						?></b></td>

                    </tr>
                     <tr>
                    	<td>Budget Minute</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                        <td align="center" height="10" colspan="2" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                        <td>Quotation ID</td>
                        <td><b><? echo $row[csf("quotation_id")] ?> </b></td>
                    </tr>
                    <tr>
                     <td>Internal Ref</td>
                        <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                        <td>File No</td>
                        <td colspan="2"><b><? echo $file_cond; ?></b></td>
                    </tr>
                </table>
            <?
			if($row[csf("costing_per")]==1){
				$order_price_per_dzn=12;
				$costing_for=" DZN";
			}
			else if($row[csf("costing_per")]==2){
				$order_price_per_dzn=1;
				$costing_for=" PCS";
			}
			else if($row[csf("costing_per")]==3){
				$order_price_per_dzn=24;
				$costing_for=" 2 DZN";
			}
			else if($row[csf("costing_per")]==4){
				$order_price_per_dzn=36;
				$costing_for=" 3 DZN";
			}
			else if($row[csf("costing_per")]==5){
				$order_price_per_dzn=48;
				$costing_for=" 4 DZN";
			}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];

	}//end first foearch
 	?>
      <?
		//start	all summary report here -------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);


	 $sql_new = "select job_no,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,depr_amor_pre_cost,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			$data_array_new=sql_select($sql_new);
			$summary_data=array();

            foreach( $data_array_new as $row_new ){
				$summary_data[price_dzn]=$row_new[csf("price_dzn")];
				$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
			    $summary_data[commission]=$row_new[csf("commission")];
				$summary_data[trims_cost]=$row_new[csf("trims_cost")];
				$summary_data[emb_cost]=$row_new[csf("embel_cost")];

				$summary_data[lab_test]=$row_new[csf("lab_test")];
				$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

				$summary_data[inspection]=$row_new[csf("inspection")];
				$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

				$summary_data[freight]=$row_new[csf("freight")];
				$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

				$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
				$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

				$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
				$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
				$summary_data[wash_cost]=$row_new[csf("wash_cost")];

				$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

				$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

				$summary_data[cm_cost]=$row_new[csf("cm_cost")];
				$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

				$summary_data[comm_cost]=$row_new[csf("comm_cost")];

				$summary_data[common_oh]=$row_new[csf("common_oh")];
				$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
				$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
				$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
			}
    unset($data_array_new);
    //Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and is_deleted=0 and status_active=1";
	$data_arr_fabric=sql_select($sql_fabric);
	foreach($data_arr_fabric as $fab_row){
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	unset($data_arr_fabric);


   //Fabric End======================

   // Yarn===========================
	$totYarn=0;
	$YarnData=array();
	$yarn_data_array=$yarn->get_By_Precostdtlsid_YarnQtyAmountArray();
	$sql_yarn="select f.id as yarn_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,count_id,copm_one_id,percent_one,color,type_id   from wo_pre_cost_fab_yarn_cost_dtls f where     f.job_no =".$txt_job_no." and f.is_deleted=0 and f.status_active=1  order by f.id";
	$data_arr_yarn=sql_select($sql_yarn);
	foreach($data_arr_yarn as $yarn_row){
		$yarnrate=$yarn_row[csf("rate")];
		$summary_data[yarn_cost][$yarn_row[csf("yarn_id")]]=$yarn_row[csf("amount")];
		$summary_data[yarn_cost_job]+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];

		$index="'".$yarn_row[csf("count_id")]."_".$yarn_row[csf("copm_one_id")]."_".$yarn_row[csf("percent_one")]."_".$yarn_row[csf("type_id")]."_".$yarn_row[csf("color")]."_".$yarnrate."'";
		$YarnData[$index]['qty']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
		$YarnData[$index]['amount']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
		$YarnData[$index]['dznqty']+=$yarn_row[csf("cons_qnty")];
		$YarnData[$index]['dznamount']+=$yarn_row[csf("amount")];
		$totYarn+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
	}
	unset($data_arr_yarn);
	// Yarn End============================
	// Conversion
	$totConv=0;
	$ConvData=array();
	$conv_data=array();
	$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
	$conv_qty_arr=$conversion->getQtyArray_by_conversionid();
	$sql_conv = "select a.id as con_id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.uom  from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.is_deleted=0 and b.status_active=1 where a.job_no=".$txt_job_no." and a.is_deleted=0 and a.status_active=1";
	$data_arr_conv=sql_select($sql_conv);
	foreach($data_arr_conv as $conv_row){
		$convamount=$conv_amount_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];
		$convQty=$conv_qty_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];

		$conv_data[cons_process][$conv_row[csf('con_id')]]=$conv_row[csf('cons_process')];
		$conv_data[amount][$conv_row[csf('con_id')]]=$conv_row[csf('amount')];
		$conv_data[amount_job][$conv_row[csf('con_id')]]+=$convamount;
		$summary_data[conver_cost_job]+=$convamount;

		$index=$conv_row[csf('con_id')];
		$ConvData[$index]['item_descrition']=$body_part[$conv_row[csf("body_part_id")]].", ".$color_type[$conv_row[csf("color_type_id")]].", ".$conv_row[csf("fabric_description")];
		$ConvData[$index]['cons_process']=$conv_row[csf("cons_process")];
		$ConvData[$index]['req_qnty']=$conv_row[csf("req_qnty")];
		$ConvData[$index]['uom']=$conv_row[csf("uom")];
		$ConvData[$index]['charge_unit']=$conv_row[csf("charge_unit")];
		$ConvData[$index]['amount']=$conv_row[csf("amount")];
		$ConvData[$index]['tot_req_qnty']=$convQty;
		$ConvData[$index]['tot_amount']=$convamount;
		$totConv+=$conv_row[csf("req_qnty")];
	}
	unset($data_arr_conv);
    //Conversion End

	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
	from wo_pre_cost_trim_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();

	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
		$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;
		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
   unset($data_array_trim);
   //End	Trims Cost part report here -------------------------------------------
   //Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5) and is_deleted=0 and status_active=1";
	$data_arrayemb=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();

	$totEmb=0;
	$EmbData=array();

	foreach( $data_arrayemb as $row ){
	$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
	$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	unset($data_arrayemb);
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and is_deleted=0 and status_active=1";
	$data_arrayWash=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_arrayWash as $row ){
	$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
	$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamount;
	$summary_data[OtherDirectExpenses_job]+=$washamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	unset($data_arrayWash);
	//End Wash cost Cost part report here -------------------------------------------
	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_arrayComi=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_arrayComi as $row ){
	$commisionamount=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[commission_job]+=$commisionamount;
	$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
	$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
	$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
	$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
	$CommiData[$row[csf("id")]]['tot_commission_amount']=$commisionamount;
	$totCommi+=$row[csf("commission_amount")];
	}
	unset($data_arrayComi);
	//End Commision cost Cost part report here -------------------------------------------

	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_arrayComer=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_arrayComer as $row ){
	$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[comm_cost_job]+=$commarcialamount;
	$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
	$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
	$totCommar+=$row[csf("amount")];
	}
	unset($data_arrayComer);
    //End Commarcial cost Cost part report here -------------------------------------------
	  ?>
       <div style="margin-top:15px">
         <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
          <tr style="font-weight:bold">
                            <td width="380" colspan="5">Order Profitability </td>

                        </tr>
                        <tr style="font-weight:bold">
                            <td width="80">Line Items</td>
                            <td width="380">Particulars</td>
                            <td width="100">Amount (USD)/<? echo $costing_for; ?></td>
                            <td width="100">Total Value</td>
                            <td width="100">%</td>
                        </tr>
                        <tr>
                            <td width="80">1</td>
                            <td width="380" align="left" style="font-weight:bold">Gross FOB Value</td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn],4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn_job],4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">2</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: commission</td>
                            <td width="100" align="right"><? echo fn_number_format($summary_data[commission],4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format($summary_data[commission_job],4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[commission_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                           <td width="80">3</td>
                            <?
							$NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
							$NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];
							?>
                            <td width="380" align="left" style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue,4); ?></td>

                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">4</td>
                            <td width="380" align="left" style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8+9) </b></td>
                            <?
							$Less_Cost_Material_Services=array_sum($summary_data[yarn_cost])+array_sum($summary_data[fabric_cost])+array_sum($conv_data[amount])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];

							$Less_Cost_Material_Services_job=$summary_data[yarn_cost_job]+$summary_data[fabric_cost_job]+$summary_data[conver_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];
							//+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($Less_Cost_Material_Services,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($Less_Cost_Material_Services_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td width="80" rowspan="2">5</td>
                            <td width="380" align="left" style=" padding-left:100px;font-weight:bold">Yarn Cost</td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format(array_sum($summary_data[yarn_cost]),4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[yarn_cost_job],4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[yarn_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="380" align="left" style=" padding-left:100px;font-weight:bold">Fabric Purchase Cost</td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format(array_sum($summary_data[fabric_cost]),4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[fabric_cost_job],4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[fabric_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80" valign="top">6</td>
                            <td width="380" align="left" style="padding-left:100px;font-weight:bold">Conversion Cost</td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format(array_sum($conv_data[amount]),4);?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[conver_cost_job],4);?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[conver_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">7</td>
                            <td width="380" align="left" style=" padding-left:100px;font-weight:bold" ><b>Trim Cost </b></td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[trims_cost],4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[trims_cost_job],4)?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[trims_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">8</td>
                            <td width="380" align="left" style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[emb_cost],4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[emb_cost_job],4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[emb_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                         <?
						 //$OtherDirectExpenses=$summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];

							//$OtherDirectExpenses_job_qty=($po_qty/($total_set_qnty*$order_price_per_dzn))*$OtherDirectExpenses;

						 ?>
                            <td width="80" valign="top">9</td>
                            <td width="380" align="left" style=" padding-left:100px">

                            <table>
                            <tr>
                            <td width="180" style="font-weight:bold">Other Direct Expenses</td>

                            </tr>
                            </table>


                            <table border="1" class="rpt_table" rules="all">

                            <tr>
                            <td width="180" align="left">Lab Test</td>

                            </tr>

                            <tr>
                            <td width="180" align="left">Inspection</td>

                            </tr>

                            <tr>
                            <td width="180" align="left">Freight Cost</td>

                            </tr>

                            <tr>
                            <td width="180" align="left">Courier Cost</td>

                            </tr>

                             <tr>
                            <td width="180" align="left">Certificate Cost</td>

                            </tr>

                            <tr>
                            <td width="180" align="left">Garments Wash Cost</td>

                            </tr>

                            </table>
                            </td>
                            <td width="100" align="right" valign="top">
                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[OtherDirectExpenses],4); ?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[lab_test],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[inspection],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[freight],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[currier_pre_cost],4);?></td>
                            </tr>

                             <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[certificate_pre_cost],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[wash_cost],4);?></td>
                            </tr>

                            </table>
                            </td>


                            <td width="100" align="right" valign="top">
							<? //echo fn_number_format($summary_data[OtherDirectExpenses_job],4); ?>
                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[OtherDirectExpenses_job],4); ?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[lab_test_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[inspection_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[freight_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[currier_pre_cost_job],4);?></td>
                            </tr>

                             <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[certificate_pre_cost_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[wash_cost_job],4);?></td>
                            </tr>

                            </table>
                            </td>
                            <td width="180" align="right" valign="top">

                            <table>
                            <tr>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[OtherDirectExpenses_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[lab_test_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[inspection_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[freight_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[currier_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                             <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[certificate_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[wash_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            </table>
                            </td>
                        </tr>
                         <tr>
                            <td width="80">10</td>
                            <td width="380" align="left" style="font-weight:bold">Contributions/Value Additions (3-4)</td>
                            <?
							$Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
							$Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($Contribution_Margin,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($Contribution_Margin_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Contribution_Margin_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">11</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: CM Cost </td>
                            <td width="100" align="right"><? echo fn_number_format($summary_data[cm_cost],4); ?> </td>
                            <td width="100" align="right"><? echo fn_number_format($summary_data[cm_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[cm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">12</td>
                            <td width="380" align="left" style="font-weight:bold">Gross Profit (10-11)</td>
                            <?
							$Gross_Profit=$Contribution_Margin-$summary_data[cm_cost];
							$Gross_Profit_job=$Contribution_Margin_job-$summary_data[cm_cost_job];
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($Gross_Profit,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($Gross_Profit_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Gross_Profit_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>

                        <tr>
                            <td width="80">13</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Commercial Cost</td>

                            <td width="100" align="right"> <? echo fn_number_format( $summary_data[comm_cost],4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $summary_data[comm_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[comm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">14</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Operating Expensees</td>

                            <td width="100" align="right"><? echo fn_number_format( $summary_data[common_oh],4); ?> </td>
                            <td width="100" align="right"><? echo fn_number_format( $summary_data[common_oh_job],4); ?> </td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[common_oh_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>

                        <tr >
                            <td width="80">15</td>
                            <td width="380" align="left" style="font-weight:bold">Operating Profit/ Loss (12-(13+14))</td>
                            <?
							$OperatingProfitLoss=$Gross_Profit-($summary_data[comm_cost]+$summary_data[common_oh]);
							$OperatingProfitLoss_job=$Gross_Profit_job-($summary_data[comm_cost_job]+$summary_data[common_oh_job]);
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($OperatingProfitLoss,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($OperatingProfitLoss_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($OperatingProfitLoss_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                         <tr>
                            <td width="80">16</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Depreciation & Amortization </td>

                            <td width="100" align="right"> <? echo fn_number_format( $summary_data[depr_amor_pre_cost],4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $summary_data[depr_amor_pre_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[depr_amor_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>

                        <tr>
                        <?
						$interest_expense=$NetFOBValue*$financial_para[$pre_costing_date][interest_expense]/100;
						$income_tax=$NetFOBValue*$financial_para[$pre_costing_date][income_tax]/100;
						$interest_expense_job=$NetFOBValue_job*$financial_para[$pre_costing_date][interest_expense]/100;
						$income_tax_job=$NetFOBValue_job*$financial_para[$pre_costing_date][income_tax]/100;
						?>
                            <td width="80">17</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Interest </td>

                            <td width="100" align="right"> <? echo fn_number_format( $interest_expense,4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $interest_expense_job,4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($interest_expense_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                         <tr>
                            <td width="80">18</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Income Tax</td>

                            <td width="100" align="right"> <? echo fn_number_format( $income_tax,4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $income_tax_job,4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($income_tax_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <?
							$Netprofit=$OperatingProfitLoss-($summary_data[depr_amor_pre_cost]+$interest_expense+$income_tax);
							$Netprofit_job=$OperatingProfitLoss_job-($summary_data[depr_amor_pre_cost_job]+$interest_expense_job+$income_tax_job);
							?>
                            <td width="80">19</td>
                            <td width="380" align="left" style="font-weight:bold">Net Profit (15-(16+17+18))</td>

                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit,4); ?> </td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Netprofit_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        </table>
         </div>
      <?
	//End all summary report here -------------------------------------------



	//2	All Fabric Cost part here-------------------------------------------
		$sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active
		from wo_pre_cost_fabric_cost_dtls
		where job_no=".$txt_job_no." and is_deleted=0 and status_active=1";
		$data_array=sql_select($sql);

		$knit_fab="";
		$woven_fab="";

		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;

		$i=1;
		$j=1;
		foreach( $data_array as $row ) {
			$uom=$unit_of_measurement[$row[csf("uom")]];
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];

            if($row[csf("fab_nature_id")]==2){//knit fabrics
			    $i++;
				$totalConsKnit=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$totalAmountKnit=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];

                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($totalConsKnit,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($totalAmountKnit,4).'</td>
                </tr>';
				if($row[csf("uom")]==1){
					$DznConsKnitSubTotalPcs += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalPcs += $totalConsKnit;
					$DznAmountKnitSubTotalPcs+=$amount;
					$TotalAmountKnitSubTotalPcs+=$totalAmountKnit;
				 }
                 if($row[csf("uom")]==12){
					$DznConsKnitSubTotalKg += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalKg += $totalConsKnit;
					$DznAmountKnitSubTotalKg+=$amount;
					$TotalAmountKnitSubTotalKg+=$totalAmountKnit;
				 }
				 if($row[csf("uom")]==23){
					$DznConsKnitSubTotalMtr += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalMtr += $totalConsKnit;
					$DznAmountKnitSubTotalMtr+=$amount;
					$TotalAmountKnitSubTotalMtr+=$totalAmountKnit;
				 }
				 if($row[csf("uom")]==27){
					$DznConsKnitSubTotalYds += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalYds += $totalConsKnit;
					$DznAmountKnitSubTotalYds+=$amount;
					$TotalAmountKnitSubTotalYds+=$totalAmountKnit;
				 }
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountKnit;

				 $GrandTotalFabricDznAmount+=$amount;
				 $GrandTotalFabricAmount+=$totalAmountKnit;


			}

			if($row[csf("fab_nature_id")]==3){//woven fabrics
			    $j++;
			    $totalConsWoven=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$totalAmountWoven=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];

				$amount=$row[csf("avg_cons")]*$row[csf("rate")];

                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($totalConsWoven,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($totalAmountWoven,4).'</td>
                </tr>';

				if($row[csf("uom")]==1){
					$DznConsWovenSubTotalPcs += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalPcs += $totalConsWoven;
					$DznAmountWovenSubTotalPcs+=$amount;
					$TotalAmountWovenSubTotalPcs+=$totalAmountWoven;
				 }
                 if($row[csf("uom")]==12){
					$DznConsWovenSubTotalKg += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalKg += $totalConsWoven;
					$DznAmountWovenSubTotalKg+=$amount;
					$TotalAmountWovenSubTotalKg+=$totalAmountWoven;
				 }
				 if($row[csf("uom")]==23){
					$DznConsWovenSubTotalMtr += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalMtr += $totalConsWoven;
					$DznAmountWovenSubTotalMtr+=$amount;
					$TotalAmountWovenSubTotalMtr+=$totalAmountWoven;
				 }
				 if($row[csf("uom")]==27){
					$DznConsWovenSubTotalYds += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalYds += $totalConsWoven;
					$DznAmountWovenSubTotalYds+=$amount;
					$TotalAmountWovenSubTotalYds+=$totalAmountWoven;
				 }
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountWoven;

				 $GrandTotalFabricDznAmount+=$amount;
				 $GrandTotalFabricAmount+=$totalAmountWoven;
			}
        }
		if($DznConsKnitSubTotalPcs>0){
				$i++;
		}
		if($DznConsKnitSubTotalKg>0){
				$i++;
		}
		if($DznConsKnitSubTotalMtr>0){
				$i++;
		}
		if($DznConsKnitSubTotalYds>0){
				$i++;
		}

		if($DznConsWovenSubTotalPcs>0){
			$j++;
		}
		if($DznConsWovenSubTotalKg>0){
			$j++;
		}
		if($DznConsWovenSubTotalMtr>0){
			$j++;
		}
		if($DznConsWovenSubTotalYds>0){
			$j++;
		}
		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Total Cons</td>
							<td width="100">UOM</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)/Dzn</td>
							<td width="100">Tot.Amount (USD)</td>
						</tr>'.$knit_fab;
		if($DznConsWovenSubTotalPcs>0 || $DznConsWovenSubTotalKg>0 || $DznConsWovenSubTotalMtr>0 || $DznConsWovenSubTotalYds>0){
		$woven_fab= '<tr><td colspan="9">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
		}

		//knit fabrics table here
		if($DznConsKnitSubTotalPcs>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Pcs)</td>
							<td align="right">'.fn_number_format($DznConsKnitSubTotalPcs,4).'</td>
							<td align="right">'.fn_number_format($TotalConsKnitSubTotalPcs,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.fn_number_format($DznAmountKnitSubTotalPcs,4).'</td>
							<td align="right">'.fn_number_format($TotalAmountKnitSubTotalPcs,4).'</td>
						</tr>';
		}
		if($DznConsKnitSubTotalKg>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Kg)</td>
							<td align="right">'.fn_number_format($DznConsKnitSubTotalKg,4).'</td>
							<td align="right">'.fn_number_format($TotalConsKnitSubTotalKg,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.fn_number_format($DznAmountKnitSubTotalKg,4).'</td>
							<td align="right">'.fn_number_format($TotalAmountKnitSubTotalKg,4).'</td>
						</tr>';
		}
		if($DznConsKnitSubTotalMtr>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Mtr)</td>
							<td align="right">'.fn_number_format($DznConsKnitSubTotalMtr,4).'</td>
							<td align="right">'.fn_number_format($TotalConsKnitSubTotalMtr,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.fn_number_format($DznAmountKnitSubTotalMtr,4).'</td>
							<td align="right">'.fn_number_format($TotalAmountKnitSubTotalMtr,4).'</td>
						</tr>';
		}
		if($DznConsKnitSubTotalYds>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Yds)</td>
							<td align="right">'.fn_number_format($DznConsKnitSubTotalYds,4).'</td>
							<td align="right">'.fn_number_format($TotalConsKnitSubTotalYds,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.fn_number_format($DznAmountKnitSubTotalYds,4).'</td>
							<td align="right">'.fn_number_format($TotalAmountKnitSubTotalYds,4).'</td>
						</tr>';
		}
		if($zero_value==1){
		   echo $knit_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $knit_fab;
			}
			else{
				echo "";
			}
		}

		//woven fabrics table here
		if($DznConsWovenSubTotalPcs>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Pcs)</td>
						<td align="right">'.fn_number_format($DznConsWovenSubTotalPcs,4).'</td>
						<td align="right">'.fn_number_format($TotalConsWovenSubTotalPcs,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountWovenSubTotalPcs,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountWovenSubTotalPcs,4).'</td>
					</tr>';
		}
		if($DznConsWovenSubTotalKg>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Kg)</td>
						<td align="right">'.fn_number_format($DznConsWovenSubTotalKg,4).'</td>
						<td align="right">'.fn_number_format($TotalConsWovenSubTotalKg,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountWovenSubTotalKg,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountWovenSubTotalKg,4).'</td>
					</tr>';
		}
		if($DznConsWovenSubTotalMtr>0){

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Mtr)</td>
						<td align="right">'.fn_number_format($DznConsWovenSubTotalMtr,4).'</td>
						<td align="right">'.fn_number_format($TotalConsWovenSubTotalMtr,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountWovenSubTotalMtr,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountWovenSubTotalMtr,4).'</td>
					</tr>';
		}
		if($DznConsWovenSubTotalYds>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Yds)</td>
						<td align="right">'.fn_number_format($DznConsWovenSubTotalYds,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountWovenSubTotalYds,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountWovenSubTotalYds,4).'</td>
						<td align="right">'.fn_number_format($DznAmountWovenSubTotalYds,4).'</td>
					</tr>';
		}

   		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total</td>
						<td align="right"></td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format(($GrandtotalDznAmount),4).'</td>
						<td align="right">'.fn_number_format(($GrandtotalAmount),4).'</td>
					</tr></table></div>';
		if($zero_value==1){
			echo $woven_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $woven_fab;
			}
			else{
				echo "";
			}
		}
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
		//$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, min(cons_ratio) as cons_ratio , sum(cons_qnty) as cons_qnty,sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
		//$data_array=sql_select($sql);
		if($zero_value==1){
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($YarnData)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qty</td>
                    <td width="100">Total Qty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount (USD)</td>
                </tr>
			<?
            $TotalDznQty = 0;
			$TotalQty = 0;
			$TotalDznAmount = 0;
			$TotalAmount = 0;
			foreach( $YarnData as $index=>$row ){
				$des=explode("_",str_replace("'","",$index));
				$item_descrition = $lib_yarn_count[$des[0]]." ".$composition[$des[1]]." ".$des[2]."% ".$color_library[$des[4]]." ".$yarn_type[$des[3]];
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row["dznqty"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["qty"],4); ?></td>
                    <td align="right"><? echo fn_number_format($des[5],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["dznamount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                </tr>
            <?
				 $TotalDznQty += $row["dznqty"];
				 $TotalQty += $row["qty"];
				 $TotalDznAmount += $row["dznamount"];
				 $TotalAmount += $row["amount"];

				 $GrandTotalFabricDznAmount+=$row["dznamount"];
				 $GrandTotalFabricAmount+=$row["amount"];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznQty,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalQty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?
	  }
	  else{
		  if($totYarn>0){
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($YarnData)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount (USD)</td>
                </tr>
			<?
			$TotalDznQty = 0;
			$TotalQty = 0;
			$TotalDznAmount = 0;
			$TotalAmount = 0;
			foreach( $YarnData as $index=>$row ){
				$des=explode("_",str_replace("'","",$index));
				$item_descrition = $lib_yarn_count[$des[0]]." ".$composition[$des[1]]." ".$des[2]."% ".$color_library[$des[4]]." ".$yarn_type[$des[3]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row["dznqty"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["qty"],4); ?></td>
                    <td align="right"><? echo fn_number_format($des[5],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["dznamount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                </tr>
            <?
				 $TotalDznQty += $row["dznqty"];
				 $TotalQty += $row["qty"];
				 $TotalDznAmount += $row["dznamount"];
				 $TotalAmount += $row["amount"];

				 $GrandTotalFabricDznAmount+=$row["dznamount"];
				 $GrandTotalFabricAmount+=$row["amount"];
            }
          ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznQty,4); ?></td>
                     <td align="right"><? echo fn_number_format($TotalQty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   /*	$sql = "select a.id,a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id
			where a.job_no=".$txt_job_no." ";
	$data_array=sql_select($sql);*/
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Total Cons</td>
                    <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Total Amount (USD)</td>
                </tr>
            <?
            $TotalDznAmount =0;
			$TotalAmount =0;
            foreach( $ConvData as $index=>$row ){

			?>
                <tr>
                    <td align="left"><? echo $row['item_descrition']; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
                    <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];

				 $GrandTotalFabricDznAmount+=$row["amount"];
				 $GrandTotalFabricAmount+=$row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td  align="left" colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else{
		if($totConv>0){
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Total Cons</td>
                     <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Total Amount (USD)</td>
                </tr>
            <?
           $TotalDznAmount =0;
		   $TotalAmount =0;
            foreach( $ConvData as $index=>$row){

			?>
                <tr>
                    <td align="left"><? echo $row['item_descrition']; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
                    <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];

				 $GrandTotalFabricDznAmount+=$row["amount"];
				 $GrandTotalFabricAmount+=$row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
      </div>
    <?
		}
		else{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------
   /*	$sql = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active
			from wo_pre_cost_trim_cost_dtls
			where job_no=".$txt_job_no." order by id";
	$data_array=sql_select($sql);*/
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmount=0;
			$TotalAmount=0;
            foreach( $TrimData as $index=>$row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                     <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totTrim>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                     <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmount=0;
			$TotalAmount=0;
            foreach( $TrimData as $index=>$row)
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	//start	Embellishment Details part report here -------------------------------------------
    	/*$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);*/
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmount=0;
		    $TotalAmount =0;
            foreach( $EmbData as $index=>$row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totEmb>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
           $TotalDznAmount=0;
		   $TotalAmount =0;
            foreach( $EmbData as $index=>$row  )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
    <?

		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
   /*	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);*/
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAount=0;
		   $TotalAount =0;
            foreach( $CommarData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["amount"];
				 $TotalAount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommar>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAount=0;
		   $TotalAount =0;
            foreach( $CommarData as $index=>$row  )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["amount"];
				 $TotalAount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                     <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	/*$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
			from  wo_pre_cost_commiss_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);*/
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAount = 0;
		    $TotalAount = 0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["commission_amount"];
				 $TotalAount += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAount = 0;
		    $TotalAount = 0;
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["commission_amount"];
				 $TotalAount += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	?>
    <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:300px;" rules="all">
            <label><b>CM Details</b></label>
                <tr>
                    <td width="150">CPM (TK)</td>
                    <td width="150" title="Costing Date-<? echo $pre_costing_date;?>"><? echo $financial_para[$pre_costing_date][cost_per_minute] ?></td>

                 </tr>
                  <tr>
                    <td width="150">SMV</td>
                    <td width="150"><? echo $sew_smv .", ".$cut_smv ?></td>
                 </tr>
                 <tr>
                    <td width="150">EFF %</td>
                    <td width="150"><? echo $sew_effi_percent .", ".$cut_effi_percent; ?></td>
                 </tr>

  </table>
  		  <?
     	 // image show here  -------------------------------------------
		$sqlData = "select id,master_tble_id,image_location from common_photo_library where master_tble_id=".$txt_job_no."";
		$data_array_img=sql_select($sqlData);
		$path=($path)?$path:'../../';
 	  ?>
          <div style=" margin-left:310px;margin-top:-70px" >
          	<? foreach($data_array_img AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' border="1" height='97' width='89' />
            <?  } ?>
          </div>
    <br/>

 	<?
	echo signature_table(109, $cbo_company_name, "860px");
	exit();
}

if($action=="preCostRpt5")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$presentation_type=str_replace("'","",$presentation_type);
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	    $txt_costingd=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
		if($db_type==0)
		{
			$costing_dateP=change_date_format($txt_costingd, "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$costing_dateP=change_date_format($txt_costingd, "yyyy-mm-dd", "-");
		}
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date_cond=''; else $txt_costing_date_cond=" and b.costing_date='".$txt_costing_date."'";
	//array for display name
	 $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	 $comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	 $color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	 //====================
	 $cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$cbo_company_name  and variable_list=22 and status_active=1 and is_deleted=0");
	if($cm_cost_method_based_on=="")
	{
		$cm_cost_method_based_on=1;
	}
	$costing_date="";
	if($cm_cost_method_based_on==1){

		$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
		if($db_type==0)
		{
			$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
			$costing_dateP=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1);
			$costing_dateP=change_date_format($txt_costing_date);
		}
	}

	if($cm_cost_method_based_on==2){
		$min_shipment_sql=sql_select("select job_no_mst, min(shipment_date) as min_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_shipment_date="";
		foreach($min_shipment_sql as $row){
			$min_shipment_date=$row[csf('min_shipment_date')];
		}
		if($db_type==0)
		{
		   $costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-",1)	;
		}
	}
	if($cm_cost_method_based_on==3){
		$max_shipment_sql=sql_select("select job_no_mst, max(shipment_date) as max_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_shipment_date=$row[csf('max_shipment_date')];
		}

		if($db_type==0)
		{
		   $costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-",1)	;
		}
	}
	if($cm_cost_method_based_on==4){

		$max_shipment_sql=sql_select("select job_no_mst, min(pub_shipment_date) as min_pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$min_pub_shipment_date=$row[csf('min_pub_shipment_date')];
		}

		if($db_type==0)
		{
		   $costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
		}
	}
	if($cm_cost_method_based_on==5){

		$max_shipment_sql=sql_select("select job_no_mst, max(pub_shipment_date) as max_pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_pub_shipment_date=$row[csf('max_pub_shipment_date')];
		}

		if($db_type==0)
		{
		   $costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
		}
	}
	 //================


	 if($db_type==0)
	{
		$sqlcpm=sql_select("select interest_expense,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1");
	}
	if($db_type==2)
	{
		 $sqlcpm=sql_select("select interest_expense,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");
	}

	$cpm='';$interest_expense='';
	foreach($sqlcpm as $sqlcpmrow)
	{
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
		$interest_expense=$sqlcpmrow[csf('interest_expense')];
	}

	 $gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	 $gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no."   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
	$po_qty+=$sql_po_row[csf('order_quantity')];
	$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
	$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
	}
	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;

	if($db_type==0)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.inserted_by,b.sew_smv,b.sew_effi_percent,b.incoterm,b.exchange_rate,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date_cond order by a.job_no";
	}
	if($db_type==2)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.inserted_by,b.sew_smv,b.sew_effi_percent,b.incoterm,b.exchange_rate,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	}

	$data_array=sql_select($sql);

	//echo $print_option_id;die;
	//image----
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
    $image_location=return_field_value("image_location","common_photo_library","master_tble_id=".$txt_job_no."");
	ob_start();//part 0;
	if($presentation_type==2)
		$path="../../../";
	else
		$path="../../";
	?>
    <div style="width:850px;">
		<table width="100%" border="0">
        	<tr>
            	<td rowspan="3" width="25%">
                    <?
                    if ($img_path) { ?>
                        <img  src='<? echo $img_path.$imge_arr[$cbo_company_name]; ?>' height='80' />
                    <?
                    } else { ?>
                        <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='80' />
                    <?
                    }
                    ?>

                </td>
            	<td align="center"><b style="font-size:20px;"><? echo $comp[$cbo_company_name]; ?></b></td>
            	<td rowspan="3" width="25%" align="right">
                    <?
                    if ($img_path) { ?>
                        <img  src='<? echo $img_path.$image_location; ?>' height='80' />
                    <?php
                    } else { ?>
                        <img  src='<? echo $path.$image_location; ?>' height='80' />
                    <?
                    }
                    ?>
                </td>
            </tr>
        	<tr>
            	<td align="center"><b style="font-size:14px;">PRE-COSTING SHEET</b></td>
            </tr>
           <tr>
                <td align="center">

					<? if( $data_array[0][csf("approved")]==1){echo "<div style='font-size:18px; color:#F00; background:#CCC;'>THIS COST SHEET IS APPROVED </div>";

					} else {echo "&nbsp;";}

					$prepared_app_data = $data_array[0][csf("inserted_by")];

					?>

                </td>
            </tr>

        </table>
    </div>
	<?
	$uom="";
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;

		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_ref.=$val[csf('grouping')].",";
			$job_in_file.=$val[csf('file_no')].",";

		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);

		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref)
		{
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="130">Job Number</td>
                        <td width="100"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="130">Buyer</td>
                        <td width="110"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; $buyer_id=$row[csf("buyer_name")];?></b></td>
                        <td>Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}

						?>
                        <td width="160"><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                         <td>Costing Date</td><td><? echo $costing_dateP;?></td>
                        <td>Job Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo fn_number_format($row[csf("job_quantity")])." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
                        <td>Plan Cut Qnty [Cut % <? echo fn_number_format((($po_plun_cut_qty/$total_set_qnty-$row[csf("job_quantity")])/$row[csf("job_quantity")])*100,2);?>]</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo fn_number_format($po_plun_cut_qty/$total_set_qnty)." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>

                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo fn_number_format($row[csf("avg_unit_price")],2); ?> USD</b></td>
                    </tr>

                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Woven Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_fin_req_yds")]; ?>(Yds)</b></td>

                        <td>Order Value</td>
                        <td><b><? echo fn_number_format($row[csf("job_quantity")]*$row[csf("avg_unit_price")],2); ?></b></td>
                    </tr>
                    <tr>
                    	<td>Knit Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_fin_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
                        <td>Incoterm</td>
                        <td><b><? echo $incoterm[$row[csf("incoterm")]]; ?></b></td>
                    </tr>
                    <tr>
                        <td>GSM</td>
                        <td><b><? echo $gsm_weight_top.",".$gsm_weight_bottom ?></b></td>
                        <td>SMV</td>
                        <td><b><? $sew_smv=$row[csf("sew_smv")]; echo fn_number_format($sew_smv,2); ?> </b></td>
                        <td>Efficiency %</td>
                        <td colspan="1"><b><? echo $sew_effi_percent=$row[csf("sew_effi_percent")] ?> </b></td>
                    </tr>
                    <tr>
                        <td>Exchange Rate</td>
                        <td><b><? echo $exchange_rate=$row[csf("exchange_rate")]; ?></b></td>
                        <td>Budget SAH</td>
                        <td><b><? echo fn_number_format(($row[csf("sew_smv")]*$row[csf("job_quantity")])/60,2); ?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo $pulich_ship_date;?></b></td>
                    </tr>
                    <tr>
                        <td>Internal Ref</td>
                        <td colspan="1"><b><? echo ltrim($ref_cond,", "); ?> </b></td>
                        <td>File No</td>
                        <td colspan="1"><b><? echo $file_cond; ?></b></td>
                        <td>Cost Per Unit As Budget </td>
                        <td id="price_as_par_budget_td"><? $job_quantity=$row[csf("job_quantity")]; ?></td>
                    </tr>
                </table>
            <?
			$part[0]=ob_get_contents();ob_end_clean();
			ob_start();//part 1;

			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];

	}//end first foearch


	//start	all summary report here -------------------------------------------
	$sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche,interest_cost,interest_percent,incometax_cost,incometax_percent,deffdlc_cost,deffdlc_percent
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;

	$interest_cost=0;
	//$interest_percent=0;

	$incometax_cost=0;
	//$incometax_percent=0;

	$deffdlc_cost=0;
	//$deffdlc_percent=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			$fabric_cost=$row[csf("fabric_cost")];
			$trims_cost=$row[csf("trims_cost")];
			$embel_cost=$row[csf("embel_cost")];
			$comm_cost=$row[csf("comm_cost")];
			$commission=$row[csf("commission")];
			$lab_test=$row[csf("lab_test")];
			$inspection=$row[csf("inspection")];
			$cm_cost=$row[csf("cm_cost")];
			$freight=$row[csf("freight")];
			$currier_pre_cost=$row[csf("currier_pre_cost")];
			$certificate_pre_cost=$row[csf("certificate_pre_cost")];
			$common_oh=$row[csf("common_oh")];

			$interest_cost=$row[csf("interest_cost")];
			//$common_oh=$row[csf("common_oh")];

			$incometax_cost=$row[csf("incometax_cost")];
			//$common_oh=$row[csf("common_oh")];

			$deffdlc_cost=$row[csf("deffdlc_cost")];
			//$common_oh=$row[csf("common_oh")];



				$sl=$sl+1;
  				$others_cost_value=$row[csf("total_cost")]-$row[csf("cm_cost")]-$row[csf("freight")]-$row[csf("comm_cost")]-$row[csf("commission")];
			    $costOfFabriTrimsEmbWash=($row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]);

				if($zero_value==1)
				{
					$price_dzn=$row[csf("price_dzn")];

	?>
	<!--                <tr>
						<td><?  //echo $sl; ?></td>
						<td align="left"><b>Order Price/<?  //echo $costing_for; ?></b></td>
						<td></td>
						<td align="right"><b><?  //echo fn_number_format($row[csf("price_dzn")],4);$price_dzn=$row[csf("price_dzn")];//$avg_unit_price*$order_price_per_dzn ?></b></td>
						<td align="center"><?  //echo "100.00%"; ?></td>
					</tr>
	-->

					<tr>
						<td><? echo $sl; ?></td>
						<td align="left">Gross FOB Value/ DZN</td>
						<td align="right">&nbsp;</td>
						<td align="right"><? echo $grfobv_dzn=fn_number_format($avg_unit_price*12,2); ?></td>
						<td align="right">100.00%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Less: Commision/ DZN</td>
						<td align="right">
							<?
							$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
									from  wo_pre_cost_commiss_cost_dtls
									where job_no=".$txt_job_no." and status_active=1";
							$commi_data_array=sql_select($sql);
							foreach( $commi_data_array as $rows )
							{
								$total_comm_amount += $rows[csf("commission_amount")];
							}
							echo fn_number_format($total_comm_amount,4);
							?>

						</td>
						<td align="right"></td>
						<td align="right"><? echo fn_number_format(($total_comm_amount/$grfobv_dzn)*100,2);?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Net FOB Value (1-2)</td>
						<td align="right">&nbsp;</td>
						<td align="right"><? echo fn_number_format($net_fob_value=$grfobv_dzn-$total_comm_amount,2); ?></td>
						<td align="right">&nbsp;</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">All Fabric Cost</td>
						<td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
						<td align="right" rowspan="13">&nbsp;</td>
						<td align="right"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
					</tr>

					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Trims Cost</td>
						<td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Embellishment Cost</td>
						<td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Gmts Wash</td>
						<td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Commercial Cost</td>
						<td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
					</tr>

	<!--                <tr>
						<td><? //echo ++$sl; ?></td>
						<td align="left">Commission Cost</td>
						<td align="right"><? //echo fn_number_format($row[csf("commission")],4); ?></td>
						<td align="center"><? //echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
					</tr>

	-->
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Lab Test</td>
						<td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Inspection Cost</td>
						<td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Gmts Freight Cost</td>
						<td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Currier Cost</td>
						<td align="right"><? echo fn_number_format($row[csf("currier_pre_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("currier_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Certificate Cost </td>
						<td align="right"><? echo fn_number_format($row[csf("certificate_pre_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("certificate_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Deffd.Lc.Cost (<? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%)</td>
						<td align="right"><? echo fn_number_format($row[csf("deffdlc_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Tax (<? echo fn_number_format($row[csf("incometax_percent")],2); ?>%)</td>
						<td align="right"><? echo fn_number_format($row[csf("incometax_cost")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("incometax_percent")],2); ?>%</td>
					</tr>


	<!--                <tr>
						<td><? //echo ++$sl; ?></td>
						<td align="left">Office OH </td>
						<td align="right"><? //echo fn_number_format($row[csf("common_oh")],4); ?></td>
						<td align="center"><? //echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
					</tr>
	-->
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Finance Charge (<? echo fn_number_format($row[csf("interest_percent")],2); ?>% )</td>
						<td align="right"><? echo fn_number_format($row[csf("interest_cost")],4);; ?></td>
						<td align="right"><? echo fn_number_format($row[csf("interest_percent")],2); ?>%</td>
					</tr>

					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left"><b>Total Material & Service Cost (4:16)</b></td>
						<td>&nbsp;</td>
						<td align="right"><b><?
						$total_material_cost=($row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("comm_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("interest_cost")]+$row[csf("incometax_cost")]+$row[csf("deffdlc_cost")]);

						//$total_material_cost=$row[csf("total_cost")]-$row[csf("cm_cost")];
						$total_material_cost_percent=$row[csf("fabric_cost_percent")]+$row[csf("trims_cost_percent")]+$row[csf("embel_cost_percent")]+$row[csf("wash_cost_percent")]+$row[csf("comm_cost_percent")]+$row[csf("lab_test_percent")]+$row[csf("inspection_percent")]+$row[csf("freight_percent")]+$row[csf("currier_percent")]+$row[csf("certificate_percent")]+$row[csf("interest_percent")]+$row[csf("incometax_percent")]+$row[csf("deffdlc_percent")];


						echo fn_number_format($total_material_cost,2); ?></b></td>
						<td align="right"><b><? //$total_material_cost_percent=$row[csf("total_cost_percent")]-$row[csf("cm_cost_percent")];
						echo fn_number_format($total_material_cost_percent,2); ?>%</b></td>
					</tr>

					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Contribution Margin/Dzn (3-17)</td>
						<td>&nbsp;</td>
						<td align="right"><? $cm_value_contribution_margine=$net_fob_value-$total_material_cost; echo fn_number_format($cm_value_contribution_margine,2); ?></td>
						<td align="right">&nbsp;</td>
					</tr>

	<!--                 <tr>
						<td><? //echo ++$sl; ?></td>
						<td align="left">CM Cost/Dzn</td>
						<td>&nbsp;</td>
						<td align="right"><? //echo fn_number_format($row[csf("cm_cost")],4); ?></td>
						<td align="center"><? //echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
					</tr>
	-->


					<tr>
						<td><?  echo ++$sl; ?></td>
						<td align="left">Factory Overhead (FOH)/Dzn</td>
						<td>&nbsp;</td>
						<td align="right"><?
						$foh=$row[csf("cm_cost")];echo fn_number_format($foh,2);
						//echo $foh=fn_number_format(($sew_smv*$cpm*12)+(($sew_smv*$cpm*12)*(100-$sew_effi_percent))/100,4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Margin/<? echo $costing_for; ?> (18-19)</td>
						<td>&nbsp;</td>
						<td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh;echo  fn_number_format($margin_dozon,3);?></td>
						<td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
						<td>&nbsp;</td>
						<td align="right"><? $margin_pcs=$margin_dozon/12;echo fn_number_format($margin_pcs,3) ?></td>
						<td align="right"><? echo fn_number_format($margin_pcs/($grfobv_dzn/12)*100,2);?>%</td>
					</tr>
					<tr bgcolor="#CCCCCC">
						<td><? echo ++$sl; ?></td>
						<td align="left">EPM (Per Pcs CM/SMV)</td>
						<td>&nbsp;</td>
						<td align="right"><? echo $margin_pcs=fn_number_format(($cm_value_contribution_margine/12)/$sew_smv,3); ?></td>
						<td align="right">&nbsp;</td>
					</tr>

					<tr bgcolor="#CCCCCC">
						<td><? echo ++$sl; ?></td>
						<td align="left">CPM (Cost Per Minute)</td>
						<td>&nbsp;</td>
						<td align="right"><? echo fn_number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
						<td align="right">&nbsp;</td>
					</tr>

					<tr bgcolor="#CCCCCC">
						<td><? echo ++$sl; ?></td>
						<td align="left">Contribution Margin %</td>
						<td>&nbsp;</td>
						<td align="right">&nbsp;</td>
						<td align="right"><? echo fn_number_format($cm_value_contribution_margine/$net_fob_value*100,2);?>%</td>
					</tr>



					<?
					/*?>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
						<td>&nbsp;</td>
						<td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
						<td align="right"></td>
					</tr>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
						<td>&nbsp;</td>
						<td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
						<td align="center"></td>
					</tr>
					<?*/
					?>

				<?
					}
					else
					{
						$price_dzn=$row[csf("price_dzn")];
						?>

	<!--                 <tr>
						<td><? //echo $sl; ?></td>
						<td align="left"><b>Order Price/<? //echo $costing_for; ?></b></td>
						<td></td>
						<td align="right"><b><? //echo fn_number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
						<td align="center"><? //echo "100.00%"; ?></td>
					</tr>

	-->



                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left">Gross FOB Value/ DZN</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $grfobv_dzn=fn_number_format($avg_unit_price*12,4); ?></td>
                    <td align="right">100.00%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commision/ DZN</td>
                    <td align="right">
                        <?
                        $sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
                                from  wo_pre_cost_commiss_cost_dtls
                                where job_no=".$txt_job_no." and status_active=1";
                        $commi_data_array=sql_select($sql);
						foreach( $commi_data_array as $rows )
						{
							 $total_comm_amount += $rows[csf("commission_amount")];
						}
						echo fn_number_format($total_comm_amount,4);
						?>

                    </td>
                    <td align="right"></td>
                    <td align="right"><? echo fn_number_format(($total_comm_amount/$grfobv_dzn)*100,2);?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $net_fob_value=$grfobv_dzn-$total_comm_amount; ?></td>
                    <td align="right">&nbsp;</td>
                </tr>



                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{

				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}

				if($row[csf("currier_pre_cost")]!=0)
				{
				?>

                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("currier_pre_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("currier_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("certificate_pre_cost")]!=0)
				{
				?>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("certificate_pre_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("certificate_percent")],2); ?>%</td>
                 </tr>

                 <?
				}
				if($row[csf("deffdlc_cost")]!=0)
				{
				?>

                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Deffd.Lc.Cost (<? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("deffdlc_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("incometax_cost")]!=0)
				{
				 ?>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo fn_number_format($row[csf("incometax_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("incometax_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("incometax_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				 ?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo fn_number_format($row[csf("interest_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_percent")],2); ?>%</td>
                 </tr>


                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Material & Service Cost (4:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><?
					$total_material_cost=($row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("comm_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("interest_cost")]+$row[csf("incometax_cost")]+$row[csf("deffdlc_cost")]);

					//$total_material_cost=$row[csf("total_cost")]-$row[csf("cm_cost")];
					echo fn_number_format($total_material_cost,2); ?></b></td>
                    <td align="center"><b><?

					//$total_material_cost_percent=$row[csf("total_cost_percent")]-$row[csf("cm_cost_percent")];
					$total_material_cost_percent=$row[csf("fabric_cost_percent")]+$row[csf("trims_cost_percent")]+$row[csf("embel_cost_percent")]+$row[csf("wash_cost_percent")]+$row[csf("comm_cost_percent")]+$row[csf("lab_test_percent")]+$row[csf("inspection_percent")]+$row[csf("freight_percent")]+$row[csf("currier_percent")]+$row[csf("certificate_percent")]+$row[csf("interest_percent")]+$row[csf("incometax_percent")]+$row[csf("deffdlc_percent")];
					echo fn_number_format($total_material_cost_percent,2); ?>%</b></td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/Dzn</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $cm_value_contribution_margine=$row[csf("price_dzn")]-$total_material_cost; echo fn_number_format($cm_value_contribution_margine,2); ?></td>
                    <td align="center">&nbsp;</td>
                 </tr>
                <?
                if($row[csf("cm_cost")]!=0)
				{
					?>
					<tr>
						<td><? echo ++$sl; ?></td>
						<td align="left">Factory Overhead (FOH)/Dzn</td>
                        <td>&nbsp;</td>
						<td align="right"><? echo fn_number_format($row[csf("cm_cost")],2); ?></td>
						<td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
					 </tr>
					 <?
				}
				?>
                <tr>

                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (16-17)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh;echo  fn_number_format($margin_dozon,2);?></td>
                    <td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>


                </tr>
                <?
				/*?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <?*/
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],2); ?></td>
                    <td align="right"></td>
                </tr>


                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo $margin_pcs=fn_number_format(($cm_value_contribution_margine/12)/$sew_smv,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>

                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM (Cost Per Minute)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>

                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin %</td>
                    <td>&nbsp;</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($cm_value_contribution_margine/$net_fob_value*100,2);?>%</td>
                </tr>










                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
        //End all summary report here -------------------------------------------
		$part[1]=ob_get_contents();ob_end_clean();
		ob_start();//part 2;



	    $sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active   from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1";

		$data_array=sql_select($sql);
		$knit_fab="";$woven_fab="";
		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
            if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				}
				else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
				}
				$percent_to_order_value=$amount/$price_dzn*100;
				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					 <td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,2).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';

				$knit_subtotal_avg_cons += $row[csf("avg_cons")];
				$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
				if($row[csf("fabric_source")] !=2){
				$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
				}
				else{
					$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
				}
			}

			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				$percent_to_order_value=$amount/$price_dzn*100;
				$j++;
                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,2).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';

				$woven_subtotal_avg_cons += $row[csf("avg_cons")];
				$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
				$woven_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">

					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Avg. Fab. Cons/Dzn</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab= '<tr><td colspan="7">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
					/*$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg_amount,4).'</td>
					</tr>';*/
					if($zero_value==1)
					{
  		               echo $knit_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $knit_fab;
						}
						else
						{
							echo "";
						}

					}

		//woven fabrics table here
		$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg,4).'</td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg_amount,4).'</td>
					</tr>';*/
   					$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.fn_number_format(($woven_subtotal_amount+$knit_subtotal_amount),2).'</td>
						<td align="right">'.fn_number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
					</tr></table></div>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total (Avg)</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.fn_number_format(($fab_woven_req_yds_avg_amount+$fab_knit_req_kg_avg_amount),4).'</td>
					</tr></table></div>';*/
        // echo $woven_fab;
		 if($zero_value==1)
					{
  		               echo $woven_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $woven_fab;
						}
						else
						{
							echo "";
						}

					}
  		$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
				$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two,color,type_id, min(cons_ratio) as cons_ratio , sum(cons_qnty) as cons_qnty,sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no." and status_active=1 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
		$data_array=sql_select($sql);
		if($zero_value==1)
		{
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                   <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;  $total_avg_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	  $grand_total_amount +=$total_amount;
	  }
	  else
	  {
		  if($fabric_cost>0)
		  {
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                     <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	      $grand_total_amount +=$total_amount;
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql = "select a.id,a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id
			where a.job_no=".$txt_job_no." and a.status_active=1 ";
	$data_array=sql_select($sql);
	$conData=array();
	$totPro=array();
	foreach($data_array as $rows){
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['FABRIC_DESCRIPTION_ID']=$rows[csf('fabric_description_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['JOB_NO']=$rows[csf('job_no')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['CONS_PROCESS']=$rows[csf('cons_process')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['REQ_QNTY']=$rows[csf('req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['AVG_REQ_QNTY']=$rows[csf('avg_req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['CHARGE_UNIT']=$rows[csf('charge_unit')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['AMOUNT']=$rows[csf('amount')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['STATUS_ACTIVE']=$rows[csf('status_active')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['BODY_PART_ID']=$rows[csf('body_part_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['FAB_NATURE_ID']=$rows[csf('fab_nature_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['COLOR_TYPE_ID']=$rows[csf('color_type_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['FABRIC_DESCRIPTION']=$rows[csf('fabric_description')];
		$totPro[$rows[csf('cons_process')]]=$rows[csf('cons_process')];
	}
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Avg. Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
			$total_req_qnty=0;
			$total_avg_req_qnty=0;
			$total_charge_unit=0;
            foreach( $conData as $processId=>$idArr )
            {
			    $sub_total_amount=0;
				$sub_total_req_qnty=0;
				$sub_total_avg_req_qnty=0;
				$sub_total_charge_unit=0;
				foreach( $idArr as $id=>$row )
				{
				if($row[csf("fabric_description_id")] !=0)
				{
					$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}
				else
				{
					$item_descrition = "All Fabrics";
				}
				?>
					<tr>
						<td align="left"><? echo $item_descrition; ?></td>
						<td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
						<td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
				<?
				     $sub_total_amount+= $row[csf("amount")];
					 $sub_total_req_qnty+= $row[csf("req_qnty")];
				     $sub_total_avg_req_qnty+= $row[csf("avg_req_qnty")];
				     $sub_total_charge_unit+= $row[csf("charge_unit")];

					 $total_amount += $row[csf("amount")];
					 $total_req_qnty+= $row[csf("req_qnty")];
				     $total_avg_req_qnty+= $row[csf("avg_req_qnty")];
				     $total_charge_unit+= $row[csf("charge_unit")];
				}
				?>
                 <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Sub Total</td>
                    <td align="right"><? echo  fn_number_format( $sub_total_req_qnty,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo  fn_number_format($sub_total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_amount,2); ?></td>
                    <td align="right"><? echo  fn_number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <?
			}
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Conversion Total Cost</td>
                    <td align="right"><? //echo fn_number_format($total_req_qnty,4);?></td>
                    <td align="right"><? //echo fn_number_format($total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo fn_number_format($total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),2); ?></td>
                    <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($fabric_cost>0)
		{
	?>
      <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Avg. Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
			$total_req_qnty=0;
			$total_avg_req_qnty=0;
			$total_charge_unit=0;
            foreach( $conData as $processId=>$idArr )
            {
			    $sub_total_amount=0;
				$sub_total_req_qnty=0;
				$sub_total_avg_req_qnty=0;
				$sub_total_charge_unit=0;
				foreach( $idArr as $id=>$row )
				{
				if($row[csf("fabric_description_id")] !=0)
				{
					$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}
				else
				{
					$item_descrition = "All Fabrics";
				}
				?>
					<tr>
						<td align="left"><? echo $item_descrition; ?></td>
						<td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
						<td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
						<td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
				<?
				     $sub_total_amount+= $row[csf("amount")];
					 $sub_total_req_qnty+= $row[csf("req_qnty")];
				     $sub_total_avg_req_qnty+= $row[csf("avg_req_qnty")];
				     $sub_total_charge_unit+= $row[csf("charge_unit")];

					 $total_amount += $row[csf("amount")];
					 $total_req_qnty+= $row[csf("req_qnty")];
				     $total_avg_req_qnty+= $row[csf("avg_req_qnty")];
				     $total_charge_unit+= $row[csf("charge_unit")];
				}
				?>
                 <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Sub Total</td>
                    <td align="right"><? echo  fn_number_format( $sub_total_req_qnty,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo  fn_number_format($sub_total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_amount,2); ?></td>
                    <td align="right"><? echo  fn_number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <?
			}
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? //echo fn_number_format($total_req_qnty,4);?></td>
                    <td align="right"><? //echo fn_number_format($total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo fn_number_format($total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),2); ?></td>
                    <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------

  			$part[2]=ob_get_contents();ob_end_clean();
			ob_start();//part 3;


  	//start	Trims Cost part report here -------------------------------------------
   	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active
			from wo_pre_cost_trim_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($trims_cost>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------

 			$part[3]=ob_get_contents();ob_end_clean();
			ob_start();//part 4;


	//start	Embellishment Details part report here -------------------------------------------
    	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no=".$txt_job_no." and emb_name !=3";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($embel_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------

  			$part[4]=ob_get_contents();ob_end_clean();
			ob_start();//part 5;

  	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo fn_number_format($ccp,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
                 $tot_ccp+=$ccp;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($tot_ccp,2); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($comm_cost>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo fn_number_format($ccp,2);?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
				 $tot_ccp+=$ccp;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($tot_ccp,2); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------
  			$part[5]=ob_get_contents();ob_end_clean();
			ob_start();//part 6;


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
			from  wo_pre_cost_commiss_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>

                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],2); ?></td>
                    <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo fn_number_format($cca,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
                 $total_cca += $cca;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_cca,2); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($commission>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],2); ?></td>
                    <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo fn_number_format($cca,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
                 $total_cca += $cca;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_cca,2); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------
 			$part[6]=ob_get_contents();ob_end_clean();
			ob_start();//part 7;


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,wash_cost,currier_pre_cost,certificate_pre_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche,interest_cost,interest_percent,incometax_cost,incometax_percent,deffdlc_cost,deffdlc_percent
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>

                <tr>
                    <td align="left"s>Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],2); ?></td>
                    <td align="right"><? $ogw=($row[csf("wash_cost")]/$grfobv_dzn)*100; echo fn_number_format($ogw,2); ?>%</td>
                </tr>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],2); ?></td>
                    <td align="right"><? $olt=($row[csf("lab_test")]/$grfobv_dzn)*100; echo fn_number_format($olt,2); ?>%</td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],2); ?></td>
                    <td align="right"><? $oic=($row[csf("inspection")]/$grfobv_dzn)*100; echo fn_number_format($oic,2); ?>%</td>
                </tr>
                <tr>
                    <td align="left">Factory Overhead (FOH)/Dzn</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],2); ?></td>
                    <td align="right"><? $ofoh=($row[csf("cm_cost")]/$grfobv_dzn)*100; echo fn_number_format($ofoh,2); ?>%</td>
                </tr>
                <tr>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],2); ?></td>
                    <td align="right"><? $ogfc=($row[csf("freight")]/$grfobv_dzn)*100; echo fn_number_format($ogfc,2); ?>%</td>
                </tr>
                <tr>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("currier_pre_cost")],2); ?></td>
                    <td align="right"><? $ocrc=($row[csf("currier_pre_cost")]/$grfobv_dzn)*100; echo fn_number_format($ocrc,2); ?>%</td>
                </tr>
                <tr>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("certificate_pre_cost")],2); ?></td>
                    <td align="right"><? $ocfc=($row[csf("certificate_pre_cost")]/$grfobv_dzn)*100; echo fn_number_format($ocfc,2); ?>%</td>
                </tr>
  <!--
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? //echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right"><? //$ooh=($row[csf("common_oh")]/$grfobv_dzn)*100; echo fn_number_format($ooh,4); ?>%</td>
                </tr>
  -->
                <tr>
                    <td align="left">Deffd.Lc.Cost Charge (<? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("deffdlc_cost")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%</td>
                </tr>

                <tr>
                    <td align="left">Finance Charge (<? echo fn_number_format($row[csf("interest_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_cost")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td align="left">Tax(<? echo fn_number_format($row[csf("incometax_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("incometax_cost")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("incometax_percent")],2); ?>%</td>
                </tr>




            <?
                 $total_amount += $row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+($row[csf("cm_cost")])+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("deffdlc_cost")]+$row[csf("interest_cost")]+$row[csf("incometax_cost")];
                 $total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$row[csf("deffdlc_percent")]+$row[csf("interest_percent")]+$row[csf("incometax_percent")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_parcent,2);?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {

				if($row[csf("wash_cost")]>0)
				{
			?>
                <tr>
                    <td align="left"s>Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],2); ?></td>
                    <td align="right"><? $ogw=($row[csf("wash_cost")]/$grfobv_dzn)*100; echo fn_number_format($ogw,2); ?>%</td>
                </tr>
			<?
				}
				if($row[csf("lab_test")]>0)
				{
  			?>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],2); ?></td>
                    <td align="right"><? $olt=($row[csf("lab_test")]/$grfobv_dzn)*100; echo fn_number_format($olt,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("inspection")]>0)
				{
				?>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],2); ?></td>
                    <td align="right"><? $oic=($row[csf("inspection")]/$grfobv_dzn)*100; echo fn_number_format($oic,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("cm_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">Factory Overhead (FOH)/Dzn</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],2); ?></td>
                    <td align="right"><? $ofoh=($row[csf("cm_cost")]/$grfobv_dzn)*100; echo fn_number_format($ofoh,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("freight")]>0)
				{
				?>
                <tr>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],2); ?></td>
                    <td align="right"><? $ogfc=($row[csf("freight")]/$grfobv_dzn)*100; echo fn_number_format($ogfc,2); ?>%</td>
                </tr>
                 <?
				}



				if($row[csf("currier_pre_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("currier_pre_cost")],2); ?></td>
                    <td align="right"><? $ocrc=($row[csf("currier_pre_cost")]/$grfobv_dzn)*100; echo fn_number_format($ocrc,2); ?>%</td>
                </tr>
                 <?
				}
				if($row[csf("certificate_pre_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("certificate_pre_cost")],2); ?></td>
                    <td align="right"><? $ocfc=($row[csf("certificate_pre_cost")]/$grfobv_dzn)*100; echo fn_number_format($ocfc,2); ?>%</td>
                </tr>
                 <?
				}

				if($row[csf("common_oh")]>0)
				{
				?>
               <!-- <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? //echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right"><? //$ooh=($row[csf("common_oh")]/$grfobv_dzn)*100; echo fn_number_format($ooh,4); ?>%</td>
                </tr>-->

			   <?
				}
				if($row[csf("deffdlc_cost")]>0)
				{
			   ?>
				<tr>
                    <td align="left">Deffd.Lc.Cost Charge (<? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("deffdlc_cost")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("deffdlc_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("interest_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">Finance Charge (<? echo fn_number_format($row[csf("interest_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_cost")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("incometax_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">Tax(<? echo fn_number_format($row[csf("incometax_percent")],2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($row[csf("incometax_cost")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("incometax_percent")],2); ?>%</td>
                </tr>
                <?
				}
                 $total_amount += $row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+($row[csf("cm_cost")])+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("deffdlc_cost")]+$row[csf("interest_cost")]+$row[csf("incometax_cost")];
                 $total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$row[csf("deffdlc_percent")]+$row[csf("interest_percent")]+$row[csf("incometax_percent")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_parcent,2);?>%</td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Other Components  Part report here -------------------------------------------

			$part[7]=ob_get_contents();ob_end_clean();
			ob_start();//part 8;


  	//start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><? echo fn_number_format($order_values,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commission,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commercial,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_freight,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,2); ?></td>
                    <td align="right"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right">
					<?
					//echo $others_cost_value;
					$otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($otherCost,2);
					?>
                    </td>
                    <td align="right"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM(Contribution Margin)</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,2); ?></td>
                    <td align="right"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_job_qnty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">FOH/<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$row[csf("cm_cost")],2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_job_qnty*$avg_unit_price; echo fn_number_format($total_order_val,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_order_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><? $total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,2); ?></td>
                    <td align="right"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_job_qnty*$order_price_per_dzn,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>

           </table>
      </div>

      <div style="clear:both"></div>
      </div>
    <!--End CM on Net Order Value Part report here -->
	<?
	echo "<br /><b>Note: Other Cost = Fabric Cost + Trims Cost + Embellishment Cost + Gmts Wash + Lab Test + Inspection + Currier Cost + <br />Certificate Cost + Finance Charge+ Deffd.Lc.Cost+Tax</b>";

	$part[8]=ob_get_contents();ob_end_clean();
	ob_start();//part 9;

	//------------------------------------------------------
	$user_sql = "select a.id,a.user_full_name,b.custom_designation from user_passwd a,lib_designation b where a.valid=1 and b.id=a.designation";
	$user_data_array=sql_select($user_sql);
	foreach($user_data_array as $row){
		$user_arr[$row[csf(id)]]=$row[csf(user_full_name)].'<br><span style="font-size:10px;">('.$row[csf(custom_designation)].')</span>';
	}

	$sql="select bypass,buyer_id, sequence_no, user_id FROM electronic_approval_setup where company_id=$cbo_company_name and FIND_IN_SET(buyer_id,$buyer_id)>0 and page_id=869 and is_deleted=0 order by sequence_no asc";
	$data_array=sql_select($sql);
	foreach($data_array as $row){
		$electronic_data[$row[csf(sequence_no)]] = $row[csf(user_id)];
		$user_wise_sequence[$row[csf(user_id)]] = $row[csf(sequence_no)];
	}
	$startSequence = min($user_wise_sequence);
	$endSequence = max($user_wise_sequence);


	$sql="select min(b.current_approval_status) as cstatus,b.approved_by,b.mst_id FROM co_com_pre_costing_approval b where b.job_no=$txt_job_no and b.approved_by not in (".$electronic_data[$endSequence].") group by b.mst_id,b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$check_app_data[$row[csf(approved_by)]] = $row[csf(approved_by)];}
		$mst_id = $row[csf(mst_id)];//for Higher Auth Check;
		$higher_auth_id = $row[csf(approved_by)];//for Higher Auth Check;
	}


	$sql="select min(b.current_approval_status) as cstatus,b.approved_by FROM co_com_pre_costing_approval b where b.job_no=$txt_job_no and b.approved_by in (".$electronic_data[$endSequence].") group by b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$last_app_data = $row[csf(approved_by)];}
	}

    //---------------------------------------------Higher Auth Check;
	 $app_history_data=return_library_array( "select sequence_no, approved_by from approval_history where mst_id=$mst_id and entry_form=15",'sequence_no','approved_by');

	if(count($check_app_data)==1 && (!in_array($higher_auth_id,$app_history_data))){
		$last_app_data=$app_history_data[$endSequence];
		$check_app_data=array();
		foreach($app_history_data as $sec=>$user){
			if($sec!=$endSequence){$check_app_data[$user] =$user;}
		}
		$align='center';
	}
	else
	{
		$higher_auth_id	=0;
		$align='right';
	}

    //--------------------------------------------------------

	?>
     <br /><br />
	<table class="rpt_table" border="0" cellpadding="1" cellspacing="1" style="text-align:center;" rules="all" width="850">
		<tr>
        	<td style="border:none; line-height:13px;" align="left"><? echo $user_arr[$prepared_app_data]; ?></td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td style="border:none; line-height:13px;" align="center">'.$user_arr[$check_user].'</td>';
			}
			?>
            <td style="border:none; line-height:13px;" align="<? echo $align;?>"><? echo $user_arr[$last_app_data]; ?></td>

       		<?
			if($higher_auth_id!=0){
				echo '<td style="border:none; line-height:13px;" align="right">'.$user_arr[$higher_auth_id].'</td>';
			}
			?>

        </tr>
		<tr style="alignment-baseline:baseline;">
        	<td width="" style="text-decoration:overline; border:none" align="left">Prepared By</td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td width="" style="text-decoration:overline; border:none" align="center">Checked By</td>';
			}
			?>

            <td width="" style="text-decoration:overline; border:none" align="<? echo $align;?>">Approved By</td>
       		<?
			if($higher_auth_id!=0){
				echo '<td width="" style="text-decoration:overline; border:none" align="right">Unapproved/Approved</td>';
			}
			?>
        </tr>
    </table>
    <script>
	  	 document.getElementById('price_as_par_budget_td').innerHTML=<? echo  fn_number_format($total_cost/$order_job_qnty,4);?>
	</script>
 	<?

	$part[9]=ob_get_contents();ob_end_clean();
	$html='';
	foreach(explode(',',str_replace("'","",$print_option_id)) as $part_id)
	{
		$html.=$part[$part_id];
	}

	if($html!=''){echo $part[0].$html.$part[9];}else{echo $part[0].$part[1].$part[2].$part[3].$part[4].$part[5].$part[6].$part[7].$part[8].$part[9];};
	exit();

}//end master if condition-------------------------------------------------------




if($action=="preCostRpt6")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	//$gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	//$gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");


	 $po_qty=0; $po_plun_cut_qty=0; $total_set_qnty=0; $job_in_orders=''; $pulich_ship_date=''; $job_in_file=''; $job_in_ref='';
	 /*$sql_po="select a.job_no, a.total_set_qnty, b.id, b.po_number, b.grouping, b.file_no, min(b.pub_shipment_date) as min_sihpment_date, max(b.pub_shipment_date) as max_sihpment_date, c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and a.job_no =".$txt_job_no." and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1
	 group by a.job_no, a.total_set_qnty, b.id, b.po_number, b.grouping, b.file_no, c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty
	 order by b.id";*/
	$sql_po="select a.job_no, a.total_set_qnty, min(b.pub_shipment_date) as min_sihpment_date, max(b.pub_shipment_date) as max_sihpment_date, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and a.job_no =".$txt_job_no." and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1
	 group by a.job_no, a.total_set_qnty";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];

		//$job_in_orders .=$sql_po_row[csf('po_number')].",";
		$min_ship_date = $sql_po_row[csf('min_sihpment_date')];
		$max_ship_date = $sql_po_row[csf('max_sihpment_date')];
	}
	//$job_in_orders=implode(",",array_unique(explode(",",substr(trim($job_in_orders),0,-1))));

	//echo $po_qty;

	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no, gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row)
	{
		$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	$financial_para=array();
	$sql_std_para=sql_select("select interest_expense, income_tax, cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
	foreach($sql_std_para as $sql_std_row){
		$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
		$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
		$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
	}

	$fab_knit_req_kg_avg=0; $fab_woven_req_yds_avg=0;
	$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";

	$fab_cons_arr=array();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, uom, avg_cons, avg_cons_yarn, rate, amount, avg_finish_cons from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and uom in (12,23,27) and status_active=1";
	$data_arr_fabric=sql_select($sql_fabric);
	foreach($data_arr_fabric as $row)
	{
		$fab_cons_arr[$row[csf("uom")]]+=$row[csf("avg_cons")];
	}
	unset($data_arr_fabric);
	$fab_cons_kg=$fab_cons_mtr=$fab_cons_yds=0;
	$fab_cons_kg=$fab_cons_arr[12];
	$fab_cons_mtr=$fab_cons_arr[23];
	$fab_cons_yds=$fab_cons_arr[27];

	$data_array=sql_select($sql);
	?>
    <!--<div style="width:850px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>-->
	<?
	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0; $order_job_qnty=0; $avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		?>

        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Pre- Costing</b>
        </td></tr></table>

        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
            <tr>
                <td width="80">Job Number</td>
                <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="90">Buyer</td>
                <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td width="80">Garments Item</td>
                <?
                    $grmnt_items = "";
					$ex_gmts_item=explode(",",$row[csf("gmts_item_id")]);
					foreach($ex_gmts_item as $item_id)
					{
						if($grmnt_items =="") $grmnt_items =$garments_item[$item_id]; else $grmnt_items.=', '.$garments_item[$item_id];
					}

                    /*if($garments_item[$row[csf("gmts_item_id")]]=="")
                    {
                        $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
                        foreach($grmts_sql as $key=>$val){
                            $grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
                        }
                        $grmnt_items = substr_replace($grmnt_items,"",-1,1);
                    }else{
                        $grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
                    }*/
                ?>
                <td width="100"><b><? echo $grmnt_items; ?></b></td>
            </tr>
            <tr>
                <td>Style Ref. No </td>
                <td colspan=""><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                <td>Job Qty</td>
                <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                 <td>Plan Cut Qty</td>
               <td><b><? echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]];?></b></td>
            </tr>
            <tr>
                <td>Knit Fabric Cons (Kg)</td>
                <td><b><? echo fn_number_format($fab_cons_kg,4); $fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?></b></td>
                <td>Knit Fabric Cons (Yds)</td>
                <td><b><? echo fn_number_format($fab_cons_yds,4); ?></b></td>
                <td>Knit Fabric Cons (Mtr)</td>
                <td><b><? echo fn_number_format($fab_cons_mtr,4); ?></b></td>
            </tr>
            <tr>
            	<td>Woven Fabric Cons</td>
                <td><b><? echo $row[csf("fab_woven_req_yds")]; $fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> (Yds)</b></td>
                <td>Costing Per</td>
                <td><b><? echo $costing_per[$row[csf("costing_per")]];?></b></td>
                <td>First & Last Shipment Date</td>
                <td><b><? echo change_date_format($min_ship_date).' & '.change_date_format($max_ship_date); ?></b></td>
            </tr>
            <tr>
            	<td>FOB Per Unit</td>
                <td><b><? echo $row[csf("avg_unit_price")]; ?> USD</b></td>
                <td align="center" height="10" colspan="2" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
            	<td>Quotation ID</td>
                <td><b><? echo $row[csf("quotation_id")]; $quotation_id= $row[csf("quotation_id")]; ?> </b></td>
            </tr>
        </table>
    	<?
		if($row[csf("costing_per")]==1){
			$order_price_per_dzn=12;
			$costing_for=" DZN";
		}
		else if($row[csf("costing_per")]==2){
			$order_price_per_dzn=1;
			$costing_for=" PCS";
		}
		else if($row[csf("costing_per")]==3){
			$order_price_per_dzn=24;
			$costing_for=" 2 DZN";
		}
		else if($row[csf("costing_per")]==4){
			$order_price_per_dzn=36;
			$costing_for=" 3 DZN";
		}
		else if($row[csf("costing_per")]==5){
			$order_price_per_dzn=48;
			$costing_for=" 4 DZN";
		}
		$order_job_qnty=$row[csf("job_quantity")];
		$avg_unit_price=$row[csf("avg_unit_price")];
	}//end first foearch

	//start	all summary report here -------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);

	$sql_new = "select job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, design_cost, design_percent, studio_cost, studio_percent from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array_new=sql_select($sql_new);
	$summary_data=array();

	foreach( $data_array_new as $row_new )
	{
		$summary_data[price_dzn]=$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
		$summary_data[commission]=$row_new[csf("commission")];
		$summary_data[trims_cost]=$row_new[csf("trims_cost")];
		$summary_data[emb_cost]=$row_new[csf("embel_cost")];
		$summary_data[lab_test]=$row_new[csf("lab_test")];
		$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];
		$summary_data[inspection]=$row_new[csf("inspection")];
		$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];
		$summary_data[freight]=$row_new[csf("freight")];
		$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];
		$summary_data[design]=$row_new[csf("design_cost")];
		$summary_data[design_job]=$row_new[csf("design_cost")]/$order_price_per_dzn*$po_qty;
		$summary_data[studio]=$row_new[csf("studio_cost")];
		$summary_data[studio_job]=$row_new[csf("studio_cost")]/$order_price_per_dzn*$po_qty;
		$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
		$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];
		$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
		$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
		$summary_data[wash_cost]=$row_new[csf("wash_cost")];
		$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("design_cost")]+$row_new[csf("studio_cost")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];
		$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[design_job]+$summary_data[studio_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];
		$summary_data[cm_cost]=$row_new[csf("cm_cost")];
		$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];
		$summary_data[comm_cost]=$row_new[csf("comm_cost")];
		$summary_data[common_oh]=$row_new[csf("common_oh")];
		$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
		$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
		$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
	}

	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_arr_fabric=sql_select($sql_fabric);
	foreach($data_arr_fabric as $fab_row)
	{
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	//Fabric End======================
	//Yarn===========================
	$totYarn=0;
	$YarnData=array();
	$yarn_data_array=$yarn->get_By_Precostdtlsid_YarnQtyAmountArray();
	$sql_yarn="select f.id as yarn_id, f.cons_ratio, f.cons_qnty, f.avg_cons_qnty, f.rate, f.amount, count_id, copm_one_id, percent_one, color, type_id from wo_pre_cost_fab_yarn_cost_dtls f where f.job_no =".$txt_job_no." and f.is_deleted=0 and f.status_active=1  order by f.id";
	$data_arr_yarn=sql_select($sql_yarn);
	foreach($data_arr_yarn as $yarn_row)
	{
		$yarnrate=$yarn_row[csf("rate")];
		$summary_data[yarn_cost][$yarn_row[csf("yarn_id")]]=$yarn_row[csf("amount")];
		$summary_data[yarn_cost_job]+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
		$index="'".$yarn_row[csf("count_id")]."_".$yarn_row[csf("copm_one_id")]."_".$yarn_row[csf("percent_one")]."_".$yarn_row[csf("type_id")]."_".$yarn_row[csf("color")]."_".$yarnrate."'";
		$YarnData[$index]['qty']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
		$YarnData[$index]['amount']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
		$YarnData[$index]['dznqty']+=$yarn_row[csf("cons_qnty")];
		$YarnData[$index]['dznamount']+=$yarn_row[csf("amount")];
		$totYarn+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
	}
	//Yarn End============================
	//Conversion
	$totConv=0;
	$ConvData=array();
	$conv_data=array();
	$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
	$conv_qty_arr=$conversion->getQtyArray_by_conversionid();
	$sql_conv = "select a.id as con_id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.uom  from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." ";
	$data_arr_conv=sql_select($sql_conv);
	foreach($data_arr_conv as $conv_row)
	{
		$convamount=$conv_amount_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];
		$convQty=$conv_qty_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];
		$conv_data[cons_process][$conv_row[csf('con_id')]]=$conv_row[csf('cons_process')];
		$conv_data[amount][$conv_row[csf('con_id')]]=$conv_row[csf('amount')];
		$conv_data[amount_job][$conv_row[csf('con_id')]]+=$convamount;
		$summary_data[conver_cost_job]+=$convamount;

		$index=$conv_row[csf('con_id')];
		$ConvData[$index]['item_descrition']=$body_part[$conv_row[csf("body_part_id")]].", ".$color_type[$conv_row[csf("color_type_id")]].", ".$conv_row[csf("fabric_description")];
		$ConvData[$index]['cons_process']=$conv_row[csf("cons_process")];
		$ConvData[$index]['req_qnty']=$conv_row[csf("req_qnty")];
		$ConvData[$index]['uom']=$conv_row[csf("uom")];
		$ConvData[$index]['charge_unit']=$conv_row[csf("charge_unit")];
		$ConvData[$index]['amount']=$conv_row[csf("amount")];
		$ConvData[$index]['tot_req_qnty']=$convQty;
		$ConvData[$index]['tot_amount']=$convamount;
		$totConv+=$conv_row[csf("req_qnty")];
	}
	//Conversion End
	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
	from wo_pre_cost_trim_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim )
	{
		$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;
		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
	//End	Trims Cost part report here -------------------------------------------
	//Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5)";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row )
	{
		$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
		$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[emb_cost_job]+=$embamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
		$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
		$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[wash_cost_job]+=$washamount;
		$summary_data[OtherDirectExpenses_job]+=$washamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Wash cost Cost part report here -------------------------------------------
	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from wo_pre_cost_commiss_cost_dtls where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
		$commisionamount=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[commission_job]+=$commisionamount;
		$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
		$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
		$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
		$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
		$CommiData[$row[csf("id")]]['tot_commission_amount']=$commisionamount;
		$totCommi+=$row[csf("commission_amount")];
	}
	//End Commision cost Cost part report here -------------------------------------------
	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
		$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[comm_cost_job]+=$commarcialamount;
		$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
		$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
		$totCommar+=$row[csf("amount")];
	}
	//End Commarcial cost Cost part report here -------------------------------------------
	?>
    <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;" rules="all">
            <tr style="font-weight:bold">
            	<td align="center" width="850" colspan="5">Order Profitability </td>
            </tr>
            <tr style="font-weight:bold">
                <td align="center" width="80">Line Items</td>
                <td width="400">Particulars</td>
                <td width="120">Amount (USD)/<? echo $costing_for; ?></td>
                <td width="120">Total Value</td>
                <td>%</td>
            </tr>
            <tr>
                <td align="center">1</td>
                <td style="font-weight:bold">Gross FOB Value</td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn_job],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">2</td>
                <td style=" padding-left:15px">Less: commission</td>
                <td align="right"><? echo fn_number_format($summary_data[commission],4); ?></td>
                <td align="right"><? echo fn_number_format($summary_data[commission_job],4); ?></td>
                <td align="right"><? echo fn_number_format(($summary_data[commission_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">3</td>
                <?
                $NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
                $NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];
                ?>
                <td style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">4</td>
                <td style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8+9) </b></td>
                <?
                $Less_Cost_Material_Services=array_sum($summary_data[fabric_cost])+array_sum($conv_data[amount])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[design]+$summary_data[studio]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];

                $Less_Cost_Material_Services_job=$summary_data[fabric_cost_job]+$summary_data[conver_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($Less_Cost_Material_Services,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($Less_Cost_Material_Services_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center" >5</td>
                <td style=" padding-left:100px;font-weight:bold">Fabric Purchase Cost</td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format(array_sum($summary_data[fabric_cost]),4); ?></td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[fabric_cost_job],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[fabric_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center" valign="top">6</td>
                <td width="400" style=" padding-left:100px">
                    <table>
                        <tr>
                        	<td style="font-weight:bold">AOP & Conversion Cost</td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
						<? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>
                                <td align="left"><? echo $conversion_cost_head_array[$conv_data[cons_process][$key]]; ?></td>
                            </tr>
                        <? }?>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format(array_sum($conv_data[amount]),4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
						<? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>
                                <td align="right"><? echo fn_number_format($conv_data[amount][$key],4);?></td>
                            </tr>
                        <? } ?>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[conver_cost_job],4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>
                                <td align="right"><? echo fn_number_format($conv_data[amount_job][$key],4);?></td>
                            </tr>
                        <? }?>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[conver_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
						<? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>
                            	<td align="right"><? echo fn_number_format(($conv_data[amount_job][$key]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>
                        <? }?>
                    </table>
                </td>
            </tr>
            <tr>
                <td align="center">7</td>
                <td style="padding-left:100px;font-weight:bold" ><b>Accessoris Cost </b></td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[trims_cost],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[trims_cost_job],4)?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[trims_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">8</td>
                <td style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[emb_cost],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[emb_cost_job],4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[emb_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center" valign="top">9</td>
                <td style="padding-left:100px">
                    <table>
                        <tr>
                        	<td style="font-weight:bold">Other Direct Expenses</td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td>Lab Test</td>
                        </tr>
                        <tr>
                        	<td>Inspection</td>
                        </tr>
                        <tr>
                        	<td>Design Cost</td>
                        </tr>
                        <tr>
                        	<td>Studio Cost</td>
                        </tr>
                        <tr>
                        	<td>Freight Cost</td>
                        </tr>
                        <tr>
                        	<td>Courier Cost</td>
                        </tr>
                        <tr>
                        	<td>Certificate Cost</td>
                        </tr>
                        <tr>
                        	<td>Garments Wash Cost</td>
                        </tr>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[OtherDirectExpenses],4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[lab_test],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[inspection],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[design],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[studio],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[freight],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[currier_pre_cost],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[certificate_pre_cost],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[wash_cost],4);?></td>
                        </tr>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        <td align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[OtherDirectExpenses_job],4); ?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[lab_test_job],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[inspection_job],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[design_job],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[studio_job],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[freight_job],4);?></td>
                        </tr>
                        <tr>
                       		<td align="right"><? echo fn_number_format($summary_data[currier_pre_cost_job],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[certificate_pre_cost_job],4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format($summary_data[wash_cost_job],4);?></td>
                        </tr>
                    </table>
                </td>
                <td align="right" valign="top">
                    <table>
                        <tr>
                        	<td align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[OtherDirectExpenses_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                    </table>
                    <table border="1" class="rpt_table" rules="all">
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data[lab_test_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data[inspection_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data[design_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                       		<td align="right"><? echo fn_number_format(($summary_data[studio_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data[freight_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data[currier_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data[certificate_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        	<td align="right"><? echo fn_number_format(($summary_data[wash_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td align="center">10</td>
                <td style="font-weight:bold">Contributions/Value Additions (3-4)</td>
                <?
                $Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
                $Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($Contribution_Margin,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($Contribution_Margin_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Contribution_Margin_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">11</td>
                <td style=" padding-left:15px">Less: CM Cost </td>
                <td align="right"><? echo fn_number_format($summary_data[cm_cost],4); ?> </td>
                <td align="right"><? echo fn_number_format($summary_data[cm_cost_job],4); ?></td>
                <td align="right"><? echo fn_number_format(($summary_data[cm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">12</td>
                <td style="font-weight:bold">Gross Profit (10-11)</td>
                <?
                $Gross_Profit=$Contribution_Margin-$summary_data[cm_cost];
                $Gross_Profit_job=$Contribution_Margin_job-$summary_data[cm_cost_job];
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($Gross_Profit,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($Gross_Profit_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Gross_Profit_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">13</td>
                <td style=" padding-left:15px">Less: Commercial Cost</td>
                <td align="right"> <? echo fn_number_format( $summary_data[comm_cost],4); ?></td>
                <td align="right"><? echo fn_number_format( $summary_data[comm_cost_job],4); ?></td>
                <td align="right"><? echo fn_number_format(($summary_data[comm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">14</td>
                <td style=" padding-left:15px">Less: Operating Expensees</td>
                <td align="right"><? echo fn_number_format( $summary_data[common_oh],4); ?> </td>
                <td align="right"><? echo fn_number_format( $summary_data[common_oh_job],4); ?> </td>
                <td align="right"><? echo fn_number_format(($summary_data[common_oh_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr >
                <td align="center">15</td>
                <td style="font-weight:bold">Operating Profit/ Loss (12-(13+14))</td>
                <?
                $OperatingProfitLoss=$Gross_Profit-($summary_data[comm_cost]+$summary_data[common_oh]);
                $OperatingProfitLoss_job=$Gross_Profit_job-($summary_data[comm_cost_job]+$summary_data[common_oh_job]);
                ?>
                <td align="right" style="font-weight:bold"> <? echo fn_number_format($OperatingProfitLoss,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format($OperatingProfitLoss_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($OperatingProfitLoss_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
            <tr>
                <td align="center">16</td>
                <td style=" padding-left:15px">Less: Depreciation & Amortization </td>

                <td align="right"> <? echo fn_number_format( $summary_data[depr_amor_pre_cost],4); ?></td>
                <td align="right"><? echo fn_number_format( $summary_data[depr_amor_pre_cost_job],4); ?></td>
                <td align="right"><? echo fn_number_format(($summary_data[depr_amor_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>

            <tr>
				<?
                $Netprofit=$OperatingProfitLoss-($summary_data[depr_amor_pre_cost]+$interest_expense+$income_tax);
                $Netprofit_job=$OperatingProfitLoss_job-($summary_data[depr_amor_pre_cost_job]+$interest_expense_job+$income_tax_job);
                ?>
                <td align="center">17</td>
                <td style="font-weight:bold">Net Profit (15-16)</td>

                <td align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit,4); ?> </td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit_job,4); ?></td>
                <td align="right" style="font-weight:bold"><? echo fn_number_format(($Netprofit_job/$summary_data[price_dzn_job])*100,4);?></td>
            </tr>
        </table>
    </div>
    <?
	//End all summary report here -------------------------------------------
	//2	All Fabric Cost part here-------------------------------------------
	$sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, uom, avg_cons, avg_cons_yarn, fabric_source, gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."  and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);

	$knit_fab=""; $woven_fab="";
	$knit_subtotal_avg_cons=0; $knit_subtotal_amount=0; $woven_subtotal_avg_cons=0; $woven_subtotal_amount=0;
	$grand_total_amount=0;

	$i=1; $j=1;
	foreach( $data_array as $row )
	{
		$uom=$unit_of_measurement[$row[csf("uom")]];
		$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];

		if($row[csf("fab_nature_id")]==2){//knit fabrics
			$i++;
			$totalConsKnit=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$totalAmountKnit=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$amount=$row[csf("avg_cons")]*$row[csf("rate")];

			$knit_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
				<td align="right">'.fn_number_format($totalConsKnit,4).'</td>
				<td align="left">'.$uom.'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,4).'</td>
				<td align="right">'.fn_number_format($totalAmountKnit,4).'</td>
			</tr>';
			if($row[csf("uom")]==1){
				$DznConsKnitSubTotalPcs += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalPcs += $totalConsKnit;
				$DznAmountKnitSubTotalPcs+=$amount;
				$TotalAmountKnitSubTotalPcs+=$totalAmountKnit;
			 }
			 if($row[csf("uom")]==12){
				$DznConsKnitSubTotalKg += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalKg += $totalConsKnit;
				$DznAmountKnitSubTotalKg+=$amount;
				$TotalAmountKnitSubTotalKg+=$totalAmountKnit;
			 }
			 if($row[csf("uom")]==23){
				$DznConsKnitSubTotalMtr += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalMtr += $totalConsKnit;
				$DznAmountKnitSubTotalMtr+=$amount;
				$TotalAmountKnitSubTotalMtr+=$totalAmountKnit;
			 }
			 if($row[csf("uom")]==27){
				$DznConsKnitSubTotalYds += $row[csf("avg_cons")];
				$TotalConsKnitSubTotalYds += $totalConsKnit;
				$DznAmountKnitSubTotalYds+=$amount;
				$TotalAmountKnitSubTotalYds+=$totalAmountKnit;
			 }
			 $GrandtotalDznAmount+=$amount;
			 $GrandtotalAmount+=$totalAmountKnit;

			 $GrandTotalFabricDznAmount+=$amount;
			 $GrandTotalFabricAmount+=$totalAmountKnit;
		}

		if($row[csf("fab_nature_id")]==3){//woven fabrics
			$j++;
			$totalConsWoven=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$totalAmountWoven=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			$woven_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
				<td align="right">'.fn_number_format($totalConsWoven,4).'</td>
				<td align="left">'.$uom.'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,4).'</td>
				<td align="right">'.fn_number_format($totalAmountWoven,4).'</td>
			</tr>';

			if($row[csf("uom")]==1){
				$DznConsWovenSubTotalPcs += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalPcs += $totalConsWoven;
				$DznAmountWovenSubTotalPcs+=$amount;
				$TotalAmountWovenSubTotalPcs+=$totalAmountWoven;
			 }
			 if($row[csf("uom")]==12){
				$DznConsWovenSubTotalKg += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalKg += $totalConsWoven;
				$DznAmountWovenSubTotalKg+=$amount;
				$TotalAmountWovenSubTotalKg+=$totalAmountWoven;
			 }
			 if($row[csf("uom")]==23){
				$DznConsWovenSubTotalMtr += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalMtr += $totalConsWoven;
				$DznAmountWovenSubTotalMtr+=$amount;
				$TotalAmountWovenSubTotalMtr+=$totalAmountWoven;
			 }
			 if($row[csf("uom")]==27){
				$DznConsWovenSubTotalYds += $row[csf("avg_cons")];
				$TotalConsWovenSubTotalYds += $totalConsWoven;
				$DznAmountWovenSubTotalYds+=$amount;
				$TotalAmountWovenSubTotalYds+=$totalAmountWoven;
			 }
			 $GrandtotalDznAmount+=$amount;
			 $GrandtotalAmount+=$totalAmountWoven;

			 $GrandTotalFabricDznAmount+=$amount;
			 $GrandTotalFabricAmount+=$totalAmountWoven;
		}
	}

	if($DznConsKnitSubTotalPcs>0) $i++;
	if($DznConsKnitSubTotalKg>0) $i++;
	if($DznConsKnitSubTotalMtr>0) $i++;
	if($DznConsKnitSubTotalYds>0) $i++;
	if($DznConsWovenSubTotalPcs>0) $j++;
	if($DznConsWovenSubTotalKg>0) $j++;
	if($DznConsWovenSubTotalMtr>0) $j++;
	if($DznConsWovenSubTotalYds>0) $j++;

	$knit_fab= '<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>All Fabric Cost  </b></label>
					<tr style="font-weight:bold"  align="center">
						<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
						<td width="350">Description</td>
						<td width="100">Source</td>
						<td width="100">Fab. Cons/'.$costing_for.'</td>
						<td width="100">Total Cons</td>
						<td width="100">UOM</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)/'.$costing_for.'</td>
						<td width="100">Tot.Amount (USD)</td>
					</tr>'.$knit_fab;
	if($DznConsWovenSubTotalPcs>0 || $DznConsWovenSubTotalKg>0 || $DznConsWovenSubTotalMtr>0 || $DznConsWovenSubTotalYds>0){
		$woven_fab= '<tr><td colspan="9">&nbsp;</td></tr><tr>
					<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
	}

	//knit fabrics table here
	if($DznConsKnitSubTotalPcs>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Pcs)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalPcs,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalPcs,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalPcs,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalPcs,4).'</td>
					</tr>';
	}
	if($DznConsKnitSubTotalKg>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Kg)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalKg,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalKg,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalKg,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalKg,4).'</td>
					</tr>';
	}
	if($DznConsKnitSubTotalMtr>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Mtr)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalMtr,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalMtr,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalMtr,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalMtr,4).'</td>
					</tr>';
	}
	if($DznConsKnitSubTotalYds>0){
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Yds)</td>
						<td align="right">'.fn_number_format($DznConsKnitSubTotalYds,4).'</td>
						<td align="right">'.fn_number_format($TotalConsKnitSubTotalYds,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($DznAmountKnitSubTotalYds,4).'</td>
						<td align="right">'.fn_number_format($TotalAmountKnitSubTotalYds,4).'</td>
					</tr>';
	}

	if($zero_value==1) echo $knit_fab;
	else
	{
		if($row[csf("avg_cons")]>0) echo $knit_fab; else echo "";
	}

	//woven fabrics table here
	if($DznConsWovenSubTotalPcs>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Pcs)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalPcs,4).'</td>
					<td align="right">'.fn_number_format($TotalConsWovenSubTotalPcs,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalPcs,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalPcs,4).'</td>
				</tr>';
	}
	if($DznConsWovenSubTotalKg>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Kg)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalKg,4).'</td>
					<td align="right">'.fn_number_format($TotalConsWovenSubTotalKg,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalKg,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalKg,4).'</td>
				</tr>';
	}
	if($DznConsWovenSubTotalMtr>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Mtr)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalMtr,4).'</td>
					<td align="right">'.fn_number_format($TotalConsWovenSubTotalMtr,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalMtr,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalMtr,4).'</td>
				</tr>';
	}
	if($DznConsWovenSubTotalYds>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total(Yds)</td>
					<td align="right">'.fn_number_format($DznConsWovenSubTotalYds,4).'</td>
					<td align="right">'.fn_number_format($TotalAmountWovenSubTotalYds,4).'</td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalYds,4).'</td>
					<td align="right">'.fn_number_format($DznAmountWovenSubTotalYds,4).'</td>
				</tr>';
	}

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="4" align="left">Total</td>
					<td align="right"></td>
					<td></td>
					<td></td>
					<td align="right">'.fn_number_format(($GrandtotalDznAmount),4).'</td>
					<td align="right">'.fn_number_format(($GrandtotalAmount),4).'</td>
				</tr></table></div>';
	if($zero_value==1) echo $woven_fab;
	else{
			if($row[csf("avg_cons")]>0) echo $woven_fab; else echo "";
	}
	//end 	All Fabric Cost part report-------------------------------------------

  	//start	Conversion Cost to Fabric report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Total Cons/<? echo $costing_for; ?></td>
                    <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Total Amount (USD)</td>
                </tr>
				<?
                $TotalDznAmount =0; $TotalAmount =0;
                foreach( $ConvData as $index=>$row )
                {
                    ?>
                    <tr>
                        <td align="left"><? echo $row['item_descrition']; ?></td>
                        <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
                        <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                    </tr>
                    <?
                     $TotalDznAmount += $row["amount"];
                     $TotalAmount += $row["tot_amount"];

                     $GrandTotalFabricDznAmount+=$row["amount"];
                     $GrandTotalFabricAmount+=$row["tot_amount"];
                }
              ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td  align="left" colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totConv>0)

		{
			?>
			 <div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                    <tr style="font-weight:bold">
                        <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                        <td width="350">Particulars</td>
                        <td width="100">Process</td>
                        <td width="100">Cons/<? echo $costing_for; ?></td>
                        <td width="100">Total Cons/<? echo $costing_for; ?></td>
                         <td width="100">Uom</td>
                        <td width="100">Rate (USD)</td>
                        <td width="100">Amount (USD)</td>
                         <td width="100">Total Amount (USD)</td>
                    </tr>
					<?
				    $TotalDznAmount =0; $TotalAmount =0;
					foreach( $ConvData as $index=>$row)
					{
						?>
						<tr>
							<td align="left"><? echo $row['item_descrition']; ?></td>
							<td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
							<td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
						<?
						 $TotalDznAmount += $row["amount"];
						 $TotalAmount += $row["tot_amount"];

						 $GrandTotalFabricDznAmount+=$row["amount"];
						 $GrandTotalFabricAmount+=$row["tot_amount"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total</td>
                        <td align="right"><? echo $TotalDznAmount; ?></td>
                        <td align="right"><? echo $TotalAmount; ?></td>
                    </tr>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total Fabric Cost</td>
                        <td align="right"><? echo fn_number_format($GrandTotalFabricDznAmount,4); ?></td>
                        <td align="right"><? echo fn_number_format($GrandTotalFabricAmount,4); ?></td>
                    </tr>
                </table>
			  </div>
			  <?
		}
		else echo "";
	}
	//End Conversion Cost to Fabric report here -------------------------------------------
  	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name"  );
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Tot. Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
				<?
                $TotalDznAmount=0; $TotalAmount=0;
                foreach( $TrimData as $index=>$row )
                {
                    ?>
                        <tr>
                            <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                            <td align="left"><? echo $row["description"]; ?></td>
                            <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                            <td align="left"><? echo $row["remark"]; ?></td>
                            <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                            <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                        </tr>
                    <?
                     $TotalDznAmount += $row["amount"];
                     $TotalAmount += $row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totTrim>0)
		{
			?>
			<div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                    <tr style="font-weight:bold">
                        <td width="150">Item Group</td>
                        <td width="150">Description</td>
                        <td width="150">Brand/Supp Ref</td>
                        <td width="150">Remarks</td>
                        <td width="100">UOM</td>
                        <td width="100">Cons/<? echo $costing_for; ?></td>
                        <td width="100">Tot. Cons/<? echo $costing_for; ?></td>
                        <td width="100">Rate (USD)</td>
                        <td width="100">Amount (USD)</td>
                        <td width="100">Tot. Amount</td>
                    </tr>
					<?
					$TotalDznAmount=0; $TotalAmount=0;
					foreach( $TrimData as $index=>$row)
					{
						?>
							<tr>
								<td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
								<td align="left"><? echo $row["description"]; ?></td>
								<td align="left"><? echo $row["brand_sup_ref"]; ?></td>
								<td align="left"><? echo $row["remark"]; ?></td>
								<td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
								<td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
							</tr>
						<?
						 $TotalDznAmount += $row["amount"];
						 $TotalAmount += $row["tot_amount"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="8" align="left">Total</td>
                        <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                        <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                    </tr>
                </table>
            </div>
            <?
		}
		else echo "";
	}
	//End Trims Cost Part report here -------------------------------------------
	//start	Embellishment Details part report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="150">Tot.Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
				<?
                $TotalDznAmount=0; $TotalAmount =0;
                foreach( $EmbData as $index=>$row )
                {
                    $em_type ="";
                    //$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
                    if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
                    else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
                    else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
                    else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
                    else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
					?>
						<tr>
							<td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
							<td align="left"><? echo $em_type; ?></td>
							<td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
					<?
                     $TotalDznAmount += $row["amount"];
                     $TotalAmount += $row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totEmb>0)
		{
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Embellishment Details</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Type</td>
						<td width="150">Cons/<? echo $costing_for; ?></td>
						<td width="150">Tot.Cons/<? echo $costing_for; ?></td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					 </tr>
					<?
                    $TotalDznAmount=0; $TotalAmount =0;
                    foreach( $EmbData as $index=>$row  )
                    {
                        $em_type ="";
                        //$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
                        if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
                        else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
                        else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
                        else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
                        else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
                        ?>
                            <tr>
                                <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                                <td align="left"><? echo $em_type; ?></td>
                                <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                                <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                            </tr>
                        <?
                         $TotalDznAmount += $row["amount"];
                         $TotalAmount += $row["tot_amount"];
                    }
                    ?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="5" align="left">Total</td>
						<td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
			</div>
			<?
		}
		else echo "";
	}
	//End Embellishment Details Part report here -------------------------------------------

  	//start	Commercial Cost part report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
				<?
                $TotalDznAount=0; $TotalAount =0;
                foreach( $CommarData as $index=>$row )
                {
					?>
						<tr>
							<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
					<?
                     $TotalDznAount += $row["amount"];
                     $TotalAount += $row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totCommar>0)
		{
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commercial Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot.Amount</td>
					 </tr>
					<?
                    $TotalDznAount=0; $TotalAount =0;
                    foreach( $CommarData as $index=>$row  )
                    {
						?>
							<tr>
								<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
								<td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
								<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
							</tr>
						<?
                         $TotalDznAount += $row["amount"];
                         $TotalAount += $row["tot_amount"];
                    }
                    ?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Total</td>
						<td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
					</tr>
				</table>
            </div>
            <?
		}
		else echo "";
	}
	//End Commercial Cost Part report here -------------------------------------------
  	//start	Commission Cost part report here -------------------------------------------
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
				<?
                $TotalDznAount = 0; $TotalAount = 0;
                foreach( $CommiData as $index=>$row )
                {
					?>
						<tr>
							<td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
							<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
						</tr>
					<?
                     $TotalDznAount += $row["commission_amount"];
                     $TotalAount += $row["tot_commission_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAount = 0; $TotalAount = 0;
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commission Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Commission Basis</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					 </tr>
				<?
				$total_amount=0;
				foreach( $CommiData as $index=>$row )
				{
					?>
						<tr>
						   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
							<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
						</tr>
					<?
					 $TotalDznAount += $row["commission_amount"];
					 $TotalAount += $row["tot_commission_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3" align="left">Total</td>
						<td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
					</tr>
				</table>
            </div>
            <?
		}
		else echo "";
	}
	//End Commission Cost Part report here -------------------------------------------
	?>
    <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:300px;" rules="all">
        <label><b>CM Details</b></label>
        <tr>
            <td width="150">CPM (TK)</td>
            <td width="150"><? echo $financial_para[cost_per_minute] ?></td>
        </tr>
        <tr>
            <td>SMV</td>
            <td><? echo $sew_smv .", ".$cut_smv ?></td>
        </tr>
        <tr>
            <td>EFF %</td>
            <td><? echo $sew_effi_percent .", ".$cut_effi_percent; ?></td>
        </tr>
    </table>
    <br/>
	<?
    // image show here  -------------------------------------------
    $sqlData = "select id, master_tble_id, image_location from common_photo_library where master_tble_id=".$txt_job_no."";
    $data_array_img=sql_select($sqlData);
	$path=($path)?$path:'../../';
    ?>
    <div style=" margin-left:310px;margin-top:-70px" >
		<? foreach($data_array_img AS $inf){ ?>
        	<img  src='<? echo $path.$inf[csf("image_location")]; ?>' border="1" height='97' width='89' />
        <?  } ?>
    </div>
    <br/><br/><br/> <br/>
    <?
	if($quotation_id!=0 && $quotation_id!="")
	{
		$cost_control_source=return_field_value("cost_control_source","variable_order_tracking","company_name=$cbo_company_name and variable_list=53","cost_control_source");
		if($cost_control_source==1)
		{
			$lib_temp_arr=return_library_array("select id, item_name from lib_qc_template","id","item_name");
			?>
			<table width="850" cellspacing="0" border="1" rules="all" class="rpt_table">
				<thead style="font-size:11px">
					<tr>
						<th colspan="17" align="center">Budget as Per Quick Costing: </th>
					</tr>
					<tr>
						<th width="60">Item</th>
						<th width="45">Fab. Cons. Kg</th>
						<th width="45">Fab. Cons. Mtr</th>
						<th width="45">Fab. Cons. Yds</th>
						<th width="50">Fab. Amount</th>
						<th width="50">Special Opera.</th>
						<th width="50">Access.</th>
						<th width="45">Frieght Cost</th>
						<th width="45">Lab - Test</th>
						<th width="45">Misce.</th>
						<th width="45">Other Cost</th>
						<th width="45">Commis.</th>
						<th width="50">FOB ($/DZN)</th>
						<th width="45" title="((CPM*100)/Efficiency)">CPPM</th>
						<th width="45">SMV</th>
						<th width="45">CM</th>
						<th>RMG Qty(Pcs)</th>
					</tr>
				</thead>
			<?
			$sql_confirm_dtls=sql_select("select id, mst_id, cost_sheet_id, item_id, fab_cons_kg, fab_cons_mtr, fab_cons_yds, fab_amount, sp_oparation_amount, acc_amount, fright_amount, lab_amount, misce_amount, other_amount, comm_amount, fob_amount, cppm_amount, smv_amount, cm_amount, rmg_ratio from qc_confirm_dtls where cost_sheet_id='$quotation_id'");
			$i=1;
			foreach($sql_confirm_dtls as $row_dtls)
			{
				?>
				<tr style="font-size:11px">
					<td width="60"><? echo $lib_temp_arr[$row_dtls[csf("item_id")]]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fab_cons_kg")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fab_cons_mtr")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fab_cons_yds")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("fab_amount")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("sp_oparation_amount")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("acc_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("fright_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("lab_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("misce_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("other_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("comm_amount")]; ?></td>
					<td width="50" align="right"><? echo $row_dtls[csf("fob_amount")]; ?></td>
					<td width="45"  align="right"><? echo $row_dtls[csf("cppm_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("smv_amount")]; ?></td>
					<td width="45" align="right"><? echo $row_dtls[csf("cm_amount")]; ?></td>
					<td align="right"><? echo $row_dtls[csf("rmg_ratio")]; ?></td>
				</tr>
				<?
			}
			?>
			</table>
			<?
		}
	}
	$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	$user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");
	//and b.un_approved_date is null
	//echo "select b.approved_by, b.sequence_no, min(b.approved_date) as approved_date from approval_history b where b.mst_id=$mst_id and b.entry_form=15 group by  b.approved_by, b.sequence_no order by b.sequence_no asc";
	//$approve_data_array=sql_select("select b.approved_by, b.sequence_no, min(b.approved_date) as approved_date from approval_history b where b.mst_id=$mst_id and b.entry_form=15 group by  b.approved_by, b.sequence_no order by b.sequence_no asc");
	$unapprove_data_array=sql_select("select b.approved_by, b.approved_date, b.un_approved_reason, b.un_approved_date, b.approved_no from approval_history b where b.mst_id=$mst_id and b.entry_form=15 order by b.approved_date,b.approved_by");
	// echo "select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_no";

	$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where entry_form=15 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
	//echo "select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id";
	$unapproved_request_arr=array();
	foreach($sql_unapproved as $rowu)
	{
		$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
	}

	if(count($unapprove_data_array)>0)
	{
		?>
		<table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
                <tr style="border:1px solid black;">
                	<th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                    <th width="3%" style="border:1px solid black;">Sl</th>
                    <th width="30%" style="border:1px solid black;">Name</th>
                    <th width="20%" style="border:1px solid black;">Designation</th>
                    <th width="5%" style="border:1px solid black;">Approval Status</th>
                    <th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                    <th width="22%" style="border:1px solid black;"> Date</th>
                </tr>
            </thead>
            <tbody>
				<?
                $i=1;
                foreach($unapprove_data_array as $row)
				{
					?>
					<tr style="border:1px solid black;">
                        <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                        <td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                        <td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                        <td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
                        <td width="20%" style="border:1px solid black;"><? echo '';?></td>
                        <td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
					</tr>
					<?
					$i++;
					$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
					$un_approved_date=$un_approved_date[0];
					if($db_type==0) //Mysql
					{
						if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
					}
					else
					{
						if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
					}

					if($un_approved_date!="")
					{
						?>
						<tr style="border:1px solid black;">
                            <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                            <td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                            <td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                            <td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
                            <td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
                            <td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
						</tr>

						<?
						$i++;
					}
                }
                ?>
            </tbody>
		</table>
		<?
	}
	echo signature_table(109, $cbo_company_name, "860px");
	exit();
}

if($action=="preCostRptBpkW")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($db_type==0)
	 {
	   $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
	 }
	if($db_type==2)
	{
		$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1)	;
	}
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	//array for display name
	 $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	 $comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	 $color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	 if($db_type==0)
	{
		$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1");
	}
	if($db_type==2)
	{
		 $sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");
	}

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow)
	{
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}
	$sql_gsm="select gsm_weight,job_no,body_part_id from wo_pre_cost_fabric_cost_dtls where job_no=$txt_job_no and body_part_id in(1,20)";
	$sql_gsm_data=sql_select($sql_gsm);
	foreach($sql_gsm_data as $row)
	{
		if($sql_po_row[csf('body_part_id')]==1)
		{
			$gsm_weight_top=$sql_po_row[csf('gsm_weight')];
		}
		if($sql_po_row[csf('body_part_id')]==20)
		{
			$gsm_weight_bottom=$sql_po_row[csf('gsm_weight')];
		}
	}
	// $gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	// $gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;$all_po_id="";
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no."   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
	$po_qty+=$sql_po_row[csf('order_quantity')];
	$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
	$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
	if($all_po_id=="") $all_po_id=$sql_po_row[csf('id')];else $all_po_id.=",".$sql_po_row[csf('id')];
	}
	$all_po_ids=implode(",",array_unique(explode(",",rtrim($all_po_id,", "))));
	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;

	if($db_type==0)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date order by a.job_no";
	}
	if($db_type==2)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	}

	$data_array=sql_select($sql);


	?>
    <!--<div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>-->
	<?
	$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 and id in($all_po_ids) order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_ref.=$val[csf('grouping')].",";
			$job_in_file.=$val[csf('file_no')].",";

		}
	$uom="";
	$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val){
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
	}
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;

		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];

		$job_in_orders = substr(trim($job_in_orders),0,-1);

		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref)
		{
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		?>
            	<table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
					   $path=($path)?$path:'../../';
					?>
                    <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                </td></tr></table>

                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{


								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}

						?>
                        <td width="100"><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td colspan="3"><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Job Qty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
                        <td>Plun Cut Qty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>

                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?> USD</b></td>
                    </tr>
                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                    <tr>
                    <td>Knit Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_fin_req_kg")] ?> (Kg)</b></td>
                        <td>Woven Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_fin_req_yds")]; ?>(Yds)</b></td>
                    	<td>GSM</td>
                        <td><b><? echo $gsm_weight_top.",".$gsm_weight_bottom ?></b></td>

                    </tr>
                     <tr>
                     <td>SMV</td>
                    <td><b><? echo $row[csf("sew_smv")] ?> </b></td>
                     <td>CPM</td>
                    <td><b><? echo $cpm; ?> </b></td>
                    <td>Budget Minute</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                    </tr>

                    <tr>
                    <td>Efficiency</td>
                    <td colspan="1"><b><? echo $row[csf("sew_effi_percent")] ?> </b></td>
                    <td>Internal Ref</td>
                    <td colspan="1"><b><? echo ltrim($ref_cond,", "); ?> </b></td>
                    <td>File No</td>
                    <td colspan="1"><b><? echo $file_cond; ?></b></td>
                    </tr>
                    <tr>
                    <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                    </tr>
                </table>
            <?

			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];

	}//end first foearch

	//start	all summary report here -------------------------------------------
	$sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			$fabric_cost=$row[csf("fabric_cost")];
			$trims_cost=$row[csf("trims_cost")];
			$embel_cost=$row[csf("embel_cost")];
			$comm_cost=$row[csf("comm_cost")];
			$commission=$row[csf("commission")];
			$lab_test=$row[csf("lab_test")];
			$inspection=$row[csf("inspection")];
			$cm_cost=$row[csf("cm_cost")];
			$freight=$row[csf("freight")];
			$currier_pre_cost=$row[csf("currier_pre_cost")];
			$certificate_pre_cost=$row[csf("certificate_pre_cost")];
			$common_oh=$row[csf("common_oh")];
				$sl=$sl+1;
  				$others_cost_value=$row[csf("total_cost")]-$row[csf("cm_cost")]-$row[csf("freight")]-$row[csf("comm_cost")]-$row[csf("commission")];
				if($zero_value==1)
				{

?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);$price_dzn=$row[csf("price_dzn")];//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right" rowspan="13">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("currier_pre_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("currier_percent")],2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("certificate_pre_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("certificate_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-15)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>

            <?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<? echo $sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
	//End all summary report here -------------------------------------------



	    $sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active   from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";

		$data_array=sql_select($sql);
		$knit_fab="";$woven_fab="";
		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
            if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				}
				else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
				}
				$percent_to_order_value=$amount/$price_dzn*100;
				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					 <td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';

				$knit_subtotal_avg_cons += $row[csf("avg_cons")];
				$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
				if($row[csf("fabric_source")] !=2){
				$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
				}
				else{
					$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
				}
			}

			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
				$percent_to_order_value=$amount/$price_dzn*100;
				$j++;
                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';

				$woven_subtotal_avg_cons += $row[csf("avg_cons")];
				$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
				$woven_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Avg. Fab. Cons/Dzn</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab= '<tr><td colspan="7">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
					/*$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg_amount,4).'</td>
					</tr>';*/
					if($zero_value==1)
					{
  		               echo $knit_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $knit_fab;
						}
						else
						{
							echo "";
						}

					}

		//woven fabrics table here
		$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg,4).'</td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg_amount,4).'</td>
					</tr>';*/
   					$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.fn_number_format(($woven_subtotal_amount+$knit_subtotal_amount),4).'</td>
						<td align="right">'.fn_number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
					</tr></table></div>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total (Avg)</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.fn_number_format(($fab_woven_req_yds_avg_amount+$fab_knit_req_kg_avg_amount),4).'</td>
					</tr></table></div>';*/
        // echo $woven_fab;
		 if($zero_value==1)
					{
  		               echo $woven_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $woven_fab;
						}
						else
						{
							echo "";
						}

					}
  		$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
				$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two,color,type_id, min(cons_ratio) as cons_ratio , sum(cons_qnty) as cons_qnty,sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no."  and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
		$data_array=sql_select($sql);
		if($zero_value==1)
		{
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                   <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;  $total_avg_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	  $grand_total_amount +=$total_amount;
	  }
	  else
	  {
		  if($fabric_cost>0)
		  {
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                     <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	      $grand_total_amount +=$total_amount;
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql = "select a.id,a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and b.status_active=1 and b.is_deleted=0 and a.fabric_description=b.id
			where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0  ";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Avg. Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo  fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                    <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($fabric_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Avg. Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                     <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------
   	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active
			from wo_pre_cost_trim_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($trims_cost>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	//start	Embellishment Details part report here -------------------------------------------
    	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {

				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($embel_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {

				$em_type ="";

				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($comm_cost>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
			from  wo_pre_cost_commiss_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($commission>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
				if($row[csf("lab_test")]>0)
				{
  			?>


                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("inspection")]>0)
				{
				?>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("cm_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("freight")]>0)
				{
				?>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                 <?
				}
				if($row[csf("common_oh")]>0)
				{
				?>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
				}
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Other Components  Part report here -------------------------------------------



  	//start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><? echo fn_number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($otherCost,4); ?></td>
                    <td align="center"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Value</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,4); ?></td>
                    <td align="center"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_job_qnty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_job_qnty*$avg_unit_price; echo fn_number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_job_qnty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

           </table>
      </div>

       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>


      <div style="clear:both"></div>
      </div>
    <!--End CM on Net Order Value Part report here -->
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>

	<table class="rpt_table" border="0" cellpadding="1" cellspacing="1" style="width:800px;text-align:center;" rules="all">
		<tr style="alignment-baseline:baseline;">
        	<td height="100" width="33%" style="text-decoration:overline; border:none">Prepared By</td>
            <td width="33%" style="text-decoration:overline; border:none">Checked By</td>
            <td width="33%" style="text-decoration:overline; border:none">Approved By</td>
        </tr>
    </table>
 	<?
	exit();
}

if($action=="preCostRptWoven")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="") $txt_po_breack_down_id_cond=''; else $txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	$poNumber=array();
	$pubShipDate=array();
	$po_qty=0; $po_plun_cut_qty=0; $total_set_qnty=0; $avg_unit_price=0;
	$sql_po="select a.job_no,a.total_set_qnty,a.avg_unit_price,b.id,b.po_number,b.pub_shipment_date,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $txt_po_breack_down_id_cond and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$poNumber[$sql_po_row[csf('po_number')]]=$sql_po_row[csf('po_number')];
		$pubShipDate[$sql_po_row[csf('po_number')]]=change_date_format($sql_po_row[csf('pub_shipment_date')],"dd-mm-yyyy","-");
		$avg_unit_price=$sql_po_row[csf('avg_unit_price')];
	}
	$po_no=""; $po_no=implode(", ",$poNumber);
	$poQtyUom=$po_qty/$total_set_qnty;
	$poPlunCutQtyUom=$po_plun_cut_qty/$total_set_qnty;
	$excessQty=$poPlunCutQtyUom-$poQtyUom;
	$excessPer=(100*$excessQty)/$poQtyUom;

	$gmtsItem=array();
	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
		$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
		$gmtsItem[$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$garments_item[$gmtsitem_ratio_sql_row[csf("gmts_item_id")]];
	}

	$financial_para=array();
	$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
	foreach($sql_std_para as $sql_std_row){
		$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
		$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
		$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
	}


    $sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv,b.sew_effi_percent,b.cut_effi_percent,b.approved from wo_po_details_master a, wo_pre_cost_mst b where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	$data_array=sql_select($sql);
	$uom=""; $jobNo=""; $buyerName=""; $styleRefNo=""; $costingPer="";

	foreach ($data_array as $row){
		$uom=$row[csf("order_uom")];
		$jobNo=$row[csf("job_no")];
		$buyerName=$buyer_arr[$row[csf("buyer_name")]];
		$styleRefNo=$row[csf("style_ref_no")];
		$costingPer=$row[csf("costing_per")];

		$order_price_per_dzn=0;
		if($costingPer==1){ $order_price_per_dzn=12; $costing_for=" DZN";}
		else if($costingPer==2){ $order_price_per_dzn=1; $costing_for=" PCS";}
		else if($costingPer==3){ $order_price_per_dzn=24; $costing_for=" 2 DZN"; }
		else if($costingPer==4){ $order_price_per_dzn=36; $costing_for=" 3 DZN"; }
		else if($costingPer==5){ $order_price_per_dzn=48; $costing_for=" 4 DZN"; }
	}

	//start	all summary report here -------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !='') $condition->job_no("=$txt_job_no");
	if(str_replace("'",'',$txt_po_breack_down_id) !="") $condition->po_id("in($txt_po_breack_down_id)");

	$condition->init();
	$fabric= new fabric($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);

	 $sql_new = "select job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array_new=sql_select($sql_new);
	$summary_data=array();

	foreach( $data_array_new as $row_new ){
		$summary_data[price_dzn]=$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job_per]=($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100;

		$summary_data[commission]=$row_new[csf("commission")];
		$summary_data[trims_cost]=$row_new[csf("trims_cost")];
		$summary_data[emb_cost]=$row_new[csf("embel_cost")];

		$summary_data[lab_test]=$row_new[csf("lab_test")];
		$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

		$summary_data[inspection]=$row_new[csf("inspection")];
		$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

		$summary_data[freight]=$row_new[csf("freight")];
		$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

		$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
		$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

		$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
		$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
		$summary_data[wash_cost]=$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

		$summary_data[cm_cost]=$row_new[csf("cm_cost")];
		$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

		$summary_data[comm_cost]=$row_new[csf("comm_cost")];

		$summary_data[common_oh]=$row_new[csf("common_oh")];
		$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
		$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
		$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
	}

    //Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and fab_nature_id=3";
	$data_arr_fabric=sql_select($sql_fabric);
	$totFabQty=0;
	$totFabAmt=0;
	$FabricData=array();
	foreach($data_arr_fabric as $fab_row){
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$totFabQty+=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$totFabAmt+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];

		$FabricData[$fab_row[csf("id")]]['description']=$body_part[$fab_row[csf("body_part_id")]].", ".$color_type[$fab_row[csf("color_type_id")]].", ".$fab_row[csf("fabric_description")].", ".$fab_row[csf("gsm_weight")];
		$FabricData[$fab_row[csf("id")]]['fabric_source']=$fabric_source[$fab_row[csf("fabric_source")]];
		$FabricData[$fab_row[csf("id")]]['avg_cons']=$fab_row[csf("avg_cons")];
		$FabricData[$fab_row[csf("id")]]['totalConsWoven']=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$FabricData[$fab_row[csf("id")]]['uom']=$unit_of_measurement[$fab_row[csf("uom")]];
		$FabricData[$fab_row[csf("id")]]['rate']=$fab_row[csf("rate")];
		$FabricData[$fab_row[csf("id")]]['amount']=$fab_row[csf("rate")]*$fab_row[csf("avg_cons")];
		$FabricData[$fab_row[csf("id")]]['totalAmountWoven']=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
   $totFabQtyAsCostPer=($totFabQty/$poPlunCutQtyUom)*$order_price_per_dzn;
//Fabric End======================
//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
	from wo_pre_cost_trim_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
		$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;
		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
//End	Trims Cost part report here -------------------------------------------
//Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5)";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();

	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row ){
	$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
	$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
	$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
	$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamount;
	$summary_data[OtherDirectExpenses_job]+=$washamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
//End Wash cost Cost part report here -------------------------------------------

//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
	$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
	$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
	$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
	$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
	$CommiData[$row[csf("id")]]['tot_commission_amount']=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	$totCommi+=$row[csf("commission_amount")];
	$summary_data[commission_job]+=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	}
	$summary_data[commission_job_per]=($summary_data[commission_job]/$summary_data[price_dzn_job])*100;
	//End Commision cost Cost part report here -------------------------------------------

	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
	$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[comm_cost_job]+=$commarcialamount;
	$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
	$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
	$totCommar+=$row[csf("amount")];
	}
	//End Commarcial cost Cost part report here -------------------------------------------
	$NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
	$NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];

	$Less_Cost_Material_Services=array_sum($summary_data[fabric_cost])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];
	$Less_Cost_Material_Services_job=$summary_data[fabric_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];

	$Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
	$Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;

	$Gross_Profit=$Contribution_Margin-$summary_data[cm_cost];
	$Gross_Profit_job=$Contribution_Margin_job-$summary_data[cm_cost_job];

	$OperatingProfitLoss=$Gross_Profit-($summary_data[comm_cost]+$summary_data[common_oh]);
	$OperatingProfitLoss_job=$Gross_Profit_job-($summary_data[comm_cost_job]+$summary_data[common_oh_job]);

	$interest_expense=$NetFOBValue*$financial_para[interest_expense]/100;
	$income_tax=$NetFOBValue*$financial_para[income_tax]/100;
	$interest_expense_job=$NetFOBValue_job*$financial_para[interest_expense]/100;
	$income_tax_job=$NetFOBValue_job*$financial_para[income_tax]/100;
	$Netprofit=$OperatingProfitLoss-($summary_data[depr_amor_pre_cost]+$interest_expense+$income_tax);
	$Netprofit_job=$OperatingProfitLoss_job-($summary_data[depr_amor_pre_cost_job]+$interest_expense_job+$income_tax_job);


?>
    <!--<div style="width:852px; margin:0 auto">
    <div style="width:850px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</d

    <table style="width:850px" ><tr><td colspan="6" align="center">
       <?
        $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
        ?>
        <img  src='../../<? echo $image_location; ?>' height='70' align="left" />
        <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
        <b style="font-size:14px;">Pre- Costing</b>
    </td></tr></table>
    <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
        <tr>
            <td width="80">Job Number</td>
            <td width="80"><b><? echo $jobNo; ?></b></td>
            <td width="90">Buyer</td>
            <td width="100"><b><? echo $buyerName; ?></b></td>
            <td width="80">Garments Item</td>
            <td width="100"><b><? echo implode(",",$gmtsItem); ?></b></td>
        </tr>
        <tr>
            <td>Order Qty </td>
            <td colspan=""><b><? echo $poQtyUom; ?></b></td>
            <td>Excess Cut %</td>
            <td><b><?  echo fn_number_format($excessPer,2) ?></b></td>
            <td>Plan Cut Qty</td>
            <td><b><? echo $poPlunCutQtyUom." ". $unit_of_measurement[$uom];?></b></td>
        </tr>
        <tr>
            <td>Style Ref. No </td>
            <td colspan=""><b><? echo $styleRefNo; ?></b></td>
            <td>Costing Per</td>
            <td><b><? echo $costing_per[$costingPer];?></b></td>
            <td>Price Per Unit</td>
            <td><b><? echo fn_number_format($avg_unit_price,2); ?></b></td>
        </tr>
        <tr>
            <td>Order Numbers</td>
            <td colspan="5"><p><? echo $po_no; ?></p></td>
        </tr>
        <tr>
            <td>Shipment Date </td>
             <td colspan="3"><b><? echo implode(", ",$pubShipDate); ?></b></td>
            <td>Fabric Cons</td>
            <td><b><? echo fn_number_format($totFabQtyAsCostPer,2); ?></b></td>
        </tr>
    </table>
       <div style="margin-top:15px">
         <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<tr style="font-weight:bold">
                        <td width="380" colspan="5">Order Profitability </td>
                    </tr>
                    <tr style="font-weight:bold">
                        <td width="80">Line Items</td>
                        <td width="380">Particulars</td>
                        <td width="100">Amount (USD)/<? echo $costing_for; ?></td>
                        <td width="100">Total Value</td>
                        <td width="100">%</td>
                    </tr>
                    <tr>
                        <td width="80">1</td>
                        <td width="380" align="left" style="font-weight:bold">Gross FOB Value</td>
                        <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn],4); ?></td>
                        <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn_job],4); ?></td>
                        <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[price_dzn_job_per],2);?></td>
                    </tr>
                    <tr>
                        <td width="80">2</td>
                        <td width="380" align="left" style=" padding-left:15px">Less: commission</td>
                        <td width="100" align="right"><? echo fn_number_format($summary_data[commission],4); ?></td>
                        <td width="100" align="right"><? echo fn_number_format($summary_data[commission_job],4); ?></td>
                        <td width="180" align="right"><? echo fn_number_format($summary_data[commission_job_per],2);?></td>
                    </tr>
                    <tr>
                       <td width="80">3</td>
                        <td width="380" align="left" style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
                        <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue,4); ?></td>
                        <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($NetFOBValue_job,4); ?></td>
                        <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,2);?></td>
                    </tr>
                    <tr>
                        <td width="80">4</td>
                        <td width="380" align="left" style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8) </b></td>
                        <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($Less_Cost_Material_Services,4); ?></td>
                        <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($Less_Cost_Material_Services_job,4); ?></td>
                        <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,2);?></td>
                    </tr>
                      <tr>
                        <td width="80">5</td>
                        <td width="380" align="left" style=" padding-left:100px;font-weight:bold">Fabric Purchase Cost</td>
                        <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format(array_sum($summary_data[fabric_cost]),4); ?></td>
                        <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[fabric_cost_job],4); ?></td>
                        <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[fabric_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                    </tr>
                    <tr>
                        <td width="80">6</td>
                        <td width="380" align="left" style=" padding-left:100px;font-weight:bold" ><b>Trim Cost </b></td>
                        <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[trims_cost],4); ?></td>
                        <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[trims_cost_job],4)?></td>
                        <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[trims_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                    </tr>
                    <tr>
                        <td width="80">7</td>
                        <td width="380" align="left" style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
                        <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($summary_data[emb_cost],4); ?></td>
                        <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[emb_cost_job],4); ?></td>
                        <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[emb_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                    </tr>
                        <tr>
                            <td width="80" valign="top">8</td>
                            <td width="380" align="left" style=" padding-left:100px">

                            <table>
                                <tr>
                                <td width="180" style="font-weight:bold">Other Direct Expenses</td>

                                </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">
                                <tr>
                                <td width="180" align="left">Lab Test</td>
                                </tr>

                                <tr>
                                <td width="180" align="left">Inspection</td>

                                </tr>

                                <tr>
                                <td width="180" align="left">Freight Cost</td>

                                </tr>

                                <tr>
                                <td width="180" align="left">Courier Cost</td>

                                </tr>

                                 <tr>
                                <td width="180" align="left">Certificate Cost</td>

                                </tr>

                                <tr>
                                <td width="180" align="left">Garments Wash Cost</td>

                                </tr>

                            </table>
                            </td>
                            <td width="100" align="right" valign="top">
                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[OtherDirectExpenses],4); ?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[lab_test],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[inspection],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[freight],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[currier_pre_cost],4);?></td>
                            </tr>

                             <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[certificate_pre_cost],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[wash_cost],4);?></td>
                            </tr>

                            </table>
                            </td>


                            <td width="100" align="right" valign="top">
                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($summary_data[OtherDirectExpenses_job],4); ?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[lab_test_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[inspection_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[freight_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[currier_pre_cost_job],4);?></td>
                            </tr>

                             <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[certificate_pre_cost_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo fn_number_format($summary_data[wash_cost_job],4);?></td>
                            </tr>

                            </table>
                            </td>
                            <td width="180" align="right" valign="top">

                            <table>
                            <tr>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($summary_data[OtherDirectExpenses_job]/$summary_data[price_dzn_job])*100,2);?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[lab_test_job]/$summary_data[price_dzn_job])*100,2);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[inspection_job]/$summary_data[price_dzn_job])*100,2);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[freight_job]/$summary_data[price_dzn_job])*100,2);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[currier_pre_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                            </tr>

                             <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[certificate_pre_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo fn_number_format(($summary_data[wash_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                            </tr>

                            </table>
                            </td>
                        </tr>
                         <tr>
                            <td width="80">9</td>
                            <td width="380" align="left" style="font-weight:bold">Contributions/Value Additions (3-4)</td>
                            <?

							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($Contribution_Margin,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($Contribution_Margin_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Contribution_Margin_job/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>
                        <tr>
                            <td width="80">10</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: CM Cost </td>
                            <td width="100" align="right"><? echo fn_number_format($summary_data[cm_cost],4); ?> </td>
                            <td width="100" align="right"><? echo fn_number_format($summary_data[cm_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[cm_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>
                        <tr>
                            <td width="80">11</td>
                            <td width="380" align="left" style="font-weight:bold">Gross Profit (9-10)</td>

                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($Gross_Profit,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($Gross_Profit_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Gross_Profit_job/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>

                        <tr>
                            <td width="80">12</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Commercial Cost</td>

                            <td width="100" align="right"> <? echo fn_number_format( $summary_data[comm_cost],4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $summary_data[comm_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[comm_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>
                        <tr>
                            <td width="80">13</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Operating Expensees</td>

                            <td width="100" align="right"><? echo fn_number_format( $summary_data[common_oh],4); ?> </td>
                            <td width="100" align="right"><? echo fn_number_format( $summary_data[common_oh_job],4); ?> </td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[common_oh_job]/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>

                        <tr >
                            <td width="80">14</td>
                            <td width="380" align="left" style="font-weight:bold">Operating Profit/ Loss (11-(12+13))</td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo fn_number_format($OperatingProfitLoss,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format($OperatingProfitLoss_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($OperatingProfitLoss_job/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>
                         <tr>
                            <td width="80">15</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Depreciation & Amortization </td>

                            <td width="100" align="right"> <? echo fn_number_format( $summary_data[depr_amor_pre_cost],4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $summary_data[depr_amor_pre_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($summary_data[depr_amor_pre_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>

                        <tr>

                            <td width="80">16</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Interest </td>

                            <td width="100" align="right"> <? echo fn_number_format( $interest_expense,4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $interest_expense_job,4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($interest_expense_job/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>
                         <tr>
                            <td width="80">17</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Income Tax</td>

                            <td width="100" align="right"> <? echo fn_number_format( $income_tax,4); ?></td>
                            <td width="100" align="right"><? echo fn_number_format( $income_tax_job,4); ?></td>
                            <td width="180" align="right"><? echo fn_number_format(($income_tax_job/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>
                        <tr>
                            <td width="80">18</td>
                            <td width="380" align="left" style="font-weight:bold">Net Profit (14-(15+16+17))</td>

                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit,4); ?> </td>
                            <td width="100" align="right" style="font-weight:bold"><? echo fn_number_format( $Netprofit_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo fn_number_format(($Netprofit_job/$summary_data[price_dzn_job])*100,2);?></td>
                        </tr>
                        </table>
         </div>
      <?
	//End all summary report here -------------------------------------------
	//2	All Fabric Cost part here-------------------------------------------
		?>
        <div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b> Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Total Cons</td>
							<td width="100">UOM</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)/Dzn</td>
							<td width="100">Tot.Amount (USD)</td>
						</tr>
        <?
		$dia_arr=array();
		$sql_dia= "select pre_cost_fabric_cost_dtls_id, dia_width from  wo_pre_cos_fab_co_avg_con_dtls  where job_no=".$txt_job_no."";
		$data_dia_arr=sql_select($sql_dia);
		foreach( $data_dia_arr as $row )
		{
			$dia_arr[$row[csf("pre_cost_fabric_cost_dtls_id")]].=$row[csf("dia_width")].',';
		}
		unset($data_dia_arr);

		foreach( $FabricData as $index=>$row ) {
			    $uom=$row["uom"];
			    $item_descrition =$row['description'];
			    $totalConsWoven=$row["totalConsWoven"];
				$totalAmountWoven=$row["totalAmountWoven"];
				$amount=$row["amount"];
				$dia_str="";
				$dia_str=implode(",",array_unique(array_filter(explode(",",$dia_arr[$index]))));
				?>
                <tr>
                    <td align="left"><?  echo $item_descrition.'; '.$dia_str; ?></td>
                    <td align="left"><?  echo $row["fabric_source"];?></td>
                    <td align="right"><? echo fn_number_format($row["avg_cons"],4);?></td>
					<td align="right"><? echo fn_number_format($totalConsWoven,4);?></td>
					<td align="left"><?  echo $uom; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4);?></td>
                    <td align="right"><? echo fn_number_format($amount,4);?></td>
					<td align="right"><? echo fn_number_format($totalAmountWoven,4);?></td>
                </tr>
                <?
				 $GrandtotalConsWoven+=$totalConsWoven;
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountWoven;
        }
		?>
            <tr class="rpt_bottom" style="font-weight:bold">
            <td colspan="3" align="left">Total</td>
            <td align="right"><? echo fn_number_format(($GrandtotalConsWoven),4);?></td>
            <td></td>
            <td></td>
            <td align="right"><? echo fn_number_format(($GrandtotalDznAmount),4);?></td>
            <td align="right"><? echo fn_number_format(($GrandtotalAmount),4);?></td>
            </tr>
            </table>
            </div>
		<?
		if($zero_value==1){
			echo $woven_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $woven_fab;
			}
			else{
				echo "";
			}
		}
		//end 	All Fabric Cost part report-------------------------------------------
  	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name"  );
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmount=0;
			$TotalAmount=0;
            foreach( $TrimData as $index=>$row )
            {

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                     <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totTrim>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                     <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmount=0;
			$TotalAmount=0;
            foreach( $TrimData as $index=>$row)
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------
	//start	Embellishment Details part report here -------------------------------------------
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmount=0;
		    $TotalAmount =0;
            foreach( $EmbData as $index=>$row )
            {
				$em_type ="";
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totEmb>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
           $TotalDznAmount=0;
		   $TotalAmount =0;
            foreach( $EmbData as $index=>$row  )
            {
				$em_type ="";
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
    <?

		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAount=0;
		   $TotalAount =0;
            foreach( $CommarData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["amount"];
				 $TotalAount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommar>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAount=0;
		   $TotalAount =0;
            foreach( $CommarData as $index=>$row  )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["amount"];
				 $TotalAount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                     <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------

	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAount = 0;
		    $TotalAount = 0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["commission_amount"];
				 $TotalAount += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAount = 0;
		    $TotalAount = 0;
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["commission_amount"];
				 $TotalAount += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------
	echo signature_table(109, $cbo_company_name, "860px");
	?>
    </div>
    <?
	exit();
}

if($action=="preCostRptOrder")//Order Wise Pre Costing Used in Fabric Receive Status Report and Cost Break Down Report
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	$order_id=$txt_job_no;

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";


	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	if($db_type==0)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio, d.po_number, d.po_quantity as po_qnty, d.unit_price, d.pub_shipment_date from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c, wo_po_break_down d where a.job_no=b.job_no and a.job_no=d.job_no_mst and b.job_no=c.job_no and a.status_active=1 and d.id=$order_id $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date";
	}
	if($db_type==2)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio, d.po_number, d.po_quantity as po_qnty, d.unit_price, d.pub_shipment_date from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c, wo_po_break_down d where a.job_no=b.job_no and a.job_no=d.job_no_mst and b.job_no=c.job_no and a.status_active=1 and d.id=$order_id $company_name $cbo_buyer_name $txt_style_ref";
	}

	$data_array=sql_select($sql);


	?>
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>
	<?
	$uom="";
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;

		$order_values = $row[csf("po_qnty")]*$row[csf("unit_price")];

		$job_in_orders = $row[csf("po_number")];
		$pulich_ship_date = $row[csf("pub_shipment_date")];
?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Garments Item</td>
                        <?
							$gmts_item='';
							$gmts_item_id=explode(",",$row[csf('gmts_item_id')]);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=",".$garments_item[$item_id];
							}

						?>
                        <td width="100"><b><? echo $gmts_item; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td colspan="3"><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Order Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("po_qnty")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="5"><? echo $job_in_orders; ?></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>
                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")]; ?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("unit_price")]; ?> USD</b></td>
                    </tr>
                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $cting_per[$row[csf("costing_per")]]; ?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                </table>
            <?

			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("po_qnty")];
			$avg_unit_price=$row[csf("unit_price")];

	}//end first foearch


	//id, fab_yarn_req_kg,fab_woven_req_yds,fab_knit_req_kg,fab_amount,yarn_cons_qnty,yarn_amount,conv_req_qnty,conv_charge_unit,conv_amount,trim_cons,trim_rate,trim_amount,emb_amount,comar_rate,comar_amount,commis_rate,commis_amount
	// 	costing_per_id 	order_uom_id 	fabric_cost 	fabric_cost_percent 	trims_cost 	trims_cost_percent 	embel_cost
	//embel_cost_percent 	comm_cost 	comm_cost_percent 	commission 	commission_percent 	lab_test 	lab_test_percent 	inspection
	//inspection_percent 	cm_cost,cm_cost_percent 	freight,freight_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent
	// 	price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
	//margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche

	$job_no=$row[csf('job_no')];
	//start	all summary report here -------------------------------------------
	$sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no='".$job_no."' and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
            $sl=0;
            foreach( $data_array as $row )
            {
			$fabric_cost=$row[csf("fabric_cost")];
			$trims_cost=$row[csf("trims_cost")];
			$embel_cost=$row[csf("embel_cost")];
			$comm_cost=$row[csf("comm_cost")];
			$commission=$row[csf("commission")];
			$lab_test=$row[csf("lab_test")];
			$inspection=$row[csf("inspection")];
			$cm_cost=$row[csf("cm_cost")];
			$freight=$row[csf("freight")];
			$common_oh=$row[csf("common_oh")];
				$sl=$sl+1;
  				$others_cost_value=$row[csf("total_cost")]-$row[csf("cm_cost")]-$row[csf("freight")]-$row[csf("comm_cost")]-$row[csf("commission")];
				if($zero_value==1)
				{

?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right" rowspan="10">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:11)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-12)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>

            <?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<? echo $sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
		//End all summary report here -------------------------------------------



		//2	All Fabric Cost part here-------------------------------------------
		$sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount,avg_finish_cons,status_active
			from wo_pre_cost_fabric_cost_dtls
			where job_no='".$job_no."'";
		$data_array=sql_select($sql);
		$knit_fab="";$woven_fab="";

		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
            if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],4).'</td>
                </tr>';

				$knit_subtotal_avg_cons += $row[csf("avg_cons")];
				$knit_subtotal_amount += $row[csf("amount")];
			}

			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$j++;
                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],4).'</td>
                </tr>';

				$woven_subtotal_avg_cons += $row[csf("avg_cons")];
				$woven_subtotal_amount += $row[csf("amount")];
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
						</tr>'.$knit_fab;
		$woven_fab= '<tr><td colspan="6">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Sub Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
					</tr>';
					if($zero_value==1)
					{
  		               echo $knit_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $knit_fab;
						}
						else
						{
							echo "";
						}

					}

		//woven fabrics table here
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Sub Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
					</tr>
   					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Total</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.fn_number_format(($woven_subtotal_amount+$knit_subtotal_amount),4).'</td>
					</tr></table></div>';
        // echo $woven_fab;
		 if($zero_value==1)
					{
  		               echo $woven_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $woven_fab;
						}
						else
						{
							echo "";
						}

					}
  		$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//Mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no='".$job_no."' group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//Oracle
				$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='".$job_no."' group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";
		$data_array=sql_select($sql);
		if($zero_value==1)
		{
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?
	  $grand_total_amount +=$total_amount;
	  }
	  else
	  {
		  if($fabric_cost>0)
		  {
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?
	      $grand_total_amount +=$total_amount;
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql = "select a.id,a.fabric_description, a.job_no, a.cons_process, a.req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id
			where a.job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo $total_amount; ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="4">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($fabric_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo $total_amount; ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="4">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------
   	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active
			from wo_pre_cost_trim_cost_dtls
			where job_no='".$job_no."' and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($trims_cost>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	//start	Embellishment Details part report here -------------------------------------------
    	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($embel_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>

                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($comm_cost>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
			from  wo_pre_cost_commiss_cost_dtls
			where job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($commission>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no='".$job_no."' and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <tr>

                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
				if($row[csf("lab_test")]>0)
				{
  			?>


                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("inspection")]>0)
				{
				?>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("cm_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("freight")]>0)
				{
				?>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                 <?
				}
				if($row[csf("common_oh")]>0)

				{
				?>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
				}
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Other Components  Part report here -------------------------------------------



  	//start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no='".$job_no."' and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><? echo fn_number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($otherCost,4); ?></td>
                    <td align="center"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Value</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,4); ?></td>
                    <td align="center"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_job_qnty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_job_qnty*$avg_unit_price; echo fn_number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_job_qnty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

           </table>
      </div>

       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id='".$job_no."'";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>


      <div style="clear:both"></div>
      </div>
    <!--End CM on Net Order Value Part report here -->
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>
    <br/>
	<?
	echo signature_table(109, $cbo_company_name, "860px");
	exit();
}
//generate_report BOM--------------------------------------------------------------

if($action=="bomRpt")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";

	$path=str_replace("'","",$path);

	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");


	$result =sql_select("select id,po_number,pub_shipment_date,po_received_date,file_no,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
	$job_in_orders = array();
	$pulich_ship_date='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders[$val[csf('id')]]= $val[csf('po_number')];
		$pulich_ship_date = $val[csf('pub_shipment_date')];
		$job_in_ref[$val[csf('id')]]= $val[csf('grouping')];
	    $job_in_file[$val[csf('id')]]= $val[csf('file_no')];
	}
	$ref_cond=implode(",",array_unique($job_in_ref));

	$file_cond=implode(",",array_unique($job_in_file));
	$job_in_orders=implode(", ",$job_in_orders);

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0){
	   $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,a.order_repeat_no,a.quotation_id,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty,c.costing_date,c.costing_per,c.budget_minute,c.approved,   d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name  $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.ship_mode,a.gmts_item_id,a.order_uom, a.avg_unit_price,a.order_repeat_no,a.quotation_id,c.costing_date,c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	if($db_type==2){
	    $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,a.order_repeat_no,a.quotation_id,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty,c.costing_date,c.costing_per,c.budget_minute,c.approved,d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name  group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom,a.ship_mode,a.order_repeat_no, a.quotation_id,a.avg_unit_price,c.costing_date, c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg  order by a.job_no";
	}
	$data_array=sql_select($sql);
	?>
    <!--<div style="width:852px; margin:0 auto">
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? //echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">BOM Report</div>-->
	<?

	$order_job_qnty=0;
	$ord_qty=0;
	$avg_unit_price=0;
	$order_values=0;
	$order_price_per_dzn=0;
	$costing_for='';
	foreach ($data_array as $row){
	    $order_job_qnty=$row[csf("job_quantity")];
		$ord_qty=$row[csf("ord_qty")];
		$avg_unit_price=$row[csf("avg_unit_price")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];

		if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
		else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
		else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
		else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
		else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
		if($path=='')
		{
			$path="../../";
		}
		else
		{
			$path="../";
		}
		?>
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Pre- Costing</b>
        </td></tr></table>

        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;" rules="all">
            <tr>
                <td width="80">Job Number</td>
                <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="90">Buyer</td>
                <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td width="80">Plan Cut Qnty</td>
                <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
            </tr>
            <tr>
                <td>Order Qty</td>
                <td><b><? echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                <td>Style Ref. No</td>
                <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                <td>Price Per Unit</td>
                <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
            </tr>
            <tr>
                <td>Order Numbers</td>
                <td colspan="5"><? echo $job_in_orders; ?></td>
                </tr>
                <tr>
                <td>Garments Item</td>
                <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                <td>Shipment Date</td>
                <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
            </tr>
            <tr>
                <td>Budget Minute</td>
                <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                <td align="center" height="10" colspan="5" valign="top" id="app_sms" style="font-size:18px;">
                <font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?></font>
                </td>

            </tr>
            <tr>
                <td>Internal Ref</td>
                <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                <td>File No</td>
                <td colspan="2"><b><? echo $file_cond; ?></b></td>
            </tr>
             <tr>
                <td>Costing Date</td>
                <td colspan="2"><b><? echo change_date_format($row[csf("costing_date")]); ?></b></td>
                <td>Ship Mode</td>
                <td colspan="2"><b><? echo $shipment_mode[$row[csf("ship_mode")]]; ?></b></td>
            </tr>
             <tr>
                <td>Order Repeat No</td>
                <td colspan="2"><b><? echo $row[csf("order_repeat_no")]; ?></b></td>
                <td>Quotation Id</td>
                <td colspan="2"><b><? echo $row[csf("quotation_id")]; ?></b></td>

            </tr>
        </table>
            <?
	}//end first foearch

	//2 Fabric Cost part here-------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !="")
	{
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);  //echo $fabric->getQuery();
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$commercial= new commercial($condition);

	$sql = "select id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, fabric_description, gsm_weight, avg_cons, uom, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);

	$knit_fab=""; $knit_subtotal_amount=0; $knit_subtotal_amount_dzn=0; $woven_fab=""; $woven_subtotal_amount=0; $woven_subtotal_amount_dzn=0;

	$i=1;$j=1;
	foreach( $data_array as $row ){
		$uom=$unit_of_measurement[$row[csf("uom")]];
		$knit_cost_dzn=$row[csf("amount")];
		$woven_cost_dzn=$row[csf("amount")];
		//knit fabrics=============
		if($row[csf("fab_nature_id")]==2){
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
			$fincons=$fabric_qty['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			$greycons=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$amount=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];

			$i++;
			$knit_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($greycons,4).'</td>
				<td align="right">'.fn_number_format($fincons,4).'</td>
				<td align="left">'.$uom.'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,4).'</td>
			</tr>';
			if($row[csf("uom")]==12){
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
				$knit_subtotal_amount+=$amount;
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
			}
			else if($row[csf("uom")]==27){
				$knit_subtotal_avg_cons_yds+=$greycons;
				$knit_subtotal_avg_finish_cons_yds+=$fincons;
				$knit_subtotal_amount_yds+=$amount;
				$knit_subtotal_amount_dzn_yds+=$knit_cost_dzn;
			}
			else if($row[csf("uom")]==1){
				$knit_subtotal_avg_cons_pcs+=$greycons;
				$knit_subtotal_avg_finish_cons_pcs+=$fincons;
				$knit_subtotal_amount_pcs+=$amount;
				$knit_subtotal_amount_dzn_pcs+=$knit_cost_dzn;
			}
			else if($row[csf("uom")]==23){
				$knit_subtotal_avg_cons_mtr+=$greycons;
				$knit_subtotal_avg_finish_cons_mtr+=$fincons;
				$knit_subtotal_amount_mtr+=$amount;
				$knit_subtotal_amount_dzn_mtr+=$knit_cost_dzn;
			}
			 $XGrandtotalAmount+=$amount;
		}
		//woven fabrics======================
		if($row[csf("fab_nature_id")]==3){
			$fincons=$fabric_qty['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			$greycons=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$amount=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			$j++;
			$woven_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($greycons,4).'</td>
				<td align="right">'.fn_number_format($fincons,4).'</td>
				<td align="left">'.$uom.'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,4).'</td>
			</tr>';
			if($row[csf("uom")]==12){
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$amount;
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
			}
			else if($row[csf("uom")]==27){
				$woven_subtotal_avg_cons_yds+=$greycons;
				$woven_subtotal_avg_finish_cons_yds+=$fincons;
				$woven_subtotal_amount_yds+=$amount;
				$woven_subtotal_amount_dzn_yds+=$woven_cost_dzn;

				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$amount;
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
			}
			else if($row[csf("uom")]==1){
				$woven_subtotal_avg_cons_pcs+=$greycons;
				$woven_subtotal_avg_finish_cons_pcs+=$fincons;
				$woven_subtotal_amount_pcs+=$amount;
				$woven_subtotal_amount_dzn_pcs+=$woven_cost_dzn;

				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$amount;
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
			}
			else if($row[csf("uom")]==23){
				$woven_subtotal_avg_cons_mtr+=$greycons;
				$woven_subtotal_avg_finish_cons_mtr+=$fincons;
				$woven_subtotal_amount_mtr+=$amount;
				$woven_subtotal_amount_dzn_mtr+=$woven_cost_dzn;

				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$amount;
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
			}
			 $XGrandtotalAmount+=$amount;
		}
	}
	if($knit_subtotal_avg_cons_pcs>0) $i++;
	if($knit_subtotal_avg_cons>0) $i++;
	if($knit_subtotal_avg_cons_mtr>0) $i++;
	if($knit_subtotal_avg_cons_yds>0) $i++;

	if($woven_subtotal_avg_cons_pcs>0) $j++;
	if($woven_subtotal_avg_cons>0) $j++;
	if($woven_subtotal_avg_cons_mtr>0) $j++;
	if($woven_subtotal_avg_cons_yds>0) $j++;

	$knit_fab= '<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<tr style="font-weight:bold"  align="center">
						<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
						<td width="300">Description</td>
						<td width="100">Source</td>
						<td width="100">Gray Fabric Qnty</td>
						<td width="100">Finish Fab Qnty</td>
						<td width="50">UOM</td>
						<td width="50">Rate</td>
						<td width="50">Amount</td>
					</tr>'.$knit_fab;
	if($woven_subtotal_avg_cons_pcs>0 || $woven_subtotal_avg_cons>0 || $woven_subtotal_avg_cons_mtr>0 || $woven_subtotal_avg_cons_yds>0){
		$woven_fab = '<tr><td colspan="8">&nbsp;</td></tr><tr>
					<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
	}

	//knit fabrics table here
	if($knit_subtotal_avg_cons>0){
	$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Sub Total (kg)</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($knit_subtotal_amount/$knit_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
				</tr>';
	}
	if($knit_subtotal_avg_cons_yds>0){
	$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Sub Total (Yds)</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yds,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_yds,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($knit_subtotal_amount_yds/$knit_subtotal_avg_cons_yds,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_amount_yds,4).'</td>
				</tr>';
	}
	if($knit_subtotal_avg_cons_pcs>0){
	$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Sub Total (Pcs)</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons_pcs,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_pcs,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($knit_subtotal_amount_pcs/$knit_subtotal_avg_cons_pcs,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_amount_pcs,4).'</td>
				</tr>';
	}
	if($knit_subtotal_avg_cons_mtr>0){
	$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Total (Mtr)</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons_mtr,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_mtr,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($knit_subtotal_amount_mtr/$knit_subtotal_avg_cons_mtr,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_amount_mtr,4).'</td>
				</tr>';
	}
	echo $knit_fab;

	//woven fabrics table here
	if($woven_subtotal_avg_cons>0){
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Sub Total (kg)</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($woven_subtotal_amount/$woven_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
				</tr>';
	}
	if($woven_subtotal_avg_cons_yds>0){
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Sub Total (Yds)</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons_yds,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons_yds,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($woven_subtotal_amount_yds/$woven_subtotal_avg_cons_yds,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_amount_yds,4).'</td>
				</tr>';
	}
	if($woven_subtotal_avg_cons_pcs>0){
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Sub Total (Pcs)</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons_pcs,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons_pcs,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($woven_subtotal_amount_pcs/$woven_subtotal_avg_cons_pcs,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_amount_pcs,4).'</td>
				</tr>';
	}
	if($woven_subtotal_avg_cons_mtr>0){
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2">Total (Mtr)</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons_mtr,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons_mtr,4).'</td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($woven_subtotal_amount_mtr/$knit_subtotal_avg_cons_mtr,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_amount_mtr,4).'</td>
				</tr>';
	}
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="3">Total</td>
					<td align="right"></td>
					<td align="right"></td>
					<td align="right"></td>
					<td align="right"></td>
					<td align="right">'.fn_number_format($XGrandtotalAmount,4).'</td>
				</tr>
				</table></div>';
	echo $woven_fab;

		//end 	All Fabric Cost part report-------------------------------------------

		//Start	Yarn Cost part report here -------------------------------------------
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
		$sql = "select min(id) as id, count_id, copm_one_id, percent_one,  color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one,  color,type_id, rate";
		$data_array=sql_select($sql);
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
             <label><b>Yarn Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($rowcons_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($rowavgcons_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($rowamount,4); ?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_yarn_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_avg_yarn_qty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?

	//End Yarn Cost part report here -------------------------------------------

	//start	Conversion Cost to Fabric report here -------------------------------------------
    $conv_data_qty=$conversion->getQtyArray_by_conversionid();
	//echo $conversion->getQuery();
	//print_r($conv_data_qty);
	$conv_data_amt=$conversion->getAmountArray_by_conversionid();
	$data_array=array();
	$sql_count = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id,b.uom from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and b.status_active=1 and b.is_deleted=0 and a.fabric_description=b.id where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by  a.cons_process";
	$tot_data_array=sql_select($sql_count);
	foreach( $tot_data_array as $row ){
			 $item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['item_descrition']=$item_descrition;
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['cons_process']=$conversion_cost_head_array[$row[csf("cons_process")]];
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['req_qnty']=$row[csf('req_qnty')];;
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['tot_req_qnty']=$conv_data_qty[$row[csf('id')]][$row[csf('uom')]];
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['uom']=$row[csf('uom')];
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['charge_unit']=$row[csf('charge_unit')];
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['amount']=$row[csf('amount')];
			 $data_array[$row[csf("cons_process")]][$row[csf("id")]]['tot_amount']=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];
	 }
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
             <label><b>Conversion Cost to Fabric</b></label>
                <tr style="font-weight:bold">
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Required</td>
                    <td width="100">UOM</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
            $total_conversion_cost=0; $total_conversion_cost_dzn=0; $total_conversion_cost_kg=0; $total_convsion_qty=0; $total_avg_convsion_qty=0; $grand_total_conv_qnty=0; $grand_total_avg_convsion_qty=0; $grand_total_conversion_cost=0;

			$total_conversion_cost_yds=0; $total_conversion_cost_dzn_yds=0; $total_conversion_cost_kg_yds=0; $total_convsion_qty_yds=0; $total_avg_convsion_qty_yds=0; $grand_total_conv_qnty_yds=0; $grand_total_avg_convsion_qty_yds=0; $grand_total_conversion_cost_yds=0;

			$process_array_check=array();
			$k=1;
            foreach( $data_array as $cons_process_id=>$cons_process_idArr )
            {
				$processAmt=0;$processQty=0;
				foreach( $cons_process_idArr as $id=>$row )
				{
					$processAmt+=$row['tot_amount'];
					$processQty+=$row['tot_req_qnty'];
					?>
						<tr>
							<td align="left"><? echo $row['item_descrition']; ?></td>
							<td align="left"><? echo $row['cons_process']; ?></td>
							<td align="right"><? echo fn_number_format($row['tot_req_qnty'],4); ?></td>
							<td align=""><? echo $unit_of_measurement[$row['uom']]; //fn_number_format($conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]],4); ?></td>
							<td align="right"><? echo fn_number_format($row['charge_unit'],4); ?></td>
							<td align="right"><? echo fn_number_format($row['tot_amount'],4); ?></td>
						</tr>
					<?
					if($row['uom']==12){
						$total_convsion_qty+=$row['tot_req_qnty'];
						$total_conversion_cost += $row['tot_amount'];

						$grand_total_conv_qnty+=$row['tot_req_qnty'];
						$grand_total_conversion_cost+= $row['tot_amount'];

						$total_conversion_cost_dzn+=$row['amount'];
						$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
					}
					if($row['uom']==27){
						$total_convsion_qty_yds+=$row['tot_req_qnty'];
						$total_conversion_cost_yds += $row['tot_amount'];

						$grand_total_conv_qnty_yds+=$row['tot_req_qnty'];
						$grand_total_conversion_cost_yds+= $row['tot_amount'];

						$total_conversion_cost_dzn_yds+=$row['amount'];
						$total_conversion_cost_kg_yds=$grand_total_conversion_cost_yds/$total_avg_yarn_qty_yds;
					}
					if($row['uom']==1){
						$total_convsion_qty_pcs+=$row['tot_req_qnty'];
						$total_conversion_cost_pcs += $row['tot_amount'];

						$grand_total_conv_qnty_pcs+=$row['tot_req_qnty'];
						$grand_total_conversion_cost_pcs+= $row['tot_amount'];

						$total_conversion_cost_dzn_pcs+=$row['amount'];
						$total_conversion_cost_kg_pcs=$grand_total_conversion_cost_pcs/$total_avg_yarn_qty_pcs;
					}
					if($row['uom']==23){
						$total_convsion_qty_mtr+=$row['tot_req_qnty'];
						$total_conversion_cost_mtr += $row['tot_amount'];

						$grand_total_conv_qnty_mtr+=$row['tot_req_qnty'];
						$grand_total_conversion_cost_mtr+= $row['tot_amount'];

						$total_conversion_cost_dzn_mtr+=$row['amount'];
						$total_conversion_cost_kg_mtr=$grand_total_conversion_cost_pcs/$total_avg_yarn_qty_mtr;
					}
				}
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="right">Process Total</td>
					<td align="right"><? //echo fn_number_format($processQty,4); ?></td>
					<td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo fn_number_format($processAmt,4); ?></td>
				</tr>
				<?
			}
			/*if($grand_total_conv_qnty>0){// hide by ISD-22-29712
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="right">Total </td>
					<td align="right"><? //echo fn_number_format($grand_total_conv_qnty,4); ?></td>
					<td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
				</tr>
				<?
			}*/
			if($grand_total_conv_qnty_yds>0){
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="right">Grand Total (Yds)</td>
					<td align="right"><? //echo fn_number_format($grand_total_conv_qnty_yds,4); ?></td>
					<td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo fn_number_format($grand_total_conversion_cost_yds,4); ?></td>
				</tr>
				<?
			}
			if($grand_total_conv_qnty_pcs>0){
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="right">Grand Total (Pcs)</td>
					<td align="right"><? //echo fn_number_format($grand_total_conv_qnty_pcs,4); ?></td>
					<td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo fn_number_format($grand_total_conversion_cost_pcs,4); ?></td>
				</tr>
				<?
			}
			if($grand_total_conv_qnty_mtr>0){
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="right">Grand Total (Mtr)</td>
					<td align="right"><? //echo fn_number_format($grand_total_conv_qnty_mtr,4); ?></td>
					<td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo fn_number_format($grand_total_conversion_cost_mtr,4); ?></td>
				</tr>
				<?
			}

			if($grand_total_conversion_cost>0){
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="right">Grand Total (Kg)</td>
					<td align="right"><? //echo fn_number_format($grand_total_conv_qnty_mtr,4); ?></td>
					<td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
				</tr>
				<?
			}
			?>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -----------------------------------



	//start	Trims Cost part report here -------------------------------------------
    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="100">Nominated Supp</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="50">UOM</td>
                    <td width="100">Consumption</td>
                    <td width="50">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
			//echo $trim->getQuery();
			$trim_qty=$trim->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount=$trim->getAmountArray_precostdtlsid();
            $total_trims_cost=0;
			$total_trims_qty=0;
			$total_trims_cost_dzn=0;
			$total_trims_cost_kg=0;
            foreach( $data_array as $row ){

				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$cons_dzn_gmts=$trim_qty[$row[csf("id")]];
				$amount=$trim_amount[$row[csf("id")]];
			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $supplier_name_arr[$row[csf("nominated_supp")]]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($cons_dzn_gmts,4); //fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($amount,4) //fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_trims_cost+= $amount;
				 $total_trims_qty += $row[csf("cons_dzn_gmts")];
				 $total_trims_cost_dzn+=$row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="7">Total</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------



	 //start	Embellishment Details part report here -------------------------------------------
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Gmts. Qnty (Dzn)</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();

			$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
            $total_embellishment_amt=0;
			$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {
				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				if($row[csf("emb_name")] !=3){
				$cons_dzn_gmts=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
				$amount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
				}
				else if($row[csf("emb_name")] ==3){
				$cons_dzn_gmts=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
				$amount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
				}
				$total_embellishment_amt_dzn += $row[csf("amount")];
				//$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$order_job_qnty;
				//$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$order_job_qnty;
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($cons_dzn_gmts); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_embellishment_amt += $amount;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	//$condition->init();
	//$commercial= new commercial($condition);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$total_commercial_cost_dzn+= $row[csf("amount")];

				$amount =$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];// $row[csf("amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_commercial_cost += $amount;

            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount = $row[csf("commission_amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($commission_amount,4); ?></td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	//End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,currier_pre_cost, currier_percent, 	certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_other_components=0;$lab_test_dzn=0;
			$lab_test = 0;
			$inspection = 0;
			$cm_cost = 0;
			$freight = 0;
			$common_oh = 0;
            foreach( $data_array as $row )
            {
				$lab_test = $row[csf("lab_test")]/$order_price_per_dzn*$ord_qty;
				$inspection = $row[csf("inspection")]/$order_price_per_dzn*$ord_qty;
				$cm_cost = $row[csf("cm_cost")]/$order_price_per_dzn*$ord_qty;
				$freight = $row[csf("freight")]/$order_price_per_dzn*$ord_qty;
				$common_oh = $row[csf("common_oh")]/$order_price_per_dzn*$ord_qty;
				$currier_pre_cost = $row[csf("currier_pre_cost")]/$order_price_per_dzn*$ord_qty;
				$certificate_pre_cost = $row[csf("certificate_pre_cost")]/$order_price_per_dzn*$ord_qty;
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
   			?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
            <?
                 $total_other_components += $lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">

            <?
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = 0;
            $total_summary_amount = $total_commission_cost+$total_commercial_cost+$total_embellishment_amt+$total_trims_cost+$grand_total_conversion_cost+$total_yarn_amount +$woven_subtotal_amount+$knit_subtotal_amount+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh+$grand_total_conversion_cost_yds;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:500px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/DZN</td>
                    <td width="100">Cost/Kg</td>
                    <td width="100">Total</td>
                 </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (kg) </td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount/$knit_subtotal_avg_cons,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Knit Fabric (Purchase) (Yds)</td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_yds/$knit_subtotal_avg_cons_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_yds,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (Pcs)</td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn_pcs,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_pcs/$knit_subtotal_avg_cons_pcs,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_pcs,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (Mtr)</td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn_mtr,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_mtr/$knit_subtotal_avg_cons_mtr,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_mtr,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Woven Fabric (Purchase)</td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount/$woven_subtotal_avg_cons,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Yarn</td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric (Kg)</td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric (Yds)</td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_dzn_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_kg_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($grand_total_conversion_cost_yds,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost_dzn,4); ?></td>
                    <td align="right" rowspan="11"><? //echo fn_number_format($total_trims_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commission</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_summary_amount,4); ?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
      </div>
      <!--End CM on Net Order Value Part report here -->
       <br/>
 	<? echo signature_table(109, $cbo_company_name, "850px");?>
	</div>
	 <?
	 exit();
}

if($action=="bomRpt2")
{
	// extract($_REQUEST);
	$process = array( &$_POST );
	$user_id=$_SESSION['logic_erp']['user_id'];
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$user_arr=return_library_array( "select id, user_name from user_passwd",'id','user_name');

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
  //  $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
    $grmts_sql = sql_select("select c.order_total,b.job_no,b.gmts_item_id,b.set_item_ratio,c.item_number_id from wo_po_details_mas_set_details b,wo_po_color_size_breakdown c where c.job_id=b.job_id and b.gmts_item_id=c.item_number_id and c.status_active=1 and c.is_deleted =0 and b.job_no=$txt_job_no");
	$tot_order_value=0;
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("item_number_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('item_number_id')]]=$val[csf('set_item_ratio')];
		$tot_order_value+=$val[csf("order_total")];
	}
	$grmnt_itemss = rtrim($grmnt_items,",");
	$grmnt_items =implode(",", array_unique(explode(",",$grmnt_itemss )));
	if($db_type==0) $po_id_cond="group_concat( distinct b.id) as po_id";
	if($db_type==2) $po_id_cond="listagg(b.id ,',') within group (order by b.id) AS po_id";
	$sql = "SELECT a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.avg_unit_price,SUM (b.plan_cut) AS job_quantity,SUM (b.po_quantity) AS ord_qty,$po_id_cond,c.costing_per,c.budget_minute,c.costing_date,c.approved,c.inserted_by,c.sew_smv,c.remarks,d.fab_knit_fin_req_kg,d.fab_knit_req_kg,d.fab_woven_req_yds,d.fab_woven_fin_req_yds,d.fab_yarn_req_kg,a.style_description,e.user_name FROM user_passwd e,wo_po_details_master a,wo_po_break_down b,wo_pre_cost_mst c LEFT JOIN wo_pre_cost_sum_dtls d ON     c.job_id = d.job_id AND d.status_active = 1 AND d.is_deleted = 0 WHERE   c.INSERTED_BY = e.id AND a.id = b.job_id AND b.job_id = c.job_id AND a.status_active = 1 AND a.is_deleted = 0 AND b.status_active = 1 AND b.is_deleted = 0 AND c.status_active = 1 AND c.is_deleted = 0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.inserted_by,c.budget_minute,c.costing_date,c.sew_smv,c.remarks, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,a.style_description,e.user_name  order by a.job_no"; //a.job_quantity as job_quantity,
 
	//echo $sql;die;
	
	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	$po_quantity=$data_array[0][csf('ord_qty')];
	$all_po_id=$data_array[0][csf('po_id')];
	$is_approved=$data_array[0][csf('approved')];
	$inserted_by=$data_array[0][csf('inserted_by')];
	$pocond="";
	if($all_po_id!="")
	{
		$pocond="and id in($all_po_id)";
	}

	//echo $plan_cut_qty;
	//echo $order_value=$plan_cut_qty*$data_array[0][csf('avg_unit_price')];
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id, embellishment_budget_id from variable_order_tracking where company_name=$cbo_company_name and variable_list=56 and status_active=1 and is_deleted=0");
	//$embel_type_id=0;$embel_type_id=0;
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$embel_type_id=$vari_row[csf('embellishment_id')];
		$embelt_budget_qty_id_arr[$embel_type_id]=$vari_row[csf('embellishment_budget_id')];
	}

	?>
    <!--<div style="width:852px; margin:0 auto">
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? //echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">BOM Report 2</div>-->
	<?


	$result =sql_select("select po_number,pub_shipment_date,file_no,excess_cut,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 $pocond order by pub_shipment_date DESC");
	// $tot_row=count($result);
	$job_in_orders = '';$pulich_ship_date='';$job_in_ref = '';$job_in_file = '';
	$tot_excess_cut=0;$tot_row=0;
	foreach ($result as $val)
	{
		$job_in_orders .= $val[csf('po_number')].", ";
		$pulich_ship_date = $val[csf('pub_shipment_date')];
		if($val[csf('excess_cut')]>0)
		{
			$tot_row++;
		}
		$tot_excess_cut+= $val[csf('excess_cut')];
		//$job_in_ref .= $val[csf('grouping')].", ";
		//$job_in_file .= $val[csf('file_no')].", ";
		if($job_in_ref=='') $job_in_ref= $val[csf('grouping')]; else $job_in_ref.=",". $val[csf('grouping')];
		if($job_in_file=='') $job_in_file= $val[csf('file_no')]; else $job_in_file.=",". $val[csf('file_no')];
	}
	$costing_date='';
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$order_values = $row[csf("ord_qty")]*$row[csf("avg_unit_price")];

		$avg_excess_cut=$tot_excess_cut/$tot_row;

		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",$job_in_ref));
		$job_file=array_unique(explode(",",rtrim($job_in_file,",")));
		$all_po_id = rtrim($all_po_id,",");
		$all_po_ids=implode(",",array_unique(explode(",",$all_po_id)));
		$costing_date = $row[csf('costing_date')];
		$user_name = $row[csf('user_name')];
		//print_r($job_ref);
		$ref_cond='';
		foreach ($job_ref as $ref)
		{
			//$ref_cond.=", ".$ref;
			if($ref_cond=='') $ref_cond=$ref; else $ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}
		$img_path=str_replace("'", "", $img_path);
		$path=str_replace("'", "", $path);

		if(empty($img_path) && empty($path))
		{
			$img_path='../../';
		}
		else if(!empty($path))
		{
			$img_path=$path;
		}
		// echo $img_path;
		?>
            <table style="width:850px" >
				<tr>
					<td colspan="6" align="center">
						<?
						$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
						?>
						<img  src='<?=$img_path;?><? echo $image_location; ?>' height='70' align="left" />
						<b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
						<b style="font-size:14px;">BOM Report 2</b>
					</td>
				</tr>
			</table>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Plan Cut Qnty</td>
                        <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; $uom=$row[csf("order_uom")]; ?></b></td>
                    </tr>
                    <tr>
                        <td>Order Qty</td>
                        <td>
							<b>
							<?
							$order_qty=$row[csf("ord_qty")];
							echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; 
							?>
							</b>
						</td>
                    	<td>Style Ref. No</td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
						<td>Style Desc</td>
                        <td><? echo $row[csf("style_description")]; ?></td>
                    </tr>
                    <tr>
                    	<td>Garments Item</td>
                        <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                        <td>Shipment Date</td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                     <tr>
                    	<td>Avg Cons. Grey</td>
                        <td align=""><b><? echo fn_number_format($row[csf("fab_knit_req_kg")]+$row[csf("fab_woven_req_yds")],2); ?></b></td>
                        <td>Avg Cons. Fin.</td>
                        <td align=""><b><? echo fn_number_format($row[csf("fab_knit_fin_req_kg")]+$row[csf("fab_woven_fin_req_yds")],2); ?></b></td>
                        <td>Plan Cut%</td>
                        <td><b><? echo fn_number_format($avg_excess_cut,2); ?></b></td>
                    </tr>
                    <tr>
                    	<td>Budget Minute</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
						<?
						$approval_allow=sql_select("select b.id, b.page_id, b.approval_need, b.allow_partial, b.validate_page,a.setup_date from approval_setup_mst a,approval_setup_dtls b
						where a.id=b.mst_id and a.company_id=$cbo_company_name and a.status_active=1 and b.page_id=25 and b.status_active=1 and b.is_deleted=0 order by b.id desc ");
						?>
                        <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000">
						<? if( $is_approved==1){ ?> <b style="left: 50%; margin-left: 240px; color: red;"> This Job is Full Approved  </b> <? }elseif( $is_approved==3){
							if($approval_allow[0][csf("approval_need")]==1 && $approval_allow[0][csf("allow_partial")]==1){
							$ap_msg="<b style='left: 50%; margin-left: 240px; color: red;'>This Job is Full Approved </b>";
							}else{
							$ap_msg="<b style='left: 50%; margin-left: 240px; color: green;'>This Job is Partially Approved </b>";
							}
							echo $ap_msg;
							} else{ ?><b style="left: 50%; margin-left: 240px; color: red;">
 							This Job is Not Approved</b> <? } ?>
                    </tr>
                     <tr>
                    	<td>Internal Ref</td>
                        <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                        <td>File No</td>
                        <td colspan="2"><b><? echo $file_cond; ?></b></td>
                    </tr>
					<tr>
						<td>Costing Date</td>
						<td><b><? echo change_date_format($costing_date); ?></b></td>
						<td>Insert by</td>
						<td><b><? echo $user_arr[$inserted_by]; ?></b></td>
						<td>Item SMV</td>
                        <td><b><? echo $row[csf("sew_smv")] ?></b></td>
					</tr>
					<tr>
						<td>Remarks</td>
						<td colspan="5"><b><? echo $row[csf("remarks")] ?></b></td>
					</tr>

                </table>

            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch

	//All Cost start here...
	//start	all summary report here -------------------------------------------
	//job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
	$sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost,deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incentives_pre_cost,incentives_pre_cost_per,incometax_cost,incometax_percent,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,depr_amor_pre_cost,depr_amor_po_price,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>  
                </tr>
            <?
			$po_no=str_replace("'","",$txt_po_breack_down_id);
			// echo str_replace("'","",$txt_job_no);die;
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				  $condition->job_no("=$txt_job_no");
			 }

			  if(str_replace("'","",$txt_po_breack_down_id)!='')
			 {
				$condition->po_id("in($po_no)");
			 }
			 else
			 { //$all_po_ids
				 $condition->po_id("in($all_po_ids)");
			 }
			  $condition->init();
			$fabric= new fabric($condition);

		   	$yarn= new yarn($condition);
			$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();

			$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();


			$conversion= new conversion($condition);
			$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
			$trims= new trims($condition);
			//echo $trims->getQuery(); die;
			$trims_costing_arr=$trims->getAmountArray_by_job();
			$emblishment= new emblishment($condition);
			$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
			$wash= new wash($condition);
			//echo $wash->getQuery(); die;
			$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();

		    $commercial= new commercial($condition);
			$commercial_costing_arr=$commercial->getAmountArray_by_job();

			$commission= new commision($condition);
			$commission_costing_arr=$commission->getAmountArray_by_job();

			$other= new other($condition);
			$other_costing_arr=$other->getAmountArray_by_job();

			$job_no=str_replace("'","",$txt_job_no);
			 
	        $sql_trim_summ = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq from wo_pre_cost_trim_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";$data_array_trim_summ=sql_select($sql_trim_summ);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();

			foreach( $data_array_trim_summ as $row )
			{
				//$trim_qty=$trim_qty_arr[$row[csf("id")]];
				$trim_amount=$trim_amount_arr[$row[csf("id")]];
				$trim_job_amountArr[$row[csf("job_no")]]+=$trim_amount;

			}
			////////=============Set Ratio======================
			$item_set=sql_select("select set_item_ratio,gmts_item_id,job_no from wo_po_details_mas_set_details where job_no=".$txt_job_no."") ;
			foreach( $item_set as $row )
			{
				 $set_item_ratio_arr[$row[csf("job_no")]][$row[csf("gmts_item_id")]]=$row[csf("set_item_ratio")];
			}
			//=========Yarn=========================
				$yarn_data_array=array();
		$sql_y=sql_select("select c.item_number_id,c.order_quantity ,c.plan_cut_qnty,f.job_no,f.color,f.count_id,f.copm_one_id,f.percent_one,f.copm_two_id,f.percent_two,f.type_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,e.requirment   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_yarn_cost_dtls f where a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id and a.id=f.job_id and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_cost_dtls_id and a.job_no=".$txt_job_no." $txt_po_breack_down_id_cond3 and e.cons !=0    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and e.status_active=1 and e.is_deleted=0");//C.COLOR_NUMBER_ID=E.COLOR_NUMBER_ID and C.SIZE_NUMBER_ID=E.GMTS_SIZES and D.ID=F.FABRIC_COST_DTLS_ID

		foreach($sql_y as $sql_y_r)
		{

			$set_item_ratio=$gmtsitem_ratio_array[$sql_y_r[csf('job_no')]][$sql_y_r[csf('item_number_id')]];
			$cons_qnty = def_number_format((($sql_y_r[csf("requirment")]*$sql_y_r[csf("cons_ratio")]/100)*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			$avg_cons_qnty = def_number_format(($sql_y_r[csf("avg_cons_qnty")]*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			 $amount = def_number_format(($cons_qnty*$sql_y_r[csf("rate")]),5,"");
			//$amount = def_number_format(($avg_cons_qnty*$sql_y_r[csf("rate")]),5,"");

			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][qnty]+=$cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][avg_qnty]+=$avg_cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][amount]+=$amount;
		}
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//Mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
		 $sql_yarn = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
		$data_array_yarn=sql_select($sql_yarn);
		/* $yarn_costing=0;
		foreach( $data_array_yarn as $row )
		{

			$yarn_costing+= $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("copm_two_id")]][$row[csf("percent_two")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]][amount];
		} */

			$price_dzn=0;
            $sl=0;
        foreach( $data_array as $row )
        {
			//$fab_production_knit=$fabric_costing_arr['knit']['grey'][$job_no];
			//$fab_production_finish=$fabric_costing_arr['finish']['grey'][$job_no];

			$fab_purchase_knit2=array_sum($fabric_costing_arr2['knit']['grey'][$job_no]);
			$fab_purchase_woven2=array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);

			 
			$yarn_costing=$yarn_costing_arr[$job_no];
			$tot_fabric_cost=$fab_purchase_knit2+$fab_purchase_woven2;
			$conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			$freight_cost=$other_costing_arr[$job_no]['freight'];
			$inspection_cost=$other_costing_arr[$job_no]['inspection'];
			$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			$common_oh=$other_costing_arr[$job_no]['common_oh'];
			$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			$cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			$incentives_cost=$other_costing_arr[$job_no]['incentives_cost'];
			$fabric_cost=$tot_fabric_cost;
			$trims_cost=$trim_job_amountArr[$job_no];
			$embel_cost=$emblishment_costing_arr[$job_no];
			$wash=$emblishment_costing_arr_wash[$job_no];
			$commercial_cost=$commercial_costing_arr[$job_no];
			$comm_cost=$row[csf("comm_cost")];
			$cm_cost_dzn=$row[csf("cm_cost")];
			$deffdlc_cost_dzn=$row[csf("deffdlc_cost")];
			$interest_cost=$row[csf("interest_cost")];
			$incentives_pre_cost=$row[csf("incentives_pre_cost")];
			$incometax_cost=$row[csf("incometax_cost")];
			//deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent
			$deffdlc_percent=$row[csf("deffdlc_percent")];
			$interest_percent=$row[csf("interest_percent")];
			$incometax_percent=$row[csf("incometax_percent")];
			$incentives_pre_cost_per=$row[csf("incentives_pre_cost_per")];
			$depr_amor_po_price=$row[csf("depr_amor_po_price")];
			$depr_amor_pre_cost_dzn=$row[csf("depr_amor_pre_cost")];
			$incometax_cost=($row[csf("incometax_cost")]/$order_price_per_dzn)*$order_qty;
			//interest_cost,interest_percent,incometax_cost
			$commission=$commission_costing_arr[$job_no];
			$lab_test=$lab_test_cost;
			$inspection=$inspection_cost;
			$cm_cost=$cm_cost;
			$freight=$freight_cost;
			$currier_pre_cost=$currier_cost;
			$certificate_pre_cost=$certificate_cost;
			$common_oh=$common_oh;
 


			$all_total_cost=$tot_fabric_cost+$yarn_costing+$conversion_cost+$trims_cost+$embel_cost+$wash+$commercial_cost+$commission+$lab_test_cost+$cm_cost+$currier_pre_cost+$inspection_cost+$freight+$common_oh+$certificate_pre_cost+$depr_amor_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost+$incentives_cost;
				$sl=$sl+1;
  				$others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
			  
				if($zero_value==1)
				{
				?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Value</b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($tot_order_value,4);$price_dzn=$tot_order_value;//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? $tot_fab_cot=$tot_fabric_cost+$yarn_costing+$conversion_cost;
					echo fn_number_format($tot_fabric_cost+$yarn_costing+$conversion_cost,2); ?></td>
                    <td align="right" rowspan="18">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($tot_fab_cot/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($trims_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($embel_cost/$tot_order_value)*100,2);//fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($wash,4); ?></td>
                    <td align="center"><? echo fn_number_format(($wash/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($commercial_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($commercial_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="center"><? echo fn_number_format(($commission/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($depr_amor_pre_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($lab_test_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($inspection_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($cm_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                    <td align="center"><? echo fn_number_format(($freight/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($currier_pre_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($certificate_pre_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Deffd. LC/DC Cost</td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($deffdlc_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Interest </td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format(($row[csf("interest_cost")]/$tot_order_value)*100,2); ?>%</td>
                </tr>
				<tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Incentives Missing Cost</td>
                    <td align="right"><? echo fn_number_format($incentives_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($incentives_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Income Tax</td>
                    <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($incometax_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                    <td align="center"><? echo fn_number_format(($common_oh/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:19)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($all_total_cost,4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format(($all_total_cost/$tot_order_value)*100,2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-20)</td>
                    <td>&nbsp;</td>
                    <td align="right" title="Total Value-Total cost/OrderQty*12"><? $tot_mergin=$tot_order_value-$all_total_cost;echo fn_number_format(($tot_mergin/$order_qty)*12,2);
					  //echo '=========='.$tot_order_value.'-'.$all_total_cost.'/'.$order_job_qnty;
					$marging_dzn=($tot_mergin/$order_qty)*12;
					  ?></td>
                    <td align="center" title="Tot Margin/Tot order Value*100"><b><? $margin_dzn_percent=($tot_mergin/$tot_order_value)*100;
					 echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right" title="Total cost/OrderJobQty"><? echo fn_number_format($all_total_cost/$order_job_qnty,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right" title="Total Margin/OrderQty/12"><? echo fn_number_format($marging_dzn/12,2); ?></td>
                    <td align="right"></td>
                </tr>
            	<?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Value</b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($tot_order_value,4); $price_dzn=$tot_order_value;//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                	<td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? $tot_fab_cot=$tot_fabric_cost+$yarn_costing+$conversion_cost;
					echo fn_number_format($tot_fabric_cost+$yarn_costing+$conversion_cost,2); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($tot_fab_cot/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($trims_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($embel_cost/$tot_order_value)*100,2);//fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($wash,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($wash/$tot_order_value)*100,2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($commercial_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($commercial_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($commission/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($lab_test_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($inspection_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($cm_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($freight/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($common_oh/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<?=$sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($all_total_cost,4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format(($all_total_cost/$tot_order_value)*100,2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><?= ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"  title="FOB Value(<? echo $tot_order_value;?>)-Tot Cost(<? echo $all_total_cost;?>)/OrderQty(<? echo $order_qty;?>)*12"><? $tot_mergin=$tot_order_value-$all_total_cost;echo fn_number_format(($tot_mergin/$order_qty)*12,2);

					$marging_dzn=($tot_mergin/$order_qty)*12;
					  ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($tot_mergin/$tot_order_value)*100;
					 echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($all_total_cost/$order_job_qnty,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($marging_dzn/12,2); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
			}
        }
        ?>
        </table>
    </div>
    <?

    //echo $commission_costing_arr[$job_no];die;

	//End all summary report here -------------------------------------------

	//2 Fabric Cost part here-------------------------------------------
		$sql = "select id, job_no,item_number_id,uom,body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount,avg_finish_cons,status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
		$po_cond2="";$po_cond="";
		if($all_po_ids!="")
		{
			$po_cond="and po_break_down_id in($all_po_ids)";
			$po_cond2="and b.id in($all_po_ids)";
		}
		//echo $po_cond.'CCCXXXXXXXXXXX';die;
		/*$item_set=sql_select("select set_item_ratio,gmts_item_id,job_no from wo_po_details_mas_set_details where job_no=".$txt_job_no."") ;
		foreach( $item_set as $row )
        {
			 $set_item_ratio_arr[$row[csf("job_no")]][$row[csf("gmts_item_id")]]=$row[csf("set_item_ratio")];
		}*/

		$knit_fab=""; $woven_fab=""; $knit_subtotal_amount=0; $woven_subtotal_amount=0; $knit_subtotal_amount_dzn=0; $knit_subtotal_amount_kg=0; $woven_subtotal_amount_dzn=0; $woven_subtotal_amount_kg=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
			$knit_cost_dzn=$row[csf("amount")];$woven_cost_dzn=$row[csf("amount")];

			if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];

 				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($greycons,4).'</td>
 					<td align="right">'.fn_number_format($fincons,4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],4).'</td>
                </tr>';
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
            	$knit_subtotal_amount+=$row[csf("amount")];
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				if($knit_subtotal_amount_dzn>0){
					$knit_subtotal_amount_kg=$knit_subtotal_amount/$knit_subtotal_avg_cons;
				}
				else{
					$knit_subtotal_amount_kg=0;
				}
			}
			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];

				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($greycons,4).'</td>
 					<td align="right">'.fn_number_format($fincons,4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],4).'</td>
                </tr>';
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$row[csf("amount")];
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;

				$woven_subtotal_amount_kg=$woven_subtotal_amount/$woven_subtotal_amount_dzn;
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="100">Gray Fabric Qnty</td>
							<td width="100">Finish Fab Qnty</td>
 							<td width="50">Rate</td>
							<td width="50">Amount</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr><td colspan="7">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
					</tr>';
  		echo $knit_fab;

		//woven fabrics table here
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
					</tr>
   					</table></div>';
        echo $woven_fab;

		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		/*$yarn_data_array=array();
		$sql_y=sql_select("select c.item_number_id,c.order_quantity ,c.plan_cut_qnty,f.job_no,f.color,f.count_id,f.copm_one_id,f.percent_one,f.copm_two_id,f.percent_two,f.type_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,e.requirment   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_yarn_cost_dtls f where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and a.job_no=f.job_no and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_cost_dtls_id and a.job_no=".$txt_job_no." $txt_po_breack_down_id_cond3 and e.cons !=0    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0");//C.COLOR_NUMBER_ID=E.COLOR_NUMBER_ID and C.SIZE_NUMBER_ID=E.GMTS_SIZES and D.ID=F.FABRIC_COST_DTLS_ID

		foreach($sql_y as $sql_y_r)
		{

			$set_item_ratio=$gmtsitem_ratio_array[$sql_y_r[csf('job_no')]][$sql_y_r[csf('item_number_id')]];
			$cons_qnty = def_number_format((($sql_y_r[csf("requirment")]*$sql_y_r[csf("cons_ratio")]/100)*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			$avg_cons_qnty = def_number_format(($sql_y_r[csf("avg_cons_qnty")]*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			 $amount = def_number_format(($cons_qnty*$sql_y_r[csf("rate")]),5,"");
			//$amount = def_number_format(($avg_cons_qnty*$sql_y_r[csf("rate")]),5,"");

			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][qnty]+=$cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][avg_qnty]+=$avg_cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][amount]+=$amount;
		}
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//Mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
				// $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
		        //$data_array=sql_select($sql);*/
		?>

		<?php
		//Yarn===========================
		$totYarn=0;
		$YarnData=array();
		$yarn_data_array=$yarn->get_By_Precostdtlsid_YarnQtyAmountArray();
		$sql_yarn="select f.id as yarn_id, f.cons_ratio, f.cons_qnty, f.avg_cons_qnty, f.rate, f.amount, count_id, copm_one_id, percent_one, color, type_id from wo_pre_cost_fab_yarn_cost_dtls f where f.job_no =".$txt_job_no." and f.is_deleted=0 and f.status_active=1  order by f.id";
		$data_arr_yarn=sql_select($sql_yarn);
		foreach($data_arr_yarn as $yarn_row)
		{
			$yarnrate=$yarn_row[csf("rate")];
			$summary_data[yarn_cost][$yarn_row[csf("yarn_id")]]=$yarn_row[csf("amount")];
			$summary_data[yarn_cost_job]+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
			$index="'".$yarn_row[csf("count_id")]."_".$yarn_row[csf("copm_one_id")]."_".$yarn_row[csf("percent_one")]."_".$yarn_row[csf("type_id")]."_".$yarn_row[csf("color")]."_".$yarnrate."'";
			$YarnData[$index]['qty']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
			$YarnData[$index]['amount']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
			$YarnData[$index]['dznqty']+=$yarn_row[csf("cons_qnty")];
			$YarnData[$index]['dznamount']+=$yarn_row[csf("amount")];
			$totYarn+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
			$total_yarn_cost_dzn+=$yarn_row[csf("amount")];
			
			$totalyarncons+=$yarn_row[csf("cons_qnty")];
			
			$total_yarn_amount+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
		}
		$total_yarn_cost_kg=$total_yarn_cost_dzn/$totalyarncons;
		//Yarn End============================
		//Start	Yarn Cost part report here -------------------------------------------
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<tr style="font-weight:bold">
					<td width="70" rowspan="<? echo count($YarnData)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
					<td width="350">Yarn Desc</td>
					<td width="100">Yarn Qty</td>
					<td width="100">Avg.Yarn Qnty</td>
					<td width="100">Rate</td>
					<!-- <td width="100">Amount</td> -->
					<td width="100">Tot.Amount</td>
				</tr>
			<?
			$TotalDznQty = 0; $TotalQty = 0; $TotalDznAmount = 0; $TotalAmount = 0;
			foreach( $YarnData as $index=>$row )
			{
				$des=explode("_",str_replace("'","",$index));
				$item_descrition = $lib_yarn_count[$des[0]]." ".$composition[$des[1]]." ".$des[2]."% ".$color_library[$des[4]]." ".$yarn_type[$des[3]];
				?>
				<tr>
					<td align="left"><? echo $item_descrition; ?></td>
					<td align="right"><? echo fn_number_format($row["qty"],4);//echo fn_number_format($row["dznqty"],4); ?></td>
					<td align="right"><? echo fn_number_format($row["qty"],4); ?></td>
					<td align="right"><? echo fn_number_format($des[5],4); ?></td>
					<!-- <td align="right"><? //echo fn_number_format($row["dznamount"],4); ?></td> -->
					<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
				</tr>
				<?
				 $TotalDznQty += $row["dznqty"];
				 $TotalQty += $row["qty"];
				 $TotalDznAmount += $row["dznamount"];
				 $TotalAmount += $row["amount"];

				 $GrandTotalFabricDznAmount+=$row["dznamount"];
				 $GrandTotalFabricAmount+=$row["amount"];
			}
		  ?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan=2 align="left">Total</td>
					<td align="right"><? echo fn_number_format($TotalQty,4);//echo fn_number_format($TotalDznQty,4); ?></td>
					<td align="right"><? echo fn_number_format($TotalQty,4); ?></td>
					<td></td>
					<!-- <td align="right"><? //echo fn_number_format($TotalDznAmount,4); ?></td> -->
					<td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
				</tr>
			</table>
	  </div>
	  <?
  }
	else
	{
	  if($totYarn>0)
	  {
		  ?>
		   <div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<tr style="font-weight:bold">
					<td width="70" rowspan="<? echo count($YarnData)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
					<td width="350">Yarn Desc</td>
					<td width="100">Yarn Qty</td>
					<td width="100">Avg.Yarn Qty</td>
					<td width="100">Rate</td>
					<!-- <td width="100">Amount</td> -->
					<td width="100">Tot.Amount</td>
				</tr>
			<?
			$TotalDznQty = 0; $TotalQty = 0; $TotalDznAmount = 0; $TotalAmount = 0;
			foreach( $YarnData as $index=>$row )
			{
				$des=explode("_",str_replace("'","",$index));
				$item_descrition = $lib_yarn_count[$des[0]]." ".$composition[$des[1]]." ".$des[2]."% ".$color_library[$des[4]]." ".$yarn_type[$des[3]];
				?>
				<tr>
					<td align="left"><? echo $item_descrition; ?></td>
					<td align="right"><?  echo fn_number_format($row["qty"],4);//echo fn_number_format($row["dznqty"],4); ?></td>
					<td align="right"><? echo fn_number_format($row["qty"],4); ?></td>
					<td align="right"><? echo fn_number_format($des[5],4); ?></td>
					<!-- <td align="right"><? //echo fn_number_format($row["dznamount"],4); ?></td> -->
					<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
				</tr>
				<?
				 $TotalDznQty += $row["dznqty"];
				 $TotalQty += $row["qty"];
				 $TotalDznAmount += $row["dznamount"];
				 $TotalAmount += $row["amount"];

				 $GrandTotalFabricDznAmount+=$row["dznamount"];
				 $GrandTotalFabricAmount+=$row["amount"];
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td align="left">Total</td>
					<td align="right"><? echo fn_number_format($TotalQty,4);//echo fn_number_format($TotalDznQty,4); ?></td>
					 <td align="right"><? echo fn_number_format($TotalQty,4); ?></td>
					<td></td>
					<!-- <td align="right"><? //echo fn_number_format($TotalDznAmount,4); ?></td> -->
					<td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
				</tr>
			</table>
		</div>
		<?
	  }
	  else echo "";
	}
	//End Yarn Cost part report here -------------------------------------------
	//start	Conversion Cost to Fabric report here -------------------------------------------

	$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 group by a.cons_process order by  a.cons_process";
	$tot_data_array=sql_select($sql_count);
	foreach( $tot_data_array as $row ){
			 $process_id=$row[csf("cons_process")];
			 $process_row+=count($row[csf("cons_process")]);
	 }
	 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.fab_nature_id,b.uom,b.color_type_id,b.fabric_description,b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by  a.cons_process";
	 $data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+2+$process_row; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Required</td>
                    <td width="100">Avg.Required</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
			$conversion= new conversion($condition);
			$conv_data_amt_arr=$conversion->getAmountArray_by_conversionid();
			$conv_data_qty_arr=$conversion->getQtyArray_by_conversionid();

            $total_conversion_cost=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
            foreach( $data_array as $row )
            {
				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0)
				{
				$item_descrition = "All Fabrics";
				}
				else
				{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}

				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) )
						{
							if($k!=1)
							{
								?>
                               <tr>
                                    <td>&nbsp;</td>
                                    <td><strong>Sub. Total : </strong></td>
                                    <td align="right"><strong><? echo fn_number_format($total_convsion_qty,4); ?></strong></td>
                                    <td align="right"><strong><? echo fn_number_format($total_avg_convsion_qty,4); ?></strong></td>
                                    <td>&nbsp;</td>
                                    <td align="right"><strong><? echo fn_number_format($total_conversion_cost,4); ?></strong></td>
                                </tr>
                                <?
							}
							?>
                            <?
							unset($total_convsion_qty);
							unset($total_avg_convsion_qty);
							unset($total_conversion_cost);
							$process_array_check[]=$process_id;
							$k++;
						}
						$conv_amount=$conv_data_amt_arr[$row[csf('id')]][$row[csf('uom')]];
						$conv_qty=$conv_data_qty_arr[$row[csf('id')]][$row[csf('uom')]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($conv_qty,4);//echo fn_number_format($conv_data[$row[csf('id')]]['conv_qnty'],4); ?></td>
                    <td align="right"><? echo fn_number_format($conv_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($conv_amount/$conv_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($conv_amount,4);//echo fn_number_format($conv_data[$row[csf('id')]]['conv_amount'],4); ?></td>
                </tr>
            <?
			$total_convsion_qty+=$conv_qty;
			$total_avg_convsion_qty+=$conv_qty;
            $total_conversion_cost +=$conv_amount;
			$grand_total_conv_qnty+=$conv_qty;
			$grand_total_avg_convsion_qty+=$conv_qty;
			$grand_total_conversion_cost+=$conv_amount;
			$total_conversion_cost_dzn+=$row[csf('amount')];
			if($total_avg_yarn_qty>0){
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
			}
			else{
				$total_conversion_cost_kg =0;
			}
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty,4); ?></td>
                <td align="right"><? echo fn_number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($total_conversion_cost,4); ?></td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total</td>
                <td align="right"><? echo fn_number_format($grand_total_conv_qnty,4); ?></td>
                <td align="right"><? echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
            </tr>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -------------------------------------------



	//start	Trims Cost part report here -------------------------------------------
    	$sql = "select id,seq, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Consumption</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();

            $total_trims_cost=0;  $total_trims_qty=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
			$trim_group=return_library_array( "select item_name,id from  lib_item_group ", "id", "item_name" );
            foreach( $data_array as $row ){

				$row[csf("cons_dzn_gmts")]=$trim_qty_arr[$row[csf("id")]];
				$row[csf("amount")]=$trim_amount_arr[$row[csf("id")]];


			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_trims_cost += $row[csf("amount")];
				 $total_trims_qty += $row[csf("cons_dzn_gmts")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------



	 //start	Embellishment Details part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Gmts. Qnty (Dzn)</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();

			$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash= new wash($condition);
			$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
			//print_r($wash_qty_arr);
            $total_embellishment_amt=0;$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {
				$em_type ="";
				$total_embellishment_amt_dzn += $row[csf("amount")];
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1) $em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];

				$embell_budget_qty_id=$embelt_budget_qty_id_arr[$row[csf("emb_name")]];
				if($row[csf("emb_name")]!=3){
				$row[csf("cons_dzn_gmts")]=$emblishment_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
				$row[csf("amount")]=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				else {
				$row[csf("cons_dzn_gmts")]=$wash_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
				$row[csf("amount")]=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}



			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_embellishment_amt += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$commercial= new commercial($condition);
			$commarcial_amount_arr=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$total_commercial_cost_dzn+= $row[csf("amount")];

				$amount =$commarcial_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_commercial_cost += $amount;

            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$commission= new commision($condition);
			$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
			//print_r($commission_amount_arr);
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount=$commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];// $row[csf("commission_amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($commission_amount,4); ?></td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	//End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,currier_pre_cost, currier_percent, 	certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";

	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_other_components=0;$lab_test_dzn=0;
			$lab_test = 0;
			$inspection = 0;
			$cm_cost = 0;
			$freight = 0;
			$common_oh = 0;
           foreach( $data_array as $row )
           {
				$lab_test = $lab_test_cost;
				$inspection = $inspection_cost;
				$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
				$freight = $freight_cost;
				$common_oh = $common_oh;
				$currier_pre_cost = $currier_cost;
				$certificate_pre_cost = $certificate_cost;
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
				$total_trims_cost_dzn = $row[csf("trims_cost")];

   			?>
                <tr>
                    <td align="left">Lab Test </td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>

                <tr>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                </tr>
				<tr>
                    <td align="left">Incentives Missing Cost</td>
                    <td align="right"><? echo fn_number_format($incentives_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
            <?
                 $total_other_components += $lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh+$depr_amor_pre_cost+$deffdlc_cost+$incometax_cost+$interest_cost+$incentives_pre_cost;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">
        <?
     	// image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location from common_photo_library where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	    ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='400' width='300'/>
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = 0;
            $total_summary_amount = $total_commission_cost+$total_commercial_cost+$total_embellishment_amt+$total_trims_cost+$grand_total_conversion_cost+$total_yarn_amount +$woven_subtotal_amount+$knit_subtotal_amount+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh+$depr_amor_pre_cost+$deffdlc_cost+$interest_cost+$incentives_pre_cost;
            ?>
	    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:500px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/DZN</td>
                    <td width="100">Cost/Kg</td>
                    <td width="100">Total</td>
                 </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) </td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Woven Fabric (Purchase)</td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Yarn</td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric</td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost_dzn,4); ?></td>
                    <td align="right" rowspan="15"><? //echo fn_number_format($total_trims_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commission</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
                    <td align="right"><? echo fn_number_format($interest_percent,4); ?></td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"><? echo fn_number_format($incometax_percent,4); ?></td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                </tr>
				<tr>
                    <td align="left">Incentives Missing Cost</td>
                    <td align="right"><? echo fn_number_format($incentives_pre_cost_per,4); ?></td>
                    <td align="right"><? echo fn_number_format($incentives_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_summary_amount,4); ?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
          <?
          //start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value -2</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><?  echo fn_number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission=$commission_costing_arr[$job_no];//$less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial=$commercial_costing_arr[$job_no];//$less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty;
					 echo fn_number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight=$other_costing_arr[$job_no]['freight'];//$less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>

                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right">
					<?
					//echo $others_cost_value;
					$otherCost = $others_cost_value;
					//	$otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($otherCost,4);
					?>
                    </td>
                    <td align="center"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM(Contribution Margin)</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,4); ?></td>
                    <td align="center"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_qty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><?
					$cm_cost=$cm_cost_dzn;//$other_costing_arr[$job_no]['cm_cost'];
					echo fn_number_format($cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value</td>
                    <td align="right"><? $total_order_val = $order_values;//$order_job_qnty*$avg_unit_price;
					 echo fn_number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $total_summary_amount;//$all_total_cost;
					echo fn_number_format($total_cost,4);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_qty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
           </table>
      </div>
       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>
      <div style="clear:both"></div>
      </div>
	   <br/> <br/>
         <?

	 $lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");
	//and b.un_approved_date is null
	 $approve_data_array=sql_select("select b.approved_by,min(b.approved_date) as approved_date from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  group by  b.approved_by order by b.approved_by asc");
	 $unapprove_data_array=sql_select("select b.approved_by, b.un_approved_by, b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_date,b.approved_by");
	// echo "select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_no";

 	if(count($approve_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="40%" style="border:1px solid black;">Name</th>
				<th width="30%" style="border:1px solid black;">Designation</th>
				<th width="27%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
    <br/>
	<?
	$sql_unapproved=sql_select("select user_id,booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2  and booking_id=$mst_id and is_deleted=0 and status_active=1");
	//echo  "select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id";
	$unapproved_request_arr=array();
	foreach($sql_unapproved as $rowu)
	{
		$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
	}

	if(count($unapprove_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<!--<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>-->
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;  $un_approve_req_chk=array();$un=1;
			foreach($unapprove_data_array as $row)
			{
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<!--<td width="20%" style="border:1px solid black;"><? //echo $unapproved_request_arr[$row[csf('approved_by')]];?></td>-->
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
             </tr>
				<?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if(!empty($un_approved_date))
				{
					$un_approv_user=$row[csf('approved_by')].$mst_id;
					if (!in_array($un_approv_user,$un_approve_req_chk))
					{
						$un++;
						$un_approve_req_chk[]=$un_approv_user;
						$unapproved_request=$unapproved_request_arr[$mst_id];
						//echo $un_approv_user."=";
					}
					if($row[csf('un_approved_by')]!=0) $row[csf('approved_by')]=$row[csf('un_approved_by')];
					?>
					<tr style="border:1px solid black;">
						<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
					</tr>
					<?
					$i++;
				}
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
    <!--End CM on Net Order Value Part report here -->
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>
      </div>
    <br/>
     <?  echo signature_table(109, $cbo_company_name, "890px",'','',$inserted_by);?>
	</div>
	 <?
	 exit();
}
if($action=="bomRpt4")
{
	///extract($_REQUEST);
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");
	if($db_type==0) $po_id_cond="group_concat( distinct b.id) as po_id";
	if($db_type==2) $po_id_cond="listagg(b.id ,',') within group (order by b.id) AS po_id";
	if($db_type==0) ///fab_knit_fin_req_kg,fab_knit_req_kg
	{
	   $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty,$po_id_cond, c.costing_per,c.budget_minute,c.approved, d.fab_knit_req_kg,d.fab_knit_fin_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,a.style_description
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,a.style_description order by a.job_no";
	}
	if($db_type==2)
	{
	    $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty,$po_id_cond, c.costing_per,c.budget_minute,c.approved,   d.fab_knit_fin_req_kg, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,a.style_description
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,a.style_description  order by a.job_no"; //a.job_quantity as job_quantity,
	}

	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	$po_quantity=$data_array[0][csf('ord_qty')];
	$all_po_id=$data_array[0][csf('po_id')];
	$pocond="";
	if($all_po_id!="")
	{
		$pocond="and id in($all_po_id)";
	}

	//echo $plan_cut_qty;
	//echo $order_value=$plan_cut_qty*$data_array[0][csf('avg_unit_price')];
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name=$cbo_company_name and variable_list=56 and status_active=1 and is_deleted=0");
	//$embel_type_id=0;$embel_type_id=0;
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$embel_type_id=$vari_row[csf('embellishment_id')];
		$embelt_budget_qty_id_arr[$embel_type_id]=$vari_row[csf('embellishment_budget_id')];
	}

	?>
    <!--<div style="width:852px; margin:0 auto">
    <div style="width:850px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">BOM Report 2</div>-->
	<?


	$result =sql_select("select po_number,pub_shipment_date,file_no,excess_cut,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 $pocond order by pub_shipment_date DESC");
		//$tot_row=count($result);
		$job_in_orders = '';$pulich_ship_date='';$job_in_ref = '';$job_in_file = '';
		$tot_excess_cut=0;$tot_row=0;
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			if($val[csf('excess_cut')]>0)
			{
				$tot_row++;
			}
			$tot_excess_cut+= $val[csf('excess_cut')];
			//$job_in_ref .= $val[csf('grouping')].", ";
			//$job_in_file .= $val[csf('file_no')].", ";
			if($job_in_ref=='') $job_in_ref= $val[csf('grouping')]; else $job_in_ref.=",". $val[csf('grouping')];
			if($job_in_file=='') $job_in_file= $val[csf('file_no')]; else $job_in_file.=",". $val[csf('file_no')];
		}
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$order_values = $row[csf("ord_qty")]*$row[csf("avg_unit_price")];

		$avg_excess_cut=$tot_excess_cut/$tot_row;

		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",$job_in_ref));
		$job_file=array_unique(explode(",",rtrim($job_in_file,",")));
		$all_po_id = rtrim($all_po_id,",");
		$all_po_ids=implode(",",array_unique(explode(",",$all_po_id)));
		//print_r($job_ref);
		$ref_cond='';
		foreach ($job_ref as $ref)
		{
			//$ref_cond.=", ".$ref;
			if($ref_cond=='') $ref_cond=$ref; else $ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}


		?>
            	<table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
					$path=($path)?$path:'../../';
					?>
                    <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre-Cost Report</b>
                </td></tr></table>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Plan Cut Qnty</td>
                        <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; $uom=$row[csf("order_uom")]; ?></b></td>
                    </tr>
                    <tr>
                        <td>Order Qty</td>
                        <td><b><? $tot_order_value=$row[csf("ord_qty")]*$row[csf("avg_unit_price")];$order_qty=$row[csf("ord_qty")];
						echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    	<td>Style Ref. No</td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
						<td>Style Desc</td>
                        <td><? echo $row[csf("style_description")]; ?></td>
                    </tr>
                    <tr>
                    	<td>Garments Item</td>
                        <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                        <td>Shipment Date</td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                     <tr>
						 <td>Avg Cons. Fin.</td>
						 <td align=""><b><? echo fn_number_format($row[csf("fab_knit_fin_req_kg")]+$row[csf("fab_woven_fin_req_yds")],2); ?></b></td>
						 <td>Plan Cut%</td>
						 <td><b><? echo fn_number_format($avg_excess_cut,2); ?></b></td>
                        <td></td>
                        <td><b></b></td>
                    </tr>
                    <tr>
                    <td>Budget Minute</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                        <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                    </tr>
                     <tr>
                    	<td>Internal Ref</td>
                        <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                        <td>File No</td>
                        <td colspan="2"><b><? echo $file_cond; ?></b></td>
                    </tr>
                </table>

            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch

	//All Cost start here...
	//start	all summary report here -------------------------------------------
	//job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
	 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost,deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,depr_amor_pre_cost,depr_amor_po_price,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
			$po_no=str_replace("'","",$txt_po_breack_down_id);
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				  $condition->job_no("=$txt_job_no");
			 }

			  if(str_replace("'","",$txt_po_breack_down_id)!='')
			 {
				$condition->po_id("in($po_no)");
			 }
			 else
			 { //$all_po_ids
				 $condition->po_id("in($all_po_ids)");
			 }
			  $condition->init();
			//$yarn= new yarn($condition);


           	$fabric= new fabric($condition);
		   	$yarn= new yarn($condition);
			$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
			$fabric= new fabric($condition);
			$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();

			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();


			$conversion= new conversion($condition);
			$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
			$trims= new trims($condition);
			//echo $trims->getQuery(); die;
			$trims_costing_arr=$trims->getAmountArray_by_job();
			$emblishment= new emblishment($condition);
			$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
			$wash= new wash($condition);
			//echo $wash->getQuery(); die;
			$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		    $commercial= new commercial($condition);
			$commercial_costing_arr=$commercial->getAmountArray_by_job();
			$commission= new commision($condition);
			$commission_costing_arr=$commission->getAmountArray_by_job();
			$other= new other($condition);
			$other_costing_arr=$other->getAmountArray_by_job();

			$job_no=str_replace("'","",$txt_job_no);
	$sql_trim_summ = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
			from wo_pre_cost_trim_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
			$data_array_trim_summ=sql_select($sql_trim_summ);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();

			foreach( $data_array_trim_summ as $row )
			{
				//$trim_qty=$trim_qty_arr[$row[csf("id")]];
				$trim_amount=$trim_amount_arr[$row[csf("id")]];
				$trim_job_amountArr[$row[csf("job_no")]]+=$trim_amount;

			}

			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			//$fab_production_knit=$fabric_costing_arr['knit']['grey'][$job_no];
			//$fab_production_finish=$fabric_costing_arr['finish']['grey'][$job_no];

			$fab_purchase_knit2=array_sum($fabric_costing_arr2['knit']['grey'][$job_no]);
			$fab_purchase_woven2=array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);

			$yarn_costing=$yarn_costing_arr[$job_no];
			$tot_fabric_cost=$fab_purchase_knit2+$fab_purchase_woven2;
			$conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			//$testing_cost=$other_costing_arr[$job_no]['lab_test'];
			$freight_cost=$other_costing_arr[$job_no]['freight'];
			$inspection_cost=$other_costing_arr[$job_no]['inspection'];
			$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			$common_oh=$other_costing_arr[$job_no]['common_oh'];
			$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			$cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			$fabric_cost=$tot_fabric_cost;
			$trims_cost=$trim_job_amountArr[$job_no];
			$embel_cost=$emblishment_costing_arr[$job_no];
			$wash=$emblishment_costing_arr_wash[$job_no];
			$commercial_cost=$commercial_costing_arr[$job_no];
			$comm_cost=$row[csf("comm_cost")];
			$cm_cost_dzn=$row[csf("cm_cost")];
			$deffdlc_cost_dzn=$row[csf("deffdlc_cost")];
			$interest_cost=$row[csf("interest_cost")];
			$incometax_cost=$row[csf("incometax_cost")];
			//deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent
			$deffdlc_percent=$row[csf("deffdlc_percent")];
			$interest_percent=$row[csf("interest_percent")];
			$incometax_percent=$row[csf("incometax_percent")];
			$depr_amor_po_price=$row[csf("depr_amor_po_price")];
			$depr_amor_pre_cost_dzn=$row[csf("depr_amor_pre_cost")];
			//interest_cost,interest_percent,incometax_cost
			$commission=$commission_costing_arr[$job_no];
			$lab_test=$lab_test_cost;
			$inspection=$inspection_cost;
			$cm_cost=$cm_cost;
			$freight=$freight_cost;
			$currier_pre_cost=$currier_cost;
			$certificate_pre_cost=$certificate_cost;
			$common_oh=$common_oh;

			$all_total_cost=$tot_fabric_cost+$yarn_costing+$conversion_cost+$trims_cost+$embel_cost+$wash+$commercial_cost+$commission+$lab_test_cost+$cm_cost+$currier_pre_cost+$inspection_cost+$freight+$common_oh+$certificate_pre_cost+$depr_amor_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost;
				$sl=$sl+1;
  				$others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
				echo $others_cost_value;die;
				if($zero_value==1)
				{
				?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Value</b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($tot_order_value,4);$price_dzn=$tot_order_value;//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? $tot_fab_cot=$tot_fabric_cost+$yarn_costing+$conversion_cost;
					echo fn_number_format($tot_fabric_cost+$yarn_costing+$conversion_cost,2); ?></td>
                    <td align="right" rowspan="17">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($tot_fab_cot/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($trims_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($embel_cost/$tot_order_value)*100,2);//fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($wash,4); ?></td>
                    <td align="center"><? echo fn_number_format(($wash/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($commercial_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($commercial_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="center"><? echo fn_number_format(($commission/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($depr_amor_pre_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($lab_test_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($inspection_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($cm_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                    <td align="center"><? echo fn_number_format(($freight/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($currier_pre_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($certificate_pre_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Deffd. LC/DC Cost</td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format(($deffdlc_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Interest </td>
                    <td align="right"><? echo fn_number_format($row[csf("interest_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format(($row[csf("interest_cost")]/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Income Tax</td>
                    <td align="right"><? echo fn_number_format($row[csf("incometax_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format(($row[csf("incometax_cost")]/$tot_order_value)*100,2); ?>%</td>
                 </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                    <td align="center"><? echo fn_number_format(($common_oh/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:18)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($all_total_cost,4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format(($all_total_cost/$tot_order_value)*100,2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-19)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $tot_mergin=$tot_order_value-$all_total_cost;echo fn_number_format(($tot_mergin/$order_qty)*12,2);
					  //echo '=========='.$tot_order_value.'-'.$all_total_cost.'/'.$order_job_qnty;
					$marging_dzn=($tot_mergin/$order_qty)*12;
					  ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($tot_mergin/$tot_order_value)*100;
					 echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($all_total_cost/$order_job_qnty,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($marging_dzn/12,2); ?></td>
                    <td align="right"></td>
                </tr>
            	<?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Value</b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($tot_order_value,4); $price_dzn=$tot_order_value;//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                	<td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? $tot_fab_cot=$tot_fabric_cost+$yarn_costing+$conversion_cost;
					echo fn_number_format($tot_fabric_cost+$yarn_costing+$conversion_cost,2); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($tot_fab_cot/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($trims_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($embel_cost/$tot_order_value)*100,2);//fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($wash,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($wash/$tot_order_value)*100,2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($commercial_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($commercial_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($commission/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($lab_test_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($inspection_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($cm_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($freight/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format(($common_oh/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<?=$sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($all_total_cost,4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format(($all_total_cost/$tot_order_value)*100,2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><?= ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $tot_mergin=$tot_order_value-$all_total_cost;echo fn_number_format(($tot_mergin/$order_qty)*12,2);

					$marging_dzn=($tot_mergin/$order_qty)*12;
					  ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($tot_mergin/$tot_order_value)*100;
					 echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($all_total_cost/$order_job_qnty,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($marging_dzn/12,2); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
	//End all summary report here -------------------------------------------

	//2 Fabric Cost part here-------------------------------------------
		$sql = "select id, job_no,item_number_id,uom,body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount,avg_finish_cons,status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
		$po_cond2="";$po_cond="";
		if($all_po_ids!="")
		{
			$po_cond="and po_break_down_id in($all_po_ids)";
			$po_cond2="and b.id in($all_po_ids)";
		}
		//echo $po_cond.'CCCXXXXXXXXXXX';die;
		$item_set=sql_select("select set_item_ratio,gmts_item_id,job_no from wo_po_details_mas_set_details where job_no=".$txt_job_no."") ;
		foreach( $item_set as $row )
        {
			 $set_item_ratio_arr[$row[csf("job_no")]][$row[csf("gmts_item_id")]]=$row[csf("set_item_ratio")];
		}

		$knit_fab=""; $woven_fab=""; $knit_subtotal_amount=0; $woven_subtotal_amount=0; $knit_subtotal_amount_dzn=0; $knit_subtotal_amount_kg=0; $woven_subtotal_amount_dzn=0; $woven_subtotal_amount_kg=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
			$knit_cost_dzn=$row[csf("amount")];$woven_cost_dzn=$row[csf("amount")];

			if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];

 				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
					<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="center">'.$unit_of_measurement[$row[csf("uom")]].'</td>
 					<td align="right">'.fn_number_format($fincons,4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],4).'</td>
                </tr>';
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
            	$knit_subtotal_amount+=$row[csf("amount")];
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				if($knit_subtotal_amount_dzn>0){
					$knit_subtotal_amount_kg=$knit_subtotal_amount/$knit_subtotal_avg_cons;
				}
				else{
					$knit_subtotal_amount_kg=0;
				}
			}
			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];

				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
					<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="center">'.$unit_of_measurement[$row[csf("uom")]].'</td>
 					<td align="right">'.fn_number_format($fincons,4).'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],4).'</td>
                </tr>';
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$row[csf("amount")];
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;

				$woven_subtotal_amount_kg=$woven_subtotal_amount/$woven_subtotal_amount_dzn;
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="100">UOM</td>
							<td width="100">Finish Fab Qnty</td>
 							<td width="50">Rate</td>
							<td width="50">Amount</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr><td colspan="6">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
					</tr>';
  		echo $knit_fab;

		//woven fabrics table here
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
					</tr>
   					</table></div>';
        echo $woven_fab;

		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$yarn_data_array=array();
		$sql_y=sql_select("select c.item_number_id,c.order_quantity ,c.plan_cut_qnty,f.job_no,f.color,f.count_id,f.copm_one_id,f.percent_one,f.copm_two_id,f.percent_two,f.type_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,e.requirment   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_yarn_cost_dtls f where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and a.job_no=f.job_no and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_cost_dtls_id and a.job_no=".$txt_job_no." $txt_po_breack_down_id_cond3 and e.cons !=0    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0");//C.COLOR_NUMBER_ID=E.COLOR_NUMBER_ID and C.SIZE_NUMBER_ID=E.GMTS_SIZES and D.ID=F.FABRIC_COST_DTLS_ID

		foreach($sql_y as $sql_y_r)
		{

			$set_item_ratio=$gmtsitem_ratio_array[$sql_y_r[csf('job_no')]][$sql_y_r[csf('item_number_id')]];
			$cons_qnty = def_number_format((($sql_y_r[csf("requirment")]*$sql_y_r[csf("cons_ratio")]/100)*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			$avg_cons_qnty = def_number_format(($sql_y_r[csf("avg_cons_qnty")]*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			 $amount = def_number_format(($cons_qnty*$sql_y_r[csf("rate")]),5,"");
			//$amount = def_number_format(($avg_cons_qnty*$sql_y_r[csf("rate")]),5,"");

			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][qnty]+=$cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][avg_qnty]+=$avg_cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][amount]+=$amount;
		}
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//Mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
				 $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
		        $data_array=sql_select($sql);
		?>
        <!-- <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

 				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("copm_two_id")]][$row[csf("percent_two")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]][qnty];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("copm_two_id")]][$row[csf("percent_two")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]][qnty];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("copm_two_id")]][$row[csf("percent_two")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]][amount];
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($rowcons_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($rowavgcons_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($rowamount,4); ?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_yarn_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_avg_yarn_qty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,4); ?></td>
                </tr>
        	</table>
        </div> -->
      <?

	//End Yarn Cost part report here -------------------------------------------

	//start	Conversion Cost to Fabric report here -------------------------------------------

	$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 group by a.cons_process order by  a.cons_process";
	$tot_data_array=sql_select($sql_count);
	foreach( $tot_data_array as $row ){
			 $process_id=$row[csf("cons_process")];
			 $process_row+=count($row[csf("cons_process")]);
	 }
	 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.fab_nature_id,b.uom,b.color_type_id,b.fabric_description,b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by  a.cons_process";
	 $data_array=sql_select($sql);
 	?>
        <!-- <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+2+$process_row; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Required</td>
                    <td width="100">Avg.Required</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
			$conversion= new conversion($condition);
			$conv_data_amt_arr=$conversion->getAmountArray_by_conversionid();
			$conv_data_qty_arr=$conversion->getQtyArray_by_conversionid();

            $total_conversion_cost=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
            foreach( $data_array as $row )
            {
				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0)
				{
				$item_descrition = "All Fabrics";
				}
				else
				{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}

				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) )
						{
							if($k!=1)
							{
								?>
                               <tr>
                                    <td>&nbsp;</td>
                                    <td><strong>Sub. Total : </strong></td>
                                    <td align="right"><strong><? echo fn_number_format($total_convsion_qty,4); ?></strong></td>
                                    <td align="right"><strong><? echo fn_number_format($total_avg_convsion_qty,4); ?></strong></td>
                                    <td>&nbsp;</td>
                                    <td align="right"><strong><? echo fn_number_format($total_conversion_cost,4); ?></strong></td>
                                </tr>
                                <?
							}
							?>
                            <?
							unset($total_convsion_qty);
							unset($total_avg_convsion_qty);
							unset($total_conversion_cost);
							$process_array_check[]=$process_id;
							$k++;
						}
						$conv_amount=$conv_data_amt_arr[$row[csf('id')]][$row[csf('uom')]];
						$conv_qty=$conv_data_qty_arr[$row[csf('id')]][$row[csf('uom')]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($conv_qty,4);//echo fn_number_format($conv_data[$row[csf('id')]]['conv_qnty'],4); ?></td>
                    <td align="right"><? echo fn_number_format($conv_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($conv_amount/$conv_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($conv_amount,4);//echo fn_number_format($conv_data[$row[csf('id')]]['conv_amount'],4); ?></td>
                </tr>
            <?
			$total_convsion_qty+=$conv_qty;
			$total_avg_convsion_qty+=$conv_qty;
            $total_conversion_cost +=$conv_amount;
			$grand_total_conv_qnty+=$conv_qty;
			$grand_total_avg_convsion_qty+=$conv_qty;
			$grand_total_conversion_cost+=$conv_amount;
			$total_conversion_cost_dzn+=$row[csf('amount')];
			if($total_avg_yarn_qty>0){
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
			}
			else{
				$total_conversion_cost_kg =0;
			}
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty,4); ?></td>
                <td align="right"><? echo fn_number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($total_conversion_cost,4); ?></td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total</td>
                <td align="right"><? echo fn_number_format($grand_total_conv_qnty,4); ?></td>
                <td align="right"><? echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
            </tr>
            </table>
      </div> -->
      <?
	//End Conversion Cost to Fabric report here -------------------------------------------



	//start	Trims Cost part report here -------------------------------------------
    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Consumption</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();

            $total_trims_cost=0;  $total_trims_qty=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
			$trim_group=return_library_array( "select item_name,id from  lib_item_group ", "id", "item_name" );
            foreach( $data_array as $row ){

				$row[csf("cons_dzn_gmts")]=$trim_qty_arr[$row[csf("id")]];
				$row[csf("amount")]=$trim_amount_arr[$row[csf("id")]];


			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_trims_cost += $row[csf("amount")];
				 $total_trims_qty += $row[csf("cons_dzn_gmts")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------



	 //start	Embellishment Details part report here -------------------------------------------
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Gmts. Qnty (Dzn)</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();

			$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash= new wash($condition);
			$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
			//print_r($wash_qty_arr);
            $total_embellishment_amt=0;$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {
				$em_type ="";
				$total_embellishment_amt_dzn += $row[csf("amount")];
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1) $em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];

				$embell_budget_qty_id=$embelt_budget_qty_id_arr[$row[csf("emb_name")]];
				if($row[csf("emb_name")]!=3){
				$row[csf("cons_dzn_gmts")]=$emblishment_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
				$row[csf("amount")]=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				else {
				$row[csf("cons_dzn_gmts")]=$wash_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
				$row[csf("amount")]=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}



			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_embellishment_amt += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$commercial= new commercial($condition);
			$commarcial_amount_arr=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$total_commercial_cost_dzn+= $row[csf("amount")];

				$amount =$commarcial_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_commercial_cost += $amount;

            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$commission= new commision($condition);
			$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
			//print_r($commission_amount_arr);
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount=$commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];// $row[csf("commission_amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($commission_amount,4); ?></td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	//End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,currier_pre_cost, currier_percent, 	certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:848px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="650">Particulars</td>
                    <td width="550">Amount</td>
                 </tr>
            <?
            $total_other_components=0;$lab_test_dzn=0;
			$lab_test = 0;
			$inspection = 0;
			$cm_cost = 0;
			$freight = 0;
			$common_oh = 0;
           foreach( $data_array as $row )
           {
				$lab_test = $lab_test_cost;
				$inspection = $inspection_cost;
				$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
				$freight = $freight_cost;
				$common_oh = $common_oh;
				$currier_pre_cost = $currier_cost;
				$certificate_pre_cost = $certificate_cost;
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
				$total_trims_cost_dzn = $row[csf("trims_cost")];

   			?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>

                <tr>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
            <?
                 $total_other_components += $lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh+$depr_amor_pre_cost+$deffdlc_cost+$incometax_cost+$interest_cost;
           }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">

            <?
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = 0;
            $total_summary_amount = $total_commission_cost+$total_commercial_cost+$total_embellishment_amt+$total_trims_cost+$grand_total_conversion_cost+$total_yarn_amount +$woven_subtotal_amount+$knit_subtotal_amount+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh+$depr_amor_pre_cost+$deffdlc_cost+$interest_cost+$interest_cost;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:848px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/DZN</td>
                    <td width="100">Cost/Kg</td>
                    <td width="100">Total</td>
                 </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) </td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Woven Fabric (Purchase)</td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Yarn</td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric</td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost_dzn,4); ?></td>
                    <td align="right" rowspan="15"><? //echo fn_number_format($total_trims_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commission</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
                    <td align="right"><? echo fn_number_format($interest_percent,4); ?></td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"><? echo fn_number_format($incometax_percent,4); ?></td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_summary_amount,4); ?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
          <?
          //start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value -111</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><?  echo fn_number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission=$commission_costing_arr[$job_no];//$less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial=$commercial_costing_arr[$job_no];//$less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty;
					 echo fn_number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight=$other_costing_arr[$job_no]['freight'];//$less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>

                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right">
					<?
					//echo $others_cost_value;
					$otherCost=$others_cost_value;
					//	$otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($otherCost,4);
					?>
                    </td>
                    <td align="center"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM(Contribution Margin)</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,4); ?></td>
                    <td align="center"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_qty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><?
					$cm_cost=$cm_cost_dzn;//$other_costing_arr[$job_no]['cm_cost'];
					echo fn_number_format($cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:425px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_values;//$order_job_qnty*$avg_unit_price;
					 echo fn_number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $total_summary_amount;//$all_total_cost;
					echo fn_number_format($total_cost,4);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_qty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
           </table>
      </div>
       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>
      <div style="clear:both"></div>
      </div>
	   <br/> <br/>
         <?

	 $lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");
	//and b.un_approved_date is null
	 $approve_data_array=sql_select("select b.approved_by,min(b.approved_date) as approved_date from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  group by  b.approved_by order by b.approved_by asc");
	 $unapprove_data_array=sql_select("select b.approved_by, b.un_approved_by, b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_date,b.approved_by");
	// echo "select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_no";

 	if(count($approve_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="40%" style="border:1px solid black;">Name</th>
				<th width="30%" style="border:1px solid black;">Designation</th>
				<th width="27%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
    <br/>
	<?
	$sql_unapproved=sql_select("select user_id,booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2  and booking_id=$mst_id and is_deleted=0 and status_active=1");
	//echo  "select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id";
	$unapproved_request_arr=array();
	foreach($sql_unapproved as $rowu)
	{
		$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
	}

	if(count($unapprove_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<!--<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>-->
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;  $un_approve_req_chk=array();$un=1;
			foreach($unapprove_data_array as $row)
			{
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<!--<td width="20%" style="border:1px solid black;"><? //echo $unapproved_request_arr[$row[csf('approved_by')]];?></td>-->
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
             </tr>
				<?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if(!empty($un_approved_date))
				{
					$un_approv_user=$row[csf('approved_by')].$mst_id;
					if (!in_array($un_approv_user,$un_approve_req_chk))
					{
						$un++;
						$un_approve_req_chk[]=$un_approv_user;
						$unapproved_request=$unapproved_request_arr[$mst_id];
						//echo $un_approv_user."=";
					}
					if($row[csf('un_approved_by')]!=0) $row[csf('approved_by')]=$row[csf('un_approved_by')];
					?>
					<tr style="border:1px solid black;">
						<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
					</tr>
					<?
					$i++;
				}
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
    <!--End CM on Net Order Value Part report here -->
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>
      </div>
    <br/>
     <?  echo signature_table(109, $cbo_company_name, "890px");?>
	</div>
	 <?
	 exit();
}

if($action=="bomRpt3")
{
	///extract($_REQUEST);
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';  $txt_po_breack_down_id_cond1='';  $txt_po_breack_down_id_cond2='';  $txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	//$brand_arr=return_library_array( "select id, brand_name from lib_brand",'id','brand_name');
	$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand",'id','brand_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and b.status_active=1 and b.is_deleted=0 and a.body_part_type in(1,20)","gsm_weight");
	//$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");
	//echo $gsm_weight_bottom.'DD';
	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");

	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	$set_order=0;
	if(count($grmts_sql)>1)
	{
		$set_order=1;
	}

	if($db_type==0) ///fab_knit_fin_req_kg,fab_knit_req_kg
	{
	   $sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty,  c.costing_per,c.budget_minute,c.costing_date,c.approved,c.exchange_rate ,a.quotation_id,c.incoterm,c.sew_effi_percent,group_concat(b.sc_lc) as sc_lc, d.fab_knit_req_kg,d.fab_knit_fin_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute,c.incoterm,c.sew_effi_percent, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv order by a.job_no";
	}
	else if($db_type==2)
	{
		$sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.ship_mode,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, listagg(cast(b.sc_lc as varchar2(4000)),',') within group (order by b.sc_lc) as sc_lc, c.costing_per,c.costing_date,c.budget_minute,c.approved,a.quotation_id,c.exchange_rate ,c.incoterm,c.sew_effi_percent,d.fab_knit_fin_req_kg, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv,a.agent_name,a.brand_id
		from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
		where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom,a.ship_mode, a.avg_unit_price, c.incoterm,c.costing_date,c.exchange_rate ,a.quotation_id,c.costing_per,c.sew_effi_percent,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv,a.agent_name,a.brand_id  order by a.job_no"; //a.job_quantity as job_quantity,
	}
  	//echo $sql;die;
	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	$exchange_rate=$data_array[0][csf('exchange_rate')];
	$pre_costing_smv=$data_array[0][csf('sew_smv')];

	//$preCost_histry=sql_select( "select min(a.sew_smv) as sew_smv,min(a.sew_effi_percent) as sew_effi_percent,min(b.margin_dzn_percent) as margin_dzn_percent ,min(b.fabric_cost_percent) as  fabric_cost_percent,min(b.trims_cost_percent ) as trims_cost_percent,min(b.embel_cost_percent) as embel_cost_percent,min(b.wash_cost_percent) as wash_cost_percent ,min(b.comm_cost_percent) as comm_cost_percent ,min(b.commission_percent) as commission_percent,min(b.lab_test_percent) as lab_test_percent,min(b.inspection_percent) as inspection_percent,min(b.cm_cost_percent) as cm_cost_percent,min(b.freight_percent) as freight_percent,min(b.currier_percent) as currier_percent,min(b.certificate_percent) as certificate_percent,min(b.common_oh_percent) as common_oh_percent    from  wo_pre_cost_mst_histry a,wo_pre_cost_dtls_histry b where a.job_no=b.job_no and a.job_no=$txt_job_no");
	$preCost_histry=sql_select( "select a.id as mst_id,b.id as dtls_id,a.sew_smv as sew_smv,a.sew_effi_percent as sew_effi_percent,b.margin_dzn_percent as margin_dzn_percent ,b.fabric_cost_percent as fabric_cost_percent,b.trims_cost_percent  as trims_cost_percent,b.embel_cost_percent as embel_cost_percent,b.wash_cost_percent as wash_cost_percent ,b.comm_cost_percent as comm_cost_percent,b.commission_percent as commission_percent,b.lab_test_percent as lab_test_percent,b.inspection_percent as inspection_percent,b.cm_cost_percent as cm_cost_percent,b.freight_percent as freight_percent,b.currier_percent as currier_percent,b.certificate_percent as certificate_percent,b.common_oh_percent as common_oh_percent from wo_pre_cost_mst_histry a,wo_pre_cost_dtls_histry b where a.job_no=b.job_no and a.job_no=$txt_job_no  order by  a.id,b.id  asc");

	list($preCost_histry_row)=$preCost_histry;
	$opert_profitloss_percent=$preCost_histry_row[csf('margin_dzn_percent')];
	$fabric_cost_percent=$preCost_histry_row[csf('fabric_cost_percent')];
	$trims_cost_percent=$preCost_histry_row[csf('trims_cost_percent')];
	$embel_cost_percent=$preCost_histry_row[csf('embel_cost_percent')];
	$wash_cost_percent=$preCost_histry_row[csf('wash_cost_percent')];
	$comm_cost_percent=$preCost_histry_row[csf('comm_cost_percent')];
	$commission_percent=$preCost_histry_row[csf('commission_percent')];
	$common_oh_percent=$preCost_histry_row[csf('common_oh_percent')];

	$lab_test_percent=$preCost_histry_row[csf('lab_test_percent')];
	$inspection_percent=$preCost_histry_row[csf('inspection_percent')];
	$cm_cost_percent=$preCost_histry_row[csf('cm_cost_percent')];
	$freight_percent=$preCost_histry_row[csf('freight_percent')];
	$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$certificate_percent=$preCost_histry_row[csf('certificate_percent')];
	//$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$sew_effi_percent=$data_array[0][csf('sew_effi_percent')];//
	$hissew_effi_percent=$preCost_histry_row[csf('sew_effi_percent')];
	$sew_smv=$preCost_histry_row[csf('sew_smv')];
	$first_app_date="";
	$last_app_date="";
	$preCost_approved=sql_select( "select max(b.approved_no) as approved_no, min(b.approved_date) as first_app_date, max(b.approved_date) as last_app_date,a.id from wo_pre_cost_mst a, approval_history b where b.full_approved=1 and  a.id=b.mst_id and a.job_no=$txt_job_no and b.entry_form=15 group by a.id");
	//echo "select max(b.approved_no) as approved_no from wo_pre_cost_mst a, approval_history b where a.id=b.mst_id and a.job_no=$txt_job_no and b.entry_form=15";
	//list($preCost_approved_row)=$preCost_approved;
	//print_r($preCost_approved); die;
	if(count($preCost_approved)>0)
	{
		foreach($preCost_approved as $preCost_approved_row)
		{
			$approved_no_row=$preCost_approved_row[csf('approved_no')];
			$fst_date=$preCost_approved_row[csf('first_app_date')];
			$fstapp_date=$fst_date[0];

			$last_date=$preCost_approved_row[csf('last_app_date')];
			$lstapp_date=$last_date[0];
			$precost_id=$preCost_approved_row[csf('id')];
			/*if($fstapp_date!="" || $fstapp_date!="00-00-0000")
			{
				$first_app_date=date('d-m-y',strtotime($fstapp_date));
				$last_app_date=date('d-m-y',strtotime($lstapp_date));
			}*/

			if($approved_no_row>1){
				$revised_no=$approved_no_row-1;
			}
		}
	}


	$preCost_approved_component=sql_select( "select   max(approved_date) as last_app_date,count(approved_date) as approve_no,cost_component_id from co_com_pre_costing_app_his where mst_id=$precost_id and job_no=$txt_job_no and entry_form=15 group by cost_component_id  ");
	$higher_autorize_app_date=$preCost_approved_component[0][csf('last_app_date')];
	$higher_autorize_approve_no=$preCost_approved_component[0][csf('approve_no')];
	if($higher_autorize_app_date!="") $last_date=$higher_autorize_app_date;
	if($higher_autorize_approve_no!="") $revised_no=$revised_no+$higher_autorize_approve_no;

	 $company_id=str_replace("'","",$cbo_company_name);
	// echo $fstapp_date.'dddddddddd';die;
	 if($fstapp_date=="" || $fstapp_date=="00-00-0000") $first_app_dateD="";else $first_app_dateD=$fstapp_date;
	 if($lstapp_date=="" || $lstapp_date=="00-00-0000") $lstapp_dateD="";else $lstapp_dateD=$lstapp_date;
	//echo $higher_autorize_app_date."**".$lstapp_date;die;
	$img_path = ($img_path)?$img_path:'../../';

	//Fabric ,Trims,Emblishment,Wash Synchronize check//If color size breakdown updated found
	$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fabric_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");

	$trim_msg="";
	foreach($sql_trim as $row)
	{
		if($row[csf("is_apply_last_update")]==2)
		{
			$trim_msg=" Trims,";
			$chk_msg=1;
		}
	}

	$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_trim_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");

	$trim_msg="";
	foreach($sql_trim as $row)
	{
		if($row[csf("is_apply_last_update")]==2)
		{
			$trim_msg=" Trims,";
			$chk_msg=1;
		}
	}
	$sql_conv=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fab_conv_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");

	$conv_msg="";
	foreach($sql_conv as $row)
	{
		if($row[csf("is_apply_last_update")]==2)
		{
			$conv_msg=" Conversion,";
			$chk_msg=1;
		}
	}

	$sql_embl=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update,emb_name  from wo_pre_cost_embe_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1 and cons_dzn_gmts>0 group by emb_name");

	$emb_msg="";
	foreach($sql_embl as $row)
	{
		if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]==3) //Wash
		{
			$wash_msg=" Wash,";
			$chk_msg=1;
		}
		else if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]!=3)
		{
			$emb_msg=" Emblishment";
			$chk_msg=1;
		}
	}
	 if($chk_msg==1)
	 {
	$check_msg="Color size breakdown is updated. please Synchronize following heads: ";
	$check_msg.=$fabric_msg.$conv_msg.$trim_msg.$emb_msg.$wash_msg;
		//echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
	 }
	 else
	 {
		$check_msg="";
		 //echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
	 }


	?>
    <div style="width:972px; margin:0 auto">

    <div style="width:970px; font-size:20px; font-weight:bold" align="center"><b style="float:left"> <img  src='<? echo $img_path.$imge_arr[$company_id]; ?>' height='40px' width='100px' /></b><? echo $comp[str_replace("'","",$cbo_company_name)]; ?><b style="float:right; font-size:14px; font-weight:bold"> <?  echo '&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;';?>  </b></div>
    <div style="width:970px; font-size:18px; font-weight:bold" align="center"><b style="float:left"></b>Bill Of Materials (BOM) Report<b style="float:right; font-size:18px; font-weight:bold"> <? if($revised_no!=0) echo 'Revised No &nbsp;:'.$revised_no; else echo " &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;"; ?>  &nbsp;  </b> </div>
    <div style="width:970px; font-size:14px; font-weight:bold" align="center"><b style="float:right; font-size:14px; font-weight:bold; color:#F00"> <? if($fst_date!="") echo "First Approval Date:".$fst_date; if($last_date!="") echo ";<br>  Last Approval Date:".$last_date; else echo " &nbsp;"; ?>  &nbsp;  </b>
    <p style="color:red"> <? echo $check_msg;?></p>
     </div>
	<?

	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$order_values = $row[csf("ord_qty")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,pub_shipment_date,file_no,excess_cut,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		//$tot_row=count($result);
		$job_in_orders = '';$pulich_ship_date='';$job_in_ref = '';$job_in_file = '';
		$tot_excess_cut=0;$tot_row=0;
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			if($val[csf('excess_cut')]>0)
			{
				$tot_row++;
			}
			$tot_excess_cut+= $val[csf('excess_cut')];

			//$job_in_ref .= $val[csf('grouping')].", ";
			//$job_in_file .= $val[csf('file_no')].", ";
		//	if($job_in_ref=='') $job_in_ref= $val[csf('grouping')]; else $job_in_ref.=",". $val[csf('grouping')];
		//	if($job_in_file=='') $job_in_file= $val[csf('file_no')]; else $job_in_file.=",". $val[csf('file_no')];
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		//$sew_effi_percent=$row[csf("sew_effi_percent")];

		?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<caption><? if($row[csf("approved")]==1) echo "<font color='red' style=' font-size:15px; font-weight:bold'>THIS JOB IS APPROVED</font>"; else "";?> </caption>
                	<tr>
                    	<td>Job No</td>
                        <td><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td>Buyer</td>
                        <td><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
						<td>Agent/Brand</td>
                        <td><b><? echo $buyer_arr[$row[csf("agent_name")]]; 
						if($row[csf("brand_id")]!="")echo "/".$brand_arr[$row[csf("brand_id")]];?></b></td>
                        <td>Style Ref. No</td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
						<td>Garments Item</td>
                        <td><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                        <td>Incoterm</td>
                        <td><b><? echo $incoterm[$row[csf("incoterm")]]; ?></b></td>
                    	<td>Costing for</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>

                        <td>Sew. Effi. %</td>
                        <td><b><? echo $row[csf("sew_effi_percent")]; ?></b></td>
						<td>Order UOM</td>
                        <td><? echo $unit_of_measurement[$row[csf("order_uom")]]; ?></td>
                    </tr>
                    <!-- <tr>
                        <td>LC/SC No</td>
                        <td colspan="5"><b><? echo $row[csf("sc_lc")]; ?></b></td>
						<td colspan="2">LC/SC Value : <b><? echo $row[csf("sc_lc")]; ?></b></td>
                    </tr> -->
                </table>

            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for="1 DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for="1 PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for="2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for="3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for="4 DZN";}
			else {$order_price_per_dzn=0;$costing_for="DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch
	  $sql_po = "select a.job_no, a.company_name, a.set_smv, a.total_set_qnty, b.id as po_id, (e.plan_cut_qnty) as plan_cut, (b.po_quantity) as ord_qty, b.excess_cut, b.unit_price, b.po_total_price, b.po_number, b.shiping_status, b.pub_shipment_date, b.is_confirmed, b.insert_date, c.exchange_rate, c.incoterm, d.price_dzn, e.order_quantity as color_size_qty, a.order_uom
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c, wo_pre_cost_dtls d, wo_po_color_size_breakdown e
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no and c.job_no=d.job_no and b.id=e.po_break_down_id and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref order by b.insert_date ASC";
			$po_data_array=sql_select($sql_po); $set_ratio=0; $exchange_rate=0;
			foreach($po_data_array as $row)
			{
				$insert_date=explode(" ",$row[csf("insert_date")]);
				$insert_date=$insert_date[0];
				$po_wise_arr[$row[csf("po_id")]]['ord_qty']=$row[csf("ord_qty")];
				$po_wise_arr[$row[csf("po_id")]]['plan_cut']+=$row[csf("plan_cut")];
				$po_wise_arr[$row[csf("po_id")]]['excess_cut']=$row[csf("excess_cut")];
				$po_wise_arr[$row[csf("po_id")]]['unit_price']=$row[csf("unit_price")];
				$po_wise_arr[$row[csf("po_id")]]['po_total_price']=$row[csf("po_total_price")];
				$po_wise_arr[$row[csf("po_id")]]['total_set_qnty']=$row[csf("total_set_qnty")];
				$po_wise_arr[$row[csf("po_id")]]['shiping_status']=$row[csf("shiping_status")];
				$po_wise_arr[$row[csf("po_id")]]['pub_shipment_date']=$row[csf("pub_shipment_date")];
				$po_wise_arr[$row[csf("po_id")]]['is_confirmed']=$row[csf("is_confirmed")];
				$po_wise_arr[$row[csf("po_id")]]['insert_date']=$insert_date;
				$po_wise_arr[$row[csf("po_id")]]['po_number']=$row[csf("po_number")];
				$po_wise_arr[$row[csf("po_id")]]['set_smv']=$row[csf("set_smv")];
				$po_wise_arr[$row[csf("po_id")]]['color_size_qty']+=$row[csf("color_size_qty")];

				$incoterm_id=$row[csf("incoterm")];
				$set_ratio=$row[csf("total_set_qnty")];
				$price_dzn=$row[csf("price_dzn")];
				$exchange_rate=$row[csf("exchange_rate")];
				$order_uom=$row[csf("order_uom")];
			}
			//echo $price_dzn; die;
			?>
			<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px; font-size:14px" rules="all">
				<caption> <b>Order Info </b></caption>
                	<thead>
                    	<th width="20">SL</th>
						<th width="90">Order No</th>
                        <th width="70">Order Qty(<?= $unit_of_measurement[$order_uom] ?>)</th>
                        <th width="70">Breakdown Qty(Pcs)</th>
                        <th width="60">Excess Cut %</th>
                        <th width="70">Plan Cut Qty(Pcs)</th>
                        <th width="60">Avg. Unit Price (Pcs)</td>
                        <th width="70">Order Value</th>
						<th width="60">SMV</th>
                        <th width="70">TTL SAH</th>
						<th width="60">Ship date</th>
						<th width="60">Insert date</th>
						<th width="70">Order Status</th>
						<th>Ship Status</th>
                    </tr>
					<?
					$p=1;$total_po_qty=$total_plan_cut_qty=$total_po_value=$total_ttl_sah=0;
					foreach($po_wise_arr as $poKey=>$val)
					{
						$ord_qty=$val["ord_qty"]*$val["total_set_qnty"];
						$plan_qty=$val["plan_cut"];
						$unit_price=($val["unit_price"]/$val["total_set_qnty"]);
						if(is_infinite($unit_price) || is_nan($unit_price)){$unit_price=0;}
						$po_price=$ord_qty*$unit_price;
						if($set_order>0)
						{
							$ttl_plan_cut=$val["ord_qty"]+($val["ord_qty"]*$val["excess_cut"]/100);
							$ttl_sah=($ttl_plan_cut*$val["set_smv"])/60;
							$ttl_title="Plan Cut Qty(Set=".$ttl_plan_cut.")*SMV/60";
						}
						else
						{
							$ttl_plan_cut=$plan_qty;
							$ttl_sah=($ttl_plan_cut*$val["set_smv"])/60;
							$ttl_title="Plan Cut Qty(Pcs=".$ttl_plan_cut.")*SMV/60";
						}
					?>
                    <tr>
                        <td><? echo $p; ?></td>
						<td style="word-break:break-all"><? echo $val["po_number"]; ?></td>
                        <td align="right"><? echo fn_number_format($val["ord_qty"],0); ?></td>
                        <td align="right"><? echo fn_number_format($val["color_size_qty"],0); ?></td>
                    	<td align="right"><? echo fn_number_format($val["excess_cut"],2); ?></td>
                        <td align="right" title="<?=$val["ord_qty"].'='.$val["total_set_qnty"];?>"><? echo fn_number_format($plan_qty,0); ?></td>
                        <td align="right"><? echo fn_number_format($unit_price,3); ?></td>
                        <td align="right"><? echo fn_number_format($po_price,2); ?></td>
						<td align="right"><? echo fn_number_format($val["set_smv"],3); ?></td>
                        <td align="right" title="<?=$ttl_title;?>"><? echo fn_number_format($ttl_sah,2); ?></td>
						<td><? echo date('d-m-y',strtotime($val["pub_shipment_date"])); //change_date_format?></td>
                        <td><? echo date('d-m-y',strtotime($val["insert_date"])); ?></td>

						<td><? echo $order_status[$val["is_confirmed"]]; ?></td>
                        <td style="word-break:break-all"><? echo $shipment_status[$val["shiping_status"]]; ?></td>
                    </tr>
					<?
					$p++;
					$total_po_qty+=$val["ord_qty"];
					$total_plan_cut_qty+=$val["plan_cut"];
					$total_po_value+=$val["po_total_price"];
					$total_color_size_qty+=$val["color_size_qty"];

					$tot_po_qty+=$ord_qty;
					$tot_plan_cut_qty+=$plan_qty;
					$tot_po_value+=$po_price;

					$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					}
					$job_po_rate_set=$total_po_value/$total_po_qty;
					if(is_infinite($job_po_rate_set) || is_nan($job_po_rate_set)){$job_po_rate_set=0;}
					$td_qty_pcs_color="";
					if($tot_po_qty!=$total_color_size_qty) $td_qty_pcs_color="#FF0000";
					?>
					<tfoot>
					<th colspan="2">Job Total</th>
					<th align="right" bgcolor="<? echo $td_qty_pcs_color; ?>"><? echo fn_number_format($total_po_qty,0); ?></th>
                    <th align="right" bgcolor="<? echo $td_qty_pcs_color; ?>"><? echo fn_number_format($total_color_size_qty,0); ?></th>
					<th align="right" title="Total ((Plan Cut-PO Qty)/Po Qty)*100"><?
					$excec_per=(($tot_plan_cut_qty-$tot_po_qty)/$tot_po_qty)*100;
					if(is_infinite($excec_per) || is_nan($excec_per)){$excec_per=0;}
					echo  fn_number_format($excec_per,0);
					?></th>

					<th align="right"><? echo  fn_number_format($tot_plan_cut_qty,0); ?></th>
					<th align="right"><? $job_po_rate=$tot_po_value/$tot_po_qty;echo  fn_number_format($job_po_rate,3); ?></th>
					<th align="right"><? echo  fn_number_format($tot_po_value,2); ?></th>
					<th align="right" title="Total TTL SAH*60/Plan Cuts"><?
					$tot_smv=($total_ttl_sah*60)/$tot_plan_cut_qty;
					if(is_infinite($tot_smv) || is_nan($tot_smv)){$tot_smv=0;}
					echo  fn_number_format($tot_smv,3);
					?></th>
					<th align="right"><?  echo  fn_number_format($total_ttl_sah,2); ?></th>
					<th align="right"><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th align="right"><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th><?
					$tot_perDznValue=($tot_po_value/$tot_po_qty)*12;
					if(is_infinite($tot_perDznValue) || is_nan($tot_perDznValue)){$tot_perDznValue=0;}
					//echo  fn_number_format($total_po_qty,0); ?></th>
					</tfoot>
                </table>
				<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<?
				$po_no=str_replace("'","",$txt_po_breack_down_id);
				$condition= new condition();
				if(str_replace("'","",$txt_job_no) !=''){
					$condition->job_no("=$txt_job_no");
				}

				if(str_replace("'","",$txt_po_breack_down_id)!='')
				{
					$condition->po_id("in($po_no)");
				}
				$condition->init();
			//$yarn= new yarn($condition);


           $fabric= new fabric($condition);
		   //echo $fabric->getQuery(); die;
		  //$fabric_costing_arr=$fabric->getQtyArray_by_job_knitAndwoven_greyAndfinish_production();
		   $yarn= new yarn($condition);
			$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
			$fabric= new fabric($condition);
			$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();

			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();

			$conversion= new conversion($condition);
			$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
			$trims= new trims($condition);
			//echo $trims->getQuery(); die;
			$trims_costing_arr=$trims->getAmountArray_by_job();
			$emblishment= new emblishment($condition);
			$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
			$wash= new wash($condition);
			//echo $wash->getQuery(); die;
			$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		    $commercial= new commercial($condition);
			$commercial_costing_arr=$commercial->getAmountArray_by_job();
			$commission= new commision($condition);
			$commission_costing_arr=$commission->getAmountArray_by_job();
			$other= new other($condition);
			$other_costing_arr=$other->getAmountArray_by_job();

			$job_no=str_replace("'","",$txt_job_no);
			//All Cost start here...
			///----------------AAA---------
			$ttl_conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);

			$ttl_fab_cost=array_sum($fabric_costing_arr2['knit']['grey'][$job_no])+array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);
			$total_fab_cost=$yarn_costing_arr[$job_no]+$ttl_fab_cost+$ttl_conversion_cost;

			$ttl_trims_cost=$trims_costing_arr[$job_no];
			$ttl_emblishment_cost=$emblishment_costing_arr[$job_no]+$emblishment_costing_arr_wash[$job_no];
			$ttl_commercial_cost=$commercial_costing_arr[$job_no];
			$ttl_commission_cost=$commission_costing_arr[$job_no];

			$ttl_cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			if(is_infinite($ttl_cm_cost) || is_nan($ttl_cm_cost)){$ttl_cm_cost=0;}
			$ttl_freight_cost=$other_costing_arr[$job_no]['freight'];
			if(is_infinite($ttl_freight_cost) || is_nan($ttl_freight_cost)){$ttl_freight_cost=0;}
			$ttl_inspection_cost=$other_costing_arr[$job_no]['inspection'];
			if(is_infinite($ttl_inspection_cost) || is_nan($ttl_inspection_cost)){$ttl_inspection_cost=0;}
			$ttl_certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			if(is_infinite($ttl_certificate_cost) || is_nan($ttl_certificate_cost)){$ttl_certificate_cost=0;}
			$ttl_common_oh=$other_costing_arr[$job_no]['common_oh'];
			if(is_infinite($ttl_common_oh) || is_nan($ttl_common_oh)){$ttl_common_oh=0;}
			$ttl_currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			if(is_infinite($ttl_currier_cost) || is_nan($ttl_currier_cost)){$ttl_currier_cost=0;}
			$ttl_lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			if(is_infinite($ttl_lab_test_cost) || is_nan($ttl_lab_test_cost)){$ttl_lab_test_cost=0;}
			$ttl_depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			if(is_infinite($ttl_depr_amor_pre_cost) || is_nan($ttl_depr_amor_pre_cost)){$ttl_depr_amor_pre_cost=0;}
			$ttl_deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			if(is_infinite($ttl_deffdlc_cost) || is_nan($ttl_deffdlc_cost)){$ttl_deffdlc_cost=0;}
			$ttl_other_cost=$ttl_cm_cost+$ttl_freight_cost+$ttl_inspection_cost+$ttl_certificate_cost+$ttl_common_oh+$ttl_currier_cost+$ttl_lab_test_cost+$ttl_depr_amor_pre_cost+$ttl_deffdlc_cost;
			//echo $ttl_conversion_cost.'='.$ttl_trims_cost.'='.$ttl_emblishment_cost.'='.$ttl_commercial_cost.'='.$ttl_commission_cost.'='.$ttl_other_cost;
			$ttl_total_cost=$total_fab_cost+$ttl_trims_cost+$ttl_emblishment_cost+$ttl_commercial_cost+$ttl_commission_cost+$ttl_other_cost;
			$costing_per_unit_budget=$ttl_total_cost/$tot_po_qty;
			if(is_infinite($costing_per_unit_budget) || is_nan($costing_per_unit_budget)){$costing_per_unit_budget=0;}

			$fab_knit_req_kg=$data_array[0][csf('fab_knit_req_kg')];
			if(is_infinite($fab_knit_req_kg) || is_nan($fab_knit_req_kg)){$fab_knit_req_kg=0;}
			$fab_knit_fin_req_kg=$data_array[0][csf('fab_knit_fin_req_kg')];
			if(is_infinite($fab_knit_fin_req_kg) || is_nan($fab_knit_fin_req_kg)){$fab_knit_fin_req_kg=0;}
			$fab_woven_req_yds=$data_array[0][csf('fab_woven_req_yds')];
			if(is_infinite($fab_woven_req_yds) || is_nan($fab_woven_req_yds)){$fab_woven_req_yds=0;}
			$fab_woven_fin_req_yds=$data_array[0][csf('fab_woven_fin_req_yds')];
			if(is_infinite($fab_woven_fin_req_yds) || is_nan($fab_woven_fin_req_yds)){$fab_woven_fin_req_yds=0;}
			$fab_yarn_req_kg=$data_array[0][csf('fab_yarn_req_kg')];
			if(is_infinite($fab_yarn_req_kg) || is_nan($fab_yarn_req_kg)){$fab_yarn_req_kg=0;}
			$exchange_rate=$data_array[0][csf('exchange_rate')];
			if(is_infinite($exchange_rate) || is_nan($exchange_rate)){$exchange_rate=0;}
			//$avg_unit_price=$data_array[0][csf('avg_unit_price')];\
			$avg_unit_price=$job_po_rate;
			if(is_infinite($avg_unit_price) || is_nan($avg_unit_price)){$avg_unit_price=0;}
			$ship_mode=$data_array[0][csf('ship_mode')];
			if(is_infinite($ship_mode) || is_nan($ship_mode)){$ship_mode=0;}
			$quotation_id=$data_array[0][csf('quotation_id')];
			if(is_infinite($quotation_id) || is_nan($quotation_id)){$quotation_id=0;}
			$costing_date=$data_array[0][csf('costing_date')];
			if(is_infinite($costing_date) || is_nan($costing_date)){$costing_date=0;}
			$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
			if(is_infinite($gsm_weights_top) || is_nan($gsm_weights_top)){$gsm_weights_top=0;}
			//$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
			//if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';

						//echo $gsm_weightTop .$gsm_weightBottom;
				?>
                	<tr>
                    	<td>Knit Fabric Cons</td>
                        <td align="right" ><b><? echo $fab_knit_req_kg; ?></b></td>
                        <td>Woven Fab. Cons	</td>
                        <td align="right" ><b><? echo $fab_woven_req_yds; ?></b></td>
                        <td>Quotation Id</td>
                        <td><b><? echo $quotation_id; ?></b></td>
						<td>Costing Date</td>
                        <td><b><? echo  date('d-M-y',strtotime($costing_date)); ?></b></td>
                    </tr>
                    <tr>
                        <td>Avg Yarn Req</td>
                        <td align="right"><b><? echo $fab_yarn_req_kg; ?></b></td>
                    	<td>Woven Fin Fabric Cons</td>
                        <td align="right" ><b><? echo $fab_woven_fin_req_yds; ?></b></td>

                        <td>Exchange Rate</td>
                        <td align="right" ><b><? echo $exchange_rate; ?></b></td>
						<td>Avg Unit Price</td>
                        <td align="right" ><? echo fn_number_format($avg_unit_price,3); ?></td>
                    </tr>
					 <tr>
                        <td>Knit Fin Fab. Cons </td>
                        <td align="right"><b><? echo $fab_knit_fin_req_kg; ?></b></td>
                    	<td>Incoterm</td>
                        <td><b><? echo $incoterm[$incoterm_id]; ?></b></td>

                        <td>Ship Mode</td>
                        <td><b><? echo $shipment_mode[$ship_mode]; ?></b></td>
						<td>Cost Per Unit As Budget</td>
                        <td align="right"  title="Total Cost<? echo $ttl_total_cost;?>/Total PO Qty Pcs"><? echo fn_number_format($costing_per_unit_budget,3); ?></td>
                    </tr>
					<tr style="background:#F9F">
						<td><b> SMV % (As 1st App) : &nbsp;<? echo $sew_smv;?></b></td>
						<td><b> Efficiency %(As 1st App) :&nbsp;<? echo $hissew_effi_percent;?> </b></td>
						<td align="right" colspan="3">Net Pft/Loss %(As 1st App)</td>
                        <td align="right" ><b><? echo $opert_profitloss_percent;?></b></td>
                    	<td title="Total Cost/Total PO Qty">Net Profit/Loss %</td>
                        <td align="right" ><b>
						<?
						$operatin_profit_loss_per=(($avg_unit_price-$costing_per_unit_budget)/$avg_unit_price)*100;
						if(is_infinite($operatin_profit_loss_per) || is_nan($operatin_profit_loss_per)){$operatin_profit_loss_per=0;}
						echo fn_number_format($operatin_profit_loss_per,2);
				 ?>
                        </b>
                        </td>
					</tr>
                </table>

			<?

	//$ttl_commercial_cost=$commercial_costing_arr[$job_no];
		//2 Fabric Cost part here-------------------------------------------
		$sql = "select id, job_no, item_number_id, gsm_weight, uom, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);

		$knit_fab="";$woven_fab="";
		$knit_subtotal_amount=0;
		$woven_subtotal_amount=0;$knit_subtotal_amount_dzn=0;$knit_subtotal_amount_kg=0;$woven_subtotal_amount_dzn=0;$woven_subtotal_amount_kg=$knit_subtotal_avg_cons_dzn=$knit_subtotal_avg_finish_cons_dzn=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
			    $set_item_ratio=return_field_value("set_item_ratio"," wo_po_details_mas_set_details", "job_no='".$row[csf('job_no')]."' and gmts_item_id='".$row[csf('item_number_id')]."'");

			   $fincons=0;
			   $greycons=0;
			   $order_qty_fab=0;
			   $fab_dtls_data=sql_select("select po_break_down_id,color_number_id,gmts_sizes,cons,requirment from wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id=".$row[csf("id")]." $txt_po_breack_down_id_cond2 and cons !=0");
			   foreach($fab_dtls_data as $fab_dtls_data_row )
			   {
					 $sql_po_qty_fab=sql_select("select sum(c.plan_cut_qnty) as order_quantity  from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  b.id=".$fab_dtls_data_row[csf('po_break_down_id')]." and c.item_number_id='".$row[csf('item_number_id')]."' and size_number_id='".$fab_dtls_data_row[csf('gmts_sizes')]."' and  color_number_id= '".$fab_dtls_data_row[csf('color_number_id')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
					 list($sql_po_qty_row_fab)=$sql_po_qty_fab;
	                 $po_qty_fab=$sql_po_qty_row_fab[csf('order_quantity')];
					 $order_qty_fab+=$po_qty_fab;
			   }
			$knit_cost_dzn=$row[csf("amount")];$woven_cost_dzn=$row[csf("amount")];
			if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
 				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.fn_number_format($greycons,2).'</td>
 					<td align="right">'.fn_number_format($row[csf("avg_finish_cons")],3).'</td>
					<td align="right">'.fn_number_format($fincons,2).'</td>
                    <td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],3).'</td>
                    <td align="right">'.fn_number_format($knit_cost_dzn,4).'</td>
					<td align="right">'.fn_number_format($row[csf("amount")],2).'</td>
					<td align="right">'.fn_number_format((($knit_cost_dzn/$price_dzn)*100),2).'</td>
                </tr>';
				$knit_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
				$knit_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
            	$knit_subtotal_amount+=$row[csf("amount")];
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				$knit_subtotal_amount_kg=$knit_subtotal_amount/$knit_subtotal_amount_dzn;
			}
			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$fincons=$fabric_qty_arr['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="center">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.fn_number_format($greycons,2).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_finish_cons")],3).'</td>
 					<td align="right">'.fn_number_format($fincons,2).'</td>
                    <td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],3).'</td>
					<td align="right">'.fn_number_format($woven_cost_dzn,4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],2).'</td>
					<td align="right">'.fn_number_format((($woven_cost_dzn/$price_dzn)*100),2).'</td>
                </tr>';
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
				$woven_subtotal_amount+=$row[csf("amount")];
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
				$woven_subtotal_amount_kg=$woven_subtotal_amount/$woven_subtotal_amount_dzn;
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">


					<label  style="float:left;background:#CCCCCC;font-size:larger;"><b>All Fabric Cost </b> </label>

						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="50">GSM</td>
							<td width="100">Fab. Cons/'.$costing_for.'</td>
							<td width="100">Gray Fabric Qty</td>
							<td width="100">Finish Cons/ '.$costing_for.'</td>
							<td width="100">Finish Fab Qty</td>
							<td width="50">UOM</td>
 							<td width="50">Rate</td>
							<td width="50">Amount/ '.$costing_for.'</td>
							<td width="50">TTL Amount</td>
							<td width="50">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$KnitFabricTotalParcentToOrdValue =(($knit_subtotal_amount_dzn/$price_dzn)*100);
		if(is_infinite($KnitFabricTotalParcentToOrdValue) || is_nan($KnitFabricTotalParcentToOrdValue)){$KnitFabricTotalParcentToOrdValue=0;}

		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Knit Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,2).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($KnitFabricTotalParcentToOrdValue,2).'</td>
					</tr>';
  		echo $knit_fab;
		//woven fabrics table here
		$WovenFabricTotalParcentToOrdValue=(($woven_subtotal_amount_dzn/$price_dzn)*100);
		if(is_infinite($WovenFabricTotalParcentToOrdValue) || is_nan($WovenFabricTotalParcentToOrdValue)){$WovenFabricTotalParcentToOrdValue=0;}

		$fabricTotalParcentToOrdValue=((($knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn)/$price_dzn)*100);
		if(is_infinite($fabricTotalParcentToOrdValue) || is_nan($fabricTotalParcentToOrdValue)){$fabricTotalParcentToOrdValue=0;}

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Woven Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,2).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($WovenFabricTotalParcentToOrdValue,2).'</td>
					</tr>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Fabric Total</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_dzn+$woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons+$woven_subtotal_avg_cons,2).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_dzn+$woven_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons+$woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount+$woven_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($fabricTotalParcentToOrdValue,2).'</td>
					</tr>
   					</table></div>';
      	  echo $woven_fab;
				//end 	All Fabric Cost part report-------------------------------------------
			$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
				 $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no."  and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";

		        $data_array=sql_select($sql);
				$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
				//print_r($yarn_data_array);

		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger;"><b>Yarn Cost </b> </label>
                <tr style="font-weight:bold">

                    <td width="350">Yarn Desc</td>
                    <td width="80">Yarn Qty/<?=$costing_for; ?></td>
					<td width="80">TTL Yarn Qty</td>

                    <td width="80">Rate</td>
                    <td width="80">Amount/<?=$costing_for; ?></td>
					<td width="80">TTL Amount</td>
					<td width="">% to Ord. Value</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=$total_yarn_qty_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
 				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
				if(is_infinite($rowamount) || is_nan($rowamount)){$rowamount=0;}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($rowcons_qnty,2); ?></td>

                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($rowamount,2); ?></td>
					<td align="right"><?
					$cv=($row[csf("amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_yarn_qty_dzn+=$row[csf("cons_qnty")];
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
				  if(is_infinite($total_yarn_cost_kg) || is_nan($total_yarn_cost_kg)){$total_yarn_cost_kg=0;}
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Yarn Total</td>
                    <td align="right"><? echo fn_number_format($total_yarn_qty_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_yarn_qty,2); ?></td>

                    <td></td>
					<td align="right"><? echo fn_number_format($total_yarn_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,2); ?></td>
					<td align="right"><?
					$cv=($total_yarn_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_yarn_cost_dzn/$price_dzn)*100,2);
					?></td>
                </tr>
        	</table>
      </div>
      <?
		//End Yarn Cost part report here -------------------------------------------

		//start	Conversion Cost to Fabric report here -------------------------------------------
		$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 group by a.cons_process order by  a.cons_process";
		$tot_data_array=sql_select($sql_count);
		foreach( $tot_data_array as $row ){
				 $process_id=$row[csf("cons_process")];
				 $process_row+=count($row[csf("cons_process")]);
		 }
		 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down,a.color_break_down_aop, a.status_active,b.body_part_id,b.uom ,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by  a.cons_process";
		 $data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label style="float:left;background:#CCCCCC; font-size:larger"><b>Conversion Cost to Fabric </b> </label>
                <tr style="font-weight:bold; font-size:12px">
                    <td width="230">Particulars</td>
                    <td width="110">Process</td>
                    <td width="60">Cons/<?=$costing_for; ?></td>
					<td width="80">TTL Required</td>
					<td width="60">Uom</td>

                    <td width="60">Rate</td>
                    <td width="60">Rate(Tk)</td>
					<td width="70">Amount/<?=$costing_for; ?></td>
                    <td width="80">TTL Amount</td>
					<td>% to Ord. Value</td>
                </tr>
            <?
			$no_color_arr=array(1=>"1 - 3",2=>"1 - 5",3=>"4 - 6",4=>"7 - 12");
			$conv_data_qty=$conversion->getQtyArray_by_conversionid();
			$conv_data_amt=$conversion->getAmountArray_by_conversionid();

            $total_conversion_cost=$total_convsion_qty_dzn=$total_conversion_cost_dzn=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=$grand_total_conversion_cost_dzn=$grand_total_avg_convsion_qty_dzn=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
            foreach( $data_array as $row )
            {
				$convsion_qty=$conv_data_qty[$row[csf('id')]][$row[csf('uom')]];
				$conversion_cost=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];

				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0) $item_descrition = "All Fabrics";
				else
				{
					$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}

				$process_id=$row[csf("cons_process")];$aop_cond="";
				if($row[csf("color_break_down_aop")]!="")
				{
					$break_down_aopArr=explode("_",$row[csf("color_break_down_aop")]);
					//print_r($break_down_aopArr);
					$aop_color=$no_color_arr[$break_down_aopArr[4]];
					$aop_type=$print_type[$break_down_aopArr[3]];
					$aop_cond=", ".$aop_type.','.$aop_color;
				}
			
				if (!in_array($process_id,$process_array_check) )
				{
					if($k!=1)
					{
						?>
					   <tr>
							<td>&nbsp;</td>
							<td><strong>Process Total </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty_dzn,3); ?></strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty,2); ?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost_dzn,3); ?></strong></td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost,2); ?></strong></td>
							<td align="right"><?
							$cv=($total_conversion_cost_dzn/$price_dzn)*100;
							if(is_infinite($cv) || is_nan($cv)){$cv=0;}
							echo fn_number_format($cv,3);
							//echo fn_number_format(($total_conversion_cost_dzn/$price_dzn)*100,3);

							?></td>
						</tr>
						<?
					}
					?>
					<?
					unset($total_convsion_qty_dzn);unset($total_conversion_cost_dzn);
					unset($total_convsion_qty);
					unset($total_avg_convsion_qty);
					unset($total_conversion_cost);
					unset($total_convsion_qty_dzn);
					$process_array_check[]=$process_id;
					$k++;
				}
			?>
                <tr>
                    <td align="left" style="font-size:14px; word-break:break-all"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]].$aop_cond; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($convsion_qty,2); ?></td>
					<td align="right"><? echo  $unit_of_measurement[$row[csf('uom')]]; ?></td>

                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],3); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")]*$exchange_rate,3); ?></td>

					<td align="right"><? echo fn_number_format($row[csf('amount')],4); ?></td>
                    <td align="right"><? echo fn_number_format($conversion_cost,2); ?></td>
					<td align="right" title="<? echo $row[csf('amount')].'='.$price_dzn;?>">
					<?
					$cv=($row[csf('amount')]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf('amount')]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
				$total_convsion_qty+=$convsion_qty;
				$total_convsion_qty_dzn+=$row[csf("req_qnty")];
				$total_avg_convsion_qty+=$row[csf("req_qnty")];
				$total_conversion_cost += $conversion_cost;
			//	$total_conversion_cost_dzn += $row[csf('amount')];
				$grand_total_conv_qnty+=$convsion_qty;
				$grand_total_avg_convsion_qty+=$convsion_qty;
				$grand_total_avg_convsion_qty_dzn+=$row[csf("req_qnty")];
				$grand_total_conversion_cost+= $conversion_cost;
				$grand_total_conversion_cost_dzn+= $row[csf('amount')];
				$total_conversion_cost_dzn+=$row[csf('amount')];
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
				if(is_infinite($total_conversion_cost_kg) || is_nan($total_conversion_cost_kg)){$total_conversion_cost_kg=0;}
				//$grand_total_avg_convsion_qty;
           	 }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Process Total</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty_dzn,3); ?></td>
				 <td align="right"><? echo fn_number_format($total_convsion_qty,2); ?></td>
				 <td align="right"><? //echo fn_number_format($total_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
				<td align="right"><? echo fn_number_format($total_conversion_cost_dzn,4); ?></td>
                <td align="right"><? echo fn_number_format($total_conversion_cost,2); ?></td>
				<td align="right"><?
					$cv=($total_conversion_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
				//echo fn_number_format(($total_conversion_cost_dzn/$price_dzn)*100,2);

				?></td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Conversion Total</td>
                <td align="right"><? echo fn_number_format($grand_total_avg_convsion_qty_dzn,3); ?></td>
				<td align="right"><? echo fn_number_format($grand_total_conv_qnty,2); ?></td>
				<td align="right"><? //echo fn_number_format($grand_total_conv_qnty,4); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
				<td align="right"><? echo fn_number_format($grand_total_conversion_cost_dzn,4); ?></td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost,2); ?></td>
				<td align="right"  title="<? echo $grand_total_conversion_cost_dzn.'='.$price_dzn;?>">
				<?
					$cv=($grand_total_conversion_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
				//echo fn_number_format(($grand_total_conversion_cost_dzn/$price_dzn)*100,3);
				?>
                </td>
            </tr>
			  <tr class="rpt_bottom" style="font-weight:bold">
			  	<td>Total Fabric Cost</td>
                <td align="right" colspan="6" style="background:#F9F">Previous Fabric cost % (As 1st Approval) : <? echo fn_number_format($fabric_cost_percent,4); ?> </td>
				<td align="right" title="Fabric Cost+Yarn+Conversion(Dzn)"><? $total_fab_cost_dzn=$knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn+$total_yarn_cost_dzn+$grand_total_conversion_cost_dzn;echo fn_number_format($total_fab_cost_dzn,4); ?></td>
				<td align="right"><? $all_fab_cost=$knit_subtotal_amount+$woven_subtotal_amount+$total_yarn_amount+$grand_total_conversion_cost; echo fn_number_format($all_fab_cost,2); ?></td>
				<td align="right"><?
					$cv=($total_fab_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
				//echo fn_number_format(($total_fab_cost_dzn/$price_dzn)*100,2);
				?></td>
			  </tr>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -------------------------------------------



	//start	Trims Cost part report here -------------------------------------------
	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi, status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Trims Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="110">Item Group</td>
                    <td width="150">Description</td>
					<td width="100">Nominated Supp</td>
                    <td width="100">Brand/Supp Ref</td>
                    <td width="60">UOM</td>
                    <td width="80">Cons/<?=$costing_for; ?></td>
					<td width="100">TTL Required</td>
                    <td width="80">Rate</td>
                    <td width="80">Amount/<?=$costing_for; ?></td>
					<td width="80">Amount</td>
					<td width="60">% to Ord. Value</td>
                </tr>
            <?
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
            $total_trims_cost=0;  $total_trims_qty=$total_trims_cost_dzn=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
            foreach( $data_array as $row ){

				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$cons_dzn_gmts= $row[csf("cons_dzn_gmts")];
				$amount_dzn= $row[csf("amount")];
				$pre_trims_qty=$trim_qty_arr[$row[csf("id")]];
				$pre_trims_amount=$trim_amount_arr[$row[csf("id")]];

				$nominated_supp_str="";
				$exsupp=explode(",",$row[csf("nominated_supp_multi")]);
				foreach($exsupp as $sid)
				{
					if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
				}
			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><?=$nominated_supp_str; ?></td>
					<td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($cons_dzn_gmts,3); ?></td>
					<td align="right"><? echo fn_number_format($pre_trims_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					 <td align="right"><? echo fn_number_format($amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($pre_trims_amount,2); ?></td>
					<td align="right"  title="<? echo $amount_dzn.'='.$price_dzn;?>">
					<?
					$cv=($amount_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($amount_dzn/$price_dzn)*100,2);
					?></td>
                </tr>
            <?
                 $total_trims_cost += $pre_trims_amount;
				 $total_trims_cost_dzn += $amount_dzn;
				  $total_trims_qty += $pre_trims_qty;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold" >
                    <td>Trims Total</td>
					<td colspan="5" style="background:#F9F">Previous Trims cost % (As 1st Approval)=<? echo fn_number_format($trims_cost_percent,4);?></td>
					<td align="right"><? echo fn_number_format($total_trims_qty,4); ?></td>
					<td align="right"><? //echo fn_number_format($total_trims_cost_dzn,4); ?></td>

					<td align="right"><? echo fn_number_format($total_trims_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_trims_cost,2); ?></td>
					<td align="right" title="<? echo $total_trims_cost_dzn.'='.$price_dzn;?>">
					<?
					$cv=($total_trims_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_trims_cost_dzn/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------

	 //start	Embellishment Details part report here -------------------------------------------

		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Embellishment Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="170">Particulars</td>
                    <td width="170">Type</td>
                    <td width="100">Cons/<?=$costing_for; ?></td>
					<td width="120">TTL Gmts. Qty</td>
                    <td width="80">Rate</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="120">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			//echo $emblishment->getQuery(); die;
			$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();

			$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
			$cost_per_qty_arr=$condition->getCostingPerArr();


            $total_embellishment_amt=0;$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {
				$em_type ="";
				//$total_embellishment_amt_dzn += $row[csf("amount")];
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
				$cost_per_qty=$cost_per_qty_arr[$row[csf("job_no")]];
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				//$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$order_job_qnty;
				//$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$order_job_qnty;
				if($row[csf("emb_name")] !=3){
					$embl_cons_gmts=$emblishment_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				else if($row[csf("emb_name")] ==3){
					$embl_cons_gmts=$wash_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				$embl_cons_gmts=$embl_cons_gmts;//(($embl_cons_gmts*$cost_per_qty)/$tot_plan_cut_qty)*$set_ratio;//
				$row[csf("amount")]=($row[csf("amount")]/$cost_per_qty)*$set_ratio;//*$set_ratio
				if(is_infinite($row[csf("amount")]) || is_nan($row[csf("amount")])){$row[csf("amount")]=0;}

				$embl_amt=$row[csf("cons_dzn_gmts")]*$row[csf("rate")];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],3); ?></td>
					<td align="right"><? echo fn_number_format($embl_cons_gmts,0); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($embl_amt,4); ?></td>
                    <td align="right"><? echo fn_number_format($embl_amount,2); ?></td>
					<td align="right" title="<? echo $embl_amt.'='.$price_dzn;?>">
					<?
					$cv=($embl_amt/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf("amount")]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
                 $total_embellishment_amt += $embl_amount;
				 $total_embellishment_amt_dzn += $embl_amt;
				 $total_embellishment_qty += $embl_cons_gmts;
				  $total_embellishment_qty_dzn += $row[csf("cons_dzn_gmts")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Embellishment Total</td>
					<td colspan="2"  style="background:#F9F">Previous Embel.cost % (As 1st Approval)=<? echo fn_number_format($embel_cost_percent,4);?></td>
                    <td align="right"><? echo fn_number_format($total_embellishment_qty,0); ?></td>
					<td align="right"><? //echo fn_number_format($total_embellishment_qty,4); ?></td>
					<td align="right"><? echo fn_number_format($total_embellishment_amt_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_embellishment_amt,2); ?></td>
					<td align="right" title="<? echo $total_embellishment_amt_dzn.'='.$price_dzn;?>">
					<?
					$cv=($total_embellishment_amt_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_embellishment_amt_dzn/$price_dzn)*100,2);
					?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------
	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commercial Cost</b> </label>

                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>

					<td width="200">Rate In %</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				//$total_commercial_cost_dzn+= $row[csf("amount")];
				$amount = $commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
				if(is_infinite($amount) || is_nan($amount)){$amount=0;}
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
					<td align="right"><? echo fn_number_format($amount,2); ?></td>
					<td align="right"  title="<? echo $$row[csf("amount")].'='.$price_dzn;?>">
					<?
					$cv=($row[csf("amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf("amount")]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
                 $total_commercial_cost_dzn += $row[csf("amount")];
				  $total_commercial_cost += $amount;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Commercial Total</td>
					<td align="right"  style="background:#F9F">Previous Commercial % (As 1st Approval)=<?  echo fn_number_format($comm_cost_percent,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commercial_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commercial_cost,2); ?></td>
					<td align="right" title="<? echo $total_commercial_cost_dzn.'='.$price_dzn;?>">
					<?
					$cv=(($total_commercial_cost_dzn/$price_dzn)*100);
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format((($total_commercial_cost_dzn/$price_dzn)*100),2);
					?>
                    </td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------

  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commission Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>
                    <td width="250">Commission Basis</td>
                    <td width="100">Rate</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount = $commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				if(is_infinite($commission_amount) || is_nan($commission_amount)){$commission_amount=0;}
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],3); ?></td>
					 <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($commission_amount,2); ?></td>
					<td align="right" title="<? echo $row[csf("commission_amount")].'='.$price_dzn;?>">
					<?
					$cv=($row[csf("commission_amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf("commission_amount")]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
				// $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Commission Total</td>
					<td colspan="2"  style="background:#F9F">Previous Commission % (As 1st Approval)=<? echo fn_number_format($commission_percent,4);?></td>
					<td align="right"><? echo fn_number_format($total_commission_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commission_cost,2); ?></td>
					<td align="right"><?
 					//echo fn_number_format(($total_commission_cost_dzn/$price_dzn)*100,2);

					?></td>
                </tr>
            </table>
      </div>
		<br/>
		  <?
	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,depr_amor_pre_cost,deffdlc_cost,studio_cost,design_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,incometax_cost,interest_cost,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,design_percent,studio_percent,currier_pre_cost, currier_percent,certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
         <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:620px;text-align:center;" rules="all">

			<label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Others Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="220">Particulars</td>
                    <td width="100"> Cost/<?=$costing_for; ?> (As 1st Approval)</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
					<td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_other_components=0; $lab_test_dzn=$interest_cost=$incometax_cost=0; $lab_test = 0; $inspection = 0; $cm_cost = 0; $freight = 0; $common_oh = 0; $price_dzn=0;
           foreach( $data_array as $row )
           {
				$job_no=$row[csf("job_no")];
				$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
				$freight_cost=$other_costing_arr[$job_no]['freight'];
				$inspection_cost=$other_costing_arr[$job_no]['inspection'];
				$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
				$common_oh=$other_costing_arr[$job_no]['common_oh'];
				$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
				$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
				$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
				$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
				$studio_cost=$other_costing_arr[$job_no]['studio_cost'];
				$design_cost=$other_costing_arr[$job_no]['design_cost'];
				$interest_cost=$other_costing_arr[$job_no]['interest_cost'];
				$incometax_cost=$other_costing_arr[$job_no]['incometax_cost'];
				$price_dzn=$row[csf("price_dzn")];
				//$freight = $freight_cost;
				//$common_oh = $common_oh;
				//$currier_pre_cost = $currier_cost;
				//$certificate_pre_cost = $certificate_cost;
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
				$deffdlc_cost_dzn = $row[csf("deffdlc_cost")];
				$depr_amor_pre_cost_dzn = $row[csf("depr_amor_pre_cost")];
				$interest_cost_dzn=$row[csf("interest_cost")];
				$incometax_cost_dzn=$row[csf("incometax_cost")];
				$studio_cost_dzn=$row[csf("studio_cost")];
				$design_cost_dzn=$row[csf("design_cost")];


				$studio_cost_percent=$row[csf("studio_percent")];
				$design_cost_percent=$row[csf("design_percent")];
   			?>
                <tr>
                    <td align="left">Lab Test </td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($lab_test_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($lab_test_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($lab_test_cost,2); ?></td>
					<td align="right"  title="<? echo $lab_test_dzn.'='.$price_dzn;?>">
					<?
					$cv=($lab_test_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($lab_test_dzn/$price_dzn)*100,2);

					?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($inspection_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($inspection_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($inspection_cost,2); ?></td>
					<td align="right" title="<? echo $inspection_dzn.'='.$price_dzn;?>">
					<?
					$cv=($inspection_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($inspection_dzn/$price_dzn)*100,2);
					 ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost</td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($cm_cost_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
					<td align="right"><?
					$cv=($cm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($cm_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>

                 <tr>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($freight_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($freight_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($freight_cost,2); ?></td>
					<td align="right"><?
					$cv=($freight_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($freight_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($currier_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($currier_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($currier_cost,2); ?></td>
					<td align="right"><?
					$cv=($currier_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($currier_pre_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($certificate_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($certificate_pre_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($certificate_cost,2); ?></td>
					<td align="right"><?
					$cv=($certificate_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($certificate_pre_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"  style="background:#F9F"><? $deffdlc_cost_percent=0; echo fn_number_format($deffdlc_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($deffdlc_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($deffdlc_cost,2); ?></td>
					 <td align="right"><?
					$cv=($deffdlc_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
				<tr>
                    <td align="left">Studio Cost </td>
                    <td align="right"  style="background:#F9F"><? $studio_cost_percent=0; echo fn_number_format($studio_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($studio_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($studio_cost,2); ?></td>
					 <td align="right"><?
					$cv=($studio_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
				<tr>
                    <td align="left">Design  Cost </td>
                    <td align="right"  style="background:#F9F"><? $design_cost_percent=0; echo fn_number_format($design_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($design_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($design_cost,2); ?></td>
					 <td align="right"><?
					$cv=($design_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($interest_cost,3); ?></td>
					<td align="right"><? echo fn_number_format($interest_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($interest_cost,2); ?></td>
					<td align="right"><?
					$cv=($interest_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($interest_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($incometax_cost,3); ?></td>
					<td align="right"><? echo fn_number_format($incometax_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($incometax_cost,2); ?></td>
					<td align="right"><?
					$cv=($incometax_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($incometax_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Operating Expensees</td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($common_oh_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($common_oh_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($common_oh,2); ?></td>
					<td align="right"><?
					$cv=($common_oh_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($common_oh_dzn/$price_dzn)*100,2); ?></td>
                </tr>
				 <tr>
                    <td align="left">Depreciation & Amortization </td>
                    <td align="right"><? //echo fn_number_format($common_oh,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost,2); ?></td>
					<td align="right"><?
					$cv=($depr_amor_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($depr_amor_pre_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
            <?
                 $total_other_components_dzn = $lab_test_dzn+$inspection_dzn+$cm_cost_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn+$common_oh_dzn+$depr_amor_pre_cost_dzn+$design_cost_dzn+$studio_cost_dzn;
				   $total_other_components =$lab_test_cost+$inspection_cost+$cm_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost+$interest_cost+$incometax_cost+$common_oh+$depr_amor_pre_cost+$design_cost+$studio_cost;
           }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Others Total</td>
                    <td align="right"><? // echo fn_number_format($total_other_components,4); ?></td>
					<td align="right"><? echo fn_number_format($total_other_components_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_other_components,2); ?></td>
					<td align="right"><?
					$cv=($total_other_components_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_other_components_dzn/$price_dzn)*100,2); ?></td>
                </tr>
            </table>
            </td>
				   <td colspan="5"   valign="top">
				  	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:260px; margin-top:20px" rules="all">
					 <?
						// image show here  -------------------------------------------
						 $sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id=$txt_job_no and file_type=1  and rownum=1 ";
						$photo_data_array=sql_select($sql);
						$path=($path)?$path:'../../';
					 ?>
					<? foreach($photo_data_array AS $inf){ ?>
						  <tr class="rpt_bottom" style="font-weight:bold">
							<td align="center"><img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='250px' width='250px' /></td>
						 </tr>
					<?  } ?>

		 	 	</table>
				   </td>
          </tr>
		  </table>
 		<br/>
      <?
			//End Commission Cost Part report here -------------------------------------------

			//start	all summary report here -------------------------------------------
			//job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
			 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost,deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,depr_amor_pre_cost,depr_amor_po_price,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
					from wo_pre_cost_dtls
					where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			$data_array=sql_select($sql);
			$others_cost_value=0; $fabric_cost=0; $trims_cost=0; $embel_cost=0; $comm_cost=0; $commission=0; $lab_test=0; $inspection=0; $cm_cost=0; $freight=0; $currier_pre_cost=0; $certificate_pre_cost=0; $common_oh=0;
 	?>

        <div style="margin-top:15px">
		 <table>
		 <tr>
		 <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:650px;text-align:center;" rules="all">
			<caption><label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Order Profitability Summary</b> </label> </caption>
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="250">Particulars</td>
                    <td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="100">TTL Amount</td>
                    <td width="100" title="(Net FOB Value DZN/ Per DZN Order Value)*100">% to Ord. Value</td>
                </tr>
            <?
			$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$cbo_company_name  and variable_list=22 and status_active=1 and is_deleted=0");
			//echo $cm_cost_method_based_on.'AAAAAAAAAA';
			if($cm_cost_method_based_on=="") $cm_cost_method_based_on=0;else $cm_cost_method_based_on=$cm_cost_method_based_on;
			if($cm_cost_method_based_on==1)
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}
			else if($cm_cost_method_based_on==2)
			{
					$based_on_date=return_field_value("min(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
					//echo $based_on_date.'GGGGGGG';
			}
			else if($cm_cost_method_based_on==3)
			{
					$based_on_date=return_field_value("max(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
			}
			else if($cm_cost_method_based_on==4)
			{
					$based_on_date=return_field_value("min(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else if($cm_cost_method_based_on==5)
			{
					$based_on_date=return_field_value("max(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}

			$based_on_date_new =change_date_format($based_on_date,'','',1);
			//echo $cm_cost_method_based_on.'='.$based_on_date_new.'fddf';

			$financial_para=array();
			$sql_std_para=sql_select("select cost_per_minute,interest_expense,income_tax,applying_period_date as from_period_date,applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and is_deleted=0  order by id desc");
			foreach($sql_std_para as $row)
			{
				$applying_period_date=change_date_format($row[csf('from_period_date')],'','',1);
				$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
				$diff=datediff('d',$applying_period_date,$applying_period_to_date);
				for($j=0;$j<$diff;$j++)
				{
					$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
					if($based_on_date_new==$newdate)
					{
						//echo $row[csf('cost_per_minute')].',';
						$financial_para[$newdate]['cost_per_minute']=$row[csf('cost_per_minute')];
						$financial_para[$newdate]['interest_expense']=$row[csf('interest_expense')];
						$financial_para[$newdate]['income_tax']=$row[csf('income_tax')];
					}
				}
			}
			//$row[csf("sew_effi_percent")]
			$cpm_budget=(($financial_para[$based_on_date_new]['cost_per_minute']/$exchange_rate)/$sew_effi_percent)*100;
			if(is_infinite($cpm_budget) || is_nan($cpm_budget)){$cpm_budget=0;}
			//	echo $based_on_date_new.'='.$financial_para[$based_on_date_new]['cost_per_minute'].'='.$exchange_rate.'='.$sew_effi_percent;
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			//$fab_production_knit=$fabric_costing_arr['knit']['grey'][$job_no];
			//$fab_production_finish=$fabric_costing_arr['finish']['grey'][$job_no];

			$fab_purchase_knit2=array_sum($fabric_costing_arr2['knit']['grey'][$job_no]);
			if(is_infinite($fab_purchase_knit2) || is_nan($fab_purchase_knit2)){$fab_purchase_knit2=0;}
			$fab_purchase_woven2=array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);
			if(is_infinite($fab_purchase_woven2) || is_nan($fab_purchase_woven2)){$fab_purchase_woven2=0;}

			$yarn_costing=$yarn_costing_arr[$job_no];
			$tot_fabric_cost=$fab_purchase_knit2+$fab_purchase_woven2;
			$conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			if(is_infinite($conversion_cost) || is_nan($conversion_cost)){$conversion_cost=0;}
			//$testing_cost=$other_costing_arr[$job_no]['lab_test'];
			$freight_cost=$other_costing_arr[$job_no]['freight'];
			if(is_infinite($freight_cost) || is_nan($freight_cost)){$freight_cost=0;}
			$inspection_cost=$other_costing_arr[$job_no]['inspection'];
			if(is_infinite($inspection_cost) || is_nan($inspection_cost)){$inspection_cost=0;}
			$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			if(is_infinite($certificate_cost) || is_nan($certificate_cost)){$certificate_cost=0;}
			$common_oh=$other_costing_arr[$job_no]['common_oh'];
			if(is_infinite($common_oh) || is_nan($common_oh)){$common_oh=0;}
			$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			if(is_infinite($currier_cost) || is_nan($currier_cost)){$currier_cost=0;}
			$cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			if(is_infinite($cm_cost) || is_nan($cm_cost)){$cm_cost=0;}
			$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			if(is_infinite($lab_test_cost) || is_nan($lab_test_cost)){$lab_test_cost=0;}
			$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			if(is_infinite($depr_amor_pre_cost) || is_nan($depr_amor_pre_cost)){$depr_amor_pre_cost=0;}
			$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			if(is_infinite($deffdlc_cost) || is_nan($deffdlc_cost)){$deffdlc_cost=0;}
			$fabric_cost=$tot_fabric_cost;
			$trims_cost=$trims_costing_arr[$job_no];
			$embel_cost=$emblishment_costing_arr[$job_no];
			$wash=$emblishment_costing_arr_wash[$job_no];
			$commercial_cost=$commercial_costing_arr[$job_no];
			$comm_cost_dzn=$row[csf("comm_cost")];
			$cm_cost_dzn=$row[csf("cm_cost")];
			$price_dzn=$row[csf("price_dzn")];
			$total_cost_dzn=$row[csf("total_cost")];
			$deffdlc_cost_dzn=$row[csf("deffdlc_cost")];
			$interest_cost_dzn=$row[csf("interest_cost")];
			$incometax_cost_dzn=$row[csf("incometax_cost")];
			$commission_dzn=$row[csf("commission")];
			$operatin_expense_dzn=$row[csf("common_oh")];
			//deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent
			$deffdlc_percent=$row[csf("deffdlc_percent")];
			$interest_percent=$row[csf("interest_percent")];
			$incometax_percent=$row[csf("incometax_percent")];
			$depr_amor_po_price=$row[csf("depr_amor_po_price")];
			$depr_amor_pre_cost_dzn=$row[csf("depr_amor_pre_cost")];
			//interest_cost,interest_percent,incometax_cost
			$tot_commission=$commission_costing_arr[$job_no];
			$lab_test=$lab_test_cost;
			$inspection=$inspection_cost;
			$cm_cost=$cm_cost;
			$freight=$freight_cost;
			$currier_pre_cost=$currier_cost;
			$certificate_pre_cost=$certificate_cost;
			$sl=$sl+1;
  			$others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
			$price_dzn=0;

			$price_dzn=($total_po_value/$total_po_qty)*$order_price_per_dzn;
	?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Gross FOB Value/ <?=$costing_for; ?></b></td>
                 	 <td align="right" title="Order value/Order Qty*Costing Per"><b><? echo fn_number_format($price_dzn,4); ?></b></td>
                    <td align="right"><b><? echo fn_number_format($total_po_value,2);//$price_dzn=$tot_order_value; ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>

                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less Commission</td>
                    <td align="right"><? echo fn_number_format($commission_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($tot_commission,2); ?></td>
                    <td align="center"><? echo fn_number_format(($commission_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right"><? $net_fob_value_dzn=$price_dzn-$commission_dzn; echo fn_number_format($net_fob_value_dzn,4); ?></td>
					 <td align="right"><? $net_fob_value=$total_po_value-$tot_commission;echo fn_number_format($net_fob_value,2); ?></td>
                    <td align="center" ><?
					$cv=($net_fob_value_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($net_fob_value_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Material & Services Cost</td>
                    <td align="right"><? $total_material_services_dzn=$total_fab_cost_dzn+$total_trims_cost_dzn+$total_embellishment_amt_dzn+$lab_test_dzn+$inspection_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn;
									$total_material_services=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$lab_test_cost+$inspection_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost;

						echo fn_number_format($total_material_services_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($total_material_services,2); ?></td>
                    <td align="center"><?
					$cv=($total_material_services_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_material_services_dzn/$price_dzn)*100,2);//fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
				 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($comm_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($commercial_cost,2); ?></td>
                    <td align="center"><?
					$cv=($comm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($comm_cost_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/CM Value (3-4-5)</td>
                    <td align="right"><? $contributions_value_dzn=$net_fob_value_dzn-$total_material_services_dzn-$comm_cost_dzn;
							$contributions_value=$net_fob_value-$total_material_services-$commercial_cost;
							echo fn_number_format($contributions_value_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($contributions_value,2); ?></td>
                    <td align="center"><?
					$cv=($contributions_value_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($contributions_value_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: CM Cost </td>
                    <td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                    <td align="center"><?
					$cv=($cm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($cm_cost_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gross Profit(6-7)</td>
                    <td align="right"><? $gross_profit_dzn=$contributions_value_dzn-$cm_cost_dzn;
					$gross_profit_loss=$contributions_value-$cm_cost;

					echo fn_number_format($gross_profit_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($gross_profit_loss,2); ?></td>
                    <td align="center"><?
					$cv=($gross_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($gross_profit_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Operating Expensees</td>
                    <td align="right"><? echo fn_number_format($operatin_expense_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($common_oh,2); ?></td>
                    <td align="center"><?
					$cv=($operatin_expense_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($operatin_expense_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Operating Profit/Loss [8-(9)]</td>
                    <td align="right">
					<?
					$operating_profit_dzn=$gross_profit_dzn-($operatin_expense_dzn);
					$operating_profit_loss=$gross_profit_loss-($operatin_expense_dzn);
					echo fn_number_format($operating_profit_dzn,4);
					?>
                    </td>
					<td align="right"><? echo fn_number_format($operating_profit_loss,2); ?></td>
                    <td align="center"><?
					$cv=($operating_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($operating_profit_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Depreciation & Amortization </td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost,2); ?></td>
                    <td align="center"><?
					$cv=($depr_amor_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($depr_amor_pre_cost_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Interest</td>
                    <td align="right"><? echo fn_number_format($interest_cost_dzn,4); ?></td>
					<td align="right"><? //echo fn_number_format($interest_cost_dzn,4); ?></td>
                    <td align="center"><?
					$cv=($interest_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($interest_cost_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Income Tax</td>
                    <td align="right"><? echo fn_number_format($incometax_cost_dzn,4); ?></td>
					 <td align="right"><? //echo fn_number_format($incometax_cost_dzn,4); ?></td>
                    <td align="center"><?
					$cv=($incometax_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($incometax_cost_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gross Profit [10-(11+12+13)]</td>
                    <td align="right"><? $net_profit_dzn=$operating_profit_dzn-($depr_amor_pre_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn);
					$net_profit=$operating_profit_loss-($depr_amor_pre_cost);
					echo fn_number_format($net_profit_dzn,4); ?></td>
					 <td align="center"><? echo fn_number_format($net_profit,2); ?></td>
                     <td align="center" title="Net Profit Dzn/Tot Fob Dzn*100">
					 <?
					$cv=($net_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($net_profit_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"  title="Contribution Mergin /<?=$order_price_per_dzn;?>/Tot SMV(<?  echo $pre_costing_smv;?>)">EPM (Per Pcs CM/SMV)</td>
					 <td align="right" colspan="3"><?
					 $epm_per_pcs=($contributions_value_dzn/$order_price_per_dzn)/$pre_costing_smv;
					 if(is_infinite($epm_per_pcs) || is_nan($epm_per_pcs)){$epm_per_pcs=0;}
					 echo fn_number_format($epm_per_pcs,4); ?></td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM </td>
                    <td align="right" colspan="3" title="CPM/Exchange Rate/Efficiency %"><?  echo fn_number_format($cpm_budget,4); ?></td>
                 </tr>
            <?
            }
			$total_job_cost=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$total_other_components+$total_commercial_cost+$total_commission_cost;
            ?>
            </table>
			</td>
			<td valign="top">
			 <div style="margin-top:0px;">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1"style="width:320px;text-align:center;" rules="all">
				<label><b>Cost Summary on Total Order Qty</b></label>
					<tr style="font-weight:bold">
						<td width="130">Particulars</td>
						<td width="80">Amount (USD)</td>
						<td width="80">%</td>
					</tr>
					<tr>
						<td align="left">Total Order Value </td>
						<td align="right"><?
						 echo fn_number_format($total_po_value,2); ?></td>
						<td align="center"><?
						$cv=$total_po_value/$total_po_value*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format($total_po_value/$total_po_value*100,2); ?></td>
					</tr>
					 <tr>
						<td align="left">Total Cost </td>
						<td align="right" title="Total Trims+Total All Fabric Cost+Emblish+Other+Commercail+Commission "><?  //$total_cost = $total_job_cost;//$all_total_cost;
						echo fn_number_format($total_job_cost,2);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
						<td align="center"><?
						$cv=$total_job_cost/$total_po_value*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format($total_job_cost/$total_po_value*100,2); ?></td>
					</tr>
					 <tr>
						<td align="left">Net Total Margin </td>
						<td align="right" title="Total Order Value-Total Cost=(<?=$total_po_value.'-'.$total_job_cost; ?>)"><? $total_margin_val = $total_po_value-$total_job_cost; echo fn_number_format($total_margin_val,2); ?></td>
						<td align="center"><?
						$cv=($total_margin_val/$total_po_value*100);
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format(($total_margin_val/$total_po_value*100),2); ?></td>
					</tr>
					 <tr>
						<td align="left">Net Margin /<?=$costing_for; ?> </td>
						<td align="right" title="Tot Margin/PO Qty*12"><?
							$ord_val_dzn_per=($job_po_rate_set*12);

						 $margin_dzn=($total_margin_val/$total_po_qty)*12;
						 if(is_infinite($margin_dzn) || is_nan($margin_dzn)){$margin_dzn=0;}
						 echo fn_number_format($margin_dzn,4); ?></td>
						<td align="center" title="<? echo $ord_val_dzn_per.'=Unit Rate*12'; ?>">
						<?
						$cv=($margin_dzn/$ord_val_dzn_per)*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format(($margin_dzn/$ord_val_dzn_per)*100,2);

						  $margin_pcs=$margin_dzn/12;
						  if(is_infinite($margin_pcs) || is_nan($margin_pcs)){$margin_pcs=0;}
						 ?></td>
					</tr>
					<tr>
						<td align="left">Net Margin /Pcs </td>
						<td align="right" title="Margin Pcs=<? echo $margin_dzn/12;?>"><? echo fn_number_format($margin_pcs,4); ?></td>
						<td align="center" title="Rate=<? echo $job_po_rate;?>"><?
						$cv=($margin_pcs/$job_po_rate_set)*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format(($margin_pcs/$job_po_rate_set)*100,2); ?></td>
					</tr>
          		 </table>
				 </div>
			</td>
			</tr>
		</table>
      </div>
     <br/>
     <?  echo signature_table(109, $cbo_company_name, "970px");?>
     </div>
	 <?
	 disconnect($con);
	 exit();
}

if($action=="costsheet")
{
	///extract($_REQUEST);
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';  $txt_po_breack_down_id_cond1='';  $txt_po_breack_down_id_cond2='';  $txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');

	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and b.status_active=1 and b.is_deleted=0 and a.body_part_type in(1,20)","gsm_weight");
	//$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");
	//echo $gsm_weight_bottom.'DD';
	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0) ///fab_knit_fin_req_kg,fab_knit_req_kg
	{
	   $sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty,  c.costing_per,c.budget_minute,c.costing_date,c.approved,c.exchange_rate ,a.quotation_id,c.incoterm,c.sew_effi_percent,group_concat(b.sc_lc) as sc_lc, d.fab_knit_req_kg,d.fab_knit_fin_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute,c.incoterm,c.sew_effi_percent, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	else if($db_type==2)
	{
		$sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.ship_mode,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, listagg(cast(b.sc_lc as varchar2(4000)),',') within group (order by b.sc_lc) as sc_lc, c.costing_per,c.costing_date,c.budget_minute,c.approved,a.quotation_id,c.exchange_rate ,c.incoterm,c.sew_effi_percent,d.fab_knit_fin_req_kg, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
		from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
		where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom,a.ship_mode, a.avg_unit_price, c.incoterm,c.costing_date,c.exchange_rate ,a.quotation_id,c.costing_per,c.sew_effi_percent,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg  order by a.job_no"; //a.job_quantity as job_quantity,
	}
	//echo $sql;die;
	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	$exchange_rate=$data_array[0][csf('exchange_rate')];

	$preCost_histry=sql_select( "select min(a.sew_smv) as sew_smv,min(a.sew_effi_percent) as sew_effi_percent,min(b.margin_dzn_percent) as margin_dzn_percent ,min(b.fabric_cost_percent) as  fabric_cost_percent,min(b.trims_cost_percent ) as trims_cost_percent,min(b.embel_cost_percent) as embel_cost_percent,min(b.wash_cost_percent) as wash_cost_percent ,min(b.comm_cost_percent) as comm_cost_percent ,min(b.commission_percent) as commission_percent,min(b.lab_test_percent) as lab_test_percent,min(b.inspection_percent) as inspection_percent,min(b.cm_cost_percent) as cm_cost_percent,min(b.freight_percent) as freight_percent,min(b.currier_percent) as currier_percent,min(b.certificate_percent) as certificate_percent,min(b.common_oh_percent) as common_oh_percent    from  wo_pre_cost_mst_histry a,wo_pre_cost_dtls_histry b where a.job_no=b.job_no and a.job_no=$txt_job_no");

	list($preCost_histry_row)=$preCost_histry;
	$opert_profitloss_percent=$preCost_histry_row[csf('margin_dzn_percent')];
	$fabric_cost_percent=$preCost_histry_row[csf('fabric_cost_percent')];
	$trims_cost_percent=$preCost_histry_row[csf('trims_cost_percent')];
	$embel_cost_percent=$preCost_histry_row[csf('embel_cost_percent')];
	$wash_cost_percent=$preCost_histry_row[csf('wash_cost_percent')];
	$comm_cost_percent=$preCost_histry_row[csf('comm_cost_percent')];
	$commission_percent=$preCost_histry_row[csf('commission_percent')];
	$common_oh_percent=$preCost_histry_row[csf('common_oh_percent')];

	$lab_test_percent=$preCost_histry_row[csf('lab_test_percent')];
	$inspection_percent=$preCost_histry_row[csf('inspection_percent')];
	$cm_cost_percent=$preCost_histry_row[csf('cm_cost_percent')];
	$freight_percent=$preCost_histry_row[csf('freight_percent')];
	$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$certificate_percent=$preCost_histry_row[csf('certificate_percent')];
	//$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$sew_effi_percent=$data_array[0][csf('sew_effi_percent')];//
	$hissew_effi_percent=$preCost_histry_row[csf('sew_effi_percent')];
	$sew_smv=$preCost_histry_row[csf('sew_smv')];
	$first_app_date="";
	$last_app_date="";
	$preCost_approved=sql_select( "select max(b.approved_no) as approved_no, min(b.approved_date) as first_app_date, max(b.approved_date) as last_app_date,a.id from wo_pre_cost_mst a, approval_history b where b.full_approved=1 and  a.id=b.mst_id and a.job_no=$txt_job_no and b.entry_form=15 group by a.id");
	if(count($preCost_approved)>0)
	{
		foreach($preCost_approved as $preCost_approved_row)
		{
			$approved_no_row=$preCost_approved_row[csf('approved_no')];
			$fst_date=$preCost_approved_row[csf('first_app_date')];
			$fstapp_date=$fst_date[0];

			$last_date=$preCost_approved_row[csf('last_app_date')];
			$lstapp_date=$last_date[0];
			$precost_id=$preCost_approved_row[csf('id')];
			if($approved_no_row>1){
				$revised_no=$approved_no_row-1;
			}
		}
	}


	$preCost_approved_component=sql_select( "select   max(approved_date) as last_app_date,count(approved_date) as approve_no,cost_component_id from co_com_pre_costing_app_his where mst_id=$precost_id and job_no=$txt_job_no and entry_form=15 group by cost_component_id  ");
	$higher_autorize_app_date=$preCost_approved_component[0][csf('last_app_date')];
	$higher_autorize_approve_no=$preCost_approved_component[0][csf('approve_no')];
	if($higher_autorize_app_date!="") $last_date=$higher_autorize_app_date;
	if($higher_autorize_approve_no!="") $revised_no=$revised_no+$higher_autorize_approve_no;

	 $company_id=str_replace("'","",$cbo_company_name);
	// echo $fstapp_date.'dddddddddd';die;
	 if($fstapp_date=="" || $fstapp_date=="00-00-0000") $first_app_dateD="";else $first_app_dateD=$fstapp_date;
	 if($lstapp_date=="" || $lstapp_date=="00-00-0000") $lstapp_dateD="";else $lstapp_dateD=$lstapp_date;
	//echo $higher_autorize_app_date."**".$lstapp_date;die;
	$img_path = ($img_path)?$img_path:'../../';
	?>
    <div style="width:972px; margin:0 auto">

    <div style="width:970px; font-size:20px; font-weight:bold" align="center"><b style="float:left"> <img  src='<? echo $img_path.$imge_arr[$company_id]; ?>' height='70px' /></b><? echo $comp[str_replace("'","",$cbo_company_name)]; ?><b style="float:right; font-size:14px; font-weight:bold"> <?  echo '&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;';?>  </b></div>
    <div style="width:970px; font-size:18px; font-weight:bold" align="center"><b style="float:left"></b>Bill Of Materials (BOM) Report - Cost Sheet<b style="float:right; font-size:18px; font-weight:bold"> <? if($revised_no!=0) echo 'Revised No &nbsp;:'.$revised_no; else echo " &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;"; ?>  &nbsp;  </b> </div>
    <div style="width:970px; font-size:14px; font-weight:bold" align="center"><b style="float:right; font-size:14px; font-weight:bold; color:#F00"> <? if($fst_date!="") echo "First Approval Date:".$fst_date; if($last_date!="") echo ";<br>  Last Approval Date:".$last_date; else echo " &nbsp;"; ?>  &nbsp;  </b> </div>
	<?

	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$order_values = $row[csf("ord_qty")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,pub_shipment_date,file_no,excess_cut,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		//$tot_row=count($result);
		$job_in_orders = '';$pulich_ship_date='';$job_in_ref = '';$job_in_file = '';
		$tot_excess_cut=0;$tot_row=0;
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];

			if($val[csf('excess_cut')]>0)
			{
				$tot_row++;
			}
			$tot_excess_cut+= $val[csf('excess_cut')];
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);

		?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<caption><? if($row[csf("approved")]==1) echo "<font color='red' style=' font-size:15px; font-weight:bold'>THIS JOB IS APPROVED</font>"; else "";?> </caption>
                	<tr>
                    	<td>Job No</td>
                        <td><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td>Buyer</td>
                        <td><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td>Style Ref. No</td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
						<td>Garments Item</td>
                        <td><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                        <td>Incoterm</td>
                        <td><b><? echo $incoterm[$row[csf("incoterm")]]; ?></b></td>
                    	<td>Costing for</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>

                        <td>Sew. Effi. %</td>
                        <td><b><? echo $row[csf("sew_effi_percent")]; ?></b></td>
						<td>Order UOM</td>
                        <td><? echo $unit_of_measurement[$row[csf("order_uom")]]; ?></td>
                    </tr>
                    <tr>
                        <td>LC/SC No</td>
                        <td colspan="7"><b><? echo $row[csf("sc_lc")]; ?></b></td>
                    </tr>
                </table>

            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for="1 DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for="1 PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for="2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for="3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for="4 DZN";}
			else {$order_price_per_dzn=0;$costing_for="DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch
	  $sql_po = "select a.job_no, a.company_name, a.set_smv, a.total_set_qnty, b.id as po_id, (b.plan_cut) as plan_cut, (b.po_quantity) as ord_qty, b.excess_cut, b.unit_price, b.po_total_price, b.po_number, b.shiping_status, b.pub_shipment_date, b.is_confirmed, b.insert_date, c.exchange_rate, c.incoterm, d.price_dzn, e.order_quantity as color_size_qty
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c, wo_pre_cost_dtls d, wo_po_color_size_breakdown e
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no and c.job_no=d.job_no and b.id=e.po_break_down_id and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref order by b.insert_date ASC";
			$po_data_array=sql_select($sql_po); $set_ratio=0; $exchange_rate=0;
			foreach($po_data_array as $row)
			{
				$insert_date=explode(" ",$row[csf("insert_date")]);
				$insert_date=$insert_date[0];
				$po_wise_arr[$row[csf("po_id")]]['ord_qty']=$row[csf("ord_qty")];
				$po_wise_arr[$row[csf("po_id")]]['plan_cut']=$row[csf("plan_cut")];
				$po_wise_arr[$row[csf("po_id")]]['excess_cut']=$row[csf("excess_cut")];
				$po_wise_arr[$row[csf("po_id")]]['unit_price']=$row[csf("unit_price")];
				$po_wise_arr[$row[csf("po_id")]]['po_total_price']=$row[csf("po_total_price")];
				$po_wise_arr[$row[csf("po_id")]]['total_set_qnty']=$row[csf("total_set_qnty")];
				$po_wise_arr[$row[csf("po_id")]]['shiping_status']=$row[csf("shiping_status")];
				$po_wise_arr[$row[csf("po_id")]]['pub_shipment_date']=$row[csf("pub_shipment_date")];
				$po_wise_arr[$row[csf("po_id")]]['is_confirmed']=$row[csf("is_confirmed")];
				$po_wise_arr[$row[csf("po_id")]]['insert_date']=$insert_date;
				$po_wise_arr[$row[csf("po_id")]]['po_number']=$row[csf("po_number")];
				$po_wise_arr[$row[csf("po_id")]]['set_smv']=$row[csf("set_smv")];
				$po_wise_arr[$row[csf("po_id")]]['color_size_qty']+=$row[csf("color_size_qty")];

				$incoterm_id=$row[csf("incoterm")];
				$set_ratio=$row[csf("total_set_qnty")];
				$price_dzn=$row[csf("price_dzn")];
				$exchange_rate=$row[csf("exchange_rate")];
			}
			//echo $price_dzn; die;
			?>
			<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px; font-size:14px" rules="all">
				<caption> <b>Order Info </b></caption>
                	<thead>
                    	<th width="20">SL</th>
						<th width="90">Order No</th>
                        <th width="70">Order Qty(Pcs)</th>
                        <th width="70">Breakdown Qty(Pcs)</th>
                        <th width="60">Excess Cut %</th>
                        <th width="70">Plan Cut Qty(Pcs)</th>
                        <th width="60">Avg. Unit Price (Pcs)</td>
                        <th width="70">Order Value</th>
						<th width="60">SMV</th>
                        <th width="70">TTL SAH</th>
						<th width="60">Ship date</th>
						<th width="60">Insert date</th>
						<th width="70">Order Status</th>
						<th>Ship Status</th>
                    </tr>
					<?
					$p=1;$total_po_qty=$total_plan_cut_qty=$total_po_value=$total_ttl_sah=0;
					foreach($po_wise_arr as $poKey=>$val)
					{
						$ord_qty=$val["ord_qty"]*$val["total_set_qnty"];
						$plan_qty=$val["plan_cut"]*$val["total_set_qnty"];
						$unit_price=($val["unit_price"]/$val["total_set_qnty"]);
						if(is_infinite($unit_price) || is_nan($unit_price)){$unit_price=0;}
						$po_price=$ord_qty*$unit_price;
					?>
                    <tr>
                        <td><? echo $p; ?></td>
						<td style="word-break:break-all"><? echo $val["po_number"]; ?></td>
                        <td align="right"><? echo fn_number_format($ord_qty,0); ?></td>
                        <td align="right"><? echo fn_number_format($val["color_size_qty"],0); ?></td>
                    	<td align="right"><? echo fn_number_format($val["excess_cut"],2); ?></td>
                        <td align="right"><? echo fn_number_format($plan_qty,0); ?></td>
                        <td align="right"><? echo fn_number_format($unit_price,3); ?></td>
                        <td align="right"><? echo fn_number_format($po_price,2); ?></td>
						<td align="right"><? echo fn_number_format($val["set_smv"],3); ?></td>
                        <td align="right"><? $ttl_sah=($plan_qty*$val["set_smv"])/60; echo fn_number_format($ttl_sah,2); ?></td>
						<td><? echo date('d-m-y',strtotime($val["pub_shipment_date"])); //change_date_format?></td>
                        <td><? echo date('d-m-y',strtotime($val["insert_date"])); ?></td>

						<td><? echo $order_status[$val["is_confirmed"]]; ?></td>
                        <td style="word-break:break-all"><? echo $shipment_status[$val["shiping_status"]]; ?></td>
                    </tr>
					<?
					$p++;
					$total_po_qty+=$val["ord_qty"];
					$total_plan_cut_qty+=$val["plan_cut"];
					$total_po_value+=$val["po_total_price"];
					$total_color_size_qty+=$val["color_size_qty"];

					$tot_po_qty+=$ord_qty;
					$tot_plan_cut_qty+=$plan_qty;
					$tot_po_value+=$po_price;

					$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					}
					$job_po_rate_set=$total_po_value/$total_po_qty;
					if(is_infinite($job_po_rate_set) || is_nan($job_po_rate_set)){$job_po_rate_set=0;}
					$td_qty_pcs_color="";
					if($tot_po_qty!=$total_color_size_qty) $td_qty_pcs_color="#FF0000";
					?>
					<tfoot>
					<th colspan="2">Job Total</th>
					<th align="right" bgcolor="<? echo $td_qty_pcs_color; ?>"><? echo fn_number_format($tot_po_qty,0); ?></th>
                    <th align="right" bgcolor="<? echo $td_qty_pcs_color; ?>"><? echo fn_number_format($total_color_size_qty,0); ?></th>
					<th align="right" title="Total ((Plan Cut-PO Qty)/Po Qty)*100"><?
					$excec_per=(($tot_plan_cut_qty-$tot_po_qty)/$tot_po_qty)*100;
					if(is_infinite($excec_per) || is_nan($excec_per)){$excec_per=0;}
					echo  fn_number_format($excec_per,0);
					?></th>

					<th align="right"><? echo  fn_number_format($tot_plan_cut_qty,0); ?></th>
					<th align="right"><? $job_po_rate=$tot_po_value/$tot_po_qty;echo  fn_number_format($job_po_rate,3); ?></th>
					<th align="right"><? echo  fn_number_format($tot_po_value,2); ?></th>
					<th align="right" title="Total TTL SAH*60/Plan Cuts"><?
					$tot_smv=($total_ttl_sah*60)/$tot_plan_cut_qty;
					if(is_infinite($tot_smv) || is_nan($tot_smv)){$tot_smv=0;}
					echo  fn_number_format($tot_smv,3);
					?></th>
					<th align="right"><?  echo  fn_number_format($total_ttl_sah,2); ?></th>
					<th align="right"><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th align="right"><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th><?
					$tot_perDznValue=($tot_po_value/$tot_po_qty)*12;
					if(is_infinite($tot_perDznValue) || is_nan($tot_perDznValue)){$tot_perDznValue=0;}
					//echo  fn_number_format($total_po_qty,0); ?></th>
					</tfoot>
                </table>
				<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<?
				$po_no=str_replace("'","",$txt_po_breack_down_id);
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				  $condition->job_no("=$txt_job_no");
			 }

			  if(str_replace("'","",$txt_po_breack_down_id)!='')
			 {
				$condition->po_id("in($po_no)");
			 }
			  $condition->init();
			//$yarn= new yarn($condition);


           $fabric= new fabric($condition);
		   //echo $fabric->getQuery(); die;
		  //$fabric_costing_arr=$fabric->getQtyArray_by_job_knitAndwoven_greyAndfinish_production();
		   $yarn= new yarn($condition);
			$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
			$fabric= new fabric($condition);
			$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();

			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();

			$conversion= new conversion($condition);
			$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
			$trims= new trims($condition);
			//echo $trims->getQuery(); die;
			$trims_costing_arr=$trims->getAmountArray_by_job();
			$emblishment= new emblishment($condition);
			$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
			$wash= new wash($condition);
			//echo $wash->getQuery(); die;
			$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		    $commercial= new commercial($condition);
			$commercial_costing_arr=$commercial->getAmountArray_by_job();
			$commission= new commision($condition);
			$commission_costing_arr=$commission->getAmountArray_by_job();
			$other= new other($condition);
			$other_costing_arr=$other->getAmountArray_by_job();

			$job_no=str_replace("'","",$txt_job_no);
			//All Cost start here...
			///----------------AAA---------
			$ttl_conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);

			$ttl_fab_cost=array_sum($fabric_costing_arr2['knit']['grey'][$job_no])+array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);
			$total_fab_cost=$yarn_costing_arr[$job_no]+$ttl_fab_cost+$ttl_conversion_cost;

			$ttl_trims_cost=$trims_costing_arr[$job_no];
			$ttl_emblishment_cost=$emblishment_costing_arr[$job_no]+$emblishment_costing_arr_wash[$job_no];
			$ttl_commercial_cost=$commercial_costing_arr[$job_no];
			$ttl_commission_cost=$commission_costing_arr[$job_no];

			$ttl_cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			if(is_infinite($ttl_cm_cost) || is_nan($ttl_cm_cost)){$ttl_cm_cost=0;}
			$ttl_freight_cost=$other_costing_arr[$job_no]['freight'];
			if(is_infinite($ttl_freight_cost) || is_nan($ttl_freight_cost)){$ttl_freight_cost=0;}
			$ttl_inspection_cost=$other_costing_arr[$job_no]['inspection'];
			if(is_infinite($ttl_inspection_cost) || is_nan($ttl_inspection_cost)){$ttl_inspection_cost=0;}
			$ttl_certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			if(is_infinite($ttl_certificate_cost) || is_nan($ttl_certificate_cost)){$ttl_certificate_cost=0;}
			$ttl_common_oh=$other_costing_arr[$job_no]['common_oh'];
			if(is_infinite($ttl_common_oh) || is_nan($ttl_common_oh)){$ttl_common_oh=0;}
			$ttl_currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			if(is_infinite($ttl_currier_cost) || is_nan($ttl_currier_cost)){$ttl_currier_cost=0;}
			$ttl_lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			if(is_infinite($ttl_lab_test_cost) || is_nan($ttl_lab_test_cost)){$ttl_lab_test_cost=0;}
			$ttl_depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			if(is_infinite($ttl_depr_amor_pre_cost) || is_nan($ttl_depr_amor_pre_cost)){$ttl_depr_amor_pre_cost=0;}
			$ttl_deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			if(is_infinite($ttl_deffdlc_cost) || is_nan($ttl_deffdlc_cost)){$ttl_deffdlc_cost=0;}
			$ttl_other_cost=$ttl_cm_cost+$ttl_freight_cost+$ttl_inspection_cost+$ttl_certificate_cost+$ttl_common_oh+$ttl_currier_cost+$ttl_lab_test_cost+$ttl_depr_amor_pre_cost+$ttl_deffdlc_cost;
			//echo $ttl_conversion_cost.'='.$ttl_trims_cost.'='.$ttl_emblishment_cost.'='.$ttl_commercial_cost.'='.$ttl_commission_cost.'='.$ttl_other_cost;
			$ttl_total_cost=$total_fab_cost+$ttl_trims_cost+$ttl_emblishment_cost+$ttl_commercial_cost+$ttl_commission_cost+$ttl_other_cost;
			$costing_per_unit_budget=$ttl_total_cost/$tot_po_qty;
			if(is_infinite($costing_per_unit_budget) || is_nan($costing_per_unit_budget)){$costing_per_unit_budget=0;}

			$fab_knit_req_kg=$data_array[0][csf('fab_knit_req_kg')];
			if(is_infinite($fab_knit_req_kg) || is_nan($fab_knit_req_kg)){$fab_knit_req_kg=0;}
			$fab_knit_fin_req_kg=$data_array[0][csf('fab_knit_fin_req_kg')];
			if(is_infinite($fab_knit_fin_req_kg) || is_nan($fab_knit_fin_req_kg)){$fab_knit_fin_req_kg=0;}
			$fab_woven_req_yds=$data_array[0][csf('fab_woven_req_yds')];
			if(is_infinite($fab_woven_req_yds) || is_nan($fab_woven_req_yds)){$fab_woven_req_yds=0;}
			$fab_woven_fin_req_yds=$data_array[0][csf('fab_woven_fin_req_yds')];
			if(is_infinite($fab_woven_fin_req_yds) || is_nan($fab_woven_fin_req_yds)){$fab_woven_fin_req_yds=0;}
			$fab_yarn_req_kg=$data_array[0][csf('fab_yarn_req_kg')];
			if(is_infinite($fab_yarn_req_kg) || is_nan($fab_yarn_req_kg)){$fab_yarn_req_kg=0;}
			$exchange_rate=$data_array[0][csf('exchange_rate')];
			if(is_infinite($exchange_rate) || is_nan($exchange_rate)){$exchange_rate=0;}
			//$avg_unit_price=$data_array[0][csf('avg_unit_price')];\
			$avg_unit_price=$job_po_rate;
			if(is_infinite($avg_unit_price) || is_nan($avg_unit_price)){$avg_unit_price=0;}
			$ship_mode=$data_array[0][csf('ship_mode')];
			if(is_infinite($ship_mode) || is_nan($ship_mode)){$ship_mode=0;}
			$quotation_id=$data_array[0][csf('quotation_id')];
			if(is_infinite($quotation_id) || is_nan($quotation_id)){$quotation_id=0;}
			$costing_date=$data_array[0][csf('costing_date')];
			if(is_infinite($costing_date) || is_nan($costing_date)){$costing_date=0;}
			$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
			if(is_infinite($gsm_weights_top) || is_nan($gsm_weights_top)){$gsm_weights_top=0;}
			//$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
			//if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';

						//echo $gsm_weightTop .$gsm_weightBottom;
				?>
                	<tr>
                    	<td>Grey Fabric Cons</td>
                        <td align="right" ><b><? echo $fab_knit_req_kg; ?></b></td>
                        <td>Woven Fab. Cons	</td>
                        <td align="right" ><b><? echo $fab_woven_req_yds; ?></b></td>
                        <!-- <td>Quotation Id</td>
                        <td><b><? echo $quotation_id; ?></b></td> -->
						<td>Costing Date</td>
                        <td><b><? echo  date('d-M-y',strtotime($costing_date)); ?></b></td>
                    </tr>
                    <tr>
                        <td>Yarn Req</td>
                        <td align="right"><b><? echo $fab_yarn_req_kg; ?></b></td>
                    	<td>Woven Fin Fabric Cons</td>
                        <td align="right" ><b><? echo $fab_woven_fin_req_yds; ?></b></td>

                        <!-- <td>Exchange Rate</td>
                        <td align="right" ><b><? echo $exchange_rate; ?></b></td> -->
						<td>Avg Unit Price</td>
                        <td align="right" ><? echo fn_number_format($avg_unit_price,3); ?></td>
                    </tr>
					 <tr>
                        <td>Fin Fab. Cons </td>
                        <td align="right"><b><? echo $fab_knit_fin_req_kg; ?></b></td>
                    	<td>Incoterm</td>
                        <td><b><? echo $incoterm[$incoterm_id]; ?></b></td>

                        <td>Ship Mode</td>
                        <td><b><? echo $shipment_mode[$ship_mode]; ?></b></td>

                    </tr>
                    <tr>
                    	<td>Cost Per Unit As Budget</td>
                        <td align="right"  title="Total Cost<? echo $ttl_total_cost;?>/Total PO Qty Pcs"><? echo fn_number_format($costing_per_unit_budget,3); ?></td>
                        <td colspan="4"></td>
                    </tr>
					<!-- <tr style="background:#F9F">
						<td><b> SMV % (As 1st App) : &nbsp;<? echo $sew_smv;?></b></td>
						<td><b> Efficiency %(As 1st App) :&nbsp;<? echo $hissew_effi_percent;?> </b></td>
						<td align="right" colspan="3">Net Pft/Loss %(As 1st App)</td>
                        <td align="right" ><b><? echo $opert_profitloss_percent;?></b></td>
                    	<td title="Total Cost/Total PO Qty">Net Profit/Loss %</td>
                        <td align="right" ><b>
						<?
						$operatin_profit_loss_per=(($avg_unit_price-$costing_per_unit_budget)/$avg_unit_price)*100;
						if(is_infinite($operatin_profit_loss_per) || is_nan($operatin_profit_loss_per)){$operatin_profit_loss_per=0;}
						echo fn_number_format($operatin_profit_loss_per,2);
						 ?>
                        </b>
                        </td>
					</tr> -->
                </table>

			<?

	//$ttl_commercial_cost=$commercial_costing_arr[$job_no];
		//2 Fabric Cost part here-------------------------------------------
		$sql = "select id, job_no, item_number_id, gsm_weight, uom, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);

		$knit_fab="";$woven_fab="";
		$knit_subtotal_amount=0;
		$woven_subtotal_amount=0;$knit_subtotal_amount_dzn=0;$knit_subtotal_amount_kg=0;$woven_subtotal_amount_dzn=0;$woven_subtotal_amount_kg=$knit_subtotal_avg_cons_dzn=$knit_subtotal_avg_finish_cons_dzn=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
			    $set_item_ratio=return_field_value("set_item_ratio"," wo_po_details_mas_set_details", "job_no='".$row[csf('job_no')]."' and gmts_item_id='".$row[csf('item_number_id')]."'");

			   $fincons=0;
			   $greycons=0;
			   $order_qty_fab=0;
			   $fab_dtls_data=sql_select("select po_break_down_id,color_number_id,gmts_sizes,cons,requirment from wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id=".$row[csf("id")]." $txt_po_breack_down_id_cond2 and cons !=0");
			   foreach($fab_dtls_data as $fab_dtls_data_row )
			   {
					 $sql_po_qty_fab=sql_select("select sum(c.plan_cut_qnty) as order_quantity  from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  b.id=".$fab_dtls_data_row[csf('po_break_down_id')]." and c.item_number_id='".$row[csf('item_number_id')]."' and size_number_id='".$fab_dtls_data_row[csf('gmts_sizes')]."' and  color_number_id= '".$fab_dtls_data_row[csf('color_number_id')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
					 list($sql_po_qty_row_fab)=$sql_po_qty_fab;
	                 $po_qty_fab=$sql_po_qty_row_fab[csf('order_quantity')];
					 $order_qty_fab+=$po_qty_fab;
			   }
			$knit_cost_dzn=$row[csf("amount")];$woven_cost_dzn=$row[csf("amount")];
			if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
 				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.fn_number_format($greycons,2).'</td>
					<td align="right">'.fn_number_format($fincons,2).'</td>
                    <td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],3).'</td>
                    <td align="right">'.fn_number_format($knit_cost_dzn,4).'</td>
					<td align="right">'.fn_number_format($row[csf("amount")],2).'</td>
					<td align="right">'.fn_number_format((($knit_cost_dzn/$price_dzn)*100),2).'</td>
                </tr>';
				$knit_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
				$knit_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
            	$knit_subtotal_amount+=$row[csf("amount")];
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				$knit_subtotal_amount_kg=$knit_subtotal_amount/$knit_subtotal_amount_dzn;
			}
			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$fincons=$fabric_qty_arr['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="center">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.fn_number_format($greycons,2).'</td>
 					<td align="right">'.fn_number_format($fincons,2).'</td>
                    <td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],3).'</td>
					<td align="right">'.fn_number_format($woven_cost_dzn,4).'</td>
                    <td align="right">'.fn_number_format($row[csf("amount")],2).'</td>
					<td align="right">'.fn_number_format((($woven_cost_dzn/$price_dzn)*100),2).'</td>
                </tr>';
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
				$woven_subtotal_amount+=$row[csf("amount")];
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
				$woven_subtotal_amount_kg=$woven_subtotal_amount/$woven_subtotal_amount_dzn;
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">


					<label  style="float:left;background:#CCCCCC;font-size:larger;"><b>Fabric Cost </b> </label>

						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="50">GSM</td>
							<td width="100">Fab. Cons/ '.$costing_for.'</td>
							<td width="100">Gray Fabric Qty</td>
							<td width="100">Finish Fab Qty</td>
							<td width="50">UOM</td>
 							<td width="50">Rate</td>
							<td width="50">Amount/ '.$costing_for.'</td>
							<td width="50">TTL Amount</td>
							<td width="50">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$KnitFabricTotalParcentToOrdValue =(($knit_subtotal_amount_dzn/$price_dzn)*100);
		if(is_infinite($KnitFabricTotalParcentToOrdValue) || is_nan($KnitFabricTotalParcentToOrdValue)){$KnitFabricTotalParcentToOrdValue=0;}

		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Knit Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($KnitFabricTotalParcentToOrdValue,2).'</td>
					</tr>';
  		echo $knit_fab;
		//woven fabrics table here
		$WovenFabricTotalParcentToOrdValue=(($woven_subtotal_amount_dzn/$price_dzn)*100);
		if(is_infinite($WovenFabricTotalParcentToOrdValue) || is_nan($WovenFabricTotalParcentToOrdValue)){$WovenFabricTotalParcentToOrdValue=0;}

		$fabricTotalParcentToOrdValue=((($knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn)/$price_dzn)*100);
		if(is_infinite($fabricTotalParcentToOrdValue) || is_nan($fabricTotalParcentToOrdValue)){$fabricTotalParcentToOrdValue=0;}

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Woven Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,3).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($WovenFabricTotalParcentToOrdValue,2).'</td>
					</tr>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Fabric Total</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_dzn+$woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons+$woven_subtotal_avg_cons,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons+$woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount+$woven_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($fabricTotalParcentToOrdValue,2).'</td>
					</tr>
   					</table></div>';
      	  echo $woven_fab;
				//end 	All Fabric Cost part report-------------------------------------------
			$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
				 $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no."  and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";

		        $data_array=sql_select($sql);
				$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
				//print_r($yarn_data_array);

		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger;"><b>Yarn Cost </b> </label>
                <tr style="font-weight:bold">

                    <td width="350">Yarn Desc</td>
                    <td width="80">Yarn Qty/<?=$costing_for; ?></td>
					<td width="80">TTL Yarn Qty</td>
                    <td width="80">Rate</td>
					<td width="80">TTL Amount</td>
					<td width="">% to Ord. Value</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=$total_yarn_qty_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
 				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
				if(is_infinite($rowamount) || is_nan($rowamount)){$rowamount=0;}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($rowcons_qnty,2); ?></td>

                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
                    <td align="right"><? echo fn_number_format($rowamount,2); ?></td>
					<td align="right"><?
					$cv=($row[csf("amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_yarn_qty_dzn+=$row[csf("cons_qnty")];
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
				  if(is_infinite($total_yarn_cost_kg) || is_nan($total_yarn_cost_kg)){$total_yarn_cost_kg=0;}
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Yarn Total</td>
                    <td align="right"><? echo fn_number_format($total_yarn_qty_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_yarn_qty,2); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,2); ?></td>
					<td align="right"><?
					$cv=($total_yarn_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_yarn_cost_dzn/$price_dzn)*100,2);
					?></td>
                </tr>
        	</table>
      </div>
      <?
		//End Yarn Cost part report here -------------------------------------------

		//start	Conversion Cost to Fabric report here -------------------------------------------
		$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 group by a.cons_process order by  a.cons_process";
		$tot_data_array=sql_select($sql_count);
		foreach( $tot_data_array as $row ){
				 $process_id=$row[csf("cons_process")];
				 $process_row+=count($row[csf("cons_process")]);
		 }
		 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.uom ,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by  a.cons_process";
		 $data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label style="float:left;background:#CCCCCC; font-size:larger"><b>Cost</b> </label>
                <tr style="font-weight:bold; font-size:12px">
                    <td width="230">Particulars</td>
                    <td width="110">Process</td>
                    <td width="60">Cons/<?=$costing_for; ?></td>
					<td width="80">TTL Required</td>
					<td width="60">Uom</td>

                    <td width="60">Rate</td>
                    <td width="60">Rate(Tk)</td>
                    <td width="80">TTL Amount</td>
					<td>% to Ord. Value</td>
                </tr>
            <?
			$conv_data_qty=$conversion->getQtyArray_by_conversionid();
			$conv_data_amt=$conversion->getAmountArray_by_conversionid();

            $total_conversion_cost=$total_convsion_qty_dzn=$total_conversion_cost_dzn=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=$grand_total_conversion_cost_dzn=$grand_total_avg_convsion_qty_dzn=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
            foreach( $data_array as $row )
            {
				$convsion_qty=$conv_data_qty[$row[csf('id')]][$row[csf('uom')]];
				$conversion_cost=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];

				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0) $item_descrition = "All Fabrics";
				else
				{
					$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}

				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) )
				{
					if($k!=1)
					{
						?>
					   <tr>
							<td>&nbsp;</td>
							<td><strong>Process Total </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty_dzn,3); ?></strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty,2); ?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost,2); ?></strong></td>
							<td align="right"><?
							$cv=($total_conversion_cost_dzn/$price_dzn)*100;
							if(is_infinite($cv) || is_nan($cv)){$cv=0;}
							echo fn_number_format($cv,3);
							//echo fn_number_format(($total_conversion_cost_dzn/$price_dzn)*100,3);

							?></td>
						</tr>
						<?
					}
					?>
					<?
					unset($total_convsion_qty_dzn);unset($total_conversion_cost_dzn);
					unset($total_convsion_qty);
					unset($total_avg_convsion_qty);
					unset($total_conversion_cost);
					unset($total_convsion_qty_dzn);
					$process_array_check[]=$process_id;
					$k++;
				}
			?>
                <tr>
                    <td align="left" style="font-size:14px; word-break:break-all"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($convsion_qty,2); ?></td>
					<td align="right"><? echo  $unit_of_measurement[$row[csf('uom')]]; ?></td>

                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],3); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")]*$exchange_rate,3); ?></td>
                    <td align="right"><? echo fn_number_format($conversion_cost,2); ?></td>
					<td align="right" title="<? echo $row[csf('amount')].'='.$price_dzn;?>">
					<?
					$cv=($row[csf('amount')]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf('amount')]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
				$total_convsion_qty+=$convsion_qty;
				$total_convsion_qty_dzn+=$row[csf("req_qnty")];
				$total_avg_convsion_qty+=$row[csf("req_qnty")];
				$total_conversion_cost += $conversion_cost;
			//	$total_conversion_cost_dzn += $row[csf('amount')];
				$grand_total_conv_qnty+=$convsion_qty;
				$grand_total_avg_convsion_qty+=$convsion_qty;
				$grand_total_avg_convsion_qty_dzn+=$row[csf("req_qnty")];
				$grand_total_conversion_cost+= $conversion_cost;
				$grand_total_conversion_cost_dzn+= $row[csf('amount')];
				$total_conversion_cost_dzn+=$row[csf('amount')];
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
				if(is_infinite($total_conversion_cost_kg) || is_nan($total_conversion_cost_kg)){$total_conversion_cost_kg=0;}
				//$grand_total_avg_convsion_qty;
           	 }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Process Total</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty_dzn,3); ?></td>
				 <td align="right"><? echo fn_number_format($total_convsion_qty,2); ?></td>
				 <td align="right"><? //echo fn_number_format($total_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($total_conversion_cost,2); ?></td>
				<td align="right"><?
					$cv=($total_conversion_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
				//echo fn_number_format(($total_conversion_cost_dzn/$price_dzn)*100,2);

				?></td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Conversion Total</td>
                <td align="right"><? echo fn_number_format($grand_total_avg_convsion_qty_dzn,3); ?></td>
				<td align="right"><? echo fn_number_format($grand_total_conv_qnty,2); ?></td>
				<td align="right"><? //echo fn_number_format($grand_total_conv_qnty,4); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost,2); ?></td>
				<td align="right"  title="<? echo $grand_total_conversion_cost_dzn.'='.$price_dzn;?>">
				<?
					$cv=($grand_total_conversion_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
				//echo fn_number_format(($grand_total_conversion_cost_dzn/$price_dzn)*100,3);
				?>
                </td>
            </tr>
			  <tr class="rpt_bottom" style="font-weight:bold">
			  	<td>Cost</td>
                <td align="right" colspan="6" style="background:#F9F">Previous Fabric cost % (As 1st Approval) : <? echo fn_number_format($fabric_cost_percent,4); ?> </td>
				<td align="right"><? $all_fab_cost=$knit_subtotal_amount+$woven_subtotal_amount+$total_yarn_amount+$grand_total_conversion_cost; echo fn_number_format($all_fab_cost,2); ?></td>
				<td align="right"><?
					$total_fab_cost_dzn=$knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn+$total_yarn_cost_dzn+$grand_total_conversion_cost_dzn;
					$cv=($total_fab_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
				//echo fn_number_format(($total_fab_cost_dzn/$price_dzn)*100,2);
				?></td>
			  </tr>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -------------------------------------------



	//start	Trims Cost part report here -------------------------------------------
	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi, status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Trims Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="110">Item Group</td>
                    <td width="150">Description</td>
					<td width="100">Nominated Supp</td>
                    <td width="100">Brand/Supp Ref</td>
                    <td width="60">UOM</td>
                    <td width="80">Cons/<?=$costing_for; ?></td>
					<td width="100">TTL Required</td>
                    <td width="80">Rate</td>
                    <td width="80">Amount/<?=$costing_for; ?></td>
					<td width="80">Amount</td>
					<td width="60">% to Ord. Value</td>
                </tr>
            <?
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
            $total_trims_cost=0;  $total_trims_qty=$total_trims_cost_dzn=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
            foreach( $data_array as $row ){

				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$cons_dzn_gmts= $row[csf("cons_dzn_gmts")];
				$amount_dzn= $row[csf("amount")];
				$pre_trims_qty=$trim_qty_arr[$row[csf("id")]];
				$pre_trims_amount=$trim_amount_arr[$row[csf("id")]];

				$nominated_supp_str="";
				$exsupp=explode(",",$row[csf("nominated_supp_multi")]);
				foreach($exsupp as $sid)
				{
					if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
				}
			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><?=$nominated_supp_str; ?></td>
					<td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($cons_dzn_gmts,3); ?></td>
					<td align="right"><? echo fn_number_format($pre_trims_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					 <td align="right"><? echo fn_number_format($amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($pre_trims_amount,2); ?></td>
					<td align="right"  title="<? echo $amount_dzn.'='.$price_dzn;?>">
					<?
					$cv=($amount_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($amount_dzn/$price_dzn)*100,2);
					?></td>
                </tr>
            <?
                 $total_trims_cost += $pre_trims_amount;
				 $total_trims_cost_dzn += $amount_dzn;
				  $total_trims_qty += $pre_trims_qty;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold" >
                    <td>Trims Total</td>
					<td colspan="5" style="background:#F9F">Previous Trims cost % (As 1st Approval)=<? echo fn_number_format($trims_cost_percent,4);?></td>
					<td align="right"><? echo fn_number_format($total_trims_qty,4); ?></td>
					<td align="right"><? //echo fn_number_format($total_trims_cost_dzn,4); ?></td>

					<td align="right"><? echo fn_number_format($total_trims_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_trims_cost,2); ?></td>
					<td align="right" title="<? echo $total_trims_cost_dzn.'='.$price_dzn;?>">
					<?
					$cv=($total_trims_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_trims_cost_dzn/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------

	 //start	Embellishment Details part report here -------------------------------------------

		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Embellishment Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="170">Particulars</td>
                    <td width="170">Type</td>
                    <td width="100">Cons/<?=$costing_for; ?></td>
					<td width="120">TTL Gmts. Qty</td>
                    <td width="80">Rate</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="120">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			//echo $emblishment->getQuery(); die;
			$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();

			$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
			$cost_per_qty_arr=$condition->getCostingPerArr();


            $total_embellishment_amt=0;$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {
				$em_type ="";
				//$total_embellishment_amt_dzn += $row[csf("amount")];
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
				$cost_per_qty=$cost_per_qty_arr[$row[csf("job_no")]];
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				//$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$order_job_qnty;
				//$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$order_job_qnty;
				if($row[csf("emb_name")] !=3){
					$embl_cons_gmts=$emblishment_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				else if($row[csf("emb_name")] ==3){
					$embl_cons_gmts=$wash_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				$embl_cons_gmts=$embl_cons_gmts;//(($embl_cons_gmts*$cost_per_qty)/$tot_plan_cut_qty)*$set_ratio;//
				$row[csf("amount")]=($row[csf("amount")]/$cost_per_qty)*$set_ratio;//*$set_ratio
				if(is_infinite($row[csf("amount")]) || is_nan($row[csf("amount")])){$row[csf("amount")]=0;}

				$embl_amt=$row[csf("cons_dzn_gmts")]*$row[csf("rate")];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],3); ?></td>
					<td align="right"><? echo fn_number_format($embl_cons_gmts,0); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($embl_amt,4); ?></td>
                    <td align="right"><? echo fn_number_format($embl_amount,2); ?></td>
					<td align="right" title="<? echo $embl_amt.'='.$price_dzn;?>">
					<?
					$cv=($embl_amt/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf("amount")]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
                 $total_embellishment_amt += $embl_amount;
				 $total_embellishment_amt_dzn += $embl_amt;
				 $total_embellishment_qty += $embl_cons_gmts;
				  $total_embellishment_qty_dzn += $row[csf("cons_dzn_gmts")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Embellishment Total</td>
					<td colspan="2"  style="background:#F9F">Previous Embel.cost % (As 1st Approval)=<? echo fn_number_format($embel_cost_percent,4);?></td>
                    <td align="right"><? echo fn_number_format($total_embellishment_qty,0); ?></td>
					<td align="right"><? //echo fn_number_format($total_embellishment_qty,4); ?></td>
					<td align="right"><? echo fn_number_format($total_embellishment_amt_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_embellishment_amt,2); ?></td>
					<td align="right" title="<? echo $total_embellishment_amt_dzn.'='.$price_dzn;?>">
					<?
					$cv=($total_embellishment_amt_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_embellishment_amt_dzn/$price_dzn)*100,2);
					?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------
	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commercial Cost</b> </label>

                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>

					<td width="200">Rate In %</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				//$total_commercial_cost_dzn+= $row[csf("amount")];
				$amount = $commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
				if(is_infinite($amount) || is_nan($amount)){$amount=0;}
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
					<td align="right"><? echo fn_number_format($amount,2); ?></td>
					<td align="right"  title="<? echo $$row[csf("amount")].'='.$price_dzn;?>">
					<?
					$cv=($row[csf("amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf("amount")]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
                 $total_commercial_cost_dzn += $row[csf("amount")];
				  $total_commercial_cost += $amount;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Commercial Total</td>
					<td align="right"  style="background:#F9F">Previous Commercial % (As 1st Approval)=<?  echo fn_number_format($comm_cost_percent,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commercial_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commercial_cost,2); ?></td>
					<td align="right" title="<? echo $total_commercial_cost_dzn.'='.$price_dzn;?>">
					<?
					$cv=(($total_commercial_cost_dzn/$price_dzn)*100);
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format((($total_commercial_cost_dzn/$price_dzn)*100),2);
					?>
                    </td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------

  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commission Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>
                    <td width="250">Commission Basis</td>
                    <td width="100">Rate</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount = $commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				if(is_infinite($commission_amount) || is_nan($commission_amount)){$commission_amount=0;}
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],3); ?></td>
					 <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($commission_amount,2); ?></td>
					<td align="right" title="<? echo $row[csf("commission_amount")].'='.$price_dzn;?>">
					<?
					$cv=($row[csf("commission_amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($row[csf("commission_amount")]/$price_dzn)*100,2);
					?>
                    </td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
				// $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Commission Total</td>
					<td colspan="2"  style="background:#F9F">Previous Commission % (As 1st Approval)=<? echo fn_number_format($commission_percent,4);?></td>
					<td align="right"><? echo fn_number_format($total_commission_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commission_cost,2); ?></td>
					<td align="right"><?
 					//echo fn_number_format(($total_commission_cost_dzn/$price_dzn)*100,2);

					?></td>
                </tr>
            </table>
      </div>
		<br/>
		  <?
	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,depr_amor_pre_cost,deffdlc_cost,studio_cost,design_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,incometax_cost,interest_cost,interest_percent,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,design_percent,studio_percent,currier_pre_cost, currier_percent,certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
         <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:620px;text-align:center;" rules="all">

			<label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Others Cost</b> </label>
                <tr style="font-weight:bold">
                    <td width="220">Particulars</td>
                    <td width="100"> Cost/<?=$costing_for; ?> (As 1st Approval)</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
					<td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_other_components=0; $lab_test_dzn=0; $lab_test = 0; $inspection = 0; $cm_cost = 0; $freight = 0; $common_oh = 0; $price_dzn=0;
            /*echo '<pre>';
            print_r($other_costing_arr); die;*/
           foreach( $data_array as $row )
           {
				$job_no=$row[csf("job_no")];
				$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
				$freight_cost=$other_costing_arr[$job_no]['freight'];
				$inspection_cost=$other_costing_arr[$job_no]['inspection'];
				$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
				$common_oh=$other_costing_arr[$job_no]['common_oh'];
				$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
				$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
				$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
				$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
				$studio_cost=$other_costing_arr[$job_no]['studio_cost'];
				$design_cost=$other_costing_arr[$job_no]['design_cost'];
				$interest_cost=$other_costing_arr[$job_no]['interest_cost'];
				$incometax_cost=$other_costing_arr[$job_no]['incometax_cost'];
				$price_dzn=$row[csf("price_dzn")];
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
				$deffdlc_cost_dzn = $row[csf("deffdlc_cost")];
				$depr_amor_pre_cost_dzn = $row[csf("depr_amor_pre_cost")];
				$interest_cost_dzn=$row[csf("interest_cost")];
				$interest_cost_percent=$row[csf("interest_percent")];
				$incometax_cost_dzn=$row[csf("incometax_cost")];
				$studio_cost_dzn=$row[csf("studio_cost")];
				$design_cost_dzn=$row[csf("design_cost")];
				$studio_cost_percent=$row[csf("studio_percent")];
				$design_cost_percent=$row[csf("design_percent")];
   			?>
                <tr>
                    <td align="left">Lab Test </td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($lab_test_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($lab_test_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($lab_test_cost,2); ?></td>
					<td align="right"  title="<? echo $lab_test_dzn.'='.$price_dzn;?>">
					<?
					$cv=($lab_test_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($lab_test_dzn/$price_dzn)*100,2);

					?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($inspection_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($inspection_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($inspection_cost,2); ?></td>
					<td align="right" title="<? echo $inspection_dzn.'='.$price_dzn;?>">
					<?
					$cv=($inspection_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($inspection_dzn/$price_dzn)*100,2);
					 ?></td>
                </tr>
                <!-- <tr>
                    <td align="left">CM Cost</td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($cm_cost_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
					<td align="right"><?
					$cv=($cm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($cm_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr> -->

                 <tr>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($freight_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($freight_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($freight_cost,2); ?></td>
					<td align="right"><?
					$cv=($freight_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($freight_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($currier_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($currier_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($currier_cost,2); ?></td>
					<td align="right"><?
					$cv=($currier_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($currier_pre_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($certificate_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($certificate_pre_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($certificate_cost,2); ?></td>
					<td align="right"><?
					$cv=($certificate_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($certificate_pre_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"  style="background:#F9F"><? $deffdlc_cost_percent=0; echo fn_number_format($deffdlc_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($deffdlc_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($deffdlc_cost,2); ?></td>
					 <td align="right"><?
					$cv=($deffdlc_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
				<tr>
                    <td align="left">Studio Cost </td>
                    <td align="right"  style="background:#F9F"><? $studio_cost_percent=0; echo fn_number_format($studio_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($studio_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($studio_cost,2); ?></td>
					 <td align="right"><?
					$cv=($studio_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
				<tr>
                    <td align="left">Design  Cost </td>
                    <td align="right"  style="background:#F9F"><? $design_cost_percent=0; echo fn_number_format($design_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($design_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($design_cost,2); ?></td>
					 <td align="right"><?
					$cv=($design_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
					<td align="right"  style="background:#F9F"><? $interest_cost_percent =0; echo fn_number_format($interest_cost_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($interest_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($interest_cost,2); ?></td>
					<td align="right"><?
					$cv=($interest_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($interest_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"  style="background:#F9F"><? $incometax_cost_percent = 0; echo fn_number_format($incometax_cost_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($incometax_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($incometax_cost,2); ?></td>
					<td align="right"><?
					$cv=($incometax_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($incometax_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Operating Expensees</td>
                    <td align="right"  style="background:#F9F"><? echo fn_number_format($common_oh_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($common_oh_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($common_oh,2); ?></td>
					<td align="right"><?
					$cv=($common_oh_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($common_oh_dzn/$price_dzn)*100,2); ?></td>
                </tr>
				 <tr>
                    <td align="left">Depreciation & Amortization </td>
                    <td align="right"><? //echo fn_number_format($common_oh,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost,2); ?></td>
					<td align="right"><?
					$cv=($depr_amor_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($depr_amor_pre_cost_dzn/$price_dzn)*100,2); ?></td>
                </tr>
            <?
                 $total_other_components_dzn = $lab_test_dzn+$inspection_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn+$common_oh_dzn+$depr_amor_pre_cost_dzn+$design_cost_dzn+$studio_cost_dzn;
				   $total_other_components =$lab_test_cost+$inspection_cost+$cm_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost+$interest_cost+$incometax_cost+$common_oh+$depr_amor_pre_cost+$design_cost+$studio_cost;
				   //$cm_cost_dzn
           }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Others Total</td>
                    <td align="right"><? // echo fn_number_format($total_other_components,4); ?></td>
					<td align="right"><? echo fn_number_format($total_other_components_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_other_components,2); ?></td>
					<td align="right"><?
					$cv=($total_other_components_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_other_components_dzn/$price_dzn)*100,2); ?></td>
                </tr>
            </table>
            </td>
				   <td colspan="5"   valign="top">
				  	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:260px; margin-top:20px" rules="all">
					 <?
						// image show here  -------------------------------------------
						 $sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id=$txt_job_no and file_type=1  and rownum=1 ";
						$photo_data_array=sql_select($sql);
						$path=($path)?$path:'../../';
					 ?>
					<? foreach($photo_data_array AS $inf){ ?>
						  <tr class="rpt_bottom" style="font-weight:bold">
							<td align="center"><img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='250px' width='250px' /></td>
						 </tr>
					<?  } ?>

		 	 	</table>
				   </td>
          </tr>
		  </table>
 		<br/>
      <?
			//End Commission Cost Part report here -------------------------------------------

			//start	all summary report here -------------------------------------------
			//job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
			 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost,deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,depr_amor_pre_cost,depr_amor_po_price,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
					from wo_pre_cost_dtls
					where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			$data_array=sql_select($sql);
			$others_cost_value=0; $fabric_cost=0; $trims_cost=0; $embel_cost=0; $comm_cost=0; $commission=0; $lab_test=0; $inspection=0; $cm_cost=0; $freight=0; $currier_pre_cost=0; $certificate_pre_cost=0; $common_oh=0;
 	?>

        <div style="margin-top:15px">
		 <table>
		 <tr>
		 <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:650px;text-align:center;" rules="all">
			<caption><label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Order Profitability Summary</b> </label> </caption>
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="250">Particulars</td>
                    <td width="100">Amount/<?=$costing_for; ?></td>
                    <td width="100">TTL Amount</td>
                    <td width="100" title="(Net FOB Value DZN/ Per DZN Order Value)*100">% to Ord. Value</td>
                </tr>
            <?
			$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$cbo_company_name  and variable_list=22 and status_active=1 and is_deleted=0");
			//echo $cm_cost_method_based_on.'AAAAAAAAAA';
			if($cm_cost_method_based_on=="") $cm_cost_method_based_on=0;else $cm_cost_method_based_on=$cm_cost_method_based_on;
			if($cm_cost_method_based_on==1)
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}
			else if($cm_cost_method_based_on==2)
			{
					$based_on_date=return_field_value("min(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
					//echo $based_on_date.'GGGGGGG';
			}
			else if($cm_cost_method_based_on==3)
			{
					$based_on_date=return_field_value("max(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
			}
			else if($cm_cost_method_based_on==4)
			{
					$based_on_date=return_field_value("min(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else if($cm_cost_method_based_on==5)
			{
					$based_on_date=return_field_value("max(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}

			$based_on_date_new =change_date_format($based_on_date,'','',1);
			//echo $cm_cost_method_based_on.'='.$based_on_date_new.'fddf';

			$financial_para=array();
			$sql_std_para=sql_select("select cost_per_minute,interest_expense,income_tax,applying_period_date as from_period_date,applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and is_deleted=0  order by id desc");
			foreach($sql_std_para as $row)
			{
				$applying_period_date=change_date_format($row[csf('from_period_date')],'','',1);
				$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
				$diff=datediff('d',$applying_period_date,$applying_period_to_date);
				for($j=0;$j<$diff;$j++)
				{
					$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
					if($based_on_date_new==$newdate)
					{
						//echo $row[csf('cost_per_minute')].',';
						$financial_para[$newdate]['cost_per_minute']=$row[csf('cost_per_minute')];
						$financial_para[$newdate]['interest_expense']=$row[csf('interest_expense')];
						$financial_para[$newdate]['income_tax']=$row[csf('income_tax')];
					}
				}
			}
			//$row[csf("sew_effi_percent")]
			$cpm_budget=(($financial_para[$based_on_date_new]['cost_per_minute']/$exchange_rate)/$sew_effi_percent)*100;
			if(is_infinite($cpm_budget) || is_nan($cpm_budget)){$cpm_budget=0;}
			//	echo $based_on_date_new.'='.$financial_para[$based_on_date_new]['cost_per_minute'].'='.$exchange_rate.'='.$sew_effi_percent;
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			//$fab_production_knit=$fabric_costing_arr['knit']['grey'][$job_no];
			//$fab_production_finish=$fabric_costing_arr['finish']['grey'][$job_no];

			$fab_purchase_knit2=array_sum($fabric_costing_arr2['knit']['grey'][$job_no]);
			if(is_infinite($fab_purchase_knit2) || is_nan($fab_purchase_knit2)){$fab_purchase_knit2=0;}
			$fab_purchase_woven2=array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);
			if(is_infinite($fab_purchase_woven2) || is_nan($fab_purchase_woven2)){$fab_purchase_woven2=0;}

			$yarn_costing=$yarn_costing_arr[$job_no];
			$tot_fabric_cost=$fab_purchase_knit2+$fab_purchase_woven2;
			$conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			if(is_infinite($conversion_cost) || is_nan($conversion_cost)){$conversion_cost=0;}
			//$testing_cost=$other_costing_arr[$job_no]['lab_test'];
			$freight_cost=$other_costing_arr[$job_no]['freight'];
			if(is_infinite($freight_cost) || is_nan($freight_cost)){$freight_cost=0;}
			$inspection_cost=$other_costing_arr[$job_no]['inspection'];
			if(is_infinite($inspection_cost) || is_nan($inspection_cost)){$inspection_cost=0;}
			$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			if(is_infinite($certificate_cost) || is_nan($certificate_cost)){$certificate_cost=0;}
			$common_oh=$other_costing_arr[$job_no]['common_oh'];
			if(is_infinite($common_oh) || is_nan($common_oh)){$common_oh=0;}
			$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			if(is_infinite($currier_cost) || is_nan($currier_cost)){$currier_cost=0;}
			$cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			if(is_infinite($cm_cost) || is_nan($cm_cost)){$cm_cost=0;}
			$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			if(is_infinite($lab_test_cost) || is_nan($lab_test_cost)){$lab_test_cost=0;}
			$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			if(is_infinite($depr_amor_pre_cost) || is_nan($depr_amor_pre_cost)){$depr_amor_pre_cost=0;}
			$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			if(is_infinite($deffdlc_cost) || is_nan($deffdlc_cost)){$deffdlc_cost=0;}
			$fabric_cost=$tot_fabric_cost;
			$trims_cost=$trims_costing_arr[$job_no];
			$embel_cost=$emblishment_costing_arr[$job_no];
			$wash=$emblishment_costing_arr_wash[$job_no];
			$commercial_cost=$commercial_costing_arr[$job_no];
			$comm_cost_dzn=$row[csf("comm_cost")];
			$cm_cost_dzn=$row[csf("cm_cost")];
			$price_dzn=$row[csf("price_dzn")];
			$total_cost_dzn=$row[csf("total_cost")];
			$deffdlc_cost_dzn=$row[csf("deffdlc_cost")];
			$interest_cost_dzn=$row[csf("interest_cost")];
			$incometax_cost_dzn=$row[csf("incometax_cost")];
			$commission_dzn=$row[csf("commission")];
			$operatin_expense_dzn=$row[csf("common_oh")];
			//deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent
			$deffdlc_percent=$row[csf("deffdlc_percent")];
			$interest_percent=$row[csf("interest_percent")];
			$incometax_percent=$row[csf("incometax_percent")];
			$depr_amor_po_price=$row[csf("depr_amor_po_price")];
			$depr_amor_pre_cost_dzn=$row[csf("depr_amor_pre_cost")];
			//interest_cost,interest_percent,incometax_cost
			$tot_commission=$commission_costing_arr[$job_no];
			$lab_test=$lab_test_cost;
			$inspection=$inspection_cost;
			$cm_cost=$cm_cost;
			$freight=$freight_cost;
			$currier_pre_cost=$currier_cost;
			$certificate_pre_cost=$certificate_cost;
			$sl=$sl+1;
  			$others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
	?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Gross FOB Value/ <?=$costing_for; ?></b></td>
                 	 <td align="right"><b><? echo fn_number_format($price_dzn,4); ?></b></td>
                    <td align="right"><b><? echo fn_number_format($total_po_value,2);//$price_dzn=$tot_order_value; ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>

                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less Commission</td>
                    <td align="right"><? echo fn_number_format($commission_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($tot_commission,2); ?></td>
                    <td align="center"><? echo fn_number_format(($commission_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right"><? $net_fob_value_dzn=$price_dzn-$commission_dzn; echo fn_number_format($net_fob_value_dzn,4); ?></td>
					 <td align="right"><? $net_fob_value=$total_po_value-$tot_commission;echo fn_number_format($net_fob_value,2); ?></td>
                    <td align="center" ><?
					$cv=($net_fob_value_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($net_fob_value_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Material & Services Cost</td>
                    <td align="right"><? $total_material_services_dzn=$total_fab_cost_dzn+$total_trims_cost_dzn+$total_embellishment_amt_dzn+$lab_test_dzn+$inspection_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn;
						$total_material_services=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$lab_test_cost+$inspection_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost;

						echo fn_number_format($total_material_services_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($total_material_services,2); ?></td>
                    <td align="center"><?
					$cv=($total_material_services_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($total_material_services_dzn/$price_dzn)*100,2);//fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
				 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($comm_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($commercial_cost,2); ?></td>
                    <td align="center"><?
					$cv=($comm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($comm_cost_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/CM Value (3-4-5)</td>
                    <td align="right"><? $contributions_value_dzn=$net_fob_value_dzn-$total_material_services_dzn-$comm_cost_dzn;
							$contributions_value=$net_fob_value-$total_material_services-$commercial_cost;
							echo fn_number_format($contributions_value_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($contributions_value,2); ?></td>
                    <td align="center"><?
					$cv=($contributions_value_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($contributions_value_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: CM Cost </td>
                    <td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                    <td align="center"><?
					$cv=($cm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($cm_cost_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gross Profit(6-7)</td>
                    <td align="right"><? $gross_profit_dzn=$contributions_value_dzn-$cm_cost_dzn;
					$gross_profit_loss=$contributions_value-$cm_cost;

					echo fn_number_format($gross_profit_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($gross_profit_loss,2); ?></td>
                    <td align="center"><?
					$cv=($gross_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($gross_profit_dzn/$price_dzn)*100,2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Operating Expensees</td>
                    <td align="right"><? echo fn_number_format($operatin_expense_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($common_oh,2); ?></td>
                    <td align="center"><?
					$cv=($operatin_expense_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($operatin_expense_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Operating Profit/Loss [8-(9)]</td>
                    <td align="right">
					<?
					$operating_profit_dzn=$gross_profit_dzn-($operatin_expense_dzn);
					$operating_profit_loss=$gross_profit_loss-($common_oh);
					echo fn_number_format($operating_profit_dzn,4);
					?>
                    </td>
					<td align="right"><? echo fn_number_format($operating_profit_loss,2); ?></td>
                    <td align="center"><?
					$cv=($operating_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($operating_profit_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Depreciation & Amortization </td>
                    <td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost,2); ?></td>
                    <td align="center"><?
					$cv=($depr_amor_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($depr_amor_pre_cost_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Interest</td>
                    <td align="right"><? echo fn_number_format($interest_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                    <td align="center"><?
					$cv=($interest_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($interest_cost_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Income Tax</td>
                    <td align="right"><? echo fn_number_format($incometax_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                    <td align="center"><?
					$cv=($incometax_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($incometax_cost_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net Profit [10-(11+12+13)]</td>
                    <td align="right"><? $net_profit_dzn=$operating_profit_dzn-($depr_amor_pre_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn);
					$net_profit=$operating_profit_loss-($depr_amor_pre_cost+$interest_cost+$incometax_cost);
					echo fn_number_format($net_profit_dzn,4); ?></td>
					 <td align="center"><? echo fn_number_format($net_profit,2); ?></td>
                     <td align="center" title="Net Profit Dzn/Tot Fob Dzn*100">
					 <?
					$cv=($net_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					 //echo fn_number_format(($net_profit_dzn/$price_dzn)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"  title="Contribution Mergin(<? echo $contributions_value_dzn;?>) /12/Tot SMV(<?  echo $tot_smv;?>)">EPM (Per Pcs CM/SMV)</td>
					 <td align="right" colspan="3"><?
					 $epm_per_pcs=($contributions_value_dzn/$order_price_per_dzn)/$tot_smv;
					 if(is_infinite($epm_per_pcs) || is_nan($epm_per_pcs)){$epm_per_pcs=0;}
					 echo fn_number_format($epm_per_pcs,4); ?></td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM </td>
                    <td align="right" colspan="3" title="CPM/Exchange Rate/Efficiency %"><?  echo fn_number_format($cpm_budget,4); ?></td>
                 </tr>
            <?
            }
			$total_job_cost=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$total_other_components+$total_commercial_cost+$total_commission_cost;
            ?>
            </table>
			</td>
			<td valign="top">
			 <div style="margin-top:0px;">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1"style="width:320px;text-align:center;" rules="all">
				<label><b>Cost Summary on Total Order Qty</b></label>
					<tr style="font-weight:bold">
						<td width="130">Particulars</td>
						<td width="80">Amount (USD)</td>
						<td width="80">%</td>
					</tr>
					<tr>
						<td align="left">Total Order Value </td>
						<td align="right"><?
						 echo fn_number_format($total_po_value,2); ?></td>
						<td align="center"><?
						$cv=$total_po_value/$total_po_value*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format($total_po_value/$total_po_value*100,2); ?></td>
					</tr>
					 <tr>
						<td align="left">Total Cost </td>
						<td align="right" title="Total Trims+Total All Fabric Cost+Emblish+Other+Commercail+Commission "><?  //$total_cost = $total_job_cost;//$all_total_cost;
						echo fn_number_format($total_job_cost,2);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
						<td align="center"><?
						$cv=$total_job_cost/$total_po_value*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format($total_job_cost/$total_po_value*100,2); ?></td>
					</tr>
					 <tr>
						<td align="left">Total Margin </td>
						<td align="right" title="Total Order Value-Total Cost"><? $total_margin_val = $total_po_value-$total_job_cost; echo fn_number_format($total_margin_val,2); ?></td>
						<td align="center"><?
						$cv=($total_margin_val/$total_po_value*100);
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format(($total_margin_val/$total_po_value*100),2); ?></td>
					</tr>
					 <tr>
						<td align="left">Margin /<?=$costing_for; ?> </td>
						<td align="right" title="Tot Margin/PO Qty*12"><?
							$ord_val_dzn_per=($job_po_rate_set*12);

						 $margin_dzn=($total_margin_val/$total_po_qty)*12;
						 if(is_infinite($margin_dzn) || is_nan($margin_dzn)){$margin_dzn=0;}
						 echo fn_number_format($margin_dzn,4); ?></td>
						<td align="center" title="<? echo $ord_val_dzn_per.'=Unit Rate*12'; ?>">
						<?
						$cv=($margin_dzn/$ord_val_dzn_per)*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format(($margin_dzn/$ord_val_dzn_per)*100,2);

						  $margin_pcs=$margin_dzn/12;
						  if(is_infinite($margin_pcs) || is_nan($margin_pcs)){$margin_pcs=0;}
						 ?></td>
					</tr>
					<tr>
						<td align="left">Margin /Pcs </td>
						<td align="right" title="Margin Pcs=<? echo $margin_dzn/12;?>"><? echo fn_number_format($margin_pcs,4); ?></td>
						<td align="center" title="Rate=<? echo $job_po_rate;?>"><?
						$cv=($margin_pcs/$job_po_rate_set)*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2);
						//echo fn_number_format(($margin_pcs/$job_po_rate_set)*100,2); ?></td>
					</tr>
          		 </table>
				 </div>
			</td>
			</tr>
		</table>
      </div>
     <br/>
     <?  echo signature_table(109, $cbo_company_name, "970px");?>
     </div>
	 <?
	 disconnect($con);
	 exit();
}



if($action=="budgetsheet") // Zakaria joy(Norban)
{  
	if(isset($_GET['action']))
	{
		
		$version=str_replace("'","",$_GET['version']);
	}
	
	else{
		$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));}
	//$version=str_replace("'","",$_GET['version']);
	//print_r($version);

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	//if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';  $txt_po_breack_down_id_cond1='';  $txt_po_breack_down_id_cond2='';  $txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond4=" and a.id in(".$txt_po_breack_down_id.")";
	}

	//array for display name
	$user_library=return_library_array( "select id, user_name from user_passwd", "id", "user_name"  );
	$team_leader_arr=return_library_array( "select id,team_leader_name from lib_marketing_team",'id','team_leader_name');
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$sesson_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
	$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand",'id','brand_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$fabric_composition_arr=return_library_array( "select id, fabric_composition_name from lib_fabric_composition",'id','fabric_composition_name');
	$photo_data_array = sql_select("SELECT id,master_tble_id,image_location from common_photo_library where master_tble_id=$txt_job_no and file_type=1  and rownum=1");

	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and b.status_active=1 and b.is_deleted=0 and a.body_part_type in(1,20)","gsm_weight");
	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
		$set_item_ratio += $val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0) ///fab_knit_fin_req_kg,fab_knit_req_kg
	{
	   $sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.total_set_qnty,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty ,   c.costing_per,c.budget_minute,c.costing_date,c.approved,c.exchange_rate ,a.quotation_id,c.incoterm,c.sew_effi_percent,group_concat(b.sc_lc) as sc_lc, d.fab_knit_req_kg,d.fab_knit_fin_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute,c.incoterm,c.sew_effi_percent, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	else if($db_type==2)
	{
		$sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.ship_mode,a.total_set_qnty,a.style_ref_no,a.team_leader,a.inserted_by, a.gmts_item_id,a.order_uom, a.avg_unit_price, a.product_dept, a.season_buyer_wise, a.brand_id, a.style_description, a.job_quantity as job_qty, sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, listagg(cast(b.sc_lc as varchar2(4000)),',') within group (order by b.sc_lc) as sc_lc, c.costing_per,c.costing_date,c.budget_minute,c.approved,a.quotation_id,c.exchange_rate ,c.incoterm,c.sew_effi_percent, c.remarks,c.sew_smv, c.refusing_cause, d.fab_knit_fin_req_kg, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
		from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
		where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.team_leader,a.inserted_by, a.gmts_item_id,a.order_uom,a.ship_mode, a.avg_unit_price, a.product_dept, c.incoterm,c.costing_date,c.exchange_rate ,a.quotation_id,c.costing_per,c.sew_effi_percent,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,a.job_quantity,a.season_buyer_wise, a.brand_id, a.total_set_qnty,a.style_description, c.remarks, c.refusing_cause,c.sew_smv  order by a.job_no"; //a.job_quantity as job_quantity,
	}
	   //echo $sql; die;
	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	$total_set_qnty=$data_array[0][csf('total_set_qnty')];
	$exchange_rate=$data_array[0][csf('exchange_rate')];
	$is_approved=$data_array[0][csf('approved')];
	$inserted_by=$user_library[$data_array[0][csf('inserted_by')]];

	$preCost_histry=sql_select( "SELECT min(a.sew_smv) as sew_smv,min(a.sew_effi_percent) as sew_effi_percent,min(b.margin_dzn_percent) as margin_dzn_percent ,min(b.fabric_cost_percent) as  fabric_cost_percent,min(b.trims_cost_percent ) as trims_cost_percent,min(b.embel_cost_percent) as embel_cost_percent,min(b.wash_cost_percent) as wash_cost_percent ,min(b.comm_cost_percent) as comm_cost_percent ,min(b.commission_percent) as commission_percent,min(b.lab_test_percent) as lab_test_percent,min(b.inspection_percent) as inspection_percent,min(b.cm_cost_percent) as cm_cost_percent,min(b.freight_percent) as freight_percent,min(b.currier_percent) as currier_percent,min(b.certificate_percent) as certificate_percent,min(b.common_oh_percent) as common_oh_percent    from  wo_pre_cost_mst_histry a,wo_pre_cost_dtls_histry b where a.job_no=b.job_no and a.job_no=$txt_job_no");
	 

	list($preCost_histry_row)=$preCost_histry;
	$opert_profitloss_percent=$preCost_histry_row[csf('margin_dzn_percent')];
	$fabric_cost_percent=$preCost_histry_row[csf('fabric_cost_percent')];
	$trims_cost_percent=$preCost_histry_row[csf('trims_cost_percent')];
	$embel_cost_percent=$preCost_histry_row[csf('embel_cost_percent')];
	$wash_cost_percent=$preCost_histry_row[csf('wash_cost_percent')];
	$comm_cost_percent=$preCost_histry_row[csf('comm_cost_percent')];
	$commission_percent=$preCost_histry_row[csf('commission_percent')];
	$common_oh_percent=$preCost_histry_row[csf('common_oh_percent')];

	$lab_test_percent=$preCost_histry_row[csf('lab_test_percent')];
	$inspection_percent=$preCost_histry_row[csf('inspection_percent')];
	$cm_cost_percent=$preCost_histry_row[csf('cm_cost_percent')];
	$freight_percent=$preCost_histry_row[csf('freight_percent')];
	$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$certificate_percent=$preCost_histry_row[csf('certificate_percent')];
	//$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$sew_effi_percent=$data_array[0][csf('sew_effi_percent')];//
	$hissew_effi_percent=$preCost_histry_row[csf('sew_effi_percent')];
	//$sew_smv=$preCost_histry_row[csf('sew_smv')];
	$first_app_date="";
	$last_app_date="";
	$revised_no=0;
	$preCost_approved=sql_select( "SELECT max(b.approved_no) as approved_no, min(b.approved_date) as first_app_date, max(b.approved_date) as last_app_date,a.id from wo_pre_cost_mst a, approval_history b where   a.id=b.mst_id and a.job_no=$txt_job_no and b.entry_form=15 group by a.id");
	if(count($preCost_approved)>0)
	{
		foreach($preCost_approved as $preCost_approved_row)
		{
			$approved_no_row=$preCost_approved_row[csf('approved_no')];
			$fst_date=$preCost_approved_row[csf('first_app_date')];
			$fstapp_date=$fst_date[0];


			$last_date=$preCost_approved_row[csf('last_app_date')];
			$lstapp_date=$last_date[0];
			if($last_date!="") $last_date=date('d-M-y',strtotime($preCost_approved_row[csf('last_app_date')])); else $last_date="";
			$precost_id=$preCost_approved_row[csf('id')];
			//if($approved_no_row>1){
				$revised_no=$approved_no_row-1;
			//}
		}
	}

	//$img_path = (str_replace("'", "", $img_path))? str_replace("'", "", $img_path):'../../';
	$img_path = (str_replace("'", "", $path))? str_replace("'", "", $path):'../';

	//echo $img_path;
	$condition= new condition();

	   if($version != ""){
					$condition->approved_no("=$version");
					$condition->approval_from("=15");
					$version_no =" $version ";
		}
      else{
		$version_no=$approved_no_row;
	  }

	

	$costing_date=$data_array[0][csf('costing_date')];
	if(is_infinite($costing_date) || is_nan($costing_date)){$costing_date=0;}

	$pre_cost_dtls = "SELECT id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";

	$pre_cost_dtls_arr=sql_select($pre_cost_dtls);
	foreach ($pre_cost_dtls_arr as $row) {
		$total_cost = $row[csf("total_cost")];
		$price_dzn = $row[csf("price_dzn")];
		$embel_cost_dzn=$row[csf("embel_cost")];
	}
	$approval_allow=sql_select("SELECT b.id, b.page_id, b.approval_need, b.allow_partial, b.validate_page,a.setup_date from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and a.status_active=1 and b.page_id=25 and b.status_active=1 and b.is_deleted=0 order by b.id desc ");
	?>
    <div style="width:972px; margin:0 auto; font-family: 'Arial Narrow', Arial, sans-serif;">

    	<div style="width:970px; font-size:20px; font-weight:bold">

    	<b style="float: left"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?><br>Budget Sheet</b>
    	<? if( $is_approved==1){ ?> <b style="left: 50%; margin-left: 240px; color: green;"> This Budget is Approved  </b> <? }elseif( $is_approved==3){
				if($approval_allow[0][csf("approval_need")]==1 && $approval_allow[0][csf("allow_partial")]==1){
					$ap_msg="<b style='left: 50%; margin-left: 240px; color: green;'>This Budget is Approved </b>";
				}else{
					$ap_msg="<b style='left: 50%; margin-left: 240px; color: green;'>This Budget is Partially Approved </b>";
				}
				echo $ap_msg;
		} else{ ?><b style="left: 50%; margin-left: 240px; color: red;">
 				This Budget is Not Approved

		</b> <? } ?></br>
		
		
    	<b style="float:right;"> <?='Budget Date: ';?><?=date('d-M-y',strtotime($costing_date)); ?> <br><?=' Revised No:'.$version_no; ?><br><?='Last Revised Date:'.$last_date; ?>  </b>
		
    	</div>

    	<div style="width:970px; font-size:18px; font-weight:bold">
    	<b style="float: left"></b>
    	<b style="float:right; font-size:18px; font-weight:bold">   &nbsp;  </b> </div>

	<?
	$sql_booking_data=sql_select("select a.booking_no_prefix_num,a.is_short,a.booking_type from  wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and a.booking_no=b.booking_no  and a.job_no=".$txt_job_no." and b.fin_fab_qnty>0 and a.is_deleted=0 and  a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.booking_no_prefix_num,a.is_short,a.booking_type order by a.booking_no_prefix_num ASC");
	foreach($sql_booking_data as $row)
	{
		$is_short=$row[csf('is_short')];
		if($is_short==1){$short_booking_no.=$row[csf('booking_no_prefix_num')].',';}
		else if($is_short==2){$main_booking_no.=$row[csf('booking_no_prefix_num')].',';}
	}
	$result =sql_select("SELECT a.id,a.po_number,a.pub_shipment_date,a.file_no,b.excess_cut_perc as excess_cut, a.grouping, a.po_received_date, sum(b.plan_cut_qnty)as plan_cut, sum(b.order_quantity) as total_order from wo_po_break_down a join wo_po_color_size_breakdown b on a.id=b.po_break_down_id where a.job_no_mst=$txt_job_no $txt_po_breack_down_id_cond4 and a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 group by a.id,a.po_number,a.pub_shipment_date,a.file_no,b.excess_cut_perc, a.grouping, a.po_received_date order by a.po_received_date desc");

	
	$job_in_orders = '';$public_ship_date='';$job_in_ref = '';$job_in_file = '';
	$tot_excess_cut=0;
	foreach ($result as $val)
	{
		$job_in_orders .= $val[csf('po_number')].", ";
		$public_ship_date = $val[csf('pub_shipment_date')];
		$po_received_date = $val[csf('po_received_date')];
		$txt_order_no_arr[$val[csf('id')]] = $val[csf('id')];
		$tot_excess_cut+= $val[csf('excess_cut')];
		$plancutqty +=$val[csf('plan_cut')];
		$total_order +=$val[csf('total_order')];
	}
	 
	$txt_order_no_id=implode(",", $txt_order_no_arr);
	$job_no=str_replace("'","",$txt_job_no);
	
		if(str_replace("'","",$txt_job_no) !=''){
			  $condition->job_no("=$txt_job_no");
		 }

		  if(str_replace("'","",$txt_po_breack_down_id)!='')
		 {
			$condition->po_id("in($txt_order_no_id)");
		 }
		$condition->init();
		//echo $version;

		if($version != ""){
			
       	 $fabric= new fabric($condition,0,2);
			
	   	  $yarn= new yarn($condition,0,2);
			 //echo $yarn->getQuery(); die;
		  $conversion= new conversion($condition,0,2);	
		//  echo $conversion->getQuery(); die; 
		    $trims= new trims($condition,0,2);
			//echo $trims->getQuery(); die; 
		   $emblishment= new emblishment($condition,0,2);
		    $wash= new wash($condition,0,2);
		   $commercial= new commercial($condition,0,2);
		 $commission= new commision($condition,0,2);
		   $other= new other($condition,0,2);
		//echo $other->getQuery(); die;
		   $yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
		$yarn_qty_amount_arr=$yarn->getJobWiseYarnQtyAndAmountArray();
		$yarnDataWithFabricidArr=$yarn->get_By_Precostfabricdtlsid_YarnQtyAmountArray();
		$fabricAmoutByFabricSource= $fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
		$fabricQtyByFabricSource= $fabric->getQtyArray_by_job_knitAndwoven_greyAndfinish_purchase();
		$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		
		$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
		$conv_qty_job_process= $conversion->getQtyArray_by_jobAndProcess();
		$conv_amount_job_process= $conversion->getAmountArray_by_jobAndProcess();
		$con_qty_fabric_process = $conversion->getQtyArray_by_fabricAndProcess();
		$con_amount_fabric_process = $conversion->getAmountArray_by_fabricAndProcess();
		$trims_costing_arr=$trims->getAmountArray_by_job();
		$trims_qty_arr=$trims->getQtyArray_by_job();
		$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
		$emb_qty_job_name_arr = $emblishment->getQtyArray_by_jobAndEmbname();
		$emb_amount_job_name_arr = $emblishment->getAmountArray_by_jobAndEmbname();
		  /*  echo '<pre>';
		print_r($fabric_amount_arr); die;  */
		$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		$wash_qty_job_name_arr =$wash->getQtyArray_by_jobAndEmbname();
		$wash_amount_job_name_arr =$wash->getAmountArray_by_jobAndEmbname();
		$commercial_costing_arr=$commercial->getAmountArray_by_job();
		$commission_costing_arr=$commission->getAmountArray_by_job();
		$other_costing_arr=$other->getAmountArray_by_job();
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();	
		$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
	    $trim_amount_arr=$trims->getAmountArray_precostdtlsid(); 

		// echo '<pre>';
		// print_r($trim_amount_arr); die;

		}
		
		else{
			
        $fabric= new fabric($condition);
	   	$yarn= new yarn($condition);
		$conversion= new conversion($condition);
		$trims= new trims($condition);
		$emblishment= new emblishment($condition);
		$wash= new wash($condition);
		$commercial= new commercial($condition);
		$commission= new commision($condition);
		$other= new other($condition);	
		$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
		$yarn_qty_amount_arr=$yarn->getJobWiseYarnQtyAndAmountArray();
		$yarnDataWithFabricidArr=$yarn->get_By_Precostfabricdtlsid_YarnQtyAmountArray();
		$fabricAmoutByFabricSource= $fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
		$fabricQtyByFabricSource= $fabric->getQtyArray_by_job_knitAndwoven_greyAndfinish_purchase();
		$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		
		/*  echo '<pre>';
		print_r($fabric_amount_arr); die;  */
		
		//echo $conversion->getQuery(); die;
		$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
		$conv_qty_job_process= $conversion->getQtyArray_by_jobAndProcess();
		$conv_amount_job_process= $conversion->getAmountArray_by_jobAndProcess();
		$con_qty_fabric_process = $conversion->getQtyArray_by_fabricAndProcess();
		$con_amount_fabric_process = $conversion->getAmountArray_by_fabricAndProcess();
		$trims_costing_arr=$trims->getAmountArray_by_job();
		$trims_qty_arr=$trims->getQtyArray_by_job();
		$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
		$emb_qty_job_name_arr = $emblishment->getQtyArray_by_jobAndEmbname();
		$emb_amount_job_name_arr = $emblishment->getAmountArray_by_jobAndEmbname();
		  /*  echo '<pre>';
		print_r($fabric_amount_arr); die;  */
		$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		$wash_qty_job_name_arr =$wash->getQtyArray_by_jobAndEmbname();
		$wash_amount_job_name_arr =$wash->getAmountArray_by_jobAndEmbname();
		$commercial_costing_arr=$commercial->getAmountArray_by_job();
		$commission_costing_arr=$commission->getAmountArray_by_job();
		$other_costing_arr=$other->getAmountArray_by_job(); 
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
		$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
		
	    
		}
		//print_r($yarn_data_array);
		

		$finishing_arr = array(
			'2','3','4','25','26','32','33','34','36','37','38','39','40','60','61','62','63','64','65','66','67','68','69','70','71','72','73','74','75','76','77','78','79','80','81','82','83','84','85','86','87','88','89','90','91','92','93','94','100','101','120','121','122','123','124','125','127','128','129','130','131','132','133','134','135','136','137','138','139','140','141','142','143','144','145','146','147','148','149','150','151','152','153','154','155','156','157','158','159','160','161','162','163','164','165','166','167','168','169','170','171','172','173','174','175','176','177','178','179','180','181','182','183','184','185','186','187','188','189','190','191','192','193','194','195','196','197','198','199','200','201','202','203','204','205','206','207','208','209','210','211','212','213','214','215','216','217','218','219','220','221','222','223','224','225','226','227','228','229','230','231','232','233','234','235','236','237','238','239','240','241','242','243','244','245','246','247','248','249','250','251','252','253','254','255','256','257','258','259','260','261','262','263','264','265','266','267','268','269','270','271','272','273','274','275','276','277','278','279','280','281','282','283','284','285','286','287','288','289','290','291','292','293','294','295','296','297','298','299','300','303','304','305','306','307','308','309','310','311','312','313','314','315','316','317','318','319','320','321','322','323','324','325','326','327','328','329','330','331','332','333','334','335','336','337','338','339','340','341','342','343','344','345','346','347','348','349','350','351','352','353','354','355','356','357','358','359','360','361','362','363','364','365','366','367','368','369','370','371','372','373','374','375','376','377','378','379','380','381','382','383','384','385','386','387','388','389','390','391','392','393','394','395','396','397','398','399','400','401','402','403','404','405','406','407','408','409','410','411'
		);
		$other_cost_attr = array('inspection','freight','certificate_pre_cost','deffdlc_cost','design_cost','studio_cost','common_oh','interest_cost','incometax_cost','depr_amor_pre_cost');
		$total_other_cost = 0;
		foreach ($other_cost_attr as $attr) {
			$total_other_cost+=$other_costing_arr[$job_no][$attr];
		}
		$sql_conv_dataArr=sql_select("select a.fabric_description,a.cons_process from  wo_pre_cost_fab_conv_cost_dtls a where  a.job_no=".$txt_job_no."  and a.is_deleted=0 and  a.status_active=1  ");
		foreach($sql_conv_dataArr as $row)
		{
			$fabric_description=$row[csf('fabric_description')];
			$cons_processArr[$row[csf('cons_process')]].=$fabric_description.',';
		}

	foreach ($data_array as $row)
	{
		  //echo $row[csf("job_no")].'DDDDDDD';
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$uom=$row[csf("order_uom")];
		$sew_smv=$row[csf("sew_smv")];
		$order_qnty = $row[csf("job_qty")];
		$order_values = $row[csf("job_qty")]*$row[csf("avg_unit_price")];
		$order_value = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];

		$job_in_orders = substr(trim($job_in_orders),0,-1);
		if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for="1 DZN";}
		else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for="1 PCS";}
		else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for="2 DZN";}
		else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for="3 DZN";}
		else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for="4 DZN";}
		else {$order_price_per_dzn=0; $costing_for="DZN";}
		$order_job_qnty=$row[csf("job_qty")];
		//$order_qty = $row[csf("job_qty")]*$set_item_ratio;
		$po_no=str_replace("'","",$txt_po_breack_down_id);
		
		/* echo '<pre>';
		print_r($con_amount_fabric_process); die; */
		$job_no= str_replace("'","",$txt_job_no);
		// $finishing_arr = array('209','165','33','94','63','171','65','170','156','179','200','208','127','125','84','68','128','190','242','240','192','172','90','218','67','197','73','66','185','142','193','265');


		$total_finishing_amount=0;
		$total_finishing_qty=0;
	
		$misc_cost=$other_costing_arr[$job_no]['lab_test']+$other_costing_arr[$job_no]['currier_pre_cost']+$commercial_costing_arr[$job_no]+$commission_costing_arr[$job_no]+$total_other_cost;
 //getQtyArray_by_fabricAndProcess

		foreach ($finishing_arr as $fid) {

			$fab_ids=rtrim($cons_processArr[$fid],',');
			//if($fab_ids!="") echo $fab_ids.'<br>';
			$fab_idsArr=array_unique(explode(",",$fab_ids));
		//	$fab_idsArr[$fab_ids]=$fab_ids;
			//$process_fab_idsArr[$fid]=$fid;
			$total_finishing_amount += array_sum($conv_amount_job_process[$job_no][$fid]);
			//$total_finishing_qty += array_sum($conv_qty_job_process[$job_no][$fid]);
			if($fab_ids)
			{
				foreach($fab_idsArr as $fabid)
				{
					if($fab_process_chk[$fabid]=="")
					{
						//echo  $fid.'='.$fabid.'='.array_sum($con_qty_fabric_process[$fabid][$fid]).'<br>';
						$total_finishing_qty += array_sum($con_qty_fabric_process[$fabid][$fid]);
						$fab_process_chk[$fabid]=$fabid;
					}
				}
			}
			//echo array_sum($conv_amount_job_process[$job_no][$fid]).'='.$fid.'<br>';
		}
		//print_r($process_fab_idsArr);
		
		$total_fabic_cost=0;
		if(count($conv_amount_job_process[$job_no][31])>0){
			$total_fabic_cost+=array_sum($conv_amount_job_process[$job_no][31])/array_sum($conv_qty_job_process[$job_no][31]);
		}
		 $total_fabric_amount +=array_sum($conv_amount_job_process[$job_no][31]);
		$total_fabric_per +=array_sum($conv_amount_job_process[$job_no][31])/$order_values*100;
		if(count($conv_amount_job_process[$job_no][30])>0){
			$total_fabic_cost+=array_sum($conv_amount_job_process[$job_no][30])/array_sum($conv_qty_job_process[$job_no][30]);
		}
		
		if($yarn_qty_amount_arr[$job_no]['amount']!=''){
			$total_fabic_cost+=$yarn_qty_amount_arr[$job_no]['amount']/$yarn_qty_amount_arr[$job_no]['qty'];
		}
		 $total_fabric_amount +=$yarn_qty_amount_arr[$job_no]['amount'];
		$total_fabric_per +=$yarn_qty_amount_arr[$job_no]['amount']/$order_values*100;
		if($total_finishing_amount!=0){
			$total_fabic_cost+=$total_finishing_amount/$total_finishing_qty;
		}
		 $total_fabric_amount +=$total_finishing_amount;
		$total_fabric_per +=$total_finishing_amount/$order_values*100;
		$total_fabric_amount +=array_sum($conv_amount_job_process[$job_no][30]);
		$total_fabric_per +=array_sum($conv_amount_job_process[$job_no][30])/$order_values*100;
		if(count($conv_amount_job_process[$job_no][35])>0){
			$total_fabic_cost+=array_sum($conv_amount_job_process[$job_no][35])/array_sum($conv_qty_job_process[$job_no][35]);
		}
		$total_fabric_amount +=array_sum($conv_amount_job_process[$job_no][35]);
		$total_fabric_per +=array_sum($conv_amount_job_process[$job_no][35])/$order_values*100;
		if(count($conv_amount_job_process[$job_no][1])>0){
			$total_fabic_cost+=array_sum($conv_amount_job_process[$job_no][1])/array_sum($conv_qty_job_process[$job_no][1]);
		}
		 $total_fabric_amount +=array_sum($conv_amount_job_process[$job_no][1]);
		$total_fabric_per +=array_sum($conv_amount_job_process[$job_no][1])/$order_values*100;

		$purchase_amount = array_sum($fabricAmoutByFabricSource['knit']['grey'][$job_no])+array_sum($fabricAmoutByFabricSource['woven']['grey'][$job_no]);
		$purchase_qty = array_sum($fabricQtyByFabricSource['knit']['grey'][$job_no])+array_sum($fabricQtyByFabricSource['woven']['grey'][$job_no]);

		$ather_emb_attr = array(4,5,6,99);
		foreach ($ather_emb_attr as $att) {
			$others_emb_amount += $emb_amount_job_name_arr[$job_no][$att];
			$others_emb_qty += $emb_qty_job_name_arr[$job_no][$att];
		}
		$knitting_amount_summ=''; $dyeing_amount_summ=''; $yds_amount_summ=''; $aop_amount_summ='';

		$yarn_amount_summ = $yarn_qty_amount_arr[$job_no]['amount'];
		$print_amount_summ = $emb_amount_job_name_arr[$job_no][1];
		$emb_amount_summ= $emb_amount_job_name_arr[$job_no][2];
		$wash_amount_summ = $wash_amount_job_name_arr[$job_no][3];
		if(count($conv_amount_job_process[$job_no][1])>0) {
			$knitting_amount_summ = array_sum($conv_amount_job_process[$job_no][1]);
		}
		if(count($conv_amount_job_process[$job_no][31])>0) {
			$dyeing_amount_summ=  array_sum($conv_amount_job_process[$job_no][31]);
		}
		if(count($conv_amount_job_process[$job_no][30])>0) {
			//echo $job_no
			$yds_amount_summ = array_sum($conv_amount_job_process[$job_no][30]);
		}
		if(count($conv_amount_job_process[$job_no][35])>0) {
			$aop_amount_summ = array_sum($conv_amount_job_process[$job_no][35]);
		}
		
		//   echo '<pre>';
		// print_r($conv_amount_job_process); die;

     

		$total_budget_value = $yarn_amount_summ+$total_finishing_amount+$print_amount_summ+$trims_costing_arr[$job_no]+$yds_amount_summ+$aop_amount_summ+$emb_amount_summ+$knitting_amount_summ+$purchase_amount+$wash_amount_summ+$other_costing_arr[$job_no]['cm_cost']+$dyeing_amount_summ+$others_emb_amount+$misc_cost;
		/* 	echo $total_budget_value. "=" .$yarn_amount_summ."+".$total_finishing_amount."+".$print_amount_summ."+".$trims_costing_arr[$job_no]."+".$yds_amount_summ."+".$aop_amount_summ."+".$emb_amount_summ."+".$knitting_amount_summ."+".$purchase_amount."+".$wash_amount_summ."+".$other_costing_arr[$job_no]['cm_cost']."+".$dyeing_amount_summ."+".$others_emb_amount."+".$misc_cost;die; */

		?>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px; font-family: 'Arial Narrow', Arial, sans-serif;" rules="all">

        	<tr>
            	<th rowspan="7">
            	<? foreach($photo_data_array AS $inf){ ?>
					<?
					$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
					?>

            	<img  src='<?=$img_path?><? echo $inf[csf("image_location")]; ?>' height='100px' width='100px' />
            	<? } ?>
            	</th>
            	<th style="background: #D7ECD9">Job No</th>
                <th><? echo $row[csf("job_no")]; ?></th>
                <th style="background: #D7ECD9">OR. Rcv Date</th>
                <th><? echo  date('d-M-y',strtotime($po_received_date)); ?></th>
                <th style="background: #D7ECD9">Order Quantity</th>
                <th style="background: yellow; color: #8B0000;">Price/<?=$unit_of_measurement[$row[csf("order_uom")]];?></th>
                <th align="right" style="background: yellow; color: #8B0000;">&#36; <? echo $row[csf("avg_unit_price")]; ?> </th>
            </tr>
            <tr>
                <th style="background: #D7ECD9">Buyer</th>
                <th><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></th> 
                <th style="background: #D7ECD9">Ship. Date</th>
                <th><? echo  date('d-M-y',strtotime($public_ship_date)); ?></th>
            	<th align="center" style="color: #8B0000"><? echo $row[csf("job_qty")];?> <?  echo $unit_of_measurement[$row[csf("order_uom")]]; ?></th>
                <th style="background: yellow; color: #8B0000;">Order Value</th>
                <th align="right" style="background: yellow; color: #8B0000;">&#36; <?= number_format($order_values,2);  ?></th>
            </tr>
            <tr>
            	<th style="background: #D7ECD9">Prod. Dept</th>
                <th><? echo $product_dept[$row[csf("product_dept")]]; ?></th>
                <th style="background: #D7ECD9">Garments Item</th>
            	<th>
            	<?
					$grmnt_items = "";
					if($garments_item[$row[csf("gmts_item_id")]]=="")
					{

						$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
						foreach($grmts_sql as $key=>$val){
							$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
							$gmts_item[]=$val[csf("gmts_item_id")];

						}
						$grmnt_items = substr_replace($grmnt_items,"",-1,1);
					}else{
						$gmts_item=explode(',',$row[csf("gmts_item_id")]);
						$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
					}
					echo $grmnt_items;
				?>
				</th>
            	<th align="center" style="color: #8B0000"><?= $row[csf("job_qty")]*$set_item_ratio.' Pcs' ?></th>
                <th style="background: yellow; color: #8B0000;"> <? if($zero_value==0) echo "Budget Value"; ?></th>
                <th align="right" style="background: yellow; color: #8B0000;"><? if($zero_value==0){ ?>
                <? if($total_budget_value>0){ echo '&dollar;'.fn_number_format($total_budget_value,2); } ?><br/>
                <? if($total_budget_value>0){ echo fn_number_format($total_budget_value/$order_values*100,2).'%'; } ?>
                <? } ?>
                </th>
            </tr>
            <tr>
            	<th style="background: #D7ECD9">Season / Brand</th>
                <th><? echo $sesson_arr[$row[csf("season_buyer_wise")]].'&nbsp'.$brand_arr[$row[csf("brand_id")]]; ?></th>
                <th>Costing Per: <br/><?= $costing_for;  ?></th>
                <th style="background: #D7ECD9" title="{(Total plan Cut Qty-Total Order Qty)/Total Order Qty}*100">Plan Cut quantity (<?
					$plan_cut_dif=$plancutqty-$total_order;
					$tot_excess_cut=($plan_cut_dif/$total_order)*100;
				echo fn_number_format($tot_excess_cut,4).'%' ?>) </td>
            	<th align="center" style="color: #8B0000"><?= $row[csf("job_quantity")]*$total_set_qnty.' Pcs';//." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></th>
                <th rowspan="2" style="background: yellow; color: #8B0000;"><? if($zero_value==0) echo "Open Value %"; ?></th>
                <th rowspan="2" align="right" style="background: yellow; color: #8B0000;"><? if($zero_value==0) { ?> &#36;<?
                	$margin_val = $order_values-$total_budget_value;
                	echo fn_number_format($margin_val,2).'<br>'.fn_number_format($margin_val/$order_values*100,2).'%';
                	}
                 ?></th>
            </tr>
            <tr>
            	<th style="background: #D7ECD9">Style No</th>
                <th><? $style_no= $row[csf("style_ref_no")]; echo $row[csf("style_ref_no")]; ?></th>
                <th style="background: #D7ECD9">App. Status</th>
                <th colspan="2"><? if( $row[csf("approved")]==1){echo "This Budget is Approved ";} elseif ($row[csf("approved")]==3) {
                	echo "This Budget is partial Approved";
                } else {echo "This Budget is Not  Approved";} ?></th>
            </tr>
            <tr>
            	<th rowspan="2" style="background: #D7ECD9">Style Description</th>
                <th rowspan="2" colspan="2"><? echo $row[csf("style_description")]; ?></th>
                <th style="background: #D7ECD9">Remarks</th>
                <th colspan="3"><? echo $row[csf("remarks")]; ?></th>
            </tr>
            <tr>
            	<th style="background: #D7ECD9">Refusing Cause</th>
                <th colspan="3"><? echo $row[csf("refusing_cause")]; ?></th>
            </tr>
			<tr>
            	<th style="background: #D7ECD9">Team Leader</th>
                <th><? echo $team_leader_arr[$row[csf("team_leader")]]; ?></th>
                <th style="background: #D7ECD9">Submitted By</th>
                <th><? echo $inserted_by; ?></th>
				<th colspan="2" style="background: #D7ECD9">Exchange Rate</th>
                <th  colspan="2"><? echo $exchange_rate ?></th>
            </tr>
            <tr>
            	<th style="background: #D7ECD9">Booking No</th>
                <th align="left" colspan="7" style="word-break: break-all;word-wrap: break-word;">M.FB&nbsp;<? echo implode(",",array_filter(array_unique(explode(",",$main_booking_no)))); ?>&nbsp;S.FB&nbsp;<? echo implode(",",array_filter(array_unique(explode(",",$short_booking_no)))); ?></th>
            </tr>
        </table>

            <?
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch
	/*echo '<pre>';
	print_r($conv_amount_job_process); die;*/

	  $yarnPer=$yarn_qty_amount_arr[$job_no]['amount']/$yarn_qty_amount_arr[$job_no]['qty'];
	  $finishPer=$total_finishing_amount/$total_finishing_qty;
	  $ydsPer=array_sum($conv_amount_job_process[$job_no][30])/array_sum($conv_qty_job_process[$job_no][30]);
	  $aopPer=array_sum($conv_amount_job_process[$job_no][35])/array_sum($conv_qty_job_process[$job_no][35]);
	  $knitPer=array_sum($conv_amount_job_process[$job_no][1])/array_sum($conv_qty_job_process[$job_no][1]);
	  $purchPer=$purchase_qty/$purchase_amount;
	  $dyePer=array_sum($conv_amount_job_process[$job_no][31])/array_sum($conv_qty_job_process[$job_no][31]);

	  $totFabPer=$yarnPer+$finishPer+$ydsPer+$aopPer+$knitPer+$purchPer+$dyePer;

	  //echo $yarnPer.'='.$finishPer.'='.$ydsPer.'='.$aopPer.'='.$knitPer.'='.$purchPer.'='.$dyePer.'='.$totFabPer;
	   //echo $other_costing_arr[$job_no]['cm_cost'].'='.$plancutqty.'='.$set_item_ratio;
	   $yarn_percentage=fn_number_format($yarn_qty_amount_arr[$job_no]['amount']/$order_values*100,2);
	   $finish_percentage=fn_number_format($total_finishing_amount/$order_values*100,2);
	   $print_percentage=$emb_amount_job_name_arr[$job_no][1]/$order_values*100;
	   $emb_percentage=$emb_amount_job_name_arr[$job_no][2]/$order_values*100;
	   $trims_percentage=$trims_costing_arr[$job_no]/$order_values*100;
	   $yds_percentage=array_sum($conv_amount_job_process[$job_no][30])/$order_values*100;
	   $aop_percenatge=array_sum($conv_amount_job_process[$job_no][35])/$order_values*100;
	   $misc_percenatage=$misc_cost/$order_values*100;
	   $knit_percentage=fn_number_format(array_sum($conv_amount_job_process[$job_no][1])/$order_values*100,2);
	   $purchase_percentage=$purchase_amount/$order_values*100;
	   $wash_percentage=$wash_amount_job_name_arr[$job_no][3]/$order_values*100;
	   $other_cm_percentage=$other_costing_arr[$job_no]['cm_cost']/$order_values*100;
	   $dying_percentage=array_sum($conv_amount_job_process[$job_no][31])/$order_values*100;
	   $txt_fabric_percentage=$yarn_percentage+$finish_percentage+$yds_percentage+$aop_percenatge+$knit_percentage+$purchase_percentage+$dying_percentage;
	   $total_percentage=$print_percentage+$trims_percentage+$emb_percentage+$misc_percenatage+$wash_percentage+$other_cm_percentage+$txt_fabric_percentage;
		?>
	  <br>
	  <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px; margin-top: 10px; font-family: 'Arial Narrow', Arial, sans-serif;" rules="all">
	  <label  style="float:left;background:#CCCCCC; font-size:larger;"><b>Summary </b> </label>
	  	<tr style="background: #D7ECD9">
	  		<th colspan="8" width="320">Fabric </th>
	  		<th colspan="4" width="160">Embellishment</th>
	  		<th colspan="4" width="160">Trims + CM + Misc</th>
	  		<th style="background: yellow">TTL COST &dollar;</th>
	  	</tr>
	  	<tr style="background: #D7ECD9">
	  		<th align="center">Item</th>
	  		<th align="center">Cost/Uom</th>
	  		<th align="center">Amount</th>
	  		<th align="center">&percnt;</th>
	  		<th align="center">Item</th>
	  		<th align="center">Cost/Uom</th>
	  		<th align="center">Amount</th>
	  		<th align="center">&percnt;</th>
	  		<th align="center">Item</th>
	  		<th align="center">Cost/Dz</th>
	  		<th align="center">Amount</th>
	  		<th align="center">&percnt;</th>
	  		<th align="center">Item</th>
	  		<th align="center">Cost/Dz</th>
	  		<th align="center">Amount</th>
	  		<th align="center">&percnt;</th>
	  		<th rowspan="5" align="right" style="background: yellow; color: #8B0000"><b>
	  			<? if($total_budget_value>o){ echo fn_number_format($total_budget_value,2,'',''); } ?><br/><br/>
                <? if($total_budget_value>o){ echo fn_number_format($total_percentage,2).'%'; } ?></b>
	  		</th>
	  	</tr>
	  	<tr>
	  		<th align="center">Yarn</th>
	  		<td align="center"><? if($yarn_amount_summ>0) { echo fn_number_format($yarn_qty_amount_arr[$job_no]['amount']/$yarn_qty_amount_arr[$job_no]['qty'],2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($yarn_amount_summ>0) { echo '&dollar;'.fn_number_format($yarn_amount_summ,2); } ?></td>
	  		<td align="right"><? if($yarn_amount_summ>0) { echo fn_number_format($yarn_percentage,2).'%';}; ?></td>

	  		<th align="center">Finishing</th>
	  		<td align="center" title="<?=$total_finishing_amount.'='.$total_finishing_qty; ?>"><? if($total_finishing_amount>0) { echo fn_number_format($total_finishing_amount/$total_finishing_qty,2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($total_finishing_amount>0) { echo '&dollar;'.fn_number_format($total_finishing_amount,2); } ?></td>
	  		<td align="right"><? if($total_finishing_amount>0) { echo fn_number_format($finish_percentage,2).'%';} ?></td>
		<?
        	$print_amt=$emb_amount_job_name_arr[$job_no][1];
		  	$print_qty=$emb_qty_job_name_arr[$job_no][1];
		?>
	  		<th align="center">Print</th>
	  		<td align="center" title="Amt=<? echo $print_amt;?>/Qty=<? echo $print_qty;?>">
			<? if($print_amount_summ>0)
			 {
				echo fn_number_format($print_amt/$print_qty,2);
			 }  ?></td>
	  		<td align="right" style="color: #8B0000"><? if($print_amount_summ>0) { echo '&dollar;'.fn_number_format($print_amount_summ,2);}  ?></td>
	  		<td align="right"><? if($print_amount_summ>0) { echo fn_number_format($print_percentage,2).'%';} ?></td>

	  		<th align="center">Trim</th>
	  		<td align="center"><? if($trims_costing_arr[$job_no]>0) { echo fn_number_format(($trims_costing_arr[$job_no]/$order_job_qnty)*$order_price_per_dzn,2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($trims_costing_arr[$job_no]>0) { echo '&dollar;'.fn_number_format($trims_costing_arr[$job_no],2);} ?></td>
	  		<td align="right"><? if($trims_costing_arr[$job_no]>0) { echo fn_number_format($trims_percentage,2).'%';} ?></td>
	  	</tr>
	  	<tr>
	  		<th align="center">Yds</th>
	  		<td align="center"><? if($yds_amount_summ>0) { echo fn_number_format(array_sum($conv_amount_job_process[$job_no][30])/array_sum($conv_qty_job_process[$job_no][30]),2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($yds_amount_summ>0) { echo '&dollar;'.fn_number_format($yds_amount_summ,2);} ?></td>
	  		<td align="right"><? if($yds_amount_summ>0) { echo fn_number_format($yds_percentage,2).'%';} ?></td>

	  		<th align="center">AOP</th>
	  		<td align="center"><? if($aop_amount_summ>0) { echo fn_number_format(array_sum($conv_amount_job_process[$job_no][35])/array_sum($conv_qty_job_process[$job_no][35]),2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($aop_amount_summ>0) { echo '&dollar;'.fn_number_format($aop_amount_summ,2);} ?></td>
	  		<td align="right"><? if($aop_amount_summ>0) { echo fn_number_format($aop_percenatge,2).'%';} ?></td>

	  		<th align="center">EMB</th>
	  		<td align="center"><? if($emb_amount_summ>0) { echo fn_number_format(($emb_amount_job_name_arr[$job_no][2]/$emb_qty_job_name_arr[$job_no][2]),2);}  ?></td>
	  		<td align="right" style="color: #8B0000"><? if($emb_amount_summ>0) { echo '&dollar;'.fn_number_format($emb_amount_summ,2);}  ?></td>
	  		<td align="right"><? if($emb_amount_summ>0) { echo fn_number_format($emb_percentage,2).'%';} ?></td>
	  		<th align="center" title="INSPECTION+FREIGHT+CERTIFICATE+DEFFDLC+DESIGN+STUDIO+Opert.Exp+INTEREST+INCOMETAX+DD&A +LAB TEST+CURRIER COST+COMMERCIAL+COMMISSION">MISC</th>
	  		<td align="center" ><?  if($misc_cost>0) { echo fn_number_format($misc_cost/$order_job_qnty*12,2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($misc_cost>0) { echo '&dollar;'.fn_number_format($misc_cost,2);}  ?></td>
	  		<td align="right"><? if($misc_cost>0) { echo fn_number_format($misc_percenatage,2).'%';} ?></td>
	  	</tr>
	  	<tr>
		  	<th align="center">Knitting</th>
	  		<td align="center"><? if($knitting_amount_summ !='') { echo fn_number_format(array_sum($conv_amount_job_process[$job_no][1])/array_sum($conv_qty_job_process[$job_no][1]),2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($knitting_amount_summ !='') { echo  '&dollar;'.fn_number_format($knitting_amount_summ,2);}   ?></td>
	  		<td align="right"><? if($knitting_amount_summ !=''){echo fn_number_format($knit_percentage,2).'%'; } ?></td>

	  		<th align="center">P. Fabric</th>
	  		<td align="center"><? $total_fabic_cost+=$purchase_qty/$purchase_amount; if($purchase_qty>0 && $purchase_amount>0){ echo fn_number_format($purchase_qty/$purchase_amount,2);} ?></td>
	  		<td align="right"><? $total_fabric_amount+=$purchase_amount; if($purchase_amount){echo '&dollar;'.fn_number_format($purchase_amount,2); } ?></td>
	  		<td align="right"><? $total_fabric_per+=$purchase_amount/$order_values*100; if($purchase_amount>0){ echo fn_number_format($purchase_percentage,2).'%'; }  ?></td>

	  		<th align="center">Wash</th>
	  		<td align="center"><? if($wash_amount_summ>0) {echo fn_number_format($wash_amount_job_name_arr[$job_no][3]/$wash_qty_job_name_arr[$job_no][3],2); };  ?></td>
	  		<td align="right" style="color: #8B0000"><? if($wash_amount_summ>0) { echo '&dollar;'.fn_number_format($wash_amount_summ,2);}  ?></td>
	  		<td align="right"><? if($wash_amount_summ>0) { echo fn_number_format($wash_percentage,2).'%';} ?></td>

	  		<th align="center" style="color: #8B0000">F.CM</th>
	  		<td align="center" style="color: #8B0000" title="(CM Cost/Order Qty Pcs)x12"><? if($other_costing_arr[$job_no]['cm_cost']>0){echo fn_number_format(($other_costing_arr[$job_no]['cm_cost']/($order_job_qnty*$set_item_ratio))*12,2); } ?></td>
	  		<td align="right" style="color: #8B0000"><? if($other_costing_arr[$job_no]['cm_cost']>0){ echo '&dollar;'.fn_number_format($other_costing_arr[$job_no]['cm_cost'],2); } ?></td>
	  		<td align="right"><? if($other_costing_arr[$job_no]['cm_cost']>0){ echo fn_number_format($other_cm_percentage,2).'%'; } ?></td>
	  	</tr>
	  	<tr>
	  		<th align="center">Dyeing</th>
	  		<td align="center"><? if($dyeing_amount_summ>0) {echo fn_number_format(array_sum($conv_amount_job_process[$job_no][31])/array_sum($conv_qty_job_process[$job_no][31]),2);} ?></td>
	  		<td align="right" style="color: #8B0000"><? if($dyeing_amount_summ>0) { echo '&dollar;'.fn_number_format($dyeing_amount_summ,2);} ?></td>
	  		<td align="right"><? if($dyeing_amount_summ>0) { echo fn_number_format($dying_percentage,2).'%';} ?></td>

	  		<th align="center" style="color: #8B0000">TOTAL</th>
	  		<th align="center" style="color: #8B0000"><? if($total_fabic_cost>0){ echo fn_number_format($total_fabic_cost,2); } ?></th>
	  		<th align="right" style="color: #8B0000"><? if($total_fabric_amount>0){ echo '&dollar;'.fn_number_format($total_fabric_amount,2); }  ?></th>
	  		<th align="right" title="yarn per+finish_per+yds_per+aop_per+knit_per+purchase_per+dying_per" style="color: #8B0000"><? if($total_fabric_per>0){ echo fn_number_format($txt_fabric_percentage,2); }  ?></th>

	  		<th align="center" title="Special works, Garments dyeing, UV print and others.">Others</th>
	  		<td align="center"><? if($others_emb_amount>0) {echo fn_number_format($others_emb_amount/$others_emb_qty,2); } ?></td>
	  		<td align="right"><? if($others_emb_amount>0) { echo '&dollar;'.fn_number_format($others_emb_amount,2); }  ?></td>
	  		<td align="right"><? if($others_emb_amount>0) { echo fn_number_format($others_emb_amount/$order_values*100,2);}  ?></td>
	  		<th></th>
	  		<td></td>
	  		<td></td>
	  		<td></td>
	  	</tr>
	  </table>
		<?
		$location_cpm_cost=0;
		$cm_min_variable=return_field_value("yarn_iss_with_serv_app as cost_per_minute","variable_order_tracking","company_name =".$cbo_company_name." and variable_list=67 and is_deleted=0 and status_active=1","cost_per_minute");
		if($cm_min_variable=="" || $cm_min_variable==0) $location_cpm_cost=0; else $location_cpm_cost=$cm_min_variable;
		if($location_cpm_cost!=1)
		{
			$sql_std_para=sql_select("select interest_expense, income_tax, cost_per_minute, applying_period_date, applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and is_deleted=0 order by id");

			foreach($sql_std_para as $row )
			{
				$applying_period_date=change_date_format($row[csf('applying_period_date')],'','',1);
				$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
				$diff=datediff('d',$applying_period_date,$applying_period_to_date);
				for($j=0;$j<$diff;$j++)
				{
					//$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
					$date_all=add_date(str_replace("'","",$applying_period_date),$j);
					$newdate =change_date_format($date_all,'','',1);
					$financial_para[$newdate][interest_expense]=$row[csf('interest_expense')];
					$financial_para[$newdate][income_tax]=$row[csf('income_tax')];
					$financial_para[$newdate][cost_per_minute]=$row[csf('cost_per_minute')];
				}
			}
		}
		else
		{
			$sql_std_para=sql_select( "select a.id, b.id as dtls_id, b.location_id, b.applying_period_date, b.applying_period_to_date, b.monthly_cm_expense, b.no_factory_machine, b.working_hour, b.cost_per_minute from lib_standard_cm_entry a, lib_standard_cm_entry_dtls b where a.id=b.mst_id and b.location_id=$location_name_id and a.company_id=$cbo_company_name" );
			foreach($sql_std_para as $row)
			{
				$applying_period_date=change_date_format($row[csf('applying_period_date')],'','',1);
				$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
				$diff=datediff('d',$applying_period_date,$applying_period_to_date);
				for($j=0;$j<$diff;$j++)
				{
					$date_all=add_date(str_replace("'","",$applying_period_date),$j);
					$newdate =change_date_format($date_all,'','',1);
					$financial_para[$newdate][interest_expense]=$row[csf('interest_expense')];
					$financial_para[$newdate][income_tax]=$row[csf('income_tax')];
					$financial_para[$newdate][cost_per_minute]=$row[csf('cost_per_minute')];
				}
			}
		}
		$sql_gsd_para=sql_select("select a.id,a.total_smv, b.target,b.efficiency,sum(layout_mp) as layout_mp
		from ppl_gsd_entry_mst      a,
			 ppl_balancing_mst_entry b,
			 wo_po_details_master   c,
			 ppl_balancing_dtls_entry d
	   where     a.id = b.gsd_mst_id
	   and a.id=d.gsd_mst_id
	   and b.id=d.mst_id
			 and c.job_no =$txt_job_no
			 and a.style_ref ='$style_no'
			 and c.style_ref_no = a.style_ref
			 and a.bulletin_type=3
			 and d.resource_gsd not in(40,41,43,44,48,68,70,147,53,54,69,55,56,90,176)
			 and a.status_active = 1
			 and a.is_deleted = 0
			 and b.status_active = 1
			 and b.is_deleted = 0
			 and c.status_active = 1
			 and c.is_deleted = 0
			  and d.status_active = 1
			 and d.is_deleted = 0
	group by  a.id,a.total_smv, b.target,b.efficiency");
	foreach($sql_gsd_para as $row)
			{
				$layout_no=$row[csf('id')];
				$layout_mp=$row[csf('layout_mp')];
				$target=$row[csf('target')];
				$efficiency=$row[csf('efficiency')];
				$total_smv=$row[csf('total_smv')];
			}


		$pre_costing_date=change_date_format($costing_date,'','',1);
		?>
		<? if($zero_value==0){ ?>
		<br/>
		<label  style="text-align:left; background:#CCCCCC; font-size:larger;"><b>CM Details </b> </label>
		<div style="width:970px; margin-top: 10px; font-family: 'Arial Narrow', Arial, sans-serif;">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:720px;float: left;" rules="all">
			<tr>
				<th colspan="13">&nbsp;</th>
			</tr>
			<tr style="background: #D7ECD9">
				<th>Style NO.</th>
				<th>MC</th>
				<th>Prd/Hr</th>
				<th>SMV</th>
				<th>BCM</th>
				<th>F.CM</th>
				<th>TTL Min</th>
				<th align="center">CPM (TK)</th>
				<th>RL</th>
				<th>RD</th>
				<th>A Eff%</th>
				<th>Layout No</th>
				<th>Alloc Qty</th>
			</tr>
			<tr align="center">
				<td><?= $style_no  ?></td>
				<td><?= $layout_mp  ?></td>
				<td><?= $target  ?></td>
				<td><?echo fn_number_format ($sew_smv,2) ?></td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td title="SMV*ORDER QUANTITY"><? echo fn_number_format($sew_smv*$order_qnty,2)?></td>
				<td><? echo fn_number_format($financial_para[$pre_costing_date][cost_per_minute],4); ?></td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td><?= $efficiency  ?></td>
				<td><?= $layout_no  ?></td>
				<td>&nbsp;</td>
			</tr>
			<?
			$tot_layout_mp+=$layout_mp;
			$tot_target+=$target;
			$tot_qnty+=$sew_smv*$order_qnty;
			$tot_efficiency+=$efficiency;
			?>
			<tr align="center">
				<th>Grand Total</th>
				<td><?= $tot_layout_mp  ?></td>
				<td><?= $tot_target  ?></td>
				<th><?echo fn_number_format($sew_smv,2) ?></th>
				<th>&nbsp;</th>
				<th>&nbsp;</th>
				<th><?=$tot_qnty;?></th>
				<th><? echo fn_number_format($financial_para[$pre_costing_date][cost_per_minute],4); ?></th>
				<th>&nbsp;</th>
				<th>&nbsp;</th>
				<th><?=$tot_efficiency?></th>
				<th>&nbsp;</th>
				<th>&nbsp;</th>
			</tr>
		</table>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:248px; margin-left: 2px; float: right;" rules="all">
			<tr>
				<th colspan="3" bgcolor="yellow">Embellishment[DZN]</th>
			</tr>
			<tr>
				<th>Print Qty</th>
				<th>Emb Qty</th>
				<th>Wash Qty</th>
			</tr>
			<tr align="center">
				<td><? if($emb_qty_job_name_arr[$job_no][1]>0){echo fn_number_format($emb_qty_job_name_arr[$job_no][1],2); } else { echo '&nbsp;'; } ?></td>
				<td><? if($emb_qty_job_name_arr[$job_no][2]>0){echo fn_number_format($emb_qty_job_name_arr[$job_no][2],2); } else { echo '&nbsp;'; } ?></td>
				<td><? if($emb_qty_job_name_arr[$job_no][3]>0){echo fn_number_format($wash_qty_job_name_arr[$job_no][3],2); } else { echo '&nbsp;'; } ?></td>
			</tr>
			<tr>
				<th><? if($emb_qty_job_name_arr[$job_no][1]>0){echo fn_number_format($emb_qty_job_name_arr[$job_no][1],2); } else { echo '&nbsp;'; } ?></th>
				<th><? if($emb_qty_job_name_arr[$job_no][2]>0){echo fn_number_format($emb_qty_job_name_arr[$job_no][2],2); } else { echo '&nbsp;'; } ?></th>
				<th><? if($emb_qty_job_name_arr[$job_no][3]>0){echo fn_number_format($wash_qty_job_name_arr[$job_no][3],2); } else { echo '&nbsp;'; } ?></th>
			</tr>
		</table>
		</div>
		<br>
		<? } ?>
		<?
			$nameArray_fabric_description= sql_select("SELECT (a.id) as fabric_cost_dtls_id,a.item_number_id, max(a.lib_yarn_count_deter_id) as determin_id,a.body_part_id,a.uom,a.color_type_id,a.fabric_source, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , a.fab_nature_id,  avg(b.requirment) as requirment, d.fabric_composition_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, lib_yarn_count_determina_mst d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and  c.id=b.color_size_table_id and a.lib_yarn_count_deter_id=d.id and c.status_active=1 and c.is_deleted=0  and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and a.job_no =$txt_job_no and  b.cons>0 group by a.body_part_id,a.uom,a.id,a.item_number_id,a.color_type_id,a.fabric_source,a.construction,a.composition,a.gsm_weight,b.dia_width,a.fab_nature_id, d.fabric_composition_id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");


			//a.fabric_source=1 and
			foreach ($nameArray_fabric_description as $row) {
				$fabric_id=$row[csf('fabric_cost_dtls_id')];
				$yarn_amount= $yarnDataWithFabricidArr[$fabric_id]['amount'];
				$yarn_qty= $yarnDataWithFabricidArr[$fabric_id]['qty'];

				$yds_amount = array_sum($con_amount_fabric_process[$fabric_id][30]);
				$yds_qty = array_sum($con_qty_fabric_process[$fabric_id][30]);

				$knitting_amount = array_sum($con_amount_fabric_process[$fabric_id][1]);
				$knitting_qty = array_sum($con_qty_fabric_process[$fabric_id][1]);
				$dyeing_amount = array_sum($con_amount_fabric_process[$fabric_id][31]);
				$dyeing_qty = array_sum($con_qty_fabric_process[$fabric_id][31]);
				$aop_amount = array_sum($con_amount_fabric_process[$fabric_id][35]);
				$aop_qty = array_sum($con_qty_fabric_process[$fabric_id][35]);

				$total_finishing_amount=0;
				$total_finishing_qty=0;
				foreach ($finishing_arr as $fid) {
					$total_finishing_amount += array_sum($con_amount_fabric_process[$fabric_id][$fid]);
					$total_finishing_qty += array_sum($con_qty_fabric_process[$fabric_id][$fid]);
				}

				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['body_part_id'] = $row[csf('body_part_id')];
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['description'] = $row[csf('construction')].', '.$fabric_composition_arr[$row[csf('fabric_composition_id')]];
				if($row[csf('fab_nature_id')]==2)
				{
					$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['fqty'] = array_sum($fabric_qty_arr['knit']['finish'][$row[csf('fabric_cost_dtls_id')]]);
					$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['gqty'] = array_sum($fabric_qty_arr['knit']['grey'][$row[csf('fabric_cost_dtls_id')]]);
				}
				if($row[csf('fab_nature_id')]==3)
				{
					$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['fqty'] = array_sum($fabric_qty_arr['woven']['finish'][$row[csf('fabric_cost_dtls_id')]]);
					$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['gqty'] = array_sum($fabric_qty_arr['woven']['grey'][$row[csf('fabric_cost_dtls_id')]]);
				}

				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['funit'] = $row[csf('uom')];
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['cons'] = $row[csf('cons')];

				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['process_loss'] = $row[csf('process_loss_percent')];
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['yarn_amount'] = $yarn_amount;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['yarn_per'] = $yarn_amount/$yarn_qty;

				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['yds_amount'] = $yds_amount;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['yds_per'] = $yds_amount/$yds_qty;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['knitting_amount'] = $knitting_amount;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['knitting_per'] = $knitting_amount/$knitting_qty;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['dyeing_amount'] = $dyeing_amount;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['dyeing_per'] = $dyeing_amount/$dyeing_qty;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['aop_amount'] = $aop_amount;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['aop_per'] = $aop_amount/$aop_qty;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['finishing_amount'] = $total_finishing_amount;
				$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['finishing_per'] = $total_finishing_amount/$total_finishing_qty;
				if($row[csf('fabric_source')]==1)
				{
					$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['ttl_cost'] = $yarn_amount+$yds_amount+$knitting_amount+$dyeing_amount+$aop_amount+$total_finishing_amount;
				}
				if($row[csf('fabric_source')]==2)
				{
					if($row[csf('fab_nature_id')]==2)
					{
						$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['ttl_cost']=array_sum($fabric_amount_arr['knit']['grey'][$row[csf('fabric_cost_dtls_id')]]);
					}
					if($row[csf('fab_nature_id')]==3)
					{
						$fabric_data_arr[$row[csf('fabric_cost_dtls_id')]]['ttl_cost']=array_sum($fabric_amount_arr['woven']['grey'][$row[csf('fabric_cost_dtls_id')]]);
					}
				}
			}
			 /* echo '<pre>';
			print_r($fabric_data_arr); die;  */
			$total_finishing_amount=0;
			?>
			<? if($zero_value==0){ ?>
			<br>
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px; margin-top: 10px; font-family: 'Arial Narrow', Arial, sans-serif;" rules="all">
			<label  style="float:left;background:#CCCCCC; font-size:larger;"><b>Fabric Details </b> </label>
				<tr style="background: #D7ECD9">
					<th rowspan="2">Garments Part Name</th>
					<th rowspan="2">Fabric Details</th>
					<th rowspan="2">Con</th>
					<th>F. QTY</th>
					<th rowspan="2">Process Loss</th>
					<th>G. QTY</th>
					<th colspan="7">Cost/Uom (Fabric)</th>
					<th rowspan="2">Cost/Dz</th>
					<th rowspan="2" style="background: yellow;">TTL Cost $</th>
				</tr>
				<tr style="background: #D7ECD9">
					<th>Unit</th>
					<th>Unit</th>
					<th>Yarn</th>
					<th>Yds</th>
					<th>Knitting</th>
					<th>Dyeing</th>
					<th>AOP</th>
					<th>Finishing</th>
					<th>Cost/Uom</th>
				</tr>
				<?
					foreach ($fabric_data_arr as $value) {?>
						<tr>
							<td rowspan="2"><?= $body_part[$value['body_part_id']] ?></td>
							<td rowspan="2"><?= $value['description'] ?></td>
							<td rowspan="2" align="center"><?= fn_number_format($value['cons'],2); ?></td>
							<td align="center"><? $total_fqty+=$value['fqty']; echo fn_number_format($value['fqty'],2); ?></td>
							<td rowspan="2" align="center"><? if($value['process_loss']>0){ echo fn_number_format($value['process_loss'],2);} ?></td>
							<td align="center"><? $total_gqty+=$value['gqty']; echo fn_number_format($value['gqty'],2) ?></td>
							<td rowspan="2" align="right"><? $total_yarn_amount += $value['yarn_amount']; if($value['yarn_amount']>0){echo fn_number_format($value['yarn_per'],2); }?><br><? if($value['yarn_amount']>0){ echo fn_number_format($value['yarn_amount'],2);} ?></td>
							<td rowspan="2" align="right"><? $total_yds_amount += $value['yds_amount']; if($value['yds_per']>0){ echo fn_number_format($value['yds_per'],2);}?><br><? if($value['yds_amount']>0){ echo fn_number_format($value['yds_amount'],2);} ?></td>
							<td rowspan="2" align="right"><? $total_knitting_amount += $value['knitting_amount']; if($value['knitting_per']>0){ echo fn_number_format($value['knitting_per'],2);}?><br><? if($value['knitting_amount']>0){ echo fn_number_format($value['knitting_amount'],2);} ?></td>
							<td rowspan="2" align="right"><? $total_dyeing_amount += $value['dyeing_amount']; if($value['dyeing_per']>0){ echo fn_number_format($value['dyeing_per'],2);} ?><br><? if($value['dyeing_amount']>0){echo fn_number_format($value['dyeing_amount'],2);} ?></td>
							<td rowspan="2" align="right"><? $total_aop_amount += $value['aop_amount']; if($value['aop_per']>0){ echo fn_number_format($value['aop_per'],2);} ?><br><? if($value['aop_amount']>0){ echo fn_number_format($value['aop_amount'],2);} ?></td>
							<td rowspan="2" align="right"><? $total_finishing_amount += $value['finishing_amount']; if($value['finishing_per']>0){ echo fn_number_format($value['finishing_per'],2);}?><br><? if($value['finishing_amount']>0){echo fn_number_format($value['finishing_amount'],2);} ?></td>
							<td rowspan="2" align="right" title="TTL Cost/Finish Quantity"><?= fn_number_format($value['ttl_cost']/$value['fqty'],2) ?></td>
							<td rowspan="2" align="right"><?= fn_number_format($value['ttl_cost']/$order_job_qnty*12,2) ?></td>
							<th rowspan="2" style="background: yellow;" align="right"><? $total_ttl_cost += $value['ttl_cost'];  echo fn_number_format($value['ttl_cost'],2) ?></th>
						</tr>
						<tr>
							<td align="center"><?= $unit_of_measurement[$value['funit']] ?></td>
							<td align="center"><?= $unit_of_measurement[$value['funit']] ?></td>
						</tr>
					<? }
				?>
				<tr>
					<th colspan="2">Fabric  Total</th>
					<td></td>
					<th align="center"><? if($total_fqty>0){echo fn_number_format($total_fqty,2);} ?></th>
					<td></td>
					<th align="right"><? if($total_gqty){ echo fn_number_format($total_gqty,2); } ?></th>
					<th align="right"><? if($total_yarn_amount){ echo fn_number_format($total_yarn_amount,2); } ?></th>
					<th align="right"><? if($total_yds_amount){ echo fn_number_format($total_yds_amount,2); } ?></th>
					<th align="right"><? if($total_knitting_amount){ echo fn_number_format($total_knitting_amount,2); } ?></th>
					<th align="right"><? if($total_dyeing_amount){ echo fn_number_format($total_dyeing_amount,2); } ?></th>
					<th align="right"><? if($total_aop_amount){ echo fn_number_format($total_aop_amount,2); } ?></th>
					<th align="right"><? if($total_finishing_amount){ echo fn_number_format($total_finishing_amount,2); } ?></th>
					<th></th>
					<th></th>
					<th style="background: yellow;" align="right"><? if($total_ttl_cost){ echo '&dollar;'.fn_number_format($total_ttl_cost,2); } ?> <br><? if($total_ttl_cost){ echo fn_number_format(($total_ttl_cost/$order_value)*100,2).'%'; } ?></th>
				</tr>
			</table>
			<? } ?>
			<?

				//end 	All Fabric Cost part report-------------------------------------------
			$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
			   if($version != ""){$table_name="wo_pre_cost_fab_yarn_cst_dtl_h "; $where_con=" and APPROVED_NO=$version"; }else {$table_name="wo_pre_cost_fab_yarn_cost_dtls "; $where_con="";}

				 $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from $table_name where job_no=".$txt_job_no." $where_con  and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
                  //echo  $sql;die;
		        $data_array=sql_select($sql);
				//$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
			 //print_r($yarn_data_array);

		?>
		<br>
        <div style="margin-top:15px; font-family: 'Arial Narrow', Arial, sans-serif;">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger;"><b>Yarn Details </b> </label>
                <tr style="font-weight:bold;">

                    <td width="540" style="background: #D7ECD9">Yarn Description</td>
                    <td width="80" style="background: #D7ECD9">Yarn Qty/<?=$costing_for; ?></td>
					<td width="80" style="background: #D7ECD9">TTL Yarn Qty</td>
                    <td width="80" style="background: #D7ECD9">Rate &#36;</td>
					<td width="80" style="background: yellow">Amount &#36;</td>
					<td width="80" style="background: #D7ECD9">% to Ord. Value</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=$total_yarn_qty_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
 				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
				if(is_infinite($rowamount) || is_nan($rowamount)){$rowamount=0;}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($rowcons_qnty,2); ?></td>

                    <td align="right"><? if($row[csf("rate")]>0){ echo fn_number_format($row[csf("rate")],3);} ?></td>
                    <td align="right" style="background: yellow"><? if($rowamount>0){ echo fn_number_format($rowamount,2);} ?></td>
					<td align="right"><?
					$cv=($row[csf("amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					if($cv>0){echo fn_number_format($cv,2); }
					?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_yarn_qty_dzn+=$row[csf("cons_qnty")];
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
				  if(is_infinite($total_yarn_cost_kg) || is_nan($total_yarn_cost_kg)){$total_yarn_cost_kg=0;}
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Yarn Total</td>
                    <td align="right"><? if($total_yarn_qty_dzn>0){ echo fn_number_format($total_yarn_qty_dzn,4); } ?></td>
					<td align="right"><? if($total_yarn_qty>0){ echo fn_number_format($total_yarn_qty,2); } ?></td>
                    <td></td>
                    <td align="right" bgcolor="yellow"><? if($total_yarn_amount>0){ echo '&dollar;'.fn_number_format($total_yarn_amount,2); } ?></td>
					<td align="right"><?
					$cv=($total_yarn_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					if($cv>0){ echo fn_number_format($cv,2).' %';  }
					?></td>
                </tr>
        	</table>
      </div>
      <?
		//End Yarn Cost part report here -------------------------------------------


	//start	Trims Cost part report here -------------------------------------------
	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

	if($version != ""){$table_name="wo_pre_cost_trim_cost_dtls_his" ;$trim_id_field="pre_cost_trim_cost_dtls_id as id"; $where_con=" and APPROVED_NO=$version"; }else {$table_name="wo_pre_cost_trim_cost_dtls";$trim_id_field="id"; $where_con="";}

    	$sql = "select $trim_id_field, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi, status_active from $table_name where job_no=".$txt_job_no." $where_con  and status_active=1 and is_deleted=0";
		//echo $sql;die;
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;font-family: 'Arial Narrow', Arial, sans-serif;" rules="all">

			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Trims Details</b> </label>
                <tr style="font-weight:bold; background: #D7ECD9" >
                    <td width="110" style="background: #D7ECD9">Item Group.</td>
                    <td width="110" style="background: #D7ECD9">Item Description</td>
					<td width="100" style="background: #D7ECD9">Supplier</td>
                    <td width="60" style="background: #D7ECD9">UOM</td>
                    <td width="80" style="background: #D7ECD9">Cons/<?=$costing_for; ?>[Qnty]</td>
					<td width="100" style="background: #D7ECD9">TTL Required[Qnty]</td>
                    <td width="50" style="background: #D7ECD9">Ex %</td>
                    <td width="80" style="background: #D7ECD9">Rate &#36;</td>
                    <td width="80" style="background: #D7ECD9">Amount/<?=$costing_for; ?>&#36;</td>
					<td width="80" style="background: yellow">Amount &#36;</td>
					<td width="60" style="background: #D7ECD9">% to Ord. Value</td>
                </tr>
            <?
			if($version != ""){$table_name="wo_pre_cost_trim_co_cons_dtl_h "; $where_con=" and APPROVED_NO=$version"; }else {$table_name="wo_pre_cost_trim_co_cons_dtls "; $where_con="";}

			$trims_cons_dtls_data_arr=sql_select("select wo_pre_cost_trim_cost_dtls_id trim_cost_dtls_id,avg(excess_per) excess_per,job_no ,job_id from $table_name where job_no=".$txt_job_no."  $where_con  and status_active=1 and is_deleted=0
			group by wo_pre_cost_trim_cost_dtls_id,job_no ,job_id");
			



			

			// echo "select wo_pre_cost_trim_cost_dtls_id trim_cost_dtls_id,avg(excess_per) excess_per,job_no ,job_id from $table_name where job_no=".$txt_job_no." $where_con and status_active=1 and is_deleted=0
			// group by wo_pre_cost_trim_cost_dtls_id,job_no ,job_id";die;

			foreach($trims_cons_dtls_data_arr as $val){
				$trims_cons_dtls_data_arr[$val[csf('trim_cost_dtls_id')]]['excess_per']=$val[csf('excess_per')];
			}
                 
			// $trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trims_cons_dtls_data_arr);die;
			// $trim_amount_arr=$trims->getAmountArray_precostdtlsid();
            $total_trims_cost=0;  $total_trims_qty=$total_trims_cost_dzn=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
            foreach( $data_array as $row ){

				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$cons_dzn_gmts= $row[csf("cons_dzn_gmts")];
				$amount_dzn= $row[csf("amount")];
				$pre_trims_qty=$trim_qty_arr[$row[csf("id")]];
				//echo $row[csf("id")];die;
				$pre_trims_amount=$trim_amount_arr[$row[csf("id")]];
               // print_r($pre_trims_amount);die;
				$nominated_supp_str="";
				$exsupp=explode(",",$row[csf("nominated_supp_multi")]);
				foreach($exsupp as $sid)
				{
					if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
				}
			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><?=$nominated_supp_str; ?></td>
                    <td align="center"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($cons_dzn_gmts,3); ?></td>
					<td align="right"><? echo fn_number_format($pre_trims_qty,4); ?></td>
					<td align="right"><? echo fn_number_format($trims_cons_dtls_data_arr[$val[csf('trim_cost_dtls_id')]]['excess_per'],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					 <td align="right"><? echo fn_number_format($amount_dzn,4); ?></td>
                    <td align="right" style="background: yellow"><? echo fn_number_format($pre_trims_amount,2); ?></td>
					<td align="right"  title="<? echo $amount_dzn.'='.$price_dzn;?>">
					<?
					$cv=($amount_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2);
					//echo fn_number_format(($amount_dzn/$price_dzn)*100,2);
					?></td>
                </tr>
            <?
                 $total_trims_cost += $pre_trims_amount;
				 $total_trims_cost_dzn += $amount_dzn;
				  $total_trims_qty += $pre_trims_qty;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold" >
                    <td>Trims Total</td>
					<td colspan="4"></td>
					<td align="right"><? if($total_trims_qty>0){ echo fn_number_format($total_trims_qty,4); } ?></td>
					<td align="right"><? //echo fn_number_format($total_trims_cost_dzn,4); ?></td>
					<td align="right"><? //echo fn_number_format($total_trims_cost_dzn,4); ?></td>

					<td align="right"><? if($total_trims_cost_dzn>0){ echo '&dollar;'.fn_number_format($total_trims_cost_dzn,4); } ?></td>
					<td align="right" style="background: yellow"><? if($total_trims_cost>0){ echo '&dollar;'.fn_number_format($total_trims_cost,2); } ?></td>
					<td align="right" title="<? echo $total_trims_cost_dzn.'='.$price_dzn;?>">
					<?
					$cv=($total_trims_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					if($cv){ echo fn_number_format($cv,2).' %'; }
					?>
                    </td>
                </tr>
            </table>
      </div>
      <?
      $pre_cost_dtls_arr = sql_select("SELECT id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost,depr_amor_pre_cost,deffdlc_cost,studio_cost,design_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,incometax_cost,interest_cost,interest_percent,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,design_percent, studio_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0");
      foreach ($pre_cost_dtls_arr as $row) {
        $price_dzn=$row[csf("price_dzn")];
		$lab_test_dzn=$row[csf("lab_test")];
		$commission_cost_dzn=$row[csf("commission")];
		$commercial_cost_dzn = $row[csf("comm_cost")];

		$inspection_dzn=$row[csf("inspection")];
		$cm_cost_dzn =$row[csf("cm_cost")];
		$common_oh_dzn =$row[csf("common_oh")];
		$freight_dzn =$row[csf("freight")];
		$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
		$currier_per_cost_dzn = $row[csf("currier_percent")];
		$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
		$deffdlc_cost_dzn = $row[csf("deffdlc_cost")];
		$depr_amor_pre_cost_dzn = $row[csf("depr_amor_pre_cost")];
		$interest_cost_dzn=$row[csf("interest_cost")];
		$interest_cost_percent=$row[csf("interest_percent")];
		$incometax_cost_dzn=$row[csf("incometax_cost")];
		$studio_cost_dzn=$row[csf("studio_cost")];
		$design_cost_dzn=$row[csf("design_cost")];
		$studio_cost_percent=$row[csf("studio_percent")];
		$design_cost_percent=$row[csf("design_percent")];

		$other_cost_per = $inspection_dzn+$freight_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn+$design_cost_dzn+$studio_cost_dzn+$common_oh_dzn+$interest_cost_dzn+$incometax_cost_dzn+$depr_amor_pre_cost_dzn;
      }
      ?>
      <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="350" cellspacing="0" rules="all" style="margin-top: 10px;font-family: 'Arial Narrow', Arial, sans-serif;">
      	<tr style="background: #D7ECD9">
      		<th>MISC/Others Cost</th>
      		<th>%</th>
      		<th>TTL Cost $</th>
      	</tr>
      	<tr>
      		<td>Test cost</td>
      		<td align="right"><?
      			$lab_test_per=($other_costing_arr[$job_no]['lab_test']/$order_values)*100;
				if(is_infinite($lab_test_per) || is_nan($lab_test_per))
				{
					$lab_test_per=0;
				}
				if($lab_test_per>0){echo fn_number_format($lab_test_per,2);}
				$total_misc_per += $lab_test_per;
      		?></td>
      		<th align="right"><? if($other_costing_arr[$job_no]['lab_test']>0){ echo fn_number_format($other_costing_arr[$job_no]['lab_test'],2);} ?></th>
      	</tr>
      	<tr>
      		<td>Buying commission</td>
      		<td align="right"><?
      			$commission_cost_per=($commission_costing_arr[$job_no]/$order_values)*100;
				if(is_infinite($commission_cost_per) || is_nan($commission_cost_per))
				{
					$commission_cost_per=0;
				}
				if($commission_cost_per>0){ echo fn_number_format($commission_cost_per,2);}
				$total_misc_per +=$commission_cost_per;
      		?></td>
      		<th align="right"><? if($commission_costing_arr[$job_no]>0){ echo fn_number_format($commission_costing_arr[$job_no],2);} ?></th>
      	</tr>
      	<tr>
      		<td>Commercial cost</td>
      		<td align="right"><?
      			$commercial_cost_per=($commercial_costing_arr[$job_no]/$order_values)*100;
				if(is_infinite($commercial_cost_per) || is_nan($commercial_cost_per))
				{
					$commercial_cost_per=0;
				}
				if($commercial_cost_per>0){ echo fn_number_format($commercial_cost_per,2); }
				$total_misc_per +=$commercial_cost_per;
      			?>
      		</td>
      		<th align="right"><? if($commercial_costing_arr[$job_no]>0) { echo fn_number_format($commercial_costing_arr[$job_no],2);} ?></th>
      	</tr>
		  <tr>
      		<td>Courier costs</td>
      		<td align="right"><?
			  	 $currier_pre_cost_dzn=$currier_pre_cost_dzn*($order_job_qnty/12);
      			// $currier_pre_cost_dzn=($currier_pre_cost_dzn/$order_values)*100;
				if(is_infinite($currier_per_cost_dzn) || is_nan($currier_per_cost_dzn))
				{
					$currier_per_cost_dzn=0;
				}
				if($currier_per_cost_dzn>0){ echo fn_number_format($currier_per_cost_dzn,2);}
				$total_misc_per +=$currier_per_cost_dzn;

      			?>
      		</td>
      		<th align="right"><? if($currier_pre_cost_dzn>0){ echo fn_number_format($currier_pre_cost_dzn,2);} ?></th>
      	</tr>
      	<tr>
      		<td>Other costs</td>
      		<td align="right"><?
      			$other_cost_per=($total_other_cost/$order_values)*100;
				if(is_infinite($other_cost_per) || is_nan($other_cost_per))
				{
					$other_cost_per=0;
				}
				if($other_cost_per>0){ echo fn_number_format($other_cost_per,2);}
				$total_misc_per +=$other_cost_per;
      			?>
      		</td>
      		<th align="right"><? if($total_other_cost>0){ echo fn_number_format($total_other_cost,2);} ?></th>
      	</tr>
      	 <tr>
      		<th>MISC/Others Cost Sub Total</th>
      		<th align="right"><? if($total_misc_per>0){ echo fn_number_format($total_misc_per,2).'%'; }  ?></th>
      		<th align="right"><? if($misc_cost>0){ echo '&dollar;'.fn_number_format($misc_cost,2); } ?></th>
      	</tr>
      </table>
      <div id="div_size_color_matrix" style="float:left; max-width:1000; font-family: 'Arial Narrow', Arial, sans-serif;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
				<?
				$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	 			$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
				$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".$txt_order_no_id.") and  job_no_mst=$txt_job_no and	is_deleted=0 and status_active=1 group by size_number_id order by size_order");
				//echo "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".$txt_order_no_id.") and  job_no_mst=$txt_job_no and	is_deleted=0 and status_active=1 group by size_number_id order by size_order"; die;
				?>
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".$txt_order_no_id.") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0; $color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo fn_number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
										$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo " ";
							 ?>
							</td>
                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><? if(round($color_total_order)>0){ echo fn_number_format(round($color_total_order),0);} ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; if(round($excexss_per)>0){ echo fn_number_format($excexss_per,2)." %";} ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? if(round($color_total)>0){ echo fn_number_format(round($color_total),0);} ?></td>
                    </tr>
                    <?
                    }
					?>
                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  if(round($item_grand_total_order)>0){ echo fn_number_format(round($item_grand_total_order),0); } ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; if($excess_item_gra_tot>0){echo fn_number_format($excess_item_gra_tot,2)." %"; } ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  if(round($item_grand_total)>0){echo fn_number_format(round($item_grand_total),0); } ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><? if(round($grand_total_order)>0){ echo fn_number_format(round($grand_total_order),0); } ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; if($excess_gra_tot>0) { echo fn_number_format($excess_gra_tot,2)." %"; } ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  if(round($grand_total)>0) { echo fn_number_format(round($grand_total),0); } ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
				<br/><br/>
				<div>

     <br/>
	 <? if($zero_value==0) {?>
	 <?

	 $lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");
	//and b.un_approved_date is null
	 $approve_data_array=sql_select("select b.approved_by,min(b.approved_date) as approved_date from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  group by  b.approved_by order by b.approved_by asc");
	 $unapprove_data_array=sql_select("select b.approved_by, b.un_approved_by, b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_date,b.approved_by");
	// echo "select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_no";

 	if(count($approve_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="40%" style="border:1px solid black;">Name</th>
				<th width="30%" style="border:1px solid black;">Designation</th>
				<th width="27%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
    <br/>
	
	<?
	$sql_unapproved=sql_select("select user_id,booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2  and booking_id=$mst_id and is_deleted=0 and status_active=1");
	//echo  "select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id";
	$unapproved_request_arr=array();
	foreach($sql_unapproved as $rowu)
	{
		$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
	}

	if(count($unapprove_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<!--<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>-->
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;  $un_approve_req_chk=array();$un=1;
			foreach($unapprove_data_array as $row)
			{
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<!--<td width="20%" style="border:1px solid black;"><? //echo $unapproved_request_arr[$row[csf('approved_by')]];?></td>-->
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
             </tr>
				<?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if(!empty($un_approved_date))
				{
					$un_approv_user=$row[csf('approved_by')].$mst_id;
					if (!in_array($un_approv_user,$un_approve_req_chk))
					{
						$un++;
						$un_approve_req_chk[]=$un_approv_user;
						$unapproved_request=$unapproved_request_arr[$mst_id];
						//echo $un_approv_user."=";
					}
					if($row[csf('un_approved_by')]!=0) $row[csf('approved_by')]=$row[csf('un_approved_by')];
					?>
					<tr style="border:1px solid black;">
						<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
					</tr>
					<?
					$i++;
				}
			}
				?>
            </tbody>
        </table>
		<?
		}
	}
		?>
    <!--End CM on Net Order Value Part report here -->
     <?  //echo signature_table(109, $cbo_company_name, "970px");?>
     <?
     $width=990;
     $padding_top = 70;
     $prepared_by='';
     $sql = sql_select("select designation,name,activities,prepared_by from variable_settings_signature where report_id=109 and company_id=$cbo_company_name order by sequence_no");


	if($sql[0][csf("prepared_by")]==1){
		list($prepared_by,$activities)=explode('**',$prepared_by);
		$sql_2[100] = array ( DESIGNATION => 'Prepared By' ,NAME => $prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
		$sql=$sql_2+$sql;
	}

	$count = count($sql);
	$td_width = floor($width / $count);
	$standard_width = $count * 120;
	if ($standard_width > $width) {
		$td_width = 120;
	}
	$no_coloumn_per_tr = floor($width / $td_width);
	$i = 1;
	if ($count == 0) {$message = "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
	echo '<table id="signatureTblId" width="' . $width . '" style="padding-top:' . $padding_top . 'px;"><tr><td width="100%" height="' . $padding_top . '" colspan="' . $count . '">' . $message . '</td></tr><tr>';
	foreach ($sql as $row) {
		echo '<td width="' . $td_width . '" align="center" valign="top">
		<strong>' . $row[csf("activities")] . '</strong><br>
		<strong style="text-decoration:overline">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
		if ($i % $no_coloumn_per_tr == 0) {
			echo '</tr><tr><td width="100%" height="70" colspan="' . $no_coloumn_per_tr . '"></td></tr>';
		}
		$i++;
	}
	echo '</tr></table>';
	?>
    </div>
	 <?
	 disconnect($con);
	 exit();
}


if($action=="bomRptWoven")
{

		$process = array( &$_POST );
		extract(check_magic_quote_gpc( $process ));
		$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
		if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
		if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
		if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
		if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
		if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
		if(str_replace("'",'',$txt_po_breack_down_id)=="")
		{
			$txt_po_breack_down_id_cond='';
			$txt_po_breack_down_id_cond1='';
			$txt_po_breack_down_id_cond2='';
			$txt_po_breack_down_id_cond3='';
		}
		else
		{
			$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
			$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
			$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
			$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
		}

		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
		$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
		$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

		$poNumber=array();
		$pubShipDate=array();
		$po_qty=0;
		$po_plun_cut_qty=0;
		$total_set_qnty=0;
		$avg_unit_price=0;
		$sql_po="select a.job_no,a.total_set_qnty,a.avg_unit_price,b.id,b.po_number,b.pub_shipment_date,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $txt_po_breack_down_id_cond and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
		$sql_po_data=sql_select($sql_po);
		foreach($sql_po_data as $sql_po_row){
			$po_qty+=$sql_po_row[csf('order_quantity')];
			$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
			$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
			$poNumber[$sql_po_row[csf('po_number')]]=$sql_po_row[csf('po_number')];
			$pubShipDate[$sql_po_row[csf('po_number')]]=change_date_format($sql_po_row[csf('pub_shipment_date')],"dd-mm-yyyy","-");
			$avg_unit_price=$sql_po_row[csf('avg_unit_price')];
		}

		$poQtyUom=$po_qty/$total_set_qnty;
		$poPlunCutQtyUom=$po_plun_cut_qty/$total_set_qnty;
		$excessQty=$poPlunCutQtyUom-$poQtyUom;
		$excessPer=(100*$excessQty)/$poQtyUom;

		$gmtsItem=array();
		$gmtsitem_ratio_array=array();
		$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");
		foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
			$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
			$gmtsItem[$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$garments_item[$gmtsitem_ratio_sql_row[csf("gmts_item_id")]];
		}

		$financial_para=array();
		$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
		foreach($sql_std_para as $sql_std_row){
			$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
			$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
			$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
		}

		$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv,b.sew_effi_percent,b.cut_effi_percent,b.approved from wo_po_details_master a, wo_pre_cost_mst b where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
		$data_array=sql_select($sql);
		$uom="";
		$jobNo="";
		$buyerName="";
		$styleRefNo="";
		$costingPer="";

		foreach ($data_array as $row){
			$uom=$row[csf("order_uom")];
			$jobNo=$row[csf("job_no")];
			$buyerName=$buyer_arr[$row[csf("buyer_name")]];
			$styleRefNo=$row[csf("style_ref_no")];
			$costingPer=$row[csf("costing_per")];

			$order_price_per_dzn=0;
			if($costingPer==1){
				$order_price_per_dzn=12;
				$costing_for=" DZN";
			}
			else if($costingPer==2){
				$order_price_per_dzn=1;
				$costing_for=" PCS";
			}
			else if($costingPer==3){
				$order_price_per_dzn=24;
				$costing_for=" 2 DZN";
			}
			else if($costingPer==4){
				$order_price_per_dzn=36;
				$costing_for=" 3 DZN";
			}
			else if($costingPer==5){
				$order_price_per_dzn=48;
				$costing_for=" 4 DZN";
			}
		}
		//start	all summary report here -------------------------------------------
		$condition= new condition();
		if(str_replace("'","",$txt_job_no) !=''){
			$condition->job_no("=$txt_job_no");
		}
		if(str_replace("'",'',$txt_po_breack_down_id) !=""){
			$condition->po_id("in($txt_po_breack_down_id)");
		}
		$condition->init();
		$fabric= new fabric($condition);
		$trim= new trims($condition);
		$emblishment= new emblishment($condition);
		$wash= new wash($condition);
		$other= new other($condition);
		$other_cost=$other->getAmountArray_by_job();
		$commercial= new commercial($condition);
		$commision= new commision($condition);


		$sql_new = "select job_no,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,depr_amor_pre_cost,total_cost , total_cost_percent, price_dzn, price_dzn_percent, margin_dzn,margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array_new=sql_select($sql_new);
		$summary_data=array();

		foreach( $data_array_new as $row_new ){
			$summary_data[price_dzn]=$row_new[csf("price_dzn")];
			$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
			$summary_data[price_dzn_job_per]=($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100;

			$summary_data[commission]=$row_new[csf("commission")];
			$summary_data[trims_cost]=$row_new[csf("trims_cost")];
			$summary_data[emb_cost]=$row_new[csf("embel_cost")];

			$summary_data[lab_test]=$row_new[csf("lab_test")];
			$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

			$summary_data[inspection]=$row_new[csf("inspection")];
			$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

			$summary_data[freight]=$row_new[csf("freight")];
			$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

			$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
			$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

			$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
			$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
			$summary_data[wash_cost]=$row_new[csf("wash_cost")];

			$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

			$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

			$summary_data[cm_cost]=$row_new[csf("cm_cost")];
			$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

			$summary_data[comm_cost]=$row_new[csf("comm_cost")];

			$summary_data[common_oh]=$row_new[csf("common_oh")];
			$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
			$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
			$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
		}

		//Fabric =====================
		$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and fab_nature_id=3";
		$data_arr_fabric=sql_select($sql_fabric);
		$totFabQty=0;
		$totFabAmt=0;
		$FabricData=array();
		foreach($data_arr_fabric as $fab_row){
			$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
			$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$totFabQty+=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$totFabAmt+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];

			$FabricData[$fab_row[csf("id")]]['description']=$body_part[$fab_row[csf("body_part_id")]].", ".$color_type[$fab_row[csf("color_type_id")]].", ".$fab_row[csf("fabric_description")].", ".$fab_row[csf("gsm_weight")];
			$FabricData[$fab_row[csf("id")]]['fabric_source']=$fabric_source[$fab_row[csf("fabric_source")]];
			$FabricData[$fab_row[csf("id")]]['avg_cons']=$fab_row[csf("avg_cons")];
			$FabricData[$fab_row[csf("id")]]['totalConsWoven']=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]]['uom']=$unit_of_measurement[$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]]['rate']=$fab_row[csf("rate")];
			$FabricData[$fab_row[csf("id")]]['amount']=$fab_row[csf("rate")]*$fab_row[csf("avg_cons")];
			$FabricData[$fab_row[csf("id")]]['totalAmountWoven']=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		$totFabQtyAsCostPer=($totFabQty/$poPlunCutQtyUom)*$order_price_per_dzn;
		//Fabric End======================
		//start	Trims Cost part report here -------------------------------------------
		$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
		from wo_pre_cost_trim_cost_dtls
		where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array_trim=sql_select($sql_trim);
		$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
		$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
		$totTrim=0;
		$TrimData=array();
		foreach( $data_array_trim as $row_trim ){
			$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
			$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
			$summary_data[trims_cost_job]+=$trim_amount;
			$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
			$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
			$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
			$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
			$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
			$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
			$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
			$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
			$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
			$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
			$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
			$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
			$totTrim+=$row_trim[csf('cons_dzn_gmts')];
		}
		//End	Trims Cost part report here -------------------------------------------
		//Emb cost Cost part report here -------------------------------------------

		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5)";
		$data_array=sql_select($sql);
		$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
		$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();

		$totEmb=0;
		$EmbData=array();

		foreach( $data_array as $row ){
			$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
			$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
			$summary_data[emb_cost_job]+=$embamount;
			$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
			$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
			$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
			$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
			$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
			$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
			$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
			$totEmb+=$row[csf("cons_dzn_gmts")];
		}
		//End Emb cost Cost part report here -------------------------------------------
		//Wash cost Cost part report here -------------------------------------------
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3";
		$data_array=sql_select($sql);
		$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
		$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
		foreach( $data_array as $row ){
			$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
			$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
			$summary_data[wash_cost_job]+=$washamount;
			$summary_data[OtherDirectExpenses_job]+=$washamount;
			$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
			$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
			$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
			$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
			$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
			$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
			$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
			$totEmb+=$row[csf("cons_dzn_gmts")];
		}
	//End Wash cost Cost part report here -------------------------------------------

	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
		$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
		$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
		$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
		$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
		$CommiData[$row[csf("id")]]['tot_commission_amount']=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
		$totCommi+=$row[csf("commission_amount")];
		$summary_data[commission_job]+=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	}
	$summary_data[commission_job_per]=($summary_data[commission_job]/$summary_data[price_dzn_job])*100;
	//End Commision cost Cost part report here -------------------------------------------

    //Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
		$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[comm_cost_job]+=$commarcialamount;
		$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
		$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
		$totCommar+=$row[csf("amount")];
    }
	?>
    <div style="width:852px; margin:0 auto">
    <!--    <div style="width:850px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">BOM Report</div>
     -->
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">BOM Report</b>
        </td></tr></table>

        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
        <tr>
            <td width="80">Job Number</td>
            <td width="80"><b><? echo $jobNo; ?></b></td>
            <td width="90">Buyer</td>
            <td width="100"><b><? echo $buyerName; ?></b></td>
            <td width="80">Garments Item</td>
            <td width="100"><b><? echo implode(",",$gmtsItem); ?></b></td>
        </tr>

        <tr>
            <td>Order Qnty </td>
            <td colspan=""><b><? echo $poQtyUom; ?></b></td>
            <td>Excess Cut %</td>
            <td><b><?  echo fn_number_format($excessPer,2) ?></b></td>
            <td>Plan Cut Qty</td>
            <td><b><? echo $poPlunCutQtyUom." ". $unit_of_measurement[$uom];?></b></td>
        </tr>

        <tr>
            <td>Style Ref. No </td>
            <td colspan=""><b><? echo $styleRefNo; ?></b></td>
            <td>Costing Per</td>
            <td><b><? echo $costing_per[$costingPer];?></b></td>
            <td>Price Per Unit</td>
            <td><b><? echo fn_number_format($avg_unit_price,2); ?></b></td>
        </tr>

        <tr>
            <td>Order Numbers</td>
            <td colspan="5"><? echo implode(",",$poNumber); ?></td>
        </tr>

        <tr>
            <td>Shipment Date </td>
            <td><b>  <? echo implode(",",$pubShipDate); ?></b></td>
             <td>Fabric Cons</td>
            <td><b><? echo fn_number_format($totFabQtyAsCostPer,2); ?></b></td>

        </tr>
    </table>
       <?


	//2 Fabric Cost part here-------------------------------------------
	?>
	<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b> Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Total Cons</td>
							<td width="100">UOM</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)/Dzn</td>
							<td width="100">Tot.Amount (USD)</td>
						</tr>
        <?
		foreach( $FabricData as $index=>$row ) {
			    $uom=$row["uom"];
			    $item_descrition =$row['description'];
			    $totalConsWoven=$row["totalConsWoven"];
				$totalAmountWoven=$row["totalAmountWoven"];
				$amount=$row["amount"];
				?>
                <tr>
                    <td align="left"><?  echo $item_descrition;?></td>
                    <td align="left"><?  echo $row["fabric_source"];?></td>
                    <td align="right"><? echo fn_number_format($row["avg_cons"],4);?></td>
					<td align="right"><? echo fn_number_format($totalConsWoven,4);?></td>
					<td align="left"><?  echo $uom; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4);?></td>
                    <td align="right"><? echo fn_number_format($amount,4);?></td>
					<td align="right"><? echo fn_number_format($totalAmountWoven,4);?></td>
                </tr>
                <?
				 $GrandtotalConsWoven+=$totalConsWoven;
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountWoven;
        }
		?>
            <tr class="rpt_bottom" style="font-weight:bold">
            <td colspan="3" align="left">Total</td>
            <td align="right"><? echo fn_number_format(($GrandtotalConsWoven),4);?></td>
            <td></td>
            <td></td>
            <td align="right"><? echo fn_number_format(($GrandtotalDznAmount),4);?></td>
            <td align="right"><? echo fn_number_format(($GrandtotalAmount),4);?></td>
            </tr>
            </table>
            </div>
		<?
		if($zero_value==1){
			echo $woven_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $woven_fab;
			}
			else{
				echo "";
			}
		}
		//end 	All Fabric Cost part report-------------------------------------------
	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name"  );
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmountTrim=0;
			$TotalAmountTrim=0;
            foreach( $TrimData as $index=>$row )
            {

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                     <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountTrim += $row["amount"];
				 $TotalAmountTrim += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmountTrim,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totTrim>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                     <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmountTrim=0;
			$TotalAmountTrim=0;
            foreach( $TrimData as $index=>$row)
            {

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountTrim += $row["amount"];
				 $TotalAmountTrim += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmountTrim,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	 //start	Embellishment Details part report here -------------------------------------------
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmountEmb=0;
		    $TotalAmountEmb =0;
            foreach( $EmbData as $index=>$row )
            {
				$em_type ='';
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountEmb += $row["amount"];
				 $TotalAmountEmb += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmountEmb,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totEmb>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmountEmb=0;
		    $TotalAmountEmb =0;
            foreach( $EmbData as $index=>$row  )
            {
				$em_type ='';
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountEmb += $row["amount"];
				 $TotalAmountEmb += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmountEmb,4); ?></td>
                </tr>
            </table>
      </div>
    <?

		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAountComr=0;
		   $TotalAountComr =0;
            foreach( $CommarData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountComr += $row["amount"];
				 $TotalAountComr += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAountComr,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAountComr,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommar>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAountComr=0;
		   $TotalAountComr =0;
            foreach( $CommarData as $index=>$row  )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountComr += $row["amount"];
				 $TotalAountComr += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                     <td align="right"><? echo fn_number_format($TotalDznAountComr,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAountComr,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------

	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAountCommi = 0;
		    $TotalAountCommi = 0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountCommi += $row["commission_amount"];
				 $TotalAountCommi += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAountCommi,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAountCommi,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAountCommi = 0;
		    $TotalAountCommi = 0;
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo fn_number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo fn_number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountCommi += $row["commission_amount"];
				 $TotalAountCommi += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAountCommi,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAountCommi,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
			$net_fob_value_dzn=$summary_data[price_dzn]-$summary_data[commission];
			$interest_expense_dzn=$net_fob_value_dzn*$financial_para['interest_expense']/100;
			$income_tax_dzn=$net_fob_value_dzn*$financial_para['income_tax']/100;

			$net_fob_value_tot=$summary_data[price_dzn_job]-$TotalAountCommi;
			$interest_expense_tot=$net_fob_value_tot*$financial_para['interest_expense']/100;
			$income_tax_tot=$net_fob_value_tot*$financial_para['income_tax']/100;

			$total_other_components += $summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job]+$summary_data[common_oh_job]+$summary_data[depr_amor_pre_cost_job]+$interest_expense_tot+$income_tax_tot+$TotalAountCommi+$TotalAountComr;
			$dzn_other_components += $summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[common_oh]+$summary_data[depr_amor_pre_cost]+$interest_expense_dzn+$income_tax_dzn+$summary_data[commission]+$summary_data[comm_cost];
            ?>
      <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>CM Cost - IE</b></label>
                <tr style="font-weight:bold">
                    <td width="100">Amount /DZN</td>
                    <td width="100">Amount</td>
                 </tr>
                 <tr>
                    <td width="100" align="right"><? echo fn_number_format($summary_data[cm_cost],4);  ?></td>
                    <td width="100" align="right"><? echo fn_number_format($summary_data[cm_cost_job],4);  ?></td>
                 </tr>
                 </table>
      </div>


        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount</td>
                 </tr>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($summary_data[lab_test_job],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($summary_data[inspection_job],4); ?></td>
                </tr>

                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($summary_data[freight_job],4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($summary_data[currier_pre_cost_job],4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($summary_data[certificate_pre_cost_job],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial Cost </td>
                    <td align="right"><? echo fn_number_format($TotalAountComr,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Operating Expenses</td>
                    <td align="right"><? echo fn_number_format($summary_data[common_oh_job],4); ?></td>
                </tr>
                  <tr>
                    <td align="left">Commission </td>
                    <td align="right"><? echo fn_number_format($TotalAountCommi,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Depreciation & Amortization </td>
                    <td align="right"><? echo fn_number_format($summary_data[depr_amor_pre_cost_job],4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest</td>
                    <td align="right"><? echo fn_number_format($interest_expense_tot,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Income Tax</td>
                    <td align="right"><? echo fn_number_format($income_tax_tot,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">

            <?
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = $GrandtotalAmount+$TotalAmountTrim+$TotalAmountEmb+$summary_data[cm_cost_job]+$total_other_components;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/DZN</td>
                    <td width="100">Total</td>
                 </tr>
                <tr>
                    <td align="left"> Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($GrandtotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($GrandtotalAmount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmountTrim,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmountEmb,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($summary_data[cm_cost],4); ?></td>
                    <td align="right"><? echo fn_number_format($summary_data[cm_cost_job],4); ?></td>
                </tr>
                  <tr>
                    <td align="left">Others Components Cost</td>
                    <td align="right"><? echo fn_number_format($dzn_other_components,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_other_components,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_summary_amount,4); ?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
      </div>
    <br/>
 	<?	 echo signature_table(109, $cbo_company_name, "850px");?>
	</div>
	<?
	exit();
}



if($action=="checkListRpt")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$dealing_marchant_arr=return_library_array( "select id, team_member_name from  lib_mkt_team_member_info",'id','team_member_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	$result =sql_select("select id,po_number,pub_shipment_date,po_received_date,file_no,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
	$job_in_orders = array();
	$pulich_ship_date='';$po_received_date='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders[$val[csf('id')]]= $val[csf('po_number')];
		$pulich_ship_date = $val[csf('pub_shipment_date')];
		$job_in_ref[$val[csf('id')]]= $val[csf('grouping')];
	    $job_in_file[$val[csf('id')]]= $val[csf('file_no')];
		if($po_received_date=='') $po_received_date = change_date_format($val[csf('po_received_date')]);else $po_received_date.=",".change_date_format($val[csf('po_received_date')]);
	}
	$ref_cond=implode(",",array_unique($job_in_ref));
	$po_received_dates=implode(",",array_unique(explode(",",$po_received_date)));
	$file_con=implode(",",$job_in_file);
	$job_in_orders=implode(", ",$job_in_orders);

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0){
	   $sql = "select a.job_no, a.company_name, a.buyer_name,a.dealing_marchant,a.style_ref_no, a.quotation_id, a.ship_mode, a.gmts_item_id, a.order_uom, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, c.costing_date, c.costing_per, c.budget_minute, c.approved, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no, a.company_name, a.buyer_name,a.dealing_marchant, a.style_ref_no, a.quotation_id, a.ship_mode, a.gmts_item_id, a.order_uom, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, c.costing_date, c.costing_per, c.approved, c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	if($db_type==2){
	    $sql = "select a.job_no, a.company_name, a.buyer_name,a.dealing_marchant, a.style_ref_no, a.quotation_id, a.ship_mode, a.gmts_item_id, a.order_uom, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, c.costing_date, c.costing_per, c.budget_minute, c.approved, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no, a.company_name,a.dealing_marchant, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.ship_mode, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, c.costing_date, c.costing_per, c.approved, c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	$data_array=sql_select($sql);
	?>
    <div style="width:852px; margin:0 auto">
	<?

	$order_job_qnty=0;
	$ord_qty=0;
	$avg_unit_price=0;
	$order_values=0;
	$order_price_per_dzn=0;
	$costing_for='';
	foreach ($data_array as $row){
	    $order_job_qnty=$row[csf("job_quantity")];
		$ord_qty=$row[csf("ord_qty")];
		$avg_unit_price=$row[csf("avg_unit_price")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];

		if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
		else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
		else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
		else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
		else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
		?>
        <div style="font-family:'Arial Narrow';">
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">BOM Details</b>
        </td></tr></table>

        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
            <tr>
                <td width="80">Job Number</td>
                <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="90">Buyer</td>
                <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td width="80">Plan Cut Qnty</td>
                <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
            </tr>
            <tr>
                <td>Order Qty</td>
                <td><b><? echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                <td>Style Ref. No</td>
                <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                <td>Price Per Unit</td>
                <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
            </tr>
            <tr>
                <td>Order Numbers</td>
                <td colspan="5"><? echo $job_in_orders; ?></td>
                </tr>
                <tr>
                <td>Garments Item</td>
                <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                <td>Shipment Date</td>
                <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
            </tr>
            <tr>
                <td>Budget Minute</td>
                <td><b><? echo $row[csf("budget_minute")]; ?> </b></td>
                <td align="center" height="10" colspan="2" valign="top" id="app_sms" style="font-size:18px;">
                <font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?></font>
                </td>
                  <td>PO Recv. Date</td>
                <td><b><? echo $po_received_dates; ?> </b></td>

            </tr>
            <tr>
                <td>Internal Ref</td>
                <td><b><? echo ltrim($ref_cond,", "); ?></b></td>
                <td>File No</td>
                <td><b><? echo $file_cond; ?></b></td>
                <td>Dealing Merchant</td>
                <td><b><? echo $dealing_marchant_arr[$row[csf("dealing_marchant")]]; ?></b></td>
            </tr>
             <tr>
                <td>Costing Date</td>
                <td><b><? echo change_date_format($row[csf("costing_date")]); ?></b></td>
                <td>Ship Mode</td>
                <td><b><? echo $shipment_mode[$row[csf("ship_mode")]]; ?></b></td>
                <td>Quotation ID</td>
                <td><b><? echo $row[csf("quotation_id")]; ?></b></td>
            </tr>
            <tr>
                <td colspan="3">Order Repeat No, Order Repeat Job No</td>
                <td colspan="3"><b>
                	<?
                		if($row[csf("repeat_job_no")] !="")
                		{
                			$repeat_job_no=	" , ".$row[csf("repeat_job_no")];
                		}
                		else
                		{
							$repeat_job_no="";
                		}
                		echo $row[csf("order_repeat_no")].$repeat_job_no;

                	?>
                </b></td>

            </tr>
        </table>
            <?
	}//end first foearch

	//2 Fabric Cost part here-------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !="")
	{
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);

	//if($db_type==2) $group_gsm=" listagg(cast(gsm_weight as varchar2(4000)),',') within group (order by  gsm_weight) as gsm_weight, ";
	//else $group_gsm=" group_concat(gsm_weight) as gsm_weight, ";

	$sql = "select id, job_no,item_number_id, body_part_id,gsm_weight, fab_nature_id, color_type_id, fabric_description, avg_cons,uom, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);

		$knit_fab="";
		$knit_subtotal_amount=0;
		$knit_subtotal_amount_dzn=0;

		$woven_fab="";
		$woven_subtotal_amount=0;
		$woven_subtotal_amount_dzn=0;

        $i=5;$j=2;
		foreach( $data_array as $row ){
			$uom=$unit_of_measurement[$row[csf("uom")]];
			$knit_cost_dzn=$row[csf("amount")];
			$woven_cost_dzn=$row[csf("amount")];
			//knit fabrics=============
			$gsm_weight='';
			if($row[csf("fab_nature_id")]==2){
				$gsm_weight.=$row[csf("gsm_weight")].',';
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$gsm_weight;
				$fincons=$fabric_qty['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$amount=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];

 				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($greycons,4).'</td>
 					<td align="right">'.fn_number_format($fincons,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
                </tr>';
				if($row[csf("uom")]==12){
					$knit_subtotal_avg_cons+=$greycons;
					$knit_subtotal_avg_finish_cons+=$fincons;
					$knit_subtotal_amount+=$amount;
					$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				}
				else if($row[csf("uom")]==27){
					$knit_subtotal_avg_cons_yds+=$greycons;
					$knit_subtotal_avg_finish_cons_yds+=$fincons;
					$knit_subtotal_amount_yds+=$amount;
					$knit_subtotal_amount_dzn_yds+=$knit_cost_dzn;
				}
				else if($row[csf("uom")]==1){
					$knit_subtotal_avg_cons_pcs+=$greycons;
					$knit_subtotal_avg_finish_cons_pcs+=$fincons;
					$knit_subtotal_amount_pcs+=$amount;
					$knit_subtotal_amount_dzn_pcs+=$knit_cost_dzn;
				}
				else if($row[csf("uom")]==23){
					$knit_subtotal_avg_cons_mtr+=$greycons;
					$knit_subtotal_avg_finish_cons_mtr+=$fincons;
					$knit_subtotal_amount_mtr+=$amount;
					$knit_subtotal_amount_dzn_mtr+=$knit_cost_dzn;
				}
			}
			//woven fabrics======================
			$gsm_weights='';
			if($row[csf("fab_nature_id")]==3){
				$fincons=$fabric_qty['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$amount=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$gsm_weights.=$row[csf("gsm_weight")].',';
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$gsm_weights;
				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($greycons,4).'</td>
 					<td align="right">'.fn_number_format($fincons,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
                </tr>';
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$amount;
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
			}
        }

	 	if(0>=$knit_subtotal_avg_finish_cons) $i=$i-1;
		if(0>=$knit_subtotal_avg_finish_cons_yds) $i=$i-1;
		if(0>=$knit_subtotal_avg_finish_cons_pcs) $i=$i-1;
		if(0>=$knit_subtotal_avg_finish_cons_mtr) $i=$i-1;

		//$woven_subtotal_avg_finish_cons
		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="100">Gray Fabric Qnty</td>
							<td width="100">Finish Fab Qnty</td>
							<td width="50">UOM</td>
 							<td width="50">Rate</td>
							<td width="50">Amount</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr><td colspan="8">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		if($knit_subtotal_avg_finish_cons>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (kg)</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons,4).'</td>
							<td align="right"></td>
							<td align="right">'.fn_number_format($knit_subtotal_amount/$knit_subtotal_avg_cons,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
						</tr>';
		}

		if($knit_subtotal_avg_finish_cons_yds>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (Yds)</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yds,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_yds,4).'</td>
							<td align="right"></td>
							<td align="right">'.fn_number_format($knit_subtotal_amount_yds/$knit_subtotal_avg_cons_yds,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_amount_yds,4).'</td>
						</tr>';
		}
		if($knit_subtotal_avg_finish_cons_pcs>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (Pcs)</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_cons_pcs,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_pcs,4).'</td>
							<td align="right"></td>
							<td align="right">'.fn_number_format($knit_subtotal_amount_pcs/$knit_subtotal_avg_cons_pcs,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_amount_pcs,4).'</td>
						</tr>';
		}
		if($knit_subtotal_avg_finish_cons_mtr>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (Mtr)</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_cons_mtr,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_mtr,4).'</td>
							<td align="right"></td>
							<td align="right">'.fn_number_format($knit_subtotal_amount_mtr/$knit_subtotal_avg_cons_mtr,4).'</td>
							<td align="right">'.fn_number_format($knit_subtotal_amount_mtr,4).'</td>
						</tr>';
		}
  		echo $knit_fab;

		//woven fabrics table here

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount/$woven_subtotal_avg_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
					</tr>
   					</table></div>';
        echo $woven_fab;

		//end 	All Fabric Cost part report-------------------------------------------

		//Start	Yarn Cost part report here -------------------------------------------
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
		$sql = "select min(id) as id, count_id, copm_one_id, percent_one,  color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one,  color,type_id, rate";
		$data_array=sql_select($sql);
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($rowcons_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($rowavgcons_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($rowamount,4); ?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_yarn_qty,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_avg_yarn_qty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?

	//End Yarn Cost part report here -------------------------------------------

	//start	Conversion Cost to Fabric report here -------------------------------------------
    $conv_data['conv_qnty']=$conversion->getQtyArray_by_conversionid();
	$conv_data['conv_amount']=$conversion->getAmountArray_by_conversionid();
	$sql_count = "select a.cons_process as cons_process, b.uom from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 group by a.cons_process, b.uom order by  a.cons_process";
	$tot_data_array=sql_select($sql_count); $uom_arr=array();
	foreach( $tot_data_array as $row ){
			 $process_id=$row[csf("cons_process")];
			 $process_row+=count($row[csf("cons_process")]);
			 $uom_arr[$row[csf("uom")]]=$row[csf("uom")];
	 }
	 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id,b.uom from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by  a.cons_process";
	 $data_array=sql_select($sql);


 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+(count($uom_arr))+($process_row*count($uom_arr))+1; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Required</td>
                    <td width="100">UOM</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
            $total_conversion_cost=0;
			$total_conversion_cost_dzn=0;
			$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;
			$grand_total_conv_qnty=0;
			$grand_total_avg_convsion_qty=0;
			$grand_total_conversion_cost=0;

			$total_conversion_cost_yds=0;
			$total_conversion_cost_dzn_yds=0;
			$total_conversion_cost_kg_yds=0;
			$total_convsion_qty_yds=0;
			$total_avg_convsion_qty_yds=0;
			$grand_total_conv_qnty_yds=0;
			$grand_total_avg_convsion_qty_yds=0;
			$grand_total_conversion_cost_yds=0;

			$process_array_check=array();
			$k=1;
            foreach( $data_array as $row )
            {
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) ){
					if($k!=1){
						if($total_convsion_qty>0)
						{
						?>
					    <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Kg): </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty,4); ?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost,4); ?></strong></td>
						</tr>
                        <? }
						if($total_convsion_qty_yds>0) { ?>
                        <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Yds): </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty_yds,4); ?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost_yds,4); ?></strong></td>
						</tr>
                        <? }
						if($total_convsion_qty_pcs>0) { ?>
                        <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Pcs): </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty_pcs,4); ?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost_pcs,4); ?></strong></td>
						</tr>
                        <? }
						if($total_convsion_qty_mtr>0) { ?>
                        <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Mtr): </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty_mtr,4); ?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost_mtr,4); ?></strong></td>
						</tr>
						<?
						}
					}
					unset($total_convsion_qty);
					unset($total_avg_convsion_qty);
					unset($total_conversion_cost);
					unset($total_convsion_qty_yds);
					unset($total_avg_convsion_qty_yds);
					unset($total_conversion_cost_yds);

					unset($total_convsion_qty_pcs);
					unset($total_avg_convsion_qty_pcs);
					unset($total_conversion_cost_pcs);
					unset($total_convsion_qty_mtr);
					unset($total_avg_convsion_qty_mtr);
					unset($total_conversion_cost_mtr);
					$process_array_check[]=$process_id;
					$k++;
				}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>

                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]],4); ?></td>
                    <td align=""><? echo $unit_of_measurement[$row[csf("uom")]]; //fn_number_format($conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]],4); ?></td>
                </tr>
            <?
			if($row[csf('uom')]==12){
				$total_convsion_qty+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn+=$row[csf('amount')];
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
			}
			if($row[csf('uom')]==27){
				$total_convsion_qty_yds+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost_yds += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty_yds+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost_yds+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn_yds+=$row[csf('amount')];
				$total_conversion_cost_kg_yds=$grand_total_conversion_cost_yds/$total_avg_yarn_qty_yds;
			}
			if($row[csf('uom')]==1){
				$total_convsion_qty_pcs+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost_pcs += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty_pcs+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost_yds+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn_pcs+=$row[csf('amount')];
				$total_conversion_cost_kg_pcs=$grand_total_conversion_cost_pcs/$total_avg_yarn_qty_pcs;
			}
			if($row[csf('uom')]==23){
				$total_convsion_qty_mtr+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost_mtr += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty_mtr+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost_mtr+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn_mtr+=$row[csf('amount')];
				$total_conversion_cost_kg_mtr=$grand_total_conversion_cost_pcs/$total_avg_yarn_qty_mtr;
			}
            }
			if($total_convsion_qty>0)
			{
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td>&nbsp;</td>
					<td align="right">Sub. Total (Kg)</td>
					<td align="right"><? echo fn_number_format($total_convsion_qty,4); ?></td>
					<td align="right"><? // echo fn_number_format($total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo fn_number_format($total_conversion_cost,4); ?></td>
				</tr>
            <? }
            if($total_convsion_qty_yds>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total (Yds)</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty_yds,4); ?></td>
                <td align="right"><? // echo fn_number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($total_conversion_cost_yds,4); ?></td>
            </tr>
             <? }
            if($total_convsion_qty_pcs>0)
			{ ?>
           <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total (Pcs)</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty_pcs,4); ?></td>
                <td align="right"><? // echo fn_number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($total_conversion_cost_pcs,4); ?></td>
            </tr>
            <? }
            if($total_convsion_qty_mtr>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total (Mtr)</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty_mtr,4); ?></td>
                <td align="right"><? // echo fn_number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($total_conversion_cost_mtr,4); ?></td>
            </tr>
            <? }
            if($grand_total_conv_qnty>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total(Kg)</td>
                <td align="right"><? echo fn_number_format($grand_total_conv_qnty,4); ?></td>
                <td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
            </tr>
            <? }
            if($grand_total_conv_qnty_yds>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total (Yds)</td>
                <td align="right"><? echo fn_number_format($grand_total_conv_qnty_yds,4); ?></td>
                <td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost_yds,4); ?></td>
            </tr>
             <? }
            if($grand_total_conv_qnty_pcs>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total (Pcs)</td>
                <td align="right"><? echo fn_number_format($grand_total_conv_qnty_pcs,4); ?></td>
                <td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost_pcs,4); ?></td>
            </tr>
            <? }
            if($grand_total_conv_qnty_mtr>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total (Mtr)</td>
                <td align="right"><? echo fn_number_format($grand_total_conv_qnty_mtr,4); ?></td>
                <td align="right"><? //echo fn_number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost_mtr,4); ?></td>
            </tr>
            <? } ?>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -----------------------------------



	//start	Trims Cost part report here -------------------------------------------
	//last $sql="select distinct a.id, a.job_no, a.trim_group,a.description,a.brand_sup_ref, a.cons_uom, a.cons_dzn_gmts, a.rate, a.amount, a.apvl_req, a.nominated_supp,a.status_active,b.cons,b.excess_per,b.tot_cons from wo_pre_cost_trim_cost_dtls a,wo_pre_cost_trim_co_cons_dtls b where a.id=b.wo_pre_cost_trim_cost_dtls_id and a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0";

	$sql ="select b.id as po, a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts, d.rate as avgrate,d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_trim_cost_dtls d, wo_pre_cost_trim_co_cons_dtls e where a.job_no =".$txt_job_no." and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and b.id=c.po_break_down_id and b.id=e.po_break_down_id and d.id=e.wo_pre_cost_trim_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 group by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id,d.rate,b.id order by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id";

	$item_size_sql=sql_select( "select b.job_no_mst,b.size_number_id,b.order_quantity from wo_po_color_size_breakdown b where b.job_no_mst=".$txt_job_no." group by b.size_number_id,b.job_no_mst,b.order_quantity");
	$item_size_array=array();
	$lib_size=return_library_array( "select size_name,id from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	foreach($item_size_sql as $row)
	{
		//$item_size_array[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("item_size")]]=$row[csf("item_size")].'='.$row[csf("tot_cons")];
		$item_size_array[$row[csf("job_no_mst")]].=$row[csf("size_number_id")].",";
	}


	//echo "select job_no,size_number_id,rate from wo_pre_cost_trim_co_cons_dtls where job_no=".$txt_job_no."";
	$rate_size_sql=sql_select("select wo_pre_cost_trim_cost_dtls_id,job_no,size_number_id,rate from wo_pre_cost_trim_co_cons_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0");

	$rate_size_array=array();
	foreach($rate_size_sql as $row)
	{
		//$item_size_array[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("item_size")]]=$row[csf("item_size")].'='.$row[csf("tot_cons")];
		$rate_size_array[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("size_number_id")]]=$row[csf("size_number_id")].'='.$row[csf("rate")];
	}

	//$sql = "select a.id, a.job_no, a.trim_group,a.description,a.brand_sup_ref, a.cons_uom, a.cons_dzn_gmts, a.rate, a.amount, a.apvl_req, a.nominated_supp,a.status_active,b.size_number_id from wo_pre_cost_trim_cost_dtls a, wo_pre_cost_trim_co_cons_dtls b   where a.job_no=b.job_no and a.id=b.wo_pre_cost_trim_cost_dtls_id and  a.job_no=".$txt_job_no." group by a.id, a.job_no, a.trim_group,a.description,a.brand_sup_ref, a.cons_uom, a.cons_dzn_gmts, a.rate, a.amount, a.apvl_req, a.nominated_supp,a.status_active,b.size_number_id order by a.id";

    	$sql = "select id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi, remark,status_active,seq from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array=sql_select($sql);
		$nominated_supplier_data=sql_select("SELECT supplier_id, trimid, is_company from wo_pre_cost_trim_supplier where status_active=1 and is_deleted=0 and job_no=".$txt_job_no."");
		$trim_wise_supplier=array();
		foreach($nominated_supplier_data as $row){
			if($row[csf('is_company')]==1){
				$trim_wise_supplier[$row[csf('trimid')]][$row[csf('supplier_id')]]=$comp[$row[csf('supplier_id')]];
			}
			else{
				$trim_wise_supplier[$row[csf('trimid')]][$row[csf('supplier_id')]]=$supplier_name_arr[$row[csf('supplier_id')]];
			}
			
		}
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                	<td width="20">SL.</td>
                    <td width="80">Accessories</td>
                    <td width="80">Description</td>
                    <td width="80">Supplier</td>
                    <td width="30">UOM</td>
                    <td width="70">Cons. QTY</td>
                    <td width="50">Ex. %</td>
                    <td width="50">Ex. Qnty</td>
                    <td width="80">Total Qnty</td>
                    <td width="150">Rate</td>
                    <td width="50">Amount</td>
                    <td width="150">Accessories Details</td>
                    <td width="80">Remarks</td>
                </tr>
            <?
			$trim_qty=$trim->getQtyArray_by_precostdtlsid_consAndTotcons();
			$trim_amount=$trim->getAmountArray_precostdtlsid();
			$trim_detail=$trim->getQtyArray_by_precostdtlsidAndGmtssize_consAndTotcons();
			$trim_detail_amount=$trim->getAmountArray_by_precostdtlsidAndGmtssize_consAndTotcons();
			//print_r($trim_qty);
            $total_trims_cost=0;
			$total_trims_qty=0;
			$total_trims_cost_dzn=0;
			$total_trims_cost_kg=0;
			$i=1;
			$cbo_costing_per=str_replace("'",'',$cbo_costing_per);

			if($cbo_costing_per==1) $costing_per=12;
			else if($cbo_costing_per==2) $costing_per=1;
			else if($cbo_costing_per==3) $costing_per=24;
			else if($cbo_costing_per==4) $costing_per=36;
			else $costing_per=48;

            foreach( $data_array as $row ){
				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$totcons=$trim_qty[$row[csf("id")]]['totcons'];
				$cons=$trim_qty[$row[csf("id")]]['cons'];
				$excess=$cons-$totcons;
				$excessper=$excess/$totcons*100;
				$amount=$trim_amount[$row[csf("id")]];
				$nominated_supp_str="";
				$nominated_supp_str=implode(", ", $trim_wise_supplier[$row[csf('id')]]);

			?>
                <tr>
                	<td><? echo $i;?></td>
                    <td align="left" style="word-break: break-all;word-wrap: break-word;"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left" style="word-break: break-all;word-wrap: break-word;"><? echo $row[csf("description")]; ?></td>
                    <td align="left" style="word-break: break-all;word-wrap: break-word;"><?=$nominated_supp_str; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><?  echo fn_number_format($totcons,4); ?></td>
                    <td align="right"><? echo fn_number_format($excessper,0); ?></td>
                    <td align="right"><? echo fn_number_format($excess,4);  ?></td>
                    <td align="right"><?  echo  fn_number_format($cons,4) ?></td>
                    <td align="right">
					  <table>
                    <?

					foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
						$size_amount=$trim_detail_amount[$row[csf("id")]][$key]['cons'];
					?>
                    <tr>
                    <td align="right"><? echo $lib_size[$key].":".fn_number_format($size_amount/$value['cons'],4);?></td>
                    </tr>
                     <?
					}
					?>
                    </table>
                    </td>
                    <td align="right"><?  echo  fn_number_format($amount,4); ?></td>
                    <td align="right">
                    <table>
                    <?
					foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
					?>
                    <tr>
                    <td align="right"> <? echo $lib_size[$key].":".fn_number_format($value['cons'],4);?></td>
                    </tr>
                     <?
					}
					?>
                    </table>

					<?
					/*	$html='';
						 $size_arr=rtrim($item_size_array[$row[csf("job_no")]],",");
						$size_arr=array_unique(explode(",",$size_arr));
						$size_qty=0;
						foreach($rate_size_array[$row[csf("wo_pre_cost_trim_cost_dtls_id")]] as $val){

							$value=explode("=",$val);
							$size_qty=$trim_detail[$row[csf("po")]][$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$value[0]];
							$html.=','.$lib_size[$value[0]]."<b>:</b>".fn_number_format($size_qty,2)." ".$unit_of_measurement[$row[csf("cons_uom")]];

						}
						echo ltrim($html,',');*/

					 ?>
                     </td>
                    <td style="word-break: break-all;word-wrap: break-word;"><? echo $row[csf("remark")]; ?></td>
                </tr>
            <?
                 $total_trims_cost+= $amount;
				 $total_trims_qty += $cons;
				 $i++;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="10" align="right">Total &nbsp; </td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
                 <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="10" align="right">Avg Price Of Accessories &nbsp;</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost/$ord_qty,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------



	 //start	Embellishment Details part report here -------------------------------------------
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Gmts. Qnty (Dzn)</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
            $total_embellishment_amt=0;
			$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {

				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				if($row[csf("emb_name")] !=3){
				$cons_dzn_gmts=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
				$amount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
				}
				else if($row[csf("emb_name")] ==3){
				$cons_dzn_gmts=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
				$amount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
				}
				$total_embellishment_amt_dzn += $row[csf("amount")];
				//$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$order_job_qnty;
				//$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$order_job_qnty;
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($cons_dzn_gmts); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_embellishment_amt += $amount;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$total_commercial_cost_dzn+= $row[csf("amount")];

				$amount = $row[csf("amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_commercial_cost += $amount;

            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount = $row[csf("commission_amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($commission_amount,4); ?></td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	//End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, common_oh, common_oh_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, design_cost, design_percent, studio_cost, studio_percent from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_other_components=0; $lab_test_dzn=0; $lab_test = 0; $inspection = 0; $cm_cost = 0; $freight = 0; $common_oh = 0; $design_cost =0; $studio_cost =0;
            foreach( $data_array as $row )
            {
				$lab_test = $row[csf("lab_test")]/$order_price_per_dzn*$ord_qty;
				$inspection = $row[csf("inspection")]/$order_price_per_dzn*$ord_qty;
				$cm_cost = $row[csf("cm_cost")]/$order_price_per_dzn*$ord_qty;
				$freight = $row[csf("freight")]/$order_price_per_dzn*$ord_qty;
				$common_oh = $row[csf("common_oh")]/$order_price_per_dzn*$ord_qty;
				$currier_pre_cost = $row[csf("currier_pre_cost")]/$order_price_per_dzn*$ord_qty;
				$certificate_pre_cost = $row[csf("certificate_pre_cost")]/$order_price_per_dzn*$ord_qty;
				$design_cost =$row[csf("design_cost")]/$order_price_per_dzn*$ord_qty;
				$studio_cost =$row[csf("studio_cost")]/$order_price_per_dzn*$ord_qty;

				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];

				$design_cost_dzn =$row[csf("design_cost")];
				$studio_cost_dzn =$row[csf("studio_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
   			?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Design Cost</td>
                    <td align="right"><? echo fn_number_format($design_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Studio Cost</td>
                    <td align="right"><? echo fn_number_format($studio_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
            <?
                 $total_other_components += $lab_test+$inspection+$cm_cost+$design_cost+$studio_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">

            <?
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
		$path=($path)?$path:'../../';
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = 0;
            $total_summary_amount = $total_commission_cost+$total_commercial_cost+$total_embellishment_amt+$total_trims_cost+$design_cost+$studio_cost+$grand_total_conversion_cost+$total_yarn_amount +$woven_subtotal_amount+$knit_subtotal_amount+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:500px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/DZN</td>
                    <td width="100">Cost/Kg</td>
                    <td width="100">Total</td>
                 </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (kg) </td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount/$knit_subtotal_avg_cons,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Knit Fabric (Purchase) (Yds)</td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_yds/$knit_subtotal_avg_cons_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_yds,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (Pcs)</td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn_pcs,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_pcs/$knit_subtotal_avg_cons_pcs,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_pcs,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (Mtr)</td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_dzn_mtr,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_mtr/$knit_subtotal_avg_cons_mtr,4); ?></td>
                    <td align="right"><? echo fn_number_format($knit_subtotal_amount_mtr,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Woven Fabric (Purchase)</td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount/$woven_subtotal_avg_cons,4); ?></td>
                    <td align="right"><? echo fn_number_format($woven_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Yarn</td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_yarn_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric (Kg)</td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($grand_total_conversion_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric (Yds)</td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_dzn_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_conversion_cost_kg_yds,4); ?></td>
                    <td align="right"><? echo fn_number_format($grand_total_conversion_cost_yds,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo fn_number_format($total_trims_cost_dzn,4); ?></td>
                    <td align="right" rowspan="13"><? //echo fn_number_format($total_trims_cost_kg,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Design Cost</td>
                    <td align="right"><? echo fn_number_format($design_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($design_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Studio Cost</td>
                    <td align="right"><? echo fn_number_format($studio_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($studio_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_embellishment_amt,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial</td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commercial_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commission</td>
                    <td align="right"><? echo fn_number_format($total_commission_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_commission_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($common_oh_dzn,4); ?></td>
                    <td align="right"><? echo fn_number_format($common_oh,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_summary_amount,4); ?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
      </div>
      <!--End CM on Net Order Value Part report here -->
	</div>
     <?  echo signature_table(109, $cbo_company_name, "870px");?>
    </div>
	<?
	exit();
}

if($action=='accessories_details')
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");


	$result =sql_select("select id,po_number,pub_shipment_date,file_no,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
	$job_in_orders = array();
	$pulich_ship_date='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders[$val[csf('id')]]= $val[csf('po_number')];
		$pulich_ship_date = $val[csf('pub_shipment_date')];
		$job_in_ref[$val[csf('id')]]= $val[csf('grouping')];
	    $job_in_file[$val[csf('id')]]= $val[csf('file_no')];
	}
	$ref_cond=implode(",",array_unique($job_in_ref));
	$file_con=implode(",",$job_in_file);
	$job_in_orders=implode(", ",$job_in_orders);

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0){
	   $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_date,c.costing_per,c.budget_minute,c.approved,   d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.ship_mode,a.gmts_item_id,a.order_uom, a.avg_unit_price,c.costing_date,c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	if($db_type==2){
	    $sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_date,c.costing_per,c.budget_minute,c.approved,d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom,a.ship_mode, a.avg_unit_price,c.costing_date, c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg  order by a.job_no";
	}
	$data_array=sql_select($sql);
	ob_start();
		?>
		<html>
    <div style="width:1052px; margin:0 auto">
    <div style="width:1050px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:1050px; font-size:14px; font-weight:bold" align="center">Accessories Details</div>
	<?

	$order_job_qnty=0;
	$ord_qty=0;
	$avg_unit_price=0;
	$order_values=0;
	$order_price_per_dzn=0;
	$costing_for='';
	foreach ($data_array as $row){
	    $order_job_qnty=$row[csf("job_quantity")];
		$ord_qty=$row[csf("ord_qty")];
		$avg_unit_price=$row[csf("avg_unit_price")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];

		if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
		else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
		else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
		else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
		else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
		?>
        <div style="font-family:'Arial Narrow';">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1050px; font-family:Arial Narrow" rules="all">
            <tr>
                <td width="80">Job Number</td>
                <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="90">Buyer</td>
                <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td width="80">Plan Cut Qnty</td>
                <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
            </tr>
            <tr>
                <td>Order Qty</td>
                <td><b><? echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                <td>Style Ref. No</td>
                <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                <td>Price Per Unit</td>
                <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
            </tr>
            <tr>
                <td>Order Numbers</td>
                <td colspan="5"><? echo $job_in_orders; ?></td>
                </tr>
                <tr>
                <td>Garments Item</td>
                <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                <td>Shipment Date</td>
                <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
            </tr>
            <tr>
                <td>Budget Minute</td>
                <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;">
                <font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?></font>
                </td>
            </tr>
            <tr>
                <td>Internal Ref</td>
                <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                <td>File No</td>
                <td colspan="2"><b><? echo $file_cond; ?></b></td>
            </tr>
             <tr>
                <td>Costing Date</td>
                <td colspan="2"><b><? echo change_date_format($row[csf("costing_date")]); ?></b></td>
                <td>Ship Mode</td>
                <td colspan="2"><b><? echo $shipment_mode[$row[csf("ship_mode")]]; ?></b></td>
            </tr>
        </table>
            <?
	}//end first foearch

	//2 Fabric Cost part here-------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !="")
	{
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	//$fabric= new fabric($condition);
	//$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	//$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	//$yarn= new yarn($condition);
	//$conversion= new conversion($condition);
	$trim= new trims($condition);
	//$emblishment= new emblishment($condition);
	//$wash= new wash($condition);








	//start	Trims Cost part report here -------------------------------------------
	$sql ="select b.id as po, a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts, d.rate as avgrate,d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id,e.item_color_number_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_trim_cost_dtls d, wo_pre_cost_trim_co_cons_dtls e where a.job_no =".$txt_job_no." and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and b.id=c.po_break_down_id and b.id=e.po_break_down_id and d.id=e.wo_pre_cost_trim_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 group by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id,d.rate,b.id order by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id,e.item_color_number_id";



	$item_size_sql=sql_select( "select b.job_no_mst,b.size_number_id,b.order_quantity from wo_po_color_size_breakdown b where b.job_no_mst=".$txt_job_no." group by b.size_number_id,b.job_no_mst,b.order_quantity");
	$item_size_array=array();
	$lib_size=return_library_array( "select size_name,id from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	foreach($item_size_sql as $row)
	{
		$item_size_array[$row[csf("job_no_mst")]].=$row[csf("size_number_id")].",";
	}


	$rate_size_sql=sql_select("select wo_pre_cost_trim_cost_dtls_id,job_no,size_number_id,rate,item_color_number_id,color_number_id from wo_pre_cost_trim_co_cons_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0");

	$rate_size_array=array();$trims_item_color=array();
	foreach($rate_size_sql as $row)
	{
		$rate_size_array[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("size_number_id")]]=$row[csf("size_number_id")].'='.$row[csf("rate")];
		$trims_item_color[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("item_color_number_id")]]=$color_library[$row[csf("item_color_number_id")]]."<br>";
		$trims_gmts_color[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("color_number_id")]]=$color_library[$row[csf("color_number_id")]]."<br>";
	}



     	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,remark,status_active,seq,nominated_supp_multi,item_print from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1350px;text-align:center; font-family:Arial Narrow" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Accessories</td>
                    <td width="150">Description</td>
                    <td width="50">UOM</td>
					<td width="100">GMTS Color</td>
					<td width="100">Item Color</td>
                     <td width="50">Cons./Unit</td>
                    <td width="100">Cons.QTY</td>
                    <td width="50">Ex. %</td>
                    <td width="50">Ex. Qnty</td>
                    <td width="80">Total Qnty</td>
                    <td width="200">Rate</td>
                    <td width="50">Amount</td>
                    <td width="200">Accessories Details</td>
                    <td width="100">Brand/Sup Ref</td>
					<td width="100">Supplier</td>
					<td width="100">Item Print</td>
                    <td width="120">Remarks</td>
                </tr>
            <?
			$trim_qty=$trim->getQtyArray_by_precostdtlsid_consAndTotcons();
			$trim_amount=$trim->getAmountArray_precostdtlsid();
			$trim_detail=$trim->getQtyArray_by_precostdtlsidAndGmtssize_consAndTotcons();
			$trim_detail_amount=$trim->getAmountArray_by_precostdtlsidAndGmtssize_consAndTotcons();

            $total_trims_cost=0;
			$total_trims_qty=0;
			$total_trims_cost_dzn=0;
			$total_trims_cost_kg=0;
			$i=1;
			$cbo_costing_per=str_replace("'",'',$cbo_costing_per);

			if($cbo_costing_per==1)
				{

					$costing_per=12;
				}
				else if($cbo_costing_per==2)
				{

					$costing_per=1;
				}
				else if($cbo_costing_per==3)
				{

					$costing_per=24;
				}
				else if($cbo_costing_per==4)
				{

					$costing_per=36;
				}
				else
				{

					$costing_per=48;
				}
				$total_size_level=0;
        foreach( $data_array as $row ){
				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$totcons=$trim_qty[$row[csf("id")]]['totcons'];
				$cons=$trim_qty[$row[csf("id")]]['cons'];
				$excess=$cons-$totcons;
				$excessper=$excess/$totcons*100;
				$amount=$trim_amount[$row[csf("id")]];

					$nominated_supp_str="";
						 $exnominated_supp=explode(",",$row[csf('nominated_supp_multi')]);
						 $n=1;
						 foreach($exnominated_supp as $supp)
						 {

							 if($n==1){
								$nominated_supp_str =$supplier_name_arr[$supp];
								$n++;

							 }else{
								$nominated_supp_str .=$supplier_name_arr[$supp].",";
							 }
						 }

			?>
                <tr>
                	<td><? echo $i;?></td>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>

                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
					<td align="left"><? echo implode(" ",$trims_gmts_color[$row[csf("id")]]); ?></td>
					<td align="left"><? echo implode(" ",$trims_item_color[$row[csf("id")]]); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><?  echo fn_number_format($totcons,4); ?></td>
                    <td align="right"><? echo fn_number_format($excessper,0); ?></td>

                    <td align="right"><? echo fn_number_format($excess,4);  ?></td>
                    <td align="right"><?  echo  fn_number_format($cons,4) ?></td>
                    <td align="right">
					  <table>
                    <?
					foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
						$size_amount=$trim_detail_amount[$row[csf("id")]][$key]['cons'];

					?>
                    <tr>
                    <td align="right"><? echo $lib_size[$key].":".fn_number_format($size_amount/$value['cons'],4);?></td>
                    </tr>
                     <?

					}
					?>
                    </table>
                    </td>
                    <td align="right"><?  echo  fn_number_format($amount,4); ?></td>
                    <td align="right">
                    <table>
                    <?
					foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
						$total_size_level+=$value['cons'];
					?>
                    <tr>
                    <td align="right"> <? echo $lib_size[$key].":".fn_number_format($value['cons'],4);?></td>
                    </tr>
                     <?
					}
					?>
                    </table>
                     </td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
					<td align="left"><? echo $nominated_supp_str; ?></td>
					<td align="left"><? echo $itemPrintArr[$row[csf("item_print")]]; ?></td>
                    <td><? echo $row[csf("remark")]; ?></td>
                </tr>
            <?
                 $total_trims_cost+= $amount;
				 $total_trims_qty += $row[csf("cons_dzn_gmts")];
				 $total_qnty+=$cons;
				 $i++;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="10">Total </td>
					<td align="right"><? echo fn_number_format( $total_qnty,4); ?></td>
					<td align="right"></td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
					<td align="right"><? echo fn_number_format($total_size_level,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------
	?>
	</div>
     <?  echo signature_table(109, $cbo_company_name, "1050px");?>
    </div>
	 </html>
	 <?
	 $user_id=$_SESSION['logic_erp']['user_id'];
	 $report_cat=100;
	 $html = ob_get_contents();
		 ob_clean();
		 //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
		 foreach (glob("tb*.xls") as $filename) {
		 //if( @filemtime($filename) < (time()-$seconds_old) )
		 @unlink($filename);
		 }
		 //---------end------------//
		 $name=time();
		 $filename="tb".$user_id."_".$name.".xls";
		 $create_new_doc = fopen($filename, 'w');
		 $is_created = fwrite($create_new_doc, $html);
		 echo "$filename****$html****$report_cat";
	exit();
}



if($action=='accessories_details2')
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	//get_submitted_data_string('txt_job_no*cbo_company_name*cbo_buyer_name*txt_style_ref*txt_costing_date*txt_po_breack_down_id*cbo_costing_per',"../../")
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);

	$txt_costing_date=change_date_format($txt_costing_date,'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no='".$txt_job_no."'";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no='".$txt_style_ref."'";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$season_name_arr=return_library_array( "select id, season_name from  lib_buyer_season",'id','season_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	$result =sql_select("select id,po_number,pub_shipment_date,file_no,grouping from wo_po_break_down where job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
	$job_in_orders = array();
	$pulich_ship_date='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders[$val[csf('id')]]= $val[csf('po_number')];
		$pulich_ship_date = $val[csf('pub_shipment_date')];
		$job_in_ref[$val[csf('id')]]= $val[csf('grouping')];
	    $job_in_file[$val[csf('id')]]= $val[csf('file_no')];
	}
	$ref_cond=implode(",",array_unique($job_in_ref));
	$file_cond=implode(",",array_unique($job_in_file));
	$job_in_orders=implode(", ",$job_in_orders);

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no='$txt_job_no'");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0){
	   $sql = "select a.job_no,a.season_buyer_wise,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_date,c.costing_per,c.budget_minute,c.approved,   d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.season_buyer_wise,a.company_name, a.buyer_name,a.style_ref_no, a.ship_mode,a.gmts_item_id,a.order_uom, a.avg_unit_price,c.costing_date,c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	if($db_type==2){
	    $sql = "select a.job_no,a.season_buyer_wise,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_date,c.costing_per,c.budget_minute,c.approved,d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.season_buyer_wise,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom,a.ship_mode, a.avg_unit_price,c.costing_date, c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg  order by a.job_no";
	}
	$data_array=sql_select($sql);
	//echo $sql;die;
	?>
<!--    <div style="width:1052px; margin:0 auto">
    <div style="width:1050px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:1050px; font-size:14px; font-weight:bold" align="center">Accessories Details V2</div>
-->	<?

	$order_job_qnty=0;
	$ord_qty=0;
	$avg_unit_price=0;
	$order_values=0;
	$order_price_per_dzn=0;
	$costing_for='';
	foreach ($data_array as $row){
	    $order_job_qnty=$row[csf("job_quantity")];
		$ord_qty=$row[csf("ord_qty")];
		$avg_unit_price=$row[csf("avg_unit_price")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];

		if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
		else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
		else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
		else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
		else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
		?>
        <div style="font-family:'Arial Narrow';">
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='$cbo_company_name'","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Accessories Details V2</b>
        </td></tr></table>
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1050px; font-family:Arial Narrow" rules="all">
            <tr>
                <td width="80">Job Number</td>
                <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="90">Buyer</td>
                <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td width="80">Plan Cut Qnty</td>
                <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
            </tr>
            <tr>
                <td>Order Qty</td>
                <td><b><? echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                <td>Style Ref. No</td>
                <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                <td>Price Per Unit</td>
                <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
            </tr>
            <tr>
                <td>Order Numbers</td>
                <td colspan="5"><? echo $job_in_orders; ?></td>
                </tr>
                <tr>
                <td>Garments Item</td>
                <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                <td>Shipment Date</td>
                <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
            </tr>
            <tr>
                <td>Budget Minute</td>
                <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;">
                <font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?></font>
                </td>
            </tr>
            <tr>
                <td>Internal Ref</td>
                <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                <td>File No</td>
                <td colspan="2"><b><? echo $file_cond; ?></b></td>
            </tr>
             <tr>
                <td>Costing Date</td>
                <td><b><? echo change_date_format($row[csf("costing_date")]); ?></b></td>
                <td>Ship Mode</td>
                <td><b><? echo $shipment_mode[$row[csf("ship_mode")]]; ?></b></td>
                <td>Season</td>
                <td><b><? echo $season_name_arr[$row[csf("season_buyer_wise")]]; ?></b></td>
            </tr>
        </table>
            <?
	}//end first foearch

	//2 Fabric Cost part here-------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("='$txt_job_no'");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !="")
	{
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	//$fabric= new fabric($condition);

	//$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	//$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	//$yarn= new yarn($condition);
	//$conversion= new conversion($condition);
	$trim= new trims($condition);
	//$emblishment= new emblishment($condition);
	//$wash= new wash($condition);

	//start	Trims Cost part report here -------------------------------------------
	$sql ="select b.id as po, a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts, d.rate as avgrate,d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_trim_cost_dtls d, wo_pre_cost_trim_co_cons_dtls e where a.job_no ='".$txt_job_no."' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and b.id=c.po_break_down_id and b.id=e.po_break_down_id and d.id=e.wo_pre_cost_trim_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 group by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id,d.rate,b.id order by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id";

	$item_size_sql=sql_select( "select b.job_no_mst,b.size_number_id,b.order_quantity from wo_po_color_size_breakdown b where b.job_no_mst='".$txt_job_no."' group by b.size_number_id,b.job_no_mst,b.order_quantity");
	$item_size_array=array();
	$lib_size=return_library_array( "select size_name,id from lib_size where status_active=1 and is_deleted=0", "id", "size_name");

	foreach($item_size_sql as $row)
	{
		$item_size_array[$row[csf("job_no_mst")]].=$row[csf("size_number_id")].",";
	}



	$rate_size_sql=sql_select("select wo_pre_cost_trim_cost_dtls_id,job_no,size_number_id,rate from wo_pre_cost_trim_co_cons_dtls where job_no='".$txt_job_no."' and status_active=1 and is_deleted=0");

	$rate_size_array=array();
	foreach($rate_size_sql as $row)
	{
		$rate_size_array[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("size_number_id")]]=$row[csf("size_number_id")].'='.$row[csf("rate")];
	}


    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,remark,status_active,seq from wo_pre_cost_trim_cost_dtls  where job_no='".$txt_job_no."' and status_active=1 and is_deleted=0 order by seq";
		$data_array=sql_select($sql);
		$rate_amt_colspn=10;
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1050px;text-align:center; font-family:Arial Narrow" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Accessories</td>
                    <td width="150">Description</td>
                    <td width="50">UOM</td>
                     <td width="50">Cons./Unit</td>
                    <td width="100">Cons.QTY</td>
                    <td width="50">Ex. %</td>
                    <td width="50">Ex. Qty</td>
                    <td width="80">Total Qty</td>
                    <? if($rate_amt==2) { $rate_amt_colspn=8; ?>
                    <td width="200">Rate</td>
                    <td width="50">Amount</td>
                     <? } ?>
                    <td width="200">Accessories Details</td>
                    <td width="100">Supplier</td>
                    <td width="200">Remarks</td>
                </tr>
            <?

            $get_item_size=sql_select("SELECT b.item_size, b.wo_pre_cost_trim_cost_dtls_id, b.size_number_id from wo_pre_cost_trim_cost_dtls a join wo_pre_cost_trim_co_cons_dtls b on a.id=b.wo_pre_cost_trim_cost_dtls_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$txt_job_no."' group by b.item_size, b.wo_pre_cost_trim_cost_dtls_id, b.size_number_id");
            foreach ($get_item_size as $row) {
            	if($row[csf('item_size')]!='' && $row[csf('item_size')]!=0)
            	{
            		if($item_size_arr[$row[csf('wo_pre_cost_trim_cost_dtls_id')]][$row[csf('size_number_id')]] !='')
            		{
            			$item_size_arr[$row[csf('wo_pre_cost_trim_cost_dtls_id')]][$row[csf('size_number_id')]].= ",".$row[csf('item_size')];
            		}
            		else{
            			$item_size_arr[$row[csf('wo_pre_cost_trim_cost_dtls_id')]][$row[csf('size_number_id')]].=$row[csf('item_size')];
            		}

            	}
            	else{
            		$item_size_arr[$row[csf('wo_pre_cost_trim_cost_dtls_id')]][$row[csf('size_number_id')]]= $lib_size[$row[csf('size_number_id')]];
            	}
            }

			$trim_qty=$trim->getQtyArray_by_precostdtlsid_consAndTotcons();
			$trim_amount=$trim->getAmountArray_precostdtlsid();
			$trim_detail=$trim->getQtyArray_by_precostdtlsidAndGmtssize_consAndTotcons();
			$trim_detail_amount=$trim->getAmountArray_by_precostdtlsidAndGmtssize_consAndTotcons();
			//print_r($trim_qty);
            $total_trims_cost=0;
			$total_trims_qty=0;
			$total_trims_cost_dzn=0;
			$total_trims_cost_kg=0;
			$i=1;

			if($cbo_costing_per==1) $costing_per=12;
			else if($cbo_costing_per==2) $costing_per=1;
			else if($cbo_costing_per==3) $costing_per=24;
			else if($cbo_costing_per==4) $costing_per=36;
			else $costing_per=48;

            foreach( $data_array as $row )
			{
				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$totcons=$trim_qty[$row[csf("id")]]['totcons'];
				$cons=$trim_qty[$row[csf("id")]]['cons'];
				$excess=$cons-$totcons;
				$excessper=$excess/$totcons*100;
				$amount=$trim_amount[$row[csf("id")]];
				?>
                <tr>
                	<td><? echo $i;?></td>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><?  echo fn_number_format($totcons,4); ?></td>
                    <td align="right"><? echo fn_number_format($excessper,0); ?></td>
                    <td align="right"><? echo fn_number_format($excess,4);  ?></td>
                    <td align="right"><?  echo  fn_number_format($cons,4) ?></td>
                    <? if($rate_amt==2) { ?>
                    <td align="right">
                        <table>
                        <?
                        foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
                            $size_amount=$trim_detail_amount[$row[csf("id")]][$key]['cons'];
                            //$lib_size[$key]
							?>
							<tr>
								<td align="right"><? echo $item_size_arr[$row[csf("id")]][$key].":".fn_number_format($size_amount/$value['cons'],4);?></td>
							</tr>
							<?
                        }
                        ?>
                        </table>
                    </td>
                    <td align="right"><? echo fn_number_format($amount,4); ?></td>
                    <? } ?>
                    <td align="right">
                    <table>
                    <?
					foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
					?>
                    <tr>
                    <td align="right"> <? echo $item_size_arr[$row[csf("id")]][$key].":".fn_number_format($value['cons'],4);?></td>
                    </tr>
                     <?
					}
					?>
                    </table>
                     </td>
                    <td align="left"><? echo $supplier_name_arr[$row[csf("nominated_supp")]]; ?></td>
                    <td><? echo $row[csf("remark")]; ?></td>
                </tr>
            	<?
                 $total_trims_cost+= $amount;
				 $total_trims_qty += $row[csf("cons_dzn_gmts")];
				 $i++;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="<? echo $rate_amt_colspn; ?>">Total </td>
                    <td align="right"><? echo fn_number_format($total_trims_cost,4); ?></td>
                </tr>
            </table>
            <br/>

            <?
            $color_size_sql= "select a.po_number,a.id as po_id,b.color_number_id,b.size_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."'  and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1group by a.po_number,a.id,b.size_number_id,b.color_number_id";

			$result_color=sql_select($color_size_sql);
			$color_size_array=array();
			foreach($result_color as $row)
			{
				$color_size_array[$row[csf("po_id")]][$row[csf("color_number_id")]]=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['po_qty']=$row[csf("order_quantity")];
				$po_array[$row[csf("po_id")]]['po_no']=$row[csf("po_number")];
			}
			$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 group by b.size_number_id";

			$result_size=sql_select($size_sql);
			$posize_array=array();
			foreach($result_size as $row)
			{
				$posize_array[$row[csf("size_number_id")]]=$row[csf("size_number_id")];
			}

			$po_rowspan_arr=array();
			foreach($color_size_array as $pokey=>$po_data)
			{
				$po_row_span=0;
				foreach($po_data as $colorkey=>$val)
				{
					$po_row_span++;
				}
				$po_rowspan_arr[$pokey]=$po_row_span;
			}

		//print_r($po_rowspan_arr);
			?>
            <br/>
             <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1050px;text-align:center; font-family:Arial Narrow" rules="all">
            <label><b>Color Size Breakdown:</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">PO NO</td>
                    <td width="120">Color</td>
					   <?
                    foreach ($posize_array as $sizid)
                    {
                        //$size_count=count($sizid);
                        ?>
                            <th width="60"><strong><? echo  $lib_size[$sizid];  ?></strong></th>
                        <?
                    }
                    ?>
                    <td> Color Total</td>
                    </tr>
                    <?
					$k=1; $total_qnty=0;
                    foreach ($color_size_array as $pokey=>$po_data)
					{
						$m=1;
						foreach ($po_data as $colorkey=>$color_data)
						{
							$po_rowspan=$po_rowspan_arr[$pokey];
							?>
							<tr>
								<?
                                if($m==1)
                                {
									?>
									<td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
									<td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>
									<?
                                }
                                ?>
                                <td align="left"><? echo $color_library[$colorkey]; ?></td>
                                <?
                                $po_size_qty=0;$tot_qnty=array();
                                foreach ($posize_array as $sizval)
                                {
									$size_count=count($sizval);
									$po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty']
									?>
									<td align="right"><? echo fn_number_format($po_size_qty,0); ?></td>
									<?
									$tot_qnty[$pokey][$cid]+=$po_size_qty;
									$tot_qnty_size[$sizval]+=$po_size_qty;
                                }
                                ?>
                                <td align="right"><? echo fn_number_format($tot_qnty[$pokey][$cid],0); ?></td>
							</tr>
							<?
							$total_qnty+=$tot_qnty[$pokey][$cid];
							$m++;
						}
						$k++;
					}
					?>
                    <tr>
                    <td colspan="3" align="right"><strong>Grand Total :</strong></td>
                    <?
					foreach ($posize_array as $sizval)
					{
						?>
						<td align="right"><?php echo fn_number_format($tot_qnty_size[$sizval],0); ?></td>
						<?
					}
                    ?>
                    <td align="right"><?php echo fn_number_format($total_qnty,0); ?></td>
                </tr>
               </table>
      </div>
    <?  echo signature_table(159, $cbo_company_name, "1050px");
 	exit();
}

if($action=='mo_sheet') //Aziz-13-5-18
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);
	$excess_per_val=str_replace("'","",$excess_per_val);
	//echo $excess_val.'dd';
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		//$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and a.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and d.po_break_down_id in(".$txt_po_breack_down_id.")";
		//$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");

	$result =sql_select("select a.job_no,a.buyer_name,a.style_ref_no,a.ship_mode, a.order_uom,a.gmts_item_id,a.total_set_qnty,b.id,b.po_number,b.po_received_date,b.pub_shipment_date,b.file_no,b.grouping,c.costing_date,c.costing_per from wo_po_details_master a,wo_po_break_down b,wo_pre_cost_mst c where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst  and c.job_no=a.job_no  and b.job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond and b.status_active=1 and b.is_deleted=0 order by b.pub_shipment_date DESC");

	$job_in_orders = array();$job_in_ship_arr = array();
	$pulich_ship_date='';$shipment_date_arr='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders_arr[$val[csf('id')]]= $val[csf('po_number')];
		$job_in_ship_arr[$val[csf('id')]]= $val[csf('pub_shipment_date')];
		$job_in_recvDate_arr[$val[csf('id')]]= change_date_format($val[csf('po_received_date')]);
		$job_in_ref_arr[$val[csf('id')]]= $val[csf('grouping')];
		$job_in_file_arr[$val[csf('id')]]= $val[csf('file_no')];
		$job_total_set_qnty_arr[$val[csf('job_no')]]= $val[csf('total_set_qnty')];

		$gmts_item_id=$val[csf('gmts_item_id')];
		$order_uom=$val[csf('order_uom')];
		$shipment_date_arr.=change_date_format($val[csf('pub_shipment_date')]).',';

		$job_no=$val[csf('job_no')];
		$buyer_name=$buyer_arr[$val[csf('buyer_name')]];
		$style_ref_no=$val[csf('style_ref_no')];

		$costing_date=$val[csf('costing_date')];
		$costing_per_name=$costing_per[$val[csf('costing_per')]];
	}
	//echo $txt_po_breack_down_id_cond.'DSD';
	$ref_cond=implode(",",array_unique($job_in_ref_arr));
	$file_con=implode(",",array_unique($job_in_file_arr));
	$shipment_date=rtrim($shipment_date_arr,',');
	$shipment_date=implode(",",array_unique(explode(",",$shipment_date)));

	$recv_date=implode(",",array_unique($job_in_recvDate_arr));
	//$shipment_date=implode(",",array_unique($job_in_ship_arr));
	$job_in_orders=implode(", ",$job_in_orders_arr);

	?>
	<style type="text/css" media="print">
   table { page-break-inside:auto; }

        @media print {
        thead {display: table-header-group;}
    }
	@media print {
				table {
					page-break-inside: avoid;
				}
			}
	</style>
	 <div style="width:1100px; margin:0 auto">
	<!--    <div style="width:1100px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
	    <div style="width:1100px; font-size:14px; font-weight:bold" align="center">MO Sheet</div>
	-->
	<br>

	 <div style="font-family:'Arial Narrow';">
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='$cbo_company_name'","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">MO Sheet</b>
        </td></tr></table>

        <table style="width:560px; font-family:Arial Narrow" border="0" >
			<table width="50%"  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<tr>
					<td width="80">Job No</td>
					<td width="80"><b><? echo $job_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Buyer</td>
					<td width="80"><b><? echo $buyer_name; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO  Number</td>
					<td width="80"><b><? echo $job_in_orders; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Style Number</td>
					<td width="80"><b><? echo $style_ref_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Item</td>
					<td width="80"><b><?
						$gmts_item=''; $gmts_item_id=explode(",",$gmts_item_id);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=", ".$garments_item[$item_id];
							}
							echo $gmts_item;
					 ?></b></td>
				</tr>
				  <tr>
					<td width="80">Shipment Date</td>
					<td width="80"><b><? echo $shipment_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO Receive Date</td>
					<td width="80"><b><? echo $recv_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Costing Date</td>
					<td width="80"><b><? echo change_date_format($costing_date); ?></b></td>
				</tr>
					<td width="90">Costing Per</td>
					<td width="100"><b><? echo $costing_per_name; ?></b></td>

				</tr>
			</table>
			<table style="float:right; margin-top:-230px;"  width="350px" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<caption><b> Item's View</b></caption>

				 <?
						// image show here  -------------------------------------------
						$sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id='$txt_job_no' and file_type=1";
						$photo_data_array=sql_select($sql);
						$path=($path)?$path:'../../';
					 ?>
					 	<tr>
						<td align="center">
							 <div style="margin:15px 5px;float:right;width:500px;"  >

							<? foreach($photo_data_array AS $inf){ ?>

								<img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='80' width='80' />

							<?  } ?>

						  </div>

					</td>
				</tr>
			</table>

		</table>
		<br/>
		<?
		 $color_size_sql= "select a.po_number,a.id as po_id,b.item_number_id,b.color_number_id,b.size_number_id,avg(b.excess_cut_perc) as excess_cut_perc,sum(b.plan_cut_qnty) as plan_cut_qnty,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."'  and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by a.po_number,a.id,b.size_number_id,item_number_id,b.color_number_id order by b.item_number_id,b.size_number_id ";

			$result_color=sql_select($color_size_sql);
			$color_size_array=array();
			foreach($result_color as $row)
			{
				$color_size_array[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]]=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['po_qty']=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['plan_cut_qnty']=$row[csf("plan_cut_qnty")];
				$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity']=$row[csf("order_quantity")];
				//$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['tot_row']+=0;
				if($row[csf("excess_cut_perc")]>0)
				{
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['excess_cut_perc']=$row[csf("excess_cut_perc")];
				}
				$po_array[$row[csf("po_id")]]['po_no']=$row[csf("po_number")];
				$po_array[$row[csf("po_id")]]['item_number_id']=$row[csf("item_number_id")];

				$po_color_array[$row[csf("po_id")]][$row[csf("item_number_id")]]['color_number_id'].=$row[csf("color_number_id")].',';
				$item_color_size_array[$row[csf("item_number_id")]][$row[csf("color_number_id")]]+=$row[csf("order_quantity")];
			}



			//$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst=".$txt_job_no." and  b.is_deleted=0 and b.status_active=1 group by b.size_number_id";
		$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity,sum(b.plan_cut_qnty) as plan_cut_qnty from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by b.size_number_id,b.size_order order by b.size_order";

			$result_size=sql_select($size_sql);
			$posize_array=array();
			foreach($result_size as $row)
			{
				$posize_array[$row[csf("size_number_id")]]=$row[csf("size_number_id")];
			}

			$po_rowspan_arr=array();$po_item_rowspan_arr=array();
			foreach($color_size_array as $pokey=>$po_data)
			{
				$po_row_span=0;
				foreach($po_data as $itemkey=>$item_data)
				{
					$item_row_span=0;$color_row_span=0;
					foreach($item_data as $colorkey=>$val)
					{
						$item_row_span++;
						$po_row_span++;
						//$po_item_color_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
						$color_row_span++;
					}
					$itempo_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
					$po_item_rowspan_arr[$pokey][$itemkey]=$item_row_span;
					$po_rowspan_arr[$pokey]=$po_row_span;

				}
			}

			//print_r($itempo_rowspan_arr);
			?>
            <br/>
			<div style="width:1100px;">
             <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:auto;text-align:center; font-family:Arial Narrow" rules="all">
            <label style="text-align:center"><b>Size and Color  Breakdown:</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Buyer PO</td>
					<td width="110">Item</td>
                    <td width="120">Color</td>
					   <?
                    foreach ($posize_array as $sizid)
                    {
                        //$size_count=count($sizid);
                        ?>
                            <th width="60"><strong><? echo  $size_library[$sizid];  ?></strong></th>
                        <?
                    }
                    ?>
                    <td  width="80"> Total Order Qty.</td>
					<td  width="60"> Ex.Cut %</td>
					<td  width="80">Plan Cut Qty</td>
                    </tr>
                    <?
					$k=1; $total_qnty=$total_plan_qnty=0;$grd_total_qnty=$grd_total_plan_qnty=0;
                    foreach ($color_size_array as $pokey=>$po_data)
					{
						$m=1;
						foreach ($po_data as $itemkey=>$item_data)
						{
							$n=1;
							foreach ($item_data as $colorkey=>$color_data)
							{
								$po_rowspan=$po_rowspan_arr[$pokey];
								$item_po_rowspan=$po_item_rowspan_arr[$pokey][$itemkey];
								$item_po_rowspan_row=$itempo_rowspan_arr[$itemkey][$colorkey];

								$color_number_id=rtrim($po_color_array[$pokey][$itemkey]['color_number_id']);
								$color_ids=explode(",",$color_number_id);
								$color_row=count($color_row);
								//echo $color_row.', ';
							?>
							<tr>
								<?
                                if($m==1)
                                {
									?>
									<td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
									<td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>
									<?
                                }
								if($n==1)
                                {
									?>
									<td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $garments_item[$itemkey]; ?></td>
									<?
                                }
                                ?>

                                <td align="left"><? echo $color_library[$colorkey]; ?></td>
                                <?
                                $po_size_qty=0;$tot_qnty=array();
                                foreach ($posize_array as $sizval)
                                {
									$size_count=count($sizval);
									$po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty'];
									$plan_cut_qnty=$po_size_qty_array[$pokey][$colorkey][$sizval]['plan_cut_qnty'];
									$excess_cut_perc=$po_size_qty_array[$pokey][$colorkey][$sizval]['excess_cut_perc'];
									$tot_excess_cut_per[$pokey][$colorkey]+=$excess_cut_perc;
									?>
									<td align="right"><? echo fn_number_format($po_size_qty,0); ?></td>
									<?
									$tot_qnty[$pokey][$colorkey]+=$po_size_qty;
									$tot_plan_qnty[$pokey][$colorkey]+=$plan_cut_qnty;
									$tot_qnty_size[$sizval]+=$po_size_qty;
									$tot_qnty_item_size[$sizval]+=$po_size_qty;
									$grd_tot_qnty_size[$sizval]+=$po_size_qty;
									$size_tot_qty+=$item_color_size_array[$pokey][$itemkey][$colorkey];
                                }

								//if($n==1)
                                //{
									$tot_excess_cut_per=(($tot_plan_qnty[$pokey][$colorkey]-$tot_qnty[$pokey][$colorkey])/$tot_qnty[$pokey][$colorkey])*100;
									?>

									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_qnty[$pokey][$colorkey],0); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_excess_cut_per,2); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_plan_qnty[$pokey][$colorkey],0); ?></td>
									<?
                                //}
								?>

							</tr>
							<?
							$total_qnty+=$tot_qnty[$pokey][$colorkey];
							$total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$total_item_qnty+=$tot_qnty_item_size[$pokey][$colorkey];
							$grd_total_qnty+=$tot_qnty[$pokey][$colorkey];
							$grd_total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$m++;$n++;
							}

							?>

						  <?
						}
						?>
					 <tr>
						<td colspan="4" align="right"><strong>PO Sub Total :</strong></td>
						<?
						foreach ($posize_array as $sizval)
						{
							?>
							<td align="right"><b><?php echo fn_number_format($tot_qnty_size[$sizval],0);unset($tot_qnty_size[$sizval]); ?></b></td>
							<?
						}
						?>
						<td align="right"><b><?php echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php //echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php echo fn_number_format($total_plan_qnty,0);unset($total_plan_qnty); ?></b></td>
					</tr>
						<?
					  $k++;
					}
					?>
                    <tr>
                    <td colspan="4" align="right"><strong>Job Total :</strong></td>
                    <?
					foreach ($posize_array as $sizval)
					{
						?>
						<td align="right"><b><?php echo fn_number_format($grd_tot_qnty_size[$sizval],0); ?></b></td>
						<?
					}
                    ?>
                    <td align="right"><b><?php echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php //echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php echo fn_number_format($grd_total_plan_qnty,0); ?></b></td>
                </tr>
               </table>
			   </div>
			   <br/>
			  <br/>
            <table id="table_header_1" class="rpt_table" width="1100" cellpadding="0" cellspacing="0" border="1" rules="all">
           				<caption> <b style="float:left">Fabric Details :</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Gmt Item</th>
						<th width="120">Fab. Nature</th>
						<th width="120">Body Part</th>
						<th width="200">Fab. Desc</th>
						<th width="100">Gmt Color</th>
						<th width="100">Fab. Color</th>
					    <th width="50">UOM</th>
						<th width="90">Fin. Cons</th>
						<th width="90">Total Fin Cons. </th>
						<th width="90">Fab. Source</th>

                    </thead>
            </table>
			<table class="rpt_table"   width="1100" cellpadding="0" cellspacing="0" border="1" rules="all" id="table_body1">
                    <?
				$condition= new condition();
				 if($txt_po_breack_down_id!='' || $txt_po_breack_down_id!=0)
				 {
					$condition->po_id("in($txt_po_breack_down_id)");
				 }
				  if(str_replace("'","",$txt_job_no)!='')
				 {
					$condition->job_no("in('$txt_job_no')");
				 }

				$condition->init();
				$costPerArr=$condition->getCostingPerArr();
				$costPerQty=$costPerArr[$txt_job_no];
				//echo $costPerQty.'DDDDDDD';
				$fabric= new fabric($condition);
				$trims= new trims($condition);
				$emblishment= new emblishment($condition);
				$wash= new wash($condition);
				$fabric_qty_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();

					//($plan_cut_qnty/$total_set_qnty)*($cons_qnty/$costPerQty);
			//	print_r($trims_qty_arr);
				$sql_fab_color="select d.pre_cost_fabric_cost_dtls_id as fab_dtl_id,d.gmts_color_id,d.contrast_color_id from wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_color_dtls d
				 where c.job_no=d.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and c.job_no='$txt_job_no'";
				   $fab_result=sql_select($sql_fab_color);
				 foreach($fab_result as $row)
				 {
					$fab_color_arr[$row[csf("fab_dtl_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
				 }

					$sql_fab="select  a.color_number_id as color_id,a.item_number_id  as item_id,b.id as po_id,b.po_quantity,b.po_total_price, b.po_number, b.pub_shipment_date,c.id, c.job_no,c.body_part_id as body_id, c.fab_nature_id as nat_id, c.color_type_id as color_type, c.construction as construction,c.composition,c.fabric_source,c.gsm_weight,c.body_part_id,c.color_size_sensitive,c.width_dia_type, c.avg_cons,c.uom,c.rate, c.amount, c.avg_finish_cons,d.dia_width,d.requirment,d.cons from wo_po_color_size_breakdown a, wo_po_break_down b,wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d  where a.job_no_mst=b.job_no_mst and  c.job_no=a.job_no_mst and  a.po_break_down_id=b.id and c.job_no=a.job_no_mst and d.pre_cost_fabric_cost_dtls_id=c.id and d.po_break_down_id=a.po_break_down_id and d.po_break_down_id=b.id and d.color_size_table_id=a.id and d.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no_mst='$txt_job_no' and d.cons>0 $txt_po_breack_down_id_cond   order  by a.item_number_id,c.body_part_id ";
				  $sql_fabs_result=sql_select($sql_fab);
				  $fabric_detail_arr=array();  $fabric_job_check_arr=array();
				$total_purchase_amt=0;
				foreach($sql_fabs_result as $row)
				{
					$color_size_sensitive=$row[csf("color_size_sensitive")];
					if($color_size_sensitive==3)
					{
						if($fab_color_arr[$row[csf("id")]][$row[csf("color_id")]]!='')
						{
							$fab_color_id=$fab_color_arr[$row[csf("id")]][$row[csf("color_id")]];
						}
					}
					else  $fab_color_id=$row[csf("color_id")];

					$fab_des=$row[csf("construction")].', '.$row[csf("composition")];
					$item_desc= $fab_des.",".$row[csf("gsm_weight")].",".$row[csf("dia_width")].",".$fabric_typee[$row[csf("width_dia_type")]].",".$color_type[$row[csf("color_type")]];
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['gmt_color'].=$row[csf("color_id")].',';
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['uom']=$row[csf("uom")];
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_id']=$row[csf("item_id")];
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['body_id']=$row[csf("body_id")];
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['nat_id']=$row[csf("nat_id")];
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fabric_source']=$row[csf("fabric_source")];
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_desc']=$item_desc;
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fin_cons']+=$row[csf("cons")];
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['consRow']+=1;
					$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['amount']+=$row[csf("amount")];

				}
				 // print($fabric_detail_arr);
					$item_rowspan_arr=array();$fab_rowspan_arr=array();

					foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
					{
						 $fab_body_rowspan=0;
						  foreach($fab_dtls_data as $fab_color_key=>$val)
						  {
							$fab_body_rowspan++;
						  }
						$fab_rowspan_arr[$fab_dtls_id_key]=$fab_body_rowspan;
					 }
					//print_r($fab_rowspan_arr);

					$i=$m=1;$total_greycons=$total_tot_greycons=$total_tot_fin_cons=$grand_total_fin_cons=$grand_total_tot_greycons=$grand_total_amount=0;

						foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
						{
					  	$y=1;
					 	 foreach($fab_dtls_data as $fab_color_key=>$val)
					 	 {

								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

								$uom_key=$val['uom'];
								$body_key=$val['body_id'];
								$item_key=$val['item_id'];
								$desc_key=$val['item_desc'];
								$nat_key=$val['nat_id'];$fab_source_key=$val['fabric_source'];
								$gmt_color=rtrim($val['gmt_color'],',');
								$gmt_colorid=array_unique(explode(",",$gmt_color));
								$gmt_color="";
								$wv_fincons=$fincons_knit=$tot_amount=0;
								foreach($gmt_colorid as $gid)
								{
									if($gmt_color=="") $gmt_color=$color_library[$gid];else $gmt_color.=",".$color_library[$gid];

									$fincons_knit+=$fabric_qty_arr['knit']['finish'][$fab_dtls_id_key][$gid][$uom_key];
									$wv_fincons+=$fabric_qty_arr['woven']['finish'][$fab_dtls_id_key][$gid][$uom_key];
								}
								$tot_fin_qty=$fincons_knit+$wv_fincons;
					?>

						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">  <?
                      	 if($y==1){
						?>
							<td width="30" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key]?>"><? echo $m; ?></td>
							<td width="100" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $garments_item[$item_key]; ?></td>
							<td width="120" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $item_category[$nat_key]; ?></td>
							<td width="120" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key];;?>" align="center"><div style="word-break:break-all"><? echo $body_part[$body_key]; ?></div></td>
                             <?
							 }

							?>

							<td width="200" align="center" ><div style="word-break:break-all"><? echo $desc_key; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $gmt_color; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $color_library[$fab_color_key]; ?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['uom']]; ?></td>
							<td width="90"  align="right">
                            <div style="word-break:break-all">
							<?

							 echo fn_number_format($val['fin_cons']/$val['consRow'],4);
							 ?>
                            </div>
                            </td>
                            <td width="90"  align="right"><div style="word-break:break-all"><? echo fn_number_format($tot_fin_qty,4); ?></div></td>
							<td width="90"  align="center"><div style="word-break:break-all"><? echo $fabric_source[$fab_source_key]; ?></div></td>

                            </tr>
                            <?
								$total_fin_cons+=$tot_fin_qty;
								$total_tot_fin_cons+=$val['fin_cons'];
								$grand_total_fin_cons+=$tot_fin_qty;

									$y++;
									$i++;
									}
								$m++;
							?>
                            <?

						}
							?>
                            <tfoot>
                            <tr>
                            <th colspan="8" ><strong>Grand Total</strong> </th>

                            <th align="right"><strong><? //echo fn_number_format($total_tot_fin_cons,4);?></strong> </th>
                            <th align="right"><strong><? echo fn_number_format($grand_total_fin_cons,4);?></strong> </th>
							<th><strong>&nbsp;</strong> </th>
                            </tr>
                            </tfoot>
                    </table>
					<br/>
					<?
					$item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
					$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id  and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

					$trims_qty_arr=$trims->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
					$trims_item_qty_arr=$trims->getQtyArray_by_jobAndItemid();
					$trims_desc_qty_arr=$trims->getQtyArray_by_jobItemidAndDescription();

					$trims_dtl_qty_arr=$trims->getQtyArray_by_OrderPrecostdtlsidGmtscolorAndGmtssize();
					//print_r($trims_amt_arr);

				 $sql_trim_color="select c.id,c.job_no,c.trim_group,c.description,c.brand_sup_ref,c.nominated_supp_multi as nominated_supp,c.cons_uom,c.remark,d.wo_pre_cost_trim_cost_dtls_id as fab_dtl_id,d.item_size,d.color_number_id,d.item_number_id,d.size_number_id,d.po_break_down_id as po_id,d.excess_per,d.cons,d.tot_cons,c.source_id from wo_pre_cost_trim_cost_dtls c,wo_pre_cost_trim_co_cons_dtls d
				 where c.job_no=d.job_no and d.wo_pre_cost_trim_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and d.cons>0 and c.job_no='$txt_job_no' $txt_po_breack_down_id_cond2 order by c.id,c.trim_group";
				 //echo  $sql_trim_color;
				 $trim_result=sql_select($sql_trim_color);$tot_trim_req_qty=0;
				 foreach($trim_result as $row)
				 {
					if($excess_per_val>0)
					{
						$total_set_qnty=$job_total_set_qnty_arr[$row[csf('job_no')]];
						$order_quantity=$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity'];
						//echo $plan_cut_qnty.'<br/>';
						$tot_cons_qnty=$row[csf("tot_cons")]+($row[csf("tot_cons")]*$excess_per_val)/100;
						$trim_req_qty=($order_quantity/$total_set_qnty)*($tot_cons_qnty/$costPerQty);
						$excess_per=$excess_per_val;
						//echo $trim_req_qty.'='.$excess_per_val.', ';
						//$tot_trim_req_qty+=$trim_req_qty;
					}
					else
					{
						$excess_per=0;
						$excess_per=$row[csf("excess_per")];
						$tot_cons_qnty=$row[csf("cons")];
						//$trim_req_qty=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
						$trim_req_qty=$trims_dtl_qty_arr[$row[csf("po_id")]][$row[csf("id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					}
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['description']=$row[csf("description")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['nominated_supp']=$row[csf("nominated_supp")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['size_number_id']=$row[csf("size_number_id")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['job_no']=$row[csf("job_no")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_size']=$row[csf("item_size")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['remark']=$row[csf("remark")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_uom']=$row[csf("cons_uom")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons']=$row[csf("tot_cons")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['source_id']=$row[csf("source_id")];

					//$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trim_req_qty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_cons']=$tot_cons_qnty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['excess_per']=$excess_per;
					$item_tot_qty_arr[$row[csf("trim_group")]][$row[csf("description")]]+=$trim_req_qty;

				 }
				// echo $tot_trim_req_qty.', ';
				  	foreach($trims_color_arr as $trim_key=>$trim_data)
					 {
						  $trim_color_rowspan=0;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						   $trim_desc_rowspan=0;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
								$item_size_rowspan=0;
								foreach($color_data as $size_key=>$val)
								{
									$item_size_rowspan++;
									$trim_desc_rowspan++;
									$trim_color_rowspan++;
								}
								$item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]=$item_size_rowspan;
								$trim_desc_rowspan_arr[$trim_key][$desc_key]=$trim_desc_rowspan;
								$trim_size_rowspan_arr[$trim_key]=$trim_color_rowspan;
							}
						   }
					}
				 	//print_r($trim_size_rowspan_arr);
					?>
           		 <table id="table_header_1" class="rpt_table" width="1120" cellpadding="0" cellspacing="0" border="1" rules="all">
           			<caption> <b style="float:left">Trims Details:</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Item</th>
						<th width="120">Description</th>
						<th width="100">Remarks</th>
						<th width="100">Source</th>
						<th width="100">Supplier</th>
						<th width="100">Gmt Color</th>
						<th width="100">Item Size</th>

					    <th width="50">UOM</th>
						<th width="80">Cons</th>
						<th width="80">Exs %</th>
						<th width="80">Total Cons. </th>
						<th width="80">Total Qty </th>

						<th width="80">Color Total Qty.</th>

                    </thead>
					<tbody>
					 <?

						 $j=1;$total_trim_cons=$total_tot_trim_cons_qty=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
						 foreach($trims_color_arr as $trim_key=>$trim_data)
					 	 {
						   $k=1;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						    $n=1;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
						    $m=1;
						     foreach($color_data as $size_key=>$val)
					 	     {
								if($j%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								if($col_size_cons_arr[$trim_key][$gmt_color_key]>0)
								{
								$tot_size_qty=$col_size_cons_arr[$trim_key][$gmt_color_key];
								}
								if($item_tot_cons_arr[$trim_key]>0)
								{
								$item_tot_size_qty=$item_tot_cons_arr[$trim_key];
								}
								$job_no=$val['job_no'];
								$item_size=$val['item_size'];
								$tot_size_cons=$val['tot_size_cons'];

								$gmt_item_desc_qty=$item_tot_qty_arr[$trim_key][$desc_key];//$trims_desc_qty_arr[$job_no][$trim_key][$desc_key];
								//$gmt_item_desc_qty=$trims_item_qty_arr[$job_no][$trim_key];
								$gmt_size_qty=$tot_size_cons;//$trims_qty_arr[$job_no][$trim_key][$desc_key][$gmt_color_key][$size_key];
								//$item_tot_qty=$item_tot_qty_arr[$trim_key][$desc_key];

								$nominated_supp_str="";
								$exsupp=explode(",",$val["nominated_supp"]);
								foreach($exsupp as $sid)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
								}


					?>

						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $j; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $j; ?>">  <?
                      	 if($k==1){
						?>
							<td width="30" rowspan="<? echo $trim_size_rowspan_arr[$trim_key]?>"><? echo $j; ?></td>
							<td width="100" rowspan="<?  echo $trim_size_rowspan_arr[$trim_key];?>"><? echo $item_group_arr[$trim_key]; ?></td>
							 <?

							 }
							//$tot_gmt_size_qty=0;


							  if($n==1){

							 ?>
							<td width="120" rowspan="<?  echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"><? echo  $desc_key; ?></td>

							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center"><div style="word-break:break-all"><? echo $val['remark']; ?></div></td>

							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center"><div style="word-break:break-all"><? echo $commission_particulars[$val['source_id']]; ?></div></td>

							<td width="100"  rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" ><div style="word-break:break-all"><?=$nominated_supp_str; ?></div></td>
                             <?
							 }

							if($m==1){

							?>
                            <td width="100" rowspan="<? echo $item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"  align="center"><div style="word-break:break-all"><? echo $color_library[$gmt_color_key]; ?></div></td>
							<?
							}
							?>
                            <td width="100" title="<?=$size_key?>"  align="center"><div style="word-break:break-all"><?=$size_key?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['cons_uom']]; ?></td>
							<td width="80"  align="center"><div style="word-break:break-all"><? echo fn_number_format($val['cons'],4); ?></div></td>

                            <td width="80"  align="right" title="<? echo $val['excess_per']; ?>"><div style="word-break:break-all"><? echo fn_number_format($val['excess_per'],4);//echo fn_number_format($val['excess_per'],4); ?></div></td>

							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($val['tot_cons'],4); ?></div></td>
							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($gmt_size_qty,4); ?></div></td>
							<?
							//if($m==1){
							?>

							<?
							//}
							?>
							<?
							if($n==1){
							 $total_tot_item_qty_cons+=$gmt_item_desc_qty;
							?>
                            <td width="80" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"  align="center"><div style="word-break:break-all"><? echo  fn_number_format($gmt_item_desc_qty,4); ?></div></td>
							<?
							}
							?>

                       </tr>
					   <?
					   		$total_tot_trim_cons_qty+=$val['cons'];
							$total_trim_cons+=$val['tot_cons'];
							$total_trim_qty_cons+=$gmt_size_qty;
							$k++;$m++;$n++;

					   		}
							?>

							<?
						    }

						   }

						  $j++;
					   	}
					   ?>
						<tfoot>
						<tr>
							<th colspan="8" align="right"> Grand Total </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_trim_cons_qty,4); ?> </th>

							<th align="right"> <? //echo fn_number_format($total_tot_trim_qty,4); ?> </th>
							<th> <? echo fn_number_format($total_trim_cons,4); ?> </th>
							<th align="right"> <? echo fn_number_format($total_trim_qty_cons,4); ?> </th>
							<th align="right"> <? echo fn_number_format($total_tot_item_qty_cons,4); ?> </th>
						</tr>
						</tfoot>
					</tbody>
            </table>
			<br/>
			 <table id="table_header_1"    class="rpt_table" width="1030" cellpadding="0" cellspacing="0" border="1" rules="all">
           	<caption> <b style="float:left">Embellishment Details :</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="120">Embellishment Name</th>
						<th width="120">Embellishment Type</th>
						<th width="120">Body Part</th>
						<th width="60">Uom</th>
						<th width="100">Cons.</th>
                        <th width="100">Total Qty</th>
                        <th width="180">Supplier</th>
                        <th width="200">Remarks</th>
                    </thead>

                    <?
					$emblishment_qty_name_type_arr=$emblishment->getQtyArray_by_jobEmbnameAndEmbtype();
					$emblishment_amount_name_type_arr=$emblishment->getAmountArray_by_jobEmbnameAndEmbtype();
					$wash_type_name_qty_arr=$wash->getQtyArray_by_jobEmbnameAndEmbtype();
					$wash_type_name_amount_arr=$wash->getAmountArray_by_jobEmbnameAndEmbtype();

				   $sql_emblish="select a.order_uom,c.id, c.job_no,c.supplier_id,c.body_part_id, c.emb_name,c.emb_type,c.cons_dzn_gmts,c.rate, c.amount from wo_po_details_master a, wo_po_break_down b,wo_pre_cost_embe_cost_dtls c  where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst and c.job_no=a.job_no  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.job_no='$txt_job_no' $txt_po_breack_down_id_cond order by c.id";

					$result_emblish=sql_select($sql_emblish);
					$emblish_detail_arr=array();
					foreach($result_emblish as $row)
					{
						$item_descrition =$row[csf("description")];
						$embl_rowspan+=1;
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['emb_name']=$row[csf("emb_name")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['emb_type']=$row[csf("emb_type")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['supplier_id']=$row[csf("supplier_id")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['body_part_id']=$row[csf("body_part_id")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['amount']=$row[csf("amount")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['order_uom']=$row[csf("order_uom")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['rate']=$row[csf("rate")];
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['job_no'].=$row[csf("job_no")].',';
						$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['desc']=$item_descrition;
						//$emblishment_qty_arr
						//$embsamount=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];

					}
					//echo $embl_rowspan;
					//print_r($conv_rowspan_arr);
					$i=$m=1;$grand_total_embl_amount=$grand_total_cons_dzn_gmts=0;
					foreach($emblish_detail_arr as $emb_name=>$enm_val)
					{
						foreach($enm_val as $emb_type=>$val)
						{

						if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$job_no=rtrim($val[('job_no')],',');
						$job_nos=array_unique(explode(",",$job_no));
						//$emb_name=$val[('emb_name')];$emb_type=$val[('emb_type')];

						if($emb_name==1)$em_type = $emblishment_print_type[$emb_type];
						else if($emb_name==2)$em_type = $emblishment_embroy_type[$emb_type];
						else if($emb_name==3)$em_type = $emblishment_wash_type[$emb_type];
						else if($emb_name==4)$em_type = $emblishment_spwork_type[$emb_type];

						$cons_dzn_gmts=0;$embl_amount=0;
						foreach($job_nos as $jno)
						{
							if($emb_name !=3){
								$wash_qty=$emblishment_qty_name_type_arr[$jno][$emb_name][$emb_type];
								$wash_amt=$emblishment_amount_name_type_arr[$jno][$emb_name][$emb_type];
								if($wash_amt) $wash_amt=$wash_amt;else $wash_amt=0;
								if($wash_qty) $wash_qty=$wash_qty;else $wash_qty=0;
								if(($wash_qty!="" || $wash_amt!=0) && ($wash_qty!="" || $wash_amt!=0))
								{
									$em_amount=$emblishment_amount_name_type_arr[$jno][$emb_name][$emb_type];
									$cons_dzn=$emblishment_qty_name_type_arr[$jno][$emb_name][$emb_type];
									if($em_amount) $em_amount=$em_amount;else $em_amount=0;
									if($cons_dzn) $cons_dzn=$cons_dzn;else $cons_dzn=0;

									$cons_dzn_gmts+=$cons_dzn;
									$embl_amount+=$em_amount;
								}
							}
							else if($emb_name ==3){
								$wash_qty=$wash_type_name_qty_arr[$jno][$emb_name][$emb_type];
								$wash_amt=$wash_type_name_amount_arr[$jno][$emb_name][$emb_type];
								if($wash_amt) $wash_amt=$wash_amt;else $wash_amt=0;
								if($wash_qty) $wash_qty=$wash_qty;else $wash_qty=0;
								if(($wash_qty!="" || $wash_amt!=0) && ($wash_qty!="" || $wash_amt!=0))
								{
									$embl_amt=$wash_type_name_amount_arr[$jno][$emb_name][$emb_type];
									$cons_dzn=$wash_type_name_qty_arr[$jno][$emb_name][$emb_type];
									if($embl_amt) $embl_amt=$embl_amt;else $embl_amt=0;
									if($cons_dzn) $cons_dzn=$cons_dzn;else $cons_dzn=0;
									$cons_dzn_gmts+=$wash_type_name_qty_arr[$jno][$emb_name][$emb_type];
									$embl_amount+=$embl_amt;
								}
							//echo 2;
							}
						}
						//wash_type_name_amount_arr
						//echo $embl_amount.',';
					?>
						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tremb_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tremb_<? echo $i; ?>">
							<td width="30">
							<? echo $i; ?></td>
                            <td width="120"><div style="word-break:break-all"><? echo $emblishment_name_array[$emb_name];; ?></div></td>
							<td width="120" align="center"><div style="word-break:break-all"><? echo $em_type; ?></div></td>
							 <td width="120" align="center"><div style="word-break:break-all"><? echo $body_part[$val[('body_part_id')]]; ?></div></td>
							 <td width="60" align="center"><div style="word-break:break-all"><? echo $unit_of_measurement[$val[('order_uom')]]; ?></div></td>

							<td width="100" align="right" ><div style="word-break:break-all"><? echo fn_number_format($val[('cons_dzn_gmts')],4); ?></div>

                            <td width="100" align="right"><? echo fn_number_format($embl_amount,4); ?></td>
                            <td width="180"  align="center"><div style="word-break:break-all">
							<? echo $supplier_library[$val['supplier_id']]; ?> </div></td>

                             <td width="200" valign="middle" align="center">
							<? //echo $val[('supplier_id')]; ?></td>

                            </tr>
                            <?
								$grand_total_embl_amount+=$embl_amount;
								$grand_total_cons_dzn_gmts+=$val[('cons_dzn_gmts')];
								$grand_total_cons_gmts_amt+=$embl_amount;
								$i++;//$m++;
								}
							}
							?>
                            <tfoot>
                            <tr>
                                <th  align="right" colspan="5"><strong>Grand Total</strong> </th>

                                <th align="right"><strong><? echo fn_number_format($grand_total_cons_dzn_gmts,4);?></strong></th>
                                <th align="right"><? echo fn_number_format($grand_total_embl_amount,4);?></th>
                                <th align="right">&nbsp;</th>

                                <th align="right"><? //echo fn_number_format(($grand_total_embl_amount/$total_fob_value)*100,4); ?> </th>
                            </tr>
                            </tfoot>
                    </table>

		</div>
		<br>
		<? echo signature_table(109, $cbo_company_name, "860px"); ?>
	</div>
	<?
	exit();
}

if($action=='mo_sheet_1') //Helal-12-10-2021
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);
	$excess_per_val=str_replace("'","",$excess_per_val);
	$supplier_check=str_replace("'","",$supplier_check);
	//echo $excess_val.'dd';
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		//$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and a.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and d.po_break_down_id in(".$txt_po_breack_down_id.")";
		//$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");

	$result =sql_select("select a.job_no,a.buyer_name,a.style_ref_no,a.ship_mode, a.order_uom,a.gmts_item_id,a.total_set_qnty,b.id,b.po_number,b.po_received_date,b.pub_shipment_date,b.file_no,b.grouping,c.costing_date,c.costing_per from wo_po_details_master a,wo_po_break_down b,wo_pre_cost_mst c where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst  and c.job_no=a.job_no  and b.job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond and b.status_active=1 and b.is_deleted=0 order by b.pub_shipment_date DESC");

	$job_in_orders = array();$job_in_ship_arr = array();
	$pulich_ship_date='';$shipment_date_arr='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders_arr[$val[csf('id')]]= $val[csf('po_number')];
		$job_in_ship_arr[$val[csf('id')]]= $val[csf('pub_shipment_date')];
		$job_in_recvDate_arr[$val[csf('id')]]= change_date_format($val[csf('po_received_date')]);
		$job_in_ref_arr[$val[csf('id')]]= $val[csf('grouping')];
		$job_in_file_arr[$val[csf('id')]]= $val[csf('file_no')];
		$job_total_set_qnty_arr[$val[csf('job_no')]]= $val[csf('total_set_qnty')];

		$gmts_item_id=$val[csf('gmts_item_id')];
		$order_uom=$val[csf('order_uom')];
		$shipment_date_arr.=change_date_format($val[csf('pub_shipment_date')]).',';

		$job_no=$val[csf('job_no')];
		$buyer_name=$buyer_arr[$val[csf('buyer_name')]];
		$style_ref_no=$val[csf('style_ref_no')];

		$costing_date=$val[csf('costing_date')];
		$costing_per_name=$costing_per[$val[csf('costing_per')]];
	}
	//echo $txt_po_breack_down_id_cond.'DSD';
	$ref_cond=implode(",",array_unique($job_in_ref_arr));
	$file_con=implode(",",array_unique($job_in_file_arr));
	$shipment_date=rtrim($shipment_date_arr,',');
	$shipment_date=implode(",",array_unique(explode(",",$shipment_date)));

	$recv_date=implode(",",array_unique($job_in_recvDate_arr));
	//$shipment_date=implode(",",array_unique($job_in_ship_arr));
	$job_in_orders=implode(", ",$job_in_orders_arr);

	?>
	<style type="text/css" media="print">
   table { page-break-inside:auto; }

        @media print {
        thead {display: table-header-group;}
    }
	@media print {
				table {
					page-break-inside: avoid;
				}
			}
	</style>
	 <div style="width:1100px; margin:0 auto">
	<!--    <div style="width:1100px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
	    <div style="width:1100px; font-size:14px; font-weight:bold" align="center">MO Sheet</div>
	-->
	<br>

	 <div style="font-family:'Arial Narrow';">
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='$cbo_company_name'","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Material Order Sheet</b>
        </td></tr></table>

        <table style="width:560px; font-family:Arial Narrow" border="0" >
			<table width="50%"  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<tr>
					<td width="80">Job No</td>
					<td width="80"><b><? echo $job_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Buyer</td>
					<td width="80"><b><? echo $buyer_name; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO  Number</td>
					<td width="80"><b><? echo $job_in_orders; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Style Number</td>
					<td width="80"><b><? echo $style_ref_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Item</td>
					<td width="80"><b><?
						$gmts_item=''; $gmts_item_id=explode(",",$gmts_item_id);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=", ".$garments_item[$item_id];
							}
							echo $gmts_item;
					 ?></b></td>
				</tr>
				  <tr>
					<td width="80">Shipment Date</td>
					<td width="80"><b><? echo $shipment_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO Receive Date</td>
					<td width="80"><b><? echo $recv_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Costing Date</td>
					<td width="80"><b><? echo change_date_format($costing_date); ?></b></td>
				</tr>
					<td width="90">Costing Per</td>
					<td width="100"><b><? echo $costing_per_name; ?></b></td>

				</tr>
			</table>
			<table style="float:right; margin-top:-230px;"  width="350px" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<caption><b> Item's View</b></caption>

				 <?
						// image show here  -------------------------------------------
						$sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id='$txt_job_no' and file_type=1";
						$photo_data_array=sql_select($sql);
						$path=($path)?$path:'../../';
					 ?>
					 	<tr>
						<td align="center">
							 <div style="margin:15px 5px;float:right;width:500px;"  >

							<? foreach($photo_data_array AS $inf){ ?>

								<img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='80' width='80' />

							<?  } ?>

						  </div>

					</td>
				</tr>
			</table>

		</table>
		<br/>
		<?
		 $color_size_sql= "select a.po_number,a.id as po_id,b.item_number_id,b.color_number_id,b.size_number_id,avg(b.excess_cut_perc) as excess_cut_perc,sum(b.plan_cut_qnty) as plan_cut_qnty,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."'  and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by a.po_number,a.id,b.size_number_id,item_number_id,b.color_number_id order by b.item_number_id,b.size_number_id ";

			$result_color=sql_select($color_size_sql);
			$color_size_array=array();
			foreach($result_color as $row)
			{
				$color_size_array[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]]=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['po_qty']=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['plan_cut_qnty']=$row[csf("plan_cut_qnty")];
				$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity']=$row[csf("order_quantity")];
				//$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['tot_row']+=0;
				if($row[csf("excess_cut_perc")]>0)
				{
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['excess_cut_perc']=$row[csf("excess_cut_perc")];
				}
				$po_array[$row[csf("po_id")]]['po_no']=$row[csf("po_number")];
				$po_array[$row[csf("po_id")]]['item_number_id']=$row[csf("item_number_id")];

				$po_color_array[$row[csf("po_id")]][$row[csf("item_number_id")]]['color_number_id'].=$row[csf("color_number_id")].',';
				$item_color_size_array[$row[csf("item_number_id")]][$row[csf("color_number_id")]]+=$row[csf("order_quantity")];
			}



			//$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst=".$txt_job_no." and  b.is_deleted=0 and b.status_active=1 group by b.size_number_id";
		$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity,sum(b.plan_cut_qnty) as plan_cut_qnty from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by b.size_number_id,b.size_order order by b.size_order";

			$result_size=sql_select($size_sql);
			$posize_array=array();
			foreach($result_size as $row)
			{
				$posize_array[$row[csf("size_number_id")]]=$row[csf("size_number_id")];
			}

			$po_rowspan_arr=array();$po_item_rowspan_arr=array();
			foreach($color_size_array as $pokey=>$po_data)
			{
				$po_row_span=0;
				foreach($po_data as $itemkey=>$item_data)
				{
					$item_row_span=0;$color_row_span=0;
					foreach($item_data as $colorkey=>$val)
					{
						$item_row_span++;
						$po_row_span++;
						//$po_item_color_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
						$color_row_span++;
					}
					$itempo_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
					$po_item_rowspan_arr[$pokey][$itemkey]=$item_row_span;
					$po_rowspan_arr[$pokey]=$po_row_span;

				}
			}

			//print_r($itempo_rowspan_arr);
			?>
            <br/>
			<div style="width:1100px;">
             <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:auto;text-align:center; font-family:Arial Narrow" rules="all">
            <label style="text-align:center"><b>Size and Color  Breakdown:</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Buyer PO</td>
					<td width="110">Item</td>
                    <td width="120">Color</td>
					   <?
                    foreach ($posize_array as $sizid)
                    {
                        //$size_count=count($sizid);
                        ?>
                            <th width="60"><strong><? echo  $size_library[$sizid];  ?></strong></th>
                        <?
                    }
                    ?>
                    <td  width="80"> Total Order Qty.</td>
					<td  width="60"> Ex.Cut %</td>
					<td  width="80">Plan Cut Qty</td>
                    </tr>
                    <?
					$k=1; $total_qnty=$total_plan_qnty=0;$grd_total_qnty=$grd_total_plan_qnty=0;
                    foreach ($color_size_array as $pokey=>$po_data)
					{
						$m=1;
						foreach ($po_data as $itemkey=>$item_data)
						{
							$n=1;
							foreach ($item_data as $colorkey=>$color_data)
							{
								$po_rowspan=$po_rowspan_arr[$pokey];
								$item_po_rowspan=$po_item_rowspan_arr[$pokey][$itemkey];
								$item_po_rowspan_row=$itempo_rowspan_arr[$itemkey][$colorkey];

								$color_number_id=rtrim($po_color_array[$pokey][$itemkey]['color_number_id']);
								$color_ids=explode(",",$color_number_id);
								$color_row=count($color_row);
								//echo $color_row.', ';
							?>
							<tr>
								<?
                                if($m==1)
                                {
									?>
									<td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
									<td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>
									<?
                                }
								if($n==1)
                                {
									?>
									<td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $garments_item[$itemkey]; ?></td>
									<?
                                }
                                ?>

                                <td align="left"><? echo $color_library[$colorkey]; ?></td>
                                <?
                                $po_size_qty=0;$tot_qnty=array();
                                foreach ($posize_array as $sizval)
                                {
									$size_count=count($sizval);
									$po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty'];
									$plan_cut_qnty=$po_size_qty_array[$pokey][$colorkey][$sizval]['plan_cut_qnty'];
									$excess_cut_perc=$po_size_qty_array[$pokey][$colorkey][$sizval]['excess_cut_perc'];
									$tot_excess_cut_per[$pokey][$colorkey]+=$excess_cut_perc;
									?>
									<td align="right"><? echo fn_number_format($po_size_qty,0); ?></td>
									<?
									$tot_qnty[$pokey][$colorkey]+=$po_size_qty;
									$tot_plan_qnty[$pokey][$colorkey]+=$plan_cut_qnty;
									$tot_qnty_size[$sizval]+=$po_size_qty;
									$tot_qnty_item_size[$sizval]+=$po_size_qty;
									$grd_tot_qnty_size[$sizval]+=$po_size_qty;
									$size_tot_qty+=$item_color_size_array[$pokey][$itemkey][$colorkey];
                                }

								//if($n==1)
                                //{
									$tot_excess_cut_per=(($tot_plan_qnty[$pokey][$colorkey]-$tot_qnty[$pokey][$colorkey])/$tot_qnty[$pokey][$colorkey])*100;
									?>

									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_qnty[$pokey][$colorkey],0); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_excess_cut_per,2); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_plan_qnty[$pokey][$colorkey],0); ?></td>
									<?
                                //}
								?>

							</tr>
							<?
							$total_qnty+=$tot_qnty[$pokey][$colorkey];
							$total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$total_item_qnty+=$tot_qnty_item_size[$pokey][$colorkey];
							$grd_total_qnty+=$tot_qnty[$pokey][$colorkey];
							$grd_total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$m++;$n++;
							}

							?>

						  <?
						}
						?>
					 <tr>
						<td colspan="4" align="right"><strong>PO Sub Total :</strong></td>
						<?
						foreach ($posize_array as $sizval)
						{
							?>
							<td align="right"><b><?php echo fn_number_format($tot_qnty_size[$sizval],0);unset($tot_qnty_size[$sizval]); ?></b></td>
							<?
						}
						?>
						<td align="right"><b><?php echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php //echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php echo fn_number_format($total_plan_qnty,0);unset($total_plan_qnty); ?></b></td>
					</tr>
						<?
					  $k++;
					}
					?>
                    <tr>
                    <td colspan="4" align="right"><strong>Job Total :</strong></td>
                    <?
					foreach ($posize_array as $sizval)
					{
						?>
						<td align="right"><b><?php echo fn_number_format($grd_tot_qnty_size[$sizval],0); ?></b></td>
						<?
					}
                    ?>
                    <td align="right"><b><?php echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php //echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php echo fn_number_format($grd_total_plan_qnty,0); ?></b></td>
                </tr>
               </table>
			   </div>
			   <br/>
			  <br/>
			  <?
				$condition= new condition();
				 if($txt_po_breack_down_id!='' || $txt_po_breack_down_id!=0)
				 {
					$condition->po_id("in($txt_po_breack_down_id)");
				 }
				  if(str_replace("'","",$txt_job_no)!='')
				 {
					$condition->job_no("in('$txt_job_no')");
				 }

				$condition->init();
				$costPerArr=$condition->getCostingPerArr();
				$costPerQty=$costPerArr[$txt_job_no];
				//echo $costPerQty.'DDDDDDD';
				$fabric= new fabric($condition);
				$trims= new trims($condition);
				$emblishment= new emblishment($condition);
				$wash= new wash($condition);
				$fabric_qty_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();

					//($plan_cut_qnty/$total_set_qnty)*($cons_qnty/$costPerQty);
			//	print_r($trims_qty_arr);
				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and c.fabric_source=2 and (c.nominated_supp is null or c.nominated_supp=0) ";
				 }
				$sql_fab_color="select d.pre_cost_fabric_cost_dtls_id as fab_dtl_id,d.gmts_color_id,d.contrast_color_id from wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_color_dtls d
				 where c.job_no=d.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and c.job_no='$txt_job_no' $nom_sup_cond ";
				   $fab_result=sql_select($sql_fab_color);
				 foreach($fab_result as $row)
				 {
					$fab_color_arr[$row[csf("fab_dtl_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
				 }



					$sql_fab="select  a.color_number_id as color_id,a.item_number_id  as item_id,b.id as po_id,b.po_quantity,b.po_total_price, b.po_number, b.pub_shipment_date,c.id, c.job_no,c.body_part_id as body_id, c.fab_nature_id as nat_id, c.color_type_id as color_type, c.construction as construction,c.composition,c.fabric_source,c.gsm_weight,c.body_part_id,c.color_size_sensitive,c.width_dia_type, c.avg_cons,c.uom,c.rate, c.amount, c.avg_finish_cons,d.dia_width,d.requirment,d.cons from wo_po_color_size_breakdown a, wo_po_break_down b,wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d  where a.job_no_mst=b.job_no_mst and  c.job_no=a.job_no_mst and  a.po_break_down_id=b.id and c.job_no=a.job_no_mst and d.pre_cost_fabric_cost_dtls_id=c.id and d.po_break_down_id=a.po_break_down_id and d.po_break_down_id=b.id and d.color_size_table_id=a.id and d.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no_mst='$txt_job_no' and d.cons>0 $txt_po_breack_down_id_cond  $nom_sup_cond  order  by a.item_number_id,c.body_part_id ";
				  //echo $sql_fab;
				  $sql_fabs_result=sql_select($sql_fab);
				  $fabric_detail_arr=array();  $fabric_job_check_arr=array();
				$total_purchase_amt=0;
					foreach($sql_fabs_result as $row)
					{
						$color_size_sensitive=$row[csf("color_size_sensitive")];
						if($color_size_sensitive==3)
						{
							if($fab_color_arr[$row[csf("id")]][$row[csf("color_id")]]!='')
							{
								$fab_color_id=$fab_color_arr[$row[csf("id")]][$row[csf("color_id")]];
							}
						}
						else  $fab_color_id=$row[csf("color_id")];

						$fab_des=$row[csf("construction")].', '.$row[csf("composition")];
						$item_desc= $fab_des.",".$row[csf("gsm_weight")].",".$row[csf("dia_width")].",".$fabric_typee[$row[csf("width_dia_type")]].",".$color_type[$row[csf("color_type")]];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['gmt_color'].=$row[csf("color_id")].',';
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['uom']=$row[csf("uom")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_id']=$row[csf("item_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['body_id']=$row[csf("body_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['nat_id']=$row[csf("nat_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fabric_source']=$row[csf("fabric_source")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_desc']=$item_desc;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fin_cons']+=$row[csf("cons")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['consRow']+=1;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['amount']+=$row[csf("amount")];

					}



			if(count($fabric_detail_color_arr)>0){
				?>


            <table id="table_header_1" class="rpt_table" width="1100" cellpadding="0" cellspacing="0" border="1" rules="all">
           				<caption> <b style="float:left">Fabric Details :</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Gmt Item</th>
						<th width="120">Fab. Nature</th>
						<th width="120">Body Part</th>
						<th width="200">Fab. Desc</th>
						<th width="100">Gmt Color</th>
						<th width="100">Fab. Color</th>
					    <th width="50">UOM</th>
						<th width="90">Fin. Cons</th>
						<th width="90">Total Fin Cons. </th>
						<th width="90">Fab. Source</th>

                    </thead>
            </table>
			<table class="rpt_table"   width="1100" cellpadding="0" cellspacing="0" border="1" rules="all" id="table_body1">

			<?

				 // print($fabric_detail_arr);
					$item_rowspan_arr=array();$fab_rowspan_arr=array();

					foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
					{
						 $fab_body_rowspan=0;
						  foreach($fab_dtls_data as $fab_color_key=>$val)
						  {
							$fab_body_rowspan++;
						  }
						$fab_rowspan_arr[$fab_dtls_id_key]=$fab_body_rowspan;
					 }
					//print_r($fab_rowspan_arr);

					$i=$m=1;$total_greycons=$total_tot_greycons=$total_tot_fin_cons=$grand_total_fin_cons=$grand_total_tot_greycons=$grand_total_amount=0;

						foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
						{
					  		$y=1;
							foreach($fab_dtls_data as $fab_color_key=>$val)
							{

								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

								$uom_key=$val['uom'];
								$body_key=$val['body_id'];
								$item_key=$val['item_id'];
								$desc_key=$val['item_desc'];
								$nat_key=$val['nat_id'];$fab_source_key=$val['fabric_source'];
								$gmt_color=rtrim($val['gmt_color'],',');
								$gmt_colorid=array_unique(explode(",",$gmt_color));
								$gmt_color="";
								$wv_fincons=$fincons_knit=$tot_amount=0;
								foreach($gmt_colorid as $gid)
								{
									if($gmt_color=="") $gmt_color=$color_library[$gid];else $gmt_color.=",".$color_library[$gid];

									$fincons_knit+=$fabric_qty_arr['knit']['finish'][$fab_dtls_id_key][$gid][$uom_key];
									$wv_fincons+=$fabric_qty_arr['woven']['finish'][$fab_dtls_id_key][$gid][$uom_key];
								}
								$tot_fin_qty=$fincons_knit+$wv_fincons;
					?>

						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">  <?
                      	 if($y==1){
						?>
							<td width="30" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key]?>"><? echo $m; ?></td>
							<td width="100" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $garments_item[$item_key]; ?></td>
							<td width="120" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $item_category[$nat_key]; ?></td>
							<td width="120" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key];;?>" align="center"><div style="word-break:break-all"><? echo $body_part[$body_key]; ?></div></td>
                             <?
							 }

							?>

							<td width="200" align="center" ><div style="word-break:break-all"><? echo $desc_key; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $gmt_color; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $color_library[$fab_color_key]; ?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['uom']]; ?></td>
							<td width="90"  align="right">
                            <div style="word-break:break-all">
							<?

							 echo fn_number_format($val['fin_cons']/$val['consRow'],4);
							 ?>
                            </div>
                            </td>
                            <td width="90"  align="right"><div style="word-break:break-all"><? echo fn_number_format($tot_fin_qty,4); ?></div></td>
							<td width="90"  align="center"><div style="word-break:break-all"><? echo $fabric_source[$fab_source_key]; ?></div></td>

                            </tr>
                            <?
								$total_fin_cons+=$tot_fin_qty;
								$total_tot_fin_cons+=$val['fin_cons'];
								$grand_total_fin_cons+=$tot_fin_qty;

									$y++;
									$i++;
									}
								$m++;
							?>
                            <?

						}
							?>
                            <tfoot>
                            <tr>
                            <th colspan="8" ><strong>Grand Total</strong> </th>

                            <th align="right"><strong><? //echo fn_number_format($total_tot_fin_cons,4);?></strong> </th>
                            <th align="right"><strong><? echo fn_number_format($grand_total_fin_cons,4);?></strong> </th>
							<th><strong>&nbsp;</strong> </th>
                            </tr>
                            </tfoot>
                    </table>
					<br/>
					<?
			}
					$item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
					$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id  and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

					$trims_qty_arr=$trims->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
					$trims_item_qty_arr=$trims->getQtyArray_by_jobAndItemid();
					$trims_desc_qty_arr=$trims->getQtyArray_by_jobItemidAndDescription();

					$trims_dtl_qty_arr=$trims->getQtyArray_by_OrderPrecostdtlsidGmtscolorAndGmtssize();
					//print_r($trims_amt_arr);

				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and ( c.nominated_supp_multi is null or c.nominated_supp_multi='' or c.nominated_supp_multi=0)";
				 }

				 $sql_trim_color="select c.id,c.job_no,c.trim_group,c.description,c.brand_sup_ref,c.nominated_supp_multi as nominated_supp,c.cons_uom,c.remark,d.wo_pre_cost_trim_cost_dtls_id as fab_dtl_id,d.item_size,d.color_number_id,d.item_number_id,d.size_number_id,d.po_break_down_id as po_id,d.excess_per,d.cons,d.tot_cons,c.source_id from wo_pre_cost_trim_cost_dtls c,wo_pre_cost_trim_co_cons_dtls d
				 where c.job_no=d.job_no and d.wo_pre_cost_trim_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and d.cons>0 and c.job_no='$txt_job_no' $txt_po_breack_down_id_cond2 $nom_sup_cond order by c.id,c.trim_group";
				 //echo  $sql_trim_color;
				 $trim_result=sql_select($sql_trim_color);$tot_trim_req_qty=0;
				 foreach($trim_result as $row)
				 {
					if($excess_per_val>0)
					{
						$total_set_qnty=$job_total_set_qnty_arr[$row[csf('job_no')]];
						$order_quantity=$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity'];
						//echo $plan_cut_qnty.'<br/>';
						$tot_cons_qnty=$row[csf("tot_cons")]+($row[csf("tot_cons")]*$excess_per_val)/100;
						$trim_req_qty=($order_quantity/$total_set_qnty)*($tot_cons_qnty/$costPerQty);
						$excess_per=$excess_per_val;
						//echo $trim_req_qty.'='.$excess_per_val.', ';
						//$tot_trim_req_qty+=$trim_req_qty;
					}
					else
					{
						$excess_per=0;
						$excess_per=$row[csf("excess_per")];
						$tot_cons_qnty=$row[csf("cons")];
						//$trim_req_qty=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
						$trim_req_qty=$trims_dtl_qty_arr[$row[csf("po_id")]][$row[csf("id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					}
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['description']=$row[csf("description")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['nominated_supp']=$row[csf("nominated_supp")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['size_number_id']=$row[csf("size_number_id")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['job_no']=$row[csf("job_no")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_size']=$row[csf("item_size")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['remark']=$row[csf("remark")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_uom']=$row[csf("cons_uom")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons']=$row[csf("tot_cons")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['source_id']=$row[csf("source_id")];

					//$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trim_req_qty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_cons']=$tot_cons_qnty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['excess_per']=$excess_per;
					$item_tot_qty_arr[$row[csf("trim_group")]][$row[csf("description")]]+=$trim_req_qty;

				 }
				// echo $tot_trim_req_qty.', ';
				  	foreach($trims_color_arr as $trim_key=>$trim_data)
					 {
						  $trim_color_rowspan=0;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						   $trim_desc_rowspan=0;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
								$item_size_rowspan=0;
								foreach($color_data as $size_key=>$val)
								{
									$item_size_rowspan++;
									$trim_desc_rowspan++;
									$trim_color_rowspan++;
									$color_qty[$trim_key][$desc_key][$gmt_color_key]+=$val['tot_size_cons'];
									$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]+=1;
								}
								$item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]=$item_size_rowspan;
								$trim_desc_rowspan_arr[$trim_key][$desc_key]=$trim_desc_rowspan;
								$trim_size_rowspan_arr[$trim_key]=$trim_color_rowspan;

							}
						   }
					}
				 	//print_r($trim_size_rowspan_arr);
					?>
           		 <table id="table_header_1" class="rpt_table" width="1120" cellpadding="0" cellspacing="0" border="1" rules="all">
           			<caption> <b style="float:left">Trims Details:</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Item</th>
						<th width="120">Description</th>
						<th width="100">Remarks</th>
						<th width="100">Source</th>
						<th width="100">Supplier</th>
						<th width="100">Gmt Color</th>
						<th width="100">Item Size</th>

					    <th width="50">UOM</th>
						<th width="80">Cons</th>
						<th width="80">Exs %</th>
						<th width="80">Total Cons. </th>
						<th width="80">Total Qty </th>
						<th width="80">Color Total Qty.</th>
						<th width="80">Item Total Qty.</th>

                    </thead>
					<tbody>
					 <?

					 	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

						 $j=1;$total_trim_cons=$total_tot_trim_cons_qty=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
						 foreach($trims_color_arr as $trim_key=>$trim_data)
					 	 {
						   $k=1;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						    $n=1;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
						    $m=1;$c=1;
						     foreach($color_data as $size_key=>$val)
					 	     {
								if($j%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								if($col_size_cons_arr[$trim_key][$gmt_color_key]>0)
								{
								$tot_size_qty=$col_size_cons_arr[$trim_key][$gmt_color_key];
								}
								if($item_tot_cons_arr[$trim_key]>0)
								{
								$item_tot_size_qty=$item_tot_cons_arr[$trim_key];
								}
								$job_no=$val['job_no'];
								$item_size=$val['item_size'];
								$tot_size_cons=$val['tot_size_cons'];

								$gmt_item_desc_qty=$item_tot_qty_arr[$trim_key][$desc_key];//$trims_desc_qty_arr[$job_no][$trim_key][$desc_key];
								//$gmt_item_desc_qty=$trims_item_qty_arr[$job_no][$trim_key];
								$gmt_size_qty=$tot_size_cons;//$trims_qty_arr[$job_no][$trim_key][$desc_key][$gmt_color_key][$size_key];
								//$item_tot_qty=$item_tot_qty_arr[$trim_key][$desc_key];


								$nominated_supp_str="";
								$exsupp=explode(",",$val["nominated_supp"]);
								foreach($exsupp as $sid)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
								}


					?>

						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $j; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $j; ?>">  <?
                      	 if($k==1){
						?>
							<td width="30" rowspan="<? echo $trim_size_rowspan_arr[$trim_key]?>"><? echo $j; ?></td>
							<td width="100" rowspan="<?  echo $trim_size_rowspan_arr[$trim_key];?>"><? echo $item_group_arr[$trim_key]; ?></td>
							 <?

							 }
							//$tot_gmt_size_qty=0;


							  if($n==1){

							 ?>
							<td width="120" rowspan="<?  echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"><? echo  $desc_key; ?></td>

							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center"><div style="word-break:break-all"><? echo $val['remark']; ?></div></td>

							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center"><div style="word-break:break-all"><? echo $commission_particulars[$val['source_id']]; ?></div></td>

							<td width="100"  rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" ><div style="word-break:break-all"><?=$nominated_supp_str; ?></div></td>
                             <?
							 }

							if($m==1){

							?>
                            <td width="100" rowspan="<? echo $item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"  align="center"><div style="word-break:break-all"><? echo $color_library[$gmt_color_key]; ?></div></td>
							<?
							}
							?>
                            <td width="100" title="<?=$size_key?>"  align="center"><div style="word-break:break-all"><?=$size_key?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['cons_uom']]; ?></td>
							<td width="80"  align="center"><div style="word-break:break-all"><? echo fn_number_format($val['cons'],4); ?></div></td>

                            <td width="80"  align="right" title="<? echo $val['excess_per']; ?>"><div style="word-break:break-all"><? echo fn_number_format($val['excess_per'],4);//echo fn_number_format($val['excess_per'],4); ?></div></td>

							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($val['tot_cons'],4); ?></div></td>
							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($gmt_size_qty,2); ?></div></td>
							<?


							 if($c==1){
							?>
                            <td width="80"   align="center" rowspan="<?=$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"><div style="word-break:break-all"><? echo  fn_number_format($color_qty[$trim_key][$desc_key][$gmt_color_key],2); ?></div></td>
							<?
							 $c++;}
							if($n==1){
							 $total_tot_item_qty_cons+=$gmt_item_desc_qty;
							?>
                            <td width="80" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"  align="center"><div style="word-break:break-all"><? echo  fn_number_format($gmt_item_desc_qty,2); ?></div></td>
							<?
							}
							?>

                       </tr>
					   <?
					   		$total_tot_trim_cons_qty+=$val['cons'];
							$total_trim_cons+=$val['tot_cons'];
							$total_trim_qty_cons+=$gmt_size_qty;
							$k++;$m++;$n++;

					   		}
							?>

							<?
						    }

						   }

						  $j++;
					   	}
					   ?>
						<tfoot>
						<tr>
							<th colspan="8" align="right"> Grand Total </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_trim_cons_qty,4); ?> </th>

							<th align="right"> <? //echo fn_number_format($total_tot_trim_qty,4); ?> </th>
							<th> <? echo fn_number_format($total_trim_cons,4); ?> </th>
							<th align="right"> <? echo fn_number_format($total_trim_qty_cons,2); ?> </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_item_qty_cons,2); ?> </th>
						</tr>
						</tfoot>
					</tbody>
            </table>

		</div>
		<br>
		<? echo signature_table(109, $cbo_company_name, "950px"); ?>
	</div>
	<?
	exit();
}
if($action=='mo_sheet_3') //Md mamun-7-12-2021
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);
	$excess_per_val=str_replace("'","",$excess_per_val);
	$supplier_check=str_replace("'","",$supplier_check);
	//echo $excess_val.'dd';
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		//$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and a.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and d.po_break_down_id in(".$txt_po_breack_down_id.")";
		//$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");

	$result =sql_select("select a.job_no,a.buyer_name,a.style_ref_no,a.ship_mode, a.order_uom,a.gmts_item_id,a.total_set_qnty,b.id,b.po_number,b.po_received_date,b.pub_shipment_date,b.file_no,b.grouping,c.costing_date,c.costing_per from wo_po_details_master a,wo_po_break_down b,wo_pre_cost_mst c where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst  and c.job_no=a.job_no  and b.job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond and b.status_active=1 and b.is_deleted=0 order by b.pub_shipment_date DESC");

	$job_in_orders = array();$job_in_ship_arr = array();
	$pulich_ship_date='';$shipment_date_arr='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders_arr[$val[csf('id')]]= $val[csf('po_number')];
		$job_in_ship_arr[$val[csf('id')]]= $val[csf('pub_shipment_date')];
		$job_in_recvDate_arr[$val[csf('id')]]= change_date_format($val[csf('po_received_date')]);
		$job_in_ref_arr[$val[csf('id')]]= $val[csf('grouping')];
		$job_in_file_arr[$val[csf('id')]]= $val[csf('file_no')];
		$job_total_set_qnty_arr[$val[csf('job_no')]]= $val[csf('total_set_qnty')];

		$gmts_item_id=$val[csf('gmts_item_id')];
		$order_uom=$val[csf('order_uom')];
		$shipment_date_arr.=change_date_format($val[csf('pub_shipment_date')]).',';

		$job_no=$val[csf('job_no')];
		$buyer_name=$buyer_arr[$val[csf('buyer_name')]];
		$style_ref_no=$val[csf('style_ref_no')];

		$costing_date=$val[csf('costing_date')];
		$costing_per_name=$costing_per[$val[csf('costing_per')]];
	}
	//echo $txt_po_breack_down_id_cond.'DSD';
	$ref_cond=implode(",",array_unique($job_in_ref_arr));
	$file_con=implode(",",array_unique($job_in_file_arr));
	$shipment_date=rtrim($shipment_date_arr,',');
	$shipment_date=implode(",",array_unique(explode(",",$shipment_date)));

	$recv_date=implode(",",array_unique($job_in_recvDate_arr));
	//$shipment_date=implode(",",array_unique($job_in_ship_arr));
	$job_in_orders=implode(", ",$job_in_orders_arr);

	?>
	<style type="text/css" media="print">
   table { page-break-inside:auto; }

        @media print {
        thead {display: table-header-group;}
    }
	@media print {
				table {
					page-break-inside: avoid;
				}
			}
	</style>
	 <div style="width:1100px; margin:0 auto">
	<!--    <div style="width:1100px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
	    <div style="width:1100px; font-size:14px; font-weight:bold" align="center">MO Sheet</div>
	-->
	<br>

	 <div style="font-family:'Arial Narrow';">
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='$cbo_company_name'","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Material Order Sheet</b>
        </td></tr></table>

        <table style="width:560px; font-family:Arial Narrow" border="0" >
			<table width="50%"  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<tr>
					<td width="80">Job No</td>
					<td width="80"><b><? echo $job_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Buyer</td>
					<td width="80"><b><? echo $buyer_name; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO  Number</td>
					<td width="80"><b><? echo $job_in_orders; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Style Number</td>
					<td width="80"><b><? echo $style_ref_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Item</td>
					<td width="80"><b><?
						$gmts_item=''; $gmts_item_id=explode(",",$gmts_item_id);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=", ".$garments_item[$item_id];
							}
							echo $gmts_item;
					 ?></b></td>
				</tr>
				  <tr>
					<td width="80">Shipment Date</td>
					<td width="80"><b><? echo $shipment_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO Receive Date</td>
					<td width="80"><b><? echo $recv_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Costing Date</td>
					<td width="80"><b><? echo change_date_format($costing_date); ?></b></td>
				</tr>
					<td width="90">Costing Per</td>
					<td width="100"><b><? echo $costing_per_name; ?></b></td>

				</tr>
			</table>
			<table style="float:right; margin-top:-230px;"  width="350px" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<caption><b> Item's View</b></caption>

				 <?
						// image show here  -------------------------------------------
						$sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id='$txt_job_no' and file_type=1";
						$photo_data_array=sql_select($sql);
						$path=($path)?$path:'../../';
					 ?>
					 	<tr>
						<td align="center">
							 <div style="margin:15px 5px;float:right;width:500px;"  >

							<? foreach($photo_data_array AS $inf){ ?>

								<img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='80' width='80' />

							<?  } ?>

						  </div>

					</td>
				</tr>
			</table>

		</table>
		<br/>
		<?
		 $color_size_sql= "select a.po_number,a.id as po_id,b.item_number_id,b.color_number_id,b.size_number_id,avg(b.excess_cut_perc) as excess_cut_perc,sum(b.plan_cut_qnty) as plan_cut_qnty,sum(b.order_quantity) as order_quantity,b.country_id from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."'  and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by a.po_number,a.id,b.size_number_id,item_number_id,b.color_number_id,b.country_id order by b.item_number_id,b.size_number_id ";

			$result_color=sql_select($color_size_sql);
			$color_size_array=array();
			foreach($result_color as $row)
			{
				$color_size_array[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]]=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['po_qty']=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['plan_cut_qnty']=$row[csf("plan_cut_qnty")];
				$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity']=$row[csf("order_quantity")];
				//$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['tot_row']+=0;
				if($row[csf("excess_cut_perc")]>0)
				{
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['excess_cut_perc']=$row[csf("excess_cut_perc")];
				}
				$po_array[$row[csf("po_id")]]['po_no']=$row[csf("po_number")];
				$po_array[$row[csf("po_id")]]['country_id']=$country_library[$row[csf("country_id")]];
				$po_array[$row[csf("po_id")]]['item_number_id']=$row[csf("item_number_id")];

				$po_color_array[$row[csf("po_id")]][$row[csf("item_number_id")]]['color_number_id'].=$row[csf("color_number_id")].',';
				$item_color_size_array[$row[csf("item_number_id")]][$row[csf("color_number_id")]]+=$row[csf("order_quantity")];
			}



			//$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst=".$txt_job_no." and  b.is_deleted=0 and b.status_active=1 group by b.size_number_id";
		$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity,sum(b.plan_cut_qnty) as plan_cut_qnty from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by b.size_number_id,b.size_order order by b.size_order";

			$result_size=sql_select($size_sql);
			$posize_array=array();
			foreach($result_size as $row)
			{
				$posize_array[$row[csf("size_number_id")]]=$row[csf("size_number_id")];
			}

			$po_rowspan_arr=array();$po_item_rowspan_arr=array();
			foreach($color_size_array as $pokey=>$po_data)
			{
				$po_row_span=0;
				foreach($po_data as $itemkey=>$item_data)
				{
					$item_row_span=0;$color_row_span=0;
					foreach($item_data as $colorkey=>$val)
					{
						$item_row_span++;
						$po_row_span++;
						//$po_item_color_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
						$color_row_span++;
					}
					$itempo_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
					$po_item_rowspan_arr[$pokey][$itemkey]=$item_row_span;
					$po_rowspan_arr[$pokey]=$po_row_span;

				}
			}

			//print_r($itempo_rowspan_arr);
			?>
            <br/>
			<div style="width:1200px;">
             <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:auto;text-align:center; font-family:Arial Narrow" rules="all">
            <label style="text-align:center"><b>Size and Color  Breakdown:</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Buyer PO</td>
					<td width="110">Item</td>
					<td width="100">Country</td>
                    <td width="120">Color</td>
					   <?
                    foreach ($posize_array as $sizid)
                    {
                        //$size_count=count($sizid);
                        ?>
                            <th width="60"><strong><? echo  $size_library[$sizid];  ?></strong></th>
                        <?
                    }
                    ?>
                    <td  width="80"> Total Order Qty.</td>
					<td  width="60"> Ex.Cut %</td>
					<td  width="80">Plan Cut Qty</td>
                    </tr>
                    <?
					$k=1; $total_qnty=$total_plan_qnty=0;$grd_total_qnty=$grd_total_plan_qnty=0;
                    foreach ($color_size_array as $pokey=>$po_data)
					{
						$m=1;
						foreach ($po_data as $itemkey=>$item_data)
						{
							$n=1;
							foreach ($item_data as $colorkey=>$color_data)
							{
								$po_rowspan=$po_rowspan_arr[$pokey];
								$item_po_rowspan=$po_item_rowspan_arr[$pokey][$itemkey];
								$item_po_rowspan_row=$itempo_rowspan_arr[$itemkey][$colorkey];

								$color_number_id=rtrim($po_color_array[$pokey][$itemkey]['color_number_id']);
								$color_ids=explode(",",$color_number_id);
								$color_row=count($color_row);
								//echo $color_row.', ';
							?>
							<tr>
								<?
                                if($m==1)
                                {
									?>
									<td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
									<td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>

									<?
                                }
								if($n==1)
                                {
									?>
									<td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $garments_item[$itemkey]; ?></td>
									<td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $po_array[$pokey]['country_id']; ?></td>
									<?
                                }
                                ?>

                                <td align="left"><? echo $color_library[$colorkey]; ?></td>
                                <?
                                $po_size_qty=0;$tot_qnty=array();
                                foreach ($posize_array as $sizval)
                                {
									$size_count=count($sizval);
									$po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty'];
									$plan_cut_qnty=$po_size_qty_array[$pokey][$colorkey][$sizval]['plan_cut_qnty'];
									$excess_cut_perc=$po_size_qty_array[$pokey][$colorkey][$sizval]['excess_cut_perc'];
									$tot_excess_cut_per[$pokey][$colorkey]+=$excess_cut_perc;
									?>
									<td align="right"><? echo fn_number_format($po_size_qty,0); ?></td>
									<?
									$tot_qnty[$pokey][$colorkey]+=$po_size_qty;
									$tot_plan_qnty[$pokey][$colorkey]+=$plan_cut_qnty;
									$tot_qnty_size[$sizval]+=$po_size_qty;
									$tot_qnty_item_size[$sizval]+=$po_size_qty;
									$grd_tot_qnty_size[$sizval]+=$po_size_qty;
									$size_tot_qty+=$item_color_size_array[$pokey][$itemkey][$colorkey];
                                }

								//if($n==1)
                                //{
									$tot_excess_cut_per=(($tot_plan_qnty[$pokey][$colorkey]-$tot_qnty[$pokey][$colorkey])/$tot_qnty[$pokey][$colorkey])*100;
									?>

									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_qnty[$pokey][$colorkey],0); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_excess_cut_per,2); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_plan_qnty[$pokey][$colorkey],0); ?></td>
									<?
                                //}
								?>

							</tr>
							<?
							$total_qnty+=$tot_qnty[$pokey][$colorkey];
							$total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$total_item_qnty+=$tot_qnty_item_size[$pokey][$colorkey];
							$grd_total_qnty+=$tot_qnty[$pokey][$colorkey];
							$grd_total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$m++;$n++;
							}

							?>

						  <?
						}
						?>
					 <tr>
						<td colspan="5" align="right"><strong>PO Sub Total :</strong></td>
						<?
						foreach ($posize_array as $sizval)
						{
							?>
							<td align="right"><b><?php echo fn_number_format($tot_qnty_size[$sizval],0);unset($tot_qnty_size[$sizval]); ?></b></td>
							<?
						}
						?>
						<td align="right"><b><?php echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php //echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php echo fn_number_format($total_plan_qnty,0);unset($total_plan_qnty); ?></b></td>
					</tr>
						<?
					  $k++;
					}
					?>
                    <tr>
                    <td colspan="4" align="right"><strong>Job Total :</strong></td>
                    <?
					foreach ($posize_array as $sizval)
					{
						?>
						<td align="right"><b><?php echo fn_number_format($grd_tot_qnty_size[$sizval],0); ?></b></td>
						<?
					}
                    ?>
                    <td align="right"><b><?php echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php //echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php echo fn_number_format($grd_total_plan_qnty,0); ?></b></td>
                </tr>
               </table>
			   </div>
			   <br/>
			  <br/>
			  <?
				$condition= new condition();
				 if($txt_po_breack_down_id!='' || $txt_po_breack_down_id!=0)
				 {
					$condition->po_id("in($txt_po_breack_down_id)");
				 }
				  if(str_replace("'","",$txt_job_no)!='')
				 {
					$condition->job_no("in('$txt_job_no')");
				 }

				$condition->init();
				$costPerArr=$condition->getCostingPerArr();
				$costPerQty=$costPerArr[$txt_job_no];
				//echo $costPerQty.'DDDDDDD';
				$fabric= new fabric($condition);
				$trims= new trims($condition);
				$emblishment= new emblishment($condition);
				$wash= new wash($condition);
				$fabric_qty_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();

					//($plan_cut_qnty/$total_set_qnty)*($cons_qnty/$costPerQty);
			//	print_r($trims_qty_arr);
				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and c.fabric_source=2 and (c.nominated_supp is null or c.nominated_supp=0) ";
				 }
				$sql_fab_color="select d.pre_cost_fabric_cost_dtls_id as fab_dtl_id,d.gmts_color_id,d.contrast_color_id from wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_color_dtls d
				 where c.job_no=d.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and c.job_no='$txt_job_no' $nom_sup_cond ";
				   $fab_result=sql_select($sql_fab_color);
				 foreach($fab_result as $row)
				 {
					$fab_color_arr[$row[csf("fab_dtl_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
				 }



					$sql_fab="select  a.color_number_id as color_id,a.item_number_id  as item_id,b.id as po_id,b.po_quantity,b.po_total_price, b.po_number, b.pub_shipment_date,c.id, c.job_no,c.body_part_id as body_id, c.fab_nature_id as nat_id, c.color_type_id as color_type, c.construction as construction,c.composition,c.fabric_source,c.gsm_weight,c.body_part_id,c.color_size_sensitive,c.width_dia_type, c.avg_cons,c.uom,c.rate, c.amount, c.avg_finish_cons,d.dia_width,d.requirment,d.cons from wo_po_color_size_breakdown a, wo_po_break_down b,wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d  where a.job_no_mst=b.job_no_mst and  c.job_no=a.job_no_mst and  a.po_break_down_id=b.id and c.job_no=a.job_no_mst and d.pre_cost_fabric_cost_dtls_id=c.id and d.po_break_down_id=a.po_break_down_id and d.po_break_down_id=b.id and d.color_size_table_id=a.id and d.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no_mst='$txt_job_no' and d.cons>0 $txt_po_breack_down_id_cond  $nom_sup_cond  order  by a.item_number_id,c.body_part_id ";
				  //echo $sql_fab;
				  $sql_fabs_result=sql_select($sql_fab);
				  $fabric_detail_arr=array();  $fabric_job_check_arr=array();
				$total_purchase_amt=0;
					foreach($sql_fabs_result as $row)
					{
						$color_size_sensitive=$row[csf("color_size_sensitive")];
						if($color_size_sensitive==3)
						{
							if($fab_color_arr[$row[csf("id")]][$row[csf("color_id")]]!='')
							{
								$fab_color_id=$fab_color_arr[$row[csf("id")]][$row[csf("color_id")]];
							}
						}
						else  $fab_color_id=$row[csf("color_id")];

						$fab_des=$row[csf("construction")].', '.$row[csf("composition")];
						$item_desc=$row[csf("gsm_weight")].",".$fabric_typee[$row[csf("width_dia_type")]];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['gmt_color'].=$row[csf("color_id")].',';
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['uom']=$row[csf("uom")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_id']=$row[csf("item_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['body_id']=$row[csf("body_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['nat_id']=$row[csf("nat_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fabric_source']=$row[csf("fabric_source")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_desc']=$item_desc;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['construction']=$row[csf("construction")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['composition']=$row[csf("composition")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['dia_width']=$row[csf("dia_width")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['color_type']=$color_type[$row[csf("color_type")]];

						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fin_cons']+=$row[csf("cons")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['consRow']+=1;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['amount']+=$row[csf("amount")];

					}



			if(count($fabric_detail_color_arr)>0){
				?>


            <table id="table_header_1" class="rpt_table" width="1210" cellpadding="0" cellspacing="0" border="1" rules="all">
           				<caption> <b style="float:left">Fabric Details :</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Gmt Item</th>
						<th width="120">Fab. Nature</th>
						<th width="120">Body Part</th>
						<th width="100">Construction</th>
						<th width="100">Composition</th>
						<th width="100">Width</th>
						<th width="100">Color Type</th>


						<th width="100">Gmt Color</th>
						<th width="100">Fab. Color</th>
					    <th width="50">UOM</th>
						<th width="90">Fin. Cons</th>
						<th width="90">Total Fin Cons. </th>
						<!-- <th width="90">Fab. Source</th> -->

                    </thead>
            </table>
			<table class="rpt_table"   width="1210" cellpadding="0" cellspacing="0" border="1" rules="all" id="table_body1">

			<?

				 // print($fabric_detail_arr);
					$item_rowspan_arr=array();$fab_rowspan_arr=array();

					foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
					{
						 $fab_body_rowspan=0;
						  foreach($fab_dtls_data as $fab_color_key=>$val)
						  {
							$fab_body_rowspan++;
						  }
						$fab_rowspan_arr[$fab_dtls_id_key]=$fab_body_rowspan;
					 }
					//print_r($fab_rowspan_arr);

					$i=$m=1;$total_greycons=$total_tot_greycons=$total_tot_fin_cons=$grand_total_fin_cons=$grand_total_tot_greycons=$grand_total_amount=0;

						foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
						{
					  		$y=1;
							foreach($fab_dtls_data as $fab_color_key=>$val)
							{

								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

								$uom_key=$val['uom'];
								$body_key=$val['body_id'];
								$item_key=$val['item_id'];
								$desc_key=$val['item_desc'];
								$nat_key=$val['nat_id'];$fab_source_key=$val['fabric_source'];
								$gmt_color=rtrim($val['gmt_color'],',');
								$gmt_colorid=array_unique(explode(",",$gmt_color));
								$gmt_color="";
								$wv_fincons=$fincons_knit=$tot_amount=0;
								foreach($gmt_colorid as $gid)
								{
									if($gmt_color=="") $gmt_color=$color_library[$gid];else $gmt_color.=",".$color_library[$gid];

									$fincons_knit+=$fabric_qty_arr['knit']['finish'][$fab_dtls_id_key][$gid][$uom_key];
									$wv_fincons+=$fabric_qty_arr['woven']['finish'][$fab_dtls_id_key][$gid][$uom_key];
								}
								$tot_fin_qty=$fincons_knit+$wv_fincons;
					?>

						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">  <?
                      	 if($y==1){
						?>
							<td width="30" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key]?>"><? echo $m; ?></td>
							<td width="100" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $garments_item[$item_key]; ?></td>
							<td width="120" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $item_category[$nat_key]; ?></td>
							<td width="120" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key];;?>" align="center"><div style="word-break:break-all"><? echo $body_part[$body_key]; ?></div></td>
                             <?
							 }

							?>
							<td width="100"  align="center"><div style="word-break:break-all"><? echo $val['construction']; ?></div></td>
							<td width="100"  align="center"><div style="word-break:break-all"><? echo $val['composition']; ?></div></td>
							<td width="100"  align="center"><div style="word-break:break-all"><? echo $val['dia_width']; ?></div></td>
							<td width="100"  align="center"><div style="word-break:break-all"><? echo $val['color_type']; ?></div></td>


                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $gmt_color; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $color_library[$fab_color_key]; ?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['uom']]; ?></td>
							<td width="90"  align="right">
                            <div style="word-break:break-all">
							<?

							 echo fn_number_format($val['fin_cons']/$val['consRow'],4);
							 ?>
                            </div>
                            </td>
                            <td width="90"  align="right"><div style="word-break:break-all"><? echo fn_number_format($tot_fin_qty,4); ?></div></td>
							<!-- <td width="90"  align="center"><div style="word-break:break-all"><? echo $fabric_source[$fab_source_key]; ?></div></td> -->

                            </tr>
                            <?
								$total_fin_cons+=$tot_fin_qty;
								$total_tot_fin_cons+=$val['fin_cons'];
								$grand_total_fin_cons+=$tot_fin_qty;

									$y++;
									$i++;
									}
								$m++;
							?>
                            <?

						}
							?>
                            <tfoot>
                            <tr>
                            <th colspan="11" ><strong>Grand Total</strong> </th>

                            <th align="right"><strong><? //echo fn_number_format($total_tot_fin_cons,4);?></strong> </th>
                            <th align="right"><strong><? echo fn_number_format($grand_total_fin_cons,4);?></strong> </th>
							<!-- <th><strong>&nbsp;</strong> </th> -->
                            </tr>
                            </tfoot>
                    </table>
					<br/>
					<?
			}
					$item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
					$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id  and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

					$trims_qty_arr=$trims->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
					$trims_item_qty_arr=$trims->getQtyArray_by_jobAndItemid();
					$trims_desc_qty_arr=$trims->getQtyArray_by_jobItemidAndDescription();

					$trims_dtl_qty_arr=$trims->getQtyArray_by_OrderPrecostdtlsidGmtscolorAndGmtssize();
					//print_r($trims_amt_arr);

				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and ( c.nominated_supp_multi is null or c.nominated_supp_multi='' or c.nominated_supp_multi=0)";
				 }

				 $sql_trim_color="select c.id,c.job_no,c.trim_group,c.description,c.brand_sup_ref,c.nominated_supp_multi as nominated_supp,c.cons_uom,c.remark,d.wo_pre_cost_trim_cost_dtls_id as fab_dtl_id,d.item_size,d.color_number_id,d.item_number_id,d.size_number_id,d.po_break_down_id as po_id,d.excess_per,d.cons,d.tot_cons,c.source_id from wo_pre_cost_trim_cost_dtls c,wo_pre_cost_trim_co_cons_dtls d
				 where c.job_no=d.job_no and d.wo_pre_cost_trim_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and d.cons>0 and c.job_no='$txt_job_no' $txt_po_breack_down_id_cond2 $nom_sup_cond order by c.id,c.trim_group";
				 //echo  $sql_trim_color;
				 $trim_result=sql_select($sql_trim_color);$tot_trim_req_qty=0;
				 foreach($trim_result as $row)
				 {
					if($excess_per_val>0)
					{
						$total_set_qnty=$job_total_set_qnty_arr[$row[csf('job_no')]];
						$order_quantity=$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity'];
						//echo $plan_cut_qnty.'<br/>';
						$tot_cons_qnty=$row[csf("tot_cons")]+($row[csf("tot_cons")]*$excess_per_val)/100;
						$trim_req_qty=($order_quantity/$total_set_qnty)*($tot_cons_qnty/$costPerQty);
						$excess_per=$excess_per_val;
						//echo $trim_req_qty.'='.$excess_per_val.', ';
						//$tot_trim_req_qty+=$trim_req_qty;
					}
					else
					{
						$excess_per=0;
						$excess_per=$row[csf("excess_per")];
						$tot_cons_qnty=$row[csf("cons")];
						//$trim_req_qty=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
						$trim_req_qty=$trims_dtl_qty_arr[$row[csf("po_id")]][$row[csf("id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					}
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['description']=$row[csf("description")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['nominated_supp']=$row[csf("nominated_supp")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['size_number_id']=$row[csf("size_number_id")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['job_no']=$row[csf("job_no")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_size']=$row[csf("item_size")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['remark']=$row[csf("remark")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_uom']=$row[csf("cons_uom")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons']=$row[csf("tot_cons")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['source_id']=$row[csf("source_id")];

					//$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trim_req_qty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_cons']=$tot_cons_qnty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['excess_per']=$excess_per;
					$item_tot_qty_arr[$row[csf("trim_group")]][$row[csf("description")]]+=$trim_req_qty;

				 }
				// echo $tot_trim_req_qty.', ';
				  	foreach($trims_color_arr as $trim_key=>$trim_data)
					 {
						  $trim_color_rowspan=0;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						   $trim_desc_rowspan=0;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
								$item_size_rowspan=0;
								foreach($color_data as $size_key=>$val)
								{
									$item_size_rowspan++;
									$trim_desc_rowspan++;
									$trim_color_rowspan++;
									$color_qty[$trim_key][$desc_key][$gmt_color_key]+=$val['tot_size_cons'];
									$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]+=1;
								}
								$item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]=$item_size_rowspan;
								$trim_desc_rowspan_arr[$trim_key][$desc_key]=$trim_desc_rowspan;
								$trim_size_rowspan_arr[$trim_key]=$trim_color_rowspan;

							}
						   }
					}
				 	//print_r($trim_size_rowspan_arr);
					?>
           		 <table id="table_header_1" class="rpt_table" width="1020" cellpadding="0" cellspacing="0" border="1" rules="all">
           			<caption> <b style="float:left">Trims Details:</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Item</th>
						<th width="120">Description</th>


						<th width="100">Supplier</th>
						<th width="100">Gmt Color</th>
						<th width="100">Item Size</th>

					    <th width="50">UOM</th>
						<th width="80">Cons</th>
						<th width="80">Exs %</th>
						<th width="80">Total Cons. </th>
						<th width="80">Total Qty </th>
						<th width="80">Color Total Qty.</th>
						<th width="80">Item Total Qty.</th>
						<th width="100">Remarks</th>

                    </thead>
					<tbody>
					 <?

					 	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

						 $j=1;$total_trim_cons=$total_tot_trim_cons_qty=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
						 foreach($trims_color_arr as $trim_key=>$trim_data)
					 	 {
						   $k=1;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						    $n=1;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
						    $m=1;$c=1;
						     foreach($color_data as $size_key=>$val)
					 	     {
								if($j%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								if($col_size_cons_arr[$trim_key][$gmt_color_key]>0)
								{
								$tot_size_qty=$col_size_cons_arr[$trim_key][$gmt_color_key];
								}
								if($item_tot_cons_arr[$trim_key]>0)
								{
								$item_tot_size_qty=$item_tot_cons_arr[$trim_key];
								}
								$job_no=$val['job_no'];
								$item_size=$val['item_size'];
								$tot_size_cons=$val['tot_size_cons'];

								$gmt_item_desc_qty=$item_tot_qty_arr[$trim_key][$desc_key];//$trims_desc_qty_arr[$job_no][$trim_key][$desc_key];
								//$gmt_item_desc_qty=$trims_item_qty_arr[$job_no][$trim_key];
								$gmt_size_qty=$tot_size_cons;//$trims_qty_arr[$job_no][$trim_key][$desc_key][$gmt_color_key][$size_key];
								//$item_tot_qty=$item_tot_qty_arr[$trim_key][$desc_key];


								$nominated_supp_str="";
								$exsupp=explode(",",$val["nominated_supp"]);
								foreach($exsupp as $sid)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
								}


					?>

						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $j; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $j; ?>">  <?
                      	 if($k==1){
						?>
							<td width="30" rowspan="<? echo $trim_size_rowspan_arr[$trim_key]?>"><? echo $j; ?></td>
							<td width="100" rowspan="<?  echo $trim_size_rowspan_arr[$trim_key];?>"><? echo $item_group_arr[$trim_key]; ?></td>
							 <?

							 }
							//$tot_gmt_size_qty=0;


							  if($n==1){

							 ?>
							<td width="120" rowspan="<?  echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"><? echo  $desc_key; ?></td>




							<td width="100"  rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" ><div style="word-break:break-all"><?=$nominated_supp_str; ?></div></td>
                             <?
							 }

							if($m==1){

							?>
                            <td width="100" rowspan="<? echo $item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"  align="center"><div style="word-break:break-all"><? echo $color_library[$gmt_color_key]; ?></div></td>
							<?
							}
							?>
                            <td width="100" title="<?=$size_key?>"  align="center"><div style="word-break:break-all"><?=$size_key?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['cons_uom']]; ?></td>
							<td width="80"  align="center"><div style="word-break:break-all"><? echo fn_number_format($val['cons'],4); ?></div></td>

                            <td width="80"  align="right" title="<? echo $val['excess_per']; ?>"><div style="word-break:break-all"><? echo fn_number_format($val['excess_per'],4);//echo fn_number_format($val['excess_per'],4); ?></div></td>

							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($val['tot_cons'],4); ?></div></td>
							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($gmt_size_qty,2); ?></div></td>
							<?


							 if($c==1){
							?>
                            <td width="80"   align="center" rowspan="<?=$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"><div style="word-break:break-all"><? echo  fn_number_format($color_qty[$trim_key][$desc_key][$gmt_color_key],2); ?></div></td>
							<?
							 $c++;}
							if($n==1){
							 $total_tot_item_qty_cons+=$gmt_item_desc_qty;
							?>
                            <td width="80" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"  align="center"><div style="word-break:break-all"><? echo  fn_number_format($gmt_item_desc_qty,2); ?></div></td>
							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"  align="center"><div style="word-break:break-all"><? echo $val['remark']; ?></div></td>
							<?
							}
							?>


                       </tr>
					   <?
					   		$total_tot_trim_cons_qty+=$val['cons'];
							$total_trim_cons+=$val['tot_cons'];
							$total_trim_qty_cons+=$gmt_size_qty;
							$k++;$m++;$n++;

					   		}
							?>

							<?
						    }

						   }

						  $j++;
					   	}
					   ?>
						<tfoot>
						<tr>
							<th colspan="6" align="right"> Grand Total </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_trim_cons_qty,4); ?> </th>

							<th align="right"> <? //echo fn_number_format($total_tot_trim_qty,4); ?> </th>
							<th> <? echo fn_number_format($total_trim_cons,4); ?> </th>
							<th align="right"> <? echo fn_number_format($total_trim_qty_cons,2); ?> </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_item_qty_cons,2); ?> </th>
						</tr>
						</tfoot>
					</tbody>
            </table>

		</div>
		<br>
		<?=signature_table(109, $cbo_company_name, "950px"); ?>
	</div>
	<?
	exit();
}

if($action=="budget_cost_validate")
{
	$exdata=explode("**",$data);
	$cost_sheet_id=$exdata[0];
	$bomfabamt=0;

	//echo $exdata[1]; die;
	if($exdata[2]==5 || $exdata[2]==8)
	{
		if($exdata[1]==0)
		{
			$sql_yarn_rate=sql_select("select fab_id as prifabdtlsid, type, cons_rate_dtls_id as pribodydtlsid, count as count_id, composition as copm_one_id, percent as percent_one, yarn_type as type_id, cons as cons_qnty, tot_cons as avg_cons_qnty, rate, value as amount, nominated_supp_multi as supplier_id, process from qc_fab_yarn_conv where qc_no='$cost_sheet_id' and type in (2,3) and cons>0 and status_active=1 and is_deleted=0 order by id");
			foreach($sql_yarn_rate as $yrow)
			{
				if($yrow[csf('type')]==2)//Yarn
				{
					if($yrow[csf('count_id')]=="") $yrow[csf('count_id')]=0;
					if($yrow[csf('copm_one_id')]=="") $yrow[csf('copm_one_id')]=0;
					if($yrow[csf('percent_one')]=="") $yrow[csf('percent_one')]=0;
					if($yrow[csf('type_id')]=="") $yrow[csf('type_id')]=0;
					if($yrow[csf('rate')]=="") $yrow[csf('rate')]=0;
					if($yrow[csf('supplier_id')]=="") $yrow[csf('supplier_id')]=0;
					$yarn_rate_array[$yrow[csf('prifabdtlsid')]][$yrow[csf('count_id')]][$yrow[csf('copm_one_id')]][$yrow[csf('percent_one')]][$yrow[csf('type_id')]]=$yrow[csf('rate')];

					if(isset($yarnString[$yrow[csf('prifabdtlsid')]]))
					{
						$yarnString[$yrow[csf('prifabdtlsid')]].= "__".$yrow[csf('count_id')]."_".$yrow[csf('copm_one_id')]."_100_".$yrow[csf('type_id')]."_".$yrow[csf('percent_one')];
					}
					else
					{
						$yarnString[$yrow[csf('prifabdtlsid')]]= $yrow[csf('count_id')]."_".$yrow[csf('copm_one_id')]."_100_".$yrow[csf('type_id')]."_".$yrow[csf('percent_one')];
					}
				}
				else if($yrow[csf('type')]==3)
				{
					if(array_key_exists($yrow[csf('prifabdtlsid')],$convDataArr))
					{
						$convDataArr[$yrow[csf('prifabdtlsid')]].="##".$yrow[csf('process')].",".$yrow[csf('rate')];
						$isConv=1;
					}
					else
					{
						$convDataArr[$yrow[csf('prifabdtlsid')]]=$yrow[csf('process')].",".$yrow[csf('rate')];
						$isConv=1;
					}
				}
			}
			unset($sql_yarn_rate);
		}
		else
		{
			$yarnString=array(); $yarn_rate_array=array();
			$sqlYarnData="select fabric_cost_dtls_id, job_id, count_id, copm_one_id, percent_one, type_id, cons_ratio, rate from wo_pre_cost_fab_yarn_cost_dtls where  job_id =".$exdata[4]." and status_active=1 and is_deleted=0";

			$sqlYarnDataArr=sql_select($sqlYarnData);
			foreach($sqlYarnDataArr as $row_yarn_rate)
			{
				$yarn_rate_array[$row_yarn_rate[csf('fabric_cost_dtls_id')]][$row_yarn_rate[csf('count_id')]][$row_yarn_rate[csf('copm_one_id')]][$row_yarn_rate[csf('cons_ratio')]][$row_yarn_rate[csf('type_id')]]=$row_yarn_rate[csf('rate')];

				if(isset($yarnString[$row_yarn_rate[csf('fabric_cost_dtls_id')]]))
				{
					$yarnString[$row_yarn_rate[csf('fabric_cost_dtls_id')]].= "__".$row_yarn_rate[csf('count_id')]."_".$row_yarn_rate[csf('copm_one_id')]."_".$row_yarn_rate[csf('percent_one')]."_".$row_yarn_rate[csf('type_id')]."_".$row_yarn_rate[csf('cons_ratio')];
				}
				else
				{
					$yarnString[$row_yarn_rate[csf('fabric_cost_dtls_id')]]= $row_yarn_rate[csf('count_id')]."_".$row_yarn_rate[csf('copm_one_id')]."_".$row_yarn_rate[csf('percent_one')]."_".$row_yarn_rate[csf('type_id')]."_".$row_yarn_rate[csf('cons_ratio')];
				}
			}
			unset($sqlYarnDataArr);
			/*echo '<pre>';
			print_r($yarn_rate_array);*/

			$fabConv="select id as ID, job_no as JOB_NO, fabric_description as FABID, cons_process as CONS_PROCESS, req_qnty as REQ_QNTY, charge_unit as CHARGE_UNIT, amount as AMOUNT from wo_pre_cost_fab_conv_cost_dtls where status_active=1 and is_deleted=0 and job_id =".$exdata[4]."";

			$convFabRes=sql_select($fabConv); $convFabArr=array();
			foreach($convFabRes as $cvrow)
			{
				$convFabArr[$cvrow['FABID']][$cvrow['ID']]['rate']=$cvrow['CHARGE_UNIT'];
			}
			/*unset($convFabRes);
			echo '<pre>';*/
			//print_r($convFabArr);
		}

		$fdata=array_filter(explode("@@",$exdata[5]));
		/*echo '<pre>';
		print_r($fdata);*/

		$totrow=count($fdata);

		foreach ($fdata as $frow)
		{
			$fdata=explode("=",$frow);

			$libyarncountdeterminationid=$oldlibyarncountdeterminationid=$yarnbreackdown=$updateid=$prifabcostdtlsid="";
			$txtconsumption=$txtrate=$txtamount=$txtavgprocessloss=$avgtxtconsumption=$avgtxtgsmweight=$cbofabricnature=0;


			$libyarncountdeterminationid=$fdata[0];
			$oldlibyarncountdeterminationid=$fdata[1];
			$txtconsumption=$fdata[2];
			$txtrate=$fdata[3];
			$txtamount=$fdata[4];
			$txtavgprocessloss=$fdata[5];
			$fupdateid=$fdata[6];
			$yarnbreackdown=$fdata[7];

			$avgtxtconsumption=$fdata[8];
			$avgtxtgsmweight=$fdata[9];
			$prifabcostdtlsid=$fdata[10];
			$cbofabricnature=$fdata[11];
			//echo $cbofabricnature.'<br>';
			/*$yarnbreackdown="yarnbreackdown_".$i;
			$prifabcostdtlsid="prifabcostdtlsid_".$i;
			$updateid="updateid_".$i;*/

			if(str_replace("'",'',$yarnbreackdown)!="")
			{
				$yarnbreckdown_array=array();
				if($exdata[1]==0)
				{
					if(str_replace("'",'',$oldlibyarncountdeterminationid)!=str_replace("'",'',$libyarncountdeterminationid))
					{
						$yarnbreckdown_array=explode('__',str_replace("'",'',$yarnbreackdown));
					}
					else if(str_replace("'",'',$oldlibyarncountdeterminationid)==str_replace("'",'',$libyarncountdeterminationid))
					{
						$yarnbreckdown_array=explode('__',$yarnString[str_replace("'","",$prifabcostdtlsid)]);
					}
				}
				else
				{
					if(str_replace("'",'',$oldlibyarncountdeterminationid)!=str_replace("'",'',$libyarncountdeterminationid))
					{
						$yarnbreckdown_array=explode('__',str_replace("'",'',$yarnbreackdown));
					}
					else if(str_replace("'",'',$oldlibyarncountdeterminationid)==str_replace("'",'',$libyarncountdeterminationid))
					{
						$yarnbreckdown_array=explode('__',$yarnString[$fupdateid]);
						/*echo '<pre>';
						print_r($yarnbreckdown_array);*/
					}
					if($yarnString[$fupdateid]=="" && str_replace("'",'',$oldlibyarncountdeterminationid)==str_replace("'",'',$libyarncountdeterminationid)){
						$yarnbreckdown_array=explode('__',str_replace("'",'',$yarnbreackdown));
					}
				}

				for($c=0; $c<count($yarnbreckdown_array); $c++)
				{
					$counter++;
					$yarnbreckdownarr=explode('_',$yarnbreckdown_array[$c]);
					$ycons=$avg_cons=$yrate=$yamount=0;

					if(str_replace("'",'',$cbofabricnature)==2)
					{
						$ycons=def_number_format((($txtconsumption*$yarnbreckdownarr[4])/100),8,"");
						$avg_cons=def_number_format(((str_replace("'",'',$$avgtxtconsumption)*$yarnbreckdownarr[4])/100),8,"");

						//if($fupdateid==39842) echo $txtconsumption.'*'.$yarnbreckdownarr[4].'<br>';
					}
					if(str_replace("'",'',$cbofabricnature)==3)
					{
						$ycons=def_number_format(((str_replace("'",'',$txtgsmweight)*$yarnbreckdownarr[4])/100),8,"");
						$avg_cons=def_number_format(((str_replace("'",'',$avgtxtgsmweight)*$yarnbreckdownarr[4])/100),8,"");
					}

					if($exdata[1]==0) $yrate=$yarn_rate_array[str_replace("'","",$prifabcostdtlsid)][$yarnbreckdownarr[0]][$yarnbreckdownarr[1]][$yarnbreckdownarr[4]][$yarnbreckdownarr[3]];
					else $yrate=$yarn_rate_array[$fupdateid][$yarnbreckdownarr[0]][$yarnbreckdownarr[1]][$yarnbreckdownarr[4]][$yarnbreckdownarr[3]];

					//echo str_replace("'",'',$txtconsumption).'-'.$yarnbreckdownarr[4].'-'.$cons.'-'.$rate.'<br>';

					$yamount=$ycons*$yrate;
					$bomfabamt+=$yamount;
				}
			}



			if($isConv==1)
			{
				$fabconvstr=explode('##',$convDataArr[str_replace("'","",$prifabcostdtlsid)]);

				foreach($fabconvstr as $convstr)
				{
					$convbreakdownarr=explode(',',$convstr);
					$convAmount=str_replace("'",'',$txtconsumption)*$convbreakdownarr[1];

					$bomfabamt+=$convAmount;
				}
			}

			foreach($convFabArr[$fupdateid] as $convid=>$covdata)
			{
				$convAmount=$txtconsumption*$covdata['rate'];

				//echo $fupdateid.'-'.$convid.'-'.$txtconsumption.'-'.$covdata['rate'].'<br>';
				$bomfabamt+=$convAmount;
			}
		}
	}

	$str_data="";
	if($cost_sheet_id!=0)
	{
		$is_approved=0;
		$approved_sql=sql_select("select approved from qc_confirm_mst where cost_sheet_id='$cost_sheet_id' and status_active=1 and is_deleted=0");
		$is_approved=$approved_sql[0][csf('approved')];

		$entryform_sql=sql_select("select entry_form from qc_mst where qc_no='$cost_sheet_id' and status_active=1 and is_deleted=0");
		$entry_formno=$entryform_sql[0][csf('entry_form')];
		if($entry_formno==458) $is_approved=1;//ISD-22-23947

		$sql="select fab_cons_kg, fab_cons_mtr, fab_cons_yds, fab_amount, sp_oparation_amount, acc_amount, fright_amount, lab_amount, operating_exp, other_amount, comm_amount, fob_amount, cm_amount, commercial_cost, rmg_ratio, wash_amount, inspection_cost from qc_confirm_dtls where cost_sheet_id='$cost_sheet_id' and status_active=1 and is_deleted=0";
		$dataArr=sql_select($sql);
		$fab_cons_kg=$fab_cons_mtr=$fab_cons_yds=$fab_amount=$sp_oparation_amount=$acc_amount=$fright_amount=$lab_amount=$operating_exp=$other_amount=$comm_amount=$fob_amount=$cm_amount=$commercial_cost=$rmg_ratio=$wash_amount=$inspection_cost=0;

		foreach($dataArr as $row)
		{
			$fab_cons_kg+=$row[csf("fab_cons_kg")];
			$fab_cons_mtr+=$row[csf("fab_cons_mtr")];
			$fab_cons_yds+=$row[csf("fab_cons_yds")];
			$fab_amount+=$row[csf("fab_amount")];
			$sp_oparation_amount+=$row[csf("sp_oparation_amount")];
			$acc_amount+=$row[csf("acc_amount")];
			$fright_amount+=$row[csf("fright_amount")];
			$lab_amount+=$row[csf("lab_amount")];
			$operating_exp+=$row[csf("operating_exp")];
			$other_amount+=$row[csf("other_amount")];
			$comm_amount+=$row[csf("comm_amount")];
			$fob_amount+=$row[csf("fob_amount")];
			$cm_amount+=$row[csf("cm_amount")];
			$rmg_ratio+=$row[csf("rmg_ratio")];
			$commercial_cost+=$row[csf("commercial_cost")];
			$wash_amount+=$row[csf("wash_amount")];
			$inspection_cost+=$row[csf("inspection_cost")];
		}
		$str_data=fn_number_format($fab_cons_kg,4)."##".fn_number_format($fab_cons_mtr,4)."##".fn_number_format($fab_cons_yds,4)."##".fn_number_format($fab_amount,4)."##".fn_number_format($sp_oparation_amount,4)."##".fn_number_format($acc_amount,4)."##".fn_number_format($fright_amount,4)."##".fn_number_format($lab_amount,4)."##".fn_number_format($operating_exp,4)."##".fn_number_format($other_amount,4)."##".fn_number_format($comm_amount,4)."##".fn_number_format($fob_amount,4)."##".fn_number_format($cm_amount,4)."##".fn_number_format($commercial_cost,4)."##".fn_number_format($rmg_ratio,4)."##".$is_approved."##".$entry_formno."##".fn_number_format($bomfabamt,4)."##".fn_number_format($wash_amount,4)."##".fn_number_format($inspection_cost,4);
	}
	echo $str_data;
	exit();
}

if($action=="fabric_cost_detail")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	$show_yarn_rate=str_replace("'","",$zero_value);
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($db_type==0) $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
	if($db_type==2) $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1)	;
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	if(str_replace("'","",$txt_po_breack_down_id)=="") $po_id_cond=''; else $po_id_cond=" and b.id in (".str_replace("'","",$txt_po_breack_down_id).")";
	//array for display name
	 $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	 $comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	 $color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	 $size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	 $sql_gsm="select gsm_weight,job_no,body_part_id from wo_pre_cost_fabric_cost_dtls where job_no =$txt_job_no and body_part_id in(1,20)";
	$sql_gsm_data=sql_select($sql_gsm);
	foreach($sql_gsm_data as $row)
	{
		if($body_part_id==1) $gsm_weight_top=$sql_po_row[csf('gsm_weight')];
		if($body_part_id==20) $gsm_weight_bottom=$sql_po_row[csf('gsm_weight')];
	}
	  //$gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	// $gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	$sql_po="select a.job_no, a.total_set_qnty,b.id,b.pub_shipment_date,b.po_number,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity , c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $po_id_cond  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];

		$job_in_orders .= $sql_po_row[csf('po_number')].",";
		$txt_order_no_id .= $sql_po_row[csf('id')].",";
		$pub_shipment_date.= change_date_format($sql_po_row[csf('pub_shipment_date')]).',';
		$po_number_arr[$sql_po_row[csf('id')]]=$sql_po_row[csf('po_number')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
	}
	$pub_shipment_date=rtrim($pub_shipment_date,',');
	$job_in_orders=rtrim($job_in_orders,',');$txt_order_no_id=rtrim($txt_order_no_id,',');
	$pub_shipment_dates=implode(",",array_unique(explode(",",$pub_shipment_date)));
	$job_in_orders=implode(", ",array_unique(explode(",",$job_in_orders)));
	$txt_order_no_id=implode(",",array_unique(explode(",",$txt_order_no_id)));
	$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.ship_mode, a.avg_unit_price, a.total_price, b.costing_per, b.budget_minute, b.exchange_rate, b.approved, b.sew_smv, b.sew_effi_percent, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on  b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";


	$data_array=sql_select($sql);
	$buyer_name_id=$data_array[0][csf('buyer_name')];
	$job_no=$data_array[0][csf('job_no')];
	$tot_po_qty=$po_qty;
	$tot_po_value=$data_array[0][csf('total_price')];
	$exchange_rate=$data_array[0][csf('exchange_rate')];
	$tot_perDznValue=($tot_po_value/$tot_po_qty)*12;
	 ?>
	 <div>

        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
			$path=($path)?$path:'../../';
            ?>
            <img  src='<? echo $path.$image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Fabric Pre-Costing Details</b>
        </td></tr></table>
         <table class="rpt_table">
		 <tr>
		 <td>
			 <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $job_no; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$buyer_name_id]; ?></b></td>
                        <td width="80">Plan Cut Qnty</td>
                        <?
							$gmts_item_name="";
							$gmts_item=explode(',',$data_array[0][csf('gmts_item_id')]);
							for($g=0;$g<=count($gmts_item); $g++)
							{
								$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
							}
						?>
                        <td width="100"><b><? echo $po_plun_cut_qty; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Qty. </td>
                        <td><b><? echo $tot_po_qty." ". $unit_of_measurement[$data_array[0][csf('order_uom')]]; ?></b></td>
						<td>Style Ref. </td>
                        <td><b><? echo $data_array[0][csf('style_ref_no')]; ?></b></td>
                        <td>Price Per Unit</td>
                        <td><b><?  echo $data_array[0][csf('avg_unit_price')]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="5"><? echo $job_in_orders; ?></td>
                    </tr>
                    <tr>
                    	<td>Garments Item</td>
                        <td colspan="3"><b><? echo $gmts_item_name;?></b></td>
                        <td>Shipment Date</td>
                        <td><b><? echo $pub_shipment_dates;?></b></td>
                    </tr>
                    <tr>
                    	<td>Budget Minute</td>
                        <td><b><? echo $data_array[0][csf('budget_minute')]; ?></b></td>
                        <td colspan="4"  style="font-size:18px;"><font color="#FF0000"><b><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?></b></font></td>
                    </tr>
                    <tr>
                    <td>Costing Date</td>
                        <td><b><? echo $costing_date; ?> </b></td>
                        <td>Ship Mode</td>
                        <td colspan="3"><b><? echo $shipment_mode[$data_array[0][csf('ship_mode')]]; ?></b></td>
                    </tr>
                </table>
				</td>
				<td width="350">
				  <?
     	 // image show here  -------------------------------------------
              $nameArray_img =sql_select("SELECT image_location FROM common_photo_library where master_tble_id=$txt_job_no and form_name='knit_order_entry' and file_type=1");
			  $path=($path)?$path:'../../';
			  ?>
			  <div style="margin:15px 5px;float:left;width:350px" >
				<? foreach($nameArray_img AS $inf){ ?>
					<img  src='<? echo $path.$inf[csf("image_location")]; ?>' height='120' width='100' />
				<?  } ?>
			  </div>
				</td>
				</tr>
				 </table>
				<br/>
				<div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
				<?
				$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".$txt_order_no_id.") and  job_no_mst=$txt_job_no and	is_deleted=0 and status_active=1 group by size_number_id order by size_order");
				?>
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".$txt_order_no_id.") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0; $color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo fn_number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
										$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>
                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo fn_number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo fn_number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo fn_number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>
                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo fn_number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo fn_number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo fn_number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo fn_number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo fn_number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo fn_number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
				<br/><br/>
				<div>
				<!--Fabric Production Start-->
	 <?
	 $costing_per=""; $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no =$txt_job_no");
	 if($costing_per_id==1)
		{
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
		}
		if($costing_per_id==2)
		{
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
		}
		if($costing_per_id==3)
		{
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
		}
		if($costing_per_id==4)
		{
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
		}
		if($costing_per_id==5)
		{
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
		}
	//$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no=$txt_job_no");

	$nameArray_fab_uom = sql_select("select a.process_loss_method,a.uom,a.fabric_source FROM wo_pre_cost_fabric_cost_dtls a WHERE a.job_no =$txt_job_no");
	foreach($nameArray_fab_uom as $row){
	if($row[csf('fabric_source')]==2)
	{
		$uom_wise_arr[$row[csf('uom')]]=$row[csf('uom')];
	}
		$process_loss_method=$row[csf('process_loss_method')];
	}
	//print_r($uom_wise_arr); die;


	$fabric_source=1;

	$nameArray_gmts_sizes = sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.size_number_id,c.size_order FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b
	WHERE
	a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	a.job_no =$txt_job_no and c.po_break_down_id in(".$txt_order_no_id.")  and a.fabric_source=1
	group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.size_number_id,c.size_order order by c.size_order");
	$GmtsSizesArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$GmtsSizesArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('size_number_id')]]=$size_library[$sizes_row[csf('size_number_id')]];
	}
	$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

	$nameArray_gmts_sizes = sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, c.count_id FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cost_fab_yarn_cost_dtls c, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=a.job_no and  a.fabric_source=1 and a.id=c.fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=c.fabric_cost_dtls_id and a.job_no =$txt_job_no group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,c.count_id");

	$countArr=array();
	foreach($nameArray_gmts_sizes as $sizes_row){
		$countArr[$sizes_row[csf('body_part_id')]][$sizes_row[csf('color_type_id')]][$sizes_row[csf('construction')]][$sizes_row[csf('composition')]][$sizes_row[csf('gsm_weight')]][$sizes_row[csf('dia_width')]][$sizes_row[csf('count_id')]]=$yarn_count_arr[$sizes_row[csf('count_id')]];
	}
	$fabid_cond="LISTAGG(a.id, ',') WITHIN GROUP (ORDER BY a.id) fabric_cost_dtls_id";
	$nameArray_fabric_description= sql_select("select $fabid_cond,a.item_number_id, max(a.lib_yarn_count_deter_id) as determin_id,a.body_part_id,a.uom,a.color_type_id,a.fabric_source, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width,avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and a.fabric_source=1 and
	c.id=b.color_size_table_id and c.status_active=1 and c.is_deleted=0  and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and
	a.job_no =$txt_job_no and c.po_break_down_id in(".$txt_order_no_id.") and b.cons>0
	group by a.body_part_id,a.uom,a.item_number_id,a.color_type_id,a.fabric_source,a.construction,a.composition,a.gsm_weight,b.dia_width order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");


		$condition= new condition();
		if(str_replace("'","",$txt_job_no) !=''){
			$condition->job_no("=$txt_job_no");
		}
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in($txt_order_no_id)");
		}
		$condition->init();
		$fabric= new fabric($condition);$yarn= new yarn($condition);
		//$fab_data_qty_arr=$fabric->getQtyArray_by_orderGmtscolorAndBodypart_knitAndwoven_greyAndfinish();
		$fab_data_qty_arr=$fabric->getQtyArray_by_orderFabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();
		$fab_data_qty_bodydia_arr=$fabric->getQtyArray_by_OrderFabriccostidGmtscolorAndDiaWidth_knitAndwoven_greyAndfinish();
		$fab_data_amt_bodydia_arr=$fabric->getAmountArray_by_OrderFabriccostidGmtscolorAndDiaWidth_knitAndwoven_greyAndfinish();

		$fab_data_qty_body_arr=$fabric->getQtyArray_by_OrderFabriccostidFabriccolorAndDiaWidth_knitAndwoven_greyAndfinish();
		//echo $fabric->getQuery();die;
		/* echo "<pre>";
		print_r($fab_data_qty_body_arr); die; */
		//$fab_data_amt_arr=$fabric->getAmountArray_by_orderGmtscolorAndBodypart_knitAndwoven_greyAndfinish();
		$fab_data_amt_arr=$fabric->getAmountArray_by_orderGmtscolorAndBodypart_knitAndwoven_greyAndfinish();

		$conversion= new conversion($condition);
		//echo $fabric->getQuery();die;
		$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
		//print_r($fab_data_amt_arr);
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	 <caption> <label style="font-size:x-large"><b>Fabric Source Production </b></label></caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('item_number_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else echo "<td  colspan='2'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>

       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else    echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="9" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$result_fabric_description[csf('uom')]];?>)</p></td>
        <td  rowspan="9" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$result_fabric_description[csf('uom')]];?>)</p></td>
        <td  rowspan="9" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else  echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else  echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition / Yarn Type</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else  echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Yarn Count</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{

		$cArr=$countArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gcount=implode(",",$cArr);
			if( $Gcount == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$Gcount."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Gmts Size</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$sizeArr=$GmtsSizesArr[$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('dia_width')]];
			$Gsize=implode(",",$sizeArr);


			if( $Gsize == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$Gsize."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else  echo "<td colspan='2' align='center'>Fin: ".fn_number_format($result_fabric_description[csf('cons')],4).", Grey: ".fn_number_format($result_fabric_description[csf('requirment')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50'>Grey</th>";
		}
		?>

       </tr>
       <?
	      //fab_nature_id,fabric_source //and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source
		  $gmt_color_library=array();//fabric_cost_dtls_id
		  $gmt_color_data=sql_select("select a.id as pre_cost_id,a.color_size_sensitive,a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id  and  a.job_no =$txt_job_no and a.color_size_sensitive=3");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$gmt_color_row[csf("gmts_color_id")];
			$gmt_color_library2[$gmt_color_row[csf("gmts_color_id")]].=$gmt_color_row[csf("contrast_color_id")].',';
			$body_gmt_color_library[$gmt_color_row[csf("body_part_id")]][$gmt_color_row[csf("gmts_color_id")]]=$gmt_color_row[csf("contrast_color_id")];
		  }
		  unset($gmt_color_data);

		  $gmtsColorData=sql_select("select c.color_number_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id  and a.job_no =$txt_job_no and c.po_break_down_id in(".$txt_order_no_id.") and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by c.color_number_id");//and a.color_size_sensitive!=3
			foreach($gmtsColorData as $cdata)
			{
				$gmt_color_library[$cdata[csf("color_number_id")]][$cdata[csf("color_number_id")]]=$cdata[csf("color_number_id")];
			}
			 unset($gmtsColorData);

			$grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
		foreach($gmt_color_library as $fcolorid=>$gcolorIdData)
	    {

			foreach($gcolorIdData as $gcolorId)
			{
				//echo $gcolorId;
				if($fcolorid=="") $fcolorid=$gcolorId; else $fcolorid=$fcolorid;

				?>
				<tr>
					<td  width="120" align="left">
					<?
						if($fcolorid==""){ echo $color_library[$gcolorId];$fcolorid=$gcolorId;} else{ echo $color_library[$fcolorid];}
					?>
					</td>
					<td>
					<?
						$gmt_color_id=$gcolorId;//$gmt_color_library2[$color_wise_wo_result[csf('fabric_color_id')]];
						echo $color_library[$gmt_color_id];
					?>
					</td>
					<td  width="120" align="left">
					<?
					$lapdip_no="";
					$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst=$txt_job_no and approval_status=3 and color_name_id=".$gcolorId."");
					if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
					?>
					</td>
					<?
					$total_fin_fab_qnty=0;
					$total_grey_fab_qnty=0;//b.color_number_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and

					foreach($nameArray_fabric_description as $result_fabric_description)
					{
					?>
					<td width='50' align='right'>
					<?
					$fabric_source_id=$result_fabric_description[csf('fabric_source')];
					$fabric_cost_dtls_ids=rtrim($result_fabric_description[csf('fabric_cost_dtls_id')],',');
					$fabric_cost_dtls_idsAll=array_filter(array_unique(explode(",",$fabric_cost_dtls_ids)));

					$fabric_cost_dtls_id_chk=implode(",",(array_unique(explode(",",$fabric_cost_dtls_ids))));

					//echo $color_wise_wo_result_qnty[csf('po_id')].'='.$gmt_color_id.'='.$result_fabric_description[csf('uom')];
					$expo_id=array_filter(array_unique(explode(",",$txt_order_no_id))); $fab_knit_fin_qty=0; $fab_knit_grey_qty=0;
					foreach($fabric_cost_dtls_idsAll as $fab_id)
					{
						foreach($expo_id as $poids)
						{

							 if( $fcolorid=="" ) $fcolorid=$gmt_color_id;
							$fab_knit_fin_qty+=$fab_data_qty_body_arr['knit']['finish'][$poids][$fab_id][$gmt_color_id][$fcolorid][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('uom')]]+$fab_data_qty_body_arr['woven']['finish'][$poids][$fab_id][$gmt_color_id][$fcolorid][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('uom')]];

							$fab_knit_grey_qty+=$fab_data_qty_body_arr['knit']['grey'][$poids][$fab_id][$gmt_color_id][$fcolorid][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('uom')]]+$fab_data_qty_body_arr['woven']['grey'][$poids][$fab_id][$gmt_color_id][$fcolorid][$result_fabric_description[csf('dia_width')]][$result_fabric_description[csf('uom')]];
						}
					}

					$tot_fab_fin_qty=$fab_knit_fin_qty;
					if($tot_fab_fin_qty!="")
					{
						echo fn_number_format($tot_fab_fin_qty,2);
						$fab_fin_qty_descrp_wise_arr[$fabric_cost_dtls_id_chk][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]]+=$tot_fab_fin_qty;
						$total_fin_fab_qnty+=$tot_fab_fin_qty;
					}
					?>
					</td>
					<td width='50' align='right' >

					<?
					if($fab_knit_grey_qty!="")
					{
						if($process_loss_method==1)
						{
							$process_loss_percent=(($fab_knit_grey_qty-$tot_fab_fin_qty)/$tot_fab_fin_qty)*100;
						}

						if($process_loss_method==2)
						{
							$process_loss_percent=(($fab_knit_grey_qty-$tot_fab_fin_qty)/$fab_knit_grey_qty)*100;
						}
						echo fn_number_format($process_loss_percent,2)."%<hr>";
						echo fn_number_format($fab_knit_grey_qty,2);
						$total_grey_fab_qnty+=$fab_knit_grey_qty;
						$fab_grey_qty_descrp_wise_arr[$fabric_cost_dtls_id_chk][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]]+=$fab_knit_grey_qty;


					}
					?>
					</td>
					<?
					}
					?>
					<td align="right"><? echo fn_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
					<td align="right"><? echo fn_number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

					<td align="right">
					<?
					if($process_loss_method==1)
					{
						$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;

					}

					if($process_loss_method==2)
					{
						$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
					}
					echo fn_number_format($process_percent,2);

					?>
					</td>
				</tr>
			 	<?
			}
		}
		?>
        <tr style=" font-weight:bold">
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$fabric_cost_dtls_ids=rtrim($result_fabric_description[csf('fabric_cost_dtls_id')],',');
				$fabric_cost_dtls_idchk=implode(",",(array_unique(explode(",",$fabric_cost_dtls_ids))));

				$ttl_fab_knit_fin_qty=$fab_fin_qty_descrp_wise_arr[$fabric_cost_dtls_idchk][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]];
				$ttl_fab_knit_grey_qty=$fab_grey_qty_descrp_wise_arr[$fabric_cost_dtls_idchk][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]];


			?>
			<td width='50' align='right'><?  echo fn_number_format($ttl_fab_knit_fin_qty,2) ;?></td><td width='50' align='right' > <? echo fn_number_format($ttl_fab_knit_grey_qty,2);?></td>
            <?
			}
			?>
            <td align="right"><? echo fn_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo fn_number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo fn_number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


			?>
			<td width='50' align='right'><?  //echo fn_number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td><td width='50' align='right' > <? //echo fn_number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			//echo $tot_po_qty.'=='.$total_set_qnty;
			echo fn_number_format(($grand_total_fin_fab_qnty/$tot_po_qty)*($total_set_qnty*$costing_per_qnty),4);
			$grand_total_fin_fab_qnty_dzn=fn_number_format(($grand_total_fin_fab_qnty/$tot_po_qty)*($total_set_qnty*$costing_per_qnty),4);


			?>
            </td>
            <td align="right"><? echo fn_number_format(($grand_total_grey_fab_qnty/$tot_po_qty)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=fn_number_format(($grand_total_grey_fab_qnty/$tot_po_qty)*($total_set_qnty*$costing_per_qnty),4)?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
			}
			echo fn_number_format($totalprocess_percent_dzn,2);
			?>
            </td>
            </tr>
    </table>
    <?



	 ?>
				</div> <!--Production End-->
				<div>
				<?
					$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  job_no_mst=$txt_job_no and po_break_down_id in(".$txt_order_no_id.") and status_active=1 and is_deleted =0 group by color_number_id, size_number_id");
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id,e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no =$txt_job_no and c.po_break_down_id in(".$txt_order_no_id.") and a.body_part_id=e.id and a.fabric_source=1 and e.body_part_type in (40,50) and c.id=b.color_size_table_id and c.status_active=1 and c.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res); $jk=0;
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					if($jk==0 || (($jk/2)==0)) {
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin:5px; margin-bottom:5px; position:relative;"> <? } ?>
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size <? echo $jk; ?></td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													if($body_type==50) $plan_cut=($order_plan_qty_arr[$color_number_id][$size_number_id]['plan'])*2;
													else $plan_cut=$order_plan_qty_arr[$color_number_id][$size_number_id]['plan'];
                                                    $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';
												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=fn_number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=fn_number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo fn_number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo fn_number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo fn_number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo fn_number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo fn_number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo fn_number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                     <? if($jk==0 || (($jk/2)==0)) { ?>
                </div> <? } ?>
                <br/>
                <?
				$jk++;
            }
        }
				?>
				<br>
				<?

		$yarn_data_array=$yarn->getOrderCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$cos_per_arr=$condition->getCostingPerArr();
		//print_r($yarn_data_array);
		$yarn_sql_array=sql_select("SELECT b.id as po_id, min(a.id) as yarn_id, a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate as rate from wo_pre_cost_fab_yarn_cost_dtls a, wo_po_break_down b where a.job_no=b.job_no_mst and a.job_no=$txt_job_no and b.id in (".$txt_order_no_id.") and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id, a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two,a.rate,a.color, a.type_id order by type_id");
		?>
		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    	<td colspan="5"><b>Yarn Required Summary (Pre Cost)</b></td>
                    </tr>
                    <tr align="center">
                        <td>Sl</td>
                        <td>PO</td>
                        <td>Yarn Description</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td>Rate</td>
                        <?
                        }
                        ?>
                        <td>Cons for <? echo $costing_per; ?> Gmts</td>
                        <td>Total Qty. </td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("po_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("po_id")]][$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
						$booking_percent=1;
						//echo $cos_per_arr[str_replace("'","",$txt_job_no)].'DDS-';
						$rate=$rowcons_Amt/$rowcons_qnty;
						//$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td><? echo $po_number_arr[$row[csf('po_id')]]; ?></td>
                            <td>
                            <?
                            $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
							$yarn_des.=$color_library[$row[csf('color')]]." ";
							$yarn_des.=$yarn_type[$row[csf('type_id')]];

                            echo $yarn_des;

                            ?>
                            </td>
                            <?
                            if($show_yarn_rate==1)
                            {
                            ?>
                             <td><? echo fn_number_format($rate,4); ?></td>
                             <?
                            }
                             ?>
                            <td title="Req Qty/PO Qty*Costing Per"><?  echo fn_number_format(($rowcons_qnty/$tot_po_qty)*$costing_per_qnty,4); ?></td>

                            <td align="right"><? echo fn_number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
						</tr>
						<?
					}
					?>
                    <tr align="center">
                        <td></td>
                        <td></td>
                        <td></td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td></td>
                        <?
                        }
                        ?>
                        <td align="right">Total : </td>
                        <td align="right"><? echo fn_number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">

                </td>
            </tr>
        </table>
	</div>
	<br>
	<div>
	<?


	foreach($uom_wise_arr as $uom_id)
	{

	$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id,  a.lib_yarn_count_deter_id as determin_id,a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.uom,a.item_number_id,min(a.width_dia_type) as width_dia_type , b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.fabric_source=2 and a.uom=$uom_id and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and a.job_no =$txt_job_no and c.po_break_down_id in(".$txt_order_no_id.") and c.status_active=1 and c.is_deleted=0 and b.requirment>0 group by a.body_part_id,a.uom,a.lib_yarn_count_deter_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.item_number_id,b.dia_width,a.id order by fabric_cost_dtls_id,a.body_part_id,b.dia_width"); //fabric_cost_dtls_id  fabric_cost_dtls_id
	/*echo '<pre>';
	print_r($fab_data_qty_bodydia_arr); die;*/
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	 <caption> <label style="font-size:x-large"><b>Fabric Source Purchase  &nbsp;<? echo $unit_of_measurement[$uom_id];?></b></label></caption>
     <tr align="center">
     <th colspan="3" align="left">Item Name</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('item_number_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else  echo "<td  colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$uom_id];?>)</p></td>
        <td  rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$uom_id];?>)</p></td>
        <td  rowspan="10" width="50"><p>Amount </p></td>
       </tr>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else  echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th   colspan="3" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else  echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else  echo "<td colspan='3' align='center'>Fin: ".fn_number_format($result_fabric_description[csf('cons')],2).", Grey: ".fn_number_format($result_fabric_description[csf('requirment')],2)."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>
       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM   wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id  and a.fabric_source =2  and a.uom=$uom_id and  a.job_no =$txt_job_no and b.pre_cost_fabric_cost_dtls_id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and a.color_size_sensitive=3");

		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
			$fab_color_library2[$gmt_color_row[csf("gmts_color_id")]]=$gmt_color_row[csf("contrast_color_id")];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;

		$color_wise_wo_sql=sql_select("select color_number_id as gmts_color_id FROM  wo_po_color_size_breakdown WHERE job_no_mst =$txt_job_no and po_break_down_id in(".$txt_order_no_id.") and status_active=1 and is_deleted=0   group by color_number_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?

			$fab_color=$fab_color_library2[$color_wise_wo_result[csf("gmts_color_id")]];
			if($fab_color!=0) echo $color_library[$fab_color];
			else echo $color_library[$color_wise_wo_result[csf('gmts_color_id')]];


			?>
            </td>
            <td>
            <?
			$gmt_color_id=$color_wise_wo_result[csf('gmts_color_id')];

			///echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			echo $color_library[$gmt_color_id];
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst=$txt_job_no and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			$expo_id=array_filter(array_unique(explode(",",$txt_order_no_id))); $fab_knit_fin_qty=0; $fab_knit_grey_qty=0; $fab_knit_grey_amount=0;
			$fab_knit_grey_qty=0;
			foreach($nameArray_fabric_description as $result_fabric_description)
			//foreach($expo_id as $poids)
		    {
				$color_wise_wo_sql_qnty=sql_select("select c.po_break_down_id as po_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and a.job_no =$txt_job_no and c.po_break_down_id in(".$txt_order_no_id.") and a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and a.construction='".$result_fabric_description[csf('construction')]."' and a.composition='".$result_fabric_description[csf('composition')]."' and a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and b.dia_width='".$result_fabric_description[csf('dia_width')]."' and nvl(c.color_number_id,0)=nvl('".$gmt_color_id."',0) and a.uom=$uom_id and c.status_active=1 and c.is_deleted=0 and b.requirment>0 group by c.po_break_down_id");
				$fab_knit_grey_qty=0;
				$fab_knit_grey_amount=0;
				foreach($color_wise_wo_sql_qnty as $color_wise_wo_result_qnty){
					$fab_knit_grey_qty+=$fab_data_qty_bodydia_arr['knit']['grey'][$color_wise_wo_result_qnty[csf('po_id')]][$result_fabric_description[csf('fabric_cost_dtls_id')]][$gmt_color_id][$result_fabric_description[csf('dia_width')]][$uom_id]+$fab_data_qty_bodydia_arr['woven']['finish'][$color_wise_wo_result_qnty[csf('po_id')]][$result_fabric_description[csf('fabric_cost_dtls_id')]][$gmt_color_id][$result_fabric_description[csf('dia_width')]][$uom_id];
					$fab_knit_grey_amount+=$fab_data_amt_bodydia_arr['knit']['grey'][$color_wise_wo_result_qnty[csf('po_id')]][$result_fabric_description[csf('fabric_cost_dtls_id')]][$gmt_color_id][$result_fabric_description[csf('dia_width')]][$uom_id]+$fab_data_amt_bodydia_arr['woven']['finish'][$color_wise_wo_result_qnty[csf('po_id')]][$result_fabric_description[csf('fabric_cost_dtls_id')]][$gmt_color_id][$result_fabric_description[csf('dia_width')]][$uom_id];
				}

			//}
			?>
			<td width='50' align='right'>
			<?
			if($fab_knit_grey_qty!="")
			{
				echo fn_number_format($fab_knit_grey_qty,2) ;
				$total_fin_fab_qnty+=$fab_knit_grey_qty;
				$total_key=$result_fabric_description[csf('body_part_id')].'*'.$result_fabric_description[csf('uom')].'*'.$result_fabric_description[csf('determin_id')].'*'.$result_fabric_description[csf('color_type_id')].'*'.$result_fabric_description[csf('construction')].'*'.$result_fabric_description[csf('composition')].'*'.$result_fabric_description[csf('gsm_weight')].'*'.$result_fabric_description[csf('item_number_id')].'*'.$result_fabric_description[csf('dia_width')].'*'.$result_fabric_description[csf('fabric_cost_dtls_id')];
				$fab_grey_qty_descrp_wise_arr[$total_key]+=$fab_knit_grey_qty;
				$fab_grey_amt_descrp_wise_arr[$total_key]+=$fab_knit_grey_amount;
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				echo fn_number_format($fab_knit_grey_amount/$fab_knit_grey_qty,2);
				?>
				</td>
				<td width='50' align='right' >
				<?
				$amount=$fab_knit_grey_amount;
				if($amount!="")
				{
				echo fn_number_format($amount,2);
				$total_amount+=$amount;
				}
				?>
				</td>
				<?
			}
			?>
            <td align="right"><? echo fn_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo fn_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo fn_number_format($total_amount,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
        	$ttl_grey_purchase_qty=0; $ttl_grey_purchase_amount=0;
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$total_key_match=$result_fabric_description[csf('body_part_id')].'*'.$result_fabric_description[csf('uom')].'*'.$result_fabric_description[csf('determin_id')].'*'.$result_fabric_description[csf('color_type_id')].'*'.$result_fabric_description[csf('construction')].'*'.$result_fabric_description[csf('composition')].'*'.$result_fabric_description[csf('gsm_weight')].'*'.$result_fabric_description[csf('item_number_id')].'*'.$result_fabric_description[csf('dia_width')].'*'.$result_fabric_description[csf('fabric_cost_dtls_id')];
				$ttl_grey_purchase_qty=$fab_grey_qty_descrp_wise_arr[$total_key_match];
				$ttl_grey_purchase_amount=$fab_grey_amt_descrp_wise_arr[$total_key_match];


			?>
			<td width='50' align='right'><?  echo fn_number_format($ttl_grey_purchase_qty,2) ;?></td>
            <td width='50' align='right' > <? //echo fn_number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
            <td width='50' align='right' ><? echo fn_number_format($ttl_grey_purchase_amount,2);?></td>
            <?
			}
			?>
            <td align="right"><? echo fn_number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo fn_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo fn_number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
            <tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


			?>
			<td width='50' align='right'><?  //echo fn_number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo fn_number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo fn_number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$tot_po_qty)*($costing_per_qnty);
			echo fn_number_format($consumption_per_unit_fab,4);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$tot_po_qty)*($costing_per_qnty);
			echo fn_number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right">
            <?
			echo fn_number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
		<br/>
    <?


	}
	?>
	<!--Fab. Source Purchase End-->
	<br/>
	<?

			$collar_cuff_percent_arr=array();
			$collar_cuff_body_arr=array();
			$collar_cuff_color_arr=array();
			$collar_cuff_size_arr=array();
			$collar_cuff_item_size_arr=array();
			$color_size_sensitive_arr=array();

			$fab_collar_cuff_data_array=$fabric->getQtyArray_by_orderGmtscolorAndGmtssize_knitAndwoven_greyAndfinish_purchase();

			$collar_cuff_sql="select a.id,a.uom, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size,c.po_break_down_id as po_id, c.size_number_id,e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no =$txt_job_no and c.po_break_down_id in(".$txt_order_no_id.") and a.body_part_id=e.id and a.fabric_source=2 and e.body_part_type in (40,50) and c.id=b.color_size_table_id and c.status_active=1 and c.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			foreach($collar_cuff_sql_res as $row)
			{
				$fab_knit_grey_size_qty=$fab_collar_cuff_data_array['knit']['grey'][$row[csf('po_id')]][$row[csf('color_number_id')]][$row[csf('gmts_sizes')]][$row[csf('uom')]];
				$collar_cuff_percent_arr[$row[csf('body_part_type')]][$row[csf('body_part_full_name')]][$row[csf('color_number_id')]][$row[csf('gmts_sizes')]]=$row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$row[csf('body_part_type')]][$row[csf('body_part_full_name')]]=$row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$row[csf('body_part_type')]][$row[csf('body_part_full_name')]][$row[csf('size_number_id')]]=$row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$row[csf('body_part_full_name')]][$row[csf('size_number_id')]][$row[csf('item_size')]]=$row[csf('item_size')];
				$color_size_sensitive_arr[$row[csf('body_part_full_name')]][$row[csf('id')]][$row[csf('color_number_id')]][$row[csf('color_size_sensitive')]]=$row[csf('color_break_down')];
				$color_size_sensitive_qty_arr[$row[csf('body_part_type')]][$row[csf('body_part_full_name')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['qty']=$fab_knit_grey_size_qty;

			}
			//print_r($color_size_sensitive_qty_arr) ;


			//print_r($fab_collar_cuff_data_array);
			unset($collar_cuff_sql_res); $jk=0;
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;
					if($jk==0 || (($jk/2)==0)) {
					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin:5px; margin-bottom:5px; position:relative;"> <? } ?>
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Breakdown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size <? echo $jk; ?></td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$size_wise_qty=$color_size_sensitive_qty_arr[$body_type][$body_val][$color_number_id][$size_number_id]['qty'];

													if($body_type==50) $plan_cut=($size_wise_qty)*2;
													else $plan_cut=$size_wise_qty;
                                                   // $ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';
												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=fn_number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=fn_number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo fn_number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo fn_number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo fn_number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo fn_number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo fn_number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo fn_number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                     <? if($jk==0 || (($jk/2)==0)) { ?>
                </div> <? } ?>
                <br/>
                <?
				$jk++;
            }
        }

		//start	Conversion Cost to Fabric report here -------------------------------------------
		$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id  and b.status_active=1 where a.job_no=".$txt_job_no."  and a.status_active=1 group by a.cons_process order by  a.cons_process";
		$tot_data_array=sql_select($sql_count);
		foreach( $tot_data_array as $row ){
				 $process_id=$row[csf("cons_process")];
				 $process_row+=count($row[csf("cons_process")]);
		 }
		 $sql = "select a.id, a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit, a.amount, a.color_break_down,a.color_break_down_aop, a.status_active, b.body_part_id, b.uom, b.fab_nature_id, b.color_type_id, b.fabric_description, b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id  and b.status_active=1 where a.job_no=".$txt_job_no." and a.status_active=1 order by a.cons_process";
		 $data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1030px;text-align:center;" rules="all">
				<tr><td colspan="10">
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Conversion Cost to Fabric </b> </label>	</td>
                <tr style="font-weight:bold">
                    <td width="230">Particulars</td>
                    <td width="100">Process</td>
                    <td width="60">Cons/Dzn</td>
					<td width="80">TTL Required</td>
					<td width="60">Uom</td>
                    <td width="160" title="For Fabric Dyeing & Yarn Dyeing">Fabric Color & Charge /Unit</td>

                    <td width="60">Rate</td>
                    <td width="60">Rate (TK)</td>
					<td width="70">Amount /Dzn</td>
                    <td width="70">TTL Amount</td>
					<td >% to Ord. Value</td>
                </tr>
            <?
			//$txt_order_no_id
			$no_color_arr=array(1=>"1 - 3",2=>"1 - 5",3=>"4 - 6",4=>"7 - 12");
			$conv_data_qty=$conversion->getQtyArray_by_conversionid();
			$conv_data_amt=$conversion->getAmountArray_by_conversionid();

            $total_conversion_cost=$total_convsion_qty_dzn=$total_conversion_cost_dzn=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=$grand_total_conversion_cost_dzn=$grand_total_avg_convsion_qty_dzn=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
            foreach( $data_array as $row )
            {
				$convsion_qty=$conv_data_qty[$row[csf('id')]][$row[csf('uom')]];
				$conversion_cost=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];

				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0) $item_descrition = "All Fabrics";
				else $item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];

				$process_id=$row[csf("cons_process")];
				$aop_cond="";
				if($row[csf("color_break_down_aop")]!="")
				{
					$break_down_aopArr=explode("_",$row[csf("color_break_down_aop")]);
					//print_r($break_down_aopArr);
					$aop_color=$no_color_arr[$break_down_aopArr[4]];
					$aop_type=$print_type[$break_down_aopArr[3]];
					$aop_cond=", ".$aop_type.','.$aop_color;
				}

				if (!in_array($process_id,$process_array_check) )
				{
					if($k!=1)
					{
						?>
					   <tr>
							<td>&nbsp;</td>
							<td><strong>Process Total </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty_dzn,3); ?></strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty,2); ?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_convsion_qty,4); ?></strong></td>
						    <td>&nbsp;</td>
							<td>&nbsp;</td>
                            <td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost_dzn,3); ?></strong></td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost,2); ?></strong></td>
							<td align="right"><? echo fn_number_format(($total_conversion_cost_dzn/$tot_perDznValue)*100,3); ?></td>
						</tr>
						<?
					}
					?>
					<?
					unset($total_convsion_qty_dzn);unset($total_conversion_cost_dzn);
					unset($total_convsion_qty);
					unset($total_avg_convsion_qty);
					unset($total_conversion_cost);
					unset($total_convsion_qty_dzn);
					$process_array_check[]=$process_id;
					$k++;
				}
			?>
                <tr>
                    <td><? echo $item_descrition; ?></td>
                    <td><? echo $conversion_cost_head_array[$row[csf("cons_process")]].$aop_cond; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($convsion_qty,2); ?></td>
					<td align="right"><? echo  $unit_of_measurement[$row[csf('uom')]]; ?></td>
                  	<td style="word-break:break-all">
						<? if ($row[csf("cons_process")]==30 || $row[csf("cons_process")]==31)
                        {
                            $ex_color_break_down=explode("__",$row[csf('color_break_down')]);
                            ?>
                                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:155px;text-align:center;" rules="all">
                                <?
                                foreach($ex_color_break_down as $exstr)
                                {
                                    $ex_data=explode("_",$exstr);
                                    $unitcharge=$ex_data[1];
                                    $fabriccolorid=$ex_data[3];
                                    ?>
                                    <tr>
                                        <td width="95" style="word-break:break-all"><? echo $color_library[$fabriccolorid]; ?></td>
                                        <td><? echo fn_number_format($unitcharge,4); ?></td>
                                    </tr>
                                    <?
                                }
                                ?>
                                </table>
                            <?
                        }
                        else echo "&nbsp;"; ?>
                    </td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],3); ?></td>
                    <td align="right"><? echo fn_number_format(($row[csf("charge_unit")]*$exchange_rate),3); ?></td>
					<td align="right"><? echo fn_number_format($row[csf('amount')],4); ?></td>
                    <td align="right"><? echo fn_number_format($conversion_cost,2); ?></td>
					<td align="right" title="<? echo $row[csf('amount')].'='.$tot_perDznValue;?>"><? echo fn_number_format(($row[csf('amount')]/$tot_perDznValue)*100,2); ?></td>
                </tr>
            <?
				$total_convsion_qty+=$convsion_qty;
				$total_convsion_qty_dzn+=$row[csf("req_qnty")];
				$total_avg_convsion_qty+=$row[csf("req_qnty")];
				$total_conversion_cost += $conversion_cost;
			//	$total_conversion_cost_dzn += $row[csf('amount')];
				$grand_total_conv_qnty+=$convsion_qty;
				$grand_total_avg_convsion_qty+=$convsion_qty;
				$grand_total_avg_convsion_qty_dzn+=$row[csf("req_qnty")];
				$grand_total_conversion_cost+= $conversion_cost;
				$grand_total_conversion_cost_dzn+= $row[csf('amount')];
				$total_conversion_cost_dzn+=$row[csf('amount')];
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;//$grand_total_avg_convsion_qty;
           	 }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Process Total</td>
                <td align="right"><? echo fn_number_format($total_convsion_qty_dzn,3); ?></td>
				 <td align="right"><? echo fn_number_format($total_convsion_qty,2); ?></td>
				 <td align="right"><? //echo fn_number_format($total_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
				<td align="right"><? echo fn_number_format($total_conversion_cost_dzn,4); ?></td>
                <td align="right"><? echo fn_number_format($total_conversion_cost,2); ?></td>
				<td align="right"><? echo fn_number_format(($total_conversion_cost_dzn/$tot_perDznValue)*100,2); ?></td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Conversion Total</td>
                <td align="right"><? echo fn_number_format($grand_total_avg_convsion_qty_dzn,3); ?></td>
				<td align="right"><? echo fn_number_format($grand_total_conv_qnty,2); ?></td>
				<td align="right"><? //echo fn_number_format($grand_total_conv_qnty,4); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
				 <td align="right"><? echo fn_number_format($grand_total_conversion_cost_dzn,4); ?></td>
                <td align="right"><? echo fn_number_format($grand_total_conversion_cost,2); ?></td>
				<td align="right"  title="<? echo $grand_total_conversion_cost_dzn.'='.$tot_perDznValue;?>"><? echo fn_number_format(($grand_total_conversion_cost_dzn/$tot_perDznValue)*100,3); ?></td>
            </tr>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -------------------------------------------
	?>
	<br>
	</div>
	</div>
	<br/>

	<!--  Here will be the summary portion  -->
	<?
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				$condition->job_no("=$txt_job_no");
			}
			if(str_replace("'","",$txt_order_no_id) !=''){
				$condition->po_id("in($txt_order_no_id)");
			}
			$condition->init();
			$fabric= new fabric($condition);
			$fabric_qty=$fabric->getQtyArray_by_OrderFabriccostidFabriccolorAndDiaWidth_knitAndwoven_greyAndfinish();
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($txt_job_no)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;
		 $color_wise_process_loss=sql_select("SELECT a.id,a.job_no, a.body_part_id, b.color_number_id,b.dia_width, a.process_loss_method, b.process_loss_percent as loss, avg(b.cons_pcs) as consdzn FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no=$txt_job_no and b.process_loss_percent>0 group by a.id,a.job_no, a.body_part_id, a.process_loss_method,b.dia_width, b.color_number_id, b.process_loss_percent");
	    foreach($color_wise_process_loss as $val)
	    {
	    	$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
	    	$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
			$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['consdzn']=$val[csf("consdzn")];
			$gmt_color_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['color_id']=$val[csf("color_number_id")];
	    }
			$nameArray_qty_arr = sql_select("select b.job_no_mst,b.po_number,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.plan_cut_qnty,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.job_no=c.job_no_mst and a.status_active =1 and b.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no=$txt_job_no and b.id in($txt_order_no_id)  ");
			foreach($nameArray_qty_arr as $row)
			{
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('po_number')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][40]+=$row[csf('order_quantity')];
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('po_number')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][50]+=$row[csf('order_quantity')];
				$fab_gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('po_number')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$plan_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('po_number')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$gmts_color_data_arr[$row[csf('job_no_mst')]][$row[csf('po_number')]][$row[csf('item_number_id')]]['color'].=$row[csf('color_number_id')].',';
			}
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id,a.seq, a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id,a.fabric_source as fabric, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,a.uom,a.color_size_sensitive,	a.color_break_down,c.job_no_mst,avg(b.requirment) as requirment,avg(b.cons) as consumption,avg(b.process_loss_percent) as process_loss_percent,avg(b.cons) as finish_cons,sum(c.plan_cut_qnty) as plan_cut_qnty,sum(c.order_quantity) as order_qnty,avg(c.excess_cut_perc) as ex_cut_per,b.color_number_id,b.rate,d.po_number,d.insert_date,d.id as did,b.color_number_id as gmts_color_id,e.contrast_color_id as fabric_color FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c,wo_po_break_down d,wo_pre_cos_fab_co_avg_con_dtls b left join wo_pre_cos_fab_co_color_dtls e on b.pre_cost_fabric_cost_dtls_id=e.pre_cost_fabric_cost_dtls_id and b.color_number_id=e.gmts_color_id and e.status_active=1 WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and  b.po_break_down_id=c.po_break_down_id and b.po_break_down_id = c.po_break_down_id  and b.po_break_down_id = d.id and a.job_no=$txt_job_no  and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.cons>0 group by a.id , a.item_number_id,a.seq, a.body_part_id,a.body_part_type,a.color_type_id,a.fabric_source, a.construction,a.composition, a.gsm_weight,a.width_dia_type , b.dia_width,a.uom ,a.color_size_sensitive,a.color_break_down,c.job_no_mst,b.color_number_id,b.rate ,d.po_number,d.id,d.insert_date,e.contrast_color_id order by d.id desc");
			$uom_data_arr=array();$b_part_array_not=array(40,50);
			foreach($nameArray_fabric_description as $row)
			{
				if(!in_array($row[csf('body_part_type')],$b_part_array_not))
				{
					$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				}
				if($row[csf('body_part_type')]==40 || $row[csf('body_part_type')]==50)
				{
					$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('po_number')]][$row[csf('item_number_id')]][$row[csf('gmts_color_id')]][$row[csf('body_part_type')]]=$row[csf('order_quantity_pcs')];
				}
			}

			if(count($nameArray_fabric_description)>0)
			{

				?>
				<table class="rpt_table" width="1890"  border="1" cellpadding="0" cellspacing="0" rules="all" >
					<caption> <strong>Fabric Booking Summary </strong> </caption>
					<tr>
						<th  width="30" align="center">SL</th>
						<th  width="150" align="center">Order Number</th>
						<th  width="100" align="center">Gmts Item</th>
						<th  width="100" align="center">Po Inset Date</th>
						<th  width="100" align="center">Body Parts</th>
						<th  width="100" align="center">Gmts Order Qty (Pcs)</th>
						<th  width="100" align="center">Fabric Source</th>
						<th  width="100" align="center">Fabric Construction</th>
						<th  width="100" align="center">Yarn Composition</th>
						<th  width="40" align="center">GSM</th>
						<th  width="90" align="center">Fin Width/ Dia Type</th>
						<th  width="100" align="center">Color Type</th>
						<th  width="110" align="center">Fabric Color</th>
						<th  width="80" align="center">Finish Cons. Kg/Dzn</th>
						<th width='100' align="center">Avg. P/L %</th>
						<th  width="80" align="center">Grey Cons. Kg/Dzn</th>
						<th  width="60" align="center">UOM</th>
						<th width='120' align="center" title="Based on avg grey consumption">Finished Fab. Qty</th>
						<th width='100' align="center">Grey Fabric Qty</th>
						<th width='70' align="center">Avg Rate/<? echo $unit_of_measurement[$uom_id];?></th>
						<th width='60' align="center">Amount</th>
					</tr>
					<?
					//$total_fin_fab_qnty=$total_gmt_qty_pcs=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
					foreach($nameArray_fabric_description as $val)
					{
						if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";

						if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];

						$order_quantity_pcs=0;
						if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
						{
							$gmt_colorName=$color_library[$val[csf('fabric_color_id')]];
							$gmt_colorId=$val[csf('fabric_color_id')];
							//echo $gmt_colorId.'d';
							$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
							$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
						}
						else
						{
							$color_break_down=$val[csf('color_break_down')];
							if($color_break_down)
							{
								$gmts_color="";$gmt_colorId="";
								if (strpos($color_break_down, '__') !== false)
								{
									$color_break_down=explode('__', $color_break_down);
									foreach ($color_break_down as $key => $value)
									{
										$cols=explode('_', $value);
										if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
										{
											if($gmts_color=="")
											{
												$gmts_color=$cols[1];
											$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$plan_quantity_pcs=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$gmt_colorId=$cols[0];

											}
											else
											{
												$gmts_color .=','.$cols[1];
											$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$gmt_colorId=$cols[0];

											}


										}

									}
								}
								else
								{
									$cols=explode('_', $color_break_down);
									if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
									{
										if($gmts_color=="")
										{
											$gmts_color=$cols[1];
											$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$plan_quantity_pcs=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$gmt_colorId=$cols[0];

										}
										else
										{
											$gmts_color .=','.$cols[1];
											$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$cols[0]];
											$gmt_colorId=$cols[0];

										}


									}

								}

								$gmt_colorName=$gmts_color;

							}

						}

						$gmt_color_Id=$gmt_colorId;
						$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('po_number')]][$val[csf('item_number_id')]][$val[csf("color_number_id")]];

						if($val[csf('color_size_sensitive')]!=3){
						$fincons=array_sum($fabric_qty['knit']['finish'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("color_number_id")]][$val[csf("dia_width")]])+array_sum($fabric_qty['woven']['finish'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("color_number_id")]][$val[csf("dia_width")]]);

						$greycons=array_sum($fabric_qty['knit']['grey'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("color_number_id")]][$val[csf("dia_width")]])+array_sum($fabric_qty['woven']['grey'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("color_number_id")]][$val[csf("dia_width")]]);
						}else{
						$fincons=array_sum($fabric_qty['knit']['finish'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("fabric_color")]][$val[csf("dia_width")]])+array_sum($fabric_qty['woven']['finish'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("fabric_color")]][$val[csf("dia_width")]]);

						$greycons=array_sum($fabric_qty['knit']['grey'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("fabric_color")]][$val[csf("dia_width")]])+array_sum($fabric_qty['woven']['grey'][$val[csf("did")]][$val[csf("fabric_cost_dtls_id")]][$val[csf("gmts_color_id")]][$val[csf("fabric_color")]][$val[csf("dia_width")]]);
						}
						$process_loss=$loss_arr[$val[csf("fabric_cost_dtls_id")]][$val[csf("dia_width")]][$val[csf("job_no_mst")]][$row[csf('po_number')]][$val[csf("body_part_id")]][$gmt_color_Id]['loss'];
						if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;

						$attribute_arr=array('po_number','item_number_id','insert_date','body_part_id','fabric','construction','composition','gsm_weight', 'dia_width', 'width_dia_type', 'color_type_id','process_loss_percent','color_number_id','requirment','uom','rate','consumption');

						$key=$val[csf('id')].'*'.$val[csf('item_number_id')].'*'.$val[csf('seq')].'*'.$val[csf('body_part_id')].'*'.$val[csf('body_part_type')].'*'.$val[csf('color_type_id')].'*'.$val[csf('fabric_source')].'*'.$val[csf('construction')].'*'.$val[csf('composition')].'*'.$val[csf('gsm_weight')].'*'.$val[csf('width_dia_type')].'*'.$val[csf('dia_width')].'*'.$val[csf('uom')].'*'.$val[csf('color_size_sensitive')].'*'.$val[csf('color_break_down')].'*'.$val[csf('job_no_mst')].'*'.$val[csf('color_number_id')].'*'.$val[csf('rate')].'*'.$val[csf('po_number')].'*'.$val[csf('id')].'*'.$val[csf('insert_date')].'*'.$val[csf('contrast_color_id')];
						foreach($attribute_arr as $attr){

							$po_wise_booking_data[$val[csf('did')]][$key][$attr]=$val[csf($attr)];
						}
						$po_wise_booking_data[$val[csf('did')]][$key]['fincons']+=$fincons;
						$po_wise_booking_data[$val[csf('did')]][$key]['greycons']+=$greycons;
						$po_wise_booking_data[$val[csf('did')]][$key]['order_quantity_pcs']+=$order_quantity_pcs;

					}
					$p=1; $k=1;
					foreach($po_wise_booking_data as  $poid=>$fabricdata){
							$tr_color="#FFF";
							if($k==1 || $k==2){
								$tr_color="#FFFF00";
							}
							$tot_fin_qnty=$tot_grey_qnty=$tot_amount=0;
						foreach($fabricdata as $fabricid=>$data){
							?>
							<tr style="background-color:<?php echo $tr_color ;?>">
								<td align="center"> <? echo $p; $p++;?></td>
								<td align="center"><? echo $data['po_number']; ?></td>
								<td align="center"> <? echo $garments_item[$data['item_number_id']];?></td>
								<td align="center"><? echo change_date_format($data['insert_date']) ;?></td>
								<td align="center"><? echo $body_part[$data['body_part_id']];?></td>
								<td align="center"><? echo number_format($data['order_quantity_pcs'],0);?></td>
								<td align="left"> <? if($data['fabric']==1){echo 'Production';}elseif($data['fabric']==2){echo 'Purchase';}elseif($data['fabric']==3){echo 'Buyer Supplied';}else{echo 'Buyer Supplied';} ?> </td>
								<td align="left"> <? echo $data['construction']; ?> </td>
								<td align="left"> <? echo $data['composition']; ?> </td>
								<td align="center"><? echo $data['gsm_weight']; ?>	</td>
								<td align="center"><? echo $data['dia_width'].'/'.$fabric_typee[$data['width_dia_type']]; ?></td>
								<td align="center"><? echo $color_type[$data['color_type_id']]; ?></td>
								<td align="center"><? echo $color_library[$data['color_number_id']];?></td>
								<td align="center"><? echo def_number_format($data['consumption'],5); ?></td>
								<td align="center"><? echo def_number_format($data['process_loss_percent'],2); ?> </td>
								<td align="center"><? echo def_number_format($data['requirment'],5); ?></td>
								<td align="center"><? echo $unit_of_measurement[$data['uom']]; ?></td>
								<td align="center"><? echo number_format($data['fincons'],2);$tot_fin_qnty+=$data['fincons']; ?> </td>
								<td align="center"> <? echo number_format($data['greycons'],2);$tot_grey_qnty+=$data['greycons']; ?> </td>
								<td align="center"> <? echo def_number_format($data['rate'],2); ?> </td>
								<td align="center"> <? echo def_number_format($data['greycons']*$data['rate'],2); $tot_amount+=$data['greycons']*$data['rate']; ?></td>
							</tr>
							<?
						} ?>
						<tr style="font-weight:bold;">
						<td  align="right" colspan="17">PO Total</td>
						<td align="center"><? echo def_number_format($tot_fin_qnty,2);?></td>
						<td align="center"><? echo def_number_format($tot_grey_qnty,2);?></td>
						<td align="center"></td>
						<td align="center"><? echo def_number_format($tot_amount,2);?></td>
						</tr>
						<?
						$grand_tot_fin_qnty+=$tot_fin_qnty;
						$grand_tot_grey_qnty+=$tot_grey_qnty;
						$grand_tot_amount+=$tot_amount;
						$k++;
					}
					?>
					<tr style=" font-weight:bold">
					<td  align="right" colspan="17">Grand Total</td>
					<td align="center"><? echo def_number_format($grand_tot_fin_qnty,2);?></td>
					<td align="center"><? echo def_number_format($grand_tot_grey_qnty,2);?></td>
					<td align="center"></td>
					<td align="center"><? echo def_number_format($grand_tot_amount,2);?></td>
					</tr>
				</table>
				<?
			}
		?>
	<br>
    <? echo signature_table(109, $cbo_company_name, "970px");
	exit();
}

if($action=="cost_control_source")
{
	$company_id=$data;
	$cost_control_source=0;
	if($company_id!=0)
	{
		$sql="select id, cost_control_source from variable_order_tracking where company_name='$company_id' and variable_list=53 order by id";
		$dataArr=sql_select($sql);
		$cost_control_source=$dataArr[0][csf('cost_control_source')];
	}
	echo $cost_control_source;
	exit();
}

if ($action == "supplier_name")
{
	$sql = "select c.id, c.supplier_name as label from lib_supplier_tag_company a, lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$data' and b.party_type =23 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by supplier_name";
	$result = sql_select($sql);
	$supplierArr = array();
	foreach($result as $key => $val){
		$supplierArr[$key]["id"]=$val[csf("id")];
		$supplierArr[$key]["label"]=$val[csf("label")];
	}
	echo json_encode($supplierArr);
    exit();
}

if($action=="validate_is_booking_create")
{
	$exdata=explode("__", $data);
	$upid=$exdata[0]; $booking_type=$exdata[1]; $jobno=$exdata[2];

	$approved=0;
	$sql=sql_select("select approved from wo_pre_cost_mst where job_no='$jobno'");
	foreach($sql as $row){
		if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
	}
	if($approved==1){
		echo "approved***".str_replace("'","",$jobno);
		die;
	}

	$amount=0;
	$data_array=sql_select("select booking_no from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$upid' and booking_type='$booking_type' and status_active=1 and is_deleted=0 group by booking_no");
	$booking_no='';
	foreach( $data_array as $row )
	{
		if($booking_no=="") $booking_no=$row[csf("booking_no")]; else $booking_no.=', '.$row[csf("booking_no")];
	}

	if (count($data_array)>0) echo "1***".$booking_no; else echo "0***".$booking_no;
	die;
}

if ($action=="unapp_request_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$data_all=explode('_',$data);
	$job_no=$data_all[0];
	$unapp_request=$data_all[1];

	$precost_id=return_field_value("id", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0");

	$sql_request="select MAX(id) as id from fabric_booking_approval_cause where entry_form=15 and booking_id='$precost_id' and approval_type=2 and status_active=1 and is_deleted=0 group by booking_id";//page_id='$menu_id' and

	$nameArray_request=sql_select($sql_request);
	foreach($nameArray_request as $row)
	{
		$unapp_request=return_field_value("approval_cause", "fabric_booking_approval_cause", "id='".$row[csf('id')]."' and status_active=1 and is_deleted=0");
	}
	?>
	<link rel="stylesheet" href="../../../sweetalert2/sweetalert2.css">
	<!-- Include SweetAlert2 JavaScript -->
	<script  type="text/javascript" src="../../../sweetalert2/sweetalert2.all.js"></script>
	<script src="../../../js/socket.io.js"></script>
    <script>
		var socket;
		var socket_url = '<?=$_SESSION['socket_url'];?>';
		$( document ).ready(function() {
			try {
				if(socket_url !="")
				{
					socket =io.connect('<?=$_SESSION['socket_url'];?>');
					console.error("Socket connected");
					//showNotification("Socket connected",'success');
				}
			}
			catch (error)
			{
				console.error("Unable to connect to the server:", error);
				//showNotification(error,'error');
			}
		});	
		$( document ).ready(function() {
			document.getElementById("unappv_request").value='<? echo preg_replace('/[\r\n]+/','\n',$unapp_request); ?>';
		});

		var permission='<? echo $permission; ?>';

		function fnc_appv_entry(operation)
		{
			var unappv_request = $('#unappv_request').val();

			if (form_validation('unappv_request','Un Approval Request')==false)
			{
				if (unappv_request=='')
				{
					alert("Please write request.");
				}
				return;
			}
			else
			{
				var data="action=save_update_delete_unappv_request&operation="+operation+get_submitted_data_string('unappv_request*precost_id*page_id*user_id',"../../../");
				//alert (data);return;
				freeze_window(operation);
				http.open("POST","pre_cost_entry_controller_v2.php",true);
				http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				http.send(data);
				http.onreadystatechange=fnc_appv_entry_Reply_info;
			}
		}

		function fnc_appv_entry_Reply_info()
		{
			if(http.readyState == 4)
			{
				var reponse=trim(http.responseText).split('**');
				show_msg(reponse[0]);
				if(reponse[0]==0 || reponse[0]==1){
					if(socket_url !="")
					{
						var approval_data = [];
						var obj = {
							ref_id : document.getElementById('precost_id').value,
							entry_form : 77
						}
						approval_data.push(obj);
						socket.emit('unapproved_req',{approval_data: approval_data});
						socket.emit('message_count', { user_id: '<?=$_SESSION['logic_erp']['user_id'];?>'});
					}
				}
				set_button_status(1, permission, 'fnc_appv_entry',1);
				release_freezing();
			}
		}

		function fnc_close()
		{
			unappv_request= $("#unappv_request").val();
			document.getElementById('hidden_appv_cause').value=unappv_request;
			parent.emailwindow.hide();
		}

    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"></textarea>
                        <Input type="hidden" name="precost_id" class="text_boxes" id="precost_id" value="<? echo $precost_id; ?>" style="width:30px" />
                        <Input type="hidden" name="page_id" class="text_boxes" ID="page_id" value="<? echo $menu_id; ?>" style="width:30px" />
                        <Input type="hidden" name="user_id" class="text_boxes" ID="user_id" value="<? echo $user_id; ?>" style="width:30px" />
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center" class="button_container">
                        <?
						//print_r ($id_up_all);
                            if(count($nameArray_request)>0)
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 1,0,"reset_form('size_1','','','','','');",1);
                            }
                            else
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 0,0,"reset_form('size_1','','','','','');",1);
                            }
                        ?>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">

                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
        <?
			$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=15 and booking_id='$precost_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
			$sqlHisRes=sql_select($sqlHis);
		?>
		<table align="center" cellspacing="0" width="420" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
				<th>Unapproved Request History</th>
			</thead>
		</table>
		<div style="width:420px; overflow-y:scroll; max-height:260px;" align="center">
			<table align="center" cellspacing="0" width="403" class="rpt_table" border="1" rules="all">
			<?
			$i=1;
			foreach($sqlHisRes as $hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
					<td width="30"><?=$i; ?></td>
					<td style="word-break:break-all"><?=$hrow[csf('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
			</table>
		</div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="save_update_delete_unappv_request")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$unappv_request = str_replace(["(",")","[","]"]," ",$unappv_request);

	//echo "shajjad_".$unappv_request.'_'.$wo_id.'_'.$page_id.'_'.$user_id; die;
	$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=15 and mst_id=$precost_id","approved_no");
	$flag=1;
	if(is_duplicate_field( "approval_cause", "approval_cause_refusing_his", "approval_cause='".str_replace("'", "", $unappv_request)."' and entry_form=15 and booking_id='".str_replace("'", "", $precost_id)."' and approval_type=2 and status_active=1 and is_deleted=0" )==1)
	{
	//
	}
	else
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//$id_his=return_next_id( "id", "approval_cause_refusing_his", 1);
		$idpre=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$precost_id." and entry_form=15 and approval_type=2 group by booking_id","id");
		$sqlHis="insert into approval_cause_refusing_his( id, cause_id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause)
				select '', id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause from fabric_booking_approval_cause where booking_id=".$precost_id." and approval_type=2 and entry_form=15and id='$idpre' ";

		if(count($sqlHis)>0)
		{
			$rID3=execute_query($sqlHis,0);
			if($flag==1)
			{
				if($rID3==1) $flag=1; else $flag=0;
			}
		}
	}

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$unapproved_request=return_field_value("id","fabric_booking_approval_cause","entry_form=15 and user_id=$user_id and booking_id=$precost_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and

		if($unapproved_request=="")
		{
			$id_mst=return_next_id( "id", "fabric_booking_approval_cause", 1 ) ;

			$field_array="id,page_id,entry_form,user_id,booking_id,approval_type,approval_no,approval_cause,inserted_by,insert_date,status_active,is_deleted";
			$data_array="(".$id_mst.",".$page_id.",15,".$user_id.",".$precost_id." ,2,'".$approved_no."',".$unappv_request.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";			

			$rID=sql_insert("fabric_booking_approval_cause",$field_array,$data_array,0);
			$rID1=true;
			if($_SESSION['socket_url']!=''){
				$rID1=execute_query("UPDATE approval_notification_engine set unapprove_request=".$unappv_request.", updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."' where ref_id=$precost_id and entry_form=77 and is_approved=1",1);
			}
			//echo $rID; die;

			if($db_type==0)
			{
				if($rID && $rID1)
				{
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($rID && $rID1)
				{
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			disconnect($con);
			die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$update_id=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$precost_id." and entry_form=15 and approval_type=2 group by booking_id","id");
			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*15*".$user_id."*".$precost_id."*2*'".$approved_no."'*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";

			$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id",$update_id,0);
			if($rID==1 && $flag==1) $flag=1; else $flag=0;
			$rID1=true;
			if($_SESSION['socket_url']!=''){
				$rID1=execute_query("UPDATE approval_notification_engine set unapprove_request=".$unappv_request.", updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."' where ref_id=$precost_id and entry_form=77 and is_approved=1",1);
				if($rID==1 && $flag==1) $flag=1; else $flag=0;
			}

			if($db_type==0)
			{
				if($flag==1)
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($flag==1)
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}

			disconnect($con);
			die;
		}
	}
	else if ($operation==1)  // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$update_id=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$precost_id." and entry_form=15 and approval_type=2 group by booking_id","id");
		$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
		$data_array="".$page_id."*15*".$user_id."*".$precost_id."*2*'".$approved_no."'*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";

		$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$update_id."",0);
		if($rID==1) $flag=1; else $flag=0;
		$rID1=true;
		if($_SESSION['socket_url']!=''){
			$rID1=execute_query("UPDATE approval_notification_engine set unapprove_request=".$unappv_request.", updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."' where ref_id=$precost_id and entry_form=77 and is_approved=1",1);
			if($rID==1 && $flag==1) $flag=1; else $flag=0;
		}

		//echo "10**".$rID.'--'.$rID3.'--'.$flag; die;
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$rID;
			}
		}
		else if($db_type==2)
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID;
			}
		}

		disconnect($con);
		die;
	}
}

if ($action=="refusing_cause_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Refusing Cause","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$data_all=explode('_',$data);
	$job_no=$data_all[0];
	$unapp_request=$data_all[1];

	$precost_id=return_field_value("id", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0");
	$sql_cause="select id,mst_id,component_id,refusing_reason from precost_component_not_app_ca where entry_form=11 and mst_id='$precost_id' order by id DESC";

	//echo $sql_cause;
	$nameArray_cause=sql_select($sql_cause);
	if(count($nameArray_cause)<1)
	{
		$sql_cause="select refusing_reason from refusing_cause_history where entry_form=15 and mst_id='$precost_id'";
		//echo $sql_cause;
		$nameArray_cause=sql_select($sql_cause);
	}
	$refusing_reason='';
	foreach($nameArray_cause as $row)
	{
		if(!empty($refusing_reason))
		{
			$refusing_reason.=",".$row[csf("refusing_reason")];
		}
		else $refusing_reason=$row[csf("refusing_reason")];
	}
	?>
    <script type="text/javascript">
    	function fnc_close()
		{
			unappv_request= $("#unappv_request").val();

			document.getElementById('hidden_appv_cause').value=unappv_request;

			parent.emailwindow.hide();
		}
    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character" readonly><?=$refusing_reason?></textarea>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">
                    </td>
                </tr>
            </table>
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
        <?
		$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=15 and booking_id='$precost_id' and approval_type='1' and status_active=1 and is_deleted=0 order by id Desc";
		$sqlHisRes=sql_select($sqlHis);
		if(count($sqlHisRes)>0)
		{
			?>
			<table align="center" cellspacing="0" width="420" class="rpt_table" border="1" rules="all">
				<thead>
					<th width="30">SL</th>
					<th>Deny/Refusing History</th>
				</thead>
			</table>
			<div style="width:420px; overflow-y:scroll; max-height:260px;" align="center">
				<table align="center" cellspacing="0" width="403" class="rpt_table" border="1" rules="all">
				<?
				$i=1;
				foreach($sqlHisRes as $hrow)
				{
					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
						<td width="30"><?=$i; ?></td>
						<td style="word-break:break-all"><?=$hrow[csf('approval_cause')]; ?></td>
					</tr>
					<?
					$i++;
				}
				?>
				</table>
			</div>
        <? } else {
		$designation_arr = return_library_array("select id,CUSTOM_DESIGNATION from  LIB_DESIGNATION ", 'id', 'CUSTOM_DESIGNATION');
		$notAppCausSql = "select a.INSERT_DATE, a.COMPONENT_ID, a.REFUSING_REASON, b.USER_NAME, b.DESIGNATION from PRECOST_COMPONENT_NOT_APP_CA a, USER_PASSWD b where a.INSERTED_BY=b.id and a.current_status=0 and a.entry_form=11 and a.mst_id='$precost_id' order by a.INSERT_DATE asc";
		//echo $notAppCausSql;
		$notAppCausSqlRes = sql_select($notAppCausSql);
		$dataArr=array();
		foreach($notAppCausSqlRes as $row){
			$key=$row['USER_NAME'].'**'.$row['DESIGNATION'].'**'.$row['INSERT_DATE'];
			$dataArr[$key][$row['COMPONENT_ID']]=$row;
		}
		?>
		<table border="1" class="rpt_table" rules="all" width="99%" cellpadding="0" cellspacing="0" align="center">
			<tr>
				<thead>
					<th>Name</th>
					<th>Designation</th>
					<th>Date & Time</th>
					<th>Cost Component</th>
					<th>Comments</th>
				</thead>
			</tr>
			<?php
			$i=1;
			foreach($dataArr as $key=>$dataRows){
				list($row['USER_NAME'],$row['DESIGNATION'],$row['INSERT_DATE'])=explode('**',$key);
				$rowspan=count($dataRows);
				if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>">
					<td rowspan="<?=$rowspan;?>"><?=$row['USER_NAME'];?></td>
					<td rowspan="<?=$rowspan;?>"><?=$designation_arr[$row['DESIGNATION']];?></td>
					<td rowspan="<?=$rowspan;?>"><?=$row['INSERT_DATE'];?></td>
					<?
					$f=0;
					foreach($dataRows as $component_id=>$row){
					if($f==1){echo "<tr>"; }
					?>
					<td><?=$cost_components[$component_id];?></td>
					<td><?=$row['REFUSING_REASON'];?></td>
				</tr>
				<?
				$f=1;
				$i++;
				}
			}
			?>
		</table>
	<? } ?>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="margin_pcs_as_bom")
{

	$txt_job_no="'".$data."'";
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	$sql_po = "SELECT a.job_no, a.total_set_qnty, (b.plan_cut) as plan_cut, (b.po_quantity) as ord_qty, b.po_total_price
			from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $job_no"; //$txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
	$po_data_array=sql_select($sql_po);
	$total_po_value=$total_po_qty=0;
	foreach($po_data_array as $row)
	{
		$job_no=$row[csf("job_no")];
		$po_value=0; $po_qty=0;
		$po_value=$row[csf("po_total_price")];//*$row[csf("total_set_qnty")]
		$po_qty=$row[csf("ord_qty")];//*$row[csf("total_set_qnty")]
		$total_po_value+=$po_value;
		$total_po_qty+=$po_qty;
	}
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		  $condition->job_no("=$txt_job_no");
	}
	$condition->init();
	$fabric= new fabric($condition);
    $yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trims= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$commercial= new commercial($condition);
	$commission= new commision($condition);
	$other= new other($condition);

	//2 Fabric Cost part here-------------------------------------------
	$sql = "select id, job_no,item_number_id,gsm_weight, uom,body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted =0 and fabric_source =2";

	$data_array=sql_select($sql);
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();

	$knit_subtotal_amount=0;
	$woven_subtotal_amount=0;
	foreach( $data_array as $row )
	{
		if($row[csf("fab_nature_id")]==2)//knit fabrics
		{
			//$knit_subtotal_amount+=$row[csf("amount")];
			$knit_subtotal_amount+=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
		}
		if($row[csf("fab_nature_id")]==3)//woven fabrics
		{
			//$woven_subtotal_amount+=$row[csf("amount")];
			$woven_subtotal_amount+=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
		}
	}
	unset($data_array);
	//echo $knit_subtotal_amount; die;
	//end 	All Fabric Cost part report-------------------------------------------
	$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted =0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";

	$data_array=sql_select($sql);
	$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
	//print_r($yarn_data_array);

	$total_yarn_amount = 0;
	foreach( $data_array as $row )
	{
		$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];

		$total_yarn_amount +=$rowamount;
	}
	unset($data_array);

	//start	Conversion Cost to Fabric report here -------------------------------------------
	$sql = "select a.id, b.uom from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted =0 order by  a.cons_process";
	$data_array=sql_select($sql);
	//echo $sql; die;
	//$conv_data_qty=$conversion->getQtyArray_by_conversionid();
	$conv_data_amt=$conversion->getAmountArray_by_conversionid();
	$total_conversion_cost=0;
	foreach( $data_array as $row )
	{
		$conversion_cost=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];
		$grand_total_conversion_cost+= $conversion_cost;
	}

	unset($data_array);
	$all_fab_cost=$knit_subtotal_amount+$woven_subtotal_amount+$total_yarn_amount+$grand_total_conversion_cost;

	//Start Trims Cost Part report here -------------------------------------------
    $sql = "select id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);

	//$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
	//print_r($trim_qty);
	$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
	$total_trims_cost=0;
	foreach( $data_array as $row )
	{
		$pre_trims_amount=$trim_amount_arr[$row[csf("id")]];

		$total_trims_cost += $pre_trims_amount;
	}

	unset($data_array);
	//start Embellishment Details part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);

	//$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	//$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();

	$total_embellishment_amt=0;
	foreach( $data_array as $row )
	{
		if($row[csf("emb_name")] !=3){
			$embl_amount=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
		}
		else if($row[csf("emb_name")] ==3){
			$embl_amount=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
		}
		$total_embellishment_amt += $embl_amount;
	}
    unset($data_array);
	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);

	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
	$total_commercial_cost=0;
	foreach( $data_array as $row )
	{
		$amount = $commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];;
		$total_commercial_cost += $amount;
	}
    unset($data_array);
	//End Commercial Cost Part report here -------------------------------------------

  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, status_active from wo_pre_cost_commiss_cost_dtls where job_no=".$txt_job_no."  and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);

	$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
	$total_commission_cost=0;
	foreach( $data_array as $row )
	{
		$commission_amount = $commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
		$total_commission_cost += $commission_amount;
	}
    unset($data_array);
	//start	Other Components part report here -------------------------------------------
	$sql = "select id, job_no, depr_amor_pre_cost, deffdlc_cost, incometax_cost, interest_cost, lab_test, inspection, cm_cost, freight, common_oh, currier_pre_cost, certificate_pre_cost, price_dzn,design_cost,studio_cost from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$other_costing_arr=$other->getAmountArray_by_job();
	$total_other_components=0;
	$lab_test_cost=$inspection_cost=$cm_cost=$freight_cost=$currier_cost=$certificate_cost=$deffdlc_cost=$common_oh=$depr_amor_pre_cost=$interest_cost=$incometax_cost=$design_cost=$studio_cost=0;
	foreach( $data_array as $row )
	{
		$job_no=$row[csf("job_no")];

		$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
		$inspection_cost=$other_costing_arr[$job_no]['inspection'];
		$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
		$freight_cost=$other_costing_arr[$job_no]['freight'];
		$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
		$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
		$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
		$common_oh=$other_costing_arr[$job_no]['common_oh'];
		$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
		$interest_cost=$other_costing_arr[$job_no]['interest_cost'];
		$incometax_cost=$other_costing_arr[$job_no]['incometax_cost'];
		$design_cost=$other_costing_arr[$job_no]['design_cost'];
		$studio_cost=$other_costing_arr[$job_no]['studio_cost'];


		$total_other_components =$lab_test_cost+$inspection_cost+$cm_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost+$interest_cost+$incometax_cost+$common_oh+$depr_amor_pre_cost+$design_cost+$studio_cost;
		$price_dzn=$row[csf("price_dzn")];
	}
	unset($data_array);
	//echo $lab_test_cost.'+'.$inspection_cost.'+'.$cm_cost.'+'.$freight_cost.'+'.$currier_cost.'+'.$certificate_cost.'+'.$deffdlc_cost.'+'.$interest_cost.'+'.$incometax_cost.'+'.$common_oh.'+'.$depr_amor_pre_cost.'+'.$design_cost.'+'.$studio_cost; die;
	//echo $total_trims_cost.'+'.$all_fab_cost.'+'.$total_embellishment_amt.'+'.$total_other_components.'+'.$total_commercial_cost.'+'.$total_commission_cost; die;
	$total_job_cost=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$total_other_components+$total_commercial_cost+$total_commission_cost;
    //echo  $total_po_value.'--'.$total_job_cost; die;
	$total_margin_val = $total_po_value-$total_job_cost;
	//echo $total_margin_val.'=='.$total_po_qty; die;
	$margin_dzn=($total_margin_val/$total_po_qty)*12;
	$margin_pcs=$margin_dzn/12;

	$job_po_rate=$total_po_value/$total_po_qty;

	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$margin_pcs_bom=fn_number_format($margin_dzn/12,4, '.', '');
	$margin_bom_per=fn_number_format(($margin_pcs/$job_po_rate)*100,2, '.', '');
	$rid=execute_query( "update wo_pre_cost_dtls set margin_pcs_bom='$margin_pcs_bom', margin_bom_per='$margin_bom_per' where job_no =".$txt_job_no."",1);
	//echo "update wo_pre_cost_dtls set margin_pcs_bom='$margin_pcs_bom', margin_bom_per='$margin_bom_per' where job_no =".$txt_job_no."";

	if($db_type==0 && $rid==1)
	{
		mysql_query("COMMIT");
		if($margin_pcs_bom=="") $margin_pcs_bom=0; else $margin_pcs_bom=fn_number_format($margin_pcs_bom,4);
		if($margin_bom_per=="") $margin_bom_per=0; else $margin_bom_per=fn_number_format($margin_bom_per,2);
		echo "1***".$margin_pcs_bom."***".$margin_bom_per;
	}
	else if($db_type==2 && $rid==1)
	{
		oci_commit($con);
		if($margin_pcs_bom=="") $margin_pcs_bom=0; else $margin_pcs_bom=fn_number_format($margin_pcs_bom,4);
		if($margin_bom_per=="") $margin_bom_per=0; else $margin_bom_per=fn_number_format($margin_bom_per,2);
		echo "1***".$margin_pcs_bom."***".$margin_bom_per;
	}
	exit();
}

if($action == "trims_cost_template_name_popup")
{
	extract($_REQUEST);
    echo load_html_head_contents("Popup Info", "../../../", 1, 1, $unicode);?>
    <script>
        var selected_name = new Array();

    	function fnc_close(data) {
            var data=data.split('_');
            var check_trims_data = return_global_ajax_value( data[1], 'check_trims_data', '', 'pre_cost_entry_controller_v2');
            if(check_trims_data == 1)
            {
                 var r=confirm("If you want to replace previous data then press Ok, otherwise press Cancel");
                if(r==false)
                {
                    parent.emailwindow.hide();
                    return;
                }
                else
                {
                    document.getElementById('hidden_template_name').value=data[0];
                    parent.emailwindow.hide();
                }
            }
            else
            {
                document.getElementById('hidden_template_name').value=data[0];
                parent.emailwindow.hide();
            }
        }

        function insert_template_data(data,buyer)
        {
            var template_data=return_global_ajax_value( data+'_'+buyer, 'get_template_data', '', 'pre_cost_entry_controller_v2');
            var template_data=trim(template_data) ;
            if(template_data)
            {
                $("tbody#template_date").html('');
                $("tbody#template_date").append(template_data);
                $('#check_all_tbl').css('display','block');
            }

			setFilterGrid('template_date',-1)
        }

        function check_all_data() {
            var tbl_row_count = document.getElementById( 'template_data_tbl' ).rows.length-1;
            tbl_row_count = tbl_row_count;
			//alert(tbl_row_count);

            if(document.getElementById('check_all').checked){
                for( var i = 1; i <= tbl_row_count; i++ ) {
                document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
                if( jQuery.inArray( $('#txttemplatedata_' + i).val(), selected_name ) == -1 ) {
                    selected_name.push($('#txttemplatedata_' + i).val());
                }
                else{
                    for( var j = 0; j < selected_name.length; j++ ) {
                        if( selected_name[j] == $('#txttemplatedata_' + i).val() ) break;
                    }
                    selected_name.splice( j,1 );
                }

                }
                var templatedata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    templatedata += selected_name[i] + '#';
                }
                templatedata = templatedata.substr( 0, templatedata.length - 1 );
                $('#select_template_data').val( templatedata );
            }else{
                for( var i = 1; i <= tbl_row_count; i++ ) {
                    if(i%2==0  ){
                        document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
                    }
                    if(i%2!=0 ){
                        document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
                    }
                    if( jQuery.inArray( $('#txttemplatedata_' + i).val(), selected_name ) == -1 ) {
                        selected_name.push($('#txttemplatedata_' + i).val());
                    }
                    else{
                        for( var j = 0; j < selected_name.length; j++ ) {
                            if( selected_name[j] == $('#txttemplatedata_' + i).val() ) break;
                        }
                        selected_name.splice( j,1 );
                    }
                }
                var templatedata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    templatedata += selected_name[i] + '#';
                }
                templatedata = templatedata.substr( 0, templatedata.length - 1 );
				//alert(templatedata);
                $('#select_template_data').val( templatedata );
            }
        }

        function toggle( x, origColor) {
            var newColor = 'yellow';
            if ( x.style ) {
                x.style.backgroundColor = (newColor == x.style.backgroundColor)? origColor : newColor;
            }
        }

        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        function js_set_value( str) {
            if($("#search"+str).css("display") !='none'){
                if(str%2==0  ){
                    toggle( document.getElementById( 'search' + str ), '#FFFFFF');
                }
                if(str%2!=0 ){
                    toggle( document.getElementById( 'search' + str ), '#E9F3FF');
                }
                if( jQuery.inArray( $('#txttemplatedata_' + str).val(), selected_name ) == -1 ) {
                    selected_name.push($('#txttemplatedata_' + str).val());
                }
                else{
                    for( var i = 0; i < selected_name.length; i++ ) {
                        if( selected_name[i] == $('#txttemplatedata_' + str).val() ) break;
                    }
                    selected_name.splice( i,1 );
                }
            }
            var templatedata='';
            for( var i = 0; i < selected_name.length; i++ ) {
                templatedata += selected_name[i] + '#';
            }
            templatedata = templatedata.substr( 0, templatedata.length - 1 );
            $('#select_template_data').val( templatedata );
        }
    </script>
    <?
	// $template_name_sql=sql_select("select a.template_name from wo_lib_trim_cost_temp a,wo_lib_trim_cost_temp_dtls b where a.id=b.lib_trim_costing_temp_id and b.buyer_id =$buyer_name and a.is_deleted=0 group by  a.template_name"); //for Woven
   $template_name_sql=sql_select("select  a.template_name  from lib_trim_costing_temp a,lib_trim_costing_temp_dtls b where a.id=b.lib_trim_costing_temp_id and b.buyer_id =$buyer_name and a.is_deleted=0 group by a.template_name");
  // echo "select  a.template_name  from lib_trim_cost_temp a,lib_trim_cost_temp_dtls b where a.id=b.lib_trim_costing_temp_id and b.buyer_id =$buyer_name and a.is_deleted=0 group by a.template_name";

   // $template_name_sql=sql_select("select distinct template_name from wo_lib_trim_cost_temp where is_deleted=0");

      ?>
    </head>
    <body>
    <div align="center" style="width:100%;">
    	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="200" class="rpt_table" align="left">
    		<tr>
    			<input id="hidden_template_name" type="hidden" name="hidden_template_name">
    			<th width="100"><span style="font-size: 25px">Template Name</span></th>
    		</tr>
    		<?
    		$i=0;
    		foreach ($template_name_sql as $row){
    		if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF"; ?>
    		<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" onClick="insert_template_data('<? echo $row[csf("template_name")] ?>','<? echo $buyer_name; ?>')">
    			<td width="100" align="center"><span style="font-size: 20px"><? echo $row[csf("template_name")]; ?></span></td>
    		</tr>
    		<? $i++; } ?>

    	</table>
        <table id="trmplate_data_tbl" cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
            <input type="hidden" id="select_template_data" name="select_template_data"/>
            <thead>
                <tr>
                    <th width="80">User Code</th>
                    <th width="120">Group</th>
                    <th width="100">Description</th>
                    <th width="100">Brand/Sup Ref.</th>
                    <th width="100">Nominated Supp</th>
                    <th width="70">Cons UOM</th>
                    <th width="95">Cons/Dzn Gmts</th>
                    <th width="50">Rate</th>
                    <th width="50">Amount</th>
                    <th>Apvl Req.</th>
                </tr>
            </thead>

        </table>
         <table id="template_data_tbl" cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
            <tbody id="template_date">
            </tbody>
        </table>

        <table width="420" id="check_all_tbl" cellspacing="0" cellpadding="0" style="border:none; display: none; margin-top: 10px" align="center">
        <tr>
            <td align="center" height="30" width="200" valign="bottom">
                <div style="width:300px">
                    <div style="width:150px; float:left" align="left">
                        <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                    </div>
                    <div style="width:150px; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
    </table>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action == "check_trims_data"){
    $trims_cost=sql_select("select id from wo_pre_cost_trim_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
	if(count($trims_cost) > 0 ) echo 1;
	else echo 0;
	exit();
}

if($action == "get_template_data")
{
    $trim_variable=1;
	$dataArr=explode("_",$data);
	$data=$dataArr[0];
	$buyer=$dataArr[1];
    $trim_variable_sql=sql_select("select trim_rate from  variable_order_tracking where company_name='$data[4]' and variable_list=35 order by id");
    foreach($trim_variable_sql as $trim_variable_row)
    {
        $trim_variable= $trim_variable_row[csf('trim_rate')];
    }
    $lib_item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name", "id", "item_name");
    $trim_rate_from_library=return_library_array( "select a.id, max(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.status_active=1 and    a.is_deleted=0 group by a.id", "id", "rate");
    $supplier_library=return_library_array( "select a.supplier_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
   // $data_array=sql_select("SELECT * from wo_lib_trim_cost_temp where template_name='$data' and status_active=1 and is_deleted=0");
   // $data_array=sql_select("SELECT * from lib_trim_costing_temp where template_name='$data' and status_active=1 and is_deleted=0");
     $data_array=sql_select("SELECT a.id ,a.trims_group,a.cons_dzn_gmts,a.trims_group,a.purchase_rate,a.amount,a.user_code,a.cons_uom,a.apvl_req,a.supplyer,a.sup_ref,a.item_description ,a.ex_per from lib_trim_costing_temp a,lib_trim_costing_temp_dtls b where a.id=b.lib_trim_costing_temp_id and a.template_name='$data' and b.buyer_id='$buyer' and a.status_active=1 and a.is_deleted=0 order by a.id asc");
	//echo "SELECT * from lib_trim_costing_temp where template_name='$data' and status_active=1 and is_deleted=0";
    $i=1;
    foreach( $data_array as $row )
    {
        $rate=$trim_rate_from_library[$row[csf('trims_group')]];
        $amount=$row[csf('cons_dzn_gmts')]*$trim_rate_from_library[$row[csf('trims_group')]];
        if($rate=="" || $rate==0)
        {
            $rate=$row[csf('purchase_rate')];
            $amount=$row[csf('amount')];
        }
        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
        $str="";
        $str=$lib_item_group_arr[$row[csf("trims_group")]].'***'.$row[csf('user_code')].'***'.$row[csf('trims_group')].'***'.$row[csf('cons_uom')].'***'.$row[csf('cons_dzn_gmts')].'***'.$row[csf('purchase_rate')].'***'.$row[csf('amount')].'***'.$row[csf('apvl_req')].'***'.$row[csf('supplyer')].'***'.$row[csf('sup_ref')].'***'.$row[csf('item_description')].'***'.$row[csf('ex_per')];
     ?>
        <tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<? echo $i;?>" class="itemdata" onClick="js_set_value(<? echo $i; ?>)" >
            <td width="80" style="word-break:break-all">
                <? echo $row[csf("user_code")]; ?>
                <input type="hidden" name="txttemplatedata_<? echo $i; ?>" id="txttemplatedata_<? echo $i; ?>" value="<? echo $str; ?>"/>
            </td>
            <td width="120" style="word-break:break-all"><? echo $lib_item_group_arr[$row[csf("trims_group")]]; ?></td>
            <td width="100" style="word-break:break-all"><? echo $row[csf("item_description")];?></td>
            <td width="100" style="word-break:break-all"><? echo $row[csf("sup_ref")]; ?></td>
            <td width="100" style="word-break:break-all"><? echo $supplier_library[$row[csf("supplyer")]]; ?></td>
            <td width="70" style="word-break:break-all"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
            <td width="95" align="right"><? echo $row[csf("cons_dzn_gmts")];?></td>
            <td width="50" align="right"><? echo fn_number_format($rate,4);?></td>
            <td width="50" align="right"><? echo fn_number_format($amount,4);?></td>
            <td style="word-break:break-all"><? echo $yes_no[$row[csf("apvl_req")]]; ?></td>
        </tr>
    <?  $i++;
	}
    exit();
}

if($action=="report_part_select_view")
{
	extract($_REQUEST);
	echo load_html_head_contents("Popup Info","../../../", '', '', $unicode);
	?>
    <script>

		var selected_id = new Array;
		var selected_name = new Array;
		var selected_no = new Array;
    	function check_all_data()
		{
			//var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			var tbl_row_count = $('#list_view tbody tr').length;
			var onclickString=paramArr=functionParam="";
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				onclickString = $('#tr_' + i).attr('onclick');
				paramArr = onclickString.split("'");
				functionParam = paramArr[1];
				js_set_value( functionParam );

			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( strCon )
		{
			//alert(strCon);
				var splitSTR = strCon.split("_");
				var str_or = splitSTR[0];
				var selectID = splitSTR[1];
				var selectDESC = splitSTR[2];
				//$('#txt_individual_id' + str).val(splitSTR[1]);
				//$('#txt_individual' + str).val('"'+splitSTR[2]+'"');

				toggle( document.getElementById( 'tr_' + str_or ), '#FFFFCC' );

				if( jQuery.inArray( str_or, selected_no ) == -1 ) {
					selected_id.push( selectID );
					selected_name.push( selectDESC );
					selected_no.push( str_or );
				}
				else {
					for( var i = 0; i < selected_id.length; i++ ) {
						if( selected_id[i] == selectID ) break;
					}
					selected_id.splice( i, 1 );
					selected_name.splice( i, 1 );
					selected_no.splice( i, 1 );
				}
				var id = ''; var name = ''; var job = ''; var num='';
				for( var i = 0; i < selected_id.length; i++ ) {
					id += selected_id[i] + ',';
					name += selected_name[i] + ',';
					num += selected_no[i] + ',';
				}
				id 		= id.substr( 0, id.length - 1 );
				name 	= name.substr( 0, name.length - 1 );
				num 	= num.substr( 0, num.length - 1 );
				//alert(num);
				$('#txt_selected_id').val( id );
				$('#txt_selected').val( name );
				$('#txt_selected_no').val( num );
		}

		function frm_close()
		{
			parent.emailwindow.hide();
		}
    </script>
    <?
	$select_rpt_option_arr=array(1=>"Main Cost Sheet ",2=>"Fabric Cost Details",3=>"Trims Cost Details",4=>"Embellishment Cost Details",
     5=>"Commercial Cost Details",6=>"Commission Cost Details",7=>"Other Cost Details",8=>"Summary");

	//echo $sql;die;
	?>

    <div>
    <table width="100%" cellpadding="0" cellspacing="0" class="rpt_table" border="1" rules="all" id="list_view" align="left">
    	<thead>
        	<tr>
                <th width="50">Sl</th>
                <th>Report Option</th>
            </tr>
        </thead>
        <tbody>
			<?
            $i=1;
            foreach($select_rpt_option_arr as $id=>$val)
            {
                if ($i%2==0)
                $bgcolor="#E9F3FF";
                else
                $bgcolor="#FFFFFF";
                ?>
                <tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>" onClick="js_set_value('<? echo $i."_".$id."_".$val; ?>')" style="cursor:pointer">
                    <td width="50"  align="center"><? echo $i; ?></td>
                    <td><? echo $val; ?></td>
                </tr>
                <?
                $i++;
            }
            ?>
            <tr>
                <td  style="vertical-align:middle; padding-left:20px;" colspan="2"><input type="checkbox" id="all_check" onClick="check_all_data('all_check')" />&nbsp;Check All / Un-Check All
                <input type='hidden' id='txt_selected_id' />
                <input type='hidden' id='txt_selected' />
                <input type='hidden' id='txt_selected_no' />
                </td>
            </tr>
        </tbody>
    </table>
    <br>
    <div style="width:100%"><p align="center"><input type="button" id="btn_close" class="formbutton" style="width:100px;" value="Close" onClick="frm_close();" ></p></div>
    </div>

    <script language="javascript" type="text/javascript">
	var category_no='<? echo $print_option_no;?>';
	var category_id='<? echo $print_option_id;?>';
	var category_des='<? echo $print_option;?>';
	var cate_ref="";
	if(category_no!="")
	{
		category_no_arr=category_no.split(",");
		category_id_arr=category_id.split(",");
		category_des_arr=category_des.split(",");
		var str_ref="";
		for(var k=0;k<category_no_arr.length; k++)
		{
			cate_ref=category_no_arr[k]+'_'+category_id_arr[k]+'_'+category_des_arr[k];
			js_set_value(cate_ref);
		}
	}
	</script>
    <?
	exit();
}

if($action=="order_no_popup_old")
{
	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	//echo $popup_checkid;
    ?>
    <script>
		var selected_id = new Array;
		var selected_name = new Array;
		var selected_color = new Array;

		var popup_checkid = '<?=$popup_checkid;?>';
	    function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			tbl_row_count = tbl_row_count - 0;
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				var onclickString = $('#tr_' + i).attr('onclick');
				var paramArr = onclickString.split("'");
				var functionParam = paramArr[1];
				js_set_value( functionParam );
			}
		}

		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			if ( x.style )
			{
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( strCon )
		{

			var splitSTR = strCon.split("_");
			var str = splitSTR[0];
			var selectID = splitSTR[1];
			var selectDESC = splitSTR[2];
			var selectColor = splitSTR[3];
			//alert(selectColor);
			if(popup_checkid==0)
			{
				str=selectColor;
			}

			toggle( document.getElementById( 'tr_' + str ), '#FFFFCC' );

			if( jQuery.inArray( selectID, selected_id ) == -1 )
			{
				alert(1);
				selected_id.push( selectID );
				selected_name.push( selectDESC );
				selected_color.push( selectColor );
			}
			else
			{
				//alert(0);

				for( var i = 0; i < selected_id.length; i++ )
				{
					if( selected_id[i] == selectID ) break;
				}

				//alert(selected_id.length);
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
				selected_color.splice( i, 1 );
			}
			var id = ''; var name = ''; var color = '';var job = '';
			for( var i = 0; i < selected_id.length; i++ )
			{
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
				color += selected_color[i] + ',';
			}
			id 		= id.substr( 0, id.length - 1 );
			name 	= name.substr( 0, name.length - 1 );
			color 	= color.substr( 0, color.length - 1 );
			$('#txt_selected_id').val( id );
			$('#txt_selected').val( name );
			//alert(id);
			$('#txt_selected_color').val( color );
		}

	</script>
    <?
	if($popup_checkid==1) //PO Level
	{
		//$i=1;
		$sql= "select id, po_number, po_quantity, pub_shipment_date, is_confirmed from wo_po_break_down where job_id='$hidd_job_id' and status_active =1 and is_deleted=0";
		/* foreach($sql as $row){
			$po_number=$row[csf('po_number')];
			$po_id=$row[csf('id')];
			$po_quantity=$row[csf('po_quantity')];
			$pub_shipment_date=$row[csf('pub_shipment_date')];
			$is_confirmed=$row[csf('is_confirmed')];
		} */
	?>
	<form name="searchpofrm_1" id="searchpofrm_1">
                <table width="500" class="rpt_table" align="center" rules="all">
                    <thead>
					<tr>
                            <th width="70">Po Id</th>
                            <th width="130">PO No.</th>
                            <th width="100">Po Qty.</th>
                            <th width="70">Pub Shipment Date</th>
                            <th width="80">Order Status</th>
                        </tr>
					</thead>
					<?
					$sql= "select id, po_number, po_quantity, pub_shipment_date, is_confirmed from wo_po_break_down where job_id='$hidd_job_id' and status_active =1 and is_deleted=0";
					foreach($sql as $row){
					?>
					<tbody>
					<tr>
							<td width="70"><? echo $row[csf('id')] ;?></td>
                            <td width="130"><? echo $row[csf('po_number')] ;?></td>
                            <td width="100"><? echo $row[csf('po_quantity')] ;?></td>
                            <td width="70"><? echo change_date_format($row[csf('pub_shipment_date')]) ;?></td>
                            <td width="80"><? echo $order_status[$row[csf('is_confirmed')]] ;?></td>
                        </tr>
						</tbody>
						<? } ?>
				</table>
		</form>
	<?
	}
	else
	{
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$sql= "select a.id, a.po_number, a.po_quantity, a.pub_shipment_date, a.is_confirmed,b.color_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a, wo_po_color_size_breakdown b where a.job_id='$hidd_job_id' and a.id=b.po_break_down_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 group by a.id, a.po_number, a.po_quantity, a.pub_shipment_date, a.is_confirmed,b.color_number_id"; //$job_num
	//echo  $sql;die;
	$arr=array(2=>$color_library,5=>$order_status);
	 ?>
		<form name="searchpofrm_1" id="searchpofrm_1">
                <table width="600" class="rpt_table" align="center" rules="all">
                    <thead>
					<tr>
                            <th width="70">Po Id</th>
                            <th width="130">PO No.</th>
							<th width="100">Color</th>
                            <th width="100">Color Qty.</th>
                            <th width="70">Pub Shipment Date</th>
                            <th width="80">Order Status</th>
                        </tr>
					</thead>
				</table>
		</form>
	 <?
	}
	echo "<input type='text' id='txt_selected_id' />";
	echo "<input type='hidden' id='txt_selected' />";
	echo "<input type='text' id='txt_selected_color' />";
	exit();
}
if($action=="order_no_popup")
{
	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	//echo $popup_checkid;
    ?>
    <script>
		var selected_id = new Array;
		var selected_name = new Array;
		var selected_color = new Array;
		var select_poid = new Array;

		var popup_checkid = '<?=$popup_checkid;?>';
	    function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			tbl_row_count = tbl_row_count - 0;
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				var onclickString = $('#tr_' + i).attr('onclick');
				var paramArr = onclickString.split("'");
				var functionParam = paramArr[1];
				js_set_value( functionParam );
			}
		}

		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			if ( x.style )
			{
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( strCon )
		{

			var splitSTR = strCon.split("_");
			var str = splitSTR[0];
			if(popup_checkid==1) splitSTR[3]=0;
			var selectID = splitSTR[1]+'**'+splitSTR[3];
			var selectDESC = splitSTR[2];
			var selectColor = splitSTR[3];
			var selectPoId = splitSTR[1];
		//	alert(selectPoId);


			toggle( document.getElementById( 'tr_' + str ), '#FFFFCC' );

			if( jQuery.inArray( selectID, selected_id ) == -1 )
			{
				//alert(1);
				selected_id.push( selectID );
				selected_name.push( selectDESC );
				selected_color.push( selectColor );
				select_poid.push( selectPoId );
			}
			else
			{
				//alert(0);

				for( var i = 0; i < selected_id.length; i++ )
				{
					if( selected_id[i] == selectID ) break;
				}

				//alert(selected_id.length);
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
				selected_color.splice( i, 1 );
				select_poid.splice( i, 1 );
			}
			var id = ''; var name = ''; var color = '';var poId = '';
			for( var i = 0; i < selected_id.length; i++ )
			{
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
				color += selected_color[i] + ',';
				poId += select_poid[i] + ',';
			}
			id 		= id.substr( 0, id.length - 1 );
			name 	= name.substr( 0, name.length - 1 );
			color 	= color.substr( 0, color.length - 1 );
			poId 	= poId.substr( 0, poId.length - 1 );
			$('#txt_selected_id').val( poId );
			$('#txt_selected').val( name );
			//alert(color);
			$('#txt_selected_color').val( color );
		}

	</script>
    <?
	if($popup_checkid==1) //PO Level
	{


	$sql= "select id, po_number, po_quantity, pub_shipment_date, is_confirmed from wo_po_break_down where job_id='$hidd_job_id' and status_active =1 and is_deleted=0"; //$job_num
	//echo  $sql;die;
	$arr=array(4=>$order_status);
	echo  create_list_view("list_view", "Po Id,PO No.,Po Qty.,Pub Shipment Date, Order Status", "70,130,100,70,80","500","300",0, $sql , "js_set_value", "id,po_number", "", 1, "0,0,0,0,is_confirmed", $arr , "id,po_number,po_quantity,pub_shipment_date,is_confirmed", "",'setFilterGrid("list_view",-1);','0,0,0,3,0','',1) ;
	}
	else
	{

	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$sql= "select a.id, a.po_number, a.po_quantity, a.pub_shipment_date, a.is_confirmed,b.color_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a, wo_po_color_size_breakdown b where a.job_id='$hidd_job_id' and a.id=b.po_break_down_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 group by a.id, a.po_number, a.po_quantity, a.pub_shipment_date, a.is_confirmed,b.color_number_id order by a.id"; //$job_num
	//echo  $sql;die;
	$arr=array(2=>$color_library,5=>$order_status);
	echo  create_list_view("list_view", "Po Id,PO No.,Color,Color Qty.,Pub Shipment Date, Order Status", "70,130,100,100,70,80","600","300",0, $sql , "js_set_value", "id,po_number,color_number_id", "", 1, "0,0,color_number_id,0,0,is_confirmed", $arr , "id,po_number,color_number_id,order_quantity,pub_shipment_date,is_confirmed", "",'setFilterGrid("list_view",-1);','0,0,0,0,3,0','',1) ;
	}
	echo "<input type='hidden' id='txt_selected_id' />";
	echo "<input type='hidden' id='txt_selected' />";
	echo "<input type='hidden' id='txt_selected_color' />";
	exit();
}

if($action=='appSubmission_withoutanyChange')
{
	$con = connect();
	if($db_type==0) mysql_query("BEGIN");
	$flag=1;
	$exdata=explode("**",$data);
	$jobNo=$exdata[0];
	$jobId=$exdata[1];
	$ready_to_approved=$exdata[2];
	$pre_cost_id=$exdata[3];
	$txt_fabric_pre_cost=$exdata[4]*1;
	
	$company_id=$exdata[5];
	
	$cost_mendatorySql=sql_select("select variable_list, excut_source, cm_cost_compulsory from variable_order_tracking where company_name='$company_id' and variable_list in (22,27) and status_active=1 and is_deleted=0");
	
	$commercial_costmendatory=$cm_costmendatory=0;
	
	foreach($cost_mendatorySql as $row)
	{
		if($row[csf('variable_list')]==27 && $row[csf('excut_source')]==1) $commercial_costmendatory=$row[csf('excut_source')];
		if($row[csf('variable_list')]==22 && $row[csf('cm_cost_compulsory')]==1) $cm_costmendatory=$row[csf('cm_cost_compulsory')];
	}
	$isorder_change=return_field_value("isorder_change","wo_pre_cost_mst","job_id=".$jobId." and is_deleted=0 and status_active=1");
	if($isorder_change==1 && $ready_to_approved==1)
	{
		$sql_check=sql_select("SELECT a.job_no_mst, Max(b.is_apply_last_update) as is_apply_last_update from wo_po_color_size_breakdown a, wo_pre_cost_fabric_cost_dtls b where a.job_no_mst=b.job_no and a.job_id=$jobId and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no_mst");

		$chk_msg='';
		foreach($sql_check as $check_row)
		{
			if($check_row[csf("is_apply_last_update")]==2)
			{
				$chk_msg=1;
			}
		}
		//Fabric ,Trims,Emblishment,Wash Synchronize check//If color size breakdown updated found
		$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_trim_cost_dtls b where  b.job_id=$jobId and b.is_deleted=0 and b.status_active=1");

		$trim_msg="";
		foreach($sql_trim as $row)
		{
			if($row[csf("is_apply_last_update")]==2)
			{
				$chk_msg=1;
			}
		}
		$sql_conv=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fab_conv_cost_dtls b where  b.job_id=$jobId and b.is_deleted=0 and b.status_active=1");

		$conv_msg="";
		foreach($sql_conv as $row)
		{
			if($row[csf("is_apply_last_update")]==2)
			{
				$conv_msg=" Conversion,";
				$chk_msg=1;
			}
		}

		$sql_embl=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update,emb_name  from wo_pre_cost_embe_cost_dtls b where  b.job_id=$jobId and b.is_deleted=0 and b.status_active=1 and cons_dzn_gmts>0 group by emb_name");

		$emb_msg="";
		foreach($sql_embl as $row)
		{
			if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]==3) //Wash
			{
				$wash_msg=" Wash,";
				$chk_msg=1;
			}
			else if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]!=3)
			{
				$emb_msg=" Emblishment,";
				$chk_msg=1;
			}
		}
		if($chk_msg==1)
		{
			echo "synchronize***".str_replace("'","",$jobNo);die;
		}
	}
	if($ready_to_approved==1)
	{
		//echo "10**".$commercial_costmendatory.'='.$cm_costmendatory; die;
		if($commercial_costmendatory==1)//ISD-24-00664
		{
			$commercial_costamt=0;
			$data_array=sql_select("select sum(amount) as comlamt from wo_pre_cost_comarci_cost_dtls where job_no='$jobNo' and status_active=1 and is_deleted=0 group by job_no");
			
			$commercial_costamt=$data_array[0][csf('comlamt')]*1;
			
			if($commercial_costamt=="" || $commercial_costamt==0)
			{
				echo "commercial***".str_replace("'","",$jobNo);
				die;
			}
		}
		
		if($cm_costmendatory==1)//ISD-24-00664
		{
			$cm_costamt=0;
			$data_array=sql_select("select sum(CM_COST) as CM_COST from WO_PRE_COST_DTLS where job_no='$jobNo' and status_active=1 and is_deleted=0 group by job_no");
			
			$cm_costamt=$data_array[0]['CM_COST']*1;
			
			if($cm_costamt=="" || $cm_costamt==0)
			{
				echo "cmcost***".str_replace("'","",$jobNo);
				die;
			}
		}
	}

	$insDate="15-May-2020";

	$isBomInsDate=return_field_value("job_no", "wo_pre_cost_mst", "job_no='$jobNo' and insert_date>'$insDate' and status_active=1 and is_deleted=0");

	$imageArray=sql_select( "select id, image_location, master_tble_id, details_tble_id, form_name, file_type, real_file_name from common_photo_library where master_tble_id='$pre_cost_id' and form_name='pre_cost_v2' and file_type=2");

	if($_SESSION['logic_erp']['mandatory_field'][158][5]!= '' && count($imageArray) == 0 && $txt_fabric_pre_cost>0 && $isBomInsDate!="")
	{
		echo "file**".str_replace("'","",$txt_job_no);
		die;
	}

	$approved=0;
	$sql=sql_select("select approved from wo_pre_cost_mst where job_no='$jobNo'");
	foreach($sql as $row){
		if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
	}
	if($approved==1){
		echo "approved***".str_replace("'","",$jobNo);
		die;
	}

	$id=return_next_id( "id", "wo_pre_cost_readyapp_his", 1);
	$field_array="id, job_no, job_id, updated_by, update_date";
	$data_array="(".$id.",'".$jobNo."','".$jobId."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
	$rID=sql_insert("wo_pre_cost_readyapp_his",$field_array,$data_array,1);
	if($rID==1 && $flag==1) $flag=1; else $flag=0;
	$update_by=$_SESSION['logic_erp']['user_id'];
	$query="UPDATE wo_pre_cost_mst SET ready_to_approved=$ready_to_approved, updated_by=$update_by, update_date='$pc_date_time' WHERE job_no='$jobNo' and status_active=1 and is_deleted=0";
	$rID1=execute_query($query,1);
	if($rID1==1 && $flag==1) $flag=1; else $flag=0;

		if($is_component_app==1 && $flag==1)
		{
			 $k=1;
			foreach($cost_components as $comp_key=>$val) //As per Bearsh Vi
			{
			 $rID2=execute_query( "update precost_component_app_mst set ready_to_approved=".$ready_to_approved." where job_id =$jobId and cost_component_id ='$comp_key'",1);
			 $k++;
			}
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}

	//echo "10**".$rID.'-'.$rID1.'-'.$flag; die;

	if($db_type==0)
	{
		if($flag==1)
		{
			mysql_query("COMMIT");
			echo "1***".$flag;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo "10**".$flag;
		}
	}
	else if($db_type==2)
	{
		if($flag==1)
		{  
			//App Notification....................................
			if($_SESSION['app_notification'] == 1){
				//$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
				$notification = new Notifications();
				if($ready_to_approved == 1){
					$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
					$company_name=return_library_array( "select id,COMPANY_SHORT_NAME from lib_company",'id','COMPANY_SHORT_NAME');
					$dealing_mar=return_library_array( "select ID,TEAM_MEMBER_NAME FROM lib_mkt_team_member_info",'id','TEAM_MEMBER_NAME');
					$user_name=return_library_array( "select ID,USER_FULL_NAME FROM USER_PASSWD",'id','USER_FULL_NAME');
					$brand_name=return_library_array( "select ID,BRAND_NAME FROM LIB_BUYER_BRAND",'id','BRAND_NAME');
					
					//$job_sql_res = sql_select("SELECT p.ID,p.COSTING_DATE,a.JOB_NO,a.STYLE_OWNER,a.TOTAL_PRICE,a.INSERT_DATE,a.STYLE_REF_NO,a.SET_SMV,a.GMTS_ITEM_ID,a.JOB_QUANTITY,pd.CM_COST,pd.CM_COST_PERCENT,pd.TRIMS_COST_PERCENT,pd.MARGIN_PCS_SET_PERCENT,p.INSERTED_BY,a.DEALING_MARCHANT,d.COMPANY_SHORT_NAME,a.COMPANY_NAME as COMPANY_ID, a.BUYER_NAME as BUYER_ID,b.BUYER_NAME,a.BRAND_ID,c.BRAND_NAME from WO_PRE_COST_MST p left join WO_PRE_COST_DTLS pd on pd.JOB_ID = p.JOB_ID,WO_PO_DETAILS_MASTER a left join lib_buyer b on a.buyer_name = b.id left join LIB_BUYER_BRAND c on a.brand_id = c.id left join LIB_COMPANY d on a.company_name = d.id where  a.id = p.job_id and A.id = '$jobId'");
					//$job_sql_res = sql_select("SELECT a.ID as job_id,p.ID,p.COSTING_DATE,a.JOB_NO,a.STYLE_OWNER,a.TOTAL_PRICE,a.STYLE_REF_NO,c.GMTS_ITEM_ID,c.SMV_SET,a.JOB_QUANTITY,pd.CM_COST,pd.CM_COST_PERCENT,pd.TRIMS_COST_PERCENT,pd.MARGIN_PCS_SET_PERCENT,p.INSERTED_BY,a.DEALING_MARCHANT,a.COMPANY_NAME as COMPANY_ID, a.BUYER_NAME as BUYER_ID,a.BRAND_ID FROM WO_PRE_COST_MST p,WO_PRE_COST_DTLS pd,WO_PO_DETAILS_MASTER a,WO_PO_BREAK_DOWN b,WO_PO_DETAILS_MAS_SET_DETAILS c WHERE pd.JOB_ID = p.JOB_ID and a.ID = p.JOB_ID and a.ID = b.JOB_ID and c.JOB_ID = a.ID and a.ID = '$jobId'");
					$job_sql_res = sql_select("SELECT a.ID AS job_id,b.PUB_SHIPMENT_DATE, p.ID, p.COSTING_DATE, a.JOB_NO, a.STYLE_OWNER, a.TOTAL_PRICE, a.STYLE_REF_NO, LISTAGG(d.ITEM_NAME, ',') WITHIN GROUP (ORDER BY c.GMTS_ITEM_ID) AS GMTS_NAMES, LISTAGG(c.SMV_SET, ',') WITHIN GROUP (ORDER BY c.SMV_SET) AS SMV_SET_LIST, a.JOB_QUANTITY, pd.CM_COST, pd.CM_COST_PERCENT, pd.TRIMS_COST_PERCENT, pd.MARGIN_PCS_SET_PERCENT, p.INSERTED_BY, a.DEALING_MARCHANT, a.COMPANY_NAME AS COMPANY_ID, a.BUYER_NAME AS BUYER_ID, a.BRAND_ID FROM WO_PRE_COST_MST p, WO_PRE_COST_DTLS pd, WO_PO_DETAILS_MASTER a, WO_PO_BREAK_DOWN b, WO_PO_DETAILS_MAS_SET_DETAILS c,lib_garment_item d WHERE pd.JOB_ID = p.JOB_ID AND a.ID = p.JOB_ID AND a.ID = b.JOB_ID AND c.JOB_ID = a.ID and c.GMTS_ITEM_ID = d.ID AND a.ID = $jobId GROUP BY a.ID, p.ID, p.COSTING_DATE, a.JOB_NO, a.STYLE_OWNER, a.TOTAL_PRICE, a.STYLE_REF_NO, a.JOB_QUANTITY, pd.CM_COST, pd.CM_COST_PERCENT, pd.TRIMS_COST_PERCENT, pd.MARGIN_PCS_SET_PERCENT, p.INSERTED_BY, a.DEALING_MARCHANT, a.COMPANY_NAME, a.BUYER_NAME, a.BRAND_ID,b.PUB_SHIPMENT_DATE");

					foreach($job_sql_res as $row){
						//$desc = "Company: ".$row['COMPANY_NAME'].",\nJob. No: ".$row['JOB_NO'].", \nCosting. date: ".date('d/m/Y',strtotime($row['COSTING_DATE']));
						//$desc = "PO.Com: ".$row['COMPANY_NAME']."    Style Owner: ".$company_name[$row['STYLE_OWNER']]." \nBOM No: ".$row['JOB_NO']."    BOM date: ".date('d/m/Y',strtotime($row['INSERT_DATE']))."\nStyle Ref: ".$row['STYLE_REF_NO']."    Style (Pcs): ".$row['JOB_QUANTITY']."\nGMT Item: ".$row['GMTS_ITEM_ID']."    SMV: ".$row['SET_SMV']."\nStyle Value: ".$row['TOTAL_PRICE']."    CM Cost $: ".$row['CM_COST']."\nFOB/Pc:     Costing/Pc:     Mar/Pcs $: \nFab:     Trims: ".$row['TRIMS_COST_PERCENT']."    CM: ".$row['CM_COST_PERCENT']."    Margin: ".$row['MARGIN_PCS_SET_PERCENT']."\nMarchent: ".$dealing_mar[$row['DEALING_MARCHANT']]."    Forward by: ".$user_name[$row['INSERTED_BY']];
						$desc = "Company: ".$company_name[$row['COMPANY_ID']]."    Style Owner: ".$company_name[$row['STYLE_OWNER']].
						" \nBOM No: ".$row['JOB_NO']."    BOM date: ".date('d/m/Y',strtotime($row['COSTING_DATE'])).
						"\nStyle Ref: ".$row['STYLE_REF_NO']."    Style (Pcs): ".$row['JOB_QUANTITY'].
						"\nGMT Item: ".$row['GMTS_NAMES'].
						"\nSMV: ".$row['SMV_SET_LIST']."    Style Value: ".$row['TOTAL_PRICE'].
						//"    CM Cost $: ".$row['CM_COST']."\nFOB/Pc:     Costing/Pc:     Mar/Pcs $: \nFab:     Trims: ".$row['TRIMS_COST_PERCENT']."    CM: ".$row['CM_COST_PERCENT']."    Margin: ".$row['MARGIN_PCS_SET_PERCENT'].
						"\nMarchent: ".$dealing_mar[$row['DEALING_MARCHANT']]."    Forward by: ".$user_name[$row['INSERTED_BY']];
						$noti_data_arr = array(
							'ID' => $row['ID'],
							'DATE' => date('d/m/Y',strtotime($row['COSTING_DATE'])),
							'DELIVERY_DATE' => date('d/m/Y',strtotime($row['PUB_SHIPMENT_DATE'])),
							'COMPANY' => $company_name[$row['COMPANY_ID']],
							'BUYER' => $buyer_name_arr[$row['BUYER_ID']],
							'SYS_NUMBER' => $row['JOB_NO'],
							'SYS_DEF' => '',
							'DESC' => $desc,
							'MENU_ID' => return_field_value("page_id as menu_id","ELECTRONIC_APPROVAL_SETUP","entry_form=77","menu_id")
						);

						$approval_parameter = array('BUYER_ID' => $row['BUYER_ID'],'BRAND_ID' => $row['BRAND_ID'],
						'approval_data' => $noti_data_arr,
						'approval_desc' => 'Company :'.$company_name[$row['COMPANY_ID']].', Job :'.$row['JOB_NO'].', Buyer :'.$buyer_name_arr[$row['BUYER_ID']].', Brand :'.$brand_name[$row['BRAND_ID']] );
						$COMPANY_NAME = $row['COMPANY_ID'];
					}
					$not_res = $notification->notificationEngine($pre_cost_id,$COMPANY_NAME,77,$approval_parameter);
				}
				else{
					$appr_data = array("USER_ID"=>'',"SEQUENCE_NO" =>'',"COMPANY_ID"=> '','NOTIFICATION_TYPE'=>0,'approval_desc'=>'','approval_data'=>'');
					$not_res=$notification->pushAll($pre_cost_id,77,$appr_data);
					if($not_res == 1)
					{
						$query="DELETE FROM APPROVAL_NOTIFICATION_ENGINE  WHERE ENTRY_FORM=77 AND REF_ID IN ($pre_cost_id) ";
						$not_delete=execute_query($query,1);
					} 
				}
			}
			//.................................................end;
			oci_commit($con);
			echo "1***".$flag;
		}
		else
		{
			oci_rollback($con);
			echo "10**".$flag;
		}
	}
	disconnect($con);
	die;
}

if($action=="yarn_cost_mail_send")//md mamun-11-28-2021-crm-27160
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$team_leader_arr=return_library_array( "select id,team_leader_name from lib_marketing_team",'id','team_leader_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		?>										<!--    Header Company Information         -->



		<?

        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);

        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';

        $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks,b.team_leader,b.fit_id from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");

		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];


		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";

			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";

			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }

		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));

		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		?>
		<div width="100%"><?
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
			$extra=explode("_",$rmg_process_breakdown);



            $booking_percent=$result[csf('booking_percent')];
			 $booking_po_id=$result[csf('po_break_down_id')];

									 $a_process_loss=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[13]+$extra[1];
									$b_process_loss=$extra[4]+$extra[3]+$extra[15];
									$tot_pro_loss=$a_process_loss+$b_process_loss;

				$sum_fin_fabqnty=sql_select("SELECT  sum(d.fin_fab_qnty) as qty	FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on
				a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on
				b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id
				WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0");

				//  print_r($total_fin_fabqnty);

			ob_start();
			$path=($path)?$path:'../../';

			?>


			<table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
				<td align="center" colspan="2"><img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='5%' width='7%' align="left"/><p style=" margin-top:2%;"><?php echo $company_library[$cbo_company_name]; ?></p></td>
					<td align="center" width="100" colspan="2"> TEAM : &nbsp; <?=$team_leader_arr[$result[csf('team_leader')]];?></td>
					<td align="center" width="100" colspan="2"> FIT: &nbsp; <?=$fit_list_arr[$result[csf('fit_id')]];?></td>
					<td align="center" colspan="2" width="170">FABRIC BOOKIC SHEET<br><?=str_replace("'","",$txt_booking_no);?></td>
				</tr>
		 	</table>
			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>Portal Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_received_date;?></b></td>
					<td width="150" style="font-size:16px;"><b>Job No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo trim($txt_job_no,"'"); ?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Prepared Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$result[csf('booking_date')];?></b></td>
					<td width="150" style="font-size:16px;"><b>Style Description</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Buyer / Brand </b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></td>
					<td width="150" style="font-size:16px;"><b>Order Quantity</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1;?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Style Ref. No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<? echo $result[csf('style_ref_no')];?> </b></td>
					<td width="150" style="font-size:16px;"><b>Target Input Qty.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Garments Item</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?></b></td>
					<td width="150" style="font-size:16px;"><b>Gmts  Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=($sum_fin_fabqnty[0][csf('qty')]/$po_qnty_tot1)*12;?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Order No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
					<td width="150" style="font-size:16px;"><b>Cutting Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
					$target_qty=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);
					echo number_format(($sum_fin_fabqnty[0][csf('qty')]/$target_qty)*12,3);?></b></td>
				</tr>


			 </table>

			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>A) B/Input  Rej%</b></td>

					<td width="100" style="font-size:16px;"><b><b>(1)&nbsp; Fabric :&nbsp<?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Print:<?=$extra[10]+$extra[2];?>%</b></td>
					<td width="100" style="font-size:16px;"><b> (3)&nbsp; Embo :<?=$extra[1];?>%</b></td>
					<td width="100" style="font-size:16px;"><b> (4)&nbsp; AOP :<?=$extra[13];?>%</b></td>
					<td width="100" align="right" style="font-size:16px;"><b>Total:</b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[13]+$extra[1];?>%</b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>B)&nbsp; A/Input Extra/Rej %</b></td>
					<td width="100" style="font-size:16px;"><b>(1)&nbsp; Sewing:<?=$extra[4];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Wash:<?=$extra[3];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(3)&nbsp; Packing: <? echo $extra[15];  ?>%</b></td>
					<td width="100" style="font-size:16px;"><b></b></td>
					<td width="100" align="right" style="font-size:16px;"><b>Total: </b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[4]+$extra[3]+$extra[15];?>%</b></td>

				</tr>

			 </table>



					<?
		}

		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>



                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="100%" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black" colspan="2" width="80"><strong> Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="word-break:break-all" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>

                                    </tr>
                                    <?

                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                 //   for($c=0;$c<count($gmts_item); $c++)
                                 //   {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  status_active=1  ".where_con_using_array($gmts_item,1,'item_number_id')." and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0  group by color_number_id  order by color_order");
										?>

										<?
									//	foreach($nameArray_color as $result_color)
										//{
											?>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">C) Order Qty (Pcs)  @</td>
												<td align="left" style="border:1px solid black" width="60">100%</td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."  ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");

													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>

											</tr>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">D) Cutting Qty (A+B+C) @ </td>
												<td align="left" style="border:1px solid black" width="60"><?=100+$tot_pro_loss;?>%</td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."   ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100),0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100) ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100) ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);


															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>

											</tr>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">Target Input Qty. (D-A) @ &nbsp;&nbsp; </td>
												<td align="left" style="border:1px solid black" width="60"><?=(100+$tot_pro_loss)-$a_process_loss;?>%</td>
                                                <?
												$target_input_loss=(100+$tot_pro_loss)-$a_process_loss;
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."   ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100),0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100) ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100) ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);


															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>

											</tr>
											<?
									//	}
										?>



										</tr>
										<?
                                   // }
                                    ?>


                                </table>


			<?
		}
		// if($cbo_fabric_source==1) end

	  	?>

      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no' and status_active=1");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');

		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
					<br>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
			<tr align="center"><th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">&nbsp; </th>


                </tr>
			<tr align="center">
                    <th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">Fabric Details in Kg</th>


                </tr>
			<tr align="center">
                    <th colspan="3" align="left">Item Name</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('item_number_id')] == "") echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
				<tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3' style='word-break:break-all'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>

                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td  colspan='3'  style='word-break:break-all'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td  colspan='3'  style='word-break:break-all'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Yarn Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all'>".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='3' style='word-break:break-all' >&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>

                <tr align="center">
                    <th colspan="3" align="left">Dia/Width (Inch)</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
				 <tr align="center">
                    <th   colspan="3" align="left">Remarks</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('remarks')].",".$fabric_typee[$result_fabric_description[csf('remarks')]]."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50'>P.Loss</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
                $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";

                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('dia_width')].'**'.$row[csf('remarks')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
                }
                unset($color_wise_wo_sql_res);

                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.status_active=1  and b.status_active=1 and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }

                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);

                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>

                        <td><? if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]) echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];

							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                    $total_fin_fab_qnty+=$color_wo_fin_qnty;
                                }
                                ?>
							</td>
							<td width='50' align='center' style="font-size:18px;"><?=$result_fabric_description[csf('process_loss_percent')];?></td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									$total_grey_fab_qnty+=$color_wo_grey_qnty;
                                }
                                ?>
							</td>
							<?
                        }
						if($process_loss_method==1) //Markup
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;

							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_fin_fab_qnty.'*'.'100';
                        }
                        if($process_loss_method==2)
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_grey_fab_qnty.'*'.'100';
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;" title="<? echo $msg;?>">
                        <?
                        if($process_loss_method==1)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
                        }
                        if($process_loss_method==2)
                        {
                        	$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
                        }
                        echo number_format($process_percent,2);
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$result_fabric_description[csf('dia_width')].'**'.$result_fabric_description[csf('remarks')];

						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];
						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td>
						<td width='50' align='center' style="font-size:18px;">&nbsp;<?  //echo number_format($wo_fin_qnty,2) ;?></td>
						<td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)// markup
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
                        }

                        if($process_loss_method==2) //margin
                        {
                            $totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
                        }
                        echo number_format($totalprocess_percent,2);
                        ?>
                    </td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
						<?
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							?>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
							<?
                        }
                        ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
						<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }

                        if($process_loss_method==2)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
				  <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }

                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;

                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>

                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;

                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {

                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);

                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}



			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order,e.body_part_type";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);

			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];

				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);

			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);

			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div width="100%" style="overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}

                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                   // $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                   $tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
												    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>

                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		// $sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		?>
        <!-- <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table> -->

        <br/>
		<div width="100%">
		<?
			$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
			$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
			$result_data=sql_select($sql_stripe);
			foreach($result_data as $row){
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			}

			if(count($stripe_arr)>0){
			?>

        <table width="55%"  border="1" style="float:left" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">


			 <tr>
				<th colspan="9"> <strong style="float:left"> Stripe Details</strong></th>

            </tr>
            <tr>
				<th width="30"> SL</th>
				<th width="100"> Body Part</th>
				<th width="80"> Fabric Color</th>
				<th width="70"> Fabric Qty(KG)</th>
				<th width="70"> Stripe Color</th>
				<th width="70"> Stripe Measurement</th>
				<th width="70"> Stripe Uom</th>
				<th  width="70"> Qty.(KG)</th>
				<th  width="70"> Y/D Req.</th>
            </tr>
            <?
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
					?>
					<tr>
					<?
					$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>



			<?
			$condition= new condition();
			if(str_replace("'","",$job_no) !=''){
				$condition->job_no("='$job_no'");
			}
			$condition->init();
			$cos_per_arr=$condition->getCostingPerArr();
			$yarn= new yarn($condition);

			//$yarn_data_array=$yarn->getOrderCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
			$yarn_data_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnQtyArray();

			$yarn_data_amt_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnAmountArray();

			$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
			$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");
		$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");

			$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_no=$txt_booking_no and a.qty>0 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");

			if(count($sql_data)>0)
			{
				?>

				<table width="40%"  border="1" cellpadding="0" style="float:left;margin-left:5px; margin-bottom:10px;" cellspacing="0" class="rpt_table" rules="all">
				<tr>
				<th colspan="6"> <strong style="float:left"> Dyes To Match</strong></th>

            </tr>
					<tr align="center">
						<td>Sl</td>
						<td>Item</td>
						<td>Body Color</td>
						<td>Item Color</td>
						<td>Finish Qty.</td>
						<td>UOM</td>
					</tr>
					<?
					foreach($sql_data  as $row)
					{
						$co++;
						?>
						<tr>
							<td><? echo $co; ?></td>
							<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
							<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
							<td><? echo $color_library[$row[csf('item_color')]];?></td>
							<td align="right"><? echo $row[csf('qty')];?></td>
							<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
						</tr>
						<?
					}
					?>
				</table>

				<?
			}
			}?>
				</div>

        <br/>


	<div width="100%">
	<?
	//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,

								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------

	if(count($tna_date_task_arr)>0){
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000;margin-top:10%;">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>

        </fieldset>
		<?php
				}?>
		</div>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>

                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>

                <?
				}
				?>
        	</table>
            <br><br><br>
		<? }
		//echo get_spacial_instruction($txt_booking_no,"97%",118);
		$mst_id=$txt_booking_no; $width="100%"; $entry_form=118;
		$html = '
	<table  width=' . $width . ' class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
	<thead>
	<tr style="border:1px solid black;">
	<th width="3%" style="border:1px solid black;">Sl</th><th width="97%" style="border:1px solid black;">Special Instruction</th>
	</tr>
	</thead>
	<tbody>';

	if ($entry_form != '') {$entry_form_con = " and entry_form=$entry_form";}

	$data_array = sql_select("select id, terms from  wo_booking_terms_condition where booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id");
	if (count($data_array) > 0) {
		$i = 0;
		foreach ($data_array as $row) {
			$i++;
			$html .= '
			<tr id="settr_1" align="" style="border:1px solid black;">
			<td style="border:1px solid black;">' . $i . '</td>
			<td style="border:1px solid black; font-weight:bold">' . $row[csf('terms')] . '</td>
			</tr>';
		}
	}

	$html .= '
	</tbody>
	</table>';
	echo $html;
		 ?>
         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
	   </div>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
		if($is_mail_send==1){
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=89 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);

		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL];
		}

		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");


		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}

		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";

		if($to!=""){
			require_once('../../../mailer/class.phpmailer.php');
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}

if($action=="fabric_price_popup"){
	echo load_html_head_contents("Fabric Price","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$fabric_price_item_arr=array('Yarn Price', 'Elastane', 'Knitting Charge', 'Dyeing Charge', 'AOP', 'Y/D', 'Brush', 'Heat Set', 'Compacting', 'Stenter', 'Others');
	$nameArray_request=sql_select("SELECT id, job_id, heading, value_field_one, value_field_two, value_field_three, value_field_four from wo_pre_cost_fabric_price_dtls where job_id=$hidd_job_id order by id ASC");
	//echo "SELECT id, job_id, heading, value_field_one, value_field_two, value_field_three, value_field_four from wo_pre_cost_fabric_price_dtls where job_id=$hidd_job_id order by id ASC"; die;
	?>
	<script>
		var permission='<? echo $permission; ?>';
		function set_sum_value(des_fil_id,field_id)
		{
			var ddd={dec_type:6,comma:0};
			var rowCount =13;
			var tot=0;
			var dec_point=0;
			for (var i=3; i<=rowCount; i++)
			{
				tot=(tot*1) + (document.getElementById(field_id+i).value*1);
			}
			document.getElementById(des_fil_id).value=number_format_common(tot,4,0);
			var wastage_per_price=0;
			if(field_id=='fabpricetwo_'){
				var waster_per= document.getElementById('fabpricetwo_14').value*1;
				if(tot>0){
					wastage_per_price= tot*(waster_per/100);
				}
				document.getElementById('wpp_two').value=wastage_per_price;
				var fabric_price=number_format_common(wastage_per_price+tot,4,0);
				document.getElementById('fabpricetwo').value=fabric_price;
			}
			if(field_id=='fabpricethree_'){
				var waster_per= document.getElementById('fabpricethree_14').value*1;
				if(tot>0){
					wastage_per_price= tot*(waster_per/100);
				}
				document.getElementById('wpp_three').value=wastage_per_price;
				var fabric_price=number_format_common(wastage_per_price+tot,4,0);
				document.getElementById('fabpricethree').value=fabric_price;
			}
			if(field_id=='fabpricefour_'){
				var waster_per= document.getElementById('fabpricefour_14').value*1;
				if(tot>0){
					wastage_per_price= tot*(waster_per/100);
				}
				document.getElementById('wpp_four').value=wastage_per_price;
				var fabric_price=number_format_common(wastage_per_price+tot,4,0);
				document.getElementById('fabpricefour').value=fabric_price;
			}
			if(field_id=='fabpricefive_'){
				var waster_per= document.getElementById('fabpricefive_14').value*1;
				if(tot>0){
					wastage_per_price= tot*(waster_per/100);
				}
				document.getElementById('wpp_five').value=wastage_per_price;
				var fabric_price=number_format_common(wastage_per_price+tot,4,0);
				document.getElementById('fabpricefive').value=fabric_price;
			}
		}
		function fnc_fabric_price_entry(operation){
			freeze_window(operation);
			if (form_validation('fabpricetwo_1*fabpricethree_1*fabpricefour_1*fabpricefive_1','Fabric*Fabric*Fabric*Fabric')==false)
			{
				release_freezing();
				return;
			}
			var z=1; var data_all="";
			for (var i=1; i<=14; i++)
			{
				if(i>2){
					var fabpriceone= $('#fabpriceone_'+i).val();
					fabpriceone = (fabpriceone=='') ? '' : fabpriceone;
					var fabpricetwo= $('#fabpricetwo_'+i).val();
					fabpricetwo = (fabpricetwo=='') ? 0 : fabpricetwo;
					var fabpricethree= $('#fabpricethree_'+i).val();
					fabpricethree = (fabpricethree=='') ? 0 : fabpricethree;
					var fabpricefour= $('#fabpricefour_'+i).val();
					fabpricefour = (fabpricefour=='') ? 0 : fabpricefour;
					var fabpricefive= $('#fabpricefive_'+i).val();
					fabpricefive = (fabpricefive=='') ? 0 : fabpricefive;
				}
				else{
					var fabpriceone= $('#fabpriceone_'+i).val();
					fabpriceone = (fabpriceone=='') ? '' : fabpriceone;
					var fabpricetwo= $('#fabpricetwo_'+i).val();
					fabpricetwo = (fabpricetwo=='') ? '' : fabpricetwo;
					var fabpricethree= $('#fabpricethree_'+i).val();
					fabpricethree = (fabpricethree=='') ? '' : fabpricethree;
					var fabpricefour= $('#fabpricefour_'+i).val();
					fabpricefour = (fabpricefour=='') ? '' : fabpricefour;
					var fabpricefive= $('#fabpricefive_'+i).val();
					fabpricefive = (fabpricefive=='') ? '' : fabpricefive;
				}
				data_all+="&fabpriceone_" + z + "='" +fabpriceone+"'"+"&fabpricetwo_" + z + "='" +fabpricetwo+"'"+"&fabpricethree_" + z + "='" +fabpricethree+"'"+"&fabpricefour_" + z + "='" +fabpricefour+"'"+"&fabpricefive_" + z + "='" +fabpricefive+"'";
				z++;
			}
			var data="action=save_update_delete_fabricprice&operation="+operation+get_submitted_data_string('job_no*job_id',"../../../")+data_all;

			http.open("POST","pre_cost_entry_controller_v2.php",true);
			http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			http.send(data);
			http.onreadystatechange = fnc_fabric_price_entry_reponse;
		}
		function fnc_fabric_price_entry_reponse()
		{
			if(http.readyState == 4)
			{
				var reponse=trim(http.responseText).split('**');
				if(reponse[0]==11)
				{
					release_freezing();
					show_msg(reponse[0]);
					return;
				}
				if(reponse[0]==10)
				{
					release_freezing();
					show_msg(reponse[0]);
					return;
				}
				if(reponse[0]==0 || reponse[0]==1)
				{
					release_freezing();
					show_msg(reponse[0]);
					set_button_status(1, permission, 'fnc_fabric_price_entry',1);
				}
				if(reponse[0]==2)
				{
					release_freezing();
					show_msg(reponse[0]);
					set_button_status(0, permission, 'fnc_fabric_price_entry',1);
				}
			}
		}
	</script>
	</head>
    <body>
    <div align="center" style="width:100%;">
		<div><?=load_freeze_divs ("../../../",$permission,1); ?></div>
		<div style="font-size:16px; color:#36F">Fabric Price Details</div>
		<form id="fabric_price">
         <table id="fabric_price_date_tbl" cellspacing="0" cellpadding="0" border="1" rules="all" width="650" class="rpt_table">
		 	<? if(count($nameArray_request)>0){
				$i=1;
				foreach($nameArray_request as $row){
				if($i<=2){
				?>
				<tr>
					<td width="90"><strong><?= $row[csf('heading')] ?></strong>
					<input width="90" type="hidden" name="fabpriceone_<?= $i?>" id="fabpriceone_<?= $i?>" class="text_boxes" value="<?= $row[csf('heading')] ?>" ></td>
					<td width="90"><input width="90" type="text" name="fabpricetwo_<?= $i ?>" id="fabpricetwo_<?= $i ?>" class="text_boxes" placeholder="<?= $row[csf('value_field_one')] ?>" value="<?= $row[csf('value_field_one')] ?>" ></td>
					<td width="90"><input width="90" type="text" name="fabpricethree_<?= $i ?>" id="fabpricethree_<?= $i ?>" class="text_boxes" placeholder="<?= $row[csf('value_field_two')] ?>" value="<?= $row[csf('value_field_two')] ?>" ></td>
					<td width="90"><input width="90" type="text" name="fabpricefour_<?= $i ?>" id="fabpricefour_<?= $i ?>" class="text_boxes" placeholder="<?= $row[csf('value_field_three')] ?>" value="<?= $row[csf('value_field_three')] ?>" ></td>
					<td width="90"><input width="90" type="text" name="fabpricefive_<?= $i ?>" id="fabpricefive_<?= $i ?>" class="text_boxes" placeholder="<?= $row[csf('value_field_four')] ?>" value="<?= $row[csf('value_field_four')] ?>" ></td>
				</tr>
				<? }
					else if ($i>2 && $i<14){ ?>
						<tr>
							<td><input type="text" name="fabpriceone_<?=$i?>" id="fabpriceone_<?=$i?>" class="text_boxes" value="<?= $row[csf('heading')] ?>" ></td>
							<td><input type="text" name="fabpricetwo_<?=$i?>" id="fabpricetwo_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_one')] ?>" onChange="set_sum_value('total_two','fabpricetwo_')" ></td>
							<td><input type="text" name="fabpricethree_<?=$i?>" id="fabpricethree_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_two')] ?>"  onchange="set_sum_value('total_three','fabpricethree_')"  ></td>
							<td><input type="text" name="fabpricefour_<?=$i?>" id="fabpricefour_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_three')] ?>" onChange="set_sum_value('total_four','fabpricefour_')"  ></td>
							<td><input type="text" name="fabpricefive_<?=$i?>" id="fabpricefive_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_four')] ?>" onChange="set_sum_value('total_five','fabpricefive_')"  ></td>
						</tr>
					<?
					$total_field_one +=$row[csf('value_field_one')]*1;
					$total_field_two +=$row[csf('value_field_two')]*1;
					$total_field_three +=$row[csf('value_field_three')]*1;
					$total_field_four +=$row[csf('value_field_four')]*1;
					}
				else{
				?>
				<tr>
					<td><strong><?= $row[csf('heading')] ?></strong><input type="hidden" name="fabpriceone_14" id="fabpriceone_14" class="text_boxes" value="<?= $row[csf('heading')] ?>" ></td>
					<td><input type="text" name="fabpricetwo_<?=$i?>" id="fabpricetwo_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_one')] ?>" onChange="set_sum_value('total_two','fabpricetwo_')"></td>
					<td><input type="text" name="fabpricethree_<?=$i?>" id="fabpricethree_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_two')] ?>" onChange="set_sum_value('total_three','fabpricethree_')" ></td>
					<td><input type="text" name="fabpricefour_<?=$i?>" id="fabpricefour_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_three')] ?>" onChange="set_sum_value('total_four','fabpricefour_')" ></td>
					<td><input type="text" name="fabpricefive_<?=$i?>" id="fabpricefive_<?=$i?>" class="text_boxes" value="<?= $row[csf('value_field_four')] ?>" onChange="set_sum_value('total_five','fabpricefive_')" ></td>
				</tr>
				<?
					$wastage_field_one = $total_field_one*($row[csf('value_field_one')]/100)*1;
					$wastage_field_two = $total_field_two*($row[csf('value_field_two')]/100)*1;
					$wastage_field_three = $total_field_three*($row[csf('value_field_three')]/100)*1;
					$wastage_field_four = $total_field_four*($row[csf('value_field_four')]/100)*1;
				}
				$i++;
				}
				?>
				<tr>
					<td><strong>Total</strong></td>
					<td><input type="text" name="total_two" id="total_two" class="text_boxes" value="<?= $total_field_one ?>" readonly></td>
					<td><input type="text" name="total_three" id="total_three" class="text_boxes" value="<?= $total_field_two ?>" readonly></td>
					<td><input type="text" name="total_four" id="total_four" class="text_boxes" value="<?= $total_field_three ?>" readonly></td>
					<td><input type="text" name="total_five" id="total_five" class="text_boxes" value="<?= $total_field_four ?>" readonly></td>
				</tr>
				<tr>
					<td><strong>wastage % price</strong></td>
					<td><input type="text" name="wpp_two" id="wpp_two" class="text_boxes" value="<?= number_format($wastage_field_one,2) ?>" readonly></td>
					<td><input type="text" name="wpp_three" id="wpp_three" class="text_boxes" value="<?= number_format($wastage_field_two,2) ?>" readonly></td>
					<td><input type="text" name="wpp_four" id="wpp_four" class="text_boxes" value="<?= number_format($wastage_field_three,2) ?>" readonly></td>
					<td><input type="text" name="wpp_five" id="wpp_five" class="text_boxes" value="<?= number_format($wastage_field_four,2) ?>" readonly></td>
				</tr>
				<tr>
					<td><strong>Fabric Price</strong></td>
					<td><input type="text" name="fabpricetwo" id="fabpricetwo" class="text_boxes" value="<?= number_format($total_field_one+$wastage_field_one,2) ?>" readonly></td>
					<td><input type="text" name="fabpricethree" id="fabpricethree" class="text_boxes" value="<?= number_format($total_field_two+$wastage_field_two,2) ?>" readonly></td>
					<td><input type="text" name="fabpricefour" id="fabpricefour" class="text_boxes" value="<?= number_format($total_field_three+$wastage_field_three,2) ?>" readonly></td>
					<td><input type="text" name="fabpricefive" id="fabpricefive" class="text_boxes" value="<?= number_format($total_field_four+$wastage_field_four,2) ?>" readonly></td>
				</tr>
			<? } else {?>
				<tr>
					<td width="90"><strong>Fabric</strong>
					<input width="90" type="hidden" name="fabpriceone_1" id="fabpriceone_1" class="text_boxes" value="Fabric" ></td>
					<td width="90"><input width="90" type="text" name="fabpricetwo_1" id="fabpricetwo_1" class="text_boxes" placeholder="Solid" value="Solid" ></td>
					<td width="90"><input width="90" type="text" name="fabpricethree_1" id="fabpricethree_1" class="text_boxes" placeholder="AOP" value="AOP" ></td>
					<td width="90"><input width="90" type="text" name="fabpricefour_1" id="fabpricefour_1" class="text_boxes" placeholder="Stripe Y/D" value="Stripe Y/D" ></td>
					<td width="90"><input width="90" type="text" name="fabpricefive_1" id="fabpricefive_1" class="text_boxes" placeholder="Other" value="Other" ></td>
				</tr>
				<tr>
					<td><strong>Yarn Count</strong><input type="hidden" name="fabpriceone_2" id="fabpriceone_2" class="text_boxes" value="Yarn Count" ></td>
					<td><input type="text" name="fabpricetwo_2" id="fabpricetwo_2" class="text_boxes" placeholder="32s" value="32s" ></td>
					<td><input type="text" name="fabpricethree_2" id="fabpricethree_2" class="text_boxes" placeholder="34s" value="" ></td>
					<td><input type="text" name="fabpricefour_2" id="fabpricefour_2" class="text_boxes" placeholder="35s" value="" ></td>
					<td><input type="text" name="fabpricefive_2" id="fabpricefive_2" class="text_boxes" placeholder="62s" value="" ></td>
				</tr>
				<?
					$i=3;
					foreach($fabric_price_item_arr as $data){ ?>
						<tr>
							<td><input type="text" name="fabpriceone_<?=$i?>" id="fabpriceone_<?=$i?>" class="text_boxes" value="<?= $data  ?>" ></td>
							<td><input type="text" name="fabpricetwo_<?=$i?>" id="fabpricetwo_<?=$i?>" class="text_boxes" value="0" onChange="set_sum_value('total_two','fabpricetwo_')" ></td>
							<td><input type="text" name="fabpricethree_<?=$i?>" id="fabpricethree_<?=$i?>" class="text_boxes" value="0"  onchange="set_sum_value('total_three','fabpricethree_')"  ></td>
							<td><input type="text" name="fabpricefour_<?=$i?>" id="fabpricefour_<?=$i?>" class="text_boxes" value="0" onChange="set_sum_value('total_four','fabpricefour_')"  ></td>
							<td><input type="text" name="fabpricefive_<?=$i?>" id="fabpricefive_<?=$i?>" class="text_boxes" value="0" onChange="set_sum_value('total_five','fabpricefive_')"  ></td>
						</tr>
					<?
						$i++;
					}
				?>
				<tr>
					<td><strong>Wastage %</strong><input type="hidden" name="fabpriceone_14" id="fabpriceone_14" class="text_boxes" value="Wastage %" ></td>
					<td><input type="text" name="fabpricetwo_14" id="fabpricetwo_14" class="text_boxes" value="0" onChange="set_sum_value('total_two','fabpricetwo_')"></td>
					<td><input type="text" name="fabpricethree_14" id="fabpricethree_14" class="text_boxes" value="0" onChange="set_sum_value('total_three','fabpricethree_')" ></td>
					<td><input type="text" name="fabpricefour_14" id="fabpricefour_14" class="text_boxes" value="0" onChange="set_sum_value('total_four','fabpricefour_')" ></td>
					<td><input type="text" name="fabpricefive_14" id="fabpricefive_14" class="text_boxes" value="0" onChange="set_sum_value('total_five','fabpricefive_')" ></td>
				</tr>
				<tr>
					<td><strong>Total</strong></td>
					<td><input type="text" name="total_two" id="total_two" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="total_three" id="total_three" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="total_four" id="total_four" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="total_five" id="total_five" class="text_boxes" value="0" readonly></td>
				</tr>
				<tr>
					<td><strong>wastage % price</strong></td>
					<td><input type="text" name="wpp_two" id="wpp_two" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="wpp_three" id="wpp_three" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="wpp_four" id="wpp_four" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="wpp_five" id="wpp_five" class="text_boxes" value="0" readonly></td>
				</tr>
				<tr>
					<td><strong>Fabric Price</strong></td>
					<td><input type="text" name="fabpricetwo" id="fabpricetwo" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="fabpricethree" id="fabpricethree" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="fabpricefour" id="fabpricefour" class="text_boxes" value="0" readonly></td>
					<td><input type="text" name="fabpricefive" id="fabpricefive" class="text_boxes" value="0" readonly></td>
				</tr>
			<? } ?>
        </table>
		<table align="center" cellspacing="0" width="650" class="rpt_table" border="1" rules="all" id="" >
			<tr>
				<td align="center" class="button_container">
				<input type="hidden" id="job_no" value="<?= $txt_job_no ?>" >
				<input type="hidden" id="job_id" value="<?= $hidd_job_id ?>" >
					<?
						if(count($nameArray_request)>0)
						{
							echo load_submit_buttons($permission, "fnc_fabric_price_entry", 1,0,"reset_form('fabric_price','','','','','');",1);
						}
						else
						{
							echo load_submit_buttons($permission, "fnc_fabric_price_entry", 0,0,"reset_form('fabric_price','','','','','');",1);
						}
					?>
				</td>
			</tr>
		</table>
		</form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=='save_update_delete_fabricprice'){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		$job_id=str_replace("'",'',$job_id);
		if (is_duplicate_field( "job_id", "wo_pre_cost_fabric_price_dtls", "job_id=$job_id" ) == 1)
		{
			echo "11**0";
			disconnect($con);die;
		}
		$id=return_next_id( "id", "wo_pre_cost_fabric_price_dtls", 1);
		$field_array="id, job_id, heading, value_field_one, value_field_two, value_field_three, value_field_four, inserted_by, insert_date";
		for ($i=1; $i<=14; $i++)
		{
			$fabpriceone="fabpriceone_".$i;
			$fabpricetwo="fabpricetwo_".$i;
			$fabpricethree="fabpricethree_".$i;
			$fabpricefour="fabpricefour_".$i;
			$fabpricefive="fabpricefive_".$i;

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$job_id.",".$$fabpriceone.",".$$fabpricetwo.",".$$fabpricethree.",".$$fabpricefour.",".$$fabpricefive.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			$id=$id+1;
		}
		$rID=sql_insert("wo_pre_cost_fabric_price_dtls",$field_array,$data_array,0);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
				echo "0";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
	if ($operation==1)  // Update Here
	{
		$con = connect();
		$id=return_next_id( "id", "wo_pre_cost_fabric_price_dtls", 1);
		$field_array="id, job_id, heading, value_field_one, value_field_two, value_field_three, value_field_four, inserted_by, insert_date";
		for ($i=1; $i<=14; $i++)
		{
			$fabpriceone="fabpriceone_".$i;
			$fabpricetwo="fabpricetwo_".$i;
			$fabpricethree="fabpricethree_".$i;
			$fabpricefour="fabpricefour_".$i;
			$fabpricefive="fabpricefive_".$i;

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$job_id.",".$$fabpriceone.",".$$fabpricetwo.",".$$fabpricethree.",".$$fabpricefour.",".$$fabpricefive.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			$id=$id+1;
		}
		//echo "10**INSERT INTO wo_pre_cost_fabric_price_dtls ($field_array) values $data_array"; die;
		$rIDmst_del=execute_query( "delete from wo_pre_cost_fabric_price_dtls where job_id in ($job_id)",0);
		if($rIDmst_del){
			$rID=sql_insert("wo_pre_cost_fabric_price_dtls",$field_array,$data_array,0);
		}
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
				echo "0";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
	if($operation==2){
		$con = connect();
		$rIDmst_del=execute_query( "delete from wo_pre_cost_fabric_price_dtls where job_id in ($job_id)",0);
		if($db_type==2 || $db_type==1 )
		{
			if($rIDmst_del){
				oci_commit($con);
				echo "2";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
}
if($action=="emb_print_issue_check"){
	$issue_check=sql_select("SELECT c.id from wo_po_details_master a join wo_po_break_down b on a.id=b.job_id join pro_garments_production_mst c on b.id=c.po_break_down_id where a.id=$data and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
	echo count($issue_check);
	exit;
}

?>